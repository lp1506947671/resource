

<!DOCTYPE html>
<html class="writer-html4" lang="zh" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>python-web-guide 0.1 文档</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'0.1',
              LANGUAGE:'zh',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: ''
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

     
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html#document-index" class="icon icon-home" alt="Documentation Home"> python-web-guide
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-base/basics">入门基础</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#python-golang-go">编程语言: Python(Golang请参考 go 章节)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">算法与数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">计算机网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">网络编程(进阶)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux">Linux系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id13">数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id14">python 相关库的使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#web">web 框架</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id15">版本控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id17">Web 服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id18">微服务架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id21">前端知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id22">学习和搜索能力</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id23">业务领域知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id24">专业素养</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id26">软件工程</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id28">后端技术栈</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id34">学习路线</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id35">求职与面试</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id38">系统/架构设计进阶</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#web-python-golang-golang">Web 开发常用 Python 库(Golang 常用库请参考 golang 章节)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id39">裁员、劳动法与法律援助</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-codingstyle/codingstyle">编码之前碎碎念(工程实践)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">技术雷达</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">代码风格</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">编程范式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pythonic">何谓Pythonic?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tdd-shit">敏捷与TDD(中华田园敏捷开发：快糙猛，产出一堆 shit)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id19">业务代码的一些常见原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id21">python代码坏味道(新手经常犯的错误)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id31">难以维护的Python代码</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id32">重视细节</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id33">版式与布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id34">命名</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id35">注释与docstring</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id36">异常处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#web">web安全</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#id38">小白的踩坑记录</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id39">文档化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id40">代码分支与代码管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id41">代码提交</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id42">注释</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#code-review">Code Review(代码审查)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id45">日志与异常记录</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id47">代码自查</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id48">服务上线</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id49">重构与维护</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id52">Python 做业务后端的优缺点分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id53">高质量服务自查表</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id55">开发习惯</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id56">技术氛围建设</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id57">开发流程(需求-&gt;分析-&gt;设计-&gt;实现-测试)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-debug/index">Debug 调试神技</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#bug-debug">调试/bug 定位/debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#bug">常见的 bug 类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id22">参考</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-codingtools/codingtools">开发和编程工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">工欲善其事，必先利其器 开(装)发(逼)工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#macos">MacOS 开发效率工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">命令行工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Mac 终端快速配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">打字速度练习</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">Mac 屏保软件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#git">Git 相关</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#chrome">Chrome 开发者插件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">编程字体(适合代码显示)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">代码工具/算法可视化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">代码辅助和检测工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">代码质量检测平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">项目工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id12">代码仓库托管</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id13">项目模板脚手架</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id14">持续集成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id15">配置中心</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#api">Api 工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#dsl">DSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id16">测试工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id17">文档/写书/笔记工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#swagger">Swagger 工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id18">静态博客工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id19">日志、异常收集工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#devops">管理及运维、监控工具(devops很火)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#api-gateway">API gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id20">调试工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id21">抓包/网络工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#proxy">Proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id22">爬虫相关</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id23">自动化测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id24">异步任务框架</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id25">端口扫描</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id26">后台管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#rpc">RPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#rest">Rest</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id27">数据处理和可视化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#benchmark">压测(benchmark)工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#profiler">Profiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#apm-application-performance-management">APM (Application Performance Management)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id28">数据库工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id29">绘图/流程图/思维导图工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id30">量化投资</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id31">效率，时间管理工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id32">程序员外设/健康工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vlog">视频课程录制(vlog工具)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#html-presentation-tools">HTML Presentation Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id34">思维导图工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id35">电子阅读器/电子书软件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux-network-debug-tools">Linux network debug Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux-debug-tools">Linux debug Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id36">参考：</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-idiom/idiom">Write Idiom Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#python">Python支持链式比较</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">Python交换变量</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Python中替代三目运算符?:</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#join">拼接字符列表时，用join方法去实现</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#format">格式化字符时多使用format函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#comprehension">使用列表或者字典comprehension</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#true-false-none">条件判断时，避免直接和True, False, None进行比较(==)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#enumerateforindex">使用enumerate代替for循环中的index变量访问</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#mutable">避免使用可变(mutable)变量作为函数参数的默认初始化值</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">一切皆对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#eafp-vs-lbyl">防御式编程EAFP vs LBYL</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#dictswitch-case">用dict对象完成switch...case...的功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tuple-namedtupleindex">访问tuple的数据项时，可以用namedtuple代替index的方式访问</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#isinstance">用isinstance来判断对象的类型</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#with">用with管理操作资源的上下文环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#generator">使用generator返回耗费内存的对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">更多资源：</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-design/design">用python实现设计模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-fctory-pattern">1: The Fctory Pattern(工厂模式: 解决对象创建问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-builder-pattern">2: The Builder Pattern(构造模式: 控制复杂对象的构造)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-prototype-pattern">3:The Prototype Pattern(原型模式:解决对象拷贝问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-adapter-pattern">4: The Adapter Pattern(适配器模式: 解决接口不兼容问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-decorator-pattern">5: The Decorator Pattern(装饰器模式： 无需子类化实现扩展对象功能问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-facade-pattern">6: The Facade Pattern(外观模式: 简化复杂对象的访问问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-flyweight-pattern">7: The Flyweight Pattern(享元模式: 实现对象复用从而改善资源使用)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-model-view-controller-pattern-mvc">8: The Model-View-Controller Pattern(mvc模式：解耦展示逻辑和业务逻辑)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-proxy-pattern">9: The Proxy Pattern(代理模式：通过一层间接保护层实现更安全的接口访问）</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-chain-of-responsibility-pattern">10: The Chain of Responsibility Pattern (责任链模式:创建链式对象用来接收广播消息)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-command-pattern-undo">11: The Command Pattern(命令模式：用来给应用添加Undo操作)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-interpreter-pattern-domain-specific-language-dsl">12: The Interpreter Pattern(解释器模式：用来实现Domain Specific Language(DSL))</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-observer-pattern">13: The Observer Pattern(发布订阅模式：用来处理多个对象之间的发布订阅问题)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-state-pattern">14: The State Pattern(状态模式：实现有限状态机)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-strategy-pattern">15: The Strategy Pattern(策略模式：动态选择算法策略)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#the-template-pattern">16: The Template Pattern(模板模式：抽象出算法公共部分从而实现代码复用)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">单例模式: 使得一个类最多生成一个实例。</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">面向过程与面向对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">python中的抽象基类</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pythonmixin">python中的Mixin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-algorithms/algorithms">用python实现基本数据结构和算法</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#adt">1章：ADT抽象数据类型，定义数据和其操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#array-vs-list">2章：array vs list</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sets-and-maps">3章：Sets and Maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#algorithm-analysis">4章：Algorithm Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#searching-and-sorting">5章：Searching and Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linked-structure">6章: Linked Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#stacks">7章：Stacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#queues">8章：Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#advanced-linked-lists">9章：Advanced Linked Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#recursion">10章：Recursion</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#hash-tables">11章：Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#advanced-sorting">12章: Advanced Sorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#binary-tree">13章: Binary Tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#search-trees">14章: Search Trees</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-database/index">数据库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-database/mongo">MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-database/mysql">Mysql</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-database/redis">Redis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-skillstack/index">技术栈</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-skillstack/docker">docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-skillstack/linux">Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-skillstack/rst">reStructuredText简明教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-skillstack/shell">Unix/Linux 常用 shell 命令</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-devtools/index">开发工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devtools/hg">hg 简明教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devtools/ipython">IPython 用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devtools/other">其它开发工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devtools/vim">vim 快速入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-devtools/xshell">xshell 客户端</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-python-note/index">个人Python笔记</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/crawler">爬虫相关</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/funny">Just For Fun</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/ffmpeg">使用Python 编写的 ffmepg 处理视频的脚本</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/flaskapi">用来测试接口的 flask server</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/pdf">合并 pdf</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python-note/uncurl">Uncurl</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-go-note/index">Golang 快速入门 Go For Pythonisa</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-go-note/web">Go入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-go-note/tricks">Go踩坑</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-go-note/optimize">Go 性能优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-go-note/algorithms">Go 算法和数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-go-note/design_patterns">Go 设计模式</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-microservice_distribute/index">微服务/分布式 web 组件</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-microservice_distribute/library">微服务/分布式系统组件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-microservice_distribute/theory">分布式理论知识</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tracing/index">后台服务搭建</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-tracing/sentry">Sentry 搭建</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-memo/memo">个人备忘录</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#python">Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pip-easy-install">pip/easy_install</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ipython">IPython</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ipdb">Ipdb</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#chrome-mac">Chrome(Mac)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#macos">MacOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ssh">SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#mac-wi1000x">Mac 蓝牙耳机(自用索尼 wi1000x)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#proxy">Proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#oh-my-zsh">Oh My Zsh</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux-centos-ubuntu">Linux(centos/ubuntu)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#centos">Centos</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#crontab">crontab</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#iterm2-terminal">Iterm2/Terminal</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tmux">Tmux</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#fabric">Fabric</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#makefile">Makefile</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#git">Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Git工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#git-hook">Git hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vim">vim</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vim-go-plugin-tips">vim-go plugin Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#markdownhtml-ppt">用markdown文件制作html ppt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ppt">PPT 技巧</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#benchmark">Benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ffmpeg-youbute-dl">Ffmpeg &amp;&amp; youbute-dl</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vlog">Vlog 如何增加字幕</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#curl">Curl</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pandoc">Pandoc 转换文档格式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#wireshark-mac-tcp">Wireshark(mac tcp 抓包)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#hhkb-karabiner-mac">HHKB 静电容键盘。Karabiner 修改 mac 键位配置</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docker">Docker 快速入门</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">基本概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Docker 命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#dockerfile">Dockerfile</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">分享</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#docker-web">使用 Docker 进行 web 开发</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">快速编配</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-meta">如何编译 reST 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-mush">蘑菇碎碎念</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#hg">HG</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">翻墙有道</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vim">vim黑科技</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">vim插件及使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#iptables">iptables</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux">linux命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">开发服务器环境介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">不要依赖工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#python">Python抽象方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">使用Docker的正确姿势</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">应对怪需求的好方法</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">python-web-guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index" class="icon icon-home"></a> &raquo;</li>
        
      <li>python-web-guide 0.1 文档</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/PegasusWang/python-web-guide/blob/master/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python-golang-web">
<h1>Python/Golang Web 入坑指南<a class="headerlink" href="#python-golang-web" title="永久链接至标题">¶</a></h1>
<div class="highlight-text"><div class="highlight"><pre><span></span> ____        _   _                    ______        __        __   _        ____       _     _
|  _ \ _   _| |_| |__   ___  _ __    / / ___| ___   \ \      / /__| |__    / ___|_   _(_) __| | ___
| |_) | | | | __| &#39;_ \ / _ \| &#39;_ \  / / |  _ / _ \   \ \ /\ / / _ \ &#39;_ \  | |  _| | | | |/ _` |/ _ \
|  __/| |_| | |_| | | | (_) | | | |/ /| |_| | (_) |   \ V  V /  __/ |_) | | |_| | |_| | | (_| |  __/
|_|    \__, |\__|_| |_|\___/|_| |_/_/  \____|\___/     \_/\_/ \___|_.__/   \____|\__,_|_|\__,_|\___|
       |___/
</pre></div>
</div>
<p>本指南根据作者的自学和工作经历提供(吐槽)一下python/golang
web的学习路线，主要包括概念介绍，参考书籍，开发工具和开发流程等，希望可以帮助非科班人士通过自学入门python/golang
网站开发，弥补学校教育和公司需求之间的鸿沟(也作为自己的学习笔记和面试参考手册)，同时也希望可以作为公司菜鸟实习生的培训手册，帮助公司快速培训新人上手开发，减轻招聘压力。
笔者目前能力有限，希望有经验的python圈人士可以一起协作。
本小书灵感来自于 requests 库作者的 <a class="reference external" href="https://github.com/kennethreitz/python-guide">python-guide</a> 。
你可以使用强大的电子书阅读软件 <a class="reference external" href="https://calibre-ebook.com/">calibre</a> 下载epub格式阅读。</p>
<p>如果您感兴趣，也可以参考慕课网教程 <a class="reference external" href="https://coding.imooc.com/class/318.html">《Python工程师面试宝典》</a> 。
本课程提供了详细的Python后端知识大纲和常考面试题，帮助自学的同学就业。如果本文档有误，您可以在 github 直接提 issue.</p>
<p>注意：Python 不适合工程管理不完善的团队构建大型项目。如果贵团队没有编码规范、单元测试、静态检测、持续集成、文档注释中的一个或者几个，请慎用动态语言。
Python 结合 Go 基本可以解决大部分业务场景，Python 用来快速实现业务和想法，Go 来解决性能瓶颈，这俩也是笔者目前使用最多的语言。
如果因为某些网络原因打不开 readthedoc 网站，您可以参考下方快速上手使用 sphinx 本地构建电子书访问。</p>
<img alt="https://readthedocs.org/projects/z42/badge/?version=latest" src="https://readthedocs.org/projects/z42/badge/?version=latest" />
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 快速上手构建本地电子书</span>
<span class="c1"># 使用方式 1</span>
<span class="c1"># 本项目页面托管在 readthedoc，如果国内因为网络原因打不开，可以使用如下方式在本地构建</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PegasusWang</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">guide</span><span class="o">.</span><span class="n">git</span>    <span class="c1"># 协作请fork一份你自己的地址</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span> <span class="c1"># 安装 Sphinx==1.3.4</span>
<span class="n">make</span> <span class="n">html</span>   <span class="c1"># 构建 html 电子书，之后会在本地生成一个 _build/html 文件夹</span>
<span class="n">cd</span> <span class="n">_build</span><span class="o">/</span><span class="n">html</span>   <span class="c1"># 切换到构建好的 html 静态文件夹里</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>  <span class="c1"># 启动一个本地文件服务器，或者 python2 用 python -m SimpleHTTPServer</span>
<span class="c1"># 之后打开 http://127.0.0.1:8000/ 即可本地访问电子书</span>

<span class="c1"># 方式2(推荐)：加入 sphinx-autobuild 自动编辑刷新</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PegasusWang</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">guide</span><span class="o">.</span><span class="n">git</span>    <span class="c1"># 协作请fork一份你自己的地址</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>  <span class="c1"># 安装 Sphinx==1.3.4, sphinx-autobuild</span>
<span class="n">make</span> <span class="n">serve</span>  <span class="c1"># 之后打开 http://127.0.0.1:8000/ 即可本地访问电子书，编辑保存直接自动刷新浏览器</span>
</pre></div>
</div>
<p>文档采用rst格式书写，用 <a class="reference external" href="https://readthedocs.org/">readthedocs</a> 托管。一个快速的rst语法demo <a class="reference external" href="http://azuwis.github.io/sphinx_demo/demo.html">教程</a>。 如果使用vim编写可以使用rst插件 <a class="reference external" href="https://github.com/Rykka/riv.vim">riv.vim</a> 配合 <a class="reference external" href="https://github.com/Rykka/InstantRst">InstantRst</a> 本地预览，定期pull一下拉取更新。
欢迎你fork一份然后添加自己的章节，本书主要面对经验尚浅的同学作为自学的指导手册，并非速成指南，内容来自笔者日常学习和工作经验的持续总结。
本电子版书集合了同事的智慧结晶，非常感谢你们带我入坑。
本指南同时会有一些不负责任的吐槽。学到东西的请狂点 star，让笔者有动力更新更多业界实战干货，更多技术分享请关注作者知乎帐号 <a class="reference external" href="https://www.zhihu.com/people/pegasus-wang/activities">pegasuswang</a> ，知乎专栏 <a class="reference external" href="https://zhuanlan.zhihu.com/python-web">Python 学习之路</a> ，<a class="reference external" href="http://ningning.today/">个人博客</a> 。
笔者还维护了一个 vim 视频教程专栏，感兴趣可以访问 <a class="reference external" href="https://zhuanlan.zhihu.com/vim-video">玩转vim</a></p>
<div class="section" id="todo">
<h2>TODO:<a class="headerlink" href="#todo" title="永久链接至标题">¶</a></h2>
<p>如果您觉得有用，可以打赏支持作者继续创作！</p>
<center>
 <img src="https://user-images.githubusercontent.com/4470478/47126924-74800900-d2bd-11e8-8f24-6d03ddafbc07.png" alt="微信打赏" width=260 height=300>
</center><div class="section" id="rest">
<h3>如何编译 reST 文档<a class="headerlink" href="#rest" title="永久链接至标题">¶</a></h3>
<p>reST 文档的编译依赖 make 和 sphinx，安装完依赖后在文档的根目录执行
<code class="xref py py-obj docutils literal"><span class="pre">make</span> <span class="pre">html</span></code> 构建 HTML 文档，如无错误即可在 <code class="xref py py-obj docutils literal"><span class="pre">_build/html</span></code> 目录中生成对应的 HTML 文件，
可以在浏览器中直接打开 <code class="xref py py-obj docutils literal"><span class="pre">_build/html/index.html</span></code> 预览生成的
HTML。或者用python起一个本地的server查看。</p>
<p>本文档托管在 ReadTheDocs，文档合并之主分支后将会自动构建，预览请访问 <a class="reference external" href="http://python-web-guide.readthedocs.io/zh/latest/">RTFD</a> 。</p>
<div class="toctree-wrapper compound">
<span id="document-base/basics"></span><div class="section" id="basics">
<span id="id1"></span><h4>入门基础<a class="headerlink" href="#basics" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>Python is a language for consenting adults. —Alan Runyan</div></blockquote>
<div class="section" id="python-golang-go">
<h5>编程语言: Python(Golang请参考 go 章节)<a class="headerlink" href="#python-golang-go" title="永久链接至标题">¶</a></h5>
<p>Python入门相对容易又可以干很多事(网站,运维,数据分析,爬虫,AI,量化投资等），是一门方便的工具语言。2016年TIOBE排名显示Python已经名列第四，成为脚本语言之首。
国外的Youtube，Instagram，Pinterest，Reddit，Dropbox，Disqus，
Quora等知名应用一开始都是基于Python构建，国内的豆瓣，知乎，今日头条，果壳，饿了么，搜狐等也是Python应用的典型。这也给了国内Python开发者一阵强心剂，Python的生态环境可以支撑起重量级的
产品。这里不想挑起语言之争，php，nodejs，java，ruby等都有丰富的生态环境。不过目前来看，技术选型用Python在招聘、学习、培训、敏捷开发等方面还是一个比较折中的选择（主要在于人，而不是语言）。
python，ruby之类的动态语言优势在于其生产力，你能在极短时间内就搭建出原型从而赢得产品竞争。
推荐一下几本个人认为比较好的Python书籍:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.python-guide.org/">《python-guide》</a> requests作者写的guide，偏向工程方面</li>
<li><a class="reference external" href="http://use-python.readthedocs.io/zh_CN/latest/">《use python》</a> use python</li>
<li><a class="reference external" href="http://python.swaroopch.com/">《A Byte of Python》</a> 一百多页的小书，可以快速熟悉Python语言。</li>
<li><a class="reference external" href="https://book.douban.com/subject/26801374/">《Python核心编程》</a> 比较全面的Python书籍，介绍了Python语言的方方面面。</li>
<li><a class="reference external" href="http://www.diveintopython.net/">《Dive Into Python》</a> 一本免费的开源书</li>
<li><a class="reference external" href="https://book.douban.com/subject/26278021/">《Fluent Python》</a> Python进阶的好书，没有之一，涉及了很多Python高级主题和实现特性。</li>
<li><a class="reference external" href="http://python3-cookbook.readthedocs.io/">《Python3 Cookbook》</a> Python进阶读物，汇集了很多技巧。</li>
<li><a class="reference external" href="http://www.dabeaz.com/">《Dabeaz》</a> Python 培训领域 number one，Pycon 常客，有很多高质量的教程</li>
<li><a class="reference external" href="https://github.com/gto76/python-cheatsheet">《Python Cheatsheet》</a>  Python 语法快速参考</li>
</ul>
<p>当然还有Python的官方文档作为参考，不过有些文档比较晦涩，还是推荐书籍入门。网上目前也可以搜到很多免费的电子书。
如果有时间可以看看国内廖雪峰写的Python教程，简单易懂，就是跳跃有点大（有些章节对新人来说不是很友好）。</p>
</div>
<div class="section" id="id2">
<h5>算法与数据结构<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<p>编写良好的代码需要了解常用的算法和数据结构，虽然你可能很少会自己实现，但是对于Python语言中一些常用数据结构如list, tuple, set, frozenset, dict和collections模块中的OrderedDict, defaultdict, deque, namedtuple, Counter等应该知道什么时候用。最主要的还是了解算法中递归，二分等常用思想，写出高效易用的代码。如果你想在线练习，可以做一些Acm基础题或者去leetcode等网站刷题。
推荐书籍:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/PegasusWang/python_data_structures_and_algorithms">《Python 算法与数据结构中文教程》</a> 笔者自己撸的一个教程，包含免费的讲义和代码以及付费视频。</li>
<li><a class="reference external" href="http://study.163.com/course/introduction.htm?courseId=1005526003">《网易云课堂-Python 算法与数据结构教程》</a> Python 算法和数据结构视频教程</li>
<li><a class="reference external" href="https://book.douban.com/subject/26979890/">《算法图解》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/20432061/">《算法导论》</a>  你可以挑选感兴趣的章节啃一啃，也可以去网易公开课看下视频教程。如果不是计算机专业的可以看下《计算机科学导论》这门公开课，正好也是以Python语言讲解的。</li>
<li><a class="reference external" href="https://github.com/PegasusWang/awesome-algorithm">《awesome-algorithm》</a></li>
</ul>
</div>
<div class="section" id="id7">
<h5>计算机网络<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h5>
<p>对于应用开发者来说大部分时间可能不太会接触特别底层的问题，但是了解网络的运行原理还是必要的。网上有个面试题  <a class="reference external" href="http://fex.baidu.com/blog/2014/05/what-happen/">从输入URL 到页面加载完成的过程中都发生了什么事情？</a> 如果对其中大部分的概念都了解就算是入门了。网络相关书籍可以随便找一本看看。Http协议对于web开发者来说比较重要，需要深入了解。推荐书籍:</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/25863515/">《图解Http》</a>
一本小白入门Http协议的好书，有大量图片示例。</li>
<li><a class="reference external" href="https://book.douban.com/subject/10746113/">《Http权威指南》</a>
Http协议最权威的讲解，大部头著作，可以看看最基础的部分。</li>
<li><a class="reference external" href="https://piaosanlang.gitbooks.io/spiders/01day/README1.html">《网络爬虫教程》</a>
非常不错的爬虫教程。感谢原作者，其实感觉这种把学习的内容总结成小书的方式很好。</li>
<li><a class="reference external" href="https://germey.gitbooks.io/python3webspider/">《Python3 网络爬虫实战》</a></li>
<li><a class="reference external" href="http://www.pythondoc.com/flask-restful/second.html">《使用 Flask-RESTful 设计 RESTful API》</a></li>
<li><a class="reference external" href="https://opensource.zalando.com/restful-api-guidelines/index.html#table-of-contents">《restful-api-guidelines》</a></li>
</ul>
</div>
<div class="section" id="id10">
<h5>网络编程(进阶)<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h5>
<p>如果想要深入了解一些网络框架的底层原理就需要学习底层socket网络编程了，比如《unix 网络编程》，《Linux 高性能服务器编程》等。
推荐一些入门资料：</p>
<ul class="simple">
<li><a class="reference external" href="http://beej-zhcn.netdpi.net/">《Beej&#8217;s Guide to Network Programming》</a></li>
</ul>
</div>
<div class="section" id="linux">
<h5>Linux系统<a class="headerlink" href="#linux" title="永久链接至标题">¶</a></h5>
<p>互联网时代软件慢慢从传统的桌面软件到移动端、浏览器演化(这其实也是脚本语言能在 IO 密集的 web 领域使用广泛的原因)，虽然 Linux 在桌面领域上完败，但是其开源和低成本的特性在网站服务器端、学术和工程领域使用广泛。
大部分Python应用都是跑在Linux服务器上的，大部分开源服务器软件使用的也是linux系统，即使日常工作不使用linux，一些基本的linux命令也要了解。
比如常用的文件操作，目录操作，进程操作等。你可以使用类unix系统mac或者linux版本ubuntu作为学习环境。
推荐：</p>
<ul class="simple">
<li><a class="reference external" href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/">《Linux工具快速教程》</a></li>
<li><a class="reference external" href="http://conqueringthecommandline.com/book/">《CONQUERING THE COMMAND LINE》</a> 掌握这上面的命令基本就可以满足日常需求了。</li>
<li><a class="reference external" href="https://www.tecmint.com/linux-network-configuration-and-troubleshooting-commands/">《13 Linux Network Configuration and Troubleshooting Commands》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/4889838/">《鸟哥的Linux私房菜.基础学习篇》</a> 浅显易懂，入门Linux命令的好书。</li>
</ul>
</div>
<div class="section" id="id13">
<h5>数据库<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h5>
<p>了解常用的关系型和非关系型(NoSQL, Not Only SQL)的数据库的使用。
现在网站业务后端用得比较多的数据库:</p>
<ul class="simple">
<li>传统关系型数据库（mysql等），使用广泛，不够灵活</li>
<li>内存型(k-v型)数据库（redis等）</li>
<li>文档型数据库（mongodb等）</li>
<li>列式存储(HBase)，大数据场景下的 IO 问题</li>
<li>全文搜索型(Elasticsearch)</li>
</ul>
<p>每种数据库各有优势和其使用场景，后端程序员需要了解下不同类型数据库的使用方法和应用场景，灵活应用到后端存储设计之中。
关于各种数据库网上已经有不少资料，读者可以自行搜索学习，mysql 和 redis（包括使用、设计、原理、优化）是重中之重。可以看看《Mysql 必知必会》和《Redis 实战》
对大数据感兴趣的可以学习下 Hadoop 生态系统。</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/26197294/">《Designing Data-Intensive Applications》</a>
了解各种数据存储模型，本书覆盖面很广，适合有一定基础的人阅读</li>
</ul>
</div>
<div class="section" id="id14">
<h5>python 相关库的使用<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h5>
<p>python一大优势在于数量丰富的库，灵活使用各种python库能帮助我们快速做出产品。作为web开发者，你需要了解常用python库和框架的使用，比如django/flask/tornado/sqlalchemy/requests/pandas等。</p>
</div>
<div class="section" id="web">
<h5>web 框架<a class="headerlink" href="#web" title="永久链接至标题">¶</a></h5>
<p>大部分后端业务逻辑开发中都会使用 web 框架，提升开发效率。常用的 python web 框架有 Django、Flask、Tornado 等，一般 web
框架都包含 http 处理、表单验证、模板引擎、ORM 、Restful 接口等，最好能熟练掌握一个 web 框架，帮助快速做出产品。</p>
</div>
<div class="section" id="id15">
<h5>版本控制<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h5>
<p>目前最流行的应该就是git了，很多公司使用 gitlab 管理代码仓库。版本控制工具是多人协作必不可少的工具，入门的程序员需要掌握基本的git命令，可以把github作为个人练习的工具。
遵守你们公司的 git 工作流程，git 是一个很强大但是很容易被初学者错误使用的工具。</p>
<ul class="simple">
<li><a class="reference external" href="http://semver.org/lang/zh-CN/">《语义化版本控制》</a></li>
<li><a class="reference external" href="https://git-scm.com/book/en/v2">《Pro Git》</a></li>
</ul>
</div>
<div class="section" id="id17">
<h5>Web 服务器<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h5>
<p>Nginx 目前很流行，使用比较广泛，推荐学习和使用。熟悉基础的 LNMP 架构(Linux + Nginx + Mysql + Python)，目前很多公司采用了都是多语言+微服务架构(基于 docker)。
你可能需要了解常见的 web 应用部署方式以及如何使用 nginx 等负载均衡</p>
</div>
<div class="section" id="id18">
<h5>微服务架构<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h5>
<p>目前很多流行的网站采用了微服务架构，每个团队负责维护自己的服务(逃离单体地狱)。以下是学习微服务的一些比较好的书籍。</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/26772677/">《微服务设计》</a> 入门微服务概念的一本书</li>
<li><a class="reference external" href="https://book.douban.com/subject/33425123/">《微服务架构设计模式》</a> 评价颇高的一本微服务实践书籍(java语言)</li>
</ul>
</div>
<div class="section" id="id21">
<h5>前端知识<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h5>
<p>基本的 html，css，javascript 需要有所了解。很多后端工程师需要做一些工具或者管理后台之类的，了解前端知识会有帮助。如果有兴趣深入前端可以了解下 Vue/React/Angular 等流行的框架。</p>
</div>
<div class="section" id="id22">
<h5>学习和搜索能力<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h5>
<p>初学者碰到的大部分技术问题都是可以通过 google 解决的，用好 google/stackoverflow/github 和各种技术论坛、牛人博客等能帮助你了解最新的技术。</p>
<ul class="simple">
<li><a class="reference external" href="https://engineering.instagram.com/">《Instagram Engineering》</a> Instagram 技术博客，有不少 python 相关的技术文章</li>
</ul>
</div>
<div class="section" id="id23">
<h5>业务领域知识<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h5>
<p>不同公司业务不同，经营（挣钱）领域不同（游戏、广告、媒体、社交、金融等），可能需要了解相关领域知识，方便业务建模。建议找工作之前研调下相应公司、经营领域、使用的技术栈等，不要太盲目，找到自己感兴趣的方向(后端知识很广)，有时候方向和平台很重要，直接决定了你的工资和发展。
比如基金公司可能需要了解投资相关知识，社交公司可能要懂一些 feed 设计知识，媒体公司可能需要懂多媒体相关知识。(当然重点还是用 python 实现业务逻辑)</p>
</div>
<div class="section" id="id24">
<h5>专业素养<a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h5>
<p>公司做项目不是自己过家家，需要你具备写文档，注释，单元测试，沟通表达、与人协作、处理业务的能力。如果你现在还不了解一个正规python项目都有哪些组建构成，请去github克隆一份知名的代码仓库，花点时间仔细分析下它的项目结构和源代码。
比如著名网站reddit代码已经开源，大部分python实现，可以参考下。另外很多著名的python库，比如requests/flask等也可以作为参考。从笔者短暂的从业经历来看，大部分自学python的人不怎么遵守代码规范（pep8），
不知道或者不重视单元测试（写个函数print下就觉得OK了），不知道怎么写注释和文档（docstring听过吗？）。所以希望学习python的你能遵守工程实践，具备良好的职业素养和编码习惯，推荐阅读《代码大全》《编程匠艺》之类的工程相关的书。</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/11614538/">《程序员的职业素养》</a></li>
</ul>
</div>
<div class="section" id="id26">
<h5>软件工程<a class="headerlink" href="#id26" title="永久链接至标题">¶</a></h5>
<p>如果有时间我建议了解下软件工程相关的东西，在你没工作之前看书本的东西不会有太多体会，但是工作以后就会感受到做项目远远不是只有写代码这么简单。包括整个开发流程、进度管理、质量管理等还是有很多学问的。
这里推荐一本邹欣(现任微软Windows中国工程团队首席研发总监)的书，读起来比较接地气。</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/27069503/">《构建之法-现代软件工程》</a></li>
</ul>
</div>
<div class="section" id="id28">
<h5>后端技术栈<a class="headerlink" href="#id28" title="永久链接至标题">¶</a></h5>
<p>web 后端工程师的主要工作职责是实现网站、app 业务后端逻辑(产品业务逻辑)，涉及到的技术相关知识点基本就是上边列举的这些。
对于技能需求可以在拉勾上搜一下Python的职位，看看各个公司对Python的要求。或者你可以写个拉勾网的爬虫，对数据做一个简单的统计，笔者当初找工作就是这么干的。找工作之前最好研究下期望公司的业务和使用的技术栈，有针对性学习。
另外，真正做项目还需要你熟悉python的各种库和框架，比如django/flask/tornado/requests/sqlalchemy/unittest/celery等等，掌握了合适的工具才能快速上手做东西，公司恨不得你第一天入职第二天就能写项目。
所以，在你入了门以后请尽快熟悉python web的技术栈。公司不管你会什么算法，只在乎你的生产力(有时候技术本身不重要，它的价值在于对业务、用户、顾客的贡献)。
推荐一些文章供参考:</p>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/36267942">《Python Web 学习路线图[视频]》</a></li>
<li><a class="reference external" href="https://github.com/phodal/growth-ebook">《全栈增长工程师指南》</a></li>
<li><a class="reference external" href="http://skill.phodal.com/">《web开发路线图》</a></li>
<li><a class="reference external" href="https://www.zhihu.com/question/24952874">《后端都要学习什么？》</a></li>
<li><a class="reference external" href="http://www.wklken.me/posts/2013/12/21/python-jd.html">《PYTHON招聘需求与技能体系》</a></li>
<li><a class="reference external" href="http://www.wklken.me/posts/2014/07/26/python-tech-stack.html">《PYTHON后端相关技术/工具栈》</a></li>
</ul>
</div>
<div class="section" id="id34">
<h5>学习路线<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h5>
<p>看了这么多是不是还有点懵，笔者当时自学的时候也没人带，没什么方向，走了很多弯路，找工作也不是一帆风顺。如果不是科班出身受过系统的计算机科学理论的训练，是比较吃亏的，只能通过大量针对性学习和练习来弥补。
大概整理下自己学习 python web 的路线，方便大家做个参考(一个合格的工程师不是短时间能练成的)。其实这基本上也是后端工程师的学习路线，换一个编程语言或者框架都差不多。技术更新迭代非常快，后端技术还算比较稳定的，但是知识点很多很杂，有针对性学习比较好。
如果你觉得这个教程列出的东西太多，建议就找最重要的知识点，每个知识点挑一本最合适的书学习，我列举的很多资料对于初学者来说可能短时间内难以消化，会有畏难心理和学习焦虑，建议多加练习通过正反馈提升自己学习的乐趣。（如果你还是个学生那很好，有大把的时间准备）</p>
<ul class="simple">
<li>学习并熟练掌握一门编程语言(学好英语)。这里笔者选择的是最近特别火的 python，它能干很多事。挑一本好的入门教材，通读并实践书中所有代码示例和练习题（练手感，坚持敲，大量敲）。了解该语言如何操作文本、进程、网络编程等，最后达到能熟练运用编程语言表达逻辑的能力。</li>
<li>搭建好开发环境。初学者个人比较推荐 Ubuntu 系统 + Pycharm 社区版，都是可以免费获取的，我经常安利用 linux 或者 mac，和桌面端不同，企业大部分用的都是 linux server 部署 web 应用的(包括 docker 容器技术等都是基于 linux)，熟悉 linux 命令行、文件、进程操作等会给你找工作和日常工作带来便利。</li>
<li>熟悉算法和数据结构。对于编程语言内置的数据结构、算法等要数量掌握和使用，常用数据结构和算法了解其原理，会计算时间空间复杂度，会自己实现(常见算法面试笔试常考)。</li>
<li>熟悉网络协议 TCP/IP，HTTP，了解互联网是怎么运作的。既然是做网站，需要对网络运行原理比较了解。</li>
<li>学习 web 框架和 python 库。做东西我们需要大量现成的轮子帮助我们，看下 django、flask 等流行的 tutorial，然后做个简单的网站出来（比如博客网站，一般按照教程撸一遍就入门了，python web 框架的文档非常完善）。最好能深入一个框架了解原理，比如看看 flask 和 Werkzeug 源码。</li>
<li>了解前端知识。如果能独立做一个博客出来，大概对 html、css、js 就有所了解了。虽然是做后端，但是基本的前端知识也是必不可少的。</li>
<li>学习业务常用数据库 mysql 和 redis，业界用得比较多的数据库。了解关系型数据库 mysql 基础概念、语句、索引优化等，了解内存型数据库 redis 的常用数据结构，使用场景、结构设计等。</li>
<li>学习 git 版本控制。公司项目协作的时候都是有版本控制的，方便我们协作、记录、回滚代码等。学习编码规范，培养良好的编程习惯。我建议一开始就遵守 pep8，用好 autopep8，pylint 等工具，写出格式规范的代码，不要走野路子。（学习下文档和规范很棒的 python 开源代码）</li>
<li>在 linux server 部署你的 python web 服务。你需要学习 linux 常用命令，web 服务器 nginx 等。最好能独立部署一个网站出来。(笔者经常安利 linux 或者 mac，即使不用来作为开发环境，也要熟悉 linux 命令，能帮助你在服务器上快速修改和调试代码)</li>
<li>对照招聘网站中意的公司的招聘需求查漏补缺。初期就是要多学多练多 google，不是做项目就是在刷题。可以做一些博客、论坛、管理后台等小网站练手。</li>
<li>老实说相比 java 和 php，python 后端岗位是比较少的，如果你学完了还没找到工作然后来臭骂我一顿我会感觉委屈的。我个人倾向于 python 是因为真爱，并且学习python 性价比很高，可以做很多事。如果你觉得不好找工作或者只是把 python 当玩具玩(比如用 pandas 分析自己的投资收益，回测等)，换个语言和技术栈后端路线图基本上还是这些，不会白学的。</li>
<li>建议坚持写技术博客，学习笔记等，总结输出(比如所谓的费曼学习法就是强调你要把学到的讲给别人听才是真正理解了)。你可以使用 hexo 之类的静态博客，或者知乎专栏等现成的服务，或者 readthedoc、gitbook 之类的文档工具。好的技术博客是找工作的一大加分项，笔者工作以后依然坚持写博客记录日常所学，可以是读书笔记、学习心得、对某个技术的理解和实践、甚至是备忘录等。</li>
<li>进阶建议：看《Fluent Python》 之类的进阶书籍；看优秀的源码，比如 python 一些内置库，flask 等优秀的框架源码(可以用 gitx 之类的工具从代码的最初提交开始看起)，能学到很多惯用法和稍微底层一些的东西。尝试仿写，比如实现个简单的 web 小框架，大概就了解框架的运行原理了。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://braydie.gitbooks.io/how-to-be-a-programmer/content/zh/">《How to be a Programmer 中文版》</a></li>
<li><a class="reference external" href="https://github.com/kamranahmedse/developer-roadmap">《Roadmap to becoming a web developer in 2019》</a></li>
</ul>
</div>
<div class="section" id="id35">
<h5>求职与面试<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h5>
<p>之前求职的时候每次面试都会充分准备（自己挂过很多次），提前一个月左右开始回顾重点理论知识(看面试相关的书)，刷常用算法，练习手写代码，看相对岗位的招聘需求等。最近面试就发现很多面试者无论是否是有经验都准备不足，忽略了基础知识。
如果没有知名公司或者项目相关背景，很多招聘要求比较高的公司都会比较看重理论基础和学习能力。公司最好能有一份针对初级、中级、高级岗位的题目，尽量覆盖面广泛、难度适中，防止因为面试官的个人喜好影响面试结果。</p>
<ul class="simple">
<li>我建议你闲着没事的时候可以多看看招聘信息，熟悉各个公司对当前技术栈的要求，看看自己和意向公司差距在哪，查漏补缺</li>
<li>电子简历尽量用 pdf 格式，方便跨平台打开。doc 等格式在不同的电脑上打开会有排版问题，很多后端技术面试官可能使用的是 mac 或者 linux。</li>
<li>提前复习回顾重点知识，防止卡在基础上。比如 mac 下著名的 brew 工具作者面试 google 就因为没写出来反转二叉树被拒，后来去了苹果😂.(这就只能看人品和运气和眼缘了，如果没见到二面面试官或者 hr，大概率是挂了)。（树、链表、哈希表、二分、快排、TCP/UDP、HTTP、数据库ACID、索引优化等常考点）。</li>
<li>白板编程，练习在纸上手写代码。虽然很多求职者都很抵触手写代码，但是白板编程确实是一种比较好的区分方式。你的思考过程、编码习惯、编码规范等都能看出来。</li>
<li>如果被问到工程里不会使用但是比较刁钻的算法题，建议你和面试官沟通的时候问问这个算法或者题目在开发中有哪些实际使用场景，看看对方怎么说😎。</li>
<li>面试的时候准备充分，简历要与招聘方需求对等。笔者每次面试都会带上白纸、笔、简历、电脑等，即使面试没过，至少也让面试官感觉我是有诚意的，给对方留下好印象。</li>
<li>加分项：github、个人技术博客、开源项目、技术论坛帐号等，让面试官有更多渠道了解你，有时候仅仅根据几十分钟的面试来评判面试者是有失偏颇的。（比如面试者临场发挥不好；面试官个人偏好；会的都不问，问的都不会等）</li>
<li>面试之前可以适当刷题，这几年招聘难度越来越大， 很多互联网公司都会问一些 leetcode 上的题目，如果不准备很有可能当场写不出来</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://github.com/taizilongxu/interview_python">《interview_python》</a> python 面试题</li>
<li><a class="reference external" href="https://github.com/taizilongxu/interview_python">《程序员面试金典》</a> 程序员面试，很多公司会比较重视基础知识</li>
<li><a class="reference external" href="http://skycrab.github.io/PythonEngineer">《Python后端工程师必备技能》</a></li>
</ul>
</div>
<div class="section" id="id38">
<h5>系统/架构设计进阶<a class="headerlink" href="#id38" title="永久链接至标题">¶</a></h5>
<p>对于有经验的工程师来说，系统设计也是一项重要的能力（也是除了存储系统、程序设计、网络通讯、操作系统之外经常被面试考到的）。比如设计一个短网址服务、简单的 feed 流系统、推荐系统、发号器服务等。笔者也处于学习中，推荐个资料供参考：
(其实中高级后端涉及的其他东西还挺多的，系统设计、大数据存储、消息队列、分布式、缓存、并发优化、软件工程等)</p>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/PegasusWang/91294caa0ab26a5c67b9b52d56178905">《backend-architectures》</a></li>
<li><a class="reference external" href="http://highscalability.com/">《http://highscalability.com/》</a></li>
<li><a class="reference external" href="https://github.com/PegasusWang/system-design-interview">《https://github.com/PegasusWang/system-design-interview》</a></li>
<li><a class="reference external" href="https://legacy.gitbook.com/book/soulmachine/system-design/details">《System Design》</a> 常见系统设计题目</li>
<li><a class="reference external" href="https://github.com/PegasusWang/system-design-primer">《https://github.com/PegasusWang/system-design-primer》</a> 关于系统设计和架构设计相关的资料</li>
<li><a class="reference external" href="https://github.com/puncsky/system-design-and-architecture">《system-design-and-architecture》</a> 系统和架构设计</li>
</ul>
</div>
<div class="section" id="web-python-golang-golang">
<h5>Web 开发常用 Python 库(Golang 常用库请参考 golang 章节)<a class="headerlink" href="#web-python-golang-golang" title="永久链接至标题">¶</a></h5>
<p>列举平常开发常用的一些库和框架(你可以很容易 google 到它们的用法)，你不必一开始就掌握它们，但需要的时候了解它们的用法会大大提升你的开发效率，
在开发工具章节我还会列举到更多能够提升开发效率的工具。</p>
<ul class="simple">
<li>web/restful 框架：Django/Flask/Tornado</li>
<li>异步http web框架：FastApi/aiohttp/Sanic</li>
<li>ORM: sqlalchemy, Peewee</li>
<li>表单验证：WTForms, marshmallow</li>
<li>数据处理和分析：Numpy, Pandas, Matplotlib</li>
<li>异步：celery, asyncio, tornado</li>
<li>并发：gevent, threading, concurrent.futures</li>
<li>部署：uwsgi, gunicorn(推荐)</li>
<li>html 处理: lxml, beautifulsoup</li>
<li>爬虫：requests, Scrapy</li>
<li>单元测试：unittest, nose, pytest(推荐)</li>
<li>图片处理：pillow</li>
<li>python2/3 兼容：six, 2to3</li>
<li>代码检测：autopep8, pylint, flake8, mypy(python3)</li>
<li>调试：Ipython, Ipdb, pdbpp</li>
<li>终端：rich(美化颜色输出)</li>
<li>命令行：click</li>
</ul>
</div>
<div class="section" id="id39">
<h5>裁员、劳动法与法律援助<a class="headerlink" href="#id39" title="永久链接至标题">¶</a></h5>
<p>最近几年裁员事件逐渐增多，互联网 ToC 端增长见顶，很多收益不好的公司或者创业公司效益不行。
作为一个码农，要适当了解法律常识，学会维护自己的合法权益。</p>
<ul class="simple">
<li><a class="reference external" href="https://www.zhihu.com/question/357459810/answer/913255932?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=31478419292160">如何看待网传网易裁员，让保安把身患绝症的 5 年老员工赶出公司一事？</a></li>
<li><a class="reference external" href="https://mp.weixin.qq.com/s/t3Ob6AHlYeO-rZf5c6cknw">网易裁员事件引发的思考：5点建议，越早懂，越能保护自己</a></li>
</ul>
</div>
</div>
<span id="document-codingstyle/codingstyle"></span><div class="section" id="codingstyle">
<span id="id1"></span><h4>编码之前碎碎念(工程实践)<a class="headerlink" href="#codingstyle" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>Controlling complexity is the essence of computer programming.  — Brian Kernighan</div></blockquote>
<p>有些人喜欢动态语言的表达能力和灵活性，有些人却讨厌动态语言，认为动态语言工程不友好，性能低、易出错、难重构。在项目中应该结合不同语言的生产力、性能、生态圈、招聘需求、产品周期等，灵活选取，扬长避短。
动态语言比较适合构建 mvp（最小可用产品），所以很多创业公司后端、内部项目、微服务等在用。以下是笔者从业过程中总结的一些工程实践，因为动态语言本身的特性，需要良好的工程控制保证代码质量，否则将来项目代码仓库可能会失控。
目前网上关于 python 项目工程的资料比较少，以下是笔者的一些实践经验(不局限于Python)，有一定局限性，仅供参考。</p>
<div class="section" id="id2">
<h5>技术雷达<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<p>中小公司尽量统一技术栈，减少运维，维护和学习成本，总结最佳实践。可以在数据库，框架，编程语言，基础组件等建立技术雷达，以供业务选型。</p>
<ul class="simple">
<li>统一编程语言和框架。比如使用 cookiecutter 之类的工具生成统一的项目代码框架，有利于统一维护。</li>
<li>统一代码组织结构。有利于维护，代码迁移和重构，如果每个项目代码组织都不一样，维护和迁移起来会很累，一致的代码组织你甚至可以轻松把一个项目的文件夹搬到另一个</li>
<li>统一数据库选型。统一建表规范，防止给以后埋坑</li>
<li>统一基础组件(中小公司可能没有，尽量使用成熟的开源组件)</li>
</ul>
<p>不同团队之间可以使用不同技术栈，不过小组内部统一技术栈有利于快速业务迭代，总结 best practice。小组定期技术分享，打造学习型团队。</p>
</div>
<div class="section" id="id3">
<h5>代码风格<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<p>不一致的开发风格会给协作开发带来困难，同时也妨碍代码阅读，读代码的时间是远多于写代码的，所以有必要统一编码规范。推荐使用pep8或者其子集作为代码规范，使用vim插件python-mode开启pep8和pylint对代码静态检测。如果使用其他编辑器或者IDE工具最好也使用相关插件使代码符合规范。工程上的代码应该尽可能保持清晰易懂，推荐看看requests等优秀的开源库学习下。强烈建议新手看看以下参考写出格式规范的代码，强烈建议打开pep8和pylint，pylint可以帮助你干掉很多低级错误。建议使用py的公司都指定好自己的代码规范并且严格遵守，同时做好code review，防止造成以后的维护噩梦。
不要搞N无代码(无文档，无注释，无单测，无规范，无 review，无静态检测......)，笔者铲💩多了对这种代码深恶痛绝。</p>
<ul class="simple">
<li><a class="reference external" href="http://pep8.org/">《PEP8.org》</a></li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">《PEP 8 &#8211; Style Guide for Python Code》</a></li>
<li><a class="reference external" href="http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/contents/">《Google开源项目风格指南-Python风格指南》</a> google风格的docstring比较赞</li>
<li><a class="reference external" href="http://deeplearning.net/software/pylearn/v2_planning/API_coding_style.html">《API_coding_style》</a></li>
<li><a class="reference external" href="https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html">《code-example》</a></li>
<li><a class="reference external" href="http://www.kancloud.cn/kancloud/sina-boot-camp/64003">《编写优雅代码》</a>  新浪微博的培训课程，可以学习一下</li>
<li><a class="reference external" href="http://blog.2baxb.me/archives/1343">《烂代码的那些事》</a>  Axb的自我修养，大神的文章</li>
<li><a class="reference external" href="http://bwanamarko.alwaysdata.net/napoleon/format_exception.html">《三种docstring示例》</a></li>
<li><a class="reference external" href="http://liyangliang.me/posts/2015/08/simple-python-style-guide/">《Simple python style guide》</a></li>
<li><a class="reference external" href="http://blog.ganyutao.com/downloading/python%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83.pdf">《python编程规范》</a></li>
<li><a class="reference external" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">《practice-go》</a></li>
</ul>
<p>一个简洁的代码规范(想偷懒的话直接用pylint 和 autopep8 过一遍，强烈建议项目开始的时候就使用 pylint 检测代码，保持 clean code):</p>
<ul class="simple">
<li>格式请遵守pep8,务必开启编辑器的pylint和pep8检测。vim请试试python-mode插件，现在不过一下 pylint 都不太敢提交代码了，动态语言太容易出错。</li>
<li>业务逻辑应该限制一些过于灵活的特性，防止代码难以维护。比如元编程，随意的设置属性等，尽量保持业务代码易维护、易修改、易测试。</li>
<li>模块、类和函数请使用docstring格式注释，除显而易见的代码，每个函数应该简洁地说明函数作用，函数参数说明和类型，返回值和类型。对于复杂的传入参数和返回值最好把示例附上。如有引用，可以把jira，github，stackoverflow，需求文档地址附上。 良好的文档和注释很考验人的判断（何时注释）和表达能力（注释什么）。</li>
<li>动态语言的变量命名尽量可以从名称就知道其类型，比如url_list, info_dict_list，降低阅读和理解的难度。(我的感觉就是动态语言易编写，写不好后期更难维护)</li>
<li>风格上衡量不了请参考知名开源项目的做法。以可读性和维护性作为标准。(比如知名网站reddit的python代码已经开源了，可以作为参考，强烈建议大家克隆一份，经常拉取更新，看看人家怎么写的python代码)</li>
<li>阿里最近开源了一个规范《阿里巴巴Java开发手册》（其实这个教程也打算搞成 Python web 开发手册》，网上可以很容易搜到，写得比较细，建议新手下载来看看，有不少实战干货，很多思想是通用的，其实python的unittest等模块很多都是直接借鉴了java。还有新浪微博的《新兵训练营系列课程》</li>
<li>给一些小团队的建议就是所有人统一用 pylint 和 autopep8 工具， pylint 检测代码有没有明显缺陷，autopep8 用来整理格式(类似于 golang 的 gofmt)，至少在风格上就不用在费心统一格式了，代码洁癖必备。</li>
<li>pylintrc 参考：<a class="reference external" href="https://github.com/PegasusWang/linux_config/blob/master/pylintrc">https://github.com/PegasusWang/linux_config/blob/master/pylintrc</a> 这里我忽略了很多无关紧要的提示(ignore配置)，你可以按需增减，默认的 pylint 配置对代码检查实在是太严格了，很多老鸟也过不了。建议项目一开始就加上静态检查，让代码更加 clean。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/32902344">《Python 项目工程实践》</a>  如何通过工具构建良好的工程代码</li>
<li><a class="reference external" href="http://www.zlovezl.cn/articles/python-using-variables-well/">《Python 工匠：善用变量来改善代码质量》</a> 动态语言命名尽量可以表达出类型，否则不好维护</li>
<li><a class="reference external" href="http://www.dongwm.com/archives/Python%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">《Python最佳实践》</a>  董伟明的文章</li>
<li><a class="reference external" href="http://www.wklken.me/posts/2016/11/03/python-code-style.html">《PYTHON 代码规范小结》</a></li>
</ul>
</div>
<div class="section" id="id10">
<h5>编程范式<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h5>
<p>Python支持多重编程范式，过程式(Procedural)，面向对象(OOP)，简单函数式(Functional)编程。不同人，不同语言转过来的人，Python老鸟和菜鸟等写出来的代码风格迥异。对个人风格喜好不予评判，但是个人感觉还是需要深挖一些Python的特性，虽然Python容易入门，但是有些语言特性还是需要一段时间才能了解深入的。使用各种风格的时候要酌情判断，比如多个过程需要共享中间状态时，单纯的使用函数会写得很冗长，这时候就应当使用类。通常能用函数完成功能的就使用函数。当你无法判断哪种方式比较好的时候，请在解释器里边 <code class="xref py py-obj docutils literal"><span class="pre">import</span> <span class="pre">this</span></code> 看看。当可以实现一样的功能时，往往简单易懂的方式就是最好的。一些参考:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/kennethreitz/requests">《requests》</a> requests库是接口设计的典范，可以参考参考。</li>
<li><a class="reference external" href="https://book.douban.com/subject/26468916/">《Python3 面向对象编程》</a> 关于Python面向对象和一些设计模式。</li>
<li><a class="reference external" href="http://stackoverflow.com/questions/552336/oop-vs-functional-programming-vs-procedural">《OOP vs Functional Programming vs Procedural》</a></li>
</ul>
</div>
<div class="section" id="pythonic">
<h5>何谓Pythonic?<a class="headerlink" href="#pythonic" title="永久链接至标题">¶</a></h5>
<p>Python的世界里你会听到这个词&#8221;Pythonic&#8221;，大概就是指代码符合Python的惯用法，使用的都是Python的语法糖(我觉得可以翻译为『地道』)。比如从其他语言转到Python
的写出来的代码很可能受到以前思维方式的影响(别像 java 一样写一堆 getter/setter)，写出来的代码不够Pythonic:
比如:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 不够Pythonic</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># python里却可以这么写</span>
<span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># bad</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mylist_length</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># good</span>
<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">mylist</span><span class="p">:</span>
   <span class="n">do_something</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

<span class="c1"># bad, 不要使用默认可变对象作为默认参数</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">pass</span>

<span class="c1"># good, 可变类型使用 None 作为占位符，因为可变类型可能会被函数修改(副作用)，导致调用代码后边使用它的地方出问题</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Python有一些语法上的坑，比如默认参数只计算一次，不要使用可变类型作为默认参数等，看多了写多了就知道了。尤其是可变类型作为函数参数传入后被改变的情况（函数尽量不要有副作用,这里副作用指的就是修改了传入的可变参数的值），尤其要注意。
一些参考帮助写出Pythonic的代码（注意pythonic 不是要你炫耀奇淫技巧，很多小白不会注意可读性和可维护性，控制复杂度，用动态语言各种瞎搞，维护起来心累）:</p>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/JeffPaine/6213790">《Transforming Code into Beautiful, Idiomatic Python》</a></li>
<li><a class="reference external" href="http://blog.csdn.net/gzlaiyonghao/article/details/2762251">《Pythonic到底是什么玩意儿？》</a> 赖勇浩的博客</li>
<li><a class="reference external" href="http://docs.python-guide.org/en/latest/writing/style/">《python-guide Code Style》</a> python-guide关于代码风格的介绍</li>
<li><a class="reference external" href="https://www.cs.cmu.edu/~srini/15-441/F11/lectures/r04-python.pdf">《Learning the Pythonic Way》</a> 一个cmu的课件</li>
<li><a class="reference external" href="http://share.sm3.su/writing_idiomatic_python_3.pdf">《Writing Idiomatic Python3》</a> 一本免费小书</li>
<li><a class="reference external" href="https://book.douban.com/subject/25910544/">《编写高质量代码：改善Python程序的91个建议》</a> 给国人的书捧捧场^_^</li>
<li><a class="reference external" href="http://python.net/~goodger/projects/pycon/2007/idiomatic/handout.html">《Code Like a Pythonista: Idiomatic Python》</a>  我强烈推荐新手看看这个教程</li>
</ul>
</div>
<div class="section" id="tdd-shit">
<h5>敏捷与TDD(中华田园敏捷开发：快糙猛，产出一堆 shit)<a class="headerlink" href="#tdd-shit" title="永久链接至标题">¶</a></h5>
<p>笔者非计算机科班出身，对于软件工程的东西也不是很懂，最近扫了一本《敏捷软件开发-原则、模式与实践》，感觉有些东西还是挺有启发的。在这里稍微提一下敏捷中的TDD(Test-driven development)吧。因为Python是动态类型语言，不像静态语言可以编译期检查，很多问题运行时暴露出来，而且动态语言语法灵活也容易刨坑。用TDD是可以提升代码质量的，虽然有时候完全用TDD可能有些死板，但是TDD的一些思想还是很值得借鉴：</p>
<ul class="simple">
<li>测试最重要的是对架构和设计的影响，不是为了测试而测试。一般难以测试的代码往往是设计不好，耦合严重的代码。没有测试的代码同时也给重构带来压力和隐患。</li>
</ul>
<p>编码的时候想着如何测试它，甚至都可以改善设计。对于动态语言，一直有『动态语言一时爽，代码重构火葬场』这种说法，说明动态语言如果没有良好的设计和测试，以后是会埋下不少隐患的。
当你发现debug的时间甚至比写代码长很多的时候，当你发现总是返工对代码修修补补的时候，或者可尝试下TDD。
你可以学习使用下python的unittest或者pytest等进行单元测试，以保证代码质量。个人工作经验也表明，难以测试的代码往往是设计不太好的代码。
update: 经验表明，TDD未必是必要的，但是单元测试是很必要的。如果是新项目建议为所有的复杂函数写单元测试，为项目质量保证。大项目如果没有单元测试修改bug和重构会有很大风险。
另外一般写测试之前先写个失败的例子(比如我会在测试函数开头加上 assert 0 失败一下确保我这个测试函数真正跑了的，我见过不止一次由于命名没有加test开头压根就没跑测试函数的，还以为测试通过了)，确定测试是真正运行了的，因为之前出现过乌龙，单测函数命名没有用 test 开头结果导致根本就没有运行这个测试用例，后来修正了以后跑失败了，如果先失败一次就会避免这个问题，说白了就是保证你的测试用例确实是跑了的(red-green testing)。
感兴趣可以试试极限编程中的测试驱动开发和结对编程。
下边是一些参考:</p>
<ul class="simple">
<li><a class="reference external" href="http://codingsans.com/blog/code-quality">《COMPREHENSIVE GUIDE TO CODE QUALITY: BEST PRACTICES AND TOOLS》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/4037534/">《敏捷开发的艺术》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/11614307/">《敏捷技能修炼》</a>  实践出真知</li>
<li><a class="reference external" href="http://web2.0coder.com/archives/92">《Tips for agile developers》</a></li>
<li><a class="reference external" href="http://pytest.org/latest/">《pytest: helps you write better programs》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/5442024/">《代码整洁之道》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/10797189/">《编写可读代码的艺术》</a> 代码首先是写给人看的</li>
<li><a class="reference external" href="https://book.douban.com/subject/4262627/">《重构-改善既有代码设计》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/6398127/">《软件调试修炼之道》</a> 了解下调试和跟踪技术。</li>
<li><a class="reference external" href="http://www.yinwang.org/blog-cn/2016/09/14/tests">《测试的道理》</a> 垠神的博客</li>
</ul>
</div>
<div class="section" id="id19">
<h5>业务代码的一些常见原则<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h5>
<p>对于什么是好代码，什么是坏代码我现在还没有太多经验，但是最近工作接手别人的代码感觉困难重重，还是too naive啊。每个人实力不同，风格不同，一起协作的时候确实会遇到很多问题和分歧。感觉code review啥的还是很有必要的，可以让菜鸟学习下老鸟的经验，也可以让老鸟指导下菜鸟的失误，同时避免过于个人化的糟糕风格（比如让人想立马离职的高达成百上千行的复杂函数，比如上来一堆不知道干啥的幻数，比如上来就 <code class="xref py py-obj docutils literal"><span class="pre">from</span> <span class="pre">shit</span> <span class="pre">import</span> <span class="pre">*</span></code> 导致俺的编辑工具找不到定义，比如整个项目没有一行测试代码，比如不知道用logger，全用print+眼珠子瞅，一个bug找半天，比如没有pep8检测导致你的环境打开别人的代码彪了一堆警告......)。</p>
<p>说好的规范呢，说好的设计模式呢，说好的高内聚低耦合呢？说好的KISS原则呢？说好的DYR原则呢？其实俺只是想多活几年，至少不要到三十岁头发掉光。啥设计模式的可以不用，能干活的代码就行，牢记几个原则，没事的时候对复杂的东西重构下，代码不能自解释的搞搞文档，不被队友坑同时不坑队友，俺就心满意足了 ，遇到坑队友就等着加班和折寿吧:(。最后还是列举一下常用原则、思想和注意事项吧(下边原则是笔者阅读很多工程相关的书后总结的，比较宽泛，最好import this看看python之禅，很多思想是通用的):
老手区别于新手的一个重要特点就是，他能用掌握的代码、模式、工程知识来把复杂度控制在合理的范围之内，让代码具有可维护性，很多新手只会直来直去，需求多复杂就能把代码写得多复杂。</p>
<ul class="simple">
<li>可读性第一定理：代码的写法应当使别人理解它的时间最小化。如果有非常直白的表现方式，就不要用语法糖复杂化，导致理解困难。不要牺牲可读性过度追求短代码，合适的语法糖用在合适的地方，很多新手会炫技使用一些技巧导致代码难以阅读和维护。</li>
<li>KISS原则，Keep It Simple, Stupid。能简单的绝对不要复杂，不要炫耀代码技巧，简单可读最重要，后人会感谢你的，软件构建的核心就是控制复杂度。开发可以工作的、最简单的解决方案。除非有不可辩驳的原因，否则不要使用模式、原则和高难度技术之类的东西。很多新手没有控制复杂度的意识，很快弄出一堆难以维护的代码。</li>
<li>DRY原则，Don&#8217;t Repeat Yourself。代码复杂重复了就及时抽取出来，至少不会碰到大问题。当然不要矫枉过正，过度追求设计和通用可能导致难以维护和理解。重复代码一旦接口变动的时候就是灾难，要修改很多地方，一定要十分警惕代码重复(警惕复制粘贴，往往代码重复是设计、抽象不合理、意图不明确的表现，而且复制代码经常会出现忘记修改一些细节产生 bug)。事不过三原则。Prefer duplication over the wrong abstraction. - Sandi Metz</li>
<li>YAGNI(You Aren&#8217;t Gonna Need It)，不要猜测性编码，不用的及时删除，估计以后也不太可能会用到(经验表名你觉得将来可能会用到的基本都用不到，最后成了死代码)，冗余的无用代码会给维护者带来很多混淆和麻烦。Build the simplest thing that we need right now。『少即是多』</li>
<li>SLAP(Single Level of Abstraction Principle): 保持一个方法中的代码在同一个抽象层。</li>
<li>Clean Coder Rule: Always leave the code cleaner than you found it.  不用的代码及时清除，留着只会造成冗余和误解(如果你认为某段代码将来可能会用到，我明确告诉你基本上它是用不到的)。笔者经验是用动态语言写代码很难写出 clean code，必须上各种静态检测工具和规范来约束，防止代码腐化。</li>
<li>Design for failure. 微服务中一切都有可能失败。</li>
<li>最少惊讶原则。让代码的副作用尽量最小或没有，函数式编程相比之下 bug 会更少。(有统计数据支撑的结论)</li>
<li>快速失败，灵活使用断言护保代码。契约式编程(先验条件和后置条件)，越早失败，越容易排查错误。</li>
<li>增量式编程。及时清理技术债务，代码坏味道，防止『破窗』。及时重构不合理代码，及时进行测试，『慢即是快』，越早发现错误修复成本越低。很多统计数据的结果都显示，一名程序员在公司每天能产出的工业级别的代码不会超过百行。</li>
<li>隐藏复杂性。如果复杂性避免不了，应该尽让内部复杂，接口要保持简单易用，而不要因为业务逻辑复杂就堆砌一堆shit。合理抽象，隐藏细节。</li>
<li>一次只做一件事(Do one thing, and do it well)。尽量避免复杂度过高的逻辑，尽量做到代码简单，意图明确。</li>
<li>高内聚，低耦合。模块化。层次化。意义相近的东西应该放到同一个地方。写代码的时候想着怎么测试它就能避免过度复杂，耦合严重的代码。</li>
<li>代码应当易于理解。 《代码大全》、《编写可读代码的艺术》、《代码整洁之道》啥的都是告诉你代码最好自解释，好理解。记住代码首先是给人看的，其次才是让机器执行的，不要过度设计。同时警惕你觉得过于『精巧』的实现，很有可能成为以后代码维护的大坑。可读性基本定律：代码的写法应该使别人理解它所需的时间最小化。聪明的程序员可能写出复杂、精巧的代码(但是对于整个团队的维护来说未必是好事)，专业的程序员会写出可读性高的代码。</li>
<li>不要过早优化，最小可用原则。先测量(profiler)，后优化。根据二八定律，大部分性能瓶颈只在20%的部分，这些才是真正需要优化的地方。不要一开始写代码就极力想压榨所有性能，往往引入优化的同时也在引入风险、复杂度和难以调试的 bug。</li>
<li>不要炫技，可读性最重要。合适的地方使用合适的技巧，不要过度炫耀语法糖导致维护和理解困难。大部分人不是造轮子的，你用不着太多奇淫技巧。</li>
<li>不要重复发明轮子(除非你是在练习编程)。遇到问题首选稳定可靠的解决方案。比如处理excel报表等直接用pandas提供的函数非常方便，我经常看见还是有人自己写一堆恶心的处理函数而不用pandas。如果自己造轮子确保测试和文档，否则后续维护和上手会有很大成本。</li>
<li>自动化。重复执行的任务应该使之自动化(代码构建，自动化运维等），手动执行的东西最容易出错。python是写自动化脚本最合适的语言。</li>
<li>Think about future, design with flexibility, but only implement for production. 尽量设计良好，避免繁杂和冗余。好的架构和设计都是不断演进的。</li>
<li>文档化。哪些东西该文档化，哪些该注释需要做好，以便新手可以尽快上手。尽量做到代码即文档，tornado的文档和代码就是典范。</li>
<li>服务化。项目做大了以后及时拆分业务，保持单个代码仓库大小在一定规模。超大规模的代码仓库在部署和维护上会遇到很多问题。</li>
<li>不要直接吞掉任何非预知错误和异常，一定要做好日志记录。使用Sentry或其他工具记录好异常发生的信息，为定位bug提供便利，web端的bug一般不好复现。</li>
<li>墨菲定律：只要有错误发生的可能性，这种错误就一定会发生。所以对代码质量要严格要求，不要心存侥幸。</li>
<li>单元测试:F.I.R.S.T原则(Fast，Independent，Repeatable，Self-Validating，Timely)</li>
<li>......还有的大家可以自己补充。我强烈建议新手或者自学的同学看《代码大全》或者《编程匠艺》之中的任何一本，带你快速入门。当然有些东西只是建议，编程中往往没有绝对正确(不要过度迷信某些所谓的实践和原则)，只有相对更优，No Silver Bullet，大家在实践中摸索吧。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://www.zhihu.com/question/22508677">《编程到底难在哪里？》</a> 感觉对于业务后端来说，难就难在『变化』，需求总是在变，如何控制复杂度并且快速响应需求是一个很大的挑战</li>
<li><a class="reference external" href="https://book.douban.com/subject/1467587/">《Unix 编程艺术》</a>   如果你有时间可以当成小说看看，感觉有点宗教主义</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/The_Elements_of_Programming_Style">《The Elements of Programming Style》</a></li>
</ul>
<p>还有OOP那一套(封装、继承、多态)，当你设计一个类的时候需要有所注意(SOLID原则):</p>
<ul class="simple">
<li>单一职责原则(Single-Responsibility Principle): It should have a single purpose in the system, and there should be only one reason to change it.</li>
<li>开闭原则(Open-Closed Principle): 对修改关闭，对扩展开放。Code should open to extension but closed to modification.</li>
<li>里氏代换原则(Liskov Substitution Principle): 所有使用基类的地方都可以使用子类替换。Anywhere you use a base class, you should be able to use a subclass and not know it.要遵守Liskov替换原则，相对基类的对应方法，派生类服务（方法）应该不要求更多，不承诺更少。</li>
<li>接口隔离原则(Interface Segregation Principle): 不要强制客户端使用他们不需要的接口。Don&#8217;t force clients to use interfaces they don&#8217;t need.</li>
<li>依赖倒置原则(Dependence Inversion Principle): 高层模块不应该依赖于底层模块，他们都应该依赖于抽象。 High-level modules shouldn&#8217;t rely on low-level modules, both should rely on abstractions.</li>
<li>迪米特原则(Law of Demeter):</li>
<li>合成复用原则(Composite/Aggregate Reuse Principle):</li>
</ul>
<p><a class="reference external" href="http://aju.space/2016/06/17/use-S-O-L-I-D-in-python.html">《如何在Python里应用SOLID原则》</a></p>
<p>Unix 哲学(来自《Unix 编程艺术》)，如果你对 unix/linux 的设计哲学和发展历史感兴趣可以看看这本书（我经常安利后端开发者使用 mac/linux 系统，它们在学术界和工程界更受欢迎）：</p>
<ul class="simple">
<li>模块原则：使用简单的接口拼合简单的部件</li>
<li>清晰原则：清晰胜于机巧</li>
<li>组合原则：设计时考虑拼接组合。组合优先于继承</li>
<li>分离原则：策略同机制分离，接口同引擎分离</li>
<li>简洁原则：控制复杂度</li>
<li>吝啬原则：除非却无它法，不要编写庞大的程序</li>
<li>透明性原则：设计要可见，以便审查和调试</li>
<li>健壮原则：健壮源于透明与简洁</li>
<li>表示原则：把知识叠入数据以求逻辑质朴而健壮</li>
<li>通俗原则：接口设计避免标新立异</li>
<li>缄默原则：如果一个程序没什么好说的，就缄默</li>
<li>补救原则：出现异常时，马上退出并给出足够的错误信息</li>
<li>经济原则：宁花机器一分钟，不花程序员一秒</li>
<li>生成原则：避免手工hack，尽量编写程序去生成程序</li>
<li>优化原则：雕琢前先要有原型，跑之前先学会走</li>
<li>多样原则：绝不相信所谓『不二法门』的断言</li>
<li>扩展原则：设计着眼未来，未来总比预想来得快</li>
</ul>
</div>
<div class="section" id="id21">
<h5>python代码坏味道(新手经常犯的错误)<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h5>
<p>下边是笔者学习和维护代码的过程中总结的一些经验和发现的一些问题，可能有些地方会有分歧，python在工程实践方面的资料不如其他语言那么成熟，如果有分歧欢迎提 issue 讨论, 仅供参考（通常可能需要数月甚至数年的工程训练才能写出良好风格的代码）：</p>
<p>风格相关:</p>
<ul class="simple">
<li>不pythonic，写得很业余(随意)，真就信了半天学会python。笔者写代码强制用pep8和pylint检测代码(集成到编辑器里)，除了一些无伤大雅的提示（比如行长度超过80），其他错误和提示全部消除。一开始比较痛苦，习惯了能大幅提升代码规范性。</li>
<li>不要滥用动态特性，<strong>不要</strong> 在业务代码里使用元类，setattr 等随意设置属性，维护起来是个灾难。</li>
<li>不要硬编码，不要用幻数！上来就整一个不知道啥意思的magic number or string，大学老师没教你不要滥用幻数(if status=1，来告诉我1是啥意思)？使用Enum/dict/对象/const等替代掉无意义的幻数。总有人偷懒使用幻数，别人看懵逼的。</li>
<li>上来就 <code class="xref py py-obj docutils literal"><span class="pre">from</span> <span class="pre">shit</span> <span class="pre">import</span> <span class="pre">*,</span></code> 为了偷懒有可能会导致同名覆盖问题，还会让开发工具找不到定义，工程上不要这么用。</li>
<li>包导入顺序混乱，没有按照pep8要求，实际上rope等工具能自动帮你整理顺序，我现在就是偷懒随意写，直接让rope给我整理。(标准库，三方库，本地库，同级按照字典序，vim的话可以用rope插件自动整理顺序)</li>
<li>导入最好按照模块导入，使用的时候用module.func使用，防止from module import func的时候可能遇到的循环引用问题(模块设计不够合理)。</li>
<li>变量名乱起，表意不明，推断不出类型，加重理解负担。我在想是不是动态语言用匈牙利命名法要好一些，命名尽量要可以看出类型，比如复数表示容器类型，nums，cnts等后缀表示数值(通过后缀和词性来使名称更容易被推断出来含义，比如是属性还是方法)。动态语言一大诟病就是容易类型出错，复杂类型推荐多写点类型注解(python2 用注释标识类型)。</li>
<li>不遵守pep8，没有pylint检测，打开代码一堆语法警告，老子的编辑器满眼都是warnning，编辑器用不好就老老实实用pycharm，用编辑器就老老实实装好语法检测(pep8)和pylint检测插件，没有插件请考虑换一个editor。我个人的感觉就是python代码很容易写得难以维护，请务必加上pylint检测，帮助提高代码质量。还是推荐不想折腾编辑器的直接用好pycharm。</li>
<li>没有逻辑分块，一点都不重视排版，没有美感（这个就算了），就算不限制一行超过80列，也不能写一行写几百列吧，左右转头脑瓜子疼(请不要用tab，全用空格，不要有多余空白，vim有类似插件去除无用空白的)。使用良好的分行，空格使代码更美观，逻辑更清晰。</li>
<li>不要一行写太多逻辑，比如嵌套的列表推导。(Raymond&#8217;s rule: One logical line of code equals one sentence in English)。好的代码读起来应该和读英文差不多，从上到下知道每一步都干了什么。不要轻易为了代码技巧缩短行数，易读性更重要。业务代码能不用奇淫技巧就千万别用，维护起来心累。</li>
<li>统一编辑环境（editorconfig）、导入顺序（isort）、编码规范（autopep8）、静态检测（pylint），甚至统一命名规范和名词术语（不要相信各种中式英语，换一个人就看不懂了）。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://docs.python.org/3/faq/programming.html#what-are-the-best-practices-for-using-import-in-a-module">《https://docs.python.org/3/faq/programming.html#what-are-the-best-practices-for-using-import-in-a-module》</a></li>
<li><a class="reference external" href="https://docs.python.org/3/faq/programming.html#how-can-i-have-modules-that-mutually-import-each-other">《https://docs.python.org/3/faq/programming.html#how-can-i-have-modules-that-mutually-import-each-other》</a></li>
<li><a class="reference external" href="https://github.com/Droogans/unmaintainable-code">《unmaintainable-code》</a> 从反面教材学习如何编写 maintainable code</li>
</ul>
<p>异常相关：</p>
<ul class="simple">
<li>到处print，debug的时候加上，上线再删除（累不累亲？），logging模块很受冷落</li>
<li>上来就try/except了，把异常都捕获了，吞掉异常导致排错困难。就在我写这段的时候又因为使用了他人未经测试的代码排错许久，就是因为吞了异常没打出来异常信息。</li>
<li>捕获的异常应该尽量类型精确，范围清晰。不要上来就try一整个代码块，可以继承内置异常类定义自己的更为精确的异常类。</li>
<li>使用sentry等工具记录异常，有利于排查问题(能保存堆栈和现场信息)。切记不要轻易吞掉非预知异常，一旦出现问题不好排查，笔者之前维护的项目曾踩过坑，后来笔者引入了sentry排查问题方便很多。</li>
<li>捕获异常是为了处理它，确定要怎么处理异常，记录待修复？流程控制？交给上一层重新抛出(raise)？预知异常直接pass？</li>
<li>了解你所使用的类库函数会抛出哪些异常，需不需要捕获异常？自定义函数抛出的异常最好在docstring里写出来。</li>
<li>编写异常安全的代码: 即使发生了异常，也不会发生异常情况。比如，不会在数据库插入垃圾数据，不会异常终止等。</li>
<li>不应当处理超出必要范围的异常，完全预测发生的异常是很困难的，应该抛出给上层程序处理。</li>
</ul>
<p>python2 编码问题：</p>
<ul class="simple">
<li>包含中文的字符串常量注意使用 u 前缀</li>
<li>代码中尽量使用 unicode，需要网络 IO 和写入磁盘的时候使用 bytes</li>
</ul>
<p>模块相关：</p>
<ul class="simple">
<li>统一代码的分层结构（MVC），当拆分或者重构项目的时候，统一的代码分层结构会带来很多便利</li>
<li>导入模块而不是具体的函数或类，防止代码结构层次设计不合理导致循环引用。碰到循环引用可以通过把导入语句写到函数里的形式延迟导入</li>
<li>注意模块命名尽量不要和标准库或者第三方库冲突</li>
<li>注意子模块名称不要和上层模块冲突,否则会 &#8220;Import Error: Cannot import Name XXX&#8221;。也可以用 <code class="xref py py-obj docutils literal"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">absolute_import</span></code> 解决，默认会从顶层包查找。</li>
<li>推荐使用绝对导入</li>
</ul>
<p>函数相关:</p>
<ul class="simple">
<li>复杂函数没有docstring，接口易用性极差，传入了一个嵌套字典都不注释，娘来。python没有类型声明真是维护代码的一个大坑。</li>
<li>保持函数参数和返回值尽量使用简单数据类型，，更加容易读懂和构造单元测试。你传入dict或者对象不写docstring我知道字典有哪些字段(最坑爹的是动态语言你还没法跳转过去看参数 object 定义)？如果传入了复杂的参数或者返回类型，最好加上 docstring 说明。看别人代码最头疼的就是看不出参数传的啥结构，返回啥结构，尤其是动态语言，十分隐晦。所以除非必要，保持参数类型尽量简单。</li>
<li>函数要么修改传入的可变参数，要么返回一个值。请不要两者同时做。注意python默认参数只计算一次，如果默认参数不是immutable对象，最好使用None作为占位符。每次修改传入的可变参数之前要三思，出bug了不容易排查。注意 None 和 空值的差别，None 是单例的，用 is 来判断一个对象是否是 None。我们能写纯函数就用纯函数（返回结果只依赖于参数并且没有副作用的函数），不容易出错，并且易于测试和调试。</li>
<li>函数尽量不要有副作用，如果没有很强的性能要求，尽量不要直接修改传入的可变参数而是返回一个新的结果。重构的时候有修改了可变参数的函数重构起来会非常麻烦，保证函数有明确的输入和输出做单元测试的时候会很方便。很多小 bug 都是因为非预期修改了传入的可变参数导致的。一个有明确输入和输出的函数更加容易理解和编写单元测试，想象一下你传进去一个字典在函数里瞎改，非常难以理解。</li>
<li>避免在遍历一个序列的同时修改它，比如边遍历边移除列表里的元素，可能会导致非预期行为。</li>
<li>超长函数，没有复用和拆分，抱歉我智商低，不能理解好几屏都翻不完的，见谅。这么长居然还tm能工作，牛逼(我发现越是新手写的代码越难理解,我实习那会总被说代码写得像面条)。控制复杂度，程序的复杂性决定了一个人要花多大努力才能理解程序。Dijkstra说过『一个聪明的程序员总是清楚地知道自己的脑力容量有限，因此他得十分小心谨慎地完成编程任务』。这不意味着为了处理复杂问题你得增大你的脑力，而是说你得想尽办法尽可能降低复杂性(彻底理解你要解决的问题)。要认识到人的脑力负荷是有限的，凡是你现在绞尽脑汁写的shit 一样的代码，将来维护起来都要花数倍的精力。如果遇到过长的代码，不如把逻辑分为几块，然后每一块抽出来作为函数并且合理命名，这样就容易理解了，别堆砌一长坨。</li>
<li>函数『圈复杂度』太高，一堆嵌套逻辑判断，导致测试难以覆盖到所有分之，单元测试几乎就没法写，恩，你压根不写单元测试就当我没说。比如你可以用德摩根律、表驱动法替代过多if/else判断，每当你写下一个if的时候，确定是否需要对应的else。感兴趣的可以搜搜软件工程里关于圈复杂度的概念，降低复杂性是编写高质量代码的关键。也可以尝试用结构化编程、单出口等方式降低代码出错率。</li>
<li>穿插着让人摸不着头脑的代码片段。（对于变态的产品需求或者非常triky的代码必须加上注释）。个人非常推崇『意图导向』编程，就是每写下一个块模、函数、类、代码片段的时候，除非显而易见或者约定俗成，否则都注释上你为什么需要它、它在哪里会用到。如果所有代码都得通读一边才能知道它是干啥的，是非常耗时的。(笔者挺痛恨阅读动态语言写的代码)</li>
<li>没注意可变类型和非可变类型，传入可变类型并在函数里修改了参数(无意的修改)，坑。。。还有一种坑 <code class="xref py py-obj docutils literal"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">b</span> <span class="pre">=</span> <span class="pre">c</span> <span class="pre">=</span> <span class="pre">[]</span> <span class="pre">or</span> <span class="pre">a,</span> <span class="pre">b,</span> <span class="pre">c</span> <span class="pre">=</span> <span class="pre">[],</span> <span class="pre">[],</span> <span class="pre">[]</span></code> ，注意可变类型会引用同一个对象，注意 python 中的深浅拷贝，可变与非可变对象。</li>
<li>滥用 <code class="xref py py-obj docutils literal"><span class="pre">(*args,</span> <span class="pre">**kwargs)</span></code> 导致函数接口模糊，有类似接口应该明确用docstring写明需要传入什么参数，&#8221;Explicity is better than implicity&#8221;，不要为了偷懒把代码写得隐晦。请尽量使用简单参数类型并保持接口清晰。</li>
<li>返回多个值可以使用namedtuple封装，比用下标更直观。对于可能经常需要变动的返回值，返回字典或者对象要比返回tuple容易修改。但是这种复杂的返回类型最好在docstring里注释下返回结构。适当使用抽象数据类型（ADT）增加代码可读性。</li>
<li>减少重复代码，否则将来接口变动一旦修改就要改动很多处，尽量保持函数简短并且尽量复用。『三则重构』原则。</li>
<li>注意函数在每个返回点的结构保持一致，尤其是在多个分之有返回点的时候(我经常看到一些函数有多个 return，但是每个 return 的返回结构却是不一致的)。函数尽量返回相同的类型（比如返回一个空 list 而不是 None，这个是参考 sqlalchemy 设计，比如批量查询查不到返回空 list 而不是 None）</li>
<li>rpc 调用等有没有降级？对方服务跪了会不会影响我们的接口？</li>
<li>不要多个函数嵌套在一起使用，比如 f(a(b()))，一旦出现问题很难定位是哪个函数的问题，即使是用 sentry 也不容易看出来。尽量每行代码明确表达一个清晰的逻辑，不要超过三层嵌套。</li>
<li>接口注意几个点，是否代码易读，易用（docstring），正确工作（单元测试）。尽量接口写出来基本就能通过名称和docstring快速让别人知道怎么用的，传入哪些值，返回什么东西，会抛出什么异常。笔者维护代码最最痛苦的就是你得一行一行读代码甚至还得打断点才能搞清楚接口是做什么的(中间充斥者复杂的嵌套数据结构，只有打断点才能看出来)，十分痛苦，十分浪费时间，用python开发省的那点时间全TM用在维护和还技术债了。偷懒只能节省一个人的成本(甚至节省不了)，对项目来说是很不利的。</li>
<li>参数过多的时候推荐调用的地方显示写出参数名 f(a=1,b=2)，当修改参数签名个数的时候调用点不容易出错，看代码的时候也比较容易知道每个参数的意义。建议一个函数传参 5 个以上以后参数就指定参数名进行传递，防止参数不匹配导致的 bug。</li>
<li>修改函数定义的时候，为了保证之前所有的调用点兼容，应该只在函数定义所有参数之后添加新的参数，并且最好给上默认值(否则你需要确保所有调用函数的地方都要改动)，绝对不要随便修改旧的参数顺序。（防止没有显示指定参数名传递的函数传入顺序错乱，如果参数过多建议指定参数名传递关键字参数）</li>
<li>如果没有特殊的性能需求，函数返回值尽量使用marshmallow之类序列化，之前的很多项目直接搞一个 dict 各种往里边塞字段然后返回，很难看清楚返回的啥结构，维护起来很累。</li>
<li>注意深浅拷贝的赋值问题，浅拷贝会导致不同变量共享结构，其中一个修改了对其他指向同一个结构的其他变量都可见，有时候会产生难以排查的 bug。比如笔者曾经碰到过一个函数返回的数据共享内存(误以为每次返回的是新的值)，在函数外又修改了它，导致不同请求『神奇』地数据相互干扰了。</li>
</ul>
<p>类和面向对象相关:</p>
<ul class="simple">
<li>你真的需要一个类吗？不要到处OOP，也不要只会写function。你了解OOP的几大原则吗？</li>
<li>业务逻辑代码中禁止使用元类，尽量避免使用 getattr/setattr 等动态特性，可能会给代码维护造成问题。除非是写框架，绝对不推荐在业务逻辑中使用任何黑魔法，以后维护起来简直就是噩梦。</li>
<li>保持类的继承层级简单，适当使用mixin。</li>
<li>注意尽量不要在非 <code class="xref py py-obj docutils literal"><span class="pre">__init__</span></code> 方法中给类赋值属性，笔者在维护别人代码的过程中，发现经常在一些非 init 方法种赋值新的属性，导致后期难以维护，根本不知道这个对象包含哪些属性，删除一个属性的时候坑也多。</li>
<li>尝试使用CRC(clas-responsibility-collaboration)：类-职责-交互卡片设计类。</li>
<li>注意多继承时候的 MRO 顺序。</li>
<li>保持类的单一职责，不要编写体积过大的类。</li>
<li>除非开发框架， 业务里不要使用元类</li>
</ul>
<p>测试/单测相关:</p>
<ul class="simple">
<li>没有单元测试，不知道怎么写测试（print大法好？）。没有一点专业精神，或许和python大部分都是自学的业余选手有关，哈哈当然我也是。没有单元测试对于大项目和动态语言项目来说就是灾难，不敢重构，改bug后无法确认是否引入新bug。对于关键代码一定要保证必要的单元测试。对于喜欢造轮子的，也要保证单元测试。有点违反直觉的是，单元测试长期来看并不会降低工作效率，因为编写代码往往只是工作中一个小环节，很多时间是在调bug，而且没有单元测试几乎不敢重构不好的代码，为代码腐化埋下祸根。但试图编写大量测试会因为工作量大而望而却步，所以可以针对关键和易出错的地方编写必要的单元测试，否则以后修复bug没有测试就是灾难。好的测试代码甚至还能当成文档，解释调用参数和返回结果。</li>
<li>不专业，写了几句代码print下结果就觉得正确了，单元测试呢？docstring呢？代码易用性和可维护性极差，未经测试的代码是不值得信任的。不要太相信自己，人人都会犯错，但不能反复犯一样的错。</li>
<li>对于外部调用、网络请求、rpc调用等使用 mock 或者 stub。<a class="reference external" href="https://chase-seibert.github.io/blog/2015/06/25/python-mocking-cookbook.html">https://chase-seibert.github.io/blog/2015/06/25/python-mocking-cookbook.html</a></li>
<li>基于代码行为测试，不要片面追求测试覆盖率。编写单测可以影响代码设计，不是为了测试而测试。一般难以测试的代码可能是复杂度太高，耦合比较大，有副作用（比如修改了传入的可变参数等）的，容易测试的代码往往是设计良好的代码。</li>
<li>什么时候使用stub，什么时候使用 mock？网络请求和数据库查询在构造上一层测试(比如controller)的时候可以 mock 掉。</li>
<li>单测中避免使用未定义或者随机行为。比如代码里依赖 random 或者时间戳，测试的时候就可能因为时间不满足失败（mock 掉time 库）</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="http://misko.hevery.com/attachments/Guide-Writing%20Testable%20Code.pdf">《Writing Testable Code》</a></li>
</ul>
<p>日志相关:</p>
<ul class="simple">
<li>哪些地方需要打印日志？debug参数？记录用户行为？排查问题？记录哪些信息？使用什么日志级别？</li>
<li>注意日志等级，使用debug/info/warnning/error要斟酌好。之前出现过生产环境使用了 debug 日志打印太多信息导致机器负载过高服务不可用的情况，注意不同环
境日志级别设置好，一般线上可以设置 ERROR 级别。</li>
<li>管理后台之类的需求凡是针对数据表的危险修改操作都应该记录日志，方便追查问题</li>
</ul>
<p>ORM和Mysql数据库相关：</p>
<ul class="simple">
<li>遵守互联网公司数据库设计规范。网上很多开源的规范可以参考，结合自己公司制定规范(很多中小公司一开始没DBA，建表很乱，没有规范/注释，不统一业务名称，各种外键/NULL值，没有创建时间等固定字段很多坑，后期修改成本比较高)。如果一开始数据库搞得比较糙，后来无论优化还是拆分都会带来不少麻烦。</li>
<li>数据库这一层的接口考虑下参数过滤，防止不恰当参数可能导致的慢查询。动态语言要注意变量类型和数据库字段类型不一致导致的查询索引失效。</li>
<li>优先使用ORM，相比sql语句更加容易维护，同时避免了sql注入。Sqlalchemy只有你想不到，没有它做不到，除非你比较在意性能。</li>
<li>获取对象的时候尽量传入需要的字段(数据表列)，减少数据传输同时还能避免拼对象的时间消耗，python构建对象比较耗时。</li>
<li>注意不要在循环里使用查询语句，合并查询语句。比如不要在for循环中使用一个对象的relation查询(懒加载的时候，每次调用都会查询数据库)</li>
<li>注意隐式类型转换导致的全表扫描。大家可以搜一下《数据库30条军规》，有一些坑应该避免。</li>
<li>Mysql需要存储表情：<code class="xref py py-obj docutils literal"><span class="pre">CREATE</span> <span class="pre">DATABASE</span> <span class="pre">mydb</span> <span class="pre">CHARACTER</span> <span class="pre">SET</span> <span class="pre">utf8mb4</span> <span class="pre">COLLATE</span> <span class="pre">utf8mb4_unicode_ci;</span></code></li>
<li>不同微服务之间尽量不要共享数据库，而是通过接口进行通信。避免一个服务迁移数据之后受到影响。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://www.verynull.com/2017/02/18/MySQL%E4%BA%92%E8%81%94%E7%BD%91%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/">《MySQL互联网业务数据库设计规范》</a></li>
<li><a class="reference external" href="https://www.cnblogs.com/huchong/p/10219318.html">《Mysql高性能优化规范建议》</a></li>
</ul>
<p>HTTP相关：</p>
<ul class="simple">
<li>注意处理请求头 content-type 里 &#8220;application/json&#8221; 和  &#8220;application/x-www-form-urlencoded&#8221; 区别，一般框架会封装好</li>
<li>注意跨域 cors 处理，一般也是封装到框架。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://imququ.com/post/four-ways-to-post-data-in-http.html">《四种常见的 POST 提交数据方式》</a></li>
<li><a class="reference external" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">《HTTP访问控制(CORS)》</a></li>
</ul>
<p>Redis相关:</p>
<ul class="simple">
<li>Redis key 命名尽量能够体现出含义，但是也要注意过长的 key 影响内存占用，尽量保持 key 长度精简，在代码里注释说明</li>
<li>使用 redis 之前最好先根据 qps 和内存占用做一个简单预估，防止线上出问题</li>
<li>注意 redis key 超时时间的设置是否合理，否则可能会占用非常多内存</li>
<li>使用集群 redis 应该注意防止大 key 产生，可能会严重影响 redis 性能</li>
<li>注意一些分布式数据库限制(阅读官方文档)：比如腾讯云 redis 集群版 lua 脚本需要所有 key 都在一个节点；不支持非 watch 事务等。</li>
<li>禁止线上 redis 服务器使用一些危险命令，比如 keys ，使用 scan 替代</li>
<li>注意连接池是否会打满，一般是用全局单例的连接池，防止频繁建立 tcp 连接开销。注意不要一直创建连接池把连接数打满</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://searchdatabase.techtarget.com.cn/7-20218/">《REDIS内存容量的预估和优化》</a></li>
<li><a class="reference external" href="https://yq.aliyun.com/articles/531067">《阿里云 Redis 开发规范》</a></li>
<li><a class="reference external" href="https://redislabs.com/redis-best-practices/">《Redis Best Practice》</a></li>
<li><a class="reference external" href="http://www.redis.cn/redis_memory/">《Redis 容量预估工具》</a></li>
</ul>
<p>Web 框架相关：</p>
<ul class="simple">
<li>推荐使用 Django/Tornado 统一管理路由配置的方式，而不是使用 Flask 装饰器路由的方式，方便统一查询和管理。</li>
</ul>
<p>内存泄露问题和排查：</p>
<ul class="simple">
<li>谨慎使用生存周期过长的全局对象。之前出现过不断append 一个全局 list 导致的内存泄露情况，很难判断销毁时机。</li>
<li>如果涉及到循环引用，使用弱引用 weakref</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://www.cnblogs.com/xybaby/p/7491656.html">《使用gc、objgraph干掉python内存泄露与循环引用》</a></li>
</ul>
<p>接口序列化和版本格式兼容问题：</p>
<ul class="simple">
<li>跨语言数据类型兼容：之前出现过后端修改了返回的 bool(true/false) 为 int(1/0) 导致客户端解析失败(甚至崩溃)的问题，注意不同后端动态语言和客户端序列化数据类型字段兼容问题（比如后端python客户端java)</li>
<li>数字类型溢出问题：跨语言 rpc 或者序列化成 json 返回给前端数据，注意 int64 类型(比如发号器发的in64 id)转成 string(grpc会自动处理)。长整型会被js截断，很多新手可能会忘记这种跨语言序列化的坑，发现int64给前端以后被截断了，建议 int64 对于 js 直接给 string</li>
<li>版本字段兼容：如果用的 json，定义好格式以后一旦上线不能删除和修改原有字段(可以新增字段)，防止使用老版本数据的客户端崩溃。如果是内部 rpc 框架(thrift/grpc)等，一般定义后的字段是不能修改其顺序序号的。</li>
<li>新旧版本逻辑兼容：客户端(iOS/Android)一般会有新老版本共存的情况(有些用户不想升级)，可以通过获取客户端的平台和版本号区分返回不同的业务逻辑。最好封装一个版本判断框架，而不是一堆恶心的 if/else 判断穿插在代码里</li>
</ul>
<p><a class="reference external" href="https://imweb.io/topic/581a8eb02373d1aa606c8be7">https://imweb.io/topic/581a8eb02373d1aa606c8be7</a></p>
<p>文档注释相关:</p>
<ul class="simple">
<li>类型注解。动态类型语言容易出错，没有类型检查。建议 python3 使用好类型注解功能，python2 里尽量多用注释给复杂类型加上类型注释。如果你有过维护和修改别人 python 代码的经验，就会发现最头疼的就是搞清楚变量的类型结构问题。其实还有个小细节，比如 python 代码里用到的 redis key 的命名我一般都会加上类型或者注释，比如 some_zset_key，方便知道能做什么操作。</li>
<li>如果是小团队(python大团队感觉会死人的)并且人都比较懒就那就『代码即文档』（有程序员说你让程序员写文档不是天方夜谭吗？你丫的哪个牛逼开源项目的文档是产品经理写的吗？？？excuse me, 代码写不好文档能好看点也行啊，你得让我不看shit一样的代码也能用你的接口啊）。python的特色docstring实际上就是最好的文档。</li>
<li>不写注释就得确保你的代码高度可读，不然shit一样的代码又没注释和文档，你让接盘侠怎么活？</li>
<li>注释有时候甚至可以帮助你思考设计，比如如果一个类、函数等如果难以用一句话描述它的职责，很有可能就违背了SRP（单一职责原则）。</li>
<li>如果系统调用过程比较复杂， 最好用流程图标识一下。</li>
<li>对于复杂的数据结构(比如嵌套类型)，可以适当注释出类型，比如最新的 tornado 源码里出现了这种注释 ` __impl_kwargs = None  # type: Dict[str, Any]`  。python3 实际上可以加上类型注解了，鉴于目前 python3 的普及程度，估计暂时也没啥用武之地了。</li>
<li>代码应该像是短文一样从上往下能够容易读懂，如果是怼不了特殊需求必须 hack 代码才能实现，必须加上注释说明。否则又出现了『黑洞代码』让别人看着一脸懵逼。善于利用 TODO，HACK 当成注释前缀，方便维护代码的人理解。 HACK: ###,  TODO: ####</li>
<li>特殊注释前缀。TODO(未完成代码), FIXME(修复我), HACK(比较 trick 才能实现的逻辑说明), NOTE(代码注意事项)，编写注释的时候可以遵守这些常见前缀。</li>
</ul>
<p>版本控制(git)相关：</p>
<ul class="simple">
<li>善用 git，多用分之，合理利用分之可以有效多个功能并行开发。git 分之是一个非常轻量的操作</li>
<li>注意一定不要提交敏感信息到代码仓库；不要提交大的二进制文件等到 git，需要忽略的文件应该放到 gitignore 文件里。</li>
<li>拆分功能，分次提交，尽量每个 commit 都是独立的小功能，可以单独回滚。不要一整次提交非常多的代码，不利于 review 和纠错</li>
<li>commit 信息要尽量描述清楚，不要瞎写比如『fix』这种毫无意义的 commit 信息。可以使用 commit message 模板或者 cz-cli 之类的提交工具</li>
</ul>
<p>线程安全相关：</p>
<ul class="simple">
<li>CPython 实现中，如果内置类型的操作是单个字节码(bytecode)操作，我们可以认为是原子的，操作能保证线程安全。比如 <code class="xref py py-obj docutils literal"><span class="pre">L[0]=0</span></code> 线程安全但是 <code class="xref py py-obj docutils literal"><span class="pre">L[0]+=1</span></code> 不是线程安全的。你可以用 dis 模块来查看操作的字节码。可以认为 GIL 以字节码为粒度。</li>
<li>虽然有些操作是原子的，比如字典赋值，但是如果用户自己实现了 <code class="xref py py-obj docutils literal"><span class="pre">__hash__</span></code> 和 <code class="xref py py-obj docutils literal"><span class="pre">__eq__</span></code> python 方法，就变成了非原子的。如果调研后无法确定是否是线程安全，最好使用锁。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="http://blog.qqrs.us/blog/2016/05/01/which-python-operations-are-atomic/">《Which Python Operations Are Atomic?》</a></li>
<li><a class="reference external" href="https://google.github.io/styleguide/pyguide.html#Threading">《Google Python Style Guide: Threading》</a></li>
</ul>
<p>python 代码性能优化相关：</p>
<ul class="simple">
<li>不要过早优化，虽然 python 性能一直被诟病。优化之前先使用 profile，火焰图 等工具查看性能瓶颈。基本上代码的耗时是遵守2/8定律的，集中优化最耗时的代码，衡量成本和收益。其实很多 python 内置库都是 c 写的，优化空间并不大。而且大部分 web 应用瓶颈在 IO 这块。</li>
<li>在优化和可读性之间寻找平衡。</li>
<li>优先从数据结构、算法、数据库、网络IO等层面优化，大部分 web 应用语言性能不会成为瓶颈，不过有些项目语言本身性能确实会成为瓶颈。</li>
<li>对于 cpu 密集的代码可以使用 cython(不是 CPython) 编写扩展来优化速度，性能提升很明显，在 reddit 和 知乎都有使用；或者使用一些知名库的比如 numpy，pandas处理矩阵等。<a class="reference external" href="http://cython.org/">http://cython.org/</a></li>
<li>更换语言（比如切到 golang），框架（使用异步框架），数据库（Nosql）甚至架构（微服务架构等），成本较高，动作较大，应该是最后的备选方案。</li>
<li>常见的 web 后端性能优化措施：<ul>
<li>批量：批量接口(比如数据库一次获取多条数据/redis pipeline等)，目的是避免多次网络I/O；消除数据库慢查询，索引优化等。</li>
<li>缓存：使用 redis 等内存型数据库缓存热数据，需要注意缓存失效问题(Cache-aside, Write-through, Write-back)，内存型数据库相比传统关系型数据库速度优势明显， 不过难以支持复杂查询。</li>
<li>异步：使用 celery 结合消息队列等把任务交给离线 worker 执行，防止阻塞当前请求。或者使用异步框架，tornado, python3 asyncio(至今仍不成熟) 等。</li>
<li>并发：使用 gevent(greenlet)、多线程 等并发请求数据，配合 gunicorn(master-slave模型) 部署。不过需要注意使用 gevent mysql driver 需要纯 python 编写的 driver 才能被 monkey patch</li>
<li>多线程/多进程：python 虽然有 GIL，但是 I/O 期间会释放 GIL，多线程仍可以大幅提升 I/O 密集应用的性能；多进程适用于 cpu 密集型应用。(threading/multiprocessing/concurrent.futures)</li>
</ul>
</li>
</ul>
<p>目前来看基于 gevent+gunicorn 的并发方案是目前比较成熟的方案(知乎就是这么用)，业务代码无需修改，也是很多公司首选的方案，在很多公司都有使用，asyncio 生态圈等待成熟。</p>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/24401056">《常见性能优化策略的总结-美团点评技术博客》</a></li>
<li><a class="reference external" href="http://ningning.today/2017/02/05/python/high-performance-python/">《High Performance Python》</a></li>
<li><a class="reference external" href="http://ningning.today/gevent-tutorial-cn/">《gevent程序员指南》</a></li>
<li><a class="reference external" href="http://www.cnblogs.com/xybaby/p/6370799.html#undefined">《gevent调度流程解析》</a></li>
<li><a class="reference external" href="https://medium.com/&#64;Pinterest_Engineering/how-we-use-gevent-to-go-fast-e30fa9f81334">《Pinterest How we use gevent to go fast》</a></li>
<li><a class="reference external" href="https://github.com/denglj/aiotutorial">《深入理解 Python 异步编程》</a></li>
<li><a class="reference external" href="http://mauveweb.co.uk/posts/2014/07/gevent-asynchronous-io-made-easy.html">《gevent-asynchronous-io-made-easy》</a></li>
<li><a class="reference external" href="http://www.cnblogs.com/xybaby/p/6510941.html">《python性能优化》</a></li>
<li><a class="reference external" href="http://www.cnblogs.com/xybaby/p/9055734.html">《性能优化指南：性能优化的一般性原则与方法》</a></li>
<li><a class="reference external" href="http://www.cnblogs.com/xybaby/p/7183854.html">《程序员必知的Python陷阱与缺陷列表》</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/31635068">《知乎是怎么运行 tornado web 服务的》</a> 知乎使用 gunicorn gevent 部署</li>
</ul>
<p>嗯，一开始就开启pep8和pylint检测能显著提升代码质量（各种错误警告逼着你写出规范的代码）。咱写不了诗一样的代码，也不能写shǐ 一样的代码，维护一个ugly的代码仓库能有效减少你的寿命。可能很多东西对老鸟来说都是显而易见的，不过菜鸟和高级菜鸟们还是需要多多练习积累经验。慢慢摸索吧骚年。。。。。。如果能主动读一读《代码大全》《编程匠艺》《clean code》《重构》之类的书更好(或者flask等优秀的开源项目代码)，别人会更乐意和你一起合作编程，不然你总会心想『天呐，千万别让我改那个家伙的代码，我宁愿离职！！！』</p>
<p>另外想说的就是，python入门容易，很多人浅尝辄止，但是相对容易出错，想写出高质量的代码反而对人的素养要求更高。另外如果是新手推荐多看看优秀的开源项目代码，能学到很多。像我等平凡之辈自己瞎捯饬也捯饬不出来啥，倒不如多学学人家高手是怎么写的，实际上对于大部分公司的业务代码，不需要什么奇淫技巧，反倒是把代码写得直白易懂易维护最重要。
对于比较灵活的动态语言，一定要定义好规范和使用静态检查，防止某些人瞎搞导致代码仓库难以维护。</p>
</div>
<div class="section" id="id31">
<h5>难以维护的Python代码<a class="headerlink" href="#id31" title="永久链接至标题">¶</a></h5>
<div class="highlight-none"><div class="highlight"><pre><span></span># python 没有 docstring 维护基本就靠命名了，对于复杂参数的类型没有注释看起来心累
def isRankingBetter(self, customer,topranking):
    testranking = getRanking(customer)
    return testranking &gt; topranking

// java
public boolean isRankingBetter(Customer customer, int topranking) {
    int testranking = getRanking(customer);
    return testranking &gt; topranking;
}
</pre></div>
</div>
<p>上面是一段java和python的对比，用来说明为什么python难以维护。java版本一眼就能看出来传入参数的类型和返回值，但是遗憾的是python看不出来，在python中基本只有通过docstring你才能知道传入参数的类型。当项目大了以后，维护一份没有文档和注释的python项目基本就是灾难。笔者曾很喜欢python语言，认为python是“伪代码”语，表达能力强，但是有了维护python旧代码的经验后，我开始怀疑python是不是适合构建大型项目(python写多了以后反而越来越不喜欢动态语言)。</p>
<p>当然很多知名应用是python构建的，我觉得老外们软件工程做得还是不错的，把控好代码质量和单元测试（比如Quora创始人曾经解释过他们为什么选择了python,他们不喜欢java的冗长繁琐，C#被微软束缚，facebook因为历史遗留问题使用php并不意味着php是个好选择,Quora最后选择python并通过严格的单元测试控制质量）。但是我经历的一些使用python的项目工程方面却比较糟糕，代码维护起来非常吃力，开始让我对python产生严重怀疑。</p>
<p>java虽然写起来繁琐，但是不容易出错，动态语言写起来爽，但是维护和重构起来吃力，并且容易出错(写稍微大型的项目时要充分认识到这个问题)。我个人感觉就是使用动态语言要严格把控代码质量和文档，强制用pylint对代码静态检测，否则项目大了难以维护，python或许更适合有代码洁癖的人写，比较严肃的大型工程还是推荐java。踩过这些坑之后，希望你以后写python工程的时候注重代码的docstring，易读性，接口易用性，正确性等，不然写着爽后来也是要付出很大的维护代价的，实现功能仅仅是代码项目中的一小环。</p>
</div>
<div class="section" id="id32">
<h5>重视细节<a class="headerlink" href="#id32" title="永久链接至标题">¶</a></h5>
</div>
<div class="section" id="id33">
<h5>版式与布局<a class="headerlink" href="#id33" title="永久链接至标题">¶</a></h5>
<p>良好的代码排版可以让人理解代码更容易，格式化的基本原理是用直观的布局显示程序的逻辑结构。一点经验:</p>
<ul class="simple">
<li>尽量遵守pep8，除了行长度可以适当放宽，比如django使用120列，我个人比较推崇120列，80列的时候经常超限制，比较浪费心思分行。短行在 web 显示，分屏，diff，code revew或者打印出来的时候都非常容易查看，所以不要写特别长的行。</li>
<li>合理使用&#8221;换行&#8221;使代码更易理解，同时更美观</li>
<li>合理使用&#8221;空行&#8221;和&#8221;括号&#8221;对代码块逻辑进行分隔，使层次清晰。尤其是比较长的代码逻辑，应该使用空行合理分割，相关逻辑的代码放到一起。即使是重构有利于搞清楚代码块的逻辑。</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span># 分行之前，我见过最长的得俩屏幕连起来才能看完
daily_report_data = db.session.query(Data.event_date, func.sum(Data.revenue).label(&#39;revenue&#39;), func.sum(Data.payout).label(&#39;payout&#39;)).filter(Data.tag != Data.TagEnum.arbitrage).filter(Data.event_date &lt; self._next_month_date).filter(Data.event_date &gt;= self._this_month_date).filter(Data.finance_type == Data.TypeEnum.normal).group_by(Data.event_date).all()

# 分行之后
daily_report_data = db.session.query(
    Data.event_date,
    func.sum(Data.revenue).label(&#39;revenue&#39;),
    func.sum(Data.payout).label(&#39;payout&#39;)
).filter(
    Data.tag != Data.TagEnum.arbitrage
).filter(
    Data.event_date &lt; self._next_month_date
).filter(
    Data.event_date &gt;= self._this_month_date
).filter(
    Data.finance_type == Data.TypeEnum.normal
).group_by(
    Data.event_date
).all()

# 不好的分行
employee_hours = (schedule.earliest_hour for employee in
                  self.public_employees for schedule in
                  employee.schedules)
return min(h for h in employee_hours if h is not None)

# 更具有可读性的分行，分行方式巧妙影响着代码可读性
employee_hours = (
    schedule.earliest_hour
    for employee in self.public_employees
    for schedule in employee.schedules
)
return min(
    hour
    for hour in employee_hours
    if hour is not None
)
</pre></div>
</div>
<p>你看看大概各需要几秒才能分别理解上边的代码，分行之后能在三秒之内大致理解代码是干啥的，但是太长行你光移动编辑器指针就要花几秒。所以有时候排版还是很重要的(想象一下每天盯着写成一坨和排版优美的代码分别是什么感受)，为了快速理解代码你要用上各种手段，尽量让代码更直观。当然有时候你拿不定注意怎么样选择的时候，就以一种最容易理解的方式写，下边是笔者常用的一些分行方式，有利于写出遵守pep8的代码:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>long_list_list_defition = [
    &#39;a_long_variable_name&#39;,
    &#39;b_long_variable_name&#39;,
    &#39;c_long_variable_name&#39;,
]   # 这样定义的好处就是你可以非常方便的增添元素而不用修改定义结构

from some_module import (
    a_long_variable_name, b_long_variable_name, c_long_variable_name,
    d_long_variable_name
)

if a_long_variable_name and b_long_variable_name and c_variable_name \
        and d_variable:
    # 我更倾向于用括号而不是反斜线来分行
    pass


if (a_long_variable_name and b_long_variable_name
        and c_long_variable_name and d_long_variable_name):

    pass


a_long_list_comprehension = [person.name
                             for person in db.session.query(Person.name)]


a_long_dict_comprehension = {
    person.id: person.name
    for person in db.session.query(Person.name, Person.id)
}


employee_id_list = [
    ins.id for ins in Employee.get_role_team_members(
        role_int, team_int, [&#39;id&#39;]
    )
]


def long_variable_function_name_and_function_params(a_long_variable_name,
                                                    b_long_variable_name,
                                                    c_long_variable_name,
                                                    d_long_variable_name):
    pass



def long_variable_function_name_and_function_params(
    a_long_variable_name,
    b_long_variable_name,
    c_long_variable_name,
    d_long_variable_name
):
    pass


return {
    &#39;code&#39;: ErrorCode.OPERATOR_FAILED_NEED_TOKEN,
    &#39;msg&#39;: ErrorCode.OPERATOR_FAILED_NEED_TOKEN_MSG,
    &#39;data&#39;: {}
}, status_codes.unauthorized


new_employee = Employee.get_by_id(new_employee_id)
(
    changed_advertiser_ids,
    changed_account_ids
) = assign_employee_advertiser_and_account(employee, new_employee)


result = a_very_very_very_very_very_very_very_very_long_function_name(
    a_long_variable_name, b_long_variable_name,
    c_long_variable_name, d_long_variable_name
)
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h5>命名<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h5>
<p>首先你要遵守pep8的规定，使用惯用法来命名。或者根据你们公司的python编码规范（如果你们公司有的话）</p>
<ul class="simple">
<li>joined_lower for functions, methods, attributes</li>
<li>ALL_CAPS for constants</li>
<li>StudlyCaps for classes</li>
</ul>
<p>另外注意动态语言因为没有类型声明，所以在阅读源代码的时候，如果名称起的不好，很难推测出代码中间变量的数据结构，给阅读代码带来障碍(用同事的话说就是，python维护基本就靠命名了，《代码大全》等书甚至用了数章来说明命名的艺术)。比如一个字典列表，或者嵌套字典等，笔者维护过python代码，深感其中坑太多。我个人的经验就是适度在命名中加入一些类型提示，比如使用nums, cnts等作为后缀很容易知道是数值类型，数据库类都会用Model作为后缀，复数单词或者some_list等很容易知道是序列，some_mapper或者some_dict, some_set等基本从命名就知道什么数据类型了。当然这只是我的经验，有些人会反对这种命名方式，老实说如果代码写得是自解释的，可以不用这么来，但是我个人感觉这种方式虽然冗余，但是确实给我维护和阅读代码带来了便利。</p>
<p>python3中加入了type hint特性，所以我觉得类型声明对于维护代码来说还是非常便利的。但是注意，动态语言有鸭子类型的概念，所以有时候名称中的类型提示并不代表就是该类型，很可能造成歧义，这也是很多人反对在python中使用类似匈牙利命名法的原因。老实说我不怎么使用鸭子类型(虽然天然支持泛型)，我感觉鸭子类型是很多错误的来源(比如很多instanceof判断增加函数复杂度)，python3加上类型注解了，甚至mypy都加上类型检测了（python3中的注解只是为IDE工具提供便利，并没有真正的类型检查），说明类型提示对大型代码项目维护还是很重要的。我觉得对于软件工程重视不够的团队最好不要使用动态语言开发后台，写不好的话坑会很多，后期新人上手和维护成本很高，虽然python易上手，但想要写好工程代码，还是需要一定功底的。</p>
<ul class="simple">
<li>注意词性。比如过程用动宾结构，用返回值的描述命名函数，数据变量使用名词，布尔数据经常使用is等作为前缀，数字类型使用cnt等作为后缀。</li>
<li>适当使用&#8221;匈牙利&#8221;命名法(能从命名推断类型)。比如一个变量明显是字典或者集合，加上后缀可能会更易理解，我个人是强烈建议通过前缀或者后缀增强名称的含义和类型（个人经验，有争议，不过我确实感觉这种代码更容易阅读理解，否则看一个变量看不出类型维护起来超级痛苦）</li>
<li>含义精确，具体胜于抽象。不要频繁使用诸如data，info，result，handle，process等概念太广泛的词汇给变量命名，不要使用偏门的简写，为了代码可读性冗余一些都可以(实际上对于现代语言长命名有一定好处，能减少冲突，容易 grep)。模棱两可的命名往往代表着某种警告（比如内聚不合理，不是单一职责等）。命名要能凸显出右侧表达式结果的类型和含义。</li>
<li>给函数命名的一个好办法：首先考虑应该给这个函数写上一句怎样的注释，然后想办法将注释变成函数名称。（来自《重构》）</li>
<li>术语表和命名规范。其实项目如果能建立术语表比较好，要不每个项目都用不同的词语命名比较混乱。命名会直接影响对代码语义的理解，还是要非常重视的。（比如不同项目用同一个名字表示不同含义，不同的名字又表示同一个含义，协作的时候非常容易混淆）</li>
<li>见其名，知其意。比如枚举类用 Enum 后缀，Handler 类用 Handler 后缀，类似的还有 Model 等，看到类的命名就知道继承了什么类。虽然有些冗余，但是很精确，看代码也方便理解</li>
<li>不要自己随便造一些缩写词。除非是有术语表或者业内常用的缩写，不要自己造缩写词语。清晰胜过简短，必要的缩写请加上注释(这也是看别人代码发现一堆摸不着头脑的缩写总结出来的)</li>
<li>变量的名称不要和循环里的临时变量名冲突。比如之前定义了 &#8220;name = &#8216;hehe&#8217;&#8221;, 同一个函数后边的循环语句尽量用 &#8220;for _name in names:&#8221; 如果循环后使用 name 就导致之前定义的 name 被循环里的最后一个值覆盖。（一般习惯用下划线前缀定义一个临时使用的变量，比如 for 循环或者列表推导里的变量，防止命名冲突)</li>
<li>使用下划线开头区分是内部函数还是提供给外部调用(私有还是共有方法)。代码重构的时候区分哪些是内部函数，哪些是外部接口会比较方便一些。（类似 golang 根据首字母的大小写区分是否 export 给外部使用）</li>
</ul>
<p>(注意这几个词语：『函数function』指有返回值的函数，『过程procedure』指无返回值的函数(比如关闭一个文件)，『方法method』指的是类中的函数，称之为方法))</p>
</div>
<div class="section" id="id35">
<h5>注释与docstring<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function_with_types_in_docstring</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Example function with types documented in the docstring.</span>

<span class="sd">`PEP 484`_ type annotations are supported. If attribute, parameter, and</span>
<span class="sd">return types are annotated according to `PEP 484`_, they do not need to be</span>
<span class="sd">included in the docstring:</span>

<span class="sd">Args:</span>
<span class="sd">    param1 (int): The first parameter.</span>
<span class="sd">    param2 (str): The second parameter.</span>

<span class="sd">Returns:</span>
<span class="sd">    bool: The return value. True for success, False otherwise.</span>

<span class="sd">.. _PEP 484:</span>
<span class="sd">    https://www.python.org/dev/peps/pep-0484/</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>这个是google的docstring示例,是我比较推崇的一种格式。还是那个问题，动态语言没有类型声明，所以复杂函数要在docstring里写清楚传入参数和返回值的描述和类型。良好的docstring能让维护代码的人一眼就看明白这个函数是怎么使用的，即使内部很复杂，也尽量保持接口简单，容易使用。经常有人传出个嵌套字典（dict的key是主键，每个key对应的value里还有字典），这种相对复杂的数据结构还不注释，每次看这种函数都要打断点看返回结构。这种就是典型的接口易用性差，只在意实现功能，完全不管别人使用，合作起来比较心累。</p>
<ul class="simple">
<li>Docstrings = How to use code。代码约定</li>
<li>Comments = Why &amp; how code works</li>
</ul>
<p>Docstring应该包括什么?接口易用性</p>
<ul class="simple">
<li>尽量让 api 或者函数的调用者看一眼 docstrig 就能知道它做了什么，传入和传出了什么（参数意义和格式），而不是非得深入代码的每个细节才能使用它，提升代码易用性。有些家伙提倡代码即文档，但其实很多代码实现比较狗屎，我不想看完一坨狗屎而是直接看 docstring 就知道怎么用。</li>
<li>docstring 分为文件(module)的、类的、函数的 docstring。文件的用来说明模块、脚本等用来做什么的；class 和 function 的用来描述其作用。</li>
<li>意图(目的)。解释为什么需要它？有些对你来说很明显的东西对其他人来说不一定很明显。最好能用一句话描述意图和功能，简单明了。笔者在接手项目看代码的时候，很多时候知道代码做了啥，但是却不知道为啥需要以及在哪些地方会需要这些代码？</li>
<li>描述参数，返回值和会抛出的异常。我举个简单的例子， <code class="xref py py-obj docutils literal"><span class="pre">def</span> <span class="pre">f(date):</span> <span class="pre">pass</span></code> ，仅仅看date这个参数你不知道传入str还是datetime.date，如果传入字符串又有很多格式的字符串，需要哪种格式？所以这个时候一个简单的描述 <code class="xref py py-obj docutils literal"><span class="pre">date</span> <span class="pre">(str):</span> <span class="pre">'YYYY-MM-DD'</span></code> 就能让使用函数的人一下子明白了。当然如果有单元测试实际上测试代码也是很好的文档，我们通过单元测试就知道怎么传值。另外使用了 <code class="xref py py-obj docutils literal"><span class="pre">**kwargs</span></code> 如果都不说明就太不厚道了。对于传入的复杂的数据类型，最好注释下，否则看代码会非常蒙逼</li>
<li>使用注意事项。复杂的使用可以有demo示例说明。</li>
<li>需求文档，使用的api或者github, stackoverflow等链接。比如有个很trick的实现是你查阅 stackoverflow解决的，可以附上地址帮助阅读代码的人找到出处。对如复杂的需求实现，附上需求文档也会帮助他人理解。使用了第三方或者自己造的api，附上地址可以让新人快速上手了解。这些都是一些小细节，但是却可以给自己和维护代码的人带来巨大的便利。</li>
<li>大家都很懒，但是还是尽可能用极其简洁明了的话给所有的模块、类和函数来几句描述（为什么需要这个模块、类、函数？这个模块、类会在在哪里被使用？它完成了什么功能）？如果能很简单描述出来，说明代码功能明确，写得至少不算烂^_^。无法简单描述的话说明代码可能需要拆分。另外涉及到业务的代码一般还需要链接一下业务文档帮助后人理解和上手。</li>
</ul>
<p>注释分5类（来自《代码大全》），但是仅『总结性注释』和『意图注释』可以接受</p>
<ul class="simple">
<li>代码的重复:用不同的词语重申代码的内容</li>
<li>代码的解释: 解释复杂的有效的和灵敏的代码，通常有用但是尽可能修改代码使得代码本身更清晰</li>
<li>代码中标记： TODO 标记等，经验表明，往往写了 TODO 后来就一直成了 TODO，所以最好提交代码前把要做的 TODO 做完，TODO 仅仅作为一次代码合并之前的提示。TODO 注释记得加上姓名，日期，联系方式和提示，方便 grep。</li>
<li>代码中的总结：简化代码为一句或两句话，这种注释比重复代码更有价值，能帮助人快速理解代码</li>
<li>代码意图的描述：解释代码的目的。意图注释在问题一级上，而不是在答案一级，是一句利用答案的总结描述。『理解最初的编程意图是最难的问题』</li>
</ul>
<p>注释怎么写?</p>
<ul class="simple">
<li>注释的目的在于快速帮助阅读代码的人了解代码功能和意图，使用方式等，不是为了注释而注释，让你看一长坨无任何文档注释风格又不好的代码是一件相当痛苦的事情，尤其是动态语言这种还看不出类型的。（所以有人说动态语言不适合构建大型项目）</li>
<li>当然，好代码 &gt; 差代码+好注释，好的注释是很有价值的，坏注释不仅浪费时间还可能有害，自解释的代码最好。好的注释不是重复代码或解释它，而是使代码更清楚，注释在高于代码的抽象水平上解释代码要做什么事。</li>
<li>适当注释，仔细衡量，不要隐晦也不要多余。</li>
<li>及时更新。</li>
<li>注释代码中一些tricky的技巧或者特殊的业务逻辑，否则会让读代码的人摸不着头脑。</li>
<li>如果附上jira、bug、需求等的地址能够帮助理解代码，可以适当加上。</li>
<li>如果代码命名良好，结构合理，一般来说是不需要什么注释的。但是用一句话解释下意图和功能也是极好的，因为很多时候仅仅是想知道代码怎么用，读一句注释要比分析几十行代码快得多。</li>
<li>根据《代码大全》上注释的分类，仅『意图注释』和『总结注释』两类注释是可以接受的。</li>
</ul>
<p>很多东西都需要自己斟酌，不要矫枉过正，比如说需要注释你就写一堆没必要的冗余的注释，说遵守pep8尽量不超过80列你连url都要拆成两行，我。。。。。。如果有些规范相冲突，你就以代码的可读性为标准，所有标准都是为了良好的代码设计的。我最怕和随意的程序员一起干活，随意就是写个函数print下就觉得正确了，没有docstring和注释，写的接口让别人难以使用。</p>
<p>公司项目毕竟不是自己过家家，我现在就是自己的小项目也会注重规范（自己维护起来也方便，不要相信你的记忆力）。很多用python的小公司就是很不规范，维护起来真心累。也希望所有看到这里的python学习者可以把规范重视起来(很多知名开源项目文档都相当不错)，这也是一个职业程序员应该具备的素养。毕竟大部分人不是造轮子的人，能把业务逻辑实现地简单优雅易维护也是一种能力。</p>
<ul class="simple">
<li><a class="reference external" href="http://ningning.today/2017/07/22/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/the-art-of-readable-code/">《The Art of Readable Code》</a></li>
</ul>
</div>
<div class="section" id="id36">
<h5>异常处理<a class="headerlink" href="#id36" title="永久链接至标题">¶</a></h5>
<p>一般在我们的代码中会出现三种错误类型：</p>
<ul class="simple">
<li>语法错误(Syntax Error): 比如手残打错了关键字等，可以通过编译器或者lint工具检查出来。动态语言要用好静态检测工具，防止代码上线了才发现直接跪了，修改成本高。（动态语言一大劣势）</li>
<li>逻辑错误(Logic Error): 逻辑错误一般是由于程序员的粗心或者需求理解不对导致的(比如该用+号用了-号)，也是一般bug产生的原因，可以通过单元测试等方式避免。</li>
<li>运行时错误(Runtime Error): 比如权限问题，文件不存在，网络请求失败等IO操作经常会抛出异常，这种错误需要程序员有意识进行处理，而不能假设操作一定就是成功的，尤其是涉及网络 IO 的地方。</li>
</ul>
<p>之前没怎么写过工程代码的小盆友可能一开始会忽视对各种异常的处理，这里需要提醒的就是，工程代码如果想写得健壮就需要对程序中可能会出错或者抛出异常的地方进行异常捕获，捕获之后进行处理或者上抛给调用者(raise)。
提倡一定的防御式编程，减少程序因为异常导致的崩溃，主要是通过文档或者源码了解使用的代码、第三方库等会抛出哪些异常，应该如何处理。</p>
<ul class="simple">
<li><a class="reference external" href="http://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html">《google docstring示例》</a></li>
<li><a class="reference external" href="http://ningning.today/2017/01/22/python/python-coding-details/">《注重细节:代码排版，命名与注释》</a></li>
</ul>
</div>
<div class="section" id="web">
<h5>web安全<a class="headerlink" href="#web" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>防范常见的xss，csrf，sql注入等漏洞，不要信任来自外部的任何输入。对于外部接收的参数都要过滤，比如表单，对外的 api 等。</li>
<li>优先使用 orm 框架可以避免很多 sql 注入之类的问题，利用框架自带的安全机制杜绝一些网络安全问题</li>
<li>对内的函数无需每一层都加上参数过滤（基于约定或者规范编程，没有遵守约定抛出的异常由调用者负责处理）。</li>
<li>有一个例外就是数据库查询的参数，最好经过一次参数校验，防止不合理参数造成慢查询等问题(比如参数传递一个非常大的查询分页导致慢查询）</li>
<li>使用断言保护代码，直接拒绝不合理参数。注意隐私参数需要加密保存</li>
<li>注意服务配置不要泄露（比如密码传到了 github），注意服务一定要认证，不要裸奔。</li>
<li>接口防刷，做好频率控制。可以在网关层面/业务层等做频率控制。如果是需要根据用户状态来限制频率可以借助 redis 计数来做</li>
<li>传输加密(https); 敏感数据加密保存，脱敏展示。</li>
</ul>
</div>
</div>
<div class="section" id="id38">
<h4>小白的踩坑记录<a class="headerlink" href="#id38" title="永久链接至标题">¶</a></h4>
<div class="section" id="id39">
<h5>文档化<a class="headerlink" href="#id39" title="永久链接至标题">¶</a></h5>
<p>团队项目开发前的统一三要素：统一需求/开发文档，统一代码规范，统一环境（编译/测试/发布）。
很多程序员是懒得写文档的，仿佛牛逼的程序员不需要写。但是看人家真正牛逼的开源项目比如flask和tornado等，无论是代码还是文档都做得相当棒。对于一些项目，有些东西如部署步骤；常用命令等还是可以记录下来的，可以使用wiki或者readthedoc，gitbooks等文档工具记录一下，方便新人上手。如果不知道记录啥，就把你发现不止一次会用到的东西文档化。个人认为需求文档也应该有历史记录，方便接手的人可以快速了解业务和需求变更。数据库字段的含义也应该及时记录和更新。</p>
<p>Readme Driven Development:</p>
<ul class="simple">
<li>Explain the system&#8217;s pupose. (What is the business reason ? Why are we here?)</li>
<li>Describe the scope. (What defines what the system does and doesn&#8217;t do?)</li>
<li>Summarise what it does. (What does it actually do? What is it for?)</li>
</ul>
<p>只有少数很复杂的系统需要详细的文档，架构图、UML、数据模型、处理流程、业务逻辑等需要整理成文档。Write the minimum viable system documentation.</p>
</div>
<div class="section" id="id40">
<h5>代码分支与代码管理<a class="headerlink" href="#id40" title="永久链接至标题">¶</a></h5>
<p>做好代码分之管理，分清楚开发、特性、bugfix等代码分枝，不要在同一个分之上一下修改太多功能，导致修复问题不好定位。比如经常和同事做一个需求，结果一个人把几个需求堆到一个分之改了，把不该上的功能也给上了，这种小细节还是需要注意的，否则就会给测试、上线等带来严重麻烦。命名分之的时候注意使用有意义的命名，比如附带上task的号码，jira号等等，把分之和你要解决的问题关联起来。</p>
</div>
<div class="section" id="id41">
<h5>代码提交<a class="headerlink" href="#id41" title="永久链接至标题">¶</a></h5>
<p>对于一个严谨的开发团队来说，即使是 git 提交信息的规范最好也是需要规定的。比如提交是 feature，bugfix，还是修改配置等。
可以使用工具来规范统一的提交信息。</p>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/34223150">《优雅的提交你的 Git Commit Message》</a></li>
</ul>
</div>
<div class="section" id="id42">
<h5>注释<a class="headerlink" href="#id42" title="永久链接至标题">¶</a></h5>
<p>有经验的人都知道看别人的代码是一件很痛苦的事情，尤其是没有任何注释的代码。代码除了完成需求外，最重要的就是维护和协作，除非你觉得你做的项目活不过仨月(或你自己玩玩的项目随便你怎么艹)，否则就一定要重视代码质量，防止代码腐化(破窗)以至难以协作和维护。有时候比写注释更难的是知道何时写，写什么注释？python里有规范的docstring用来给类和函数进行注释，除了说明功能外，关于github,stackoverflow链接、复杂的传入传出参数（比如嵌套字典作为参数这种你都不注释就很不合适了)，类型说明、需求文档和bug的jira地址等都可以注释。凡是你回头看代码一眼看不出来干啥的，都应该有适当的注释，方便自己也方便别人。</p>
<p>当然，最重要的是代码清晰易读，好的命名和编写风格的代码往往是自解释的，看代码大致就可以看出功能。建议就是给所有的模块、类和函数都加上注释，除非一眼能看出来这个东西干啥，否则都应该简洁注释下，让别人不用一行行看你的代码就大概知道你这个东西是干啥的。最后注意的就是一旦函数更改及时更新注释。qiniu的sdk写得就不错，可以去github看看。总之，&#8221;Explicit is better than implicit.&#8221;, 代码里不要有隐晦的东西，一时偷懒将来可能会付出几倍的维护代价，请对将来的自己和他人负责。</p>
<ul class="simple">
<li><a class="reference external" href="http://bwanamarko.alwaysdata.net/napoleon/format_exception.html">《python docstring》</a></li>
</ul>
</div>
<div class="section" id="code-review">
<h5>Code Review(代码审查)<a class="headerlink" href="#code-review" title="永久链接至标题">¶</a></h5>
<p>笔者认为code review是一件非常重要的事情，可以有效防止代码腐化，同时方便同事了解业务(可以说编码规范、静态分析、代码审查和单元测试是保证代码质量的几个重要工具，没有使用这几个工具之一将来代码都可能难以维护)。可以在公司搭建Phabricator（facebook在用）gitlab 类似工具进行代码review。可惜小公司流程不严格，codereview总是坚持不下去，要不就是被同事吐槽总是给他挑刺。实际上如果是新手能够从code review当中快速学到很多东西，比如编程惯用法，摆脱不良编码习惯，不良设计和难以维护的代码等。review的时候对事不对人，代码如果有明显缺陷快速记录个TODO等待review后修正，以一种开放和学习的心态看待review，慢慢整个团队的实力和代码质量就会提高。review就是个互相学习进步的过程，正规的团队都应该严格遵守，而不只是走走流程。
(没有 review 过的代码可能很快就会成为一坨shit)</p>
<ul class="simple">
<li>一次检查代码在 200-400 行比较适合，不要一次提交太多代码，应当合理分配每一次提交的代码量和功能点</li>
<li>建立 review 检查表，防止不合理、过于复杂、明显缺陷、可读性差的代码。眼睛足够多，bug 无处藏。越早修复缺陷，成本越低。</li>
<li>建立提交模板，每个提交是需求、bugfix还是啥一目了然，同时贴上需求、jira 等地址，方便追溯。</li>
<li>对事不对人，review 和被 review 的人都要以一种开放和学习的良好心态看待 review，共同进步。新手或者新加入项目的人不要过度吹毛求疵(会有很大心理负担和反感情绪)，共事久了步调和代码风格慢慢趋同了。</li>
<li>及时复查，防止一次太多的commit。使用 gitlab 等工具可以在代码 diff 的地方评论，这样方便对照别人的评论迅速修改代码里的问题</li>
<li>commit 信息关联。提交的代码解决了什么问题，如果是需求需要在 gitlab 附上需求文档地址，如果是 bug fix，附上对应的 sentry 或者 jira 链接，让每个commit 有意义并且可以追溯。在代码片段里加上文档、jira 地址等对于代码护维也很重要。</li>
<li><dl class="first docutils">
<dt>检查内容：</dt>
<dd><ul class="first last">
<li>逻辑是否正确，代码行为是否符合预期</li>
<li>代码规范（风格和命名等，动态语言没类型声明，很依赖良好的命名推断变量含义和类型）。同志们学好英语，命名真不是个简单的问题(尤其是各种中式英文和缩写)。</li>
<li>是否有单测</li>
<li>是否健壮（安全性、性能、异常捕获）</li>
<li>必要的文档和注释（意图，外部链接需要注上）</li>
<li>可读性和可维护性(是否有过于复杂的逻辑)</li>
<li>commit 信息（commit信息是否准确，比如附上 jira 或者需求文档地址，bug 地址等，你的代码变动都应该有迹可循, 目前团队加上了提交模板，对于 bug fix、新特性、重构等都需要填写对应的模板信息 <a class="reference external" href="https://www.conventionalcommits.org/zh/v1.0.0-beta.2/">https://www.conventionalcommits.org/zh/v1.0.0-beta.2/</a>）</li>
<li>代码洁癖要适度，如果代码遵守了规范并能正确解决问题，就不要吹毛求疵。review 过程中出现分歧是很常见的，每个人都有自己的编码习惯。如果出现难以解决的分歧，可以列出优劣表格，对各自的方式有一个量化的分析（比如从实现难度、可读性、可扩展性、可维护性等方面打分）。如果无伤大雅，不必吹毛求疵。</li>
</ul>
</dd>
</dl>
</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://www.kevinlondon.com/2015/05/05/code-review-best-practices.html">《https://www.kevinlondon.com/2015/05/05/code-review-best-practices.html》</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/31581735">《如何用人类的方式进行 Code Review》</a></li>
<li><a class="reference external" href="https://www.infoq.cn/article/tQrY-B15aRoBdzyr2aOh?utm_source=weibo&amp;utm_medium=infoq&amp;utm_campaign=newinfoq&amp;utm_content=0515Airbnb">《硅谷 Code Review 流程图》</a></li>
</ul>
</div>
<div class="section" id="id45">
<h5>日志与异常记录<a class="headerlink" href="#id45" title="永久链接至标题">¶</a></h5>
<p>一定要有良好的日志记录习惯。良好的日志对于记录问题至关重要。python有方便的日志模块帮助我们记录，日志输出的代价是比较小的，python的日志模块尽量做到对函数功能没有性能影响，可以在线上和开发环境设置不同的log等级，方便开发调试。注意别再日志语句里引入了bug或异常。有时候需要判断什么时候需要日志，记录哪些东西方便我们排查问题，分析数据。
对于异常，一定『不要吞掉任何异常』，常有新手上来就try/except，也不区分非退出异常，也没有日志记录(坑啊......)。请先阅读python文档的异常机制，可以使用Sentry等工具记录异常。同时发生异常时候的时间，调用点，栈调用信息，locals()变量等要注意记录，给排查错误带来便利。有些错误的复现是比较困难的，这时候日志和异常的作用就凸显出来了。</p>
<ul class="simple">
<li><a class="reference external" href="http://mp.weixin.qq.com/s?__biz=MzA4MjEyNTA5Mw==&amp;mid=2652564362&amp;idx=1&amp;sn=f33910af004f276bbef7ae52e0757bcb&amp;chksm=8464c3c0b3134ad617bcffd865894344367fdd2995a0d5ff9c4da30e0c158b3d02b3d616f615&amp;mpshare=1&amp;scene=23&amp;srcid=1124K7Ht1FP2A1Fnvi3HTBE5#rd">《每个 Python 程序员都要知道的日志实践》</a></li>
<li><a class="reference external" href="http://www.cnblogs.com/xybaby/p/7954610.html">《日志的艺术（The art of logging）》</a></li>
</ul>
</div>
<div class="section" id="id47">
<h5>代码自查<a class="headerlink" href="#id47" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>该加的日志是否加上了？日志等级是否正确？代码里的各项配置是否正确</li>
<li>代码规范是否符合标准？是否有用工具格式化</li>
<li>加锁的地方有没有对应的释放锁？打开的资源是否关闭了？会不会导致资源泄露？</li>
</ul>
</div>
<div class="section" id="id48">
<h5>服务上线<a class="headerlink" href="#id48" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>如果上线流程复杂，应该建立上线流程表和上线自查表，防止出问题(当然如果 devops 做得好很多问题可以避免，最容易出错的是人为因素)</li>
<li>一般会先灰度上线(部署少量容器/机器)，如果发现上线的代码有问题，需要立即回滚到上一个可用的部署版本(不要立马写代码尝试修复)</li>
<li>上线之后应当关注异常上报、错误上报、服务日志、机器资源性能等监控系统指标，防止出现问题，确认无误以后可以全量发布</li>
</ul>
</div>
<div class="section" id="id49">
<h5>重构与维护<a class="headerlink" href="#id49" title="永久链接至标题">¶</a></h5>
<p>不知道你有没有这种感觉，看那些知名代码库flask等，人家写的代码水平是比较高的，但是自己的项目确实一团糟。我觉得代码要经常去重构，想着怎么写更优雅，更容易理解和维护。我个人感觉好的代码就是不断修改出来的，实现一个需求的时候，适当想想怎么设计更加优雅易维护，编写代码的时候注意想着可读性。完成需求了如果代码可以设计更优雅，可以尝试重构下，慢慢代码水平就上来了。如果总是直来直去堆砌需求代码，业务逻辑写再多依然不会有进步(我个人感觉写python有时候反而会降低编程能力)。牛人和计算机高手很多，能写出良好的工程代码的人却很少(试想一下让你维护一个『牛人』的『精巧』代码)。代码一次编写，却可能被无数次查看、修改和维护，在可读性和可维护性上的努力长远来看是值得的，编写代码只是整个软件项目中很小的一部分。写代码的时候最好也从维护者的角度思考一下。
Code Quality: Simple, Well-tested, Bug free, Clear, Refactored, Documented, Extensible, Fast.</p>
<ul class="simple">
<li>面对代码屎山。不要妄想一上来就大规模重构，每次需求需要修改代码的时候，保持相关的代码块更加整洁就可以。破窗理论</li>
<li>避免彻头彻尾重写，增量式重写代码。开发新代码比重写旧的代码让人更加舒服。天生乐观会让我们低估了复制旧功能要付出的精力和时间。</li>
<li>重构：在不改变代码功能的情况下优化代码设计。修改功能和优化代码不要同时做。优化应该以可读性为标准。</li>
<li>接手老项目的时候不要盲目大规模重构，但要保证代码仓库越来越『干净』，不要破罐子破摔。</li>
<li>可以通过设计(需求)归档、代码规范、静态检测工具、单元测试、必要的注释和文档、code review(代码复审)、重构、服务化等手段增加项目的可维护性。</li>
<li>动态语言的重构工具支持不够完善，重构的时候要注意别改坏了逻辑，要十分谨慎。单元测试可以保证原有逻辑没有被破坏。</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="http://www.wklken.me/posts/2017/06/17/refactoring-07.html">《重构 - 读书笔记(PYTHON示例)》</a>  来自 wklken&#8217;s blog</li>
<li><a class="reference external" href="http://kaelzhang81.github.io/2017/06/18/%E8%AF%A6%E8%A7%A3%E5%9C%88%E5%A4%8D%E6%9D%82%E5%BA%A6/">《详解圈复杂度》</a></li>
</ul>
</div>
<div class="section" id="id52">
<h5>Python 做业务后端的优缺点分析<a class="headerlink" href="#id52" title="永久链接至标题">¶</a></h5>
<p>笔者从实习开始做 Python 后端，经历过一些新项目、老项目，以及和很多 python 工程师(豆瓣、知乎)协作过，大概总结下 python 做 web 业务后端的优缺点吧，尽量客观，
总得来说就是用动态语言写项目在追求高生产力的同时要严格把控工程质量。先说优点:</p>
<ul class="simple">
<li>多面手。python 可以写方便地写爬虫、网站、数据分析、运维脚本等，都有比较成熟的框架，目前比较火，TIOBE 里脚本语言排第一。</li>
<li>轮子多。python 发布时间比 java 还早，大量现成的轮子可以用。我觉得即使是 web 之王 php 做网站开发体验和效率上来说并不比 python 强。这可能也是 Instagram 和  Quora 等选择 Python 的原因。</li>
<li>表达能力强，语法糖多，生产力高，适合快速构建原型。笔者喜欢动态语言的一个原因就是表达能力强，用更少代码完成功能。(代码行数越少意味着高生产力和低出错率，当然不一定对可读性有帮助)</li>
</ul>
<p>缺陷:</p>
<ul class="simple">
<li>解释性语言执行效率低，大部分时间用在 IO 密集场景，比如 web 后端。不过大部分公司不用担心性能问题，除非真到了一定用户量级。</li>
<li>开发工具支持不够完善，不如 java 有那么完善的 IDE，Pycharm 还不错，但是依然解决不了滥用动态特性导致的补全和跳转等问题</li>
<li>易编写，但难以重构和维护，易出错，工程上不够友好，较难写出 clean code(笔者基本上会强制上 pylint and autopep8, 模仿 gofmt 吧)。基本上重构只能依据字符串匹配，老实说每次重构有稍微大一些的改动都会有点担心</li>
<li>滥用动态特性导致代码不好维护。这是个双刃剑，但是对工程来说还是不要滥用。有时候会利用一些动态特性使用黑魔法来快速完成需求，但是工程上来说这是很不利于维护的。这是很多人抨击动态语言不适合大型项目的原因，一般需要在编码规范里明确说明哪些能用，哪些不能用。</li>
<li>没有类型声明，看不出一些复杂类型的数据结构（Python、php 都在不遗余力地加上 type hint），代码写糙了维护起来很累（看不出复杂变量的类型和结构，阅读代码吃力，我都是给复杂类型加上类型注释），命名和编码习惯很重要</li>
<li>缺少一些最佳实践（技术、小白文章偏多，工程实践文章比较少），以很多 python 的中小公司在软件工程上管理不够，无规范、无文档、无注释、无单测、无持续集成的尿性，还是慎用动态语言瞎胡搞，后期维护成本会很高。</li>
<li>python2，3 不兼容，迁移有成本。我个人觉得 python 敢于抛弃当初的设计是值得赞赏的，但是很多企业并没有足够的资源来去迁移</li>
<li>招人不好招，这两年 python 雷声大，雨点小，而且基本都是在 AI 领域。有经验的 python 后端远没有 Java 好招(往往很多人学得还是半吊子写代码很随意，不重视工程质量)，更多是创业公司、中小公司使用</li>
</ul>
<p>技术选型都是在权衡吧，因为灵活性与工程性、开发效率和运行效率很多时候无法兼得。</p>
</div>
<div class="section" id="id53">
<h5>高质量服务自查表<a class="headerlink" href="#id53" title="永久链接至标题">¶</a></h5>
<p>分布式系统中会遇到各种失败问题，开发健壮的后端服务需要注意很多细节问题，依赖各种后端组件。下边是一份总结不错的自查表，可以对照看一下。</p>
<ul class="simple">
<li><a class="reference external" href="http://vearne.cc/archives/39164">《开发更高质量的服务》</a></li>
</ul>
</div>
<div class="section" id="id55">
<h5>开发习惯<a class="headerlink" href="#id55" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>认识和熟悉所在团队中的成员（笔者一直做得不够好，这一条远比想象中重要，内向性格有时候会比较吃亏），良好的沟通和协调能力能帮助你更快完成(或者委托)任务。</li>
<li>确保正确理解需求，确保熟悉所做的业务，正确理解业务能减少很多无用功(想象一下你写了很多代码结果因为理解失误需要全删掉的心情)；需求分析；适当设计。流程图或者文档有时候可以帮助理清楚业务。比如知乎有 rfc 机制，每次做一个稍微大点的需求都需要写设计文档。可以通过复述给产品人员听的方式确认双方是否理解一致。</li>
<li>番茄工作法，劳逸结合(working smart rather than working hard)，一次只做一件事(do one thing and do it well)。长时间专注写代码是非常消耗精力的。确保编码期间足够专注。快速迭代。</li>
<li>边写边测，增量式编程。虽没有使用 TDD 开发的习惯，但是对于稍复杂的逻辑就要写单测，以便及时发现错误，越早发现越容易修复(修复成本随时间指数增加)。我习惯用文件变动监控工具(when-changed fswatch等)检测文件变动，每次保存文件自动跑相关测试(比如 nose pytest 等都可以执行单个文件或类的测试,你可以快速验证当前代码是否有问题，及时修改或者重构)。TDD 的好处之一就是改善设计，自顶向下考虑，笔者有时候也会尝试用 TDD。</li>
<li>注释先行，意图导向，表达明确，牢记可读性可维护性，可追溯（附上需求文档地址，方便维护者查看）。写一个模块、类或者函数之前先想好它的功能，按照功能命名，之后写简单的注释描述其意图和功能，通常不超过三句话，虽然大部分时间只有一句话(只做一件事) ，但是能快速让后来的维护者了解你的意图。别看人代码最头疼的就是看不出代码究竟是要干啥。</li>
<li>文档驱动编程(Document Driven Development):比如写一个脚本的时候，应该在文件头部注明需求地址 url(保证代码功能、意图等是可追溯的)，写下实现方式和目的等。有时候对于很复杂的业务逻辑笔者会用自然语言描述步骤，之后再用代码实现。对于需要经常维护的代码，必要的文档是值得的。</li>
<li>边开发，边重构，及时清理技术债。如果有代码写糙了（圈复杂度太高、可读性差、代码重复等坏味道），应该及时重构不好的代码，这时的重构成本是最小的。代码写得复杂到自己都快看不懂了是个危险的信号。</li>
<li>善用工具。比如笔者使用的 vim 插件 python-mode 集成了 pylint、pep8、pyflakes、autopep8、isort 等工具，方便快速检测代码是否有语法错误和规范问题。每次保存文件后我都会在 vim 里执行一遍 pylint 和 pep8 检测，确保代码在规范上没问题。
(即便如此动态语言依旧很容易犯错，比如使用了未定义的属性，参数个数不一致等开发工具都不会报错，但是一上线就报了异常，所以动态语言编码还是需要很谨慎，同时通过良好的编码习惯、测试和 code review 来消除缺陷，有些同事说用动态语言
写大型项目会睡不好觉，不无道理。目前笔者所在的小团队就在 CI 上加了 flake8，pylint 检测，代码写糙了过不了，同时所有同事提交之前用 autopep8 格式化代码，用 isort 整理导入包顺序，避免了风格不统一的问题)</li>
<li>重视规范。代码量上去以后没有规范就是噩梦，也是很多小公司代码不忍直视的原因。(无文档、无注释、无单测、风格混乱、难以维护)</li>
<li>追根溯源，需求归档。在代码、提交信息、文档中记录需求文档地址、引用地址等。方便维护者能够根据代码提交寻找代码意图，尤其是几乎没有任何文档注释的代码。让人上来就看一段不知所云的代码无比痛苦。写代码有时候和写文章、论文差不多，可以在 docstring 里附上相关链接。commit 信息都应该足够重视，不要瞎写，要能体现代码提交意图（修复 bug、新 feature、代码优化等）</li>
<li>交叉引用。一般我们会使用 goodle doc 之类的工具协作需求和代码设计文档，之后在相关代码的 docstring 里注释上产品和代码设计链接，方便维护者了解需求和代码设计。</li>
<li>结对编程。结对编程和TDD是极限编程中大力提倡的，国内似乎没有多少公司在实践，一般帮助新人了解项目或者带实习生的时候，结对能帮助新人快速上手。有时候两个人一起边讨论边写代码要比写完后在 gitlab 一条条评论快很多。</li>
<li>总结复盘。不论是大小 bug，每次犯错都应该在你的小本本记录一下，不要重复犯错。</li>
</ul>
<p>平常可以留心下周围优秀的同事都有哪些好习惯，我们可以学习并改善下自己的开发流程。</p>
<ul class="simple">
<li>12 Schedule Time to Lower Technical Debt</li>
<li>11 Favor Hign Cohesion(low cyclomatic complexity)</li>
<li>10 Favor Losse Coupling</li>
<li>9 Program with Intention(Simple Design: Passes the tests; Revieals intention; No duplication; Fewest elements)</li>
<li>8 Avoid Primitive Obsession(Imperative code is packed with accidental complexity)</li>
<li>7 Prefer Clear Code over Clever Code</li>
<li>6 Apply Zinsser&#8217;s Principle on Writing(Simplicity;Clarity;Brevity;Humanity)</li>
<li>5 Comment Why, not What</li>
<li>4 Avoid Long Methods&#8211;Apply SLAP (long is not about length of code, but levels of abstraction)</li>
<li>3 Give Good Meaningful Names (if we can&#8217;t name it appropriately, it may be a sign we&#8217;ve not yet understood its true purpose)</li>
<li>2 To Tactical Code Reviews</li>
<li>1 Reduce State &amp; State Mutation</li>
</ul>
</div>
<div class="section" id="id56">
<h5>技术氛围建设<a class="headerlink" href="#id56" title="永久链接至标题">¶</a></h5>
<p>对我个人而言，一个良好的团队想要留住人才，有竞争力的薪资，友好的同事关系，学习成长型团队是我比较看重的三点。国内感觉不好
的一点就是不太重视技术，导致大部分技术从业者吃青春饭，希望以后能有所改善吧。</p>
<ul class="simple">
<li>code review。通过结对编程或者code review可以快速让新人适应新的开发团队，统一开发风格，学习良好的编码习惯。</li>
<li>技术分享。每周团队成员技术分享，打造学习型团队。最好围绕团队目前正在使用到的技术栈</li>
<li>one on one : 每周一对一小组 leader 谈话，及时沟通反馈技术或者业务上的问题。(北美很多公司有这种习惯，我个人觉得挺好的)</li>
<li>技术复盘。如果有成员导致了重大 bug，可以一起开复盘会进行分析总结，如何避免再犯。</li>
</ul>
</div>
<div class="section" id="id57">
<h5>开发流程(需求-&gt;分析-&gt;设计-&gt;实现-测试)<a class="headerlink" href="#id57" title="永久链接至标题">¶</a></h5>
<p>总了一下开发步骤，当然如果需求紧急一下一些步骤可以省略，但是对于一些对质量要求特别高的场景，最好严格遵守开发步骤，防止
上线之后出问题造成重大损失。</p>
<ul class="simple">
<li>需求评审。一般需求评审环节也需要技术人员参与评估，以此衡量开发排期，防止不合理需求出现(比如技术上短期不可行等技术风险, 明显不合理的需求也要给出自己的意见)</li>
<li>设计文档。包含需求背景，技术调研，技术选型，关键流程图，架构图，数据表设计，接口功能格式设计，项目排期等。可以据此构造一个模板，每次填写相关项。不要上来就写代码，不仔细设计可能后以后留下隐患</li>
<li>技术评审。根据项目大小和重要性由同事共同 review 技术方案，最好组内有技术老手负责把关。之前使用 google doc 来编写技术方案文档，大家可以一起评论和编辑。</li>
<li>需求分解。功能需求，性能需求，容错容灾需求，监控需求等，评估开发量。</li>
<li>编码实现，使用公司规定的 git 工作流和编码规范开发。推荐合理使用 git 分支，防止多个功能被一起带上线，或者难以回滚。</li>
<li>自查代码。git commit 之前先自己审查一下代码，看看有没有小bug，不规范甚至有错误的地方。可以使用自己的一套自查表。</li>
<li>服务自查。参考这个表格自查一下服务，是否有没有漏洞 <a class="reference external" href="http://vearne.cc/archives/39164">《开发更高质量的服务》</a></li>
<li>代码审查。至少一个同事负责代码 review，方便同事了解业务，修正不合理代码。</li>
<li>单测+自测。项目最好有单测，接口自测。一般来说会有自己的开发环境来自测。再简单的功能也要自测，不要太自信，否则 bug 会教你做人</li>
<li>功能提测（提测模板：包含需求背景，测试流程，期望结果，测试注意事项等），一般由测试工程师来完成。</li>
<li>监控上报。服务或者业务有没有需要监控的，比如视频上传成功率等，功能完成之后需要加上相关的监控上报，指标报警等。</li>
<li>压力测试。如果预估有相当大的访问压力(评估最大 qps，缓存该加的加上)，必须在上线之前使用压力测试工具压测，防止线上出问题，比如使用 locust 来压测并生成结果。压测的时候监控服务和底层组件的压力。</li>
<li>bug 跟进和修复，复盘总结问题等。可以根据 bug 影响级别定级，高级别 bug 需要一起复盘总结，防止再次出问题。</li>
<li>复盘总结。出了哪些 bug，踩的坑，可以改进的地方等可以总结成文档。</li>
</ul>
<p>Think more, type less. Aim for minimalism, fewer states, less mutability, and just enough code for the known, relevant parts of the problem.</p>
<p>《The Zen of Python》 - Tim Peters</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren&#39;t special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you&#39;re Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it&#39;s a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let&#39;s do more of those!
</pre></div>
</div>
</div>
</div>
<span id="document-debug/index"></span><div class="section" id="debug">
<h4>Debug 调试神技<a class="headerlink" href="#debug" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>凡是可能出错的事就一定会出错。 - 墨菲定律</div></blockquote>
<div class="section" id="bug-debug">
<h5>调试/bug 定位/debug<a class="headerlink" href="#bug-debug" title="永久链接至标题">¶</a></h5>
<p>调试也是个很重要的问题，不可能保证代码没bug，要命的是有时候写代码完成功能的时间还没调试的时间多，编码不要过度求快，逻辑正确更重要。
复现是排错的第一步，之后通过各种方式确定原因（访问日志、邮件报的异常记录）等，通过走查代码、断点调试（二分法等）确定错误位置，确定好错误原因了就好改了。修复后最好反思下问题的原因、类型等，哪些地方可以改进，争取下次不犯一样的错，慢慢减少错误才能越来越高效。</p>
<p>尽量写出对自己也对其他人负责的代码，上边费了牛劲都是在阐述这个显而易见但是没多少人严格遵守的东西。用动态语言写大型项目维护起来要稍麻烦，
很多新手写代码不注重可维护性，甚至自己写的代码回头自己看都一脸懵逼，问了一句这代码TM是干啥的？
一开始的负责会为以后协作和维护带来极大便利（当然你想干两天就走让其他人擦屁股就当我没说）。
最后，很多东西我也在摸索，上面的玩意你就当小白的踩坑记录，随着理解和经验的加深我会不定期更新本篇内容。另外我发现网上大部分是教程性的东西，对于python相关的工程性的东西很少，我很疑惑难道大部分公司的python项目都写得相当规范？没人吐槽？反正我是踩过坑，希望看到过本章的人能把python代码质量重视起来。</p>
<p>如何定位和修复 bug：复现-&gt;定位-&gt;修复-&gt;验证-&gt;复盘。大胆假设，小心求证；思路不通，换个角度。定位需要找到 bug 出现时候的上下文信息，可以用 log，sentry，kibana 日志系统等查看。确认之后通过走查代码、断点调试等方式寻找代码逻辑错误。
如果是比较复杂的系统，之间的交互比较多，可以边调试边记录，把关键的流程调用、系统交互逻辑、关键点的日志记录到文档里，整体梳理，对于排查比较难以解决的 bug 也有帮助。</p>
<ul class="simple">
<li>第一步是复现，偶尔才复现的代码是很难排查错误的。如果不好复现但是有 sentry 之类的记录工具也是极好的，sentry 会记录当前栈信息和变量信息，非常有利于排错。</li>
<li>走查代码。使用 pylint 等静态检测工具排除低级错误(你应该把它集成到开发工具里)。</li>
<li>看提交日志。最近代码的修改记录，是否是别人的代码引入了 bug。是否可以回滚到上一个可用部署解决呢？(注意一旦一个新的上线出问题，应该先回滚部署而不是回滚代码)</li>
<li>看日志，各种日志(logging, nginx)，看 sentry 异常信息。很多框架或者工具都有 debug 模式，打开 debug 模式可以获取到更多有用信息（但是要注意线上慎用 debug 级别日志）</li>
<li>加日志。如果已有的日志没能排查出来关键信息，可以适当增加 debug 日志记录更充分的数据。比如关键函数的输入和输出，关键rpc调用/数据库查询/第三方库调用/重要数据结构的输入和输出等。</li>
<li>问同事，问源码作者(脸皮要厚)，让同事帮忙 review 审查代码。有时候人有思维定势，你自己看不出来的别人可能一眼就看出来了。</li>
<li>借助搜索引擎。很多问题 google/stackoverflow/github 上都可以搜到，善用搜索引擎解决问题。</li>
<li>小黄鸭调试法，桌子上放个小黄鸭（小黄鸡儿也行），然后尝试从头到尾给它讲解有问题的代码段，说不定就在你给它代码描述过程中发现了问题。</li>
<li>断点调试。看变量值。二分法(分而治之)排查代码位置，快速试错定位。比如一个地方很有隐秘的错误，但是又不好快速确定位置，我们就可以用二分加断点的方式快速定位到具体哪一块出了问题。</li>
<li>使用调试器(命令行or IDE 调试工具）。 ipdb/pdb 断点配合 python 一些内置方法比如 <code class="xref py py-obj docutils literal"><span class="pre">print/vars/locals/pprint</span></code> 等断点调试，使用 curl/chrome 开发者工具/mitmproxy 等调试请求。代码异常可以通过 <code class="xref py py-obj docutils literal"><span class="pre">import</span> <span class="pre">traceback;</span> <span class="pre">traceback.print_exc()</span></code> 打印出来。</li>
<li>日志比对/输入输出对拍。在重构系统的时候，首先保持原有系统和重构之后代码的正确性。可以通过比对日志，比对输入和输出值的方式确保正确</li>
<li>功能对拍。可以用不同的语言、框架等实现同一个功能，看看是否是因为某些框架的 bug 导致，比如一个框架没问题，另一个有问题就可以断定是该框架实现本身有问题。</li>
<li>排除法。不断记录灵感/想法/可能的原因等，做排除法，缩小问题范围，说不定就可以发现 bug 的藏身点。</li>
<li>依赖库bug。一般经过广泛使用的第三方库是可以信赖的，但是公司自己造的轮子（尤其是文档和单测都没有的），还是有可能出 bug 的。有可能是依赖而非自己代码逻辑 bug。</li>
<li>升级后出问题。是否有完善的功能测试和单元测试保证回归没有问题？升级代码修改了哪些部分？降级之后能否复现？</li>
<li>服务超载。重点关注指标 cpu/io/memory/磁盘/log/连接数 是否被打满，是否无法继续正常服务，如果是服务器负载问题也会导致服务失败，不一定是主逻辑代码有问题(当然也有可能是连接池使用不当导致)。</li>
<li>是否是缓存的问题？缓存数据过期了么？缓存是否一致呢？能否清理缓存解决？测试环境禁用一下缓存看看表现如何(笔者之前改完代码一直 debug 没生效结果发现是缓存还在导致一直是旧数据)</li>
<li>是否是配置的问题？配置的时候参数填写的是否正确，有没有去掉多余的无用的空白符？比如笔者遇到过对比配置结果手动填写的配置多了空格导致比对失败</li>
<li>是否是特殊输入问题？偶现的问题可能是由某些特殊的输入参数代码未处理导致的，能否通过日志或者构造某些特殊的输入复现？</li>
<li>服务之间的依赖关系如何？有没有分布式链路追踪，哪一步调用关系出了问题？是否是没有降级，有没有碰到雪崩？服务间有没有循环调用?</li>
<li>监控报警。各种服务指标监控是否有报警？报警是否正常？如果没有及时监控到是否可以增加相关指标的报警？</li>
</ul>
<p>发现并且修复问题之后，我们需要通过之前的 bug 来涨涨记性，如何避免类似的问题再犯，养成良好的编码和思维习惯。</p>
<ul class="simple">
<li>重视静态检查/编译器/IDE 开发工具的缺陷提示，尽量连 warning 提示都不要留，及时修复缺陷，保证高质量的代码可以有效减少 bug 产生。</li>
<li>不要死磕，一个法子不行换一个。死磕可能会耗费太长时间并且容易进入死胡同(思维定势)，在一个大型复杂系统中定位 bug 原因是对技术、经验、毅力、灵感、心理素质的很大考验，休息一会甚至睡一觉醒来可能就解决了。</li>
<li>极难排查和复现的 bug 可以无限期搁置，bug 永远修不完的</li>
<li>找到 bug 修复以后增加相应单元测试用例，这样对回归测试非常有利，同时避免重复犯一样的错误。tricky 的地方要加上注释。</li>
<li>修复原因而非现象。你要排查出来真正导致 bug 的原因，而不是仅仅通过魔改代码修复了不合理现象。又比如仅仅依赖重启解决内存泄露等问题，而不去排查真正泄露的原因（当然可能排查起来很艰难）</li>
<li>真的是代码的问题么？还是非代码因素：比如代码是否正确部署上线等(比如之前脑残查一个 bug 无解最后发现是部署系统失败部署到线上压根没成功，还是老代码，根本没起作用）。如果实在没发现代码级别错误，单测也比较完善，可能就要考虑下非代码因素。</li>
<li>配置/环境问题。是否是因为配置而非代码逻辑 bug 导致的，线上/测试/开发环境 的配置是否正确，是否脑子抽了写串了，比如测试环境的配置写到了正式环境(这种看似低级的错误笔者在工作中就遇到过)</li>
<li>建立个人 bug 清单和上线核对清单，避免再次出现犯过的错误。你的每一个错误都应该自己用一个笔记软件或者小本本记录下来，避免再次犯错(小心被扣工资)。上线之前检查日志等级，进程数设置是否正确，建立核对清单，养成好的思维习惯</li>
<li>bug 总结：建立错误检查表(核对清单)，哪些可以避免的记录下来，防止以后再犯。(团队的知识财富)。比如笔者在关闭一个 bug 单的时候会注明 bug 产生的原因和修复方式，而不是修复完成之后就不长记性了</li>
<li>流程自动化。凡是可以自动化的就自动化，依赖人的行为反而是最容易出错的。脚本一旦编写通过之后就可以无限次正确使用，远比人为操作可靠。</li>
</ul>
<p>大多数 bug 都可以通过复杂度控制、设计复审、代码审查、代码静态分析、单测/功能测试等找出来，我们可以综合利用以上手段尽量减少代码缺陷，大幅减少给代码擦屁股的时间。</p>
<ul class="simple">
<li><a class="reference external" href="https://book.douban.com/subject/6398127/">《软件调试修炼之道》</a> 笔者比较推荐的一本书，告诉你正确的思维方式</li>
<li><a class="reference external" href="http://www.wklken.me/posts/2015/11/29/debugging-9-rules.html">《调试九法》</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/36810978">《Python ipdb 调试大法[视频]》</a> 笔者经常在服务器上进行命令行调试，一些技巧</li>
</ul>
</div>
<div class="section" id="bug">
<h5>常见的 bug 类型<a class="headerlink" href="#bug" title="永久链接至标题">¶</a></h5>
<p>打算记录一下自己犯过和见过别人犯过的一些常见 bug 类型，尽量避免重复犯错，笔者会长期不定期更新这个错误列表，不断吸取自己
和别人的经验。笔者这里也强烈建议你自己整理一个文件，专门用来记录你曾经犯下的错误并引以为戒，争取不要重复之前的 bug。</p>
<div class="section" id="id3">
<h6>需求理解错误:<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>需求理解不一致。业务开发中很常见的一个问题，产品/开发/测试理解不一致导致实现被当成 bug，一定好沟通好互相阐述确保需求理解一致。</li>
</ul>
</div>
<div class="section" id="id4">
<h6>代码错误:<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>拼写错误。不要笑，这个错误其实很常见，推荐打开编辑器的拼写检查，可以消除一些类似问题。</li>
<li>类型错误。在动态语言和弱类型语言当中比较常见的一种错误(动态语言确实更容易出 bug)，可以借助类型强转，type hint 工具。</li>
<li>资源没有关闭。打开的文件/IO流/连接等资源一定要关闭，防止资源泄露。go 的 defer 和 python 的 with 最好用上</li>
<li>深浅拷贝问题。不同语言可能又不同的拷贝模型，确定你的参数是深拷贝还是浅拷贝，能否修改，修改了之后是否有副作用。</li>
<li>数组越界错误。注意涉及到数组的时候使用的下标是否会越界。越界了 python 抛出异常，go 直接 panic 掉，并且 go 不支持负数下标</li>
<li>数值截断错误。注意强制类型转换是否会发生截断，损失精度，结果是否符合期望。注意不同语言数值范围，比如前端 js 无处直接处
理后台返回的 int64 数字，必须处理成字符串，被坑过</li>
<li>参数校验。一般来自用户的输入都要假设参数可能是错误甚至是恶意参数，后台必须要进行类型、大小、范围、长度、边界、空值等进行检查，防止恶意参数导致服务出问题</li>
<li>参数单位是否匹配。比如 go 需要时间的参数 time.Duration 有没有乘以对应的 time.Second/MilliSecond 等。</li>
<li>参数顺序不对。如果函数参数太多可能导致看走眼顺序写错了，所以强烈建议如果参数太多，封装成对象或者一个结构体传参。</li>
<li>路径错误。编写一些脚本需要处理文件的时候，推荐使用绝对路径比较不容易出错。</li>
<li>空值错误。比如直接赋值一个 go 里边声明的 map 会 panic，你需要先给 map make 一个值，很多 go 新手会重复犯这个错(go slice 却可以直接声明之后 append)</li>
<li>零值和空值。有时候我们根据业务来区分零值（一个类型的初始化值）和空值 (None/nil等)，注意处理上的细微区别。</li>
<li>闭包问题。循环里闭包引用的是最后一个循环变量的值，需要注意一下，很多语言都有类似问题，可以通过临时变量或者传参的方式避免</li>
<li>遍历修改列表问题。一边遍历，一边修改可能会使得迭代器失效而出错，最好不要遍历的时候修改列表。</li>
<li>遍历修改元素值问题。这一点 go 和 python 表现不同，go 比如你去循环一个 <code class="xref py py-obj docutils literal"><span class="pre">[]Struct</span></code> 是无法修改每个元素的，go 会拷贝每一个元素值，需要通过下标或者指针修改</li>
<li>影子变量(shadow)。很多语言同名的局部作用域变量会隐藏外部作用域变量，最好不要同名冲突，否则可能不是期望结果。建议使用go vet/go-nyet 之类的静态检查工具检查</li>
</ul>
</div>
<div class="section" id="id5">
<h6>内存问题<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>解引用空指针。是否引用了空指针的值导致直接 panic？比如 go 里边直接对一个 nil map 赋值 panic。指针有没有 nil 检查</li>
<li>内存泄露。有没有循环引用？有没有全局变量值一直增长没有释放？有没有多个对象底层引用的其实是同一块内存始终无法释放(比如直接赋值)？</li>
</ul>
</div>
<div class="section" id="id6">
<h6>网络问题<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>网络请求超时。所有网络请求的 client(http/rpc) 是否有设置超时参数，比如有些 go 的 client 需要显式自己传进去超时参数，否则可能导致 block</li>
<li>连接池打满。连接池应该是服务共享的(单例)，而不是每个请求都要去创建连接池导致打满连接池。请检查 client 的连接池和超时参数设置是否合理。</li>
<li>长短连接使用不当。注意有些需要长连接的场景，可以避免频繁建立 tcp 握手的开销。(http keepalive)</li>
<li>接口限制。接口请求参数有没有进行限制，一次请求的数据量是否太大，有没有加上分页参数，日志会不会一次打印太多导致 IO 压力大</li>
</ul>
</div>
<div class="section" id="rpc-web">
<h6>RPC/Web 框架<a class="headerlink" href="#rpc-web" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>请求参数限制。比如一般 rpc 请求会限制每次请求的最大的参数个数，如果一次性请求太多可能需要分批并发请求</li>
<li>debug 模式。注意线上一定要关闭掉 debug 方式防止泄露关键信息。很多框架在 debug 模式下会显示一些关键信息，可能会被黑客利用</li>
<li>序列化协议版本问题。client/server 序列化的方式是否一致？版本是否一致？不同的版本之间有时候可能会有一些微妙的 bug</li>
</ul>
</div>
<div class="section" id="id7">
<h6>数据库问题<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>查询参数非法。查询数据库的时候可能因为一些不合理参数导致数据库慢查询,比如一次查询太多导致慢查询。可以在入口处做一下限制。比如限制limit 大小</li>
<li>查询参数类型不匹配。注意如果传入类型不对，可能导致数据库没法利用索引导致慢查询，注意查询的参数类型和数据库类型匹配</li>
<li>慢查询：没有索引，索引设计不合理可能导致慢查询问题，有没有慢查询监控？</li>
<li>连接池跳涨。除了不当使用连接池之外，如果是启动了大量的服务容器也可能有这个问题，注意限制单服务连接池的大小</li>
<li>连接池过大。连接池数量设置太大效率反而可能降低，应该根据实际压测结果设置一个比较合理的值，并非越大越好</li>
<li>主写从读。很多采用最终一致性模型，但是对于一些对时延敏感的场景要考虑是否会有主从延迟问题</li>
<li>字符集问题。注意如果字符串需要存一些特殊的 emoji 表情符号，需要使用 utf8mb4 字符集。</li>
<li>请求放大。不要在循环语句里边请求数据库或者 redis（除非你明确知道你在干什么？），使用批量请求并限制每次请求个数，防止打挂数据库</li>
<li>SQL注入。尽量不要使用直接拼接 sql 的方式，比较容易出现 sql 注入。使用 orm 或者一些第三方库可以有效减少注入问题</li>
<li>数据脱敏。敏感数据是否加密存储，绝对不能明文直接存储用户的敏感信息</li>
</ul>
</div>
<div class="section" id="id8">
<h6>并发问题<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>线程安全。如果不是线程安全的操作(原子操作)，应该通过加锁等方式做数据同步。比如 go 里边如果多个 goroutine 并发读写 map 程序会出错(lock/sync.Map)。利用好 race detector。
但是有些语言有 GIL 可以保证内部数据结构的一些原子操作，这个时候可以不用加锁，所以要区分不同编程语言决定。</li>
<li>goroutine泄露。确保你的 goroutine 可以完成退出，防止大量未执行结束的 goroutine 堆积。通过上报 go 的 runtime 指标可以发现</li>
<li>死锁问题。锁的粒度对不对？锁有没有正确加锁和释放锁？加锁和释放锁的类型是否匹配(Lock/Unlock, Rlock/Runlock())，次数是否匹配？</li>
</ul>
</div>
<div class="section" id="id9">
<h6>依赖库问题<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>依赖版本是否一致。笔者曾经因为开发工具的自动 import 引入了错误的包版本导致一个挺难查的 bug（vendor 和 gopath 下不同的redigo 版本)，
要小心因为不同版本导致的一些极其隐蔽的 bug。最好通过包管理工具锁定依赖的第三方库版本</li>
<li>升级服务出问题。升级有时候可以解决一些 bug，但是也可能引入新 bug？能否通过回退到上一个版本解决(比如git checkout 到一个历史提交)？是否详细看过升级日志(release notes)，修改了哪些东西？是兼容升级还是不兼容升级？</li>
<li>清理无用依赖。对于不用的依赖也有可能引入问题，不用的依赖最好清理掉，比如 <code class="xref py py-obj docutils literal"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> 或者清理掉 python <code class="xref py py-obj docutils literal"><span class="pre">requirements.txt</span></code></li>
</ul>
</div>
<div class="section" id="id10">
<h6>日志错误<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>日志级别错误。线上使用了 debug 级别，可能导致日志打满，如果没有滚动日志可能会导致服务器磁盘打满。一定要注意不同环境日志级别，推荐集中式日志收集系统</li>
<li>日志参数错误。日志语句对应的占位符要和传参的个数一致，类型要匹配，比如本来是数字的使用了 <code class="xref py py-obj docutils literal"><span class="pre">&quot;%s&quot;</span></code> 而不是 <code class="xref py py-obj docutils literal"><span class="pre">&quot;%d&quot;</span></code></li>
<li>缺少必要信息。如果是为了 debug 加上的日志一定要有足够的上下文信息、关键参数帮助排查问题，同时也要注意日志不要泄露敏感数据（比如密码等）</li>
<li>日志过大：除了注意日志等级，还要注意是否输出了过大的日志导致磁盘 IO 飙升，适当精简日志量，或者提升线上日志等级只打印异常和ERROR。线上一定要关闭 DEBUG 日志</li>
<li>危险操作记录。对于一些修改数据的危险操作，比如一些后台管理系统等，一定要加上日志记录，方便排查问题</li>
</ul>
</div>
<div class="section" id="id11">
<h6>错误/异常处理<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>不要忽略任何一个错误/异常。除非你有 100% 的把握可以忽略，否则至少要在发生错误或者异常的地方加上日志，出问题之后错误被吞掉会极难排查。笔者这个地方吃过亏，吞掉了错误导致排查困难</li>
<li>集中收集。一般搭建 sentry（异常、错误收集）；ELK（集中式日志收集）来进行集中收集，方便针对异常、日志进行聚合和搜索。否则散布在各个服务器上很难排查问题</li>
</ul>
</div>
<div class="section" id="id12">
<h6>配置错误<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>配置环境写串。看起来是一个很傻的错误，但是其实还挺常见，注意不同环境配置是否对的上，别把测试的写到正式环境了。启动服务时打印配置看看</li>
<li>服务启动命令是否写错。有些服务依赖命令行启动的时候容易写错参数，建议通过配置文件的形式传进去。</li>
<li>配置字符串是否有多余空白符。笔者也被这个小问题坑过，手动编辑的时候人工加上了空白符导致我比对出错，注意配置参数都要去掉空白符</li>
</ul>
</div>
<div class="section" id="id13">
<h6>字符串问题<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>比对字符串。单元测试的时候注意比对的字符串可能因为多了空格的问题没法严格比对。注意可以去掉空格之后对比，笔者曾经因为不
同字符串就多了一个空白符比对失败查了好久，被坑过。比对字符串特征而不是直接对比字符串</li>
</ul>
</div>
<div class="section" id="id14">
<h6>分布式系统问题<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>分布式锁。分布式服务对于需要数据同步的操作可以使用分布式锁，注意分布式锁的超时问题(本身是否高可用)</li>
<li>时钟倾斜(clock skew)。如果代码强依赖时间戳在不同的服务器上可能因为时钟差距导致问题，可以采用适当取整对齐时钟。有一些第
三方库允许一定的时间差容忍。<a class="reference external" href="https://github.com/dgrijalva/jwt-go/issues/383">https://github.com/dgrijalva/jwt-go/issues/383</a></li>
<li>时钟同步出错。笔者最近碰到的问题，云服务机器时钟出问题了，导致我一些服务鉴权带上时间戳参数的失败了。</li>
<li>分布式数据库。注意有些分布式数据库插入数据之后不会返回主键。可以用分布式 id 生成器(snowflake算法)指定主键</li>
</ul>
</div>
<div class="section" id="id15">
<h6>缓存问题<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>超高热点 key：对于微博/直播之类的应用，比如明星出轨或者热门直播等，可能有某些热点的 key 集中到单台 redis 上导致压力过大(看一下 redis 热点 key 统计方便排查问题)，可以考虑再加一层进程内缓存。比如使用 go-cache 等进程内缓存库。
编写代码的时候应该注意到可能发生这种热点 key 的问题(测试环境压测+观察热点 key)，应当谨慎使用 redis，充分利用进程缓存/key hash是有效的方案。</li>
<li>redis版本和集群模式。使用云 redis 的时候之前因为使用了 lua 脚本，但是测试环境和线上使用了不同的 redis 集群版本，发现测试
环境测试一直没问题，但是一到线上就不起作用。建议保持线上和测试环境的基础组件版本一致。</li>
<li>系统调用结果缓存。之前发日志获取本机 ip 的时候没有缓存下来，导致大量系统调用，类似结果可以放到缓存或者全局变量</li>
</ul>
<p>参考:  <a class="reference external" href="https://www.alibabacloud.com/help/zh/doc-detail/67252.htm">热点key问题的发现与解决</a></p>
</div>
<div class="section" id="id16">
<h6>脚本编写问题<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>先用日志替换写操作。需要跑一些脚本的时候，可能会修改数据库，如果脚本直接修改了数据并且脚本有 bug 可能就会导致数据异常并很难回滚。
建议所有的写操作写替换成日志打印出来，确认无误之后再去执行，更加保险。</li>
<li>数据备份。用脚本操作重要数据之前建议先备份一份，防止操作出错无法恢复。</li>
</ul>
</div>
<div class="section" id="id17">
<h6>服务构建问题<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>版本检查。go/python 版本是否一致</li>
<li>环境检查。环境变量，或者构建参数、 go env 等是否一致</li>
</ul>
</div>
<div class="section" id="id18">
<h6>后台服务<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>自动拉起。如果服务因为严重错误退出了(比如 go panic 了，python 未捕获异常进程退出了)，能否快速拉起服务？</li>
<li>异地部署。是否已经做到了两地三机房？一个机房挂了之后，服务能否正常继续工作</li>
<li>数据不一致。如果程序在关键流程中退出了，是否会导致数据不一致的问题？有方法修复么？是幂等操作么？比如交易系统定期对账</li>
<li>自动扩容。如果突然请求量上去了，服务能否在短时间之内快速扩容应对压力？</li>
<li>快速回滚部署。如果线上出了问题，能否快速回滚到上一个可用的稳定版本保证服务可以继续稳定执行？回滚是否会有不兼容情况，导致其他依赖你的服务不正常？</li>
<li>拆分部署。对于一些特别核心的接口，可以分开部署。防止其他接口有问题了，造成核心服务不稳定。（一个项目的接口重要性不同)</li>
</ul>
</div>
<div class="section" id="id19">
<h6>服务监控(监控三板斧：度量指标+告警、链路追踪、日志)<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>qps监控。有没有监控服务每个接口的 qps？有没有监控接口的成功失败率？返回码？</li>
<li>响应时间。每个接口请求的响应时间有没有做监控？ TP90, TP99 分别是多少？</li>
<li>链路追踪。微服务中各种系统互相调用，有没有用 open-tracing 之类的进行链路追踪？</li>
<li>业务监控。使用 Grafana 之类的监控系统对关键业务数据进行打点监控，防止某些业务异常</li>
<li>失败报警。关键接口、服务挂了，机器负载高了有没有及时发送报警提醒？</li>
<li>异常上报。区分于日志，异常一般是发生了比较严重的错误，业界有比如 sentry 这种集中式异常收集平台来上报异常，一般除了无法
避免的网络问题之外，大部分异常都是需要开发者修复的。</li>
</ul>
<p>写完代码之后检查一下该加的日志有没有加，该上报的指标有没有上报，错误能否及时捕捉并且上报到平台上。</p>
</div>
<div class="section" id="id20">
<h6>熔断降级<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>熔断保护。对于核心服务，如果流量短时间暴增，能否监控到并且正常处理。如果下游服务打挂了，能否熔断保护，应当确保调用其他 rpc 服务加上熔断器保护。</li>
<li>柔性降级。柔性可用是在有损服务价值观支持下的方法，重点在于实际上会结合用户使用场景，根据资源消耗，调整产品策略，
设计几个级别不同的用户体验场景，保证尽可能成功返回关键数据，并正常接受请求，绝不轻易倒下。简言之就是保证关键接口兜底策略</li>
<li>压力测试。上线之前有没有预估过最高 qps 然后做过压力测试并且监控各个基础组件和下游服务的压力和稳定性？能否应对突发的流量</li>
<li>混沌测试。如果随机停掉一些依赖服务，你的服务会有问题么？有没有类似混沌测试保证接口没问题？</li>
<li>接口限流。是匀速限流（leaky bucket 漏桶算法）还是可以允许突发流量（token bucket 令牌桶算法）？限流之后是丢弃还是降级(fallback)？</li>
<li>频率限制。对于一些用户相关接口有没有针对用户操作进行频率限制(比如借助 redis 限制操作频率)？如果接口被恶意刷量了如何处理？</li>
</ul>
<p>想一下，如果你的服务接口突然 qps 暴增了成百上千倍(比如类似微博热点推送，直播间涌入，轮询接口等)，你的服务能扛得住么？
各种基础组件 mysql/redis 等会挂掉么？如果扛不住能够限流降级保证服务依然可用么？笔者之前就因为疏忽，一个接口短时间 qps 翻了几百倍导致接口大量失败。</p>
</div>
<div class="section" id="id21">
<h6>服务自查<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>上线之前请阅读以上内容，详细检查自己的服务是否有缺陷</li>
</ul>
</div>
</div>
<div class="section" id="id22">
<h5>参考<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="http://vearne.cc/archives/39164">《开发更高质量的服务》</a></li>
<li><a class="reference external" href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/">50 Shades of Go: Traps, Gotchas, and Common Mistakes for New Golang Devs</a></li>
</ul>
</div>
</div>
<span id="document-codingtools/codingtools"></span><div class="section" id="codingtools">
<span id="id1"></span><h4>开发和编程工具<a class="headerlink" href="#codingtools" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>Do one thing, and do it well. - A principle of Unix philosopy</div></blockquote>
<div class="section" id="id2">
<h5>工欲善其事，必先利其器 开(装)发(逼)工具<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Pycharm/IDEA/Goland(JB全家桶)。专业的python IDE，功能很强大，特别喜欢它的代码merge工具，不想被编辑器折腾死的推荐直接使用，五星级推荐。(除了内存占用大点)。如果你不喜欢折腾编辑器，请直接用 IDE，经常看见一些用裸编辑器写代码的，代码规范检测都没有。</li>
<li>Neovim/vim/Emacs/Vscode/Sublime/Atom: 跨平台的编辑器。vim 目前是笔者的最爱，你可以在慕课网和 B站搜索到我的视频教程</li>
<li>meld/vimdiff/kdiff3: 跨平台的文件对比和冲突合并工具。当然还有付费的 BeyondCompare，对笔者来说大部分场景 vimdiff 就很好用</li>
<li>devdocs.io: 文档查询工具，可以在线查询</li>
<li>EditorConfig: <a class="reference external" href="http://editorconfig.org/">http://editorconfig.org/</a> 用来统一编辑器配置。如果成员用不同的操作系统和编辑器，建议使用。尤其是对于 python 这种使用缩进的语言</li>
</ul>
<p>一定要有个趁手的开发工具(它甚至比你女朋友都重要)，不管是IDE还是编辑器，你程序员生涯的小半辈子都在和它打交道(提升编辑效率的秘诀在于多用键盘快捷键，少用鼠标，以及可以高度定制、和扩展功能的编辑器)。甚至编程字体你都要谨慎选取，比如字体可以很好区分&#8216;1&#8217;, &#8216;l&#8217;, &#8216;I&#8217;, &#8216;0&#8217;, &#8216;O&#8217;, &#8216;S&#8217;, &#8216;5&#8217;等易混淆字符，给浏览代码带来便利。如果使用的是mac可以google下 &#8220;Mac OS X development environment setup&#8221;，有惊喜呦。最后注意你用编辑器的话一定要用 pylint，pep8 检测插件，否则不遵守规范可能会导致用 IDE 打开项目后一堆警告(别人会想问候你祖宗的)。
更多 mac 工具可以参考：<a class="reference external" href="https://github.com/jaywcjlove/awesome-mac">https://github.com/jaywcjlove/awesome-mac</a> 。搜 awesome-python 或者 awesome-flask 等有很多类似项目。</p>
<p>一些提升效率的建议：</p>
<ul class="simple">
<li>指法用对，练习盲打，提升敲击数字键的成功率</li>
<li>熟悉你的开发工具，各种 IDE 或者编辑器快捷键。vim 等高度定制的编辑器允许你按照自己的习惯修改快捷键</li>
<li>学习一门脚本语言（编写自动化脚本），编写你的命令行工具（一个可执行的 python 文件放到 bin 下就是一个命令行工具)</li>
<li>多用键盘快捷键少用鼠标。修改系统键盘按键，比如 capslock 使用频率比较低，一般我改成了 ctrl 键，因为用开发工具频繁使用到 ctrl，改成 ctrl 之后效率提高不少，小指头也不疼啦。</li>
<li>自动化（比如监听文件变动刷新浏览器、重启http服务等）</li>
<li>用好终端和命令行工具（我建议后端/运维等用 mac 或者 linux 系统，因为 server 大多跑的 linux，熟悉命令行会给你调试和面试带来便利）</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="http://ningning.today/2016/11/09/tools/vim-tmux-zsh-autojump/">《使用vim+tmux+zsh+autojump高效工作》</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/vim-video">《玩转 vim 与 Terminal (视频)》</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/91031876">《Mac 无鼠标编程指南（视频)》</a></li>
</ul>
</div>
<div class="section" id="macos">
<h5>MacOS 开发效率工具<a class="headerlink" href="#macos" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Item2: 替代原生的终端。<a class="reference external" href="https://medium.com/&#64;RyanDavidson/make-your-terminal-more-colourful-and-productive-with-iterm2-and-zsh-11b91607b98c">https://medium.com/&#64;RyanDavidson/make-your-terminal-more-colourful-and-productive-with-iterm2-and-zsh-11b91607b98c</a></li>
<li>Alfred: mac 下一款功能强大的工具，不过我一般只用它快速打开软件(比如直接输入app名前缀快速切换不同app)。可以用 python 编写一些自己的 workflow 提高效率(<a class="reference external" href="https://github.com/deanishe/alfred-workflow">https://github.com/deanishe/alfred-workflow</a>)，比如把时间戳转成日期等。 <a class="reference external" href="https://github.com/derimagia/awesome-alfred-workflows">https://github.com/derimagia/awesome-alfred-workflows</a></li>
<li>Dash: 强悍的文档查询工具。支持非常多编程语言和框架。windows 和 linux 可以用 Zeal。或者 <a class="reference external" href="https://devdocs.io/">https://devdocs.io/</a></li>
<li>CheatSheet: <a class="reference external" href="https://www.mediaatelier.com/CheatSheet/">https://www.mediaatelier.com/CheatSheet/</a> 显示 mac 快捷键</li>
<li>mac-setup: <a class="reference external" href="https://github.com/sb2nov/mac-setup">https://github.com/sb2nov/mac-setup</a> mac 下各种编程语言开发环境配置指引</li>
<li>Hammerspoon: 开源的mac窗口管理工具 <a class="reference external" href="https://github.com/Hammerspoon/hammerspoon">https://github.com/Hammerspoon/hammerspoon</a></li>
<li>Magnet/chunkwm/Amethyst/yabai 窗口管理辅助工具，拖拽窗口到屏幕边缘可以自动半屏， 全屏或者四分之一屏幕，还可以设定快捷键完成分屏，现在已经离不开magnet 分屏了。</li>
<li>Karabiner-Elements(mac): 改键工具 <a class="reference external" href="https://github.com/tekezo/Karabiner-Elements">https://github.com/tekezo/Karabiner-Elements</a> 也可以用来禁用内置键盘(mac自带修改capslock为 control)</li>
<li>Be Focused: mac 下番茄工作法工具，可以用来给任务计时，或者提醒该休息下了</li>
<li>Qbserve: <a class="reference external" href="https://qotoqot.com/qbserve/">https://qotoqot.com/qbserve/</a> 一个 mac 下的时间追踪软件，可以查看自己在不同软件耗时，改善时间和工作管理</li>
</ul>
</div>
<div class="section" id="id3">
<h5>命令行工具<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>tmux/tmuxp。比screen好用，可以用来分屏，托管进程等，服务器端必备神器，ubuntu下基本就不用使用terminator之类的分屏工具了。最近看youtube视频还发现有人在服务器上使用tmux和vim结对编程，两个人同时attach到一个session里，基情四射。</li>
<li>vim。本人比较喜欢的编辑器，平常写代码、博客、文档等使用频繁，配上各种插件编辑效率很高。<a class="reference external" href="http://vimawesome.com/">http://vimawesome.com/</a> 可以到这个上面安装排名靠前的那些插件，能够大大提高编辑效率，部分替代IDE(本人装了六七十个插件，满足各种变态的编辑需求)。其他优秀的编辑器sublime，atom，vscode，emacs等根据个人喜好来吧，不过vim等终端友好的编辑器方便在服务器上直接写代码，和本地体验一样，缺点就是补全和跳转支持不完善，对新人不友好，也可以 Pycharm  和 vim插件配合。(在google搜索python awesome等可以在github上搜索到一些awesome项目，总结了该语言很多技术工具)。网上还有很多牛人开源了自己的 dotfiles，我们可以参考下别人的 vimrc 配置。</li>
<li>neovim: 新时代的 vim，我在这个配置(<a class="reference external" href="https://github.com/PegasusWang/vim-config">https://github.com/PegasusWang/vim-config</a>)上自定义了自己的配置，使用起来性能和反应速度上远超原生的老古董 vim，目前笔者已经全面迁移到 neovim，用着很爽。感兴趣可以关注笔者知乎专栏，我录了一些针对初学者的教学视频。</li>
<li>vim-bootstrap: 一个快速建立不同编程语言 vimrc 的创建工具 <a class="reference external" href="https://github.com/editor-bootstrap/vim-bootstrap">https://github.com/editor-bootstrap/vim-bootstrap</a></li>
<li>ranger: 用 vim 的方式管理文件，替代 mac 下难用的 finder。</li>
<li>oni: <a class="reference external" href="https://github.com/onivim/oni/">https://github.com/onivim/oni/</a> 构建在 neovim 上的 IDE。还有 VimR 等项目。</li>
<li>wemux: tmux 共享，<a class="reference external" href="https://github.com/zolrath/wemux">https://github.com/zolrath/wemux</a></li>
<li>sshfs: 本地挂在服务器文件夹</li>
<li>tmate: <a class="reference external" href="https://tmate.io">https://tmate.io</a> 终端共享工具，结对编程。很多现代化编辑器 vscode, atom 提供结对编程的插件。</li>
<li>asciinema: 终端会话记录工具。<a class="reference external" href="https://asciinema.org/">https://asciinema.org/</a> 可以用来录制终端演示操作，而不用录屏。</li>
<li>oh-my-zsh。替代原生的bash shell，提供了好多方便的特性和漂亮主题，支持插件比如 zsh autocomplete。linux/mac下vim+tmux+zsh简直是绝配，甚至可以直接在服务器上方便地撸代码，跟本地开发体验没区别。</li>
<li>brew(mac)。类似ubuntu下的apt-get，可以方便安转各种软件和工具。</li>
<li>autojump。方便在命令行里来回跳转目录。</li>
<li>tldr: 列举出常见命令行工具用法。linux 命令行很多参数又不好记，man 手册比较难用，可以用这个 tldr 替代。<a class="reference external" href="https://github.com/tldr-pages/tldr">https://github.com/tldr-pages/tldr</a></li>
<li>rmtrash/safe-rm: linux 自带的 rm 非常危险，可以使用安全删除工具先放到垃圾桶。<a class="reference external" href="https://zhuanlan.zhihu.com/p/91515325">saferm</a></li>
<li>when-changed: 一个可以监控文件变动并且自动执行命令的工具，写脚本代码观察编写边输出结果的时候比较方便。笔者很多视频演示过</li>
<li><a class="reference external" href="https://github.com/onceupon/Bash-Oneliner">https://github.com/onceupon/Bash-Oneliner</a></li>
<li>epy-reader: <a class="reference external" href="https://github.com/wustho/epy">https://github.com/wustho/epy</a> 一个在终端下阅读 epub 电子书的工具，用快捷键 &#8220;o&#8221; 还可以打开图片</li>
</ul>
</div>
<div class="section" id="id4">
<h5>Mac 终端快速配置<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>安装iterm2 替代难看的原生终端</li>
<li>安装 home brew 方便装各种工具</li>
<li>安装 oh-my-zsh or fish</li>
<li>安装 oh-my-zsh 主题 powerlevel9k 或者 spaceship。推荐使用异步的更快的 <a class="reference external" href="https://github.com/romkatv/powerlevel10k">https://github.com/romkatv/powerlevel10k</a>。 常见其他主题有(pure, powerlevel9k, spaceship)</li>
<li>安装 vim / spacevim /neovim</li>
<li>最好安装 tmux 用来替代iterm2 分屏</li>
<li>按需安装 htop/autojump/z/fzf/ag 等命令行工具(使用 brew 可以安装)</li>
</ul>
<p>可以参考我 github 上的快速配置教程：</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/PegasusWang/linux_config/tree/master/mac">https://github.com/PegasusWang/linux_config/tree/master/mac</a> 笔者的 MacOS 终端快速配置</li>
<li><a class="reference external" href="https://github.com/bhilburn/powerlevel9k/wiki/Show-Off-Your-Config">https://github.com/bhilburn/powerlevel9k/wiki/Show-Off-Your-Config</a></li>
</ul>
</div>
<div class="section" id="id5">
<h5>打字速度练习<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h5>
<p>虽然程序员不是打字员，但是对笔者来说，需要记录大量文档和阅读笔记，高效的键盘和打字速度可以大幅增加(我使用 HHKB键盘+Vim编辑器无鼠标编程)码字效率。
打字速度上去以后(一开始正确率比速度重要，如果不是刻意练习正确率打字再多效果也不明显)，你可能会更加喜欢记录文档和笔记了，脑子里的想法可以快速用键盘来实现出来。
编程和平常打字不同的一大区别就是需要经常使用各种特殊的符号，如果没有经过刻意练习会经常打错符号。</p>
<ul class="simple">
<li><a class="reference external" href="https://www.ratatype.com/typing-test/">https://www.ratatype.com/typing-test/</a>  先来做一个 wpm 测试吧</li>
<li><a class="reference external" href="https://typing.io/">https://typing.io/</a>  包含代码片段的练习网站</li>
<li><a class="reference external" href="https://www.keybr.com/">https://www.keybr.com/</a> 可以根据英文『音节』来练习，提升因为打字速度和正确率</li>
<li><a class="reference external" href="http://www.speedcoder.net/">http://www.speedcoder.net/</a>  可以展示出来正确的指法</li>
<li><a class="reference external" href="https://www.typing-lessons.org/">https://www.typing-lessons.org/</a> 一套系列的打字和指法教程，没事的时候可以练习一下，摆脱二指禅打字。笔者目前就练习这个</li>
<li><a class="reference external" href="https://www.keyhero.com/wpm-typing-tips/">https://www.keyhero.com/wpm-typing-tips/</a> 同样一个针对程序员的打字练习网站。笔者没事就会练习一下</li>
<li>gtypist (brew install gnu-typist; gtypist) 一个linux/MacOS 命令行打字练习工具</li>
</ul>
</div>
<div class="section" id="id6">
<h5>Mac 屏保软件<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://github.com/JohnCoates/Aerial">https://github.com/JohnCoates/Aerial</a></li>
<li><a class="reference external" href="https://github.com/packagesdev/savehollywood">https://github.com/packagesdev/savehollywood</a></li>
</ul>
</div>
<div class="section" id="git">
<h5>Git 相关<a class="headerlink" href="#git" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>gitx(mac):方便查看代码提交历史，便于了解整个代码仓库是怎样一步步构建的。<a class="reference external" href="http://gitx.frim.nl/user_manual.html">http://gitx.frim.nl/user_manual.html</a></li>
<li>tig: text-mode interface for git. 喜欢命令行的可以尝试下，比如可以在终端下浏览提交记录和文件修改。 <a class="reference external" href="https://github.com/jonas/tig">https://github.com/jonas/tig</a></li>
<li>git-extras: 提供了很多方便的 git 工具，比如 git summary 可以输出代码的提交统计。<a class="reference external" href="https://github.com/tj/git-extras">https://github.com/tj/git-extras</a></li>
<li>git-cz: <a class="reference external" href="https://github.com/commitizen/cz-cli">https://github.com/commitizen/cz-cli</a> 用来统一 git commmit 提交信息，代替 gitmessage。参考文章：<a class="reference external" href="https://juejin.im/post/5afc5242f265da0b7f44bee4">https://juejin.im/post/5afc5242f265da0b7f44bee4</a></li>
<li>pre-commit: git pre commit 工具，比如可以在 commit 之前增加代码静态检查或者运行单元测试。 <a class="reference external" href="https://pre-commit.com/">https://pre-commit.com/</a></li>
<li>gitignore.io: 搜索ignore文件模板，有常见编程语言的示例模板。<a class="reference external" href="https://www.gitignore.io">https://www.gitignore.io</a></li>
<li>lazygit/gitui: 终端 git UI 工具</li>
</ul>
</div>
<div class="section" id="chrome">
<h5>Chrome 开发者插件<a class="headerlink" href="#chrome" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>SurfingKeys/vimium/Cvim: chrome 插件，可以用 vim 的方式操作浏览器，很方便，不用鼠标也能完成大部分操作，笔者使用的SurfingKeys比较强大，可以用 ctrl+i 来用 vim 编辑输入</li>
<li>wasavi: 想在网页编辑框使用 vim 可以试试这个插件。安装完之后使用 ctrl+enter 就可以了 <a class="reference external" href="https://github.com/akahuku/wasavi">https://github.com/akahuku/wasavi</a></li>
<li>FE助手：前端插件，Json 格式化/代码美化等很多有用的工具</li>
<li>Octotree: Chrome github 浏览插件，可以把 github 项目的目录树结构展示出来，非常方便</li>
<li>Github Hovercard: 可以在浏览 github 的时候展示一些链接信息，比如可以查看作者的个人页</li>
<li>Momentum: 美化 Chrome 界面的插件，有很多漂亮的图片作为背景</li>
<li>Onetab: 用来整合 chrome tab到一个页面，如果打开了太多窗口特别占用资源的时候可以使用</li>
<li>LGTM: 有些开发过程中，需要一个同事review 代码后评价 LGTM(Looks Good To Me)才能 merge 代码，这里是图片版的 LGTM</li>
<li>SimpRead: 简悦，阅读模式 chrome 插件，支持导出和分享。试了一下导出知乎回答还不错</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/86027644">《在浏览器中嵌入 NeoVim，可使用本地配置》</a></li>
</ul>
</div>
<div class="section" id="id7">
<h5>编程字体(适合代码显示)<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Monaco (Mac)</li>
<li>Consolas (Windows)</li>
<li>Hack</li>
<li>Source Code Pro (Adobe)</li>
<li>[FiraCode(连字符特性)](<a class="reference external" href="https://github.com/tonsky/FiraCode">https://github.com/tonsky/FiraCode</a>)</li>
<li>Jetbrinas Mono 字体</li>
<li>Nerdfont [<a class="reference external" href="https://www.nerdfonts.com/">https://www.nerdfonts.com/</a>]</li>
</ul>
</div>
<div class="section" id="id8">
<h5>代码工具/算法可视化<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>codelf: <a class="reference external" href="https://github.com/unbug/codelf">https://github.com/unbug/codelf</a> 不会命名？变量名查询神器</li>
<li>python 可视化：<a class="reference external" href="http://www.pythontutor.com/live.html#mode=edit">http://www.pythontutor.com/live.html#mode=edit</a></li>
<li>VisuAlgo: <a class="reference external" href="https://visualgo.net/en">https://visualgo.net/en</a> 算法可视化</li>
<li><a class="reference external" href="https://www.cs.usfca.edu/~galles/visualization/RedBlack.html">https://www.cs.usfca.edu/~galles/visualization/RedBlack.html</a></li>
</ul>
</div>
<div class="section" id="id9">
<h5>代码辅助和检测工具<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>pylint: 代码静态检测工具，请务必集成在你的编辑器或者IDE里（推荐）。能帮你少犯很多错误，动态语言写项目要十分谨慎，非常容易犯错。或者在CI加上 hook 每次 push 代码的时候检测。pylintrc 参考：<a class="reference external" href="https://github.com/PegasusWang/linux_config/blob/master/pylintrc">https://github.com/PegasusWang/linux_config/blob/master/pylintrc</a> 这里我忽略了很多无关紧要的提示，默认的 pylint 配置对代码检查实在是太严格了，很多老鸟也过不了。我敢打赌大部分 python 项目用默认 pylint 检查都是不及格分。（pylint 会给代码算个分, 10分制）</li>
<li>mypy: 类型检查工具，结合 python3 的 type hint 或者 python2 中的类型注释可以做类型检查。<a class="reference external" href="https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html">https://mypy.readthedocs.io/en/latest/cheat_sheet_py3.html</a></li>
<li>pep8: python代码风格检测工具(推荐)。懒人可以试试 autopep8 工具，自动格式化。所有人的代码都过一遍 pylint 和 autopep8(放宽行长度) 看起来就比较一致了。甚至可以配置编辑器保存后自动执行 autopep8，类似 gofmt</li>
<li>autopep8/yapf: python 代码自动格式化工具，懒人必备。都可以集成到 vim 里，比如使用  Plugin &#8216;Chiel92/vim-autoformat&#8217;  工具一键格式化。不过注意有时会无法正确处理多重缩进，这个比较危险，代码逻辑都变了，还是自己写代码的时候注意下格式。</li>
<li>prospector: 集成了众多python代码检测工具</li>
<li>mccabe: 圈复杂度检测工具。McCabe 是一种度量程序复杂度的方法，如果单个子程序复杂度过高，或许就需要拆分逻辑提高程序的易读性。</li>
<li>pyflakes</li>
<li>bandit: 用于Python代码的安全性分析，openstack 的项目 <a class="reference external" href="https://github.com/openstack/bandit">https://github.com/openstack/bandit</a></li>
<li>rope，可以用来重构等，功能强大。笔者经常用rope自动帮我重新整理导入的包顺序。</li>
<li>python-mode: 一个vim插件，有很多 python 补全，语法检测等支持。并且集成了很多 python 工具(pylint,pep8等)，笔者正在用。</li>
<li>jedi-vim: 一个 vim 插件，python 支持补全和重构。注意和 rope 的自动补全有冲突，不要同时启用。</li>
<li>Pyreverse: 代码 UML 生成工具, 帮助我们理解继承关系 (<a class="reference external" href="https://pythonhosted.org/theape/documentation/developer/explorations/explore_graphs/explore_pyreverse.html">https://pythonhosted.org/theape/documentation/developer/explorations/explore_graphs/explore_pyreverse.html</a>)</li>
<li>Epydoc: Automatic API Documentation Generation for Python</li>
<li>2to3/python-modernize: python2 转 python3 工具。目前 Instagram 已经全面迁移到 python3</li>
<li>编写2/3兼容代码：<a class="reference external" href="http://python-future.org/compatible_idioms.html">http://python-future.org/compatible_idioms.html</a></li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/27232791">《[转] Instagram 在 PyCon 2017 的演讲摘要》</a></li>
</ul>
<p>我觉得对于动态语言使用好静态代码检测工具还是很有必要的，最好集成在你的开发工具里(比如使用vim的python-mode插件可以很容易整合这几个代码检测工具)，辅助你写出高质量代码，否则大型动态语言项目维护起来就是灾难。python会给你一种代码很好写的错觉，不严格要求经常会写出来难以维护的烂代码，甚至导致代码仓库失控。通过 pep8、pylint、mccae 检测过的代码如果警告和错误都消除以后，从代码风格来说基本是没有大问题的，笔者一开始用的时候也是各种警告，修正过很多代码警告以后，以后代码就越来越规范和整洁了。<a class="reference external" href="https://github.com/PyCQA">https://github.com/PyCQA</a> 。对于懒人的话直接用 autopep8 ，再也不用纠结格式问题了。目前笔者在公司的一些后端项目中就加入了 flake8 和 pylint 检测（自定义了 pylintrc 文件忽略一些无伤大雅的警告），代码写糙了 CI 都过不了。
我个人强烈建议，所有的人用 isort 整理包导入顺序，用 autopep8 格式化代码，用 pylint 静态检测，（笔者目前的小团队就是这么做的），这样提交的代码格式会非常一致，而且代码非常干净，大项目也不容易失控，动态语言写项目真的很容易出错。能用工具就尽量用工具帮我们解决格式等问题，多余的精力用来思考代码逻辑本身。</p>
</div>
<div class="section" id="id10">
<h5>代码质量检测平台<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Covrralls</li>
<li>Sonar: <a class="reference external" href="https://www.sonarqube.org">https://www.sonarqube.org</a></li>
</ul>
</div>
<div class="section" id="id11">
<h5>项目工具<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>pigar: 找出项目使用到的依赖库</li>
<li>buildout: 项目构建工具</li>
<li>pyenv/virtualenv/pipenv：多版本管理</li>
<li>cloc, boyter/scc: 命令行代码行数统计工具，scc 速度快很多</li>
</ul>
</div>
<div class="section" id="id12">
<h5>代码仓库托管<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>gitlab: 公司用得多</li>
<li>github: 著名的程序员同性交友网站</li>
<li>bitbucket: 类似 github，好处是支持免费的私有仓库。当你不想共享代码的时候可以用</li>
</ul>
</div>
<div class="section" id="id13">
<h5>项目模板脚手架<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h5>
<p>微服务化的时代经常需要创建很多类似的项目代码模板，这个时候项目脚手架就分方便了。
统一的项目模板对于运维和开发都比较重要，有利于降低维护成本。</p>
<ul class="simple">
<li>cookiecutter: 一系列项目模板生成工具，懒人必备。<a class="reference external" href="https://github.com/audreyr/cookiecutter">https://github.com/audreyr/cookiecutter</a>。笔者之前内部项目就直接用 flask-cookiecutter 直接生成的。</li>
<li>yeoman: <a class="reference external" href="http://yeoman.io/generators/">http://yeoman.io/generators/</a> 前端项目模板生成工具</li>
<li>ant-design: 后端管理后台项目解决方案 <a class="reference external" href="https://ant.design/docs/react/practical-projects-cn">https://ant.design/docs/react/practical-projects-cn</a></li>
</ul>
</div>
<div class="section" id="id14">
<h5>持续集成<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>gitlab</li>
<li>Travis CI</li>
<li>Jenkins</li>
<li>Sonar: <a class="reference external" href="https://www.sonarqube.org/">https://www.sonarqube.org/</a> 代码质量管理</li>
</ul>
</div>
<div class="section" id="id15">
<h5>配置中心<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Apollo: <a class="reference external" href="https://github.com/ctripcorp/apollo">https://github.com/ctripcorp/apollo</a></li>
</ul>
</div>
<div class="section" id="api">
<h5>Api 工具<a class="headerlink" href="#api" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>checklist: <a class="reference external" href="http://python.apichecklist.com/">http://python.apichecklist.com/</a></li>
</ul>
</div>
<div class="section" id="dsl">
<h5>DSL<a class="headerlink" href="#dsl" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>PLY</li>
<li>PyParsing: 用来实现 DSL 比较方便。</li>
<li>Parsley</li>
</ul>
</div>
<div class="section" id="id16">
<h5>测试工具<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>py.test</li>
<li>nosetest</li>
<li>unittest</li>
<li>tox</li>
<li>mock: mocking makes unit testing easier</li>
</ul>
</div>
<div class="section" id="id17">
<h5>文档/写书/笔记工具<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>google doc/石墨: 支持多人协作编辑</li>
<li>gitbook/docsify + markdown: 可以写文档或电子书，托管到 github 上，可以生成 pdf。</li>
<li>doocer: <a class="reference external" href="http://doocer.com/">http://doocer.com/</a> 写 kindle 电子书工具</li>
<li>sphinx + readthedoc(或者 mkdocs，支持 markdown) （代码即文档），python 项目很多在用这个生成文档。这本小书就是这么写出来的。<a class="reference external" href="http://blog.huangz.me/diary/2013/tools-for-writing-redisbook.html">编写《Redis 设计与实现》时用到的工具</a></li>
<li>swagger/apidocjs: 适合写 restful 文档。如果使用 grpc 可以直接生成。</li>
<li>jupyter(ipython) notebook，可以做笔记或者代码演示或者ppt，支持rst，md等格式，搞数据科学的人用得比较多，配合 RISE (<a class="reference external" href="https://github.com/damianavila/RISE">https://github.com/damianavila/RISE</a>) 可以做代码交互式 slideshow，非常好的工具</li>
<li>Confluence: 适合作为团队的项目文档工具，团队大了以后文档还是很重要的</li>
<li>vimwiki/emacs org-mode: 依赖于vim/emacs 编辑器，可以做个人笔记，不过笔者还是比较倾向于独立于编辑器的工具</li>
<li>Graphviz: 通过编写代码来生成图片 <a class="reference external" href="http://graphviz.org/">http://graphviz.org/</a></li>
<li>pandoc: 用于各种格式文档之间的转换，比如 html-&gt;markdown, html-&gt;rst, markdown-&gt;rst</li>
<li>Onenote: 微软出品笔记工具，手写和绘图功能很不错，笔者在一些教程里使用它来绘图演示</li>
</ul>
<p>参考: <a class="reference external" href="https://digitalsuperpowers.com/blog/2019-02-16-publishing-ebook.html">Self-publishing a book with reStructuredText, Sphinx, Calibre, and vim</a></p>
</div>
<div class="section" id="swagger">
<h5>Swagger 工具<a class="headerlink" href="#swagger" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>swagger编辑器: <a class="reference external" href="https://swagger.io/tools/swagger-editor/">https://swagger.io/tools/swagger-editor/</a></li>
<li>swagger-edit: <a class="reference external" href="https://github.com/huan/swagger-edit">https://github.com/huan/swagger-edit</a> 本地编写文件预览，可以用自己喜欢的编辑器了（依赖 docker)</li>
</ul>
</div>
<div class="section" id="id18">
<h5>静态博客工具<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h5>
<p>静态建站工具允许我们用 github pages 建立静态博客，省去了服务器的费用。笔者的 <a class="reference external" href="https://pegasuswang.github.io">https://pegasuswang.github.io</a> 就是基于 hexo 搭建</p>
<ul class="simple">
<li>hexo: 基于 nodejs 编写的静态博客工具 <a class="reference external" href="https://hexo.io/zh-cn/">https://hexo.io/zh-cn/</a></li>
<li>hugo: <a class="reference external" href="https://gohugo.io/">https://gohugo.io/</a> 博客建站工具</li>
<li>gitalk: <a class="reference external" href="https://github.com/gitalk/gitalk#install">https://github.com/gitalk/gitalk#install</a>  基于 github 的评论系统</li>
</ul>
</div>
<div class="section" id="id19">
<h5>日志、异常收集工具<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Sentry: 用来记录异常非常好用，能看到完善的栈信息，方便排错。Python 社区用的比较多</li>
<li>Fluentd</li>
<li>ELK: Elasticsearch, Logstash, Kibana 日志聚合和搜索系统</li>
</ul>
</div>
<div class="section" id="devops">
<h5>管理及运维、监控工具(devops很火)<a class="headerlink" href="#devops" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Supervisor.进程管理</li>
<li>Fabric.应用部署</li>
<li>docker/k8s.最近比较火的容器技术。很多采用微服务架构的公司使用 docker 作为容器部署服务，或者构建一致的开发环境</li>
<li>SaltStack和Ansible. 配置管理</li>
<li>StatsDGraphitePrometheus等web监控</li>
<li>Netdata: 强大的系统监控工具 <a class="reference external" href="https://github.com/netdata/netdata">https://github.com/netdata/netdata</a></li>
</ul>
</div>
<div class="section" id="api-gateway">
<h5>API gateway<a class="headerlink" href="#api-gateway" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>kong: open-source API gateway and a microservices management layer. <a class="reference external" href="https://github.com/Kong/kong">https://github.com/Kong/kong</a></li>
</ul>
</div>
<div class="section" id="id20">
<h5>调试工具<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>IPython/Bpython: 代替原生的解释器，支持补全，语法高亮等</li>
<li>ipdb/pdb: ipdb 支持自动补全，比原生的 pdb 要好用一些。</li>
<li>pdbpp: <a class="reference external" href="https://pypi.org/project/pdbpp/">https://pypi.org/project/pdbpp/</a></li>
<li>postman: 接口调试 gui 工具，也可以导出成各种编程语言的 HTTP 请求代码，或者粘贴请求地址并且修改参数</li>
<li>curl: 如果不想使用 postman 等 GUI 工具（比如在服务器上本地测试无法使用这种工具），可以用 curl 命令或者 python requests 库模拟请求</li>
<li><a class="reference external" href="https://curl.trillworks.com/">https://curl.trillworks.com/</a> 把 curl 命令参数转成 requests 代码。 <a class="reference external" href="https://github.com/NickCarneiro/curlconverter/">https://github.com/NickCarneiro/curlconverter/</a>。</li>
<li>httpie : 类似 curl 但是参数更加友好的命令行请求工具</li>
<li>httpbin.org 一个使用 flask 编写的 http 调试网站，你可以通过 http 客户端发送请求到该网址验证 http 参数等</li>
<li>curl/requests 互相转化: <a class="reference external" href="https://github.com/oeegor/curlify">https://github.com/oeegor/curlify</a> <a class="reference external" href="https://github.com/spulec/uncurl">https://github.com/spulec/uncurl</a></li>
<li>Violentmonkey: 油猴脚本。有比较多插件 <a class="reference external" href="https://greasyfork.org/zh-CN">https://greasyfork.org/zh-CN</a> 可以搜索使用</li>
</ul>
<p>调试小技巧：使用 chrome 开发者工具右键请求点击copy as curl，然后可以用 uncurl 转成 requests请求调试代码。</p>
</div>
<div class="section" id="id21">
<h5>抓包/网络工具<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>mitmproxy: 用 python 实现的终端命令行http抓包工具，可以将请求直接导出成 curl 请求，python 代码甚至 locust 测试脚本，非常方便，笔者经常用来抓包和调试。</li>
<li>charles: mac下的 http抓包软件(收费)</li>
<li>wireshark: 支持tcp抓包，对于一些使用自有协议的抓包，没法通过 http 请求抓包，可以使用 wireshark。wireshark是学习网络协议的好帮手</li>
<li>termshark: 类似 wireshark 的一个命令行版本的抓包工具 <a class="reference external" href="https://github.com/gcla/termshark">https://github.com/gcla/termshark</a></li>
<li>tcpdump: 服务器命令行抓包工具</li>
<li>netwox: 网络工具集，可以用来创造任意的 TCP、UDP 和 IP 数据报文</li>
</ul>
<p>参考:</p>
<ul class="simple">
<li><a class="reference external" href="http://mrpeak.cn/blog/wireshark/">Wireshark抓包iOS入门教程</a></li>
</ul>
</div>
<div class="section" id="proxy">
<h5>Proxy<a class="headerlink" href="#proxy" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>proxychains-ng/privoxy: 把socks5 转成 http代理</li>
</ul>
</div>
<div class="section" id="id22">
<h5>爬虫相关<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Scrapy: 知名的爬虫框架。生态比较丰富</li>
<li>pyspider: 国人写的一个不错的爬虫框架</li>
<li>requests: 一般小爬虫用 requests 绰绰有余。</li>
<li>lxml/BeautifulSoup/pyquery: 解析 html，xml 等。</li>
<li>tornado: 异步的 http client 可以写爬虫</li>
<li>redis/celery: 实现队列、异步爬虫。异步方案也比较多</li>
<li>phantomjs/puppeteer/playwright-python: 用来处理动态网站。puppeteer 基于 nodejs。可以用来写爬虫，控制浏览器，自动化测试等</li>
<li>pyppeteer/selenium: 基于 python 动态网站爬虫处理，或者用于自动化测试</li>
<li>portia: 类似造数、八爪鱼之类的可视化爬虫 <a class="reference external" href="https://github.com/scrapinghub/portia">https://github.com/scrapinghub/portia</a></li>
</ul>
</div>
<div class="section" id="id23">
<h5>自动化测试<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>uiautomator2: <a class="reference external" href="https://github.com/openatx/uiautomator2">https://github.com/openatx/uiautomator2</a></li>
<li>taobao-iphone-device: <a class="reference external" href="https://github.com/alibaba/taobao-iphone-device">https://github.com/alibaba/taobao-iphone-device</a></li>
</ul>
</div>
<div class="section" id="id24">
<h5>异步任务框架<a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>celery: python 社区一个流行的异步任务框架</li>
<li>machinery: golang 的异步任务框架 <a class="reference external" href="https://github.com/RichardKnop/machinery">https://github.com/RichardKnop/machinery</a></li>
<li>Airflow: 任务调度 <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/1.10.1/index">https://airflow.apache.org/docs/apache-airflow/1.10.1/index</a>.html#</li>
<li>xxl-job: 分布式任务调度平台 <a class="reference external" href="https://github.com/xuxueli/xxl-job/">https://github.com/xuxueli/xxl-job/</a></li>
</ul>
</div>
<div class="section" id="id25">
<h5>端口扫描<a class="headerlink" href="#id25" title="永久链接至标题">¶</a></h5>
<p>ZMap: 是密歇根大学研究人员发布的软件，可以在千兆网络条件下 45 分钟完成全网单端口扫描。支持 TCP SYN 、ICMP、UDP 等多种模式。可以用来搜寻代理</p>
</div>
<div class="section" id="id26">
<h5>后台管理<a class="headerlink" href="#id26" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Ant Design Pro: 基于 react 的后台管理方案，可以用来快速搭建后台运营 or 管理</li>
<li>flask-admin/Django admin: 框架自带的后台管理。flask-admin 也有类似功能</li>
</ul>
</div>
<div class="section" id="rpc">
<h5>RPC<a class="headerlink" href="#rpc" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>thrift: facebook 开源的 rpc 框架，很多大公司在使用</li>
<li>grpc: grpc是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C# 支持. <a class="reference external" href="https://github.com/grpc/grpc">https://github.com/grpc/grpc</a></li>
</ul>
</div>
<div class="section" id="rest">
<h5>Rest<a class="headerlink" href="#rest" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Django Rest Framework(DRF): <a class="reference external" href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a></li>
<li>Flask-Restful: <a class="reference external" href="https://flask-restful.readthedocs.io/">https://flask-restful.readthedocs.io/</a> ，可以用 cookiecutter-flask-restful 快速启动一个 restful 后端项目</li>
<li>fastapi: <a class="reference external" href="https://github.com/tiangolo/fastapi">https://github.com/tiangolo/fastapi</a> python3 异步框架</li>
<li>GRPC: <a class="reference external" href="https://github.com/grpc-ecosystem">https://github.com/grpc-ecosystem</a></li>
<li>Gin: go web 框架</li>
</ul>
</div>
<div class="section" id="id27">
<h5>数据处理和可视化<a class="headerlink" href="#id27" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>pandas: 处理报表经常用，非常适合处理矩阵、DataFrame、excel 等。配合一些前端可视化库可以弄报表啥的。碰到  Excel
处理的强烈建议使用。录了一个小视频讲了下简单的 pands 处理 excel <a class="reference external" href="https://zhuanlan.zhihu.com/p/37654682">https://zhuanlan.zhihu.com/p/37654682</a></li>
<li>matplotlib: python 绘图。数据可视化有很多其他 python 和前端解决方案</li>
</ul>
</div>
<div class="section" id="benchmark">
<h5>压测(benchmark)工具<a class="headerlink" href="#benchmark" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>locust: 基于 python gevent 实现的压测工具。<a class="reference external" href="http://locust.io/">http://locust.io/</a>， 有 web 界面，支持编写 python 脚本模拟测试，高度定制化，推荐。</li>
<li>ab/wrk/siege: 常见的命令行测试工具，用于一些简单的压测</li>
<li>JMeter: 基于 Java 的压测工具</li>
<li>pts: 阿里云提供的一个压测工具。<a class="reference external" href="https://cn.aliyun.com/product/pts">https://cn.aliyun.com/product/pts</a></li>
</ul>
<p>一些 web 框架的压测结果：</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/the-benchmarker/web-frameworks">https://github.com/the-benchmarker/web-frameworks</a></li>
<li><a class="reference external" href="https://www.techempower.com/benchmarks/">https://www.techempower.com/benchmarks/</a></li>
</ul>
</div>
<div class="section" id="profiler">
<h5>Profiler<a class="headerlink" href="#profiler" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>pyflame: <a class="reference external" href="https://github.com/uber/pyflame">https://github.com/uber/pyflame</a></li>
</ul>
</div>
<div class="section" id="apm-application-performance-management">
<h5>APM (Application Performance Management)<a class="headerlink" href="#apm-application-performance-management" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>Zipkin: <a class="reference external" href="https://link.zhihu.com/?target=https%3A//github.com/openzipkin/zipkin">https://link.zhihu.com/?target=https%3A//github.com/openzipkin/zipkin</a></li>
</ul>
<p>参考：<a class="reference external" href="https://www.zhihu.com/question/27994350">https://www.zhihu.com/question/27994350</a></p>
</div>
<div class="section" id="id28">
<h5>数据库工具<a class="headerlink" href="#id28" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>mycli: mysql 命令行补全等。<a class="reference external" href="https://github.com/dbcli/mycli">https://github.com/dbcli/mycli</a></li>
<li>MysqlWorkbench/Sequel Pro: mysql 客户端工具。</li>
<li>Navicat Premium: 强大的数据库管理工具，收费</li>
<li>pt-online-schema-change: mysql数据库变更工具</li>
<li>Medis: redis client 工具</li>
<li>MongoChef: Mongodb 客户端工具</li>
<li>gen: 根据 mysql 生成 golang gorm model。<a class="reference external" href="https://github.com/smallnest/gen">https://github.com/smallnest/gen</a></li>
<li>sqlacodegen: 从 mysql 生成python sqlalchemy model定义。<a class="reference external" href="https://github.com/agronholm/sqlacodegen">https://github.com/agronholm/sqlacodegen</a></li>
</ul>
</div>
<div class="section" id="id29">
<h5>绘图/流程图/思维导图工具<a class="headerlink" href="#id29" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>processon: <a class="reference external" href="http://processon.com/">http://processon.com/</a> 使用了下感觉还不错，支持流程图、时序图、思维导图等，可以 clone 别人看好的图作为模板</li>
<li>亿图：www.edrawmax.cn 类似 processon，有很多好看的模板</li>
<li>Gliffy Diagrams: <a class="reference external" href="https://chrome.google.com/webstore/detail/gliffy-diagrams/bhmicilclplefnflapjmnngmkkkkpfad/related">https://chrome.google.com/webstore/detail/gliffy-diagrams/bhmicilclplefnflapjmnngmkkkkpfad/related</a></li>
<li>draw.io: <a class="reference external" href="https://www.draw.io/">https://www.draw.io/</a></li>
<li>carbon/codeimg.io: <a class="reference external" href="https://carbon.now.sh/">https://carbon.now.sh/</a> 可以根据代码生成图片，在分享代码却没有高亮的时候比较方便。codeimg 类似</li>
</ul>
</div>
<div class="section" id="id30">
<h5>量化投资<a class="headerlink" href="#id30" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>tushare: <a class="reference external" href="https://github.com/waditu/tushare">https://github.com/waditu/tushare</a> 有本小白参考书: <a class="reference external" href="https://wizardforcel.gitbooks.io/python-quant-uqer/">https://wizardforcel.gitbooks.io/python-quant-uqer/</a></li>
</ul>
</div>
<div class="section" id="id31">
<h5>效率，时间管理工具<a class="headerlink" href="#id31" title="永久链接至标题">¶</a></h5>
<p>不像计算机，人脑其实不善于多进程工作（基于脑科学研究），最好一次做好一件事情，如果中间有各种任务穿插，可以用 todolist 工
具记录之后分配轻重缓急统一处理，减少大脑的负荷。</p>
<ul class="simple">
<li>teambiation/trello: todo list 工具，管理任务。今天做了什么；计划做什么；哪些困难导致工作被阻塞(实在搞不定的记下来及时向同事求助)；发现了什么问题；今天学到了什么。(类似于开发日志之类的玩意，每天都是真正做了事情的，并且最好每天都是学到了新东西的)。有时候一些小灵感或者解决问题的思路在没有纸笔的情况下也能迅速记录到工具里，防止遗忘。</li>
<li>番茄工作法：人长期专注的时间是有限的，找到适合自己的最佳番茄钟，并且每个时间段都专注于一件事，每件事分清轻重缓急，要事优先。在休息时间处理喝水、上厕所等杂事，做几个深呼吸给脑瓜子充点氧，或者活动下筋骨，眺望下远处。预防职业病（最近有看到工程师视网膜脱落的，要重视身体健康）。</li>
<li>Be Focused: mac 下番茄工作法工具，可以用来给任务计时，或者提醒该休息下了</li>
<li>复盘。无论是写代码、做需求、改bug等，事后反思总结。分析并且记录耗时的地方和可以改进的地方(怎么让自己涨点记性，整理 checklist)，对于一些错误或者坑也可以记录成文档当做团队的知识财富。</li>
<li>zapier: <a class="reference external" href="https://zapier.com/">https://zapier.com/</a> 一个连接 app 自动化工作流的工具，比如可以用来定期提醒发邮件等，非程序员也能实现定时任务啦</li>
</ul>
</div>
<div class="section" id="id32">
<h5>程序员外设/健康工具<a class="headerlink" href="#id32" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>键盘/鼠标腕垫：长时间使用键盘手腕压力比较大，可以考虑买一个几十块的软垫放在键盘下边托住手腕，减轻手腕压力</li>
<li>主动降噪耳机和纯音乐：选择类似于《阿尔法波高效记忆音乐》《巴洛克学习音乐》等，能帮助你隔绝噪音，或者你可以在youtube/网易云音乐等搜索到很多类似工作或学习音乐(搜优美钢琴曲)。反正笔者听歌的时候会想歌词反而会打扰思路，一般就是听这种不怎么让你瞎想的音乐。降噪耳机如果不差钱可以考虑主动降噪耳机(WI1000X/QC30)，效果好一些，网上也有一些对比视频。对于嘈杂的工作环境来说，绝对是一个非常值得的投资。</li>
<li>人体工学座椅/鼠标/键盘/usb 屏幕挂灯，土豪必备</li>
<li>办公室午休床，隔音耳塞</li>
<li>海露人工泪液/湿房镜/防蓝光镜片/usb热敷眼罩: 缓解干眼症</li>
<li>录音笔。最近裁员有点多，你懂的。笔者用的一款搜狗的录音笔，非常小巧，可以用来记录会议，语音转文字做字幕，实时翻译等。</li>
<li>机械/静电容键盘（键盘可以说是程序员最在意的工具了，推荐几个我个人认为比较适合写代码的，个人推荐红轴，无段落感，打字行云流水)<ul>
<li>HHKB: 码农神器静电容键盘，不过不用 vim，非 linux/unix 用户慎用。没有方向键和F区</li>
<li>宁芝（niz）PLUM普拉姆静电容键盘: 同静电容键盘，键位更多，适合大众用户</li>
<li>阿米洛（Varmilo） 苹果MAC双系统机械键盘: 机械键盘，适合 mac</li>
<li>Poker2: 键位类似 HHKB，同样是可编程迷你键盘，可以替代 HHKB，笔者之前长期使用</li>
<li>Filco Minila Air: 同样是迷你机械键盘，适合大众程序员</li>
</ul>
</li>
</ul>
<p>参考: <a class="reference external" href="https://zhuanlan.zhihu.com/p/89192238">程序员双十一剁手指南</a></p>
</div>
<div class="section" id="vlog">
<h5>视频课程录制(vlog工具)<a class="headerlink" href="#vlog" title="永久链接至标题">¶</a></h5>
<p>在 mac 下录制了一些 vim 和 python 的视频教程(b 站或者知乎可以看到)，记录下使用到的一些硬件和软件工具，硬件工具均可网购，部分软件收费：</p>
<ul class="simple">
<li>keycastr: mac 按键回显到屏幕，最近录制 vim 视频教程的时候有用到。<a class="reference external" href="https://github.com/keycastr/keycastr">https://github.com/keycastr/keycastr</a></li>
<li>youbute-dl: <a class="reference external" href="https://github.com/rg3/youtube-dl">https://github.com/rg3/youtube-dl</a> 命令行油管视频下载工具</li>
<li>aria2: <a class="reference external" href="https://aria2.github.io/">https://aria2.github.io/</a> 轻量级的命令行下载工具</li>
<li>FFmpeg: 强大的视频处理工具，可以用来截图，截取视频片段等</li>
<li>ScreenFlow/Camtasia/Obs: 屏幕录制，剪辑工具，收费。笔者用来录制屏幕用</li>
<li>licecap: 一款小巧的免费 gif 录制工具</li>
<li>TunesKit Video Cutter(mac): 视频分割、合并工具</li>
<li>iZotope RX6: 音频降噪工具，去除杂音、呼吸声等等，收费</li>
<li>Audacity: 音频处理 <a class="reference external" href="https://www.audacityteam.org/download/">https://www.audacityteam.org/download/</a></li>
<li>MediaInfo: 查看视频信息</li>
<li>HandBrake: 视频压缩工具，免费工具。直接从录屏工具导出的视频体积可能会非常大，推荐压缩后上传到网站</li>
<li>SketchBookPro/Deskscribble(收费): 白板/黑板工具，配合 wacom 手写板可以把屏幕当成黑板或者白板使用。模仿可汗学院的授课方式，笔者在讲述 Python 算法的课程里使用到。</li>
<li>Wacom/绘王 手绘板：用来实现屏幕手写，配合绘图或者白板软件当做黑板使用，方便手写做一些演示或者推导。</li>
<li>Blue yeti电容麦/Rode NT usb电容麦/铁三角Atr2100动圈麦：使用 mac 内置麦克风音频效果比较差，可以考虑专业的播客级麦克风，录制出来的视频声音要清楚很多。usb 麦克风即插即用，非常方便，但是灵敏底噪大。动圈麦在嘈杂环境表现更好，不会收录杂音。</li>
<li>VideoScribe: 制作手绘风格视频，提升视频趣味性。收费</li>
<li>课件制作: PowerPoint, Keynote, AxeSlide, Focusky 等。笔者现在喜欢使用 OneNote 配合手写板在视频里进行图解演示。</li>
<li>Mousepose: 鼠标高亮增强工具。演示的时候可以高亮部分区域，其他部分置灰</li>
<li>免费字体：思源字体(思源宋体、思源黑体)；站酷字体。视频中的一些字体可能要考虑版权问题，推荐使用无版权字体</li>
<li>canva: 一个好用的封面设计网站，可以用来设计 vlog/课程 视频封面图 <a class="reference external" href="https://www.canva.com">https://www.canva.com</a></li>
</ul>
</div>
<div class="section" id="html-presentation-tools">
<h5>HTML Presentation Tools<a class="headerlink" href="#html-presentation-tools" title="永久链接至标题">¶</a></h5>
<p>如果觉得用 ppt 做分享比较老套，可以尝试一些使用 HTML 来做 slide show 的工具。或者使用 markdown 生成 html 幻灯片。</p>
<ul class="simple">
<li>reveal-md: 使用 markdown 转成网页 slides。<a class="reference external" href="https://github.com/webpro/reveal-md">https://github.com/webpro/reveal-md</a> 亲测使用起来很方便，依赖 nodejs</li>
<li>reveal.js: The HTML Presentation Framework</li>
<li>RISE: 在 jupyter 里做 slide show，甚至可以直接在网页里运行 Python 代码。 <a class="reference external" href="https://github.com/damianavila/RISE">https://github.com/damianavila/RISE</a></li>
<li>remark: A simple, in-browser, markdown-driven slideshow tool. <a class="reference external" href="https://github.com/gnab/remark">https://github.com/gnab/remark</a></li>
<li>md2googleslides: markdown 转成google slides  <a class="reference external" href="https://github.com/gsuitedevs/md2googleslides">https://github.com/gsuitedevs/md2googleslides</a></li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/PegasusWang/5d00c2e32943f1e3258e964eb64ce4aa">《HTML-presentation-tools.md》</a></li>
<li><a class="reference external" href="https://gist.github.com/johnloy/27dd124ad40e210e91c70dd1c24ac8c8">《markdown-for-slide-decks.md》</a></li>
</ul>
</div>
<div class="section" id="id34">
<h5>思维导图工具<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>coggle.it: 一款免费的在线思维导图工具 <a class="reference external" href="https://coggle.it/">https://coggle.it/</a></li>
<li>GitMind: 在线思维导图工具，可以多人协作 <a class="reference external" href="https://gitmind.cn/">https://gitmind.cn/</a></li>
</ul>
</div>
<div class="section" id="id35">
<h5>电子阅读器/电子书软件<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h5>
<p>笔者使用的 Kindle 和 国产的大屏幕 Boox，目前小米生态的墨案也推出了大屏幕(10.3)寸水墨屏阅读器。
当然你可以使用平板电脑，不过长时间盯着屏幕对眼睛不太好，笔者倾向于使用水墨屏阅读器。</p>
<ul class="simple">
<li>Koreader: <a class="reference external" href="http://koreader.rocks/">http://koreader.rocks/</a> 一款支持多种主流电子书格式的开源电子书阅读器，支持Kindle/Android等</li>
<li>calibre: <a class="reference external" href="https://calibre-ebook.com">https://calibre-ebook.com</a> 跨平台的电子书管理和阅读桌面软件</li>
</ul>
<p>参考：</p>
<ul class="simple">
<li><a class="reference external" href="http://www.dealwithem.com/3457282/">《Kobo Aura One刷机折腾记录：激活、安装koreader、中英字体、字典》</a></li>
</ul>
</div>
<div class="section" id="linux-network-debug-tools">
<h5>Linux network debug Tools<a class="headerlink" href="#linux-network-debug-tools" title="永久链接至标题">¶</a></h5>
<p>注意：dig/nslookup 等直接请求 dns server，会忽略 etc/hosts</p>
<ul>
<li><p class="first">ping/tcping：特定域名的 ip 是否可达。ping send ICMP echo request</p>
<ul class="simple">
<li>ping google.com</li>
<li>ping -c 3 google.com</li>
</ul>
</li>
<li><p class="first">dig/host: get DNS records。用来替代 nslookup</p>
<ul class="simple">
<li>dig google.com 默认返回 A 记录</li>
<li>dig google.com MX</li>
<li>dig -x 8.8.8.8 反向查询</li>
<li>host -a google.com 类似dig</li>
<li>host 8.8.8.8</li>
</ul>
</li>
<li><p class="first">route: shows and manipulate ip routing table</p>
</li>
<li><p class="first">traceroute 诊断网络延迟。诊断到目标路径的设备延迟</p>
<ul class="simple">
<li>traceroute google.com  命令返回的星号指示丢失包</li>
<li>traceroute -n google.com , to avoid reverse dns lookup use -n</li>
<li>traceroute -I google.com, send ICMP packet (default UDP, -T TCP, some servers block UDP)</li>
</ul>
</li>
<li><p class="first">mtr, realtime tracing, 结合了ping,traceroute,nslookup的相关特性</p>
</li>
<li><p class="first">ss(socket statistics), checking connection performance。socket 统计，比netstat快，利用了 tcp_diag</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://www.cnblogs.com/peida/archive/2013/03/11/2953420.html">https://www.cnblogs.com/peida/archive/2013/03/11/2953420.html</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">arp, view the arp table</p>
</li>
<li><p class="first">tcpdump, packet analysis</p>
<ul class="simple">
<li>tcpdump -i &lt;network_device&gt; tcp</li>
<li>tcpdump -i &lt;network_device&gt; port 80</li>
<li>tcpdump -c 20 -i &lt;network_device&gt; port 80 , -c number of events</li>
<li>tcpdump -c 20 -i &lt;network_device&gt; src XXX.XXX.XXX.XXX</li>
<li>ifconfig, you can obtain the device names likes this。查看和配置机器网卡</li>
<li>tcpdump -w /path/ -i &lt;network_device&gt;, tcpdump to a file</li>
<li>tcmpdump -r /path</li>
<li>sudo tcpdump -i lo0 port 6379 -nnX -vvv -A  # 本地 redis 抓包</li>
</ul>
</li>
<li><p class="first">netstat, network statisic,  display connection info, routing table information etc</p>
</li>
<li><p class="first">lsof(查看端口进程): lsof -i:8000</p>
</li>
<li><p class="first">iftop: 查询流量异常的进程</p>
</li>
<li><p class="first">curl: 发送 http 请求，类似的还有一些比如 httpie</p>
</li>
<li><p class="first">nc: 作为tcp|udp服务器,或者作为工具,模拟发送tcp,udp包</p>
</li>
<li><p class="first">trickle: 用户空间带宽控制管理的工具</p>
</li>
<li><p class="first">Nmap: 端口扫描工具</p>
</li>
</ul>
</div>
<div class="section" id="linux-debug-tools">
<h5>Linux debug Tools<a class="headerlink" href="#linux-debug-tools" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>gdb</li>
<li>valgrind</li>
<li>ltrace: tracing system and library calls</li>
<li>strace —— Trace system calls and signals。 跟踪进程的系统调用或信号产生的情况。</li>
<li>lsof: tracking open files</li>
<li>pmap: viewing memory allocation</li>
</ul>
</div>
<div class="section" id="id36">
<h5>参考：<a class="headerlink" href="#id36" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://likegeeks.com/linux-network-commands/">https://likegeeks.com/linux-network-commands/</a></li>
<li><a class="reference external" href="https://unix.stackexchange.com/questions/50098/linux-network-troubleshooting-and-debugging">https://unix.stackexchange.com/questions/50098/linux-network-troubleshooting-and-debugging</a></li>
<li><a class="reference external" href="https://www.tecmint.com/linux-network-configuration-and-troubleshooting-commands/">https://www.tecmint.com/linux-network-configuration-and-troubleshooting-commands/</a></li>
<li><a class="reference external" href="https://github.com/mrzool/unix-as-ide">https://github.com/mrzool/unix-as-ide</a></li>
</ul>
</div>
</div>
<span id="document-idiom/idiom"></span><div class="section" id="write-idiom-python">
<span id="idiom"></span><h4>Write Idiom Python<a class="headerlink" href="#write-idiom-python" title="永久链接至标题">¶</a></h4>
<div class="section" id="python">
<h5>Python支持链式比较<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="c1"># good</span>
<span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h5>Python交换变量<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">x</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tmp</span>

<span class="c1"># good</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h5>Python中替代三目运算符?:<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>
<span class="c1"># good</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="section" id="join">
<h5>拼接字符列表时，用join方法去实现<a class="headerlink" href="#join" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
</pre></div>
</div>
</div>
<div class="section" id="format">
<h5>格式化字符时多使用format函数<a class="headerlink" href="#format" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;tony&quot;</span>
<span class="n">age</span> <span class="o">=</span> <span class="mi">100</span>
<span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;myname : &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; my age : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
<span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;myname : </span><span class="si">%s</span><span class="s2"> my age : </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
<span class="c1"># good</span>
<span class="n">str2</span> <span class="o">=</span> <span class="s2">&quot;myname : </span><span class="si">{}</span><span class="s2"> my age </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="comprehension">
<h5>使用列表或者字典comprehension<a class="headerlink" href="#comprehension" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">mylist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">odd_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">mylist</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">odd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="c1"># good</span>
<span class="n">odd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">mylist</span> <span class="k">if</span> <span class="n">e</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># bad</span>
<span class="n">user_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;lucy&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;lucy@g.com&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;lily&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;lily@g.com&#39;</span><span class="p">}]</span>
<span class="n">user_email</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">user_email</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
<span class="c1"># good</span>
<span class="p">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_list</span> <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="true-false-none">
<h5>条件判断时，避免直接和True, False, None进行比较(==)<a class="headerlink" href="#true-false-none" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="p">[]:</span>
    <span class="k">pass</span>
<span class="c1"># good</span>
<span class="k">if</span> <span class="n">l</span><span class="p">:</span>    <span class="c1"># 实际调用l.__len__() == 0</span>
    <span class="k">pass</span>

<span class="c1"># bad</span>
<span class="k">if</span> <span class="n">something</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
<span class="c1"># good, None 是单例对象</span>
<span class="k">if</span> <span class="n">something</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</pre></div>
</div>
</div>
<div class="section" id="enumerateforindex">
<h5>使用enumerate代替for循环中的index变量访问<a class="headerlink" href="#enumerateforindex" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">my_container</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lily&#39;</span><span class="p">,</span> <span class="s1">&#39;lucy&#39;</span><span class="p">,</span> <span class="s1">&#39;tom&#39;</span><span class="p">]</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">my_container</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># good</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_container</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mutable">
<h5>避免使用可变(mutable)变量作为函数参数的默认初始化值<a class="headerlink" href="#mutable" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="p">[]):</span>
 <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">l</span>

 <span class="nb">print</span> <span class="n">function</span><span class="p">()</span>
 <span class="nb">print</span> <span class="n">function</span><span class="p">()</span>
 <span class="nb">print</span> <span class="n">function</span><span class="p">()</span>

 <span class="c1"># print</span>
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

 <span class="c1"># good 使用None作为可变对象占位符</span>
 <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">l</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5>一切皆对象<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">def</span> <span class="nf">print_addition_table</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_subtraction_table</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_multiplication_table</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_division_table</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">print_addition_table</span><span class="p">()</span>
<span class="n">print_subtraction_table</span><span class="p">()</span>
<span class="n">print_multiplication_table</span><span class="p">()</span>
<span class="n">print_division_table</span><span class="p">()</span>

<span class="c1"># good, python一切都是对象，可以函数作为参数，类似技巧可以用来简化代码</span>
<span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">op</span>

<span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">div</span><span class="p">):</span>
    <span class="n">print_table</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="eafp-vs-lbyl">
<h5>防御式编程EAFP vs LBYL<a class="headerlink" href="#eafp-vs-lbyl" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>EAFP：easier to ask forgiveness than permission</li>
<li>LBYL：look before you leap</li>
</ul>
<p>EAFP可以理解成一切按正常的逻辑编码，不用管可能出现的错误，等出了错误再说；而LBYL就是尽可能每写一行代码，都要提前考虑下当前的前置条件是否成立；</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># LBYL</span>
<span class="k">def</span> <span class="nf">getPersonInfo</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">person</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;person must be not null!&#39;</span>
    <span class="nb">print</span> <span class="n">person</span><span class="o">.</span><span class="n">info</span>

<span class="c1"># EAFP</span>
<span class="k">def</span> <span class="nf">getPersonInfo</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">person</span><span class="o">.</span><span class="n">info</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s1">&#39;person must be not null!&#39;</span>
</pre></div>
</div>
<p>其实用EAFP风格的代码最大的好处是代码逻辑清晰，而LBYL会导致本来两句话说清楚的事，往往因为穿插了很多条件检查的语句使代码逻辑变得混乱。Python社区更提倡EAFP形式的。另外还有一个原因，在高并发场景下， if条件如果是个表达式，会造成一致性问题，这个时候必须用EAFP形式。这个可以参考Glow团队的技术博客[Glow cache structure](<a class="reference external" href="http://tech.glowing.com/cn/glow-cache-structure">http://tech.glowing.com/cn/glow-cache-structure</a>).</p>
</div>
<div class="section" id="dictswitch-case">
<h5>用dict对象完成switch...case...的功能<a class="headerlink" href="#dictswitch-case" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">def</span> <span class="nf">apply_operation</span><span class="p">(</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">right_operand</span><span class="p">,</span> <span class="n">operator</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">left_operand</span> <span class="o">+</span> <span class="n">right_operand</span>
    <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">left_operand</span> <span class="o">-</span> <span class="n">right_operand</span>
    <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">left_operand</span> <span class="o">*</span> <span class="n">right_operand</span>
    <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">left_operand</span> <span class="o">/</span> <span class="n">right_operand</span>
<span class="c1"># good</span>
<span class="k">def</span> <span class="nf">apply_operation</span><span class="p">(</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">right_operand</span><span class="p">,</span> <span class="n">operator</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">op</span>
    <span class="n">operator_mapper</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">op</span><span class="o">.</span><span class="n">truediv</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">operator_mapper</span><span class="p">[</span><span class="n">operator</span><span class="p">](</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">right_operand</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="tuple-namedtupleindex">
<h5>访问tuple的数据项时，可以用namedtuple代替index的方式访问<a class="headerlink" href="#tuple-namedtupleindex" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;lily&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lucy&#39;</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">2500</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">`age is </span><span class="si">{}</span><span class="s1">, salary is </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># good</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span>  <span class="n">namedtuple</span>
<span class="n">Employee</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Employee&#39;</span><span class="p">,</span> <span class="s1">&#39;name, age, salary&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
    <span class="n">employee</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">`age is </span><span class="si">{}</span><span class="s1">, salary is </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">employee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">employee</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">employee</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="isinstance">
<h5>用isinstance来判断对象的类型<a class="headerlink" href="#isinstance" title="永久链接至标题">¶</a></h5>
<p>因为在python中定义变量时，不用像其它静态语言，如java， 要指定其变量数据类型，如int = 4. 但是这并不意味在python中没有数据类型，只是一个变量的数据类型是在运行的时候根据具体的赋值才最终确定。比如下面的代码是计算一个对象的长度值，如果是序列类型（str,list,set,dict）的, 直接调用len方法，如果是True, False, None则返回1，如果是数值的，则返回其int值.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="n">some_object</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_object</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">some_object</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">some_object</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">get_size</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">get_size</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>

<span class="c1"># good</span>
<span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="n">some_object</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_object</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">some_object</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="with">
<h5>用with管理操作资源的上下文环境<a class="headerlink" href="#with" title="永久链接至标题">¶</a></h5>
<p>在一个比较典型的场景里，如数据库操作，我们操作connection时一般要正常关闭连接，而不管是正常退出还是异常退出。如下：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ohoh, exception!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;closed the Connection&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from t_users&#39;</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># good</span>
<span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ohoh, exception!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s1">&#39;closed the Connection&#39;</span>

<span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>

<span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errorType</span><span class="p">,</span> <span class="n">errorValue</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from t_users&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="generator">
<h5>使用generator返回耗费内存的对象<a class="headerlink" href="#generator" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># bad</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">biglist</span>

<span class="c1"># good</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">biglist</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h5>更多资源：<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="http://www.cnblogs.com/jcli/p/3624904.html">《分享书籍[writing idiomatic python ebook]》</a></li>
<li><a class="reference external" href="https://media.readthedocs.org/pdf/python-3-patterns-idioms-test/latest/python-3-patterns-idioms-test.pdf">《Python 3 Patterns, Recipes and Idioms》</a></li>
<li><a class="reference external" href="http://blog.jobbole.com/63320/">《30个有关Python的小技巧》</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/101268/hidden-features-of-python">《Hidden features of Python》</a></li>
<li><a class="reference external" href="http://blog.jobbole.com/68256/">《Python程序员的10个常见错误》</a></li>
<li><a class="reference external" href="http://www.dongwm.com/archives/fen-xiang-%5B%3F%5D-ge-zhun-bei-gei-gong-si-jiang-pythongao-ji-bian-cheng-de-slide/">《Python高级编程slide》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/26312313/">《Effective Python》</a></li>
<li><a class="reference external" href="https://book.douban.com/subject/25910544/">《编写高质量代码：改善Python程序的91个建议》</a></li>
<li><a class="reference external" href="http://python.net/~goodger/projects/pycon/2007/idiomatic/handout.html">《Code Like a Pythonista: Idiomatic Python》</a></li>
<li><a class="reference external" href="http://docs.quantifiedcode.com/python-code-patterns/">《The Little Book of Python Anti-Patterns》</a></li>
</ul>
</div>
</div>
<span id="document-design/design"></span><div class="section" id="python">
<span id="designpatterns"></span><h4>用python实现设计模式<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>Patterns mean &#8220;I have run out of language.&#8221; - Rich Hickey</div></blockquote>
<p>之前学习设计模式的时候总是没有什么感觉，因为记性不好一直没记住多少。python不像java中比较强调设计模式(编程套路)，动态语言也内置了像是装饰器、迭代器等模式，另外python中的『一切皆对象』、鸭子类型等也导致python中实现的设计模式和其他语言有些差别。根据YAGNI(you
aren&#8217;t gonna need it)和KISS(Keep it simple
sutpid)原则，如果能用简单易懂的方式实现，最好不要滥用设计模式以免增加复杂度和维护难度。本博客是《Mastering
Python Design
Patterns》的读书笔记，涵盖大部分设计模式(力求pythonic实现)，有兴趣可以参考下，代码示例版本为python3.5.2。（3.6都发布了，已经被时代遗弃😢......)</p>
<hr class="docutils" />
<div class="section" id="the-fctory-pattern">
<h5>1: The Fctory Pattern(工厂模式: 解决对象创建问题)<a class="headerlink" href="#the-fctory-pattern" title="永久链接至标题">¶</a></h5>
<p>先来看三种创建模式中的第一种工厂模式。
解释：处理对象创建，客户端可以申请一个对象而不用知道对象被哪个class创建。可以方便地解耦对象的使用和创建。有两种实现，工厂方法和抽象工厂.</p>
<div class="section" id="method">
<h6>Method(工厂方法)：<a class="headerlink" href="#method" title="永久链接至标题">¶</a></h6>
<p>执行单独的函数，通过传参提供需要的对象的信息。通过一个demo看看例子:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>import json
import xml.etree.ElementTree as etree

class JSONConnector:
    def __init__(self, filepath):
        self.data = dict()
        with open(filepath, mode=&#39;r&#39;, encoding=&#39;utf8&#39;) as f:
            self.data = json.load(f)

    @property
    def parsed_data(self):
        return self.data


class XMLConnector:
    def __init__(self, filepath):
        self.tree = etree.parse(filepath)

    @property
    def parsed_data(self):
        return self.tree


def connection_factory(filepath):
    &quot;&quot;&quot; 工厂方法 &quot;&quot;&quot;
    if filepath.endswith(&#39;json&#39;):
        connector = JSONConnector
    elif filepath.endswith(&#39;xml&#39;):
        connector = XMLConnector
    else:
        raise ValueError(&#39;Cannot connect to {}&#39;.format(filepath))
    return connector(filepath)
</pre></div>
</div>
</div>
<div class="section" id="abstract-factory">
<h6>Abstract Factory(抽象工厂: 解决复杂对象创建问题)<a class="headerlink" href="#abstract-factory" title="永久链接至标题">¶</a></h6>
<p>工厂方法适合对象种类较少的情况，如果有多种不同类型对象需要创建，使用抽象工厂模式。以实现一个游戏的例子说明，在一个抽象工厂类里实现多个关联对象的创建：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Frog:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return self.name

    def interact_with(self, obstacle):
        &quot;&quot;&quot; 不同类型玩家遇到的障碍不同 &quot;&quot;&quot;
        print(&#39;{} the Frog encounters {} and {}!&#39;.format(
            self, obstacle, obstacle.action()))


class Bug:
    def __str__(self):
        return &#39;a bug&#39;

    def action(self):
        return &#39;eats it&#39;


class FrogWorld:
    def __init__(self, name):
        print(self)
        self.player_name = name

    def __str__(self):
        return &#39;\n\n\t----Frog World -----&#39;

    def make_character(self):
        return Frog(self.player_name)

    def make_obstacle(self):
        return Bug()


class Wizard:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return self.name

    def interact_with(self, obstacle):
        print(&#39;{} the Wizard battles against {} and {}!&#39;.format(
            self, obstacle, obstacle.action()))


class Ork:
    def __str__(self):
        return &#39;an evil ork&#39;

    def action(self):
        return &#39;kill it&#39;


class WizardWorld:
    def __init__(self, name):
        print(self)
        self.player_name = name

    def __str__(self):
        return &#39;\n\n\t------ Wizard World -------&#39;

    def make_character(self):
        return Wizard(self.player_name)

    def make_obstacle(self):
        return Ork()


class GameEnvironment:
    &quot;&quot;&quot; 抽象工厂，根据不同的玩家类型创建不同的角色和障碍 (游戏环境)
    这里可以根据年龄判断，成年人返回『巫师』游戏，小孩返回『青蛙过河』游戏&quot;&quot;&quot;
    def __init__(self, factory):
        self.hero = factory.make_character()
        self.obstacle = factory.make_obstacle()

    def play(self):
        self.hero.interact_with(self.obstacle)
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-builder-pattern">
<h5>2: The Builder Pattern(构造模式: 控制复杂对象的构造)<a class="headerlink" href="#the-builder-pattern" title="永久链接至标题">¶</a></h5>
<p>当对象需要多个部分组合起来一步步创建，并且创建和表示分离的时候。可以这么理解，你要买电脑，工厂模式直接返回一个你需要型号的电脑，但是构造模式允许你自定义电脑各种配置类型，组装完成后给你。这个过程你可以传入builder从而自定义创建的方式。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># factory pattern
MINI14 = &#39;1.4GHz Mac mini&#39;


class AppleFactory:

    class MacMini14:
        def __init__(self):
            self.memory = 4  # in gigabytes
            self.hdd = 500  # in gigabytes
            self.gpu = &#39;Intel HD Graphics 5000&#39;

        def __str__(self):
            info = (&#39;Model: {}&#39;.format(MINI14),
                    &#39;Memory: {}GB&#39;.format(self.memory),
                    &#39;Hard Disk: {}GB&#39;.format(self.hdd),
                    &#39;Graphics Card: {}&#39;.format(self.gpu))
            return &#39;\n&#39;.join(info)

    def build_computer(self, model):
        if model == MINI14:
            return self.MacMini14()
        else:
            print(&quot;I don&#39;t know how to build {}&quot;.format(model))


# 使用工厂
afac = AppleFactory()
mac_mini = afac.build_computer(MINI14)
print(mac_mini)


# builder模式


class Computer:
    def __init__(self, serial_number):
        self.serial = serial_number
        self.memory = None      # in gigabytes
        self.hdd = None         # in gigabytes
        self.gpu = None

    def __str__(self):
        info = (&#39;Memory: {}GB&#39;.format(self.memory),
                &#39;Hard Disk: {}GB&#39;.format(self.hdd),
                &#39;Graphics Card: {}&#39;.format(self.gpu))
        return &#39;\n&#39;.join(info)


class ComputerBuilder:
    def __init__(self):
        self.computer = Computer(&#39;AG23385193&#39;)

    def configure_memory(self, amount):
        self.computer.memory = amount

    def configure_hdd(self, amount):
        self.computer.hdd = amount

    def configure_gpu(self, gpu_model):
        self.computer.gpu = gpu_model


class HardwareEngineer:
    def __init__(self):
        self.builder = None

    def construct_computer(self, memory, hdd, gpu):
        self.builder = ComputerBuilder()
        [step for step in (self.builder.configure_memory(memory),
                        self.builder.configure_hdd(hdd),
                        self.builder.configure_gpu(gpu))]

    @property
    def computer(self):
        return self.builder.computer

# 使用buidler，可以创建多个builder类实现不同的组装方式
engineer = HardwareEngineer()
engineer.construct_computer(hdd=500, memory=8, gpu=&#39;GeForce GTX 650 Ti&#39;)
computer = engineer.computer
print(computer)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-prototype-pattern">
<h5>3:The Prototype Pattern(原型模式:解决对象拷贝问题)<a class="headerlink" href="#the-prototype-pattern" title="永久链接至标题">¶</a></h5>
<p>这是创建模式中的最后一个，用来克隆一个对象，有点像生物学中的有丝分裂。我们可以使用python内置的copy模块实现。拷贝分为深拷贝和浅拷贝，深拷贝会递归复制并创建新对象，而浅拷贝会利用引用指向同一个对象.深拷贝的优点是对象之间互不影响，但是会耗费资源，创建比较耗时；如果不会修改对象可以使用浅拷贝，更加节省资源和创建时间。</p>
<ul class="simple">
<li>&#8220;A shallow copy constructs a new compound object and then (to the
extent possible) inserts references into it to the objects found in
the original.</li>
<li>A deep copy constructs a new compound object and then, recursively,
inserts copies into it of the objects found in the original.&#8221;</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>import copy
from collections import OrderedDict

class Book:
    def __init__(self, name, authors, price, **rest):
        &#39;&#39;&#39;Examples of rest: publisher, length, tags, publication
        date&#39;&#39;&#39;
        self.name = name
        self.authors = authors
        self.price = price      # in US dollars
        self.__dict__.update(rest)

    def __str__(self):
        mylist = []
        ordered = OrderedDict(sorted(self.__dict__.items()))
        for i in ordered.keys():
            mylist.append(&#39;{}: {}&#39;.format(i, ordered[i]))
            if i == &#39;price&#39;:
                mylist.append(&#39;$&#39;)
            mylist.append(&#39;\n&#39;)
        return &#39;&#39;.join(mylist)


class Prototype:
    def __init__(self):
        self.objects = {}

    def register(self, identifier, obj):
        self.objects[identifier] = obj

    def unregister(self, identifier):
        del self.objects[identifier]

    def clone(self, identifier, **attr):
        &quot;&quot;&quot; 实现对象拷贝 &quot;&quot;&quot;
        found = self.objects.get(identifier)
        if not found:
            raise ValueError(&#39;Incorrect object identifier: {}&#39;.format(identifier))
        obj = copy.deepcopy(found)
        obj.__dict__.update(attr)    # 实现拷贝时自定义更新
        return obj


def main():
    b1 = Book(&#39;The C Programming Language&#39;, (&#39;Brian W. Kernighan&#39;, &#39;Dennis M.Ritchie&#39;),
            price=118, publisher=&#39;Prentice Hall&#39;, length=228, publication_date=&#39;1978-02-22&#39;,
            tags=(&#39;C&#39;, &#39;programming&#39;, &#39;algorithms&#39;, &#39;data structures&#39;))

    prototype = Prototype()
    cid = &#39;k&amp;r-first&#39;
    prototype.register(cid, b1)
    b2 = prototype.clone(cid, name=&#39;The C Programming Language (ANSI)&#39;, price=48.99, length=274,
                        publication_date=&#39;1988-04-01&#39;, edition=2)
    for i in (b1, b2):
        print(i)
        print(&quot;ID b1 : {} != ID b2 : {}&quot;.format(id(b1), id(b2)))
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-adapter-pattern">
<h5>4: The Adapter Pattern(适配器模式: 解决接口不兼容问题)<a class="headerlink" href="#the-adapter-pattern" title="永久链接至标题">¶</a></h5>
<p>开始介绍结构型设计模式，结构型设计模式通过组合对象来实现新功能。适配器模式通过引入间接层来实现不兼容接口之间的适配。现实中最好的例子就是手机充电口，不同型号安卓手机都可以用同样的充电线充电。在python中可以通过继承实现适配，也可以通过使用class的__dict__属性。
开闭原则：适配器模式和OOP中的开闭原则关系密切，开闭原则强调对扩展开放，对修改关闭。通过适配器模式我们可以通过创建适配器模式在不修改原有类代码的情况下实现新的功能。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Computer:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return &#39;the {} computer&#39;.format(self.name)

    def execute(self):
        &quot;&quot;&quot; call by client code &quot;&quot;&quot;
        return &#39;execute a program&#39;


class Synthesizer:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return &#39;the {} synthesizer&#39;.format(self.name)

    def play(self):
        return &#39;is playing an electroinc song&#39;


class Human:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return &#39;the {} human&#39;.format(self.name)

    def speak(self):
        return &#39;says hello&#39;


class Adapter:
    def __init__(self, obj, adapted_methods):
        &quot;&quot;&quot; 不使用继承，使用__dict__属性实现适配器模式 &quot;&quot;&quot;
        self.obj = obj
        self.__dict__.update(adapted_methods)

    def __str__(self):
        return str(self.obj)


# 适配器使用示例
def main():
    objs = [Computer(&#39;Asus&#39;)]
    synth = Synthesizer(&#39;moog&#39;)
    objs.append(Adapter(synth, dict(execute=synth.play)))
    human = Human(&#39;Wnn&#39;)
    objs.append(Adapter(human, dict(execute=human.speak)))

    for o in objs:
        # 用统一的execute适配不同对象的方法，这样在无需修改源对象的情况下就实现了不同对象方法的适配
        print(&#39;{} {}&#39;.format(str(o), o.execute()))


if __name__ == &quot;__main__&quot;:
    main()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-decorator-pattern">
<h5>5: The Decorator Pattern(装饰器模式： 无需子类化实现扩展对象功能问题)<a class="headerlink" href="#the-decorator-pattern" title="永久链接至标题">¶</a></h5>
<p>通常给一个对象添加新功能有三种方式： - 直接给对象所属的类添加方法。 -
使用『组合』 - 使用『继承』，优先使用组合而非继承。
装饰器模式提供了第四种选择，通过动态改变对象扩展对象功能。其他编程语言通常使用继承实现装饰器装饰器模式，而python内置了装饰器。装饰器有很多用途，比如数据校验，事务处理，缓存，日志等。比如用装饰器实现一个简单的缓存，python3.5自带了functools.lru_cache</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from functools import wraps

def memoize(fn):
    known = dict()

    @wraps(fn)
    def memoizer(*args):
        if args not in known:
            known[args] = fn(*args)
        return known[args]
    return memoizer


@memoize
def fibonacci(n):
    assert(n &gt;= 0), &#39;n must be &gt;= 0&#39;
    return n if n in (0, 1) else fibonacci(n-1) + fibonacci(n-2)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-facade-pattern">
<h5>6: The Facade Pattern(外观模式: 简化复杂对象的访问问题)<a class="headerlink" href="#the-facade-pattern" title="永久链接至标题">¶</a></h5>
<p>外观模式用来简化复杂系统的访问。通过简化的接口只访问需要的部分，隐藏系统复杂性。想象一下公司接线员，虽然公司内部运行机制比较复杂，但是接线员可以迅速帮你解决特定问题。
我们以实现个简单的操作系统示例说明外观模式：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from abc import ABCMeta, abstractmethod
from enum import Enum

State = Enum(&#39;State&#39;, &#39;new running sleeping restart zombie&#39;)


class Server(metaclass=ABCMeta):
    &quot;&quot;&quot; 抽象基类 &quot;&quot;&quot;
    @abstractmethod
    def __init__(self):
        pass

    def __str__(self):
        return self.name

    @abstractmethod
    def boot(self):
        pass

    @abstractmethod
    def kill(self, restart=True):
        pass


class FileServer(Server):
    def __init__(self):
        &#39;&#39;&#39;actions required for initializing the file server&#39;&#39;&#39;
        self.name = &#39;FileServer&#39;
        self.state = State.new

    def boot(self):
        print(&#39;booting the {}&#39;.format(self))
        &#39;&#39;&#39;actions required for booting the file server&#39;&#39;&#39;
        self.state = State.running

    def kill(self, restart=True):
        print(&#39;Killing {}&#39;.format(self))
        &#39;&#39;&#39;actions required for killing the file server&#39;&#39;&#39;
        self.state = State.restart if restart else State.zombie

    def create_file(self, user, name, permissions):
        &#39;&#39;&#39;check validity of permissions, user rights, etc.&#39;&#39;&#39;
        print(&quot;trying to create the file &#39;{}&#39; for user &#39;{}&#39; with permissions {}&quot;.format(name, user, permissions))

class ProcessServer(Server):
    def __init__(self):
        &#39;&#39;&#39;actions required for initializing the process server&#39;&#39;&#39;
        self.name = &#39;ProcessServer&#39;
        self.state = State.new

    def boot(self):
        print(&#39;booting the {}&#39;.format(self))
        &#39;&#39;&#39;actions required for booting the process server&#39;&#39;&#39;
        self.state = State.running

    def kill(self, restart=True):
        print(&#39;Killing {}&#39;.format(self))
        &#39;&#39;&#39;actions required for killing the process server&#39;&#39;&#39;
        self.state = State.restart if restart else State.zombie

    def create_process(self, user, name):
        &#39;&#39;&#39;check user rights, generate PID, etc.&#39;&#39;&#39;
        print(&quot;trying to create the process &#39;{}&#39; for user &#39;{}&#39;&quot;.format(name, user))


class OperatingSystem:
    &#39;&#39;&#39; 实现外观模式，外部使用的代码不必知道 FileServer 和 ProcessServer的
    内部机制，只需要通过 OperatingSystem类调用&#39;&#39;&#39;
    def __init__(self):
        self.fs = FileServer()
        self.ps = ProcessServer()

    def start(self):
        &quot;&quot;&quot; 被客户端代码使用 &quot;&quot;&quot;
        [i.boot() for i in (self.fs, self.ps)]

    def create_file(self, user, name, permissions):
        return self.fs.create_file(user, name, permissions)

    def create_process(self, user, name):
        return self.ps.create_process(user, name)

def main():
    os = OperatingSystem()
    os.start()
    os.create_file(&#39;foo&#39;, &#39;hello&#39;, &#39;-rw-r-r&#39;)
    os.create_process(&#39;bar&#39;, &#39;ls /tmp&#39;)

main()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-flyweight-pattern">
<h5>7: The Flyweight Pattern(享元模式: 实现对象复用从而改善资源使用)<a class="headerlink" href="#the-flyweight-pattern" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>Flyweight design pattern is a technique used to minimize memory usage and improve performance by introducing data sharing between similar objects.</div></blockquote>
<p>OOP编程中容易出现对象创建带来的性能和内存占用问题，需要满足以下条件：</p>
<ul class="simple">
<li>需要使用大量对象(python里我们可以用__slots__节省内存占用)</li>
<li>对象太多难以存储或解析大量对象。</li>
<li>对象识别不是特别重要，共享对象中对象比较会失败。</li>
</ul>
<p>经常使用对象池技术来实现共享对象，比如数据库中经常使用连接池来减少开销，预先建立一些连接池，每次取一个连接和数据库交互。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># 使用对象池技术实现享元模式
import random
from enum import Enum
TreeType = Enum(&#39;TreeType&#39;, &#39;apple_tree cherry_tree peach_tree&#39;)


class Tree:
    pool = dict()

    def __new__(cls, tree_type):
        obj = cls.pool.get(tree_type, None)
        if obj is None:
            obj = object.__new__(cls)
            cls.pool[tree_type] = obj
            obj.tree_type = tree_type
        return obj

    def render(self, age, x, y):
        print(&#39;render a tree of type {} and age {} at ({}, {})&#39;.format(self.tree_type, age, x, y))


def main():
    rnd = random.Random()
    age_min, age_max = 1, 30    # in years
    min_point, max_point = 0, 100
    tree_counter = 0

    for _ in range(10):
        t1 = Tree(TreeType.apple_tree)
        t1.render(rnd.randint(age_min, age_max),
                rnd.randint(min_point, max_point),
                rnd.randint(min_point, max_point))
        tree_counter += 1

    for _ in range(3):
        t2 = Tree(TreeType.cherry_tree)
        t2.render(rnd.randint(age_min, age_max),
                rnd.randint(min_point, max_point),
                rnd.randint(min_point, max_point))
        tree_counter += 1

    for _ in range(5):
        t3 = Tree(TreeType.peach_tree)
        t3.render(rnd.randint(age_min, age_max),
                rnd.randint(min_point, max_point),
                rnd.randint(min_point, max_point))
        tree_counter += 1
    print(&#39;trees rendered: {}&#39;.format(tree_counter))
    print(&#39;trees actually created: {}&#39;.format(len(Tree.pool)))
    t4 = Tree(TreeType.cherry_tree)
    t5 = Tree(TreeType.cherry_tree)
    t6 = Tree(TreeType.apple_tree)
    print(&#39;{} == {}? {}&#39;.format(id(t4), id(t5), id(t4) == id(t5)))
    print(&#39;{} == {}? {}&#39;.format(id(t5), id(t6), id(t5) == id(t6)))


if __name__ == &#39;__main__&#39;:
    main()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-model-view-controller-pattern-mvc">
<h5>8: The Model-View-Controller Pattern(mvc模式：解耦展示逻辑和业务逻辑)<a class="headerlink" href="#the-model-view-controller-pattern-mvc" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>When using MVC, make sure that you creating smart models (core
functionality), thin controllers (functionality required for the
communication between the view and the controller), and dumb views
(representation and minimal processing).</div></blockquote>
<p>MVC模式既是一种设计模式，也是软件架构模式。比如流行的django框架就是mvc(MTV)模式。Model层负责和数据库交互，View层负责展现逻辑，Controller层负责粘合Model和View层，将各个部分解耦，使代码更易扩展和维护。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>quotes = (&#39;A man is not complete until he is married. Then he is finished.&#39;,
        &#39;As I said before, I never repeat myself.&#39;,
        &#39;Behind a successful man is an exhausted woman.&#39;,
        &#39;Black holes really suck...&#39;, &#39;Facts are stubborn things.&#39;)


class QuoteModel:
    def get_quote(self, n):
        try:
            return quotes[n]
        except IndexError:
            return &#39;Not found&#39;


class QuoteTerminalView:

    def show(self, quote):
        print(&#39;And the quote is: &quot;{}&quot;&#39;.format(quote))

    def error(self, msg):
        print(&#39;Error: {}&#39;.format(msg))

    def select_quote(self):
        return input(&#39;Which quote number would you like to see? &#39;)



class QuoteTerminalController:
    def __init__(self):
        self.model = QuoteModel()
        self.view = QuoteTerminalView()

    def run(self):
        valid_input = False
        while not valid_input:
            n = self.view.select_quote()
            try:
                n = int(n)
            except ValueError:
                self.view.error(&quot;Incorrect index &#39;{}&#39;&quot;.format(n))
            else:
                valid_input = True
                quote = self.model.get_quote(n)
                self.view.show(quote)


def main():
    controller = QuoteTerminalController()
    while True:
        controller.run()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-proxy-pattern">
<h5>9: The Proxy Pattern(代理模式：通过一层间接保护层实现更安全的接口访问）<a class="headerlink" href="#the-proxy-pattern" title="永久链接至标题">¶</a></h5>
<p>在访问真正的对象之前做一些操作。有四种常用的代理类型:</p>
<ul class="simple">
<li>A remote
proxy.使得访问远程对象就像本地访问一样，例如网络服务器。隐藏复杂性，使得访问本地远程统一。比如ORM</li>
<li>A virtual
proxy。用来实现延迟访问，比如一些需要复杂计算的对象，python里可以实现lazy_property，性能改善</li>
<li>A protection/protective proxy.
控制敏感对象的访问，加上一层保护层，实现安全控制</li>
<li>A smart(reference) proxy.
访问对象时加上一层额外操作，例如引用计数和线程安全检查。weakref.proxy()</li>
</ul>
<p>代理模式的功能还是很强大的，先来看看使用描述符实现LazyProperty，在对象创建以后第一次访问才会真正生成</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class LazyProperty:
    &quot;&quot;&quot; 用描述符实现延迟加载的属性 &quot;&quot;&quot;
    def __init__(self, method):
        self.method = method
        self.method_name = method.__name__

    def __get__(self, obj, cls):
        if not obj:
            return None
        value = self.method(obj)
        print(&#39;value {}&#39;.format(value))
        setattr(obj, self.method_name, value)
        return value


class Test:
    def __init__(self):
        self.x = &#39;foo&#39;
        self.y = &#39;bar&#39;
        self._resource = None

    @LazyProperty
    def resource(self):    # 构造函数里没有初始化，第一次访问才会被调用
        print(&#39;initializing self._resource which is: {}&#39;.format(self._resource))
        self._resource = tuple(range(5))    # 模拟一个耗时计算
        return self._resource


def main():
    t = Test()
    print(t.x)
    print(t.y)
    # 访问LazyProperty, resource里的print语句只执行一次，实现了延迟加载和一次执行
    print(t.resource)
    print(t.resource)


main()
</pre></div>
</div>
<p>再看那个用代理实现安全控制的例子，我们给SensitiveInfo里的add操作加上密钥验证，例子也很简单</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class SensitiveInfo:
    def __init__(self):
        self.users = [&#39;nick&#39;, &#39;tom&#39;, &#39;ben&#39;, &#39;mike&#39;]

    def read(self):
        print(&#39;There are {} users: {}&#39;.format(len(self.users), &#39; &#39;.join(self.users)))

    def add(self, user):
        self.users.append(user)
        print(&#39;Added user {}&#39;.format(user))


class Info:
    &#39;&#39;&#39;protection proxy to SensitiveInfo&#39;&#39;&#39;
    def __init__(self):
        self.protected = SensitiveInfo()
        # 为了方便示例这里直接写死在代码里，为了安全不应该这么做
        self.secret = &#39;0xdeadbeef&#39;

    def read(self):
        self.protected.read()

    def add(self, user):
        &quot;&quot;&quot; 给add操作加上密钥验证，保护add操作&quot;&quot;&quot;
        sec = input(&#39;what is the secret? &#39;)
        self.protected.add(user) if sec == self.secret else print(&quot;That&#39;s wrong!&quot;)


def main():
    info = Info()
    while True:
        print(&#39;1. read list |==| 2. add user |==| 3. quit&#39;)
        key = input(&#39;choose option: &#39;)
        if key == &#39;1&#39;:
            info.read()
        elif key == &#39;2&#39;:
            name = input(&#39;choose username: &#39;)
            info.add(name)
        elif key == &#39;3&#39;:
            exit()
        else:
            print(&#39;unknown option: {}&#39;.format(key))
main()
</pre></div>
</div>
<p>上面这个示例有几个缺点 1.
SensitiveInfo可以被直接实例化使用，绕过Info类，可以考虑使用abc模块避免SensitiveInfo被直接实例化
2. 密钥直接写死在代码里，应该用安全性较高密钥写到配置或者环境变量里</p>
<p>我们使用抽象基类来修正第一个缺陷，只需要修正类代码而不用改main函数里的使用代码</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from abc import ABCMeta, abstractmethod


class SensitiveInfo(metaclass=ABCMeta):
    def __init__(self):
        self.users = [&#39;nick&#39;, &#39;tom&#39;, &#39;ben&#39;, &#39;mike&#39;]

    @abstractmethod
    def read(self):
        pass

    @abstractmethod
    def add(self, user):
        pass


class Info(SensitiveInfo):
    &#39;&#39;&#39;protection proxy to SensitiveInfo&#39;&#39;&#39;
    def __init__(self):
        # self.protected = SensitiveInfo()
        super().__init__()
        self.secret = &#39;0xdeadbeef&#39;    # 为了方便示例这里直接写死在代码里

    def read(self):
        print(&#39;There are {} users: {}&#39;.format(len(self.users), &#39; &#39;.join(self.users)))

    def add(self, user):
        &quot;&quot;&quot; 给add操作加上密钥验证，保护add操作&quot;&quot;&quot;
        sec = input(&#39;what is the secret? &#39;)
        self.users.append(user) if sec == self.secret else print(&quot;That&#39;s wrong!&quot;)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-chain-of-responsibility-pattern">
<h5>10: The Chain of Responsibility Pattern (责任链模式:创建链式对象用来接收广播消息)<a class="headerlink" href="#the-chain-of-responsibility-pattern" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>The Chain of Responsibility pattern is used when we want to give a
chance to multiple objects to satisfy a single request, or when we
don&#8217;t know which object (from a chain of objects) should process a
specific request in advance.</div></blockquote>
<p>开始介绍行为型设计模式，行为型设计模式处理对象之间的交互和算法问题。在责任连模式中，我们把消息发送给一系列对象的首个节点，对象可以选择处理消息或者向下一个对象传递,只有对消息感兴趣的节点处理。用来解耦发送者和接收者。在python里通过dynamic
dispatching来实现，以一个事件驱动系统来说明：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Event:
    def __init__(self, name):
        self.name = name

    def __str__(self):
        return self.name


class Widget:

    &quot;&quot;&quot;Docstring for Widget. &quot;&quot;&quot;

    def __init__(self, parent=None):
        self.parent = parent

    def handle(self, event):
        handler = &#39;handle_{}&#39;.format(event)
        if hasattr(self, handler):
            method = getattr(self, handler)
            method(event)
        elif self.parent:
            self.parent.handle(event)
        elif hasattr(self, &#39;handle_default&#39;):
            self.handle_default(event)


class MainWindow(Widget):
    def handle_close(self, event):
        print(&#39;MainWindow: {}&#39;.format(event))

    def handle_default(self, event):
        print(&#39;MainWindow: Default {}&#39;.format(event))


class SendDialog(Widget):
    def handle_paint(self, event):
        print(&#39;SendDialog: {}&#39;.format(event))


class MsgText(Widget):
    def handle_down(self, event):
        print(&#39;MsgText: {}&#39;.format(event))


def main():
    mw = MainWindow()
    sd = SendDialog(mw)    # parent是mw
    msg = MsgText(sd)

    for e in (&#39;down&#39;, &#39;paint&#39;, &#39;unhandled&#39;, &#39;close&#39;):
        evt = Event(e)
        print(&#39;\nSending event -{}- to MainWindow&#39;.format(evt))
        mw.handle(evt)
        print(&#39;Sending event -{}- to SendDialog&#39;.format(evt))
        sd.handle(evt)
        print(&#39;Sending event -{}- to MsgText&#39;.format(evt))
        msg.handle(evt)

if __name__ == &quot;__main__&quot;:
    main()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-command-pattern-undo">
<h5>11: The Command Pattern(命令模式：用来给应用添加Undo操作)<a class="headerlink" href="#the-command-pattern-undo" title="永久链接至标题">¶</a></h5>
<p>命令模式帮助我们把一个操作(undo,redo,copy,paste等)封装成一个对象，通常是创建一个包含Operation所有逻辑和方法的类。
通过命令模式可以控制命令的执行时间和过程，还可以用来组织事务。
用一些文件操作类来说明命令模式的使用</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>import os

class RenameFile:

    def __init__(self, path_src, path_dest):
        &quot;&quot;&quot; 在init里保存一些必要信息，比如undo需要的老的和新的文件名 &quot;&quot;&quot;
        self.src, self.dest = path_src, path_dest

    def execute(self, verbose=False):
        if verbose:
            print(&quot;[renaming &#39;{}&#39; to &#39;{}&#39;]&quot;.format(self.src, self.dest))
        os.rename(self.src, self.dest)

    def undo(self, verbose=False):
        if verbose:
            print(&quot;[renaming &#39;{}&#39; back to &#39;{}&#39;]&quot;.format(self.dest, self.src))
        os.rename(self.dest, self.src)


def delete_file(path, verbose=False):
    if verbose:
        print(&quot;deleting file &#39;{}&quot;.format(path))
    os.remove(path)


class CreateFile:
    def __init__(self, path, txt=&#39;hello world\n&#39;):
        self.path, self.txt = path, txt

    def execute(self, verbose=False):
        if verbose:
            print(&quot;[creating file &#39;{}&#39;]&quot;.format(self.path))
        with open(self.path, mode=&#39;w&#39;, encoding=&#39;utf-8&#39;) as out_file:
            out_file.write(self.txt)

    def undo(self):
        delete_file(self.path)


class ReadFile:
    def __init__(self, path):
        self.path = path

    def execute(self, verbose=False):
        if verbose:
            print(&quot;[reading file &#39;{}&#39;]&quot;.format(self.path))
        with open(self.path, mode=&#39;r&#39;, encoding=&#39;utf-8&#39;) as in_file:
            print(in_file.read(), end=&#39;&#39;)


def main():
    orig_name, new_name = &#39;file1&#39;, &#39;file2&#39;
    commands = []
    for cmd in CreateFile(orig_name), ReadFile(orig_name), RenameFile(orig_name, new_name):
        commands.append(cmd)
    [c.execute() for c in commands]

    answer = input(&#39;reverse the executed commands? [y/n] &#39;)
    if answer not in &#39;yY&#39;:
        print(&quot;the result is {}&quot;.format(new_name))
        exit()
    for c in reversed(commands):
        try:
            c.undo()   # 执行undo
        except AttributeError:
            pass

main()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-interpreter-pattern-domain-specific-language-dsl">
<h5>12: The Interpreter Pattern(解释器模式：用来实现Domain Specific Language(DSL))<a class="headerlink" href="#the-interpreter-pattern-domain-specific-language-dsl" title="永久链接至标题">¶</a></h5>
<p>本章我们实现一个简单的控制大门Gate类的DSL。使用<a class="reference external" href="http://infohost.nmt.edu/tcc/help/pubs/pyparsing/web/index.html">pyparsing</a>来解析我们定义的控制大门的语法命令。
pyparsing自带了很多有用的函数和类帮助我们从文本中抽取需要的信息，比如我们方便地处理c++源文件中的注释:(<code class="xref py py-obj docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pyparsing</span></code>)</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&gt;&gt;&gt; text = &#39;// Look out of the yard? What will we see?&#39;
&gt;&gt;&gt; print pp.cppStyleComment.parseString(text)
[&#39;// Look out of the yard? What will we see?&#39;]
&gt;&gt;&gt; print pp.cppStyleComment.parseString(&#39;/* Author: R. J. Gumby */&#39;)
[&#39;/* Author: R. J. Gumby */&#39;]
</pre></div>
</div>
<p>再比如我们一句话就可以去除C++源码中的注释:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from pyparsing import cppStyleComment
code = &quot;&quot;&quot;
/* Hello World program */

#include&lt;stdio.h&gt;

main()
{
    printf(&quot;Hello World&quot;);    // print hello

}
&quot;&quot;&quot;
print(cppStyleComment.suppress().transformString(code))
</pre></div>
</div>
<p>下面实现我们的控制Gate的DSL</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from pyparsing import Word, OneOrMore, Optional, Group, Suppress, alphanums

class Gate:
    def __init__(self):
        self.is_open = False

    def __str__(self):
        return &#39;open&#39; if self.is_open else &#39;closed&#39;

    def open(self):
        print(&#39;opening the gate&#39;)
        self.is_open = True

    def close(self):
        print(&#39;closing the gate&#39;)
        self.is_open = False


def main():
    # 首先定义我们的DSL格式，我们这里最简单的控制语法就是   &quot;open -&gt; gate&quot;
    word = Word(alphanums)
    command = Group(OneOrMore(word))
    token = Suppress(&quot;-&gt;&quot;)
    device = Group(OneOrMore(word))
    argument = Group(OneOrMore(word))
    event = command + token + device + Optional(token + argument)

    gate = Gate()
    cmds = [&#39;open -&gt; gate&#39;, &#39;close -&gt; gate&#39;]    # 两个自定义的命令
    open_actions = {&#39;gate&#39;: gate.open}
    close_actions = {&#39;gate&#39;: gate.close}

    for cmd in cmds:
        print(event.parseString(cmd))    # [[&#39;open&#39;], [&#39;gate&#39;]]
        cmd, dev = event.parseString(cmd)
        cmd_str, dev_str = &#39; &#39;.join(cmd), &#39; &#39;.join(dev)
        print(cmd_str, dev_str)
        if &#39;open&#39; in cmd_str:
            open_actions[dev_str]()
        elif &#39;close&#39; in cmd_str:
            close_actions[dev_str]()

if __name__ == &quot;__main__&quot;:
    main()
</pre></div>
</div>
<p>这样就实现了一个简单的大门控制语言，不过功能很弱。</p>
</div>
<hr class="docutils" />
<div class="section" id="the-observer-pattern">
<h5>13: The Observer Pattern(发布订阅模式：用来处理多个对象之间的发布订阅问题)<a class="headerlink" href="#the-observer-pattern" title="永久链接至标题">¶</a></h5>
<p>如果用过blinker库或者redis的pub，sub，对发布订阅应该会比较熟悉。该模式用在当一个对象的状态变更需要通知其他很多对象的时候，比如rss订阅或者在社交网站上订阅某个频道的更新。事件驱动系统也是一种发布订阅模式，事件作为发布者，监听器作为订阅者，只不过这里多个事件监听器可以监听同一个事件。
我们这里实现一个&#8221;Data
Formatter&#8221;来解释发布订阅模式，一种数据可以有多个格式化Formatter，当数据更新的时候，会通知所有的Formatter格式化新的数据。使用继承来实现。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Publisher:
    def __init__(self):
        self.observers = []

    def add(self, observer):
        if observer not in self.observers:
            self.observers.append(observer)
        else:
            print(&#39;Failed to add : {}&#39;).format(observer)

    def remove(self, observer):
        try:
            self.observers.remove(observer)
        except ValueError:
            print(&#39;Failed to remove : {}&#39;).format(observer)

    def notify(self):
        [o.notify_by(self) for o in self.observers]


class DefaultFormatter(Publisher):
    def __init__(self, name):
        super().__init__()
        self.name = name
        self._data = 0

    def __str__(self):
        return &quot;{}: &#39;{}&#39; has data = {}&quot;.format(
            type(self).__name__, self.name, self._data)

    @property
    def data(self):
        return self._data

    @data.setter
    def data(self, new_value):
        try:
            self._data = int(new_value)
        except ValueError as e:
            print(&#39;Error: {}&#39;.format(e))
        else:
            self.notify()    # data 在被合法赋值以后会执行notify


class HexFormatter:
    &quot;&quot;&quot; 订阅者 &quot;&quot;&quot;
    def notify_by(self, publisher):
        print(&quot;{}: &#39;{}&#39; has now hex data = {}&quot;.format(
            type(self).__name__, publisher.name, hex(publisher.data)))


class BinaryFormatter:
    &quot;&quot;&quot; 订阅者 &quot;&quot;&quot;
    def notify_by(self, publisher):
        print(&quot;{}: &#39;{}&#39; has now bin data = {}&quot;.format(
            type(self).__name__, publisher.name, bin(publisher.data)))


if __name__ == &quot;__main__&quot;:
    df = DefaultFormatter(&#39;test1&#39;)
    print(df)
    print()
    hf = HexFormatter()
    df.add(hf)
    df.data = 3
    print(df)

    print()
    bf = BinaryFormatter()
    df.add(bf)
    df.data = 21
    print(df)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-state-pattern">
<h5>14: The State Pattern(状态模式：实现有限状态机)<a class="headerlink" href="#the-state-pattern" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>A state machine is an abstract machine that has two key components:
states and transitions. A state is the current (active) status of a
system. A transition is the switch from one state to another. A
state meachine has only one active state at a specific point in the
time.</div></blockquote>
<p>我们通过实现操作系统中进程的生命周期来演示状态模式的使用：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># 先装下pip3 install state_machine
from state_machine import (
    acts_as_state_machine, State, Event, before, after, InvalidStateTransition
)


@acts_as_state_machine
class Process:
    # 先来定义状态机的状态 states
    created = State(initial=True)    # 初始状态
    waiting = State()
    running = State()
    terminated = State()
    blocked = State()
    swapped_out_waiting = State()
    swapped_out_blocked = State()

    # 再定义状态机的转移 transitions
    wait = Event(from_states=(created, running, blocked,
                            swapped_out_waiting), to_state=waiting)
    run = Event(from_states=waiting, to_state=running)
    terminate = Event(from_states=running, to_state=terminated)
    block = Event(from_states=(running, swapped_out_blocked),
                to_state=blocked)
    swap_wait = Event(from_states=waiting, to_state=swapped_out_waiting)
    swap_block = Event(from_states=blocked, to_state=swapped_out_blocked)

    def __init__(self, name):
        self.name = name

    # The state_machine module provides us with the @before and @after
    # decorators that can be used to execute actions before or after a
    # transition occurs, respectfully.
    @after(&#39;wait&#39;)
    def wait_info(self):
        print(&#39;{} entered waiting mode&#39;.format(self.name))

    @after(&#39;run&#39;)
    def run_info(self):
        print(&#39;{} is running&#39;.format(self.name))

    @before(&#39;terminate&#39;)
    def terminate_info(self):
        print(&#39;{} terminated&#39;.format(self.name))

    @after(&#39;block&#39;)
    def block_info(self):
        print(&#39;{} is blocked&#39;.format(self.name))

    @after(&#39;swap_wait&#39;)
    def swap_wait_info(self):
        print(&#39;{} is swapped out and waiting&#39;.format(self.name))

    @after(&#39;swap_block&#39;)
    def swap_block_info(self):
        print(&#39;{} is swapped out and blocked&#39;.format(self.name))


def transition(process, event, event_name):
    &quot;&quot;&quot;
    Args:
        process (Process obj):
        event (Event obj): wait, run, terminate...
        event_name (str): name of event
    &quot;&quot;&quot;
    try:
        event()
    except InvalidStateTransition:
        print(&#39;Error: transition of {} from {} to {} failed&#39;.format(
            process.name, process.current_state, event_name))


def state_info(process):
    &quot;&quot;&quot; 当前状态机的状态 &quot;&quot;&quot;
    print(&#39;state of {}: {}&#39;.format(process.name, process.current_state))

if __name__ == &quot;__main__&quot;:
    RUNNING = &#39;running&#39;
    WAITING = &#39;waiting&#39;
    BLOCKED = &#39;blocked&#39;
    TERMINATED = &#39;terminated&#39;
    p1, p2 = Process(&#39;process1&#39;), Process(&#39;process2&#39;)
    [state_info(p) for p in (p1, p2)]

    print()
    transition(p1, p1.wait, WAITING)
    transition(p2, p2.terminate, TERMINATED)
    [state_info(p) for p in (p1, p2)]
    print()
    transition(p1, p1.run, RUNNING)
    transition(p2, p2.wait, WAITING)
    [state_info(p) for p in (p1, p2)]
    print()
    transition(p2, p2.run, RUNNING)
    [state_info(p) for p in (p1, p2)]
    print()
    [transition(p, p.block, BLOCKED) for p in (p1, p2)]
    [state_info(p) for p in (p1, p2)]
    print()
    [transition(p, p.terminate, TERMINATED) for p in (p1, p2)]
    [state_info(p) for p in (p1, p2)]
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-strategy-pattern">
<h5>15: The Strategy Pattern(策略模式：动态选择算法策略)<a class="headerlink" href="#the-strategy-pattern" title="永久链接至标题">¶</a></h5>
<p>现实中往往解决问题的方式不止一种，我们可能需要根据问题的特征选择最优的实现策略，以排序算法为例子，挑选一个合适的排序算法的时候，需要考虑待排序数组的以下特征：</p>
<ul class="simple">
<li>元素个数。算法输入规模，大部分排序算法在输入规模很小的时候效率相差不大，只有一部分nlogn平均时间复杂度的适合排序大规模。</li>
<li>最好/平均/最坏时间复杂度.这个往往是挑选排序算法时候优先考虑的。</li>
<li>空间复杂度。是不是原地排序(inplace),需要额外的空间吗？在内存限制苛刻的时候就需要考虑</li>
<li>稳定性。排序算法是稳定的吗？稳定是指相同大小的值排序后保持相对顺序。</li>
<li>实现复杂度。算法是否容易实现，其他大致相同的情况下，优先考虑易维护的代码。</li>
</ul>
<p>策略模式允许我们根据待处理数据的特征灵活选用当前特征下最优的实现，比如常见库的排序算法一般都是混合了多种排序算法的实现，python使用的是Tim
Peters在2002年设计的结合了合并排序和插入排序的<a class="reference external" href="https://en.wikipedia.org/wiki/Timsort">Timsort</a>.
函数在python里是一等公民，可以简化策略模式的实现。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def f1(seq):
    pass

def f2(seq):
    pass

def f(seq):
    if len(seq) &gt;= threshold_value:    # 大于某个阈值
        f1(seq)    # 在数量较多时候具有良好的效率
    else:
        f2(seq)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="the-template-pattern">
<h5>16: The Template Pattern(模板模式：抽象出算法公共部分从而实现代码复用)<a class="headerlink" href="#the-template-pattern" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>Don&#8217;t repeat yourself.</div></blockquote>
<p>模板模式中，我们可以把代码中重复的部分抽出来作为一个新的函数，把可变的部分作为函数参数，从而消除代码冗余。实际上这种模式在代码重构的时候是经常使用的 ，使用一个有意思的例子来说明下，请安装<code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">cowpy</span></code>，真有人闲的*疼写这个玩意</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from cowpy import cow


def dots_style(msg):
    msg = msg.capitalize()
    msg = &#39;.&#39; * 10 + msg + &#39;.&#39; * 10
    return msg


def admire_style(msg):
    msg = msg.upper()
    return &#39;!&#39;.join(msg)


def cow_style(msg):
    msg = cow.milk_random_cow(msg)
    return msg


def generate_banner(msg, style=dots_style):
    print(&#39;-- start of banner --&#39;)
    print(style(msg))
    print(&#39;-- end of banner --\n\n&#39;)


def main():
    msg = &#39;happy coding&#39;
    [generate_banner(msg, style) for style in (dots_style, admire_style,
                                            cow_style)]

if __name__ == &quot;__main__&quot;:
    main()


&quot;&quot;&quot;
-- start of banner --
..........Happy coding..........
-- end of banner --


-- start of banner --
H!A!P!P!Y! !C!O!D!I!N!G
-- end of banner --


-- start of banner --
______________
&lt; happy coding &gt;
--------------
    o
    o
    ^__^         /
    (**)\_______/  _________
    (__)\       )=(  ____|_ \_____
U    ||----w |  \ \     \_____ |
        ||     ||   ||           ||
-- end of banner --
&quot;&quot;&quot;
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id1">
<h5>单例模式: 使得一个类最多生成一个实例。<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>Design ptterns are discoverd, not invented. - Alex Martelli</div></blockquote>
<p>很奇怪，本书讲完了都没有讲到单例模式。python的单例模式有各种实现，元类、装饰器等，但是还有一种说法：</p>
<blockquote>
<div>I don&#8217;t really see the need, as a module with functions (and not a
class) would serve well as a singleton. All its variables would be
bound to the module, which could not be instantiated repeatedly
anyway. If you do wish to use a class, there is no way of creating
private classes or private constructors in Python, so you can&#8217;t
protect against multiple instantiations, other than just via
convention in use of your API. I would still just put methods in a
module, and consider the module as the singleton.</div></blockquote>
<p>也就是说，实际上，python中，如果我们只用一个实例，直接这么写就行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># some module.py
class SingletonClass:
    pass

# 在别处我们想用这个实例都直接使用 module.single_instance 这个实例就好。
# 这是最简单也是最直观的一种方式,嗯，直接导入这个实例用，而不是导入class，简单粗暴
single_instance = SingletonClass()
</pre></div>
</div>
<p><a class="reference external" href="http://stackoverflow.com/questions/31875/is-there-a-simple-elegant-way-to-define-singletons-in-python">Is there a simple, elegant way to define singletons in Python?
[closed]</a></p>
<p>其他实现：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># http://stackoverflow.com/questions/6760685/creating-a-singleton-in-python
class BaseClass:
    pass


# 装饰器实现
def singleton(class_):
    instances = {}
    def getinstance(*args, **kwargs):
        if class_ not in instances:
            instances[class_] = class_(*args, **kwargs)
        return instances[class_]
    return getinstance


@singleton
class MyClass(BaseClass):
    pass


class Singleton(object):
    _instance = None
    def __new__(class_, *args, **kwargs):
        if not isinstance(class_._instance, class_):
            class_._instance = object.__new__(class_, *args, **kwargs)
        return class_._instance


class MyClass(Singleton, BaseClass):
pass


# 元类实现
class Singleton(type):
    _instances = {}
    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super(Singleton, cls).__call__(*args, **kwargs)
        return cls._instances[cls]


# Python2
class MyClass(BaseClass):
    __metaclass__ = Singleton

# Python3
class MyClass(BaseClass, metaclass=Singleton):
    pass
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id2">
<h5>面向过程与面向对象<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<p>设计模式讲完了，来看看python中OOP的相关东西。</p>
<ul class="simple">
<li>过程式: 基本都是一个个函数(function)来实现功能，你给我一些参数，我对参数做出各种操作，返回需要的结果。</li>
<li>面向对象：把资源抽象成一个类，数据(data)和方法(method)的集合。在构造函数中进行数据属性的初始化，在方法中进行对象数据的各种操作。实际在python里，一切皆对象。</li>
</ul>
<p>哪种方式更好这个我暂时没有定论，编程规范也不会说强制你使用哪种风格。编码中往往没有绝对正确的，只有相对更优的，如果不好定论，那就一致，易读，易用，易维护的风格优先。一般来说，能用函数实现的优先使用函数，相比类更简单易维护。如果多个过程共享一些状态（操作+数据），这时候使用类就比较适合。使用类的时候尽量保持继承层级简单，如果同样可以完成功能，优先使用组合而非继承。</p>
</div>
<hr class="docutils" />
<div class="section" id="id3">
<h5>python中的抽象基类<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<p>在python中我们可以使用内置的abc(abstract base class)模块来实现抽象基类。什么时候需要一个抽象基类呢？</p>
<ul class="simple">
<li>抽象基类是没法被实例化的。</li>
<li>抽象基类中定义抽象方法强制子类去实现，没有实现抽象方法的子类也无法实例化。</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span># 为了实现这两个特性，我们可以这么写
class Base:
    def foo(self):
        raise NotImplementedError()

    def bar(self):
        raise NotImplementedError()

class Concrete(Base):
    def foo(self):
        return &#39;foo() called&#39;

    # Oh no, we forgot to override bar()...
    # def bar(self):
    #     return &quot;bar() called&quot;
</pre></div>
</div>
<p>但是这么写依然可以实例化Base，python2.6以后引入了abc模块帮助我们实现这个功能。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>from abc import ABCMeta, abstractmethod

class Base(metaclass=ABCMeta):
    @abstractmethod
    def foo(self):
        pass

    @abstractmethod
    def bar(self):
        pass

class Concrete(Base):
    def foo(self):
        pass
    # We forget to declare bar() again...
</pre></div>
</div>
<p>使用这种方式如果没有在子类里实现bar方法你是没有办法实例化子类的。合理使用抽象基类定义明确的接口。另外应该优先使用collections定义的抽象基类，比如要实现一个容器我们可以继承 collections.Container</p>
<ul class="simple">
<li><a class="reference external" href="https://dbader.org/blog/abstract-base-classes-in-python">《Abstract Base Classes in Python》</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/3570796/why-use-abstract-base-classes-in-python">《http://stackoverflow.com/questions/3570796/why-use-abstract-base-classes-in-python》</a></li>
<li><a class="reference external" href="https://docs.python.org/2/library/abc.html">《https://docs.python.org/2/library/abc.html》</a></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="pythonmixin">
<h5>python中的Mixin<a class="headerlink" href="#pythonmixin" title="永久链接至标题">¶</a></h5>
<p>Mixin是为了给一个类扩充功能用的，它也没法被实例化。我们可以在Mixin类里实现一些方法给类扩充功能，合理使用mixin也能避免复杂的继承关系。你可能会问了，那为啥不直接写在类里头，比如用&#64;staticmethod方法(我就有这个疑问)？我的理解是这样的，为了『高内聚』。如果你用过pylint检测代码，你会发现你在写类的一个方法时，如果在写一个method时没有使用到任何self里的东西，pylint会给提示『R0201 Method could be a function [pylint]』，意思是这个方法可以可以单独写成一个函数，不必要写在类里。也就是说，只有一个类里实现的方法都是使用了self里的数据时才能成为高内聚的（我不知道我这样理解对不对）。例子：flask_login插件有个UserMixin给定义的用户类实现登录功能。关于多重继承和 mixin 在 Ruby 之父的书《松本行弘的程序世界》中有不错的科普。</p>
</div>
</div>
<span id="document-algorithms/algorithms"></span><div class="section" id="python">
<span id="algorithms"></span><h4>用python实现基本数据结构和算法<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h4>
<div class="section" id="adt">
<h5>1章：ADT抽象数据类型，定义数据和其操作<a class="headerlink" href="#adt" title="永久链接至标题">¶</a></h5>
<p>什么是ADT: 抽象数据类型，学过数据结构的应该都知道。</p>
<p>How to select datastructures for ADT</p>
<ol class="arabic simple">
<li>Dose the data structure provide for the storage requirements as specified by the domain of the ADT?</li>
<li>Does the data structure provide the data access and manipulation functionality to fully implement the ADT?</li>
<li>Effcient implemention?  based on complexity analysis.</li>
</ol>
<p>下边代码是个简单的示例，比如实现一个简单的Bag类，先定义其具有的操作，然后我们再用类的magic
method来实现这些方法：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Bag:
    &quot;&quot;&quot;
    constructor: 构造函数
    size
    contains
    append
    remove
    iter
    &quot;&quot;&quot;
    def __init__(self):
        self._items = list()

    def __len__(self):
        return len(self._items)

    def __contains__(self, item):
        return item in self._items

    def add(self, item):
        self._items.append(item)

    def remove(self, item):
        assert item in self._items, &#39;item must in the bag&#39;
        return self._items.remove(item)

    def __iter__(self):
        return _BagIterator(self._items)


class _BagIterator:
    &quot;&quot;&quot; 注意这里实现了迭代器类 &quot;&quot;&quot;
    def __init__(self, seq):
        self._bag_items = seq
        self._cur_item = 0

    def __iter__(self):
        return self

    def __next__(self):
        if self._cur_item &lt; len(self._bag_items):
            item = self._bag_items[self._cur_item]
            self._cur_item += 1
            return item
        else:
            raise StopIteration


b = Bag()
b.add(1)
b.add(2)
for i in b:     # for使用__iter__构建，用__next__迭代
    print(i)


&quot;&quot;&quot;
# for 语句等价于
i = b.__iter__()
while True:
    try:
        item = i.__next__()
        print(item)
    except StopIteration:
        break
&quot;&quot;&quot;
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="array-vs-list">
<h5>2章：array vs list<a class="headerlink" href="#array-vs-list" title="永久链接至标题">¶</a></h5>
<div class="section" id="array-python3-5array-import-array">
<h6>array: 定长，操作有限，但是节省内存；貌似我的生涯中还没用过，不过python3.5中我试了确实有array类，可以用import array直接导入<a class="headerlink" href="#array-python3-5array-import-array" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="list-sys-getsizeofc-stlvector">
<h6>list: 会预先分配内存，操作丰富，但是耗费内存。我用sys.getsizeof做了实验。我个人理解很类似C++ STL里的vector，是使用最频繁的数据结构。<a class="headerlink" href="#list-sys-getsizeofc-stlvector" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>list.append:
如果之前没有分配够内存，会重新开辟新区域，然后复制之前的数据，复杂度退化</li>
<li>list.insert: 会移动被插入区域后所有元素,O(n)</li>
<li>list.pop:
pop不同位置需要的复杂度不同pop(0)是O(1)复杂度,pop()首位O(n)复杂度</li>
<li>list[]: slice操作copy数据（预留空间）到另一个list</li>
</ul>
<p>来实现一个array的ADT:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>import ctypes

class Array:
    def __init__(self, size):
        assert size &gt; 0, &#39;array size must be &gt; 0&#39;
        self._size = size
        PyArrayType = ctypes.py_object * size
        self._elements = PyArrayType()
        self.clear(None)

    def __len__(self):
        return self._size

    def __getitem__(self, index):
        assert index &gt;= 0 and index &lt; len(self), &#39;out of range&#39;
        return self._elements[index]

    def __setitem__(self, index, value):
        assert index &gt;= 0 and index &lt; len(self), &#39;out of range&#39;
        self._elements[index] = value

    def clear(self, value):
        &quot;&quot;&quot; 设置每个元素为value &quot;&quot;&quot;
        for i in range(len(self)):
            self._elements[i] = value

    def __iter__(self):
        return _ArrayIterator(self._elements)


class _ArrayIterator:
    def __init__(self, items):
        self._items = items
        self._idx = 0

    def __iter__(self):
        return self

    def __next__(self):
        if self._idex &lt; len(self._items):
            val = self._items[self._idx]
            self._idex += 1
            return val
        else:
            raise StopIteration
</pre></div>
</div>
</div>
<div class="section" id="two-demensional-arrays">
<h6>Two-Demensional Arrays<a class="headerlink" href="#two-demensional-arrays" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Array2D:
    &quot;&quot;&quot; 要实现的方法
    Array2D(nrows, ncols):    constructor
    numRows()
    numCols()
    clear(value)
    getitem(i, j)
    setitem(i, j, val)
    &quot;&quot;&quot;
    def __init__(self, numrows, numcols):
        self._the_rows = Array(numrows)     # 数组的数组
        for i in range(numrows):
            self._the_rows[i] = Array(numcols)

    @property
    def numRows(self):
        return len(self._the_rows)

    @property
    def NumCols(self):
        return len(self._the_rows[0])

    def clear(self, value):
        for row in self._the_rows:
            row.clear(value)

    def __getitem__(self, ndx_tuple):    # ndx_tuple: (x, y)
        assert len(ndx_tuple) == 2
        row, col = ndx_tuple[0], ndx_tuple[1]
        assert (row &gt;= 0 and row &lt; self.numRows and
                col &gt;= 0 and col &lt; self.NumCols)

        the_1d_array = self._the_rows[row]
        return the_1d_array[col]

    def __setitem__(self, ndx_tuple, value):
        assert len(ndx_tuple) == 2
        row, col = ndx_tuple[0], ndx_tuple[1]
        assert (row &gt;= 0 and row &lt; self.numRows and
                col &gt;= 0 and col &lt; self.NumCols)
        the_1d_array = self._the_rows[row]
        the_1d_array[col] = value
</pre></div>
</div>
</div>
<div class="section" id="the-matrix-adt-m-npandas">
<h6>The Matrix ADT, m行，n列。这个最好用还是用pandas处理矩阵，自己实现比较*疼<a class="headerlink" href="#the-matrix-adt-m-npandas" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Matrix:
    &quot;&quot;&quot; 最好用pandas的DataFrame
    Matrix(rows, ncols): constructor
    numCols()
    getitem(row, col)
    setitem(row, col, val)
    scaleBy(scalar): 每个元素乘scalar
    transpose(): 返回transpose转置
    add(rhsMatrix):    size must be the same
    subtract(rhsMatrix)
    multiply(rhsMatrix)
    &quot;&quot;&quot;
    def __init__(self, numRows, numCols):
        self._theGrid = Array2D(numRows, numCols)
        self._theGrid.clear(0)

    @property
    def numRows(self):
        return self._theGrid.numRows

    @property
    def NumCols(self):
        return self._theGrid.numCols

    def __getitem__(self, ndxTuple):
        return self._theGrid[ndxTuple[0], ndxTuple[1]]

    def __setitem__(self, ndxTuple, scalar):
        self._theGrid[ndxTuple[0], ndxTuple[1]] = scalar

    def scaleBy(self, scalar):
        for r in range(self.numRows):
            for c in range(self.numCols):
                self[r, c] *= scalar

    def __add__(self, rhsMatrix):
        assert (rhsMatrix.numRows == self.numRows and
                rhsMatrix.numCols == self.numCols)
        newMartrix = Matrix(self.numRows, self.numCols)
        for r in range(self.numRows):
            for c in range(self.numCols):
                newMartrix[r, c] = self[r, c] + rhsMatrix[r, c]
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="sets-and-maps">
<h5>3章：Sets and Maps<a class="headerlink" href="#sets-and-maps" title="永久链接至标题">¶</a></h5>
<p>除了list之外，最常用的应该就是python内置的set和dict了。</p>
<div class="section" id="sets-adt">
<h6>sets ADT<a class="headerlink" href="#sets-adt" title="永久链接至标题">¶</a></h6>
<p>A set is a container that stores a collection of unique values over a
given comparable domain in which the stored values have no particular
ordering.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Set:
    &quot;&quot;&quot; 使用list实现set ADT
    Set()
    length()
    contains(element)
    add(element)
    remove(element)
    equals(element)
    isSubsetOf(setB)
    union(setB)
    intersect(setB)
    difference(setB)
    iterator()
    &quot;&quot;&quot;
    def __init__(self):
        self._theElements = list()

    def __len__(self):
        return len(self._theElements)

    def __contains__(self, element):
        return element in self._theElements

    def add(self, element):
        if element not in self:
            self._theElements.append(element)

    def remove(self, element):
        assert element in self, &#39;The element must be set&#39;
        self._theElements.remove(element)

    def __eq__(self, setB):
        if len(self) != len(setB):
            return False
        else:
            return self.isSubsetOf(setB)

    def isSubsetOf(self, setB):
        for element in self:
            if element not in setB:
                return False
        return True

    def union(self, setB):
        newSet = Set()
        newSet._theElements.extend(self._theElements)
        for element in setB:
            if element not in self:
                newSet._theElements.append(element)
        return newSet
</pre></div>
</div>
</div>
<div class="section" id="maps-or-dict-pythonhash">
<h6>Maps or Dict: 键值对,python内部采用hash实现。<a class="headerlink" href="#maps-or-dict-pythonhash" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Map:
    &quot;&quot;&quot; Map ADT list implemention
    Map()
    length()
    contains(key)
    add(key, value)
    remove(key)
    valudOf(key)
    iterator()
    &quot;&quot;&quot;
    def __init__(self):
        self._entryList = list()

    def __len__(self):
        return len(self._entryList)

    def __contains__(self, key):
        ndx = self._findPosition(key)
        return ndx is not None

    def add(self, key, value):
        ndx = self._findPosition(key)
        if ndx is not None:
            self._entryList[ndx].value = value
            return False
        else:
            entry = _MapEntry(key, value)
            self._entryList.append(entry)
            return True

    def valueOf(self, key):
        ndx = self._findPosition(key)
        assert ndx is not None, &#39;Invalid map key&#39;
        return self._entryList[ndx].value

    def remove(self, key):
        ndx = self._findPosition(key)
        assert ndx is not None, &#39;Invalid map key&#39;
        self._entryList.pop(ndx)

    def __iter__(self):
        return _MapIterator(self._entryList)

    def _findPosition(self, key):
        for i in range(len(self)):
            if self._entryList[i].key == key:
                return i
        return None


class _MapEntry:    # or use collections.namedtuple(&#39;_MapEntry&#39;, &#39;key,value&#39;)
    def __init__(self, key, value):
        self.key = key
        self.value = value
</pre></div>
</div>
</div>
<div class="section" id="the-multiarray-adt">
<h6>The multiArray ADT, 多维数组，一般是使用一个一维数组模拟，然后通过计算下标获取元素<a class="headerlink" href="#the-multiarray-adt" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>class MultiArray:
    &quot;&quot;&quot; row-major or column-marjor ordering, this is row-major ordering
    MultiArray(d1, d2, ...dn)
    dims():   the number of dimensions
    length(dim): the length of given array dimension
    clear(value)
    getitem(i1, i2, ... in), index(i1,i2,i3) = i1*(d2*d3) + i2*d3 + i3
    setitem(i1, i2, ... in)
    计算下标：index(i1,i2,...in) = i1*f1 + i2*f2 + ... + i(n-1)*f(n-1) + in*1
    &quot;&quot;&quot;
    def __init__(self, *dimensions):
        # Implementation of MultiArray ADT using a 1-D # array,数组的数组的数组。。。
        assert len(dimensions) &gt; 1, &#39;The array must have 2 or more dimensions&#39;
        self._dims = dimensions
        # Compute to total number of elements in the array
        size = 1
        for d in dimensions:
            assert d &gt; 0, &#39;Dimensions must be &gt; 0&#39;
            size *= d
        # Create the 1-D array to store the elements
        self._elements = Array(size)
        # Create a 1-D array to store the equation factors
        self._factors = Array(len(dimensions))
        self._computeFactors()

    @property
    def numDims(self):
        return len(self._dims)

    def length(self, dim):
        assert dim &gt; 0 and dim &lt; len(self._dims), &#39;Dimension component out of range&#39;
        return self._dims[dim-1]

    def clear(self, value):
        self._elements.clear(value)

    def __getitem__(self, ndxTuple):
        assert len(ndxTuple) == self.numDims, &#39;Invalid # of array subscripts&#39;
        index = self._computeIndex(ndxTuple)
        assert index is not None, &#39;Array subscript out of range&#39;
        return self._elements[index]

    def __setitem__(self, ndxTuple, value):
        assert len(ndxTuple) == self.numDims, &#39;Invalid # of array subscripts&#39;
        index = self._computeIndex(ndxTuple)
        assert index is not None, &#39;Array subscript out of range&#39;
        self._elements[index] = value

    def _computeIndex(self, ndxTuple):
        # using the equation: i1*f1 + i2*f2 + ... + in*fn
        offset = 0
        for j in range(len(ndxTuple)):
            if ndxTuple[j] &lt; 0 or ndxTuple[j] &gt;= self._dims[j]:
                return None
            else:
                offset += ndexTuple[j] * self._factors[j]
        return offset
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="algorithm-analysis">
<h5>4章：Algorithm Analysis<a class="headerlink" href="#algorithm-analysis" title="永久链接至标题">¶</a></h5>
<p>一般使用大O标记法来衡量算法的平均时间复杂度, 1 &lt; log(n) &lt; n &lt; nlog(n) &lt;
n^2 &lt; n^3 &lt; a^n。
了解常用数据结构操作的平均时间复杂度有利于使用更高效的数据结构，当然有时候需要在时间和空间上进行衡量，有些操作甚至还会退化，比如list的append操作，如果list空间不够，会去开辟新的空间，操作复杂度退化到O(n)，有时候还需要使用均摊分析(amortized)</p>
</div>
<hr class="docutils" />
<div class="section" id="searching-and-sorting">
<h5>5章：Searching and Sorting<a class="headerlink" href="#searching-and-sorting" title="永久链接至标题">¶</a></h5>
<p>排序和查找是最基础和频繁的操作，python内置了in操作符和bisect二分操作模块实现查找，内置了sorted方法来实现排序操作。二分和快排也是面试中经常考到的，本章讲的是基本的排序和查找。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def binary_search(sorted_seq, val):
    &quot;&quot;&quot; 实现标准库中的bisect.bisect_left &quot;&quot;&quot;
    low = 0
    high = len(sorted_seq) - 1
    while low &lt;= high:
        mid = (high + low) // 2
        if sorted_seq[mid] == val:
            return mid
        elif val &lt; sorted_seq[mid]:
            high = mid - 1
        else:
            low = mid + 1
    return low

  def bubble_sort(seq):  # O(n^2), n(n-1)/2 = 1/2(n^2 + n)
      n = len(seq)
      for i in range(n-1):
          for j in range(n-1-i):    # 这里之所以 n-1 还需要 减去 i 是因为每一轮冒泡最大的元素都会冒泡到最后，无需再比较
              if seq[j] &gt; seq[j+1]:
                  seq[j], seq[j+1] = seq[j+1], seq[j]


def select_sort(seq):
    &quot;&quot;&quot;可以看作是冒泡的改进，每次找一个最小的元素交换，每一轮只需要交换一次&quot;&quot;&quot;
    n = len(seq)
    for i in range(n-1):
        min_idx = i    # assume the ith element is the smallest
        for j in range(i+1, n):
            if seq[j] &lt; seq[min_idx]:   # find the minist element index
                min_idx = j
        if min_idx != i:    # swap
            seq[i], seq[min_idx] = seq[min_idx], seq[i]


def insertion_sort(seq):
    &quot;&quot;&quot; 每次挑选下一个元素插入已经排序的数组中,初始时已排序数组只有一个元素&quot;&quot;&quot;
    n = len(seq)
    for i in range(1, n):
        value = seq[i]    # save the value to be positioned
        # find the position where value fits in the ordered part of the list
        pos = i
        while pos &gt; 0 and value &lt; seq[pos-1]:
            # Shift the items to the right during the search
            seq[pos] = seq[pos-1]
            pos -= 1
        seq[pos] = value


def merge_sorted_list(listA, listB):
    &quot;&quot;&quot; 归并两个有序数组 &quot;&quot;&quot;
    new_list = list()
    a = b = 0
    while a &lt; len(listA) and b &lt; len(listB):
        if listA[a] &lt; listB[b]:
            new_list.append(listA[a])
            a += 1
        else:
            new_list.append(listB[b])
            b += 1

    while a &lt; len(listA):
        new_list.append(listA[a])
        a += 1

    while b &lt; len(listB):
        new_list.append(listB[b])
        b += 1

    return new_list
</pre></div>
</div>
</div>
<div class="section" id="linked-structure">
<h5>6章: Linked Structure<a class="headerlink" href="#linked-structure" title="永久链接至标题">¶</a></h5>
<p>list是最常用的数据结构，但是list在中间增减元素的时候效率会很低，这时候linked
list会更适合，缺点就是获取元素的平均时间复杂度变成了O(n)</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># 单链表实现
class ListNode:
    def __init__(self, data):
        self.data = data
        self.next = None


def travsersal(head, callback):
    curNode = head
    while curNode is not None:
        callback(curNode.data)
        curNode = curNode.next


def unorderdSearch(head, target):
    curNode = head
    while curNode is not None and curNode.data != target:
        curNode = curNode.next
    return curNode is not None


# Given the head pointer, prepend an item to an unsorted linked list.
def prepend(head, item):
    newNode = ListNode(item)
    newNode.next = head
    head = newNode


# Given the head reference, remove a target from a linked list
def remove(head, target):
    predNode = None
    curNode = head
    while curNode is not None and curNode.data != target:
        # 寻找目标
        predNode = curNode
        curNode = curNode.data
    if curNode is not None:
        if curNode is head:
            head = curNode.next
        else:
            predNode.next = curNode.next
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="stacks">
<h5>7章：Stacks<a class="headerlink" href="#stacks" title="永久链接至标题">¶</a></h5>
<p>栈也是计算机里用得比较多的数据结构，栈是一种后进先出的数据结构，可以理解为往一个桶里放盘子，先放进去的会被压在地下，拿盘子的时候，后放的会被先拿出来。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Stack:
    &quot;&quot;&quot; Stack ADT, using a python list
    Stack()
    isEmpty()
    length()
    pop(): assert not empty
    peek(): assert not empty, return top of non-empty stack without removing it
    push(item)
    &quot;&quot;&quot;
    def __init__(self):
        self._items = list()

    def isEmpty(self):
        return len(self) == 0

    def __len__(self):
        return len(self._items)

    def peek(self):
        assert not self.isEmpty()
        return self._items[-1]

    def pop(self):
        assert not self.isEmpty()
        return self._items.pop()

    def push(self, item):
        self._items.append(item)


class Stack:
    &quot;&quot;&quot; Stack ADT, use linked list
    使用list实现很简单，但是如果涉及大量push操作，list的空间不够时复杂度退化到O(n)
    而linked list可以保证最坏情况下仍是O(1)
    &quot;&quot;&quot;
    def __init__(self):
        self._top = None    # top节点, _StackNode or None
        self._size = 0    # int

    def isEmpty(self):
        return self._top is None

    def __len__(self):
        return self._size

    def peek(self):
        assert not self.isEmpty()
        return self._top.item

    def pop(self):
        assert not self.isEmpty()
        node = self._top
        self.top = self._top.next
        self._size -= 1
        return node.item

    def _push(self, item):
        self._top = _StackNode(item, self._top)
        self._size += 1


class _StackNode:
    def __init__(self, item, link):
        self.item = item
        self.next = link
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="queues">
<h5>8章：Queues<a class="headerlink" href="#queues" title="永久链接至标题">¶</a></h5>
<p>队列也是经常使用的数据结构，比如发送消息等，celery可以使用redis提供的list实现消息队列。
本章我们用list和linked list来实现队列和优先级队列。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class Queue:
    &quot;&quot;&quot; Queue ADT, use list。list实现，简单但是push和pop效率最差是O(n)
    Queue()
    isEmpty()
    length()
    enqueue(item)
    dequeue()
    &quot;&quot;&quot;
    def __init__(self):
        self._qList = list()

    def isEmpty(self):
        return len(self) == 0

    def __len__(self):
        return len(self._qList)

    def enquue(self, item):
        self._qList.append(item)

    def dequeue(self):
        assert not self.isEmpty()
        return self._qList.pop(0)


from array import Array    # Array那一章实现的Array ADT
class Queue:
    &quot;&quot;&quot;
    circular Array ，通过头尾指针实现。list内置append和pop复杂度会退化，使用
    环数组实现可以使得入队出队操作时间复杂度为O(1)，缺点是数组长度需要固定。
    &quot;&quot;&quot;
    def __init__(self, maxSize):
        self._count = 0
        self._front = 0
        self._back = maxSize - 1
        self._qArray = Array(maxSize)

    def isEmpty(self):
        return self._count == 0

    def isFull(self):
        return self._count == len(self._qArray)

    def __len__(self):
        return len(self._count)

    def enqueue(self, item):
        assert not self.isFull()
        maxSize = len(self._qArray)
        self._back = (self._back + 1) % maxSize     # 移动尾指针
        self._qArray[self._back] = item
        self._count += 1

    def dequeue(self):
        assert not self.isFull()
        item = self._qArray[self._front]
        maxSize = len(self._qArray)
        self._front = (self._front + 1) % maxSize
        self._count -= 1
        return item

class _QueueNode:
    def __init__(self, item):
        self.item = item


class Queue:
    &quot;&quot;&quot; Queue ADT, linked list 实现。为了改进环型数组有最大数量的限制，改用
    带有头尾节点的linked list实现。
    &quot;&quot;&quot;
    def __init__(self):
        self._qhead = None
        self._qtail = None
        self._qsize = 0

    def isEmpty(self):
        return self._qhead is None

    def __len__(self):
        return self._count

    def enqueue(self, item):
        node = _QueueNode(item)    # 创建新的节点并用尾节点指向他
        if self.isEmpty():
            self._qhead = node
        else:
            self._qtail.next = node
        self._qtail = node
        self._qcount += 1

    def dequeue(self):
        assert not self.isEmpty(), &#39;Can not dequeue from an empty queue&#39;
        node = self._qhead
        if self._qhead is self._qtail:
            self._qtail = None
        self._qhead = self._qhead.next    # 前移头节点
        self._count -= 1
        return node.item


class UnboundedPriorityQueue:
    &quot;&quot;&quot; PriorityQueue ADT: 给每个item加上优先级p，高优先级先dequeue
    分为两种：
    - bounded PriorityQueue: 限制优先级在一个区间[0...p)
    - unbounded PriorityQueue: 不限制优先级

    PriorityQueue()
    BPriorityQueue(numLevels): create a bounded PriorityQueue with priority in range
        [0, numLevels-1]
    isEmpty()
    length()
    enqueue(item, priority): 如果是bounded PriorityQueue, priority必须在区间内
    dequeue(): 最高优先级的出队，同优先级的按照FIFO顺序

    - 两种实现方式：
    1.入队的时候都是到队尾，出队操作找到最高优先级的出队，出队操作O(n)
    2.始终维持队列有序，每次入队都找到该插入的位置，出队操作是O(1)
    (注意如果用list实现list.append和pop操作复杂度会因内存分配退化)
    &quot;&quot;&quot;
    from collections import namedtuple
    _PriorityQEntry = namedtuple(&#39;_PriorityQEntry&#39;, &#39;item, priority&#39;)

    # 采用方式1，用内置list实现unbounded PriorityQueue
    def __init__(self):
        self._qlist = list()

    def isEmpty(self):
        return len(self) == 0

    def __len__(self):
        return len(self._qlist)

    def enqueue(self, item, priority):
        entry = UnboundedPriorityQueue._PriorityQEntry(item, priority)
        self._qlist.append(entry)

    def deque(self):
        assert not self.isEmpty(), &#39;can not deque from an empty queue&#39;
        highest = self._qlist[0].priority
        for i in range(len(self)):    # 出队操作O(n)，遍历找到最高优先级
            if self._qlist[i].priority &lt; highest:
                highest = self._qlist[i].priority
        entry = self._qlist.pop(highest)
        return entry.item


class BoundedPriorityQueue:
    &quot;&quot;&quot; BoundedPriorityQueue ADT，用linked list实现。上一个地方提到了 BoundedPriorityQueue
    但是为什么需要 BoundedPriorityQueue呢？ BoundedPriorityQueue 的优先级限制在[0, maxPriority-1]
    对于 UnboundedPriorityQueue,出队操作由于要遍历寻找优先级最高的item，所以平均
    是O(n)的操作，但是对于 BoundedPriorityQueue，用队列数组实现可以达到常量时间，
    用空间换时间。比如要弹出一个元素，直接找到第一个非空队列弹出 元素就可以了。
    (小数字代表高优先级，先出队)

    qlist
    [0] -&gt; [&quot;white&quot;]
    [1]
    [2] -&gt; [&quot;black&quot;, &quot;green&quot;]
    [3] -&gt; [&quot;purple&quot;, &quot;yellow&quot;]
    &quot;&quot;&quot;
    # Implementation of the bounded Priority Queue ADT using an array of #
    # queues in which the queues are implemented using a linked list.
    from array import Array    #  第二章定义的ADT

    def __init__(self, numLevels):
        self._qSize = 0
        self._qLevels = Array(numLevels)
        for i in range(numLevels):
            self._qLevels[i] = Queue()    # 上一节讲到用linked list实现的Queue

    def isEmpty(self):
        return len(self) == 0

    def __len__(self):
        return len(self._qSize)

    def enqueue(self, item, priority):
        assert priority &gt;= 0 and priority &lt; len(self._qLevels), &#39;invalid priority&#39;
        self._qLevel[priority].enquue(item)    # 直接找到 priority 对应的槽入队

    def deque(self):
        assert not self.isEmpty(), &#39;can not deque from an empty queue&#39;
        i = 0
        p = len(self._qLevels)
        while i &lt; p and not self._qLevels[i].isEmpty():    # 找到第一个非空队列
            i += 1
        return self._qLevels[i].dequeue()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="advanced-linked-lists">
<h5>9章：Advanced Linked Lists<a class="headerlink" href="#advanced-linked-lists" title="永久链接至标题">¶</a></h5>
<p>之前曾经介绍过单链表，一个链表节点只有data和next字段，本章介绍高级的链表。</p>
<p>Doubly Linked
List，双链表，每个节点多了个prev指向前一个节点。双链表可以用来编写文本编辑器的buffer。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class DListNode:
    def __init__(self, data):
        self.data = data
        self.prev = None
        self.next = None


def revTraversa(tail):
    curNode = tail
    while cruNode is not None:
        print(curNode.data)
        curNode = curNode.prev


def search_sorted_doubly_linked_list(head, tail, probe, target):
    &quot;&quot;&quot; probing technique探查法，改进直接遍历，不过最坏时间复杂度仍是O(n)
    searching a sorted doubly linked list using the probing technique
    Args:
        head (DListNode obj)
        tail (DListNode obj)
        probe (DListNode or None)
        target (DListNode.data): data to search
    &quot;&quot;&quot;
    if head is None:    # make sure list is not empty
        return False
    if probe is None:    # if probe is null, initialize it to first node
        probe = head

    # if the target comes before the probe node, we traverse backward, otherwise
    # traverse forward
    if target &lt; probe.data:
        while probe is not None and target &lt;= probe.data:
            if target == probe.dta:
                return True
            else:
                probe = probe.prev
    else:
        while probe is not None and target &gt;= probe.data:
            if target == probe.data:
                return True
            else:
                probe = probe.next
    return False


def insert_node_into_ordered_doubly_linekd_list(value):
    &quot;&quot;&quot; 最好画个图看，链表操作很容易绕晕，注意赋值顺序&quot;&quot;&quot;
    newnode = DListNode(value)

    if head is None:    # empty list
        head = newnode
        tail = head

    elif value &lt; head.data:    # insert before head
        newnode.next = head
        head.prev = newnode
        head = newnode

    elif value &gt; tail.data:    # insert after tail
        newnode.prev = tail
        tail.next = newnode
        tail = newnode

    else:    # insert into middle
        node = head
        while node is not None and node.data &lt; value:
            node = node.next
        newnode.next = node
        newnode.prev = node.prev
        node.prev.next = newnode
        node.prev = newnode
</pre></div>
</div>
<p>循环链表</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def travrseCircularList(listRef):
    curNode = listRef
    done = listRef is None
    while not None:
        curNode = curNode.next
        print(curNode.data)
        done = curNode is listRef   # 回到遍历起始点


def searchCircularList(listRef, target):
    curNode = listRef
    done = listRef is None
    while not done:
        curNode = curNode.next
        if curNode.data == target:
            return True
        else:
            done = curNode is listRef or curNode.data &gt; target
    return False


def add_newnode_into_ordered_circular_linked_list(listRef, value):
    &quot;&quot;&quot; 插入并维持顺序
    1.插入空链表；2.插入头部；3.插入尾部；4.按顺序插入中间
    &quot;&quot;&quot;
    newnode = ListNode(value)
    if listRef is None:    # empty list
        listRef = newnode
        newnode.next = newnode

    elif value &lt; listRef.next.data:    # insert in front
        newnode.next = listRef.next
        listRef.next = newnode

    elif value &gt; listRef.data:    # insert in back
        newnode.next = listRef.next
        listRef.next = newnode
        listRef = newnode

    else:    # insert in the middle
        preNode = None
        curNode = listRef
        done = listRef is None
        while not done:
            preNode = curNode
            preNode = curNode.next
            done = curNode is listRef or curNode.data &gt; value

        newnode.next = curNode
        preNode.next = newnode
</pre></div>
</div>
<p>利用循环双端链表我们可以实现一个经典的缓存失效算法，lru：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># -*- coding: utf-8 -*-

class Node(object):
    def __init__(self, prev=None, next=None, key=None, value=None):
        self.prev, self.next, self.key, self.value = prev, next, key, value


class CircularDoubleLinkedList(object):
    def __init__(self):
        node = Node()
        node.prev, node.next = node, node
        self.rootnode = node

    def headnode(self):
        return self.rootnode.next

    def tailnode(self):
        return self.rootnode.prev

    def remove(self, node):
        if node is self.rootnode:
            return
        else:
            node.prev.next = node.next
            node.next.prev = node.prev

    def append(self, node):
        tailnode = self.tailnode()
        tailnode.next = node
        node.next = self.rootnode
        self.rootnode.prev = node


class LRUCache(object):
    def __init__(self, maxsize=16):
        self.maxsize = maxsize
        self.cache = {}
        self.access = CircularDoubleLinkedList()
        self.isfull = len(self.cache) &gt;= self.maxsize

    def __call__(self, func):
        def wrapper(n):
            cachenode = self.cache.get(n)
            if cachenode is not None:  # hit
                self.access.remove(cachenode)
                self.access.append(cachenode)
                return cachenode.value
            else:  # miss
                value = func(n)
                if not self.isfull:
                    tailnode = self.access.tailnode()
                    newnode = Node(tailnode, self.access.rootnode, n, value)
                    self.access.append(newnode)
                    self.cache[n] = newnode

                    self.isfull = len(self.cache) &gt;= self.maxsize
                    return value
                else:  # full
                    lru_node = self.access.headnode()
                    del self.cache[lru_node.key]
                    self.access.remove(lru_node)
                    tailnode = self.access.tailnode()
                    newnode = Node(tailnode, self.access.rootnode, n, value)
                    self.access.append(newnode)
                    self.cache[n] = newnode
                return value
        return wrapper


@LRUCache()
def fib(n):
    if n &lt;= 2:
        return 1
    else:
        return fib(n - 1) + fib(n - 2)


for i in range(1, 35):
    print(fib(i))
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="recursion">
<h5>10章：Recursion<a class="headerlink" href="#recursion" title="永久链接至标题">¶</a></h5>
<blockquote>
<div>Recursion is a process for solving problems by subdividing a larger
problem into smaller cases of the problem itself and then solving
the smaller, more trivial parts.</div></blockquote>
<p>递归函数：调用自己的函数</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># 递归函数：调用自己的函数，看一个最简单的递归函数，倒序打印一个数
def printRev(n):
    if n &gt; 0:
        print(n)
        printRev(n-1)


printRev(3)    # 从10输出到1


# 稍微改一下，print放在最后就得到了正序打印的函数
def printInOrder(n):
    if n &gt; 0:
        printInOrder(n-1)
        print(n)    # 之所以最小的先打印是因为函数一直递归到n==1时候的最深栈，此时不再
                    # 递归，开始执行print语句，这时候n==1，之后每跳出一层栈，打印更大的值

printInOrder(3)    # 正序输出
</pre></div>
</div>
<p>Properties of Recursion: 使用stack解决的问题都能用递归解决</p>
<ul class="simple">
<li>A recursive solution must contain a base case; 递归出口，代表最小子问题(n == 0退出打印)</li>
<li>A recursive solution must contain a recursive case; 可以分解的子问题</li>
<li>A recursive solution must make progress toward the base case. 递减n使得n像递归出口靠近</li>
</ul>
<p>Tail Recursion: occurs when a function includes a single recursive call
as the last statement of the function. In this case, a stack is not
needed to store values to te used upon the return of the recursive call
and thus a solution can be implemented using a iterative loop instead.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># Recursive Binary Search

def recBinarySearch(target, theSeq, first, last):
    # 你可以写写单元测试来验证这个函数的正确性
    if first &gt; last:    # 递归出口1
        return False
    else:
        mid = (first + last) // 2
        if theSeq[mid] == target:
            return True    # 递归出口2
        elif theSeq[mid] &gt; target:
            return recBinarySearch(target, theSeq, first, mid - 1)
        else:
            return recBinarySearch(target, theSeq, mid + 1, last)
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="hash-tables">
<h5>11章：Hash Tables<a class="headerlink" href="#hash-tables" title="永久链接至标题">¶</a></h5>
<p>基于比较的搜索（线性搜索，有序数组的二分搜索）最好的时间复杂度只能达到O(logn)，利用hash可以实现O(1)查找，python内置dict的实现方式就是hash，你会发现dict的key必须要是实现了 <code class="xref py py-obj docutils literal"><span class="pre">__hash__</span></code> 和 <code class="xref py py-obj docutils literal"><span class="pre">__eq__</span></code> 方法的。</p>
<p>Hashing: hashing is the process of mapping a search a key to a limited
range of array indeices with the goal of providing direct access to the
keys.</p>
<p>hash方法有个hash函数用来给key计算一个hash值，作为数组下标，放到该下标对应的槽中。当不同key根据hash函数计算得到的下标相同时，就出现了冲突。解决冲突有很多方式，比如让每个槽成为链表，每次冲突以后放到该槽链表的尾部，但是查询时间就会退化，不再是O(1)。还有一种探查方式，当key的槽冲突时候，就会根据一种计算方式去寻找下一个空的槽存放，探查方式有线性探查，二次方探查法等，cpython解释器使用的是二次方探查法。还有一个问题就是当python使用的槽数量大于预分配的2/3时候，会重新分配内存并拷贝以前的数据，所以有时候dict的add操作代价还是比较高的，牺牲空间但是可以始终保证O(1)的查询效率。如果有大量的数据，建议还是使用bloomfilter或者redis提供的HyperLogLog。</p>
<p>如果你感兴趣，可以看看这篇文章，介绍c解释器如何实现的python
dict对象：<a class="reference external" href="http://www.laurentluce.com/posts/python-dictionary-implementation/">Python dictionary
implementation</a>。我们使用Python来实现一个类似的hash结构。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>import ctypes

class Array:  # 第二章曾经定义过的ADT，这里当做HashMap的槽数组使用
    def __init__(self, size):
        assert size &gt; 0, &#39;array size must be &gt; 0&#39;
        self._size = size
        PyArrayType = ctypes.py_object * size
        self._elements = PyArrayType()
        self.clear(None)

    def __len__(self):
        return self._size

    def __getitem__(self, index):
        assert index &gt;= 0 and index &lt; len(self), &#39;out of range&#39;
        return self._elements[index]

    def __setitem__(self, index, value):
        assert index &gt;= 0 and index &lt; len(self), &#39;out of range&#39;
        self._elements[index] = value

    def clear(self, value):
        &quot;&quot;&quot; 设置每个元素为value &quot;&quot;&quot;
        for i in range(len(self)):
            self._elements[i] = value

    def __iter__(self):
        return _ArrayIterator(self._elements)


class _ArrayIterator:
    def __init__(self, items):
        self._items = items
        self._idx = 0

    def __iter__(self):
        return self

    def __next__(self):
        if self._idx &lt; len(self._items):
            val = self._items[self._idx]
            self._idx += 1
            return val
        else:
            raise StopIteration


class HashMap:
    &quot;&quot;&quot; HashMap ADT实现，类似于python内置的dict
    一个槽有三种状态：
    1.从未使用 HashMap.UNUSED。此槽没有被使用和冲突过，查找时只要找到UNUSEd就不用再继续探查了
    2.使用过但是remove了，此时是 HashMap.EMPTY，该探查点后边的元素扔可能是有key
    3.槽正在使用 _MapEntry节点
    &quot;&quot;&quot;

    class _MapEntry:    # 槽里存储的数据
        def __init__(self, key, value):
            self.key = key
            self.value = value

    UNUSED = None    # 没被使用过的槽，作为该类变量的一个单例，下边都是is 判断
    EMPTY = _MapEntry(None, None)     # 使用过但是被删除的槽

    def __init__(self):
        self._table = Array(7)    # 初始化7个槽
        self._count = 0
        # 超过2/3空间被使用就重新分配，load factor = 2/3
        self._maxCount = len(self._table) - len(self._table) // 3

    def __len__(self):
        return self._count

    def __contains__(self, key):
        slot = self._findSlot(key, False)
        return slot is not None

    def add(self, key, value):
        if key in self:    # 覆盖原有value
            slot = self._findSlot(key, False)
            self._table[slot].value = value
            return False
        else:
            slot = self._findSlot(key, True)
            self._table[slot] = HashMap._MapEntry(key, value)
            self._count += 1
            if self._count == self._maxCount:    # 超过2/3使用就rehash
                self._rehash()
            return True

    def valueOf(self, key):
        slot = self._findSlot(key, False)
        assert slot is not None, &#39;Invalid map key&#39;
        return self._table[slot].value

    def remove(self, key):
        &quot;&quot;&quot; remove操作把槽置为EMPTY&quot;&quot;&quot;
        assert key in self, &#39;Key error %s&#39; % key
        slot = self._findSlot(key, forInsert=False)
        value = self._table[slot].value
        self._count -= 1
        self._table[slot] = HashMap.EMPTY
        return value

    def __iter__(self):
        return _HashMapIteraotr(self._table)

    def _slot_can_insert(self, slot):
        return (self._table[slot] is HashMap.EMPTY or
                self._table[slot] is HashMap.UNUSED)

    def _findSlot(self, key, forInsert=False):
        &quot;&quot;&quot; 注意原书有错误，代码根本不能运行，这里我自己改写的
        Args:
            forInsert (bool): if the search is for an insertion
        Returns:
            slot or None
        &quot;&quot;&quot;
        slot = self._hash1(key)
        step = self._hash2(key)
        _len = len(self._table)

        if not forInsert:    # 查找是否存在key
            while self._table[slot] is not HashMap.UNUSED:
                # 如果一个槽是UNUSED，直接跳出
                if self._table[slot] is HashMap.EMPTY:
                    slot = (slot + step) % _len
                    continue
                elif self._table[slot].key == key:
                    return slot
                slot = (slot + step) % _len
            return None

        else:    # 为了插入key
            while not self._slot_can_insert(slot):    # 循环直到找到一个可以插入的槽
                slot = (slot + step) % _len
            return slot

    def _rehash(self):    # 当前使用槽数量大于2/3时候重新创建新的table
        origTable = self._table
        newSize = len(self._table) * 2 + 1    # 原来的2*n+1倍
        self._table = Array(newSize)

        self._count = 0
        self._maxCount = newSize - newSize // 3

        # 将原来的key value添加到新的table
        for entry in origTable:
            if entry is not HashMap.UNUSED and entry is not HashMap.EMPTY:
                slot = self._findSlot(entry.key, True)
                self._table[slot] = entry
                self._count += 1

    def _hash1(self, key):
        &quot;&quot;&quot; 计算key的hash值&quot;&quot;&quot;
        return abs(hash(key)) % len(self._table)

    def _hash2(self, key):
        &quot;&quot;&quot; key冲突时候用来计算新槽的位置&quot;&quot;&quot;
        return 1 + abs(hash(key)) % (len(self._table)-2)


class _HashMapIteraotr:
    def __init__(self, array):
        self._array = array
        self._idx = 0

    def __iter__(self):
        return self

    def __next__(self):
        if self._idx &lt; len(self._array):
            if self._array[self._idx] is not None and self._array[self._idx].key is not None:
                key = self._array[self._idx].key
                self._idx += 1
                return key
            else:
                self._idx += 1
        else:
            raise StopIteration


def print_h(h):
    for idx, i in enumerate(h):
        print(idx, i)
    print(&#39;\n&#39;)


def test_HashMap():
    &quot;&quot;&quot; 一些简单的单元测试，不过测试用例覆盖不是很全面 &quot;&quot;&quot;
    h = HashMap()
    assert len(h) == 0
    h.add(&#39;a&#39;, &#39;a&#39;)
    assert h.valueOf(&#39;a&#39;) == &#39;a&#39;
    assert len(h) == 1

    a_v = h.remove(&#39;a&#39;)
    assert a_v == &#39;a&#39;
    assert len(h) == 0

    h.add(&#39;a&#39;, &#39;a&#39;)
    h.add(&#39;b&#39;, &#39;b&#39;)
    assert len(h) == 2
    assert h.valueOf(&#39;b&#39;) == &#39;b&#39;
    b_v = h.remove(&#39;b&#39;)
    assert b_v == &#39;b&#39;
    assert len(h) == 1
    h.remove(&#39;a&#39;)
    assert len(h) == 0

    n = 10
    for i in range(n):
        h.add(str(i), i)
    assert len(h) == n
    print_h(h)
    for i in range(n):
        assert str(i) in h
    for i in range(n):
        h.remove(str(i))
    assert len(h) == 0
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="advanced-sorting">
<h5>12章: Advanced Sorting<a class="headerlink" href="#advanced-sorting" title="永久链接至标题">¶</a></h5>
<p>第5章介绍了基本的排序算法，本章介绍高级排序算法。</p>
<p>归并排序(mergesort): 分治法</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def merge_sorted_list(listA, listB):
    &quot;&quot;&quot; 归并两个有序数组，O(max(m, n)) ,m和n是数组长度&quot;&quot;&quot;
    print(&#39;merge left right list&#39;, listA, listB, end=&#39;&#39;)
    new_list = list()
    a = b = 0
    while a &lt; len(listA) and b &lt; len(listB):
        if listA[a] &lt; listB[b]:
            new_list.append(listA[a])
            a += 1
        else:
            new_list.append(listB[b])
            b += 1

    while a &lt; len(listA):
        new_list.append(listA[a])
        a += 1

    while b &lt; len(listB):
        new_list.append(listB[b])
        b += 1

    print(&#39; -&gt;&#39;, new_list)
    return new_list


def mergesort(theList):
    &quot;&quot;&quot; O(nlogn)，log层调用，每层n次操作
    mergesort: divided and conquer 分治
    1. 把原数组分解成越来越小的子数组
    2. 合并子数组来创建一个有序数组
    &quot;&quot;&quot;
    print(theList)    # 我把关键步骤打出来了，你可以运行下看看整个过程
    if len(theList) &lt;= 1:    # 递归出口
        return theList
    else:
        mid = len(theList) // 2

        # 递归分解左右两边数组
        left_half = mergesort(theList[:mid])
        right_half = mergesort(theList[mid:])

        # 合并两边的有序子数组
        newList = merge_sorted_list(left_half, right_half)
        return newList

&quot;&quot;&quot; 这是我调用一次打出来的排序过程
[10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
[10, 9, 8, 7, 6]
[10, 9]
[10]
[9]
merge left right list [10] [9] -&gt; [9, 10]
[8, 7, 6]
[8]
[7, 6]
[7]
[6]
merge left right list [7] [6] -&gt; [6, 7]
merge left right list [8] [6, 7] -&gt; [6, 7, 8]
merge left right list [9, 10] [6, 7, 8] -&gt; [6, 7, 8, 9, 10]
[5, 4, 3, 2, 1]
[5, 4]
[5]
[4]
merge left right list [5] [4] -&gt; [4, 5]
[3, 2, 1]
[3]
[2, 1]
[2]
[1]
merge left right list [2] [1] -&gt; [1, 2]
merge left right list [3] [1, 2] -&gt; [1, 2, 3]
merge left right list [4, 5] [1, 2, 3] -&gt; [1, 2, 3, 4, 5]
&quot;&quot;&quot;
</pre></div>
</div>
<p>快速排序</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def quicksort(theSeq, first, last):    # average: O(nlog(n))
    &quot;&quot;&quot;
    quicksort :也是分而治之，但是和归并排序不同的是，采用选定主元（pivot）而不是从中间
    进行数组划分
    1. 第一步选定pivot用来划分数组，pivot左边元素都比它小，右边元素都大于等于它
    2. 对划分的左右两边数组递归，直到递归出口（数组元素数目小于2）
    3. 对pivot和左右划分的数组合并成一个有序数组
    &quot;&quot;&quot;
    if first &lt; last:
        pos = partitionSeq(theSeq, first, last)
        # 对划分的子数组递归操作
        quicksort(theSeq, first, pos - 1)
        quicksort(theSeq, pos + 1, last)


def partitionSeq(theSeq, first, last):
    &quot;&quot;&quot; 快排中的划分操作，把比pivot小的挪到左边，比pivot大的挪到右边&quot;&quot;&quot;
    pivot = theSeq[first]
    print(&#39;before partitionSeq&#39;, theSeq)

    left = first + 1
    right = last

    while True:
        # 找到第一个比pivot大的
        while left &lt;= right and theSeq[left] &lt; pivot:
            left += 1

        # 从右边开始找到比pivot小的
        while right &gt;= left and theSeq[right] &gt;= pivot:
            right -= 1

        if right &lt; left:
            break
        else:
            theSeq[left], theSeq[right] = theSeq[right], theSeq[left]

    # 把pivot放到合适的位置
    theSeq[first], theSeq[right] = theSeq[right], theSeq[first]

    print(&#39;after partitionSeq {}: {}\t&#39;.format(theSeq, pivot))
    return right    # 返回pivot的位置


def test_partitionSeq():
    l = [0,1,2,3,4]
    assert partitionSeq(l, 0, len(l)-1) == 0
    l = [4,3,2,1,0]
    assert partitionSeq(l, 0, len(l)-1) == 4
    l = [2,3,0,1,4]
    assert partitionSeq(l, 0, len(l)-1) == 2

test_partitionSeq()


def test_quicksort():
    def _is_sorted(seq):
        for i in range(len(seq)-1):
            if seq[i] &gt; seq[i+1]:
                return False
        return True

    from random import randint
    for i in range(100):
        _len = randint(1, 100)
        to_sort = []
        for i in range(_len):
            to_sort.append(randint(0, 100))
        quicksort(to_sort, 0, len(to_sort)-1)    # 注意这里用了原地排序，直接更改了数组
        print(to_sort)
        assert _is_sorted(to_sort)

test_quicksort()
</pre></div>
</div>
<p>利用快排中的partitionSeq操作，我们还能实现另一个算法，nth_element，快速查找一个无序数组中的第k大元素</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>def nth_element(seq, beg, end, k):
    if beg == end:
        return seq[beg]
    pivot_index = partitionSeq(seq, beg, end)
    if pivot_index == k:
        return seq[k]
    elif pivot_index &gt; k:
        return nth_element(seq, beg, pivot_index-1, k)
    else:
        return nth_element(seq, pivot_index+1, end, k)

def test_nth_element():
    from random import shuffle
    n = 10
    l = list(range(n))
    shuffle(l)
    print(l)
    for i in range(len(l)):
        assert nth_element(l, 0, len(l)-1, i) == i

test_nth_element()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="binary-tree">
<h5>13章: Binary Tree<a class="headerlink" href="#binary-tree" title="永久链接至标题">¶</a></h5>
<p>The binary Tree: 二叉树，每个节点做多只有两个子节点</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class _BinTreeNode:
    def __init__(self, data):
        self.data = data
        self.left = None
        self.right = None


# 三种depth-first遍历
def preorderTrav(subtree):
    &quot;&quot;&quot; 先（根）序遍历&quot;&quot;&quot;
    if subtree is not None:
        print(subtree.data)
        preorderTrav(subtree.left)
        preorderTrav(subtree.right)


def inorderTrav(subtree):
    &quot;&quot;&quot; 中(根)序遍历&quot;&quot;&quot;
    if subtree is not None:
        preorderTrav(subtree.left)
        print(subtree.data)
        preorderTrav(subtree.right)


def postorderTrav(subtree):
    &quot;&quot;&quot; 后（根）序遍历&quot;&quot;&quot;
    if subtree is not None:
        preorderTrav(subtree.left)
        preorderTrav(subtree.right)
        print(subtree.data)


# 宽度优先遍历(bradth-First Traversal): 一层一层遍历, 使用queue
def breadthFirstTrav(bintree):
    from queue import Queue    # py3
    q = Queue()
    q.put(bintree)
    while not q.empty():
        node = q.get()
        print(node.data)
        if node.left is not None:
            q.put(node.left)
        if node.right is not None:
            q.put(node.right)


class _ExpTreeNode:
    __slots__ = (&#39;element&#39;, &#39;left&#39;, &#39;right&#39;)

    def __init__(self, data):
        self.element = data
        self.left = None
        self.right = None

    def __repr__(self):
        return &#39;&lt;_ExpTreeNode: {} {} {}&gt;&#39;.format(
            self.element, self.left, self.right)

from queue import Queue
class ExpressionTree:
    &quot;&quot;&quot;
    表达式树: 操作符存储在内节点操作数存储在叶子节点的二叉树。(符号树真难打出来)
        *
       / \
      +   -
     / \  / \
     9  3 8   4
    (9+3) * (8-4)

    Expression Tree Abstract Data Type，可以实现二元操作符
    ExpressionTree(expStr): user string as constructor param
    evaluate(varDict): evaluates the expression and returns the numeric result
    toString(): constructs and retutns a string represention of the expression

    Usage:
        vars = {&#39;a&#39;: 5, &#39;b&#39;: 12}
        expTree = ExpressionTree(&quot;(a/(b-3))&quot;)
        print(&#39;The result = &#39;, expTree.evaluate(vars))
    &quot;&quot;&quot;

    def __init__(self, expStr):
        self._expTree = None
        self._buildTree(expStr)

    def evaluate(self, varDict):
        return self._evalTree(self._expTree, varDict)

    def __str__(self):
        return self._buildString(self._expTree)

    def _buildString(self, treeNode):
        &quot;&quot;&quot; 在一个子树被遍历之前添加做括号，在子树被遍历之后添加右括号 &quot;&quot;&quot;
        # print(treeNode)
        if treeNode.left is None and treeNode.right is None:
            return str(treeNode.element)    # 叶子节点是操作数直接返回
        else:
            expStr = &#39;(&#39;
            expStr += self._buildString(treeNode.left)
            expStr += str(treeNode.element)
            expStr += self._buildString(treeNode.right)
            expStr += &#39;)&#39;
            return expStr

    def _evalTree(self, subtree, varDict):
        # 是不是叶子节点, 是的话说明是操作数，直接返回
        if subtree.left is None and subtree.right is None:
            # 操作数是合法数字吗
            if subtree.element &gt;= &#39;0&#39; and subtree.element &lt;= &#39;9&#39;:
                return int(subtree.element)
            else:    # 操作数是个变量
                assert subtree.element in varDict, &#39;invalid variable.&#39;
                return varDict[subtree.element]
        else:    # 操作符则计算其子表达式
            lvalue = self._evalTree(subtree.left, varDict)
            rvalue = self._evalTree(subtree.right, varDict)
            print(subtree.element)
            return self._computeOp(lvalue, subtree.element, rvalue)

    def _computeOp(self, left, op, right):
        assert op
        op_func = {
            &#39;+&#39;: lambda left, right: left + right,    # or import operator, operator.add
            &#39;-&#39;: lambda left, right: left - right,
            &#39;*&#39;: lambda left, right: left * right,
            &#39;/&#39;: lambda left, right: left / right,
            &#39;%&#39;: lambda left, right: left % right,
        }
        return op_func[op](left, right)

    def _buildTree(self, expStr):
        expQ = Queue()
        for token in expStr:    # 遍历表达式字符串的每个字符
            expQ.put(token)
        self._expTree = _ExpTreeNode(None)    # 创建root节点
        self._recBuildTree(self._expTree, expQ)

    def _recBuildTree(self, curNode, expQ):
        token = expQ.get()
        if token == &#39;(&#39;:
            curNode.left = _ExpTreeNode(None)
            self._recBuildTree(curNode.left, expQ)

            # next token will be an operator: + = * / %
            curNode.element = expQ.get()
            curNode.right = _ExpTreeNode(None)
            self._recBuildTree(curNode.right, expQ)

            # the next token will be &#39;)&#39;, remmove it
            expQ.get()

        else:  # the token is a digit that has to be converted to an int.
            curNode.element = token


vars = {&#39;a&#39;: 5, &#39;b&#39;: 12}
expTree = ExpressionTree(&quot;((2*7)+8)&quot;)
print(expTree)
print(&#39;The result = &#39;, expTree.evaluate(vars))
</pre></div>
</div>
<p>Heap（堆）：二叉树最直接的一个应用就是实现堆。堆就是一颗完全二叉树，最大堆的非叶子节点的值都比孩子大，最小堆的非叶子结点的值都比孩子小。
python内置了heapq模块帮助我们实现堆操作，比如用内置的heapq模块实现个堆排序:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># 使用python内置的heapq实现heap sort
def heapsort(iterable):
    from heapq import heappush, heappop
    h = []
    for value in iterable:
        heappush(h, value)
    return [heappop(h) for i in range(len(h))]
</pre></div>
</div>
<p>但是一般实现堆的时候实际上并不是用数节点来实现的，而是使用数组实现，效率比较高。为什么可以用数组实现呢?因为完全二叉树的性质，
可以用下标之间的关系表示节点之间的关系，MaxHeap的docstring中已经说明了</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class MaxHeap:
    &quot;&quot;&quot;
    Heaps:
    完全二叉树，最大堆的非叶子节点的值都比孩子大，最小堆的非叶子结点的值都比孩子小
    Heap包含两个属性，order property 和 shape property(a complete binary tree)，在插入
    一个新节点的时候，始终要保持这两个属性
    插入操作：保持堆属性和完全二叉树属性, sift-up 操作维持堆属性
    extract操作：只获取根节点数据，并把树最底层最右节点copy到根节点后，sift-down操作维持堆属性

    用数组实现heap，从根节点开始，从上往下从左到右给每个节点编号，则根据完全二叉树的
    性质，给定一个节点i， 其父亲和孩子节点的编号分别是:
        parent = (i-1) // 2
        left = 2 * i + 1
        rgiht = 2 * i + 2
    使用数组实现堆一方面效率更高，节省树节点的内存占用，一方面还可以避免复杂的指针操作，减少
    调试难度。

    &quot;&quot;&quot;

    def __init__(self, maxSize):
        self._elements = Array(maxSize)    # 第二章实现的Array ADT
        self._count = 0

    def __len__(self):
        return self._count

    def capacity(self):
        return len(self._elements)

    def add(self, value):
        assert self._count &lt; self.capacity(), &#39;can not add to full heap&#39;
        self._elements[self._count] = value
        self._count += 1
        self._siftUp(self._count - 1)
        self.assert_keep_heap()    # 确定每一步add操作都保持堆属性

    def extract(self):
        assert self._count &gt; 0, &#39;can not extract from an empty heap&#39;
        value = self._elements[0]    # save root value
        self._count -= 1
        self._elements[0] = self._elements[self._count]    # 最右下的节点放到root后siftDown
        self._siftDown(0)
        self.assert_keep_heap()
        return value

    def _siftUp(self, ndx):
        if ndx &gt; 0:
            parent = (ndx - 1) // 2
            # print(ndx, parent)
            if self._elements[ndx] &gt; self._elements[parent]:    # swap
                self._elements[ndx], self._elements[parent] = self._elements[parent], self._elements[ndx]
                self._siftUp(parent)    # 递归

    def _siftDown(self, ndx):
        left = 2 * ndx + 1
        right = 2 * ndx + 2
        # determine which node contains the larger value
        largest = ndx
        if (left &lt; self._count and
            self._elements[left] &gt;= self._elements[largest] and
            self._elements[left] &gt;= self._elements[right]):  # 原书这个地方没写实际上找的未必是largest
            largest = left
        elif right &lt; self._count and self._elements[right] &gt;= self._elements[largest]:
            largest = right
        if largest != ndx:
            self._elements[ndx], self._elements[largest] = self._elements[largest], self._elements[ndx]
            self._siftDown(largest)

    def __repr__(self):
        return &#39; &#39;.join(map(str, self._elements))

    def assert_keep_heap(self):
        &quot;&quot;&quot; 我加了这个函数是用来验证每次add或者extract之后，仍保持最大堆的性质&quot;&quot;&quot;
        _len = len(self)
        for i in range(0, int((_len-1)/2)):    # 内部节点（非叶子结点）
            l = 2 * i + 1
            r = 2 * i + 2
            if l &lt; _len and r &lt; _len:
                assert self._elements[i] &gt;= self._elements[l] and self._elements[i] &gt;= self._elements[r]

def test_MaxHeap():
    &quot;&quot;&quot; 最大堆实现的单元测试用例 &quot;&quot;&quot;
    _len = 10
    h = MaxHeap(_len)
    for i in range(_len):
        h.add(i)
        h.assert_keep_heap()
    for i in range(_len):
        # 确定每次出来的都是最大的数字，添加的时候是从小到大添加的
        assert h.extract() == _len-i-1

test_MaxHeap()

def simpleHeapSort(theSeq):
    &quot;&quot;&quot; 用自己实现的MaxHeap实现堆排序，直接修改原数组实现inplace排序&quot;&quot;&quot;
    if not theSeq:
        return theSeq
    _len = len(theSeq)
    heap = MaxHeap(_len)
    for i in theSeq:
        heap.add(i)
    for i in reversed(range(_len)):
        theSeq[i] = heap.extract()
    return theSeq


def test_simpleHeapSort():
    &quot;&quot;&quot; 用一些测试用例证明实现的堆排序是可以工作的 &quot;&quot;&quot;
    def _is_sorted(seq):
        for i in range(len(seq)-1):
            if seq[i] &gt; seq[i+1]:
                return False
        return True

    from random import randint
    assert simpleHeapSort([]) == []
    for i in range(1000):
        _len = randint(1, 100)
        to_sort = []
        for i in range(_len):
            to_sort.append(randint(0, 100))
        simpleHeapSort(to_sort)    # 注意这里用了原地排序，直接更改了数组
        assert _is_sorted(to_sort)


test_simpleHeapSort()
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="search-trees">
<h5>14章: Search Trees<a class="headerlink" href="#search-trees" title="永久链接至标题">¶</a></h5>
<p>二叉差找树性质：对每个内部节点V， 1. 所有key小于V.key的存储在V的左子树。
2. 所有key大于V.key的存储在V的右子树
对BST进行中序遍历会得到升序的key序列</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class _BSTMapNode:
    __slots__ = (&#39;key&#39;, &#39;value&#39;, &#39;left&#39;, &#39;right&#39;)

    def __init__(self, key, value):
        self.key = key
        self.value = value
        self.left = None
        self.right = None

    def __repr__(self):
        return &#39;&lt;{}:{}&gt; left:{}, right:{}&#39;.format(
            self.key, self.value, self.left, self.right)

    __str__ = __repr__


class BSTMap:
    &quot;&quot;&quot; BST，树节点包含key可payload。用BST来实现之前用hash实现过的Map ADT.
    性质：对每个内部节点V，
    1.对于节点V，所有key小于V.key的存储在V的左子树。
    2.所有key大于V.key的存储在V的右子树
    对BST进行中序遍历会得到升序的key序列
    &quot;&quot;&quot;
    def __init__(self):
        self._root = None
        self._size = 0
        self._rval = None     # 作为remove的返回值

    def __len__(self):
        return self._size

    def __iter__(self):
        return _BSTMapIterator(self._root, self._size)

    def __contains__(self, key):
        return self._bstSearch(self._root, key) is not None

    def valueOf(self, key):
        node = self._bstSearch(self._root, key)
        assert node is not None, &#39;Invalid map key.&#39;
        return node.value

    def _bstSearch(self, subtree, target):
        if subtree is None:    # 递归出口，遍历到树底没有找到key或是空树
            return None
        elif target &lt; subtree.key:
            return self._bstSearch(subtree.left, target)
        elif target &gt; subtree.key:
            return self._bstSearch(subtree.right, target)
        return subtree    # 返回引用

    def _bstMinumum(self, subtree):
        &quot;&quot;&quot; 顺着树一直往左下角递归找就是最小的,向右下角递归就是最大的 &quot;&quot;&quot;
        if subtree is None:
            return None
        elif subtree.left is None:
            return subtree
        else:
            return subtree._bstMinumum(self, subtree.left)

    def add(self, key, value):
        &quot;&quot;&quot; 添加或者替代一个key的value, O(N) &quot;&quot;&quot;
        node = self._bstSearch(self._root, key)
        if node is not None:    # if key already exists, update value
            node.value = value
            return False
        else:   # insert a new entry
            self._root = self._bstInsert(self._root, key, value)
            self._size += 1
            return True

    def _bstInsert(self, subtree, key, value):
        &quot;&quot;&quot; 新的节点总是插入在树的叶子结点上 &quot;&quot;&quot;
        if subtree is None:
            subtree = _BSTMapNode(key, value)
        elif key &lt; subtree.key:
            subtree.left = self._bstInsert(subtree.left, key, value)
        elif key &gt; subtree.key:
            subtree.right = self._bstInsert(subtree.right, key, value)
        # 注意这里没有else语句了，应为在被调用处add函数里先判断了是否有重复key
        return subtree

    def remove(self, key):
        &quot;&quot;&quot; O(N)
        被删除的节点分为三种:
        1.叶子结点:直接把其父亲指向该节点的指针置None
        2.该节点有一个孩子: 删除该节点后，父亲指向一个合适的该节点的孩子
        3.该节点有俩孩子:
            (1)找到要删除节点N和其后继S（中序遍历后该节点下一个）
            (2)复制S的key到N
            (3)从N的右子树中删除后继S（即在N的右子树中最小的）
        &quot;&quot;&quot;
        assert key in self, &#39;invalid map key&#39;
        self._root = self._bstRemove(self._root, key)
        self._size -= 1
        return self._rval

    def _bstRemove(self, subtree, target):
        # search for the item in the tree
        if subtree is None:
            return subtree
        elif target &lt; subtree.key:
            subtree.left = self._bstRemove(subtree.left, target)
            return subtree
        elif target &gt; subtree.key:
            subtree.right = self._bstRemove(subtree.right, target)
            return subtree

        else:    # found the node containing the item
            self._rval = subtree.value
            if subtree.left is None and subtree.right is None:
                # 叶子node
                return None
            elif subtree.left is None or subtree.right is None:
                # 有一个孩子节点
                if subtree.left is not None:
                    return subtree.left
                else:
                    return subtree.right
            else:   # 有俩孩子节点
                successor = self._bstMinumum(subtree.right)
                subtree.key = successor.key
                subtree.value = successor.value
                subtree.right = self._bstRemove(subtree.right, successor.key)
                return subtree

    def __repr__(self):
        return &#39;-&gt;&#39;.join([str(i) for i in self])

    def assert_keep_bst_property(self, subtree):
        &quot;&quot;&quot; 写这个函数为了验证add和delete操作始终维持了bst的性质 &quot;&quot;&quot;
        if subtree is None:
            return
        if subtree.left is not None and subtree.right is not None:
            assert subtree.left.value &lt;= subtree.value
            assert subtree.right.value &gt;= subtree.value
            self.assert_keep_bst_property(subtree.left)
            self.assert_keep_bst_property(subtree.right)

        elif subtree.left is None and subtree.right is not None:
            assert subtree.right.value &gt;= subtree.value
            self.assert_keep_bst_property(subtree.right)

        elif subtree.left is not None and subtree.right is None:
            assert subtree.left.value &lt;= subtree.value
            self.assert_keep_bst_property(subtree.left)


class _BSTMapIterator:
    def __init__(self, root, size):
        self._theKeys = Array(size)
        self._curItem = 0
        self._bstTraversal(root)
        self._curItem = 0

    def __iter__(self):
        return self

    def __next__(self):
        if self._curItem &lt; len(self._theKeys):
            key = self._theKeys[self._curItem]
            self._curItem += 1
            return key
        else:
            raise StopIteration

    def _bstTraversal(self, subtree):
        if subtree is not None:
            self._bstTraversal(subtree.left)
            self._theKeys[self._curItem] = subtree.key
            self._curItem += 1
            self._bstTraversal(subtree.right)


def test_BSTMap():
    l = [60, 25, 100, 35, 17, 80]
    bst = BSTMap()
    for i in l:
        bst.add(i)

def test_HashMap():
    &quot;&quot;&quot; 之前用来测试用hash实现的map，改为用BST实现的Map测试 &quot;&quot;&quot;
    # h = HashMap()
    h = BSTMap()
    assert len(h) == 0
    h.add(&#39;a&#39;, &#39;a&#39;)
    assert h.valueOf(&#39;a&#39;) == &#39;a&#39;
    assert len(h) == 1

    a_v = h.remove(&#39;a&#39;)
    assert a_v == &#39;a&#39;
    assert len(h) == 0

    h.add(&#39;a&#39;, &#39;a&#39;)
    h.add(&#39;b&#39;, &#39;b&#39;)
    assert len(h) == 2
    assert h.valueOf(&#39;b&#39;) == &#39;b&#39;
    b_v = h.remove(&#39;b&#39;)
    assert b_v == &#39;b&#39;
    assert len(h) == 1
    h.remove(&#39;a&#39;)

    assert len(h) == 0

    _len = 10
    for i in range(_len):
        h.add(str(i), i)
    assert len(h) == _len
    for i in range(_len):
        assert str(i) in h
    for i in range(_len):
        print(len(h))
        print(&#39;bef&#39;, h)
        _ = h.remove(str(i))
        assert _ == i
        print(&#39;aft&#39;, h)
        print(len(h))
    assert len(h) == 0

test_HashMap()
</pre></div>
</div>
</div>
</div>
<span id="document-database/index"></span><div class="section" id="id1">
<h4>数据库<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-database/mongo"></span><div class="section" id="mongodb">
<span id="mongo"></span><h5>MongoDB<a class="headerlink" href="#mongodb" title="永久链接至标题">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">lzy <a class="reference external" href="mailto:kzinglzy&#37;&#52;&#48;gmail&#46;com">kzinglzy<span>&#64;</span>gmail<span>&#46;</span>com</a>, tonghs <a class="reference external" href="mailto:tonghuashuai&#37;&#52;&#48;gmail&#46;com">tonghuashuai<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="id1">
<h6>简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p>MongoDB是文档型的非关系型数据库，其优势在于查询功能强大，能存储海量数据. 是懒人借以代替SQL型数据库的产品.</p>
<p>在API选择上, 我们用的是基于PyMongo的MongoKit, 并在此基础上进行了小的封装.
所以如果你遇到了问题, 可以去查阅PyMongo或MongoKit的官方文档</p>
</div>
<div class="section" id="id2">
<h6>基本用法<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>find<ul>
<li>limit</li>
<li>skip</li>
<li>sort</li>
</ul>
</li>
<li>delete</li>
<li>remove(删除条件)</li>
<li>save</li>
<li>填充默认值</li>
<li>upsert</li>
<li>时间用int保存</li>
<li>mongo默认值需要是一个生成函数</li>
<li>pyhton常见的默认值陷阱，以create_time=time()为例</li>
</ul>
<div class="section" id="id3">
<h7>创建文档<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h7>
<p>在mongo里,用&#8221;文档&#8221;的概念代替SQL里的&#8221;表&#8221;. 例如, 下面定义了一个UserIm文档:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>class UserIM(Doc):

    structure = dict(
        user_id=int,
        phone=str,
        qq=str,
        weixin=str,
    )

    indexes = [{
        &#39;fields&#39;: &#39;user_id&#39;,
        &#39;unique&#39;: True
    }]
    default_values = {
        &#39;user_id&#39;: 0
    }
</pre></div>
</div>
<p>其中, UserIm继承自类Doc</p>
<p>structure定义了文档的字段, 接受一个Python字典对象;</p>
<p>indexes定义了索引, 接受一个列表</p>
<p>default_values定义了初始化时的默认值.</p>
<p>除此之外, 你还可以添加更多的信息, 这些可以在 <a class="reference external" href="//https://github.com/namlook/mongokit/wiki">MongoKit document</a> 里找到.</p>
</div>
<div class="section" id="id4">
<h7>初始化<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h7>
<p>初始化一个文档对象可以这么写:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ui = UserIM()
</pre></div>
</div>
<p>此时, 所有的文档属性值都会被设为 None , 因为我们并没有给他传递任何值.</p>
<p>这可以通过传递一个字典对象或者JsOB对象来初始化属性值, 如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ui = UserIM(dict(user_id=123, phone=456))  # 字典

ui = UserIM(JsOb(user_id=123, phone=456))  # JsOb 对象
</pre></div>
</div>
<p>但此时, 其它的没有被初始化的值还是会被设为 None, 若要使我们设置的default_values生效, 可以通过将第二个参数设为True来实现, 如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ui = UserIM(dict(user_id=123, phone=456), True)
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h7>更新<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h7>
<p>下面我们想更新数据, 如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ui = UserIm()
ui.user_id = 123
ui.mail = &#39;abc@gmail.com&#39;
ui.save()
</pre></div>
</div>
<p>这将会添加一个user_id为123, mail为abc&#64;gmail.com 的记录.</p>
<p>其中未被赋值的属性会被设为None, 不存在的属性会被忽略. 如果要添加的记录已存在, 那么旧的记录会被替换掉, 否则,会创建一个新的记录.</p>
<p>除此之外, 还有一种更优雅的方式可以实现数据的更新:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ui = UserIM({&#39;mail&#39;: &#39;abc@gmail.com&#39;})
user_im.upsert({&#39;user_id&#39;: &#39;123&#39;})
</pre></div>
</div>
<p>这里使用了upsert这个函数, 它的效果和 save 是一样的.但用起来更优雅更简单.</p>
</div>
<div class="section" id="id6">
<h7>查询<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h7>
<p>常用的查询要用到两个函数:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>UserIM.find(dict(phone=456))
</pre></div>
</div>
<p>这会返回所有的phone值为456的Python列表.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>UserIM.find_one(dict(user_id=123))
</pre></div>
</div>
<p>这会返回一个用户记录, 其 id 为123.</p>
<p>当然, 还可以添加更多的查询条件来实现复杂的查询, 如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>UserIM.find(
        {&#39;$or&#39;: [{&#39;phone&#39; :456}, {&#39;mail&#39;: abc@gmail.com}]},
        limit=10,
        skip=0
        )
</pre></div>
</div>
<p>如上会返回最多包含10条的, phone 为456或者 mail 为 <a class="reference external" href="mailto:abc&#37;&#52;&#48;gmail&#46;com">abc<span>&#64;</span>gmail<span>&#46;</span>com</a> 的记录列表</p>
</div>
<div class="section" id="id7">
<h7>备份和恢复<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h7>
<p>Mongodb自带了mongodump和mongorestore这两个工具来实现对数据的备份和恢复。
mongodump能够在Mongodb运行时进行备份，它的工作原理是对运行的Mongodb做查询，然后将所有查到的文档写入磁盘。但是存在的问题时使用mongodump产生的备份不一定是数据库的实时快照，如果我们在备份时对数据库进行了写入操作，则备份出来的文件可能不完全和Mongodb实时数据相等。另外在备份时可能会对其它客户端性能产生不利的影响。</p>
<p>备份:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>mongodump -d SITE -o ~/download/mongobak/SITE/
</pre></div>
</div>
<p>恢复:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>mongorestore -d SITE --directoryperdb ~/download/mongobak/SITE/ --drop
</pre></div>
</div>
<p>注意: &#8211;drop 参数代表恢复前删除原数据</p>
<p>官方文档: <a class="reference external" href="http://docs.mongodb.org/manual/core/import-export/">http://docs.mongodb.org/manual/core/import-export/</a></p>
</div>
</div>
<div class="section" id="id8">
<h6>源码<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<p>&#8220;源码面前, 了无秘密&#8221; &#8211; 侯捷</p>
<p>当你愤怒的发现上面的某些用法不是标准的MongoKit用法时, 就是时候看看源码了:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>/home/zz/42web/z42/web/mongo.py
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h6>阅读资料<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="//https://github.com/namlook/mongokit/wiki">MongoKit document</a></p>
<p><a class="reference external" href="//http://api.mongodb.org/python/current">PyMongo document</a></p>
<p><a class="reference external" href="//http://docs.mongodb.org/manual">MongoDB document</a></p>
<p><a class="reference external" href="http://blog.nosqlfan.com/html/3548.html">MongoDB 资料汇总</a></p>
</div>
</div>
<span id="document-database/mysql"></span><div class="section" id="mysql">
<span id="id1"></span><h5>Mysql<a class="headerlink" href="#mysql" title="永久链接至标题">¶</a></h5>
<div class="section" id="id2">
<h6>数据库操作<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<div class="section" id="kill">
<h7>批量 kill 掉查询<a class="headerlink" href="#kill" title="永久链接至标题">¶</a></h7>
<p>有时候需要批量 kill 掉查询进程，有几种方式，比如生成 sql 文件执行：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="s1">&#39;KILL &#39;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">processlist</span>
<span class="k">where</span> <span class="k">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span> <span class="k">and</span> <span class="k">time</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">into</span> <span class="n">outfile</span> <span class="s1">&#39;/tmp/a.txt&#39;</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">source</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">txt</span><span class="p">;</span>
</pre></div>
</div>
<p>有时候没法生成文件（权限原因），可以直接生成 sql 语句 copy 下来复制到命令行也可以，或者连接成一行方便复制：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span>mysql &gt; select concat(&#39;KILL &#39;,id,&#39;;&#39;) from information_schema.processlist where db=&#39;dbname&#39;;`

mysql &gt; select GROUP_CONCAT(stat SEPARATOR &#39; &#39;) from (select concat(&#39;KILL &#39;,id,&#39;;&#39;) as stat from information_schema.processlist where db=&#39;dbname&#39;) as stats;

# 按客户端 IP 分组，看哪个客户端的链接数最多
select client_ip,count(client_ip) as client_num from (select substring_index(host,&#39;:&#39; ,1) as client_ip from processlist ) as connect_info group by client_ip order by client_num desc;

# 查看正在执行的线程，并按 Time 倒排序，看看有没有执行时间特别长的线程
select * from information_schema.processlist where Command != &#39;Sleep&#39; order by Time desc;

# 找出所有执行时间超过 5 分钟的线程，拼凑出 kill 语句，方便后面查杀
select concat(&#39;kill &#39;, id, &#39;;&#39;) from information_schema.processlist where Command != &#39;Sleep&#39; and Time &gt; 300 order by Time desc;
</pre></div>
</div>
<p>也可以通过 python 脚本来完成，原理也是查询进程 id 然后删除：</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="c1"># https://stackoverflow.com/questions/1903838/how-do-i-kill-all-the-processes-in-mysql-show-processlist</span>

<span class="kn">import</span> <span class="nn">pymysql</span> <span class="c1"># pip install pymysql</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">db</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SHOW PROCESSLIST&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="c1"># 过滤条件</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;kill </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;kill </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">_id</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h7>删除大表(借助一个临时表)<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span># https://stackoverflow.com/questions/879327/quickest-way-to-delete-enormous-mysql-table
CREATE TABLE new_foo LIKE foo;
RENAME TABLE foo TO old_foo, new_foo TO foo;
DROP TABLE old_foo;
# 发现好像直接用 truncate table tablename; 清理千万级别表也挺快的
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h7>统计表的大小并排序<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">stackoverflow</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">questions</span><span class="o">/</span><span class="mi">9620198</span><span class="o">/</span><span class="n">how</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="k">get</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">sizes</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">tables</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">mysql</span><span class="o">-</span><span class="k">database</span>
<span class="k">SELECT</span>
     <span class="n">table_schema</span> <span class="k">as</span> <span class="o">`</span><span class="k">Database</span><span class="o">`</span><span class="p">,</span>
     <span class="k">table_name</span> <span class="k">AS</span> <span class="o">`</span><span class="k">Table</span><span class="o">`</span><span class="p">,</span>
     <span class="n">round</span><span class="p">(((</span><span class="n">data_length</span> <span class="o">+</span> <span class="n">index_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">`</span><span class="k">Size</span> <span class="k">in</span> <span class="n">MB</span><span class="o">`</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">TABLES</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">+</span> <span class="n">index_length</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h7>统计数据库大小<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">stackoverflow</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">questions</span><span class="o">/</span><span class="mi">1733507</span><span class="o">/</span><span class="n">how</span><span class="o">-</span><span class="k">to</span><span class="o">-</span><span class="k">get</span><span class="o">-</span><span class="k">size</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">mysql</span><span class="o">-</span><span class="k">database</span>
<span class="k">SELECT</span> <span class="n">table_schema</span> <span class="ss">&quot;DB Name&quot;</span><span class="p">,</span>
        <span class="n">ROUND</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">data_length</span> <span class="o">+</span> <span class="n">index_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ss">&quot;DB Size in MB&quot;</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">table_schema</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h7>查看表信息<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">mysql</span> <span class="o">&gt;</span> <span class="k">show</span> <span class="k">table</span> <span class="n">status</span><span class="p">;</span>
<span class="n">mysql</span> <span class="o">&gt;</span> <span class="k">show</span> <span class="k">table</span> <span class="n">status</span> <span class="k">where</span> <span class="k">Rows</span><span class="o">&gt;</span><span class="mi">100000</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h7>纵向显示<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h7>
<p>有时候表字段比较多的时候，查询结果显示会很乱，可以使用竖屏显示的方式，结尾加上 <code class="xref py py-obj docutils literal"><span class="pre">\G</span></code></p>
<div class="highlight-sql"><div class="highlight"><pre><span></span>mysql &gt; select * from user limit 10 \G
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h7>导出和导入表的数据<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">shell</span> <span class="o">&gt;</span> <span class="n">mysqldump</span> <span class="o">-</span><span class="n">u</span> <span class="k">user</span> <span class="o">-</span><span class="n">h</span> <span class="k">host</span> <span class="o">-</span><span class="n">p</span> <span class="n">pass</span> <span class="n">db_name</span> <span class="k">table_name</span> <span class="o">&gt;</span> <span class="k">out</span><span class="p">.</span><span class="k">sql</span>
<span class="n">mysql</span> <span class="o">&gt;</span> <span class="k">source</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="k">out</span><span class="p">.</span><span class="k">sql</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h7>重命名数据库<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h7>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">stackoverflow</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">questions</span><span class="o">/</span><span class="mi">67093</span><span class="o">/</span><span class="n">how</span><span class="o">-</span><span class="k">do</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">quickly</span><span class="o">-</span><span class="k">rename</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">mysql</span><span class="o">-</span><span class="k">database</span><span class="o">-</span><span class="n">change</span><span class="o">-</span><span class="k">schema</span><span class="o">-</span><span class="n">name</span>
<span class="n">mysqldump</span> <span class="o">-</span><span class="n">u</span> <span class="n">username</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">v</span> <span class="n">olddatabase</span> <span class="o">&gt;</span> <span class="n">olddbdump</span><span class="p">.</span><span class="k">sql</span>
<span class="n">mysqladmin</span> <span class="o">-</span><span class="n">u</span> <span class="n">username</span> <span class="o">-</span><span class="n">p</span> <span class="k">create</span> <span class="n">newdatabase</span>
<span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">username</span> <span class="o">-</span><span class="n">p</span> <span class="n">newdatabase</span> <span class="o">&lt;</span> <span class="n">olddbdump</span><span class="p">.</span><span class="k">sql</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="python-mysql">
<h6>Python Mysql 操作<a class="headerlink" href="#python-mysql" title="永久链接至标题">¶</a></h6>
<div class="section" id="sqlalchemy">
<h7>Sqlalchemy 示例<a class="headerlink" href="#sqlalchemy" title="永久链接至标题">¶</a></h7>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sqlalchemy 快速读取 mysql 数据示例</span>

<span class="sd">pip install SQLAlchemy -i https://pypi.doubanio.com/simple --user</span>
<span class="sd">pip install pymysql -i https://pypi.doubanio.com/simple --user</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">db</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># 本机 mysql 创建一个测试表</span>

<span class="sd">CREATE TABLE `area_code` (</span>
<span class="sd">  `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="sd">  `code` bigint(12) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;行政区划代码&#39;,</span>
<span class="sd">  `name` varchar(32) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;,</span>
<span class="sd">  PRIMARY KEY (`id`),</span>
<span class="sd">  KEY `idx_code` (`code`)</span>
<span class="sd">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">sqlalchemy_demo</span><span class="p">():</span>
    <span class="c1"># https://towardsdatascience.com/sqlalchemy-python-tutorial-79a577141a91</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;mysql+pymysql://root:wnnwnn@127.0.0.1:3306/testdb&quot;</span>  <span class="c1"># 测试地址</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s1">&#39;area_code&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

    <span class="c1"># 插入单个数据</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="mi">10010</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;北京&quot;</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># 插入多个数据</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">10020</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;上海&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">10030</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;杭州&#39;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="c1"># 查询</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># 修改</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;帝都&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">10010</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="c1"># 删除行</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">10010</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sqlalchemy_demo</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="go-mysql">
<h6>Go Mysql 操作<a class="headerlink" href="#go-mysql" title="永久链接至标题">¶</a></h6>
<p>go 可以使用 gorm 或者 database/sql</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;database/sql&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;log&quot;</span>
    <span class="s">&quot;time&quot;</span>

    <span class="nx">_</span> <span class="s">&quot;github.com/go-sql-driver/mysql&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;mysql&quot;</span><span class="p">,</span> <span class="s">&quot;root:root@(127.0.0.1:3306)/root?parseTime=true&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Ping</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">{</span> <span class="c1">// Create a new table</span>
        <span class="nx">query</span> <span class="o">:=</span> <span class="s">`</span>
<span class="s">            CREATE TABLE users (</span>
<span class="s">                id INT AUTO_INCREMENT,</span>
<span class="s">                username TEXT NOT NULL,</span>
<span class="s">                password TEXT NOT NULL,</span>
<span class="s">                created_at DATETIME,</span>
<span class="s">                PRIMARY KEY (id)</span>
<span class="s">            );`</span>

        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">{</span> <span class="c1">// Insert a new user</span>
        <span class="nx">username</span> <span class="o">:=</span> <span class="s">&quot;johndoe&quot;</span>
        <span class="nx">password</span> <span class="o">:=</span> <span class="s">&quot;secret&quot;</span>
        <span class="nx">createdAt</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>

        <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">`INSERT INTO users (username, password, created_at) VALUES (?, ?, ?)`</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">createdAt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">LastInsertId</span><span class="p">()</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">{</span> <span class="c1">// Query a single user</span>
        <span class="kd">var</span> <span class="p">(</span>
            <span class="nx">id</span>        <span class="kt">int</span>
            <span class="nx">username</span>  <span class="kt">string</span>
            <span class="nx">password</span>  <span class="kt">string</span>
            <span class="nx">createdAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
        <span class="p">)</span>

        <span class="nx">query</span> <span class="o">:=</span> <span class="s">&quot;SELECT id, username, password, created_at FROM users WHERE id = ?&quot;</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">QueryRow</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">password</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">createdAt</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">createdAt</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">{</span> <span class="c1">// Query all users</span>
        <span class="kd">type</span> <span class="nx">user</span> <span class="kd">struct</span> <span class="p">{</span>
            <span class="nx">id</span>        <span class="kt">int</span>
            <span class="nx">username</span>  <span class="kt">string</span>
            <span class="nx">password</span>  <span class="kt">string</span>
            <span class="nx">createdAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
        <span class="p">}</span>

        <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="s">`SELECT id, username, password, created_at FROM users`</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

        <span class="kd">var</span> <span class="nx">users</span> <span class="p">[]</span><span class="nx">user</span>
        <span class="k">for</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">u</span> <span class="nx">user</span>

            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="nx">users</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="nx">u</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%#v&quot;</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">`DELETE FROM users WHERE id = ?`</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-database/redis"></span><div class="section" id="redis">
<span id="id1"></span><h5>Redis<a class="headerlink" href="#redis" title="永久链接至标题">¶</a></h5>
</div>
</div>
</div>
<span id="document-skillstack/index"></span><div class="section" id="id1">
<h4>技术栈<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-skillstack/docker"></span><div class="section" id="docker">
<h5>docker<a class="headerlink" href="#docker" title="永久链接至标题">¶</a></h5>
<div class="section" id="id1">
<h6>预习材料<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="http://www.widuu.com/chinese_docker/installation/windows.html">docker
中文文档</a></p>
</div>
<div class="section" id="mac">
<h6>MAC使用<a class="headerlink" href="#mac" title="永久链接至标题">¶</a></h6>
<p>mac用iterm运行 boot2docker ssh 可以进入虚拟机</p>
<p>重启mac以后需要先 book2docker start</p>
</div>
<div class="section" id="windows">
<h6>windows使用<a class="headerlink" href="#windows" title="永久链接至标题">¶</a></h6>
<p>可以用xshell登录到虚拟机方便使用</p>
</div>
<div class="section" id="id2">
<h6>基本用法<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>从镜像文件新建一个虚拟机</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker run -t -i -p 80:80 -p 2200:22 --name 42 6e469ec45c90 /bin/bash

docker run -d -p 80:80 -p 2222:22 --name 42 zuroc/42web /usr/sbin/sshd -D
</pre></div>
</div>
<p>ifconfig 可以看到docker母机的ip</p>
<p>重新进入一个虚拟机</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker start -i 42
</pre></div>
</div>
<p>浏览所有虚拟机</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker ps -a
</pre></div>
</div>
<p>一次性删除所有的容器</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker rm $(docker ps -q -a)
</pre></div>
</div>
<p>一次性删除所有的镜像。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker rmi $(docker images -q)
</pre></div>
</div>
<p>docker commit 37a3eb81fb77 zuroc/42web 保存一个虚拟机为镜像 docker</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>export 42 \| xz -c &gt; 42.txz

rsync -avhP docker.txz root@42py.com:/data
</pre></div>
</div>
<p>docer export 对应</p>
<p>导入的命令是 cat docker_42web.bz2 | docker import - zuroc/42web</p>
<p>我这里用的是niubi：latest ......</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>$ sudo ifconfig docker0 docker0 Link encap:Ethernet HWaddr xx:xx:xx:xx:xx:xx inet addr:172.17.42.1 Bcast:0.0.0.0 Mask:255.255.0.0
</pre></div>
</div>
<p><a class="reference external" href="http://linuxwiki.github.io/Services/Docker.html#62docker0-ip">http://linuxwiki.github.io/Services/Docker.html#62docker0-ip</a></p>
<dl class="docutils">
<dt>::</dt>
<dd><p class="first">docker export bb6ce0f8e59c |bzip2 -c &gt; 42.tar.bz2</p>
<p class="last">sudo iptables -t nat -A PREROUTING -i eth0 -p tcp &#8211;dport 8000 -j DNAT
&#8211;to 172.17.0.17:8000</p>
</dd>
</dl>
<p>mysql 密码 42web 解析</p>
<p>修改本机host ， 加入</p>
<p>a.com xx.xxx.xx.xx sso.a.com xx.xxx.xx.xx</p>
<p>进入虚拟机后先运行boot sudo /etc/init.d/sshd start
可以启动ssh服务用xshell来登录</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>sudo /etc/init.d/sshd start

~/ac/zapp/TECH2IPO $ ./dev.sh

brew install dnsmasq

brew install dnsmasq
</pre></div>
</div>
</div>
<div class="section" id="macdnsmasq">
<h6>Mac安装DNSMASQ<a class="headerlink" href="#macdnsmasq" title="永久链接至标题">¶</a></h6>
<p>要安装dnsmasq，你需要先安装 Homebrew 。</p>
<p>它自称“OS X 不可或缺的套件管理器”。</p>
</div>
<div class="section" id="homebrew">
<h6>安装Homebrew<a class="headerlink" href="#homebrew" title="永久链接至标题">¶</a></h6>
<p>请打开 终端 （应用程序&gt;实用工具），并运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ruby -e &quot;$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)&quot;
</pre></div>
</div>
<p>你需要按照提示来继续安装。这个过程或许会很慢，受限于网络状况。如果实在很慢，你可以在VPN环境下安装。</p>
<p>安装完成之后，你就可以使用brew命令来安装dnsmasq了。</p>
<p>安装并配置dnsmasq组件!</p>
<p>仍然在终端运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>brew install dnsmasq
</pre></div>
</div>
<p>等待安装完成后，请在 /usr/local/ 文件下新建一个 etc 文件夹。</p>
<p>现在把 /usr/local/opt/dnsmasq/dnsmasq.conf.example 文件拷贝至并重命名为
/usr/local/etc/ dnsmasq.conf 。</p>
<p>在刚刚的 /usr/local/etc/ 文件夹下新建一个 resolv.dnsmasq.conf 文件。</p>
<p>用sublime text，textmate，bbedit等纯文本编辑器打开这个
resolv.dnsmasq.conf 文件，输入以下内容</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>nameserver 223.5.5.5 nameserver 223.6.6.6 nameserver 178.79.131.110
</pre></div>
</div>
<p>这些都是你常用的DNS地址，你可以添加更多，比如OpenDNS。</p>
<p>用sublime text，textmate，bbedit等纯文本编辑器打开同文件夹下的
dnsmasq.conf 文件，增加以下内容</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>resolv-file=/usr/local/etc/resolv.dnsmasq.conf

strict-order

no-hosts

cache-size=32768

listen-address=127.0.0.1

address=/c.cc/192.168.59.103 address=/a.com/192.168.59.103
</pre></div>
</div>
<p>这就是最简单的配置文件。需要说明的是，listen-address后面的可以是多个IP用英文逗号隔开，例如你写listen-address=127.0.0.1,192.168.1.102，其中192.168.1.102是你的计算机的内网IP，就可以实现同一个局域网内的设备，通过设置DNS为这个IP，来实现都通过你的dnsmasq来查询dns，即局域网范围内的DNS泛解析。</p>
<p>要运行并且开机自动运行dnsmasq，在终端运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>sudo cp -fv /usr/local/opt/dnsmasq/\*.plist /Library/LaunchDaemons sudo
launchctl load /Library/LaunchDaemons/homebrew.mxcl.dnsmasq.plist
</pre></div>
</div>
<p>现在，你可以通过把Mac系统的DNS改为127.0.0.1来使用dnsmasq。同局域网的用户也可以修改DNS到此台Mac的IP即可。前提是要把此台Mac的局域网IP写到listen-address里。</p>
<div class="figure" id="id3">
<img alt="配置dns" src="http://img.hb.aicdn.com/f57480ce42715b9c489ab7ecfe57a0984058592bac19-tVhEuN" />
<p class="caption"><span class="caption-text">配置dns</span></p>
</div>
<p>dnsmasq dns config 要检查运行情况，你可以在终端运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>dig g.cn
</pre></div>
</div>
<p>来检查是否在使用本地的dnsmasq进行dns解析。</p>
</div>
<div class="section" id="dnsmasq">
<h6>DNSMASQ 泛解析<a class="headerlink" href="#dnsmasq" title="永久链接至标题">¶</a></h6>
<p>上面只是安装好了dnsmasq，下面来具体介绍DNSMASQ的泛解析功能，来突破墙，实现谷歌服务直连。要添加规则，只需在dnsmasq.conf文件里追加内容即可。</p>
<p>DNSMASQ的泛解析规则是这样的：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>address=/baidu.com/1.1.1.1
</pre></div>
</div>
<p>这意味着，<em>.baidu.com/</em>都将被引导至IP为1.1.1.1。</p>
</div>
</div>
<span id="document-skillstack/linux"></span><div class="section" id="linux">
<span id="id1"></span><h5>Linux<a class="headerlink" href="#linux" title="永久链接至标题">¶</a></h5>
<div class="section" id="gentoo">
<h6>Gentoo<a class="headerlink" href="#gentoo" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>emerge &#8211;autounmask-write 然后 etc-update 然后 -3</li>
<li>emerge =xxx-版本号</li>
</ul>
<p>自定义的命令 .................................. * dirreplace *
replace_line.py * deltmp</p>
<p>高级篇 .................................. * dstat * dirreplace *
replace_line.py</p>
<ul class="simple">
<li>eix<ul>
<li>eix-update</li>
</ul>
</li>
<li>etc-update -3</li>
<li>emerge &#8211;auto-unmaskwrite</li>
<li>emerge =</li>
<li>rc-update<ul>
<li>rc-update add 服务名称 default</li>
<li>rc-update remove 服务名称 default</li>
</ul>
</li>
</ul>
</div>
</div>
<span id="document-skillstack/rst"></span><div class="section" id="restructuredtext">
<span id="rst-tutorial"></span><h5>reStructuredText简明教程<a class="headerlink" href="#restructuredtext" title="永久链接至标题">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">作者:</th><td class="field-body">刘斗 <a class="reference external" href="mailto:redfork&#37;&#52;&#48;gmail&#46;com">redfork<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<p>图形化 web 编辑工具： <a class="reference external" href="http://rst.ninjs.org/">rst.ninjs.org</a></p>
<div class="section" id="id1">
<h6>段落<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p>REST 是松散的文本结构，使用预定义的模式描述文章的结构。首先学习最基本的结构：段落。</p>
<p>段落是被空行分割的文字片段，左侧必须对齐（没有空格，或者有相同多的空格）。</p>
<blockquote>
<div><p>缩进的段落被视为引文。</p>
<blockquote>
<div>继续缩进……</div></blockquote>
<p>恢复</p>
</div></blockquote>
<p>恢复</p>
</div>
<div class="section" id="id2">
<h6>文字样式<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>最简单的样式是 <em>斜体</em> 和 <strong>粗体</strong>.</p>
<blockquote>
<div><ul class="simple">
<li>*斜体*. 被*包围的文字是斜体</li>
<li>**粗体**. 被**包围的文字是粗体</li>
</ul>
</div></blockquote>
<p>注意: * 两侧必须留有空格, 英文标点符号. 输入法设置为英文标点, 并使用正确的英文标点规范 (逗号, 句号后留一个空格, 引号, 括号两侧留一个空格).</p>
</div>
<div class="section" id="id3">
<h6>列表<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<p>有三种列表:</p>
<blockquote>
<div><ol class="arabic simple">
<li>顺序,</li>
<li>公告牌,</li>
<li>定义.</li>
</ol>
</div></blockquote>
<p>列表前后, 以及条目之间必须有空行隔开. 列表下面可以插入任意的内容, 段落, 图片都可以, 只要他们的左侧和列表的第一个文字左对齐.</p>
<div class="section" id="id4">
<h7>顺序列表<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h7>
<div class="highlight-none"><div class="highlight"><pre><span></span>1. 第 **一** 条

   段落

#. 第二条

   1. 小条

#. 第三条
</pre></div>
</div>
<p>顺序列表 生成:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">第 <strong>一</strong> 条</p>
<p>段落</p>
</li>
<li><p class="first">第二条</p>
<ol class="arabic simple">
<li>小条</li>
</ol>
</li>
<li><p class="first">第三条</p>
</li>
</ol>
</div></blockquote>
<p>第二条开始后续的条目用 # 开头</p>
</div>
<div class="section" id="id5">
<h7>顺序列表 - 序号<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h7>
<p>第一条的序号不必从 1 开始:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>3. 第三条

#. 第四条

7. 重新设定序号

#. 继续
</pre></div>
</div>
<p>顺序列表 - 序号 生成:</p>
<blockquote>
<div><ol class="arabic simple" start="3">
<li>第三条</li>
<li>第四条</li>
</ol>
<ol class="arabic simple" start="7">
<li>重新设定序号</li>
<li>继续</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id6">
<h7>顺序列表 - 符号样式<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h7>
<p>符号:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>1. 数字

a. 小写字母

A. 大写字母

i) 小写罗马数字

(I) 大写罗马数字
</pre></div>
</div>
<p>顺序列表 - 符号样式 效果</p>
<p>符号:</p>
<blockquote>
<div><ol class="arabic simple">
<li>数字</li>
</ol>
<ol class="loweralpha simple">
<li>小写字母</li>
</ol>
<ol class="upperalpha simple">
<li>大写字母</li>
</ol>
<ol class="lowerroman simple">
<li>小写罗马数字</li>
</ol>
<ol class="upperroman simple">
<li>大写罗马数字</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="id7">
<h7>公告牌列表<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h7>
<p>和顺序列表相似, 使用 &#8220;*&#8221; &#8220;+&#8221; &#8220;-&#8221; 代替数字:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>* 列表第一级

  + 第二级

    - 第三级

  + 第二级的另一个项目
</pre></div>
</div>
<p>公告牌列表 生成:</p>
<blockquote>
<div><ul class="simple">
<li>列表第一级<ul>
<li>第二级<ul>
<li>第三级</li>
</ul>
</li>
<li>第二级的另一个项目</li>
</ul>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="id8">
<h6>定义列表<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<p>或者叫名词解释更确切:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>*鸡*
  两条腿, 直立行走, 带翅膀, 有头冠的动物.

*鸭*
  鸡的崇拜者
</pre></div>
</div>
<p>定义列表生成:</p>
<dl class="docutils">
<dt><em>鸡</em></dt>
<dd>两条腿, 直立行走, 带翅膀, 有头冠的动物.</dd>
<dt><em>鸭</em></dt>
<dd>鸡的崇拜者</dd>
</dl>
</div>
<div class="section" id="id9">
<h6>嵌入程序代码<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<p>如果需要嵌入大段的程序代码(SQL, 业务逻辑设置, 配置文件等), 在段落末尾添加两个&#8217;:&#8217;. 代码的左侧必须缩进, 代码引用到没有缩进的行为止. 例如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>如果数据库有问题, 执行下面的 SQL::

 # Dumping data for table `item_table`

 INSERT INTO item_table VALUES (
   0000000001, 0, &#39;Manual&#39;, &#39;&#39;, &#39;0.18.0&#39;,
   &#39;This is the manual for Mantis version 0.18.0.\r\n\r\nThe Mantis manual is modeled after the [url=http://www.php.net/manual/en/]PHP Manual[/url]. It is authored via the \\&quot;manual\\&quot; module in Mantis CVS.  You can always view/download the latest version of this manual from [url=http://mantisbt.sourceforge.net/manual/]here[/url].&#39;,
   &#39;&#39;, 1, 1, 20030811192655);
</pre></div>
</div>
<p>嵌入程序代码生成:</p>
<p>如果数据库有问题, 执行下面的 SQL:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># Dumping data for table `item_table`
INSERT INTO item_table VALUES (
  0000000001, 0, &#39;Manual&#39;, &#39;&#39;, &#39;0.18.0&#39;,
  &#39;This is the manual for Mantis version 0.18.0.\r\n\r\nThe Mantis manual is modeled after the [url=http://www.php.net/manual/en/]PHP Manual[/url]. It is authored via the \\&quot;manual\\&quot; module in Mantis CVS.  You can always view/download the latest version of this manual from [url=http://mantisbt.sourceforge.net/manual/]here[/url].&#39;,
  &#39;&#39;, 1, 1, 20030811192655);
</pre></div>
</div>
<div class="section" id="id10">
<h7>嵌入程序代码 续<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h7>
<p>如果没有合适的段落添加 ::, 也可以在一个空行上添加, 这个双冒号行被忽略:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>::

#
# Dumping data for table `item_table`
#

INSERT INTO item_table VALUES (
  0000000001, 0, &#39;Manual&#39;, &#39;&#39;, &#39;0.18.0&#39;,
  &#39;This is the manual for Mantis version 0.18.0.\r\n\r\nThe Mantis manual is modeled after the [url=http://www.php.net/manual/en/]PHP Manual[/url]. It is authored via the \\&quot;manual\\&quot; module in Mantis CVS.  You can always view/download the latest version of this manual from [url=http://mantisbt.sourceforge.net/manual/]here[/url].&#39;,
  &#39;&#39;, 1, 1, 20030811192655);
</pre></div>
</div>
<p>嵌入程序代码 续 生成:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>#
# Dumping data for table `item_table`
#

INSERT INTO item_table VALUES (
  0000000001, 0, &#39;Manual&#39;, &#39;&#39;, &#39;0.18.0&#39;,
  &#39;This is the manual for Mantis version 0.18.0.\r\n\r\nThe Mantis manual is modeled after the [url=http://www.php.net/manual/en/]PHP Manual[/url]. It is authored via the \\&quot;manual\\&quot; module in Mantis CVS.  You can always view/download the latest version of this manual from [url=http://mantisbt.sourceforge.net/manual/]here[/url].&#39;,
  &#39;&#39;, 1, 1, 20030811192655);
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h7>程序引用体例<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h7>
<p>可以 用 <code class="xref py py-obj docutils literal"> <span class="pre">code-block::</span></code> 追加各种语法高亮声明:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. code-block:: python
    :linenos:

    def foo():
        print &quot;Love Python, Love FreeDome&quot;
        print &quot;E文标点,.0123456789,中文标点,. &quot;
</pre></div>
</div>
<p>效果:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;Love Python, Love FreeDome&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;E文标点,.0123456789,中文标点,. &quot;</span>
</pre></div>
</td></tr></table></div>
<p>外部包含:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. literalinclude:: example.py
    :language: python
</pre></div>
</div>
<p>效果:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#coding:utf-8</span>

<span class="nb">print</span> <span class="s2">&quot;Hello&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id12">
<h6>章节<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<p>章节是文章的主体结构, 分为 <strong>标题 章 节 小节</strong> 等. 定义章节的方式是在行的下面添加 &#8216;=======&#8217;, 比如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>标题
====

章
--

节
~~

小节
####
</pre></div>
</div>
<p>说明 <a class="footnote-reference" href="#id14" id="id13">[1]</a>:</p>
<blockquote>
<div><ol class="arabic simple">
<li>&#8216;====&#8217; 至少和文字行一样长, 更长也行</li>
<li>相同级别必须使用统一的符号, 否则会被识别为更小的级别</li>
<li>= - ~ ` : &#8216; &#8221; ^ _ * _ # &lt; &gt;
这些符号都可以, 级别足够多了.</li>
</ol>
</div></blockquote>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id13">[1]</a></td><td>由于幻灯片系统的限制, 效果无法在幻灯片内演示</td></tr>
</tbody>
</table>
</div>
<div class="section" id="id15">
<h6>标题<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h6>
<p>标题和章节在结构上的作用相同, 但是可能有不同的显示格式. 标题的区别是在章节的上方也加上 &#8216;====&#8217; 行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>====
标题
====

-----------
第一章 概述
-----------
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h6>表格<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h6>
<div class="section" id="id17">
<h7>普通表格<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h7>
<div class="highlight-none"><div class="highlight"><pre><span></span>+------------+------------+-----------+
| Header 1   | Header 2   | Header 3  |
+============+============+===========+
| body row 1 | column 2   | column 3  |
+------------+------------+-----------+
| body row 2 | Cells may span columns.|
+------------+------------+-----------+
| body row 3 | Cells may  | - Cells   |
+------------+ span rows. | - contain |
| body row 4 |            | - blocks. |
+------------+------------+-----------+
</pre></div>
</div>
<p>普通表格 生成:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="34%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Header 1</th>
<th class="head">Header 2</th>
<th class="head">Header 3</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>body row 1</td>
<td>column 2</td>
<td>column 3</td>
</tr>
<tr class="row-odd"><td>body row 2</td>
<td colspan="2">Cells may span columns.</td>
</tr>
<tr class="row-even"><td>body row 3</td>
<td rowspan="2">Cells may
span rows.</td>
<td rowspan="2"><ul class="first last simple">
<li>Cells</li>
<li>contain</li>
<li>blocks.</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>body row 4</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id18">
<h7>简单表格<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h7>
<p><em>注意:</em> 表格包含中文时,基本无法对齐,,,</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>=====  =====  ======
   Inputs     Output
------------  ------
  A      B    A or B
=====  =====  ======
False  False  False
True   False  True
False  True   True
True   True   True
=====  =====  ======
</pre></div>
</div>
<p>简单表格  生成:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="31%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Inputs</th>
<th class="head">Output</th>
</tr>
<tr class="row-even"><th class="head">A</th>
<th class="head">B</th>
<th class="head">A or B</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="row-even"><td>True</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="row-odd"><td>False</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="row-even"><td>True</td>
<td>True</td>
<td>True</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="csv">
<h7>CSV 表格<a class="headerlink" href="#csv" title="永久链接至标题">¶</a></h7>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. csv-table:: Frozen Delights!
 :header: &quot;Treat&quot;, &quot;Quantity&quot;, &quot;Description&quot;
 :widths: 15, 10, 30

 &quot;Albatross&quot;, 2.99, &quot;On a stick!&quot;
 &quot;Crunchy Frog&quot;, 1.49, &quot;If we took the bones out, it wouldn&#39;t be
 crunchy, now would it?&quot;
 &quot;Gannet Ripple&quot;, 1.99, &quot;On a stick!&quot;
</pre></div>
</div>
<p>CSV 表格生成:</p>
<table border="1" class="colwidths-given docutils" id="id24">
<caption><span class="caption-text">Frozen Delights!</span><a class="headerlink" href="#id24" title="永久链接至表格">¶</a></caption>
<colgroup>
<col width="27%" />
<col width="18%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Treat</th>
<th class="head">Quantity</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Albatross</td>
<td>2.99</td>
<td>On a stick!</td>
</tr>
<tr class="row-odd"><td>Crunchy Frog</td>
<td>1.49</td>
<td>If we took the bones out, it wouldn&#8217;t be
crunchy, now would it?</td>
</tr>
<tr class="row-even"><td>Gannet Ripple</td>
<td>1.99</td>
<td>On a stick!</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id19">
<h7>列表表格<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h7>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. list-table:: Frozen Delights!
  :widths: 15 10 30
  :header-rows: 1

  * - Treat
    - Quantity
    - Description
  * - Albatross
    - 2.99
    - On a stick!
  * - Crunchy Frog
    - 1.49
    - If we took the bones out, it wouldn&#39;t be
      crunchy, now would it?
  * - Gannet Ripple
    - 1.99
    - On a stick!
</pre></div>
</div>
<p>列表表格 生成:</p>
<table border="1" class="colwidths-given docutils" id="id25">
<caption><span class="caption-text">Frozen Delights!</span><a class="headerlink" href="#id25" title="永久链接至表格">¶</a></caption>
<colgroup>
<col width="27%" />
<col width="18%" />
<col width="55%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Treat</th>
<th class="head">Quantity</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Albatross</td>
<td>2.99</td>
<td>On a stick!</td>
</tr>
<tr class="row-odd"><td>Crunchy Frog</td>
<td>1.49</td>
<td>If we took the bones out, it wouldn&#8217;t be
crunchy, now would it?</td>
</tr>
<tr class="row-even"><td>Gannet Ripple</td>
<td>1.99</td>
<td>On a stick!</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="rst">
<h6>rST排版技巧<a class="headerlink" href="#rst" title="永久链接至标题">¶</a></h6>
<div class="section" id="id20">
<h7>跨章节指引<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h7>
<ul class="simple">
<li>行文中,经常要对其它章节进行指引,在 html 中对应的就是 锚点链接</li>
<li><dl class="first docutils">
<dt>rST 中提供了非常优雅的解决:</dt>
<dd><ul class="first last">
<li>使用通用元素定义</li>
<li>比如説:</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>各个章节的首页一般是 index.rst
头一行,习惯性加个聲明:
.. _chapter6index:

那么,在其它任意文本中,随时可以使用:
:ref:`构建 buzz &lt;chapter6index&gt;`
来生成一个指向第二章 首页的链接!
</pre></div>
</div>
</div>
<div class="section" id="id21">
<h7>插图/表格指代<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h7>
<ul class="simple">
<li>行文中,经常对指定插图/表格 进行指代</li>
<li><dl class="first docutils">
<dt>rST 中提供了非常优雅的解决:</dt>
<dd><ul class="first last">
<li>进行通用元素定义</li>
<li>比如说</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>.. _fig_0601:
.. figure:: ../_static/figs/magic-2.png

   插图 6-1 神奇的2
</pre></div>
</div>
<p>然后,就可以在任意地方使用 <a class="reference internal" href="#fig-0601"><span>插图 6-1 神奇的2</span></a> 来指代,
实际输出的就是 &#8220;插图 6-1 神奇的2&#8221;</p>
<div class="figure" id="id26">
<span id="fig-0601"></span><img alt="_images/magic-2.png" src="_images/magic-2.png" />
<p class="caption"><span class="caption-text">插图 6-1 神奇的2</span></p>
</div>
</div>
<div class="section" id="id22">
<h7>上下标号<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h7>
<p>有时要进行数学/化学的表示,在 html 中就需要上/下标( <code class="xref py py-obj docutils literal"><span class="pre">&lt;sub&gt;</span></code> , <code class="xref py py-obj docutils literal"><span class="pre">&lt;sup&gt;</span></code>) 的表达,
rST 中当然也有:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>H\ :sub:`2`\ O
E = mc\ :sup:`2`
</pre></div>
</div>
<p>效果:</p>
<p>H<sub>2</sub>O</p>
<p>E = mc<sup>2</sup></p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p>注意:</p>
<p class="last">这里的 只是为了制造语法空间,输出时,是没有空格的了,,,</p>
</div>
</div>
</div>
<div class="section" id="id23">
<h6>段落层次约定<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h6>
<p>使用</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>共分4级
=======================
大标题
=======================


-----------------------
小标题
-----------------------


^^^^^^^^^^^^^^^^^^^^^^^
二级标题
^^^^^^^^^^^^^^^^^^^^^^^


&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
三级标题
&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
</pre></div>
</div>
<p>再小，就使用列表!:</p>
<blockquote>
<div><ul class="simple">
<li>列表项目1</li>
<li>列表项目2</li>
<li>...</li>
</ul>
</div></blockquote>
</div>
</div>
<span id="document-skillstack/shell"></span><div class="section" id="unix-linux-shell">
<span id="shell"></span><h5>Unix/Linux 常用 shell 命令<a class="headerlink" href="#unix-linux-shell" title="永久链接至标题">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">作者:</th><td class="field-body">王然 <a class="reference external" href="mailto:kxxoling&#37;&#52;&#48;gmail&#46;com">kxxoling<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="id1">
<h6>简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p>shell 是 Unix/Linux 上常见的用户与计算机的交互接口，根据用户输入执行系统命令。
现如今，主流 Linux 发行版中默认的 shell 多是 bash。</p>
<p>开发服务器上使用的 shell 也是 bash，并安装了一些第三方命令和自己编写的批处理命令。</p>
</div>
<div class="section" id="sh">
<h6>常用 sh 命令及操作<a class="headerlink" href="#sh" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>table 键自动补全</li>
<li>ls 列出目录</li>
<li>ls -al 使用格式化列出隐藏文件</li>
<li>pwd 显示当前目录</li>
<li>cd &lt;dir&gt; 切换到 dir 目录</li>
<li>cd 切换到 home 目录</li>
<li>cd .. 切换到父目录</li>
<li>mkdir &lt;dir&gt; 创建目录</li>
<li>touch &lt;file&gt; 创建文件</li>
<li>cat &lt;file&gt; 显示文件内容</li>
<li>less &lt;file&gt; 逐页显示文件内容</li>
<li>more &lt;file&gt;</li>
<li>head &lt;file&gt; 显示文件头 10 行</li>
<li>tail &lt;file&gt; 显示文件后 10 行</li>
<li>tail -f &lt;file&gt; 从后 10 行开始查看文件内容</li>
<li>ctrl+c 结束程序</li>
<li>ctrl+z 停止当前程序，可使用 fg 恢复</li>
<li>ctrl+w 删除当前行中文字</li>
<li>ctrl+u 删除整行文字</li>
<li>ctrl+a/e 将光标移动至行首/尾</li>
<li>ctrl+r 搜索最近使用的命令</li>
<li>bg 列出已停止或者后台程序</li>
<li>fg 将最近作业带到前台</li>
<li>locate &lt;file&gt; 查找某个文件所在位置</li>
</ul>
</div>
<div class="section" id="id2">
<h6>常用第三方命令<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>tree 以树形显示当前目录结构</p>
<ul class="simple">
<li>tree 以树形结构显示当前目录下所有文件和目录</li>
<li>tree -d 仅显示目录</li>
<li>tree -L &lt;num&gt; 限制目录的最大深度</li>
</ul>
<p>ag 搜索</p>
<ul class="simple">
<li>ag &lt;something&gt; 在目录所有文件中寻找 something</li>
<li>ag &lt;something&gt; &lt;&#8211;python&gt; 在所有 Python 文件中搜索 something</li>
</ul>
<p><code class="xref py py-obj docutils literal"><span class="pre">autojump</span></code></p>
<ul class="simple">
<li>j &lt;dir&gt; 根据最近工作目录记录跳转到最合适的位置。</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-devtools/index"></span><div class="section" id="id1">
<h4>开发工具<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-devtools/hg"></span><div class="section" id="hg">
<span id="id1"></span><h5>hg 简明教程<a class="headerlink" href="#hg" title="永久链接至标题">¶</a></h5>
<p>作者: 王然 <a class="reference external" href="mailto:kxxoling&#37;&#52;&#48;gmail&#46;com">kxxoling<span>&#64;</span>gmail<span>&#46;</span>com</a></p>
<div class="section" id="id2">
<h6>关于 hg<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>hg 即 Mercurial，是一个跨平台的分布式版本控制软件，主要由Python语言实现，
但也包含一个用C语言实现的二进制比较工具。其使用方式即原理与 git 相似，
如果你已经有 git 使用经验，可以访问
<a class="reference external" href="http://www.worldhello.net/2011/03/10/2370.html">git 和 hg 面对面</a></p>
</div>
<div class="section" id="id3">
<h6>hg 基本流程<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<p>以 42web <a class="reference external" href="https://bitbucket.org/z42/z42">https://bitbucket.org/z42/z42</a> 为例，演示 hg 开发流程。</p>
<ol class="arabic">
<li><dl class="first docutils">
<dt>从远程仓库复制到本地</dt>
<dd><p class="first">https 协议从远程仓库获取代码:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg clone https://bitbucket.org/z42/z42
</pre></div>
</div>
<p>或者也可以通过 ssh 协议:</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>hg clone ssh://hg@bitbucket.org/z42/z42
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p class="first">添加新创建的文件:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg add file_name
</pre></div>
</div>
</li>
<li><p class="first">修改本地代码并提交</p>
<blockquote>
<div><p>保存修改后，提交本地代码：:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg commit -m &quot;change log&quot;
</pre></div>
</div>
<p>或者也可以简写为：:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg ci -m &quot;change log&quot;
</pre></div>
</div>
<p>-m 表示关于本次提交的相关信息</p>
<p>commit 时 hg 会自动 add 代码库中已修改的文件。</p>
</div></blockquote>
</li>
<li><p class="first">提交到远程仓库前，首先检查远程代码状态</p>
<blockquote>
<div><p>可以使用 hg diff branches 查看不同分支间差异</p>
<p>使用 hg fetch 命令从其它分支拉取代码并合并，如合并代码出现问题，
需要手动合并后再提交。</p>
</div></blockquote>
</li>
<li><p class="first">将代码提交到远程仓库:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg push
</pre></div>
</div>
</li>
<li><p class="first">发起 pull request</p>
<blockquote>
<div><p>在 <a class="reference external" href="https://bitbucket.org">https://bitbucket.org</a>/你的用户名/项目名/pull-request/new 发起一个新的 pull request</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id4">
<h6>解决冲突<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<p>在 fetch 他人代码的时候，时常会遇到合并冲突的问题，因为有可能两人同时修改了同一个文件，这时需要先解决冲突（直接修改有冲突的文件），解决冲突后将其标注为已解决:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg resolve -m file.name
</pre></div>
</div>
</div>
<div class="section" id="tips">
<h6>Tips<a class="headerlink" href="#tips" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>向版本库添加/删除文件 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">add/rm</span></code></li>
<li>移动版本库中的文件 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">mv</span></code></li>
<li>查找某段代码的责任人 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">blame</span></code></li>
<li>从现有代码初始化版本仓库 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">init</span></code></li>
<li>建立 hg 服务器 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">serve</span></code></li>
<li>更新代码库至最新提交 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">update</span></code></li>
<li>切换至分支 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">update</span> <span class="pre">-r</span></code></li>
<li>放弃所有修改，返回至上一个提交 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">update</span> <span class="pre">-C</span></code></li>
<li>搜索 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">grep</span></code></li>
<li>放弃某个文件的修改 <code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">revert</span></code></li>
</ul>
</div>
<div class="section" id="id5">
<h6>分支命名规则<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<p>命名示例： * bug/index_page * feature/founder_page</p>
<p>分支的目的如果是 bug 修复以 <code class="docutils literal"><span class="pre">bug/</span></code> 作为开头；同理，新需求则以
<code class="docutils literal"><span class="pre">feature/</span></code> 开头。这样能够明显地区分需求与 bug，并且以 <code class="docutils literal"><span class="pre">/</span></code>
为分隔符能够得到 SourceTree 这样的图形化版本控制工具更好的支持。</p>
<p>分支名中不需要添加创建者，因为一个分支通常会有多个开发者（一个前端一个后端）同时使用。</p>
</div>
<div class="section" id="id6">
<h6>内部 Hg 服务器<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<p>公司内部基于 <a class="reference external" href="https://kallithea-scm.org/">Kallithea</a> 开源系统搭建了一套 Hg web
服务，内网配置 DNS 后可访问 <a class="reference external" href="http://hg.pe.vc/">hg.pe.vc</a> 注册账号并 fork 所需要的项目。
使用流程如下：</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://hg.pe.vc/_admin/register">注册</a> 并联系管理员激活</li>
<li>登录并 <a class="reference external" href="http://hg.pe.vc/_admin/repo_groups/new">添加项目组</a> 。</li>
<li>前往 <code class="docutils literal"><span class="pre">http://hg.pe.vc/&lt;项目名&gt;/fork</span></code> 页面 fork 相应的项目。</li>
</ol>
<p>其余操作和 GitHub、BitBucket 并无显著区别。</p>
<div class="section" id="id9">
<h7>配置 Hg 记住密码功能<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h7>
<p>通过 Hg HTTP 协议操作项目时，往往需要重复输入密码，不像 ssh 方式便捷，可以通过插件实现 Hg 记住密码功能：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>pip install mercurial_keyring
</pre></div>
</div>
<p>在 <code class="xref py py-obj docutils literal"><span class="pre">hgrc</span></code> 文件后写入：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="o">[</span>extensions<span class="o">]</span>
<span class="nv">mercurial_keyring</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h6>扩展阅读<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="http://doc.42qu.com/tool/hg.html">Hg－42 区漫游指南</a></p>
<p><a class="reference external" href="http://www.worldhello.net/2011/03/10/2370.html">git 和 hg 面对面</a></p>
<p><a class="reference external" href="http://bucunzai.net/hginit/">HgInit 中文版</a></p>
</div>
</div>
<span id="document-devtools/ipython"></span><div class="section" id="ipython">
<span id="id1"></span><h5>IPython 用法<a class="headerlink" href="#ipython" title="永久链接至标题">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">作者:</th><td class="field-body">王然 <a class="reference external" href="mailto:kxxoling&#37;&#52;&#48;gmail&#46;com">kxxoling<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="id2">
<h6>启动<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>启动IPython就是运行可执行文件ipython。你会看到一个提示符，如果你曾经玩过标准Python命令行提示符，你会发现这个有点儿不同:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[jjones@cerberus ~]$ /usr/local/python24/bin/ipython
Python 2.4 (#2, Nov 30 2004, 09:22:54)
Type &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.

IPython 0.6.6 -- An enhanced Interactive Python.
? -&gt; Introduction to IPython&#39;s features.
%magic -&gt; Information about IPython&#39;s &#39;magic&#39; % functions.
help -&gt; Python&#39;s own help system.
object? -&gt; Details about &#39;object&#39;. ?object also works, ?? prints more.

In [1]:
</pre></div>
</div>
<p>要退出IPython（Linux系统上）就输入Ctrl-D（会要求你确认），也可以输入Exit或Quit（注意大小写）退出而不需要确认。</p>
</div>
<div class="section" id="id3">
<h6>特性<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<div class="section" id="magic">
<h7>Magic<a class="headerlink" href="#magic" title="永久链接至标题">¶</a></h7>
<p>IPython有一些&#8221;magic&#8221;关键字:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>%Exit, %Pprint, %Quit, %alias, %autocall, %autoindent, %automagic,
%bookmark, %cd, %color_info, %colors, %config, %dhist, %dirs, %ed,
%edit, %env, %hist, %logoff, %logon, %logstart, %logstate, %lsmagic,
%macro, %magic, %p, %page, %pdb, %pdef, %pdoc, %pfile, %pinfo, %popd,
%profile, %prun, %psource, %pushd, %pwd, %r, %rehash, %rehashx, %reset,
%run, %runlog, %save, %sc, %sx, %system_verbose, %unalias, %who,
%who_ls, %whos, %xmode
</pre></div>
</div>
<p>IPython 会检查传给它的命令是否包含magic关键字。如果命令是一个magic关键字，IPython就自己来处理。如果不是magic关键字，就交给 Python（标准解释器）去处理。如果automagic打开（默认），你不需要在magic关键字前加%符号。相反，如果automagic是关闭的，则%是必须的。在命令提示符下输入命令magic就会显示所有magic关键字列表以及它们的简短的用法说明。良好的文档对于一个软件的任何一部分来说都是重要的，从在线IPython用户手册到内嵌文档（%magic），IPython当然不会在这方面有所缺失。</p>
</div>
<div class="section" id="tab">
<h7>Tab自动补全<a class="headerlink" href="#tab" title="永久链接至标题">¶</a></h7>
<p>IPython一个非常强大的功能是tab自动补全。如果你对Python很了解，可能会想，标准Python交互式解释器也可以tab自动补全啊。你要做的只是:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[jjones@cerberus ~]$ /usr/local/python24/bin/python
Python 2.4 (#2, Nov 30 2004, 09:22:54)
[GCC 3.4.2 20041017 (Red Hat 3.4.2-6.fc3)] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import rlcompleter, readline
&gt;&gt;&gt; readline.parse_and_bind(&#39;tab: complete&#39;)
&gt;&gt;&gt;
</pre></div>
</div>
<p>是的，标准Python交互式解释器和IPython都支持“普通”自动补全和菜单补全。使用自动补全，你要先输入一个匹配模型，然后按Tab键。如果是“普通”自动补全模式（默认），Tab后会：</p>
<ul class="simple">
<li>匹配模型按最大匹配展开。</li>
<li>列出所有匹配的结果。</li>
</ul>
<p>例如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [1]: import os
In [2]: os.po
os.popen os.popen2 os.popen3 os.popen4
In [2]: os.popen
</pre></div>
</div>
<p>输入os.po然后按Tab键，os.po被展开成os.popen（就象在In [2]:提示符显示的那样），并显示os所有以po开头的模块，类和函数，它们是popen，popen2， popen3和popen4。</p>
<dl class="docutils">
<dt>菜单补全稍有不同。关闭默认Tab补全，使用菜单补全，你需要修改配置文件$HOME/.ipython/ipythonrc。注释掉：</dt>
<dd>readline_parse_and_bind tab: complete</dd>
<dt>取消注释:</dt>
<dd>readline_parse_and_bind tab: menu-complete</dd>
</dl>
<p>不同于“普通”自动补全的显示当前命令所有匹配列表，菜单补全会随着你每按一次Tab键而循环显示匹配列表中的项目。例如:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [1]: import os
In [2]: os.po
</pre></div>
</div>
<p>结果是：</p>
<blockquote>
<div>In [3]: os.popen</div></blockquote>
<p>接下来每次按Tab键就会循环显示匹配列表中的其它项目：popen2，popen3，popen4，最后回到po。菜单补全模式下查看所有匹配列表的快捷键是Ctrl-L:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [2]: os.po
os.popen os.popen2 os.popen3 os.popen4
In [2]: os.po
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h7>自省<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h7>
<p>Python有几个内置的函数用于自省。IPython不仅可以调用所有标准Python函数，对于那些Python shell内置函数同样适用。典型的使用标准Python shell进行自省是使用内置的dir()函数:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&gt;&gt;&gt; import SimpleXMLRPCServer
&gt;&gt;&gt; dir(SimpleXMLRPCServer.SimpleXMLRPCServer)
[&#39;__doc__&#39;, &#39;__init__&#39;, &#39;__module__&#39;, &#39;_dispatch&#39;,
&#39;_marshaled_dispatch&#39;, &#39;address_family&#39;, &#39;allow_reuse_address&#39;,
&#39;close_request&#39;, &#39;fileno&#39;, &#39;finish_request&#39;, &#39;get_request&#39;,
&#39;handle_error&#39;, &#39;handle_request&#39;, &#39;process_request&#39;,
&#39;register_function&#39;, &#39;register_instance&#39;,
&#39;register_introspection_functions&#39;, &#39;register_multicall_functions&#39;,
&#39;request_queue_size&#39;, &#39;serve_forever&#39;, &#39;server_activate&#39;, &#39;server_bind&#39;,
&#39;server_close&#39;, &#39;socket_type&#39;, &#39;system_listMethods&#39;,
&#39;system_methodHelp&#39;, &#39;system_methodSignature&#39;, &#39;system_multicall&#39;,
&#39;verify_request&#39;]
</pre></div>
</div>
<p>嗯，非常棒。事实上非常实用。几年来我一直这么做，对此非常满意。这是一个漂亮的列表，包含了 SimpleXMLRPCServer.SimpleXMLRPCServer的所有方法，类，模块等等。因为dir()是一个内置函数，在 IPython中也能很好的使用它们。但是IPython的操作符?和??功能还要强大:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [1]: import SimpleXMLRPCServer

In [2]: ? SimpleXMLRPCServer.SimpleXMLRPCServer
Type: classobj
String Form: SimpleXMLRPCServer.SimpleXMLRPCServer
Namespace: Interactive
File: /usr/local/python24/lib/python2.4/SimpleXMLRPCServer.py
Docstring:
Simple XML-RPC server.

Simple XML-RPC server that allows functions and a single instance
to be installed to handle requests. The default implementation
attempts to dispatch XML-RPC calls to the functions or instance
installed in the server. Override the _dispatch method inherited
from SimpleXMLRPCDispatcher to change this behavior.

Constructor information:
Definition: SimpleXMLRPCServer.SimpleXMLRPCServer(self, addr,
requestHandler=, logRequests=1)
</pre></div>
</div>
<p>? 操作符会截断长的字符串。相反，?? 不会截断长字符串，如果有源代码的话还会以语法高亮形式显示它们。</p>
</div>
<div class="section" id="id5">
<h7>历史<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h7>
<p>当你在IPython shell下交互的输入了大量命令，语句等等，就象这样:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [1]: a = 1

In [2]: b = 2

In [3]: c = 3

In [4]: d = {}

In [5]: e = []

In [6]: for i in range(20):
...: e.append(i)
...: d[i] = b
...:
</pre></div>
</div>
<p>你可以快速查看那些输入的历史记录:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [7]: hist
1: a = 1
2: b = 2
3: c = 3
4: d = {}
5: e = []
6:
for i in range(20):
e.append(i)
d[i] = b
</pre></div>
</div>
<p>要去掉历史记录中的序号（这里是1至6），使用命令hist -n:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [8]: hist -n
a = 1
b = 2
c = 3
d = {}
e = []
for i in range(20):
e.append(i)
d[i] = b
</pre></div>
</div>
<p>这样你就可以方便的将代码复制到一个文本编辑器中。要在历史记录中搜索，可以先输入一个匹配模型，然后按Ctrl-P。找到一个匹配后，继续按Ctrl-P会向后搜索再上一个匹配，Ctrl-N则是向前搜索最近的匹配。</p>
</div>
</div>
<div class="section" id="id6">
<h6>编辑<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<p>当在Python提示符下试验一个想法时，经常需要通过编辑器修改源代码（甚至是反复修改）。在IPython下输入edit就会根据环境变量$EDITOR调用相应的编辑器。如果$EDITOR为空，则会调用vi（Unix）或记事本（Windows）。要回到IPython提示符，直接退出编辑器即可。如果是保存并退出编辑器，输入编辑器的代码会在当前名字空间下被自动执行。如果你不想这样，使用edit -x。如果要再次编辑上次最后编辑的代码，使用edit -p。在上一个特性里，我提到使用hist -n可以很容易的将代码拷贝到编辑器。一个更简单的方法是edit加Python列表的切片（slice）语法。假定hist输出如下:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [29]: hist
1 : a = 1
2 : b = 2
3 : c = 3
4 : d = {}
5 : e = []
6 :
for i in range(20):
e.append(i)
d[i] = b

7 : %hist
</pre></div>
</div>
<p>现在要将第4，5，6句代码导出到编辑器，只要输入：</p>
<blockquote>
<div>edit 4:7</div></blockquote>
<div class="section" id="debugger">
<h7>Debugger接口<a class="headerlink" href="#debugger" title="永久链接至标题">¶</a></h7>
<p>IPython 的另一特性是它与Python debugger的接口。在IPython shell下输入magic关键字pdb就会在产生一个异常时自动开关debugging功能。在自动pdb呼叫启用的情况下，当Python遇到一个未处理的异常时Python debugger就会自动启动。你在debugger中的当前行就是异常发生的那一行。IPython的作者说有时候当他需要在某行代码处debug时，他会在开始debug的地方放一个表达式1/0。启用pdb，在IPython中运行代码。当解释器处理到1/0那一行时，就会产生一个 ZeroDivisionError异常，然后他就在指定的代码处被带到一个debugging session中了。</p>
</div>
<div class="section" id="id7">
<h7>运行<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h7>
<p>有时候当你在一个交互式shell中时，如果可以运行某个源文件中的内容将会很有用。运行magic关键字run带一个源文件名就可以在IPython解释器中运行一个文件了（例如run &lt;源文件&gt; &lt;运行源文件所需参数&gt;）。参数主要有以下这些：</p>
<ul>
<li><p class="first">-n 阻止运行源文件代码时__name__变量被设为&#8221;__main__&#8221;。这会防止</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>if __name__ == &quot;__main__&quot;:
</pre></div>
</div>
<p>块中的代码被执行</p>
</li>
<li><p class="first">-i 源文件就在当前IPython的名字空间下运行而不是在一个新的名字空间中。如果你需要源代码可以使用在交互式session中定义的变量就会很有用。</p>
</li>
<li><p class="first">-p 使用Python的profiler模块运行并分析源代码。使用该选项代码不会运行在当前名字空间。</p>
</li>
</ul>
</div>
<div class="section" id="id8">
<h7>宏<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h7>
<p>宏允许用户为一段代码定义一个名字，这样你可以在以后使用这个名字来运行这段代码。就象在magic关键字edit中提到的，列表切片法也适用于宏定义。假设有一个历史记录如下:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [3]: hist
1: l = []
2:
for i in l:
print i
</pre></div>
</div>
<p>你可以这样来定义一个宏：</p>
<blockquote>
<div>In [4]: macro print_l 2
Macro <code class="xref py py-obj docutils literal"><span class="pre">print_l</span></code> created. To execute, type its name (without quotes).
Macro contents:
for i in l:
print i</div></blockquote>
<p>运行宏:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [5]: print_l
Out[5]: Executing Macro...
</pre></div>
</div>
<p>在这里，列表l是空的，所以没有东西被输出。但这其实是一个很强大的功能，我们可以赋予列表l某些实际值，再次运行宏就会看到不同的结果:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>In [6]: l = range(5)

In [7]: print_l
Out[7]: Executing Macro...
0
1
2
3
4
</pre></div>
</div>
<p>当运行一个宏时就好象你重新输入了一遍包含在宏print_1中的代码。它还可以使用新定义的变量l。由于Python语法中没有宏结构（也许永远也不会有），在一个交互式shell中它更显得是一个有用的特性。</p>
</div>
</div>
<div class="section" id="profiles">
<h6>环境（Profiles）<a class="headerlink" href="#profiles" title="永久链接至标题">¶</a></h6>
<p>就象早前提到的那样，IPython安装了多个配置文件用于不同的环境。配置文件的命名规则是ipythonrc-。要使用特定的配置启动IPython，需要这样</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ipython -p
</pre></div>
</div>
<p>一个创建你自己环境的方法是在$HOME/.ipython目录下创建一个IPython配置文件，名字就叫做ipythonrc- ，这里是你想要的环境的名字。如果你同时进行好几个项目，而这些项目又用到互不相同的特殊的库，这时候每个项目都有自己的环境就很有用了。你可以为每个项目建立一个配置文件，然后在每个配置文件中import该项目中经常用到的模块。</p>
</div>
<div class="section" id="shell">
<h6>使用操作系统的Shell<a class="headerlink" href="#shell" title="永久链接至标题">¶</a></h6>
<p>使用默认的IPython配置文件，有几个Unix Shell命令（当然，是在Unix系统上），cd，pwd和ls都能象在bash下一样工作。运行其它的shell命令需要在命令前加!或!!。使用magic关键字%sc和%sx可以捕捉shell命令的输出。</p>
<p>pysh环境可以被用来替换掉shell。使用-p pysh参数启动的IPython，可以接受并执行用户$PATH中的所有命令，同时还可以使用所有的Python模块，Python关键字和内置函数。例如，我想要创建500个目录，命名规则是从d_0_d到d_500_d（译注：呵呵，作者这里犯了个小小的计算错误，你能看出来吗），我可以使用-p pysh启动IPython，然后就象这样:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>jjones@cerberus[foo]|2&gt; for i in range(500):
|.&gt; mkdir d_${i}_d
|.&gt;
</pre></div>
</div>
<p>这就会创建500个目录:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>jjones@cerberus[foo]|8&gt; ls -d d* | wc -l
500
</pre></div>
</div>
<p>注意这里混合了Python的range函数和Unix的mkdir命令。</p>
<p>注意，虽然ipython -p pysh提供了一个强大的shell替代品，但它缺少正确的job控制。在运行某个很耗时的任务时按下Ctrl-z将会停止IPython session而不是那个子进程。</p>
</div>
<div class="section" id="id9">
<h6>问题和方法<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<p>虽然作为标准Python shell的替换，IPython总的来说很完美。还是有两个问题给我带来了一些麻烦。感谢IPython的开发者，这两个问题都可以通过配置来解决，每个配置都有清晰的文档。</p>
<p>第一个问题是关于颜色的。在我的一个系统上，我使用的是一个白色背景的xterm。当我使用?和??查询一个对象或模块的信息时，对象的定义会被显示，但看起来好象那些参数丢失了。那是因为在构造函数中的的参数默认显示为白色。我的解决办法是在IPython shell中输入colors LightBG。</p>
<p>第二个问题是关于自动缩进和代码粘贴的。如果autoindent被启用，IPython会对我粘贴的已排好缩进的代码再次应用缩进。例如下面的代码:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>for i in range(10):
for j in range(10):
for k in range(10):
pass
</pre></div>
</div>
<p>会变成:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>for i in range(10):
for j in range(10):
for k in range(10):
pass
</pre></div>
</div>
<p>在这里它并不是个问题，因为在它自身中缩进都保持一致。在其它一些情况下（例子一下子举不出来了），可能会成为真正的问题。可以使用magic关键字autoindent来开关自动缩进，告诉IPython不要添加多余的缩进──就象在vim中设置粘贴set paste一样。</p>
</div>
<div class="section" id="id10">
<h6>结论<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<p>IPython 并不是囗囗性的，也不是完全创新的。Tab自动补全，历史记录搜索，配置环境，配置文件等都早已在其它shells中存在有些年头了。Python拥有各种级别的自省能力也有一段时间了。但IPython把来自成熟的Unix shell，标准Python shell以及Python语言中的一些最强大的功能整合到了一起。产生出了一个强大的令人难以置信的性能增强工具，我想我会很乐意在接下来的几年中一直使用它。套用阿基米德的话来说，给我一个强大而又灵活的文本编辑器（vim），一个交互式shell（IPython）以及一个语言（Python），我就能撬动整个世界。</p>
</div>
</div>
<span id="document-devtools/other"></span><div class="section" id="other-dev-tools">
<span id="id1"></span><h5>其它开发工具<a class="headerlink" href="#other-dev-tools" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><dl class="first docutils">
<dt>开发工具</dt>
<dd><ul class="first last">
<li>bitbucket</li>
<li>iTerm2</li>
<li>xshell</li>
<li>filezilla</li>
<li>Grunt</li>
<li>Firefox<ul>
<li>firebug</li>
<li>scrapbook</li>
</ul>
</li>
<li>sip(Mac)</li>
<li>Postman</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<span id="document-devtools/vim"></span><div class="section" id="vim">
<span id="vim-tutorial"></span><h5>vim 快速入门<a class="headerlink" href="#vim" title="永久链接至标题">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">作者:</th><td class="field-body">王然 <a class="reference external" href="mailto:kxxoling&#37;&#52;&#48;gmail&#46;com">kxxoling<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
</tbody>
</table>
<div class="section" id="id1">
<h6>vim 简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p>在这个蔚蓝色的星球上，流传着两大神器的传说：Emacs是神的编辑器，而Vim是编辑器之神。</p>
<p>VIM , 全称 Vi Improved , Vi的增强版 。</p>
<p>Vi 在 1976 年发布，奉行 Unix 传统的“Do one thing and do it well”哲学，每个程序只做一件事但做到最好，通过程序之间的配合得到强大的功能。</p>
<p>Emacs则奉行“Everything at reach”设计哲学，通过强大的扩展性，达到在一个软件里做所有的事。Emacs可以用来编辑文档、时间管理、浏览图片、阅读pdf、听音乐、写程序、运行程序、调试程序、接受发送邮件、看新闻组、玩游戏、管理系统、Telnet/FTP、版本控制、写LaTex…被称为“伪装成编辑器的操作系统”。</p>
<p>江湖中有一句话: “ 世界上的程序员分三种，一种使用Emacs，一种使用Vim，剩余的是其它” 。</p>
</div>
<div class="section" id="id2">
<h6>基本概念<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>Vim 有两种模式——Normal 模式和 Insert 模，所有命令都是在 Normal 模式下执行。启动 Vim 后，默认进入 Normal 模式，
可以按 <code class="xref py py-obj docutils literal"><span class="pre">i</span></code> 键进入 Insert 模式，或者 <code class="xref py py-obj docutils literal"><span class="pre">s</span></code> 删除当前字符并进入 Insert 模式，退出 Insert 模式进入 Normal 按 <code class="xref py py-obj docutils literal"><span class="pre">ESC</span></code> 。</p>
<p>下面的教程中约定 + 表示同时按其左右的按键，小写字母（如 i）表示按该字母一次，大写字母（如 G）表示同时按 shift+g。</p>
</div>
<div class="section" id="id3">
<h6>基本用法<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>i insert 输入</li>
<li>v 行选中</li>
<li>ctrl+v 列选中</li>
<li>G 至文末</li>
<li>gg 至文首</li>
<li>:q 未修改退出</li>
<li>:q! 强制不保存退出</li>
<li>:x / :wq 保存并退出</li>
<li>J 合并多行</li>
<li>d 删除当前所选</li>
<li>dd 删除多行并存在剪贴板中（剪切）</li>
<li>y 复制当前所选</li>
<li>yy 复制整行</li>
<li>p 粘贴</li>
<li>u 撤销操作</li>
<li>w 光标移动到下一个单词处</li>
<li>b 光标移动到上一个单词处</li>
<li>^ 光标移动到行首</li>
<li>$ 光标移动到行尾</li>
<li>kjhl 或者上下左右键移动光标</li>
<li>shift+上下键 翻页</li>
<li>shift+左右 光标乙至上/下一个单词（以空格/标点区分单词）词首</li>
<li>u 撤销上一步操作</li>
<li>zo/zn/zc 折叠/展开代码块</li>
<li>:vsp 新建工作区</li>
<li>ctrl+w 松手后再按 <code class="xref py py-obj docutils literal"><span class="pre">方向键</span></code> 切换工作区</li>
<li>:MR 选择最近打开的文件（需安装插件）</li>
<li>F12 运行当前文件</li>
<li># 搜索光标处短语</li>
<li>:set paste 进入粘贴模式</li>
<li>:%s/target/something/g 替换全部 target 字段</li>
<li>:s/target/something/g 替换选中区域 target 字段</li>
</ul>
</div>
<div class="section" id="id4">
<h6>组合用法<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<p>注释大段文字</p>
<ul class="simple">
<li>光标移至行首</li>
<li>I 进入插入模式</li>
<li>输入注释符号</li>
<li>双击 <code class="xref py py-obj docutils literal"><span class="pre">ESC</span></code></li>
</ul>
</div>
<div class="section" id="id5">
<h6>如何配置<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="https://github.com/yangyangwithgnu/use_vim_as_ide">VIM as an IDE</a></p>
</div>
<div class="section" id="id6">
<h6>进阶文档<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="//css42.42qu.us/school/简明Vim练级攻略.pdf">简明 Vim 练级攻略</a></p>
</div>
<div class="section" id="id8">
<h6>vim名词解释<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<div class="section" id="id9">
<h7>模式<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h7>
<p>vim有5中基本模式，分别是</p>
<ul class="simple">
<li>Normal Mode 也就是最一般的普通模式，默认进入vim之后，处于这种模式。</li>
<li>Visual Mode 一般译作可视模式，在这种模式下选定一些字符、行、多列。
在普通模式下，可以按v进入。</li>
<li>Insert Mode
插入模式，其实就是指处在编辑输入的状态。普通模式下，可以按i进入。</li>
<li>Select Mode
在gvim下常用的模式，可以叫作选择模式吧。用鼠标拖选区域的时候，就进入了选择模式。
和可视模式不同的是，在这个模式下，选择完了高亮区域后，敲任何按键就直接输入并替换选择的文本了。
和windows下的编辑器选定编辑的效果一致。普通模式下，可以按gh进入。
ps:这种模式好无用啊</li>
<li>Command-Line/Ex Mode
就叫命令行模式和Ex模式吧。两者略有不同，普通模式下按冒号(:)进入Command-Line模式，可以输入各种命令，
使用vim的各种强大功能。普通模式下按Q进入Ex模式，其实就是多行的Command-Line模式。
ps:经常使用EX模式的都是神阶vimer</li>
</ul>
<p><em>注：本文中所说的快捷键若无特殊说明则是Normal Mode下的模式</em></p>
</div>
<div class="section" id="windows">
<h7>Windows/窗口<a class="headerlink" href="#windows" title="永久链接至标题">¶</a></h7>
<p>vim可以将窗口分成好多个独立的块来显示不同的文件，我们把这些块叫做窗口。当然你可以选择竖着分或者横着分，横着分的叫做split
window，竖着分的叫做vsplit window。</p>
</div>
<div class="section" id="tab">
<h7>Tab/标签页<a class="headerlink" href="#tab" title="永久链接至标题">¶</a></h7>
<p>就像chrome的标签页一样。</p>
</div>
<div class="section" id="buffer">
<h7>Buffer/缓冲区<a class="headerlink" href="#buffer" title="永久链接至标题">¶</a></h7>
<p>缓冲区（Buffer）是一块内存区域，里面存储着正在编辑的文件。如果没有把缓冲区里的文件存盘，那么原始文件不会被更改。
可以通过:ls或:buffer命令查看缓冲区</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id10">
<h6>插件<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<div class="section" id="vundle">
<h7>Vundle插件管理器<a class="headerlink" href="#vundle" title="永久链接至标题">¶</a></h7>
<p>Vundle的功能是用于安装和管理其他插件，它能够直接从github上下载并自动安装置顶的插件。其本身也托管在github上，我们可以使用下面的命令快捷的安装它。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>git clone https://github.com/gmarik/Vundle.vim.git ~/.vim/bundle/Vundle.vim
</pre></div>
</div>
<p>然后只需要在.vimrc文件中写入要安装的插件然后在vim中运行Vundle的插件安装命令就可以自动下载安装指定的插件了。
更详细的使用方法可参考<a class="reference external" href="https://github.com/gmarik/Vundle.vim/blob/master/README.md">Vundle的文档</a>。</p>
</div>
<div class="section" id="mru">
<h7>MRU最近打开的文件<a class="headerlink" href="#mru" title="永久链接至标题">¶</a></h7>
<p>MRU的功能是从底部弹出一个最近打开的插件列表，其默认启动命令是:MRU，为了使用方便我将其设为mr。</p>
</div>
<div class="section" id="nerdtree">
<h7>nerdtree文件目录树<a class="headerlink" href="#nerdtree" title="永久链接至标题">¶</a></h7>
<p>nerdtree是一个用于显示目录树的工具默认启动方式是:NERDtree，好难打的样子，所以我把它设成了nt。</p>
<p>关于这个插件有一个非常实用的设置是它可以忽略指定类型的文件，例如我们希望将所有的pyc或者其他没用的文件从目录树中过滤调的时候就可以使用它的这个功能，就像这样</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>let NERDTreeIgnore=[&#39;\.pyc$&#39;, &#39;\~$&#39;]
</pre></div>
</div>
<p>它在github上的readme比较渣，没有介绍什么具体的用法和功能，我这里列出一些我用过的，还有一些大家可以通过:help
Nerdtree查看。</p>
<ul class="simple">
<li>o.......打开文件并将焦点移动到打开的文件或展开当前文件夹</li>
<li>Enter...跟o一样</li>
<li>go......跟o一样，但将焦点留在NerdTree</li>
<li>t.......在新tab中打开文件</li>
<li>T.......同t，但保留焦点</li>
<li>i.......在一个新的 split window中打开文件</li>
<li>gi......同i，保留焦点</li>
<li>s.......在新的 vsplit 窗口打开文件</li>
<li>gs......同s保留焦点</li>
<li>O.......递归打开当前文件夹</li>
<li>x.......关闭当前文件夹的父文件夹</li>
<li>X.......递归关闭当前文件夹</li>
<li>P.......跳到根目录</li>
<li>p.......跳到当前目录的父目录</li>
<li>q.......退出NerdTree</li>
</ul>
</div>
<div class="section" id="ctrlp">
<h7>CtrlP模糊搜索文件<a class="headerlink" href="#ctrlp" title="永久链接至标题">¶</a></h7>
<p>CtrlP是一个用于模糊搜索文件的插件，其文档比较健全看看它的<a class="reference external" href="https://github.com/kien/ctrlp.vim/blob/master/readme.md">readme</a>就能学会其用法，而且其默认启动快捷键就是Ctrl+p。</p>
<p>其跟NerdTree一样，也可以在split(Ctrl+s)和vsplit(Ctrl+v)窗口以及新tab(Ctrl+t)打开文件。</p>
<p>还有一个使用的设置就是忽略指定类型文件，像这样</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>let g:ctrlp_custom_ignore = {
    \&#39;file&#39; : &#39;\v\.(pyc|html\.py)$&#39;,
    \}
</pre></div>
</div>
</div>
<div class="section" id="agctrlsf">
<h7>ag和CtrlSF<a class="headerlink" href="#agctrlsf" title="永久链接至标题">¶</a></h7>
<p>ag是一个linux下非常好用的代码搜索工具（代码在<a class="reference external" href="https://github.com/ggreer/the_silver_searcher">github上</a>需要手动安装），它可以快速搜索你的代码内容。vim的ag插件允许我们在vim中使用ag命令搜索代码，CtrlSF插件跟ag插件的不同在于前者可以显示代码的上下文，显然是CtrlSF更为强大。</p>
<p>CtrlSF的默认命令就是:CtrlSF，然后输入要搜索的字符再敲回车。好难打，好难用，所以我设置了下面的快捷键：</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>nmap &lt;C-S&gt;f :CtrlSF
nmap &lt;C-S&gt;o :CtrlSFOpen&lt;CR&gt;
nmap ss :CtrlSF &lt;C-R&gt;&lt;C-W&gt;&lt;CR&gt;
vnoremap ss y:CtrlSF &lt;C-R&gt;&quot;&lt;CR&gt;
</pre></div>
</div>
<ul class="simple">
<li>Ctrl+s+f................适用于normal模式，就跟:CtrlSF一样</li>
<li>Ctrl+s+o................适用于normal模式，打开搜索结果的窗口</li>
<li>ss......................适用于normal模式，搜索当前光标所在的单词</li>
<li>ss......................适用于visual模式，搜索当前选中的文字</li>
</ul>
</div>
<div class="section" id="tpope-vim-commentary">
<h7>tpope/vim-commentary 批量注释<a class="headerlink" href="#tpope-vim-commentary" title="永久链接至标题">¶</a></h7>
<p>这货可以批量注释代码，就像eclipse的Ctrl+j一样。当然你以可以使用选中再批量插入的方式开实现批量注释，但你需要按5个键(Ctrl,v,Shift,I,Est)而commentry只需三个键就可以了。</p>
<p>首先，我们设个快捷键以及将python的注释符设为#</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>vnoremap &lt;Backspace&gt; :Commentary &lt;CR&gt;
autocmd FileType python set commentstring=#\ %s
</pre></div>
</div>
<p>这样在可视模式选中要注释的内容后可以按退格键批量注释，再次选中按退格键就解除注释。</p>
</div>
<div class="section" id="syntastic">
<h7>Syntastic语法检查<a class="headerlink" href="#syntastic" title="永久链接至标题">¶</a></h7>
<p>该插件的功能是检查和标记语法错误及不规范的问题，在我们的项目下</p>
</div>
<div class="section" id="supertab">
<h7>supertab,补全插件<a class="headerlink" href="#supertab" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="vim-coffee-script-coffeescript">
<h7>vim-coffee-script,CoffeeScript语法高亮<a class="headerlink" href="#vim-coffee-script-coffeescript" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="mako-vim-mako">
<h7>mako.vim,mako语法高亮<a class="headerlink" href="#mako-vim-mako" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="vim-mercenary-hg-blamediff">
<h7>vim-mercenary 支持hg blame和diff<a class="headerlink" href="#vim-mercenary-hg-blamediff" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="vim-colors-solarized">
<h7>vim-colors-solarized 漂亮的颜色主题<a class="headerlink" href="#vim-colors-solarized" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="luochen1990-rainbow">
<h7>luochen1990/rainbow 彩虹括号，匹配的括号显示为同一颜色<a class="headerlink" href="#luochen1990-rainbow" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="godlygeek-tabular">
<h7>godlygeek/tabular 自动对齐<a class="headerlink" href="#godlygeek-tabular" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="hynek-vim-python-pep8-indent-python">
<h7>hynek/vim-python-pep8-indent python自动缩进<a class="headerlink" href="#hynek-vim-python-pep8-indent-python" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="indentline">
<h7>indentLine垂直缩进对齐线<a class="headerlink" href="#indentline" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="matchtaghtml">
<h7>MatchTag高亮显示匹配的html标签<a class="headerlink" href="#matchtaghtml" title="永久链接至标题">¶</a></h7>
</div>
</div>
<div class="section" id="id11">
<h6>移动<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>：[n] 移动光标当第n行。</li>
<li>H,M,L 分别移动光标到当前屏幕首行，中间行和尾行。</li>
<li>Ctrl+f和Ctrl+b向下和向上翻页，相当于pageup和pagedown。</li>
<li>h，j，k，l向左下上右移动一个字符。</li>
<li>f和F加字符，将光标移动到下一个或上一个该字符的位置,例如fa会将光标移动到下一个a的位置。</li>
<li>m设定标记，`跳转到指定标记。例如可以用ma在某行设定标记，再使用`a跳转到改行。</li>
<li>shift+左右 光标移至上/下一个单词（以空格/标点区分单词）词首。</li>
<li>w 光标移动到下一个单词处</li>
<li>b 光标移动到上一个单词处</li>
<li>^ 光标移动到行首</li>
<li>$ 光标移动到行尾</li>
</ol>
</div>
<div class="section" id="id12">
<h6>插入<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>a和i分别在当前字符前和后插入。</li>
<li>A和I分别在当前行尾和行首插入。</li>
<li>批量插入。首先在可视模式下选中要插入的行，然后按I可在选中处之前批量插入字符</li>
</ol>
</div>
<div class="section" id="id13">
<h6>复制、粘贴、替换和删除<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>r可以替换当前字符。</li>
<li>yy和dd可以分别复制和剪切当前行。</li>
<li>y2y和d2d可以分别复制和剪切当前行开始的2行。</li>
<li>:3,8y和:3,8d可以分别复制和剪切第3到第8行。</li>
<li>yw和dw可以分别复制和剪切光标所在的单词。</li>
<li>d(可视模式) 删除当前所选</li>
<li>dd 删除多行并存在剪贴板中（剪切)</li>
<li>y 复制当前所选</li>
<li>p 粘贴</li>
</ol>
</div>
<div class="section" id="id14">
<h6>分屏相关<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>:vsp和:sp分别竖着和横着分割当前窗口。</li>
<li>Ctrl + v和Ctrl + s也可以竖向和横向分屏。</li>
<li>Ctrl + w + 箭头键（hjkl）在不同窗口键移动。</li>
<li>Ctrl + = 将所有的窗口大小调成相同大。</li>
</ol>
</div>
<div class="section" id="id15">
<h6>查找和替换<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>/ + 要搜索的内容搜索。</li>
<li>n和N跳到下一个或上一个搜索结果。</li>
<li># 搜索当前光标所在的单词。</li>
</ol>
</div>
<div class="section" id="id16">
<h6>折叠代码<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>zc,zC,zo,zO折叠或打开折叠当前行的代码，其中大写Z和O表示折叠或打开折叠所有层。</li>
<li>zn,zm折叠或打开折叠当前文件的所有代码。</li>
</ol>
</div>
<div class="section" id="id17">
<h6>定制的快捷键<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>F12..................运行python文件或使用zencode补全html</li>
<li>F11..................格式化代码</li>
<li>F5,F6,F7,F8..........调整窗口大小</li>
<li>Ctrl+s+f.............使用ag搜索</li>
<li>Ctrl+s+o.............打开ag搜索结果</li>
<li>ss...................使用ag搜索光标所在的单词</li>
<li>ss(可视模式).........搜索选中的单词</li>
<li>Backspace(可视模式)..注释/解除注释代码</li>
<li>nt...................打开NerdTree</li>
<li>mr...................打开MRU</li>
<li>tl...................打开taglist</li>
<li>bn...................打开下一个buffer</li>
<li>bp...................打开上一个buffer</li>
</ul>
</div>
<div class="section" id="id18">
<h6>其他<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h6>
<ol class="arabic simple">
<li>u和CTRL+r分别是undo和redo的功能。</li>
<li>:set nu和:set nonu分别为显示和不显示行号。</li>
<li>Shift + &lt; 或 &gt;分表表示向左或向右缩进一层，也可以选中后批量缩进。</li>
<li>n + Shift + &lt; 或 &gt;可批量缩进n层。</li>
</ol>
<ul class="simple">
<li>i insert 输入</li>
<li>v 行选中</li>
<li>ctrl+v 列选中</li>
<li>:q 未修改退出</li>
<li>:q! 强制不保存退出</li>
<li>:x / :wq 保存并退出</li>
<li>J 合并多行</li>
<li>shift+上下键 翻页</li>
<li>:set paste 进入粘贴模式</li>
<li>:%s/target/something/g 替换全部 target 字段</li>
</ul>
</div>
<div class="section" id="id19">
<h6>Vim 实用技巧<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="http://segmentfault.com/q/1010000000166577">http://segmentfault.com/q/1010000000166577</a> 文字</p>
<p>vim-multiple-cursors Sublime Text
支持多个光标选择功能，在重构时非常有用。这个插件将 Sublime Text
中的这个邪恶功能引入了
Vim。想要修改变量名时，只需要将光标放在变量名内，然后多次敲击 Ctrl +
n，即可将多个同名变量选中，此时再按 s 就能同时将这些变量重命名了。</p>
<p><a class="reference external" href="http://doc.42qu.com/school/vim.html?highlight=vim">http://doc.42qu.com/school/vim.html?highlight=vim</a></p>
</div>
</div>
<span id="document-devtools/xshell"></span><div class="section" id="xshell">
<span id="id1"></span><h5>xshell 客户端<a class="headerlink" href="#xshell" title="永久链接至标题">¶</a></h5>
<div class="section" id="xshell-ssh">
<span id="ssh-login"></span><h6>Xshell : 极好用的免费SSH客户端<a class="headerlink" href="#xshell-ssh" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="http://www.onlinedown.net/softdown/36383_2.htm">点此下载 Xshell</a></p>
</div>
<div class="section" id="session">
<h6>创建session<a class="headerlink" href="#session" title="永久链接至标题">¶</a></h6>
<p>安装好xshell后，打开软件，点击菜单栏“File”中的“new”,将出现下图所示弹窗，填写相应信息。其中Host为邮件中所给的主机ip地址（name栏可以不用修改，但一般为便于在xshell中区分不同的主机，自己一般会修改为“用户名&#64;主机”，也可以用“用户名&#64;42qu”），然后点击“ok”。</p>
<img alt="首次登录" src="_images/register.png" />
</div>
<div class="section" id="id3">
<h6>登录<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<p>在随后弹出的弹窗中选择自己创建的帐号，点击“connect”，在弹出窗口中输入邮件中提供的用户名，新窗口中选择“keyboard Interactive”</p>
<p>并确定，最后输入邮件中提供的密码，即可登录到自己的vps中。</p>
<ol class="arabic">
<li><img alt="_images/login1.png" class="first" src="_images/login1.png" />
</li>
<li><img alt="_images/login2.png" class="first" src="_images/login2.png" />
</li>
<li><img alt="_images/login3.png" class="first" src="_images/login3.png" />
</li>
</ol>
</div>
<div class="section" id="id4">
<h6>设置显示编码<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<p>简单设置一下xshell的字符显示，在下图所示的导航按钮中，勾选“UTF-8”。</p>
<img alt="_images/encoding.png" src="_images/encoding.png" />
<p>顺便可以设置下字体</p>
<img alt="_images/xshell_ft.png" src="_images/xshell_ft.png" />
<p>如果觉得粗体看着碍眼, 那么可以修正下显示设置</p>
<ol class="arabic">
<li><img alt="_images/xshell_font_btn.png" class="first" src="_images/xshell_font_btn.png" />
</li>
<li><img alt="_images/xshell_font.png" class="first" src="_images/xshell_font.png" />
</li>
</ol>
</div>
<div class="section" id="id5">
<h6>配置密钥登录 , 无需每次输入密码<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<p>为避免每次登录vps都需要重复输入用户名和密码的步骤，可以通过生成.ssh/authorized_keys来减少麻烦。</p>
<p>执行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>cd ~
</pre></div>
</div>
<p>命令，来到home(家)目录</p>
<p>执行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ssh-keygen
</pre></div>
</div>
<p>命令 , 然后按两次回车, 生成密钥</p>
<p>执行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>cd  .ssh
</pre></div>
</div>
<p>进入.ssh目录</p>
<p>执行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>cat id_rsa.pub &gt;&gt; authorized_keys
</pre></div>
</div>
<p>将把当前目录下</p>
<p>id_rsa.pub中的数据拷贝一份到新建的authorized_keys档案中。</p>
<img alt="_images/makekeys.png" src="_images/makekeys.png" />
<p>点击导航中的“new file transfer”图标，如下图所示。</p>
<img alt="_images/filetransfer.png" src="_images/filetransfer.png" />
<p>弹出窗口中忽视警告，确定后输入密码，在.ssh目录下执行“get id_rsa”命令，id_rsa将被保存到下图红线所示的本地目录中。</p>
<img alt="_images/getkeys.png" src="_images/getkeys.png" />
<p>在xshell菜单栏中依次点击“File”-&gt;“open”，选中你的session用户，并点击“Properties”，如下图所示。</p>
<img alt="_images/reset1.png" src="_images/reset1.png" />
<p>做下图所示修改，点击“Browse”按钮。</p>
<img alt="_images/reset2.png" src="_images/reset2.png" />
<p>点击import按钮，选择id_rsa，之后一路确定，再次登录是就可以不用再输入用户名和密码了。</p>
<img alt="_images/reset3.png" src="_images/reset3.png" />
</div>
<div class="section" id="id6">
<h6>克隆代码<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<p>重新登录后，为了方便学习各种命令; 我们可以首先克隆一份 42qu.com 的源代码, 执行:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg clone https://bitbucket.org/zuroc/zpage
</pre></div>
</div>
<p>等上十分钟 , 会在当前目录下生成新目录zpage，其中包括了项目的所有代码，如图所示。</p>
<img alt="_images/clone.png" src="_images/clone.png" />
</div>
<div class="section" id="virtualenv">
<h6>安装 virtualenv<a class="headerlink" href="#virtualenv" title="永久链接至标题">¶</a></h6>
<p>首先运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>virtualenv .
</pre></div>
</div>
<p>然后修改 ~/.bash_profile 如下</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>[[ -f ~/.bashrc ]] &amp;&amp; . ~/.bashrc
export PATH=$HOME/bin:$HOME/sbin:$PATH:/usr/sbin:/sbin
</pre></div>
</div>
<p>再运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>source ~/.bash_profile
</pre></div>
</div>
<p>再运行</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>pip install setuptools --upgrad
</pre></div>
</div>
<p>然后就可以使用 pip 或者 easy_install 安装python的库了</p>
</div>
</div>
</div>
</div>
<span id="document-python-note/index"></span><div class="section" id="python">
<h4>个人Python笔记<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-python-note/crawler"></span><div class="section" id="crawler">
<span id="id1"></span><h5>爬虫相关<a class="headerlink" href="#crawler" title="永久链接至标题">¶</a></h5>
<div class="section" id="tornado">
<h6>基于Tornado的异步爬虫<a class="headerlink" href="#tornado" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">httpclient</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">ioloop</span><span class="p">,</span> <span class="n">queues</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>


<span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="n">class_</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">class_</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">class_</span>


<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">AsyncSpider</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple class of asynchronous spider.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AsyncSpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span> <span class="o">=</span> <span class="n">concurrency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
            <span class="s2">&quot;tornado.curl_httpclient.CurlAsyncHTTPClient&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fetch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">(),</span> <span class="s1">&#39;fetch&#39;</span><span class="p">)</span>
        <span class="n">http_request</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fetch</span><span class="p">(</span><span class="n">http_request</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;处理html页面&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;处理http响应，对于200响应码直接处理html页面，</span>
<span class="sd">        否则按照需求处理不同响应码&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_html</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">599</span><span class="p">:</span>    <span class="c1"># retry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="c1"># yield gen.sleep(10)    # sleep when need</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;######fetched </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">gen</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">gen</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>    <span class="c1"># py3 can just return response</span>

    <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">fetch_url</span><span class="p">():</span>
            <span class="n">current_url</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fetching****** </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">current_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>

                <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_response</span><span class="p">(</span><span class="n">current_url</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>    <span class="c1"># handle reponse</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_url</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

        <span class="nd">@gen</span><span class="o">.</span><span class="n">coroutine</span>
        <span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">fetch_url</span><span class="p">()</span>

        <span class="c1"># Start workers, then wait for the work queue to be empty.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span><span class="p">):</span>
            <span class="n">worker</span><span class="p">()</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">300000</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>    <span class="c1"># some http error not handle</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetching</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">io_loop</span> <span class="o">=</span> <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span>
        <span class="n">io_loop</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MySpider</span><span class="p">(</span><span class="n">AsyncSpider</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;重写父类fetch方法可以添加cookies，headers，timeout等信息&quot;&quot;&quot;</span>
        <span class="n">cookies_str</span> <span class="o">=</span> <span class="s2">&quot;PHPSESSID=j1tt66a829idnms56ppb70jri4; pspt=%7B</span><span class="si">%22i</span><span class="s2">d</span><span class="si">%22%</span><span class="s2">3A</span><span class="si">%2233153%</span><span class="s2">22%2C%22pswd</span><span class="si">%22%</span><span class="s2">3A</span><span class="si">%228835d</span><span class="s2">2c1351d221b4ab016fbf9e8253f</span><span class="si">%22%</span><span class="s2">2C%22_code</span><span class="si">%22%</span><span class="s2">3A</span><span class="si">%22f</span><span class="s2">779dcd011f4e2581c716d1e1b945861</span><span class="si">%22%</span><span class="s2">7D; key=</span><span class="si">%E</span><span class="s2">9</span><span class="si">%87%</span><span class="s2">8D</span><span class="si">%E</span><span class="s2">5%BA</span><span class="si">%86%</span><span class="s2">E5</span><span class="si">%95%</span><span class="s2">84</span><span class="si">%E</span><span class="s2">6%9C%A8</span><span class="si">%E</span><span class="s2">9%B8</span><span class="si">%9F%E</span><span class="s2">7%BD</span><span class="si">%91%</span><span class="s2">E7%BB%9C</span><span class="si">%E</span><span class="s2">7%A7</span><span class="si">%91%</span><span class="s2">E6%8A</span><span class="si">%80%</span><span class="s2">E6%9C</span><span class="si">%89%</span><span class="s2">E9</span><span class="si">%99%</span><span class="s2">90</span><span class="si">%E</span><span class="s2">5</span><span class="si">%85%</span><span class="s2">AC</span><span class="si">%E</span><span class="s2">5</span><span class="si">%8F</span><span class="s2">%B8; think_language=zh-cn; SERVERID=a66d7d08fa1c8b2e37dbdc6ffff82d9e|1444973193|1444967835; CNZZDATA1254842228=1433864393-1442810831-%7C1444972138&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;mozilla/5.0 (compatible; baiduspider/2.0; +http://www.baidu.com/search/spider.html)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cookie&#39;</span><span class="p">:</span> <span class="n">cookies_str</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MySpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="c1">#proxy_host=&quot;127.0.0.1&quot;, proxy_port=8787,    # for proxy</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1">#print(BeautifulSoup(html, &#39;lxml&#39;).find(&#39;title&#39;))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;http://www.jb51.net/article/</span><span class="si">%s</span><span class="s1">.htm&#39;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">MySpider</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="mf">60.0</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;per minute&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="mf">60.0</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">st</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="mf">60.0</span><span class="p">,</span> <span class="s1">&#39;per second&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h6>写爬虫会遇到的一些工具函数<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">chrome有个功能，对于请求可以直接右键copy as curl，然后在命令行里边用curl</span>
<span class="sd">模拟发送请求。现在需要把此curl字符串处理成requests库可以传入的参数格式，</span>
<span class="sd">http://stackoverflow.com/questions/23118249/whats-the-difference-between-request-payload-vs-form-data-as-seen-in-chrome</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">encode_to_dict</span><span class="p">(</span><span class="n">encoded_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 将encode后的数据拆成dict</span>
<span class="sd">    &gt;&gt;&gt; encode_to_dict(&#39;name=foo&#39;)</span>
<span class="sd">    {&#39;name&#39;: foo&#39;}</span>
<span class="sd">    &gt;&gt;&gt; encode_to_dict(&#39;name=foo&amp;val=bar&#39;)</span>
<span class="sd">    {&#39;name&#39;: &#39;foo&#39;, &#39;val&#39;: &#39;var&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pair_list</span> <span class="o">=</span> <span class="n">encoded_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pair_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pair</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">parse_curl_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert chrome curl string to url, headers_dict and data&quot;&quot;&quot;</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;&#39;(.*?)&#39;&quot;</span><span class="p">)</span>
    <span class="n">str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">s</span><span class="p">)]</span>   <span class="c1"># 拆分curl请求字符串</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">headers_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">str_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">str_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;curl&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">string</span>

        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-H&#39;</span><span class="p">):</span>
            <span class="n">header_key</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">header_val</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">headers_dict</span><span class="p">[</span><span class="n">header_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_val</span>

        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--data&#39;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">string</span>

    <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers_dict</span><span class="p">,</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;一个失败请求重试，或者使用下边这个功能强大的retrying</span>
<span class="sd">    pip install retrying</span>
<span class="sd">    https://github.com/rholder/retrying</span>

<span class="sd">    :param retries: number int of retry times.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_retry</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">_wrapper</span>
    <span class="k">return</span> <span class="n">_retry</span>


<span class="n">_get</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span>


<span class="nd">@retry</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="s1">&#39;headers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>

    <span class="k">return</span> <span class="n">_get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<span class="n">requests</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">get</span>


<span class="k">def</span> <span class="nf">retry_get_html</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>


<span class="k">def</span> <span class="nf">lazy_property</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">attr_name</span> <span class="o">=</span> <span class="s1">&#39;_lazy_&#39;</span> <span class="o">+</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_lazy_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_lazy_property</span>


<span class="k">def</span> <span class="nf">my_ip</span><span class="p">():</span>
    <span class="c1"># url = &#39;https://api.ipify.org?format=json&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://httpbin.org/ip&#39;</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>


<span class="k">def</span> <span class="nf">form_data_to_dict</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;form_data_to_dict s是从chrome里边复制得到的form-data表单里的字符串，</span>
<span class="sd">    注意*必须*用原始字符串r&quot;&quot;</span>

<span class="sd">    :param s: form-data string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">arg_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">curl_str</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># 用三引号括起来作为参数</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">headers_dict</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">parse_curl_str</span><span class="p">(</span><span class="n">curl_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">headers_dict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h6>如何使用代理<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="c1"># requests proxy demo</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># install lantern first, 这是使用lantern的代理地址</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8787&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8787&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://httpbin.org/ip&#39;</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


<span class="c1"># requests from version 2.10.0 support socks proxy</span>
<span class="c1"># pip install -U requests[socks]</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="s2">&quot;socks5://myproxy:9191&quot;</span><span class="p">}</span>
<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://example.org&#39;</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>

<span class="c1"># tornado proxy demo</span>
<span class="c1"># sudo apt-get install libcurl-dev librtmp-dev</span>
<span class="c1"># pip install tornado pycurl</span>

<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">httpclient</span><span class="p">,</span> <span class="n">ioloop</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;proxy_host&#39;</span><span class="p">:</span> <span class="s1">&#39;YOUR_PROXY_HOSTNAME_OR_IP_ADDRESS&#39;</span><span class="p">,</span>
    <span class="s1">&#39;proxy_port&#39;</span><span class="p">:</span> <span class="mi">3128</span>
<span class="p">}</span>

<span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
    <span class="s2">&quot;tornado.curl_httpclient.CurlAsyncHTTPClient&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Error:&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
    <span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">http_client</span> <span class="o">=</span> <span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
<span class="n">http_client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;http://twitter.com/&quot;</span><span class="p">,</span>
    <span class="n">handle_request</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
<span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h6>使用线程池<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">bs4</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">class</span> <span class="nc">ThreadPoolCrawler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="n">urls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span> <span class="o">=</span> <span class="n">concurrency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">future_to_url</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span> <span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_url</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">future_to_url</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_response</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestCrawler</span><span class="p">(</span><span class="n">ThreadPoolCrawler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">url</span><span class="p">:</span> <span class="n">title</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">300</span>
    <span class="k">for</span> <span class="n">nums</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
        <span class="n">beg</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">TestCrawler</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">nums</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">beg</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="torip">
<h6>使用tor代理ip<a class="headerlink" href="#torip" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

    <span class="c1"># http://ningning.today/2016/03/07/python/python-requests-tor-crawler/</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">requesocks</span>

<span class="c1">#url = &#39;https://api.ipify.org?format=json&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://httpbin.org/ip&#39;</span>


<span class="k">def</span> <span class="nf">getip_requests</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;(+) Sending request with plain requests...&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;(+) IP is: &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">getip_requesocks</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;(+) Sending request with requesocks...&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">requesocks</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="s1">&#39;socks5://127.0.0.1:9050&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="s1">&#39;socks5://127.0.0.1:9050&#39;</span><span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;(+) IP is: &quot;</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">tor_requests</span><span class="p">():</span>
    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="s1">&#39;socks5://127.0.0.1:9050&#39;</span><span class="p">,</span>
        <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="s1">&#39;socks5://127.0.0.1:9050&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;Running tests...&quot;</span>
    <span class="n">getip_requests</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">getip_requesocks</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;(echo authenticate &#39;&quot;yourpassword&quot;&#39;; echo signal newnym; echo quit) | nc localhost 9051&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">getip_requesocks</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="c1">#tor_requests()</span>
</pre></div>
</div>
</div>
</div>
<span id="document-python-note/funny"></span><div class="section" id="just-for-fun">
<span id="funny"></span><h5>Just For Fun<a class="headerlink" href="#just-for-fun" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;生成 ascii 字体</span>
<span class="sd">pip install colorama termcolor pyfiglet</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span>
<span class="n">init</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span> <span class="c1"># strip colors if stdout is redirected</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">cprint</span>
<span class="kn">from</span> <span class="nn">pyfiglet</span> <span class="kn">import</span> <span class="n">figlet_format</span>

<span class="c1"># cprint(figlet_format(&#39;missile!&#39;, font=&#39;starwars&#39;), &#39;yellow&#39;, &#39;on_red&#39;, attrs=[&#39;bold&#39;])</span>
<span class="n">cprint</span><span class="p">(</span><span class="n">figlet_format</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;docker vim&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="sd"> ____        _   _                  __        __   _          ____       _     _</span>
<span class="sd">|  _ \ _   _| |_| |__   ___  _ __   \ \      / /__| |__      / ___|_   _(_) __| | ___</span>
<span class="sd">| |_) | | | | __| &#39;_ \ / _ \| &#39;_ \   \ \ /\ / / _ \ &#39;_ \    | |  _| | | | |/ _` |/ _ \</span>
<span class="sd">|  __/| |_| | |_| | | | (_) | | | |   \ V  V /  __/ |_) |   | |_| | |_| | | (_| |  __/</span>
<span class="sd">|_|    \__, |\__|_| |_|\___/|_| |_|    \_/\_/ \___|_.__/     \____|\__,_|_|\__,_|\___|</span>
<span class="sd">       |___/</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<span id="document-python-note/ffmpeg"></span><div class="section" id="python-ffmepg">
<span id="ffmpeg"></span><h5>使用Python 编写的 ffmepg 处理视频的脚本<a class="headerlink" href="#python-ffmepg" title="永久链接至标题">¶</a></h5>
<div class="section" id="id1">
<h6>拼接视频片段<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">使用 ffmpeg 截取视频片段并且重新拼接</span>

<span class="sd">使用方式:</span>
<span class="sd">提供文件格式如下：比如 input.txt</span>

<span class="sd">./input.mp4</span>
<span class="sd">00:01:00 00:02:00</span>
<span class="sd">00:04:00 00:08:00</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">CONCAT_FILE</span> <span class="o">=</span> <span class="s1">&#39;_concat.txt&#39;</span>


<span class="k">def</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">input_mp4</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">input_mp4</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">start_end_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">start_end_time</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">part_name</span> <span class="o">=</span> <span class="s1">&#39;part_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg -i </span><span class="si">{}</span><span class="s2"> -ss </span><span class="si">{}</span><span class="s2"> -to </span><span class="si">{}</span><span class="s2"> -c copy </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">input_mp4</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">part_name</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">part_name</span>


<span class="k">def</span> <span class="nf">write_part_to_file</span><span class="p">(</span><span class="n">part_list</span><span class="p">):</span>
    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">filepath_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part_name</span> <span class="ow">in</span> <span class="n">part_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">part_name</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">part_name</span><span class="p">)</span>
        <span class="n">filepath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONCAT_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">filepath_list</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">filepath_list</span>


<span class="k">def</span> <span class="nf">concat_video</span><span class="p">():</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ffmpeg -f concat -safe 0 -i </span><span class="si">{}</span><span class="s2"> -c copy output.mp4&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CONCAT_FILE</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">filepath_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;移除中间文件&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">filepath_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">CONCAT_FILE</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">inputfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;must need input.txt&#39;</span><span class="p">)</span>
    <span class="n">partnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">read_input</span><span class="p">(</span><span class="n">inputfile</span><span class="p">))</span>
    <span class="n">filepath_list</span> <span class="o">=</span> <span class="n">write_part_to_file</span><span class="p">(</span><span class="n">partnames</span><span class="p">)</span>
    <span class="n">concat_video</span><span class="p">()</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">filepath_list</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h6>递归统计一个文件夹下的所有视频时长<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">递归统计一个目录下所有视频文件的总时长。比如笔者用来统计课程的内容总时长。</span>

<span class="sd">pip install moviepy</span>

<span class="sd">如果安装报错，尝试升级</span>

<span class="sd">pip install --upgrade setuptools</span>

<span class="sd">使用方法：</span>
<span class="sd">python compute_duration.py --path ~/Movies/ --type .mp4</span>

<span class="sd">参考：https://blog.csdn.net/qq_22210253/article/details/86684658</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="n">VideoFileClip</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Compute Total Time of a Series of Videos&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--path&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the root path of the videos(default: .)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--type&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;TYPE&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;.mkv&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the type of the videos(default: .mkv)&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">ftime</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filelist</span><span class="p">):</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">秒&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">clip</span><span class="o">.</span><span class="n">duration</span><span class="p">))</span>
        <span class="n">ftime</span> <span class="o">+=</span> <span class="n">clip</span><span class="o">.</span><span class="n">duration</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> seconds: &quot;</span> <span class="o">%</span> <span class="n">ftime</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">ftime</span><span class="p">)))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<span id="document-python-note/flaskapi"></span><div class="section" id="flask-server">
<span id="flaskapi"></span><h5>用来测试接口的 flask server<a class="headerlink" href="#flask-server" title="永久链接至标题">¶</a></h5>
<div class="section" id="restful">
<h6>Restful规范<a class="headerlink" href="#restful" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">RESTFul url 规范，参考：http://www.pythondoc.com/flask-restful/second.html</span>

<span class="sd">==========  ===============================================  =============================</span>
<span class="sd">HTTP 方法   URL                                              动作</span>
<span class="sd">==========  ===============================================  ==============================</span>
<span class="sd">GET         http://[hostname]/todo/api/v1.0/tasks            检索任务列表</span>
<span class="sd">GET         http://[hostname]/todo/api/v1.0/tasks/[task_id]  检索某个任务</span>
<span class="sd">POST        http://[hostname]/todo/api/v1.0/tasks            创建新任务</span>
<span class="sd">PUT         http://[hostname]/todo/api/v1.0/tasks/[task_id]  更新任务</span>
<span class="sd">DELETE      http://[hostname]/todo/api/v1.0/tasks/[task_id]  删除任务</span>
<span class="sd">==========  ================================================ =============================</span>


<span class="sd">命名规范：</span>

<span class="sd"># 我们使用 SomeListHandler 命名而不是复数形式方便区分，比如 VideosHandler 和 VideoHandler 不容易区分</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">TaskListHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;获取列表&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;创建一条新的记录&quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TaskHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;获取一条记录的信息&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;更新一条记录的信息&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;删除一条记录&quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="server">
<h6>测试 server<a class="headerlink" href="#server" title="永久链接至标题">¶</a></h6>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># pip install flask Flask-RESTful</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_restful</span> <span class="kn">import</span> <span class="n">reqparse</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">Api</span><span class="p">,</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">TODOS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;todo1&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;build an API&#39;</span><span class="p">},</span>
    <span class="s1">&#39;todo2&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;?????&#39;</span><span class="p">},</span>
    <span class="s1">&#39;todo3&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;profit!&#39;</span><span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">abort_if_todo_doesnt_exist</span><span class="p">(</span><span class="n">todo_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">todo_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TODOS</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Todo </span><span class="si">{}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">todo_id</span><span class="p">))</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">reqparse</span><span class="o">.</span><span class="n">RequestParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)</span>


<span class="c1"># Todo</span>
<span class="c1"># shows a single todo item and lets you delete a todo item</span>
<span class="k">class</span> <span class="nc">Todo</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">):</span>
        <span class="n">abort_if_todo_doesnt_exist</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TODOS</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">):</span>
        <span class="n">abort_if_todo_doesnt_exist</span><span class="p">(</span><span class="n">todo_id</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">TODOS</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">todo_id</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]}</span>
        <span class="n">TODOS</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="k">return</span> <span class="n">task</span><span class="p">,</span> <span class="mi">201</span>


<span class="c1"># TodoList</span>
<span class="c1"># shows a list of all todos, and lets you POST to add new tasks</span>
<span class="k">class</span> <span class="nc">TodoList</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TODOS</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">todo_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">TODOS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">todo_id</span> <span class="o">=</span> <span class="s1">&#39;todo</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">todo_id</span>
        <span class="n">TODOS</span><span class="p">[</span><span class="n">todo_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">TODOS</span><span class="p">[</span><span class="n">todo_id</span><span class="p">],</span> <span class="mi">201</span>


<span class="k">class</span> <span class="nc">TaskList</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Ping</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;pong&#39;</span>

<span class="c1">##</span>
<span class="c1"># Actually setup the Api resource routing here</span>
<span class="c1">##</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Ping</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TodoList</span><span class="p">,</span> <span class="s1">&#39;/todos&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">Todo</span><span class="p">,</span> <span class="s1">&#39;/todos/&lt;todo_id&gt;&#39;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">TaskList</span><span class="p">,</span> <span class="s1">&#39;/tasks&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># port=5000</span>
</pre></div>
</div>
</div>
</div>
<span id="document-python-note/pdf"></span><div class="section" id="pdf">
<span id="id1"></span><h5>合并 pdf<a class="headerlink" href="#pdf" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">合并多个 pdf 到一个，使用方式：放到当前文件夹下运行</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">from</span> <span class="nn">pyPdf</span> <span class="kn">import</span> <span class="n">PdfFileReader</span><span class="p">,</span> <span class="n">PdfFileWriter</span> <span class="c1"># pip install pyPdf</span>


<span class="k">def</span> <span class="nf">get_pdf_files</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">):</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filespath</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filespath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">):</span>  <span class="c1"># pdf file</span>
                <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filespath</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span>


<span class="c1">##########################合并同一个文件夹下所有PDF文件########################</span>
<span class="k">def</span> <span class="nf">merge_pdf</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">PdfFileWriter</span><span class="p">()</span>
    <span class="n">curpage</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pdf_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">get_pdf_files</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">))</span> <span class="k">if</span> <span class="n">sort</span> <span class="k">else</span> <span class="n">get_pdf_files</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">pdf_paths</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="n">each</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
        <span class="c1"># 如果pdf文件已经加密，必须首先解密才能使用pyPdf</span>
        <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">isEncrypted</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
        <span class="c1"># 获得源pdf文件中页面总数</span>
        <span class="n">page_count</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>
        <span class="n">curpage</span> <span class="o">+=</span> <span class="n">page_count</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">page_count</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iPage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_count</span><span class="p">):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">addPage</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">getPage</span><span class="p">(</span><span class="n">iPage</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All Pages Number:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">curpage</span><span class="p">))</span>
    <span class="n">outputStream</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">dst_dir</span> <span class="o">+</span> <span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outputStream</span><span class="p">)</span>
    <span class="n">outputStream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="s2">&quot;all.pdf&quot;</span>
    <span class="n">merge_pdf</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">merged</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
<span id="document-python-note/uncurl"></span><div class="section" id="uncurl">
<span id="id1"></span><h5>Uncurl<a class="headerlink" href="#uncurl" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">http_cookies</span> <span class="k">as</span> <span class="n">Cookie</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--data&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--data-binary&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-H&#39;</span><span class="p">,</span> <span class="s1">&#39;--header&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--compressed&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--insecure&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>

<span class="n">BASE_INDENT</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">4</span>

<span class="n">ParsedContext</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ParsedContext&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="s1">&#39;cookies&#39;</span><span class="p">,</span> <span class="s1">&#39;verify&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">parse_context</span><span class="p">(</span><span class="n">curl_command</span><span class="p">):</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;get&quot;</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">curl_command</span><span class="p">)</span>
    <span class="n">parsed_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

    <span class="n">post_data</span> <span class="o">=</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">data_binary</span>
    <span class="k">if</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;post&#39;</span>

    <span class="k">if</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">X</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">cookie_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">quoted_headers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">curl_header</span> <span class="ow">in</span> <span class="n">parsed_args</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">curl_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="n">occurrence</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">curl_header</span><span class="p">)]</span>
            <span class="n">header_key</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">=</span> <span class="n">curl_header</span><span class="p">[:</span><span class="n">occurrence</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">curl_header</span><span class="p">[</span><span class="n">occurrence</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header_key</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">=</span> <span class="n">curl_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header_key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cookie&#39;</span><span class="p">:</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">(</span><span class="n">header_value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cookie</span><span class="p">:</span>
                <span class="n">cookie_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quoted_headers</span><span class="p">[</span><span class="n">header_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ParsedContext</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">parsed_args</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">quoted_headers</span><span class="p">,</span>
        <span class="n">cookies</span><span class="o">=</span><span class="n">cookie_dict</span><span class="p">,</span>
        <span class="n">verify</span><span class="o">=</span><span class="n">parsed_args</span><span class="o">.</span><span class="n">insecure</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">curl_command</span><span class="p">):</span>
    <span class="n">parsed_context</span> <span class="o">=</span> <span class="n">parse_context</span><span class="p">(</span><span class="n">curl_command</span><span class="p">)</span>

    <span class="n">data_token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">parsed_context</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">data_token</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">data=</span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BASE_INDENT</span><span class="p">,</span> <span class="n">parsed_context</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="n">verify_token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">parsed_context</span><span class="o">.</span><span class="n">verify</span><span class="p">:</span>
        <span class="n">verify_token</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">verify=False&#39;</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">parsed_context</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">parsed_context</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
        <span class="s1">&#39;data_token&#39;</span><span class="p">:</span> <span class="n">data_token</span><span class="p">,</span>
        <span class="s1">&#39;headers_token&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">headers=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BASE_INDENT</span><span class="p">,</span> <span class="n">dict_to_pretty_string</span><span class="p">(</span><span class="n">parsed_context</span><span class="o">.</span><span class="n">headers</span><span class="p">)),</span>
        <span class="s1">&#39;cookies_token&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">cookies=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BASE_INDENT</span><span class="p">,</span> <span class="n">dict_to_pretty_string</span><span class="p">(</span><span class="n">parsed_context</span><span class="o">.</span><span class="n">cookies</span><span class="p">)),</span>
        <span class="s1">&#39;security_token&#39;</span><span class="p">:</span> <span class="n">verify_token</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import requests</span>

<span class="s2">url = &quot;http://localhost:22222&quot;</span>
<span class="s2">url = &quot;</span><span class="si">{url}</span><span class="s2">&quot;</span>

<span class="s2">resp = requests.</span><span class="si">{method}</span><span class="s2">(</span>
<span class="s2">    url,</span>
<span class="si">{data_token}{headers_token}</span><span class="s2">,</span>
<span class="si">{cookies_token}</span><span class="s2">,</span><span class="si">{security_token}</span><span class="s2"></span>
<span class="s2">)</span>
<span class="s2">print(resp.text)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">formatter</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dict_to_pretty_string</span><span class="p">(</span><span class="n">the_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">the_dict</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-go-note/index"></span><div class="section" id="golang-go-for-pythonisa">
<h4>Golang 快速入门 Go For Pythonisa<a class="headerlink" href="#golang-go-for-pythonisa" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-go-note/web"></span><div class="section" id="go">
<span id="goweb"></span><h5>Go入门<a class="headerlink" href="#go" title="永久链接至标题">¶</a></h5>
<div class="section" id="id1">
<h6>Go语言入门和深入<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/PegasusWang/LetsGo">Lets Go</a>  笔者连载的 go 文字和视频教程</li>
<li><a class="reference external" href="https://tour.golang.org/welcome/1">A Tour of Go</a></li>
<li><a class="reference external" href="https://gobyexample.com">Go by Example</a></li>
<li><a class="reference external" href="https://quii.gitbook.io/learn-go-with-tests/">Learn Go with Tests</a></li>
<li><a class="reference external" href="https://github.com/Unknwon/the-way-to-go_ZH_CN">The-way-to-go</a></li>
<li><a class="reference external" href="https://github.com/Alikhll/golang-developer-roadmap">golang-developer-roadmap</a></li>
<li><a class="reference external" href="https://golang.org/doc/code.html">How to Write Go Code</a></li>
<li><a class="reference external" href="https://github.com/developer-learning/learning-golang">Learning-golang</a></li>
<li><a class="reference external" href="https://github.com/astaxie/build-web-application-with-golang">Build Web Application With Golang</a></li>
<li><a class="reference external" href="https://chai2010.cn/advanced-go-programming-book/">Go 高级编程</a></li>
<li><a class="reference external" href="https://go101.org/article/101.html">Go 101</a> 包含了很多基础和高级主题</li>
<li><a class="reference external" href="https://books.studygolang.com/Mastering_Go_ZH_CN/">Mastering Go</a></li>
<li><a class="reference external" href="https://books.studygolang.com/gopl-zh/">Go语言圣经</a></li>
</ul>
</div>
<div class="section" id="go-books">
<h6>Go Books<a class="headerlink" href="#go-books" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/dariubs/GoBooks">https://github.com/dariubs/GoBooks</a></li>
</ul>
</div>
<div class="section" id="id4">
<h6>Go 开发工具<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>Goland IDE</li>
<li>Vscode/Sublime/Atom 等常用编辑器结合插件</li>
<li>vim/Neovim + vim-go + coc.nvim</li>
</ul>
<p>博客:</p>
<ul class="simple">
<li><a class="reference external" href="https://octetz.com/docs/2019/2019-04-24-vim-as-a-go-ide/">https://octetz.com/docs/2019/2019-04-24-vim-as-a-go-ide/</a></li>
<li><a class="reference external" href="https://ictar.xyz/2019/05/14/an-overview-of-go-tooling/">https://ictar.xyz/2019/05/14/an-overview-of-go-tooling/</a></li>
<li><a class="reference external" href="https://github.com/fedir/go-tooling-cheat-sheet/blob/master/go-tooling-cheat-sheet.pdf">https://github.com/fedir/go-tooling-cheat-sheet/blob/master/go-tooling-cheat-sheet.pdf</a></li>
</ul>
</div>
<div class="section" id="id5">
<h6>Go 博客教程<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://yourbasic.org/golang/">https://yourbasic.org/golang/</a></li>
<li><a class="reference external" href="https://golangbot.com/learn-golang-series/">https://golangbot.com/learn-golang-series/</a></li>
<li><a class="reference external" href="https://golangbot.com/learn-golang-series/">https://golangbot.com/learn-golang-series/</a></li>
<li><a class="reference external" href="https://golangbyexample.com/all-design-patterns-golang/">https://golangbyexample.com/all-design-patterns-golang/</a> go 设计模式(考虑并发安全)</li>
</ul>
</div>
<div class="section" id="go-idioms">
<h6>Go idioms<a class="headerlink" href="#go-idioms" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://yourbasic.org/golang/switch-statement/">https://yourbasic.org/golang/switch-statement/</a></li>
</ul>
</div>
<div class="section" id="id6">
<h6>Go 错误处理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/pkg/errors">https://github.com/pkg/errors</a> 推荐使用</li>
<li><a class="reference external" href="https://github.com/juju/errors">https://github.com/juju/errors</a></li>
<li><a class="reference external" href="https://blog.golang.org/error-handling-and-go">https://blog.golang.org/error-handling-and-go</a></li>
<li><a class="reference external" href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/82985617">https://zhuanlan.zhihu.com/p/82985617</a> Golang error 的突围</li>
</ul>
</div>
<div class="section" id="id7">
<h6>Go日志实践<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://imhanjm.com/2017/05/19">https://imhanjm.com/2017/05/19</a>/go%20logger%20日志实践/</li>
</ul>
</div>
<div class="section" id="id8">
<h6>Go文档查询<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://gowalker.org">https://gowalker.org</a></li>
</ul>
</div>
<div class="section" id="goproxy">
<h6>GOPROXY 代理<a class="headerlink" href="#goproxy" title="永久链接至标题">¶</a></h6>
<p>如果有有一些库拉不下来又没有自己的代理，可以试试</p>
<p>export GOPROXY=https://goproxy.io</p>
</div>
<div class="section" id="web-rpc">
<h6>Web/RPC框架<a class="headerlink" href="#web-rpc" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>gin</li>
<li>grpc</li>
</ul>
<p>个人推荐使用 gin，当然你可以参考一下 star 选择别的框架</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/gin-gonic/contrib">https://github.com/gin-gonic/contrib</a> gin各种组件</li>
<li><a class="reference external" href="https://github.com/e421083458/gin_scaffold">https://github.com/e421083458/gin_scaffold</a> gin 脚手架</li>
<li><a class="reference external" href="https://github.com/mingrammer/go-web-framework-stars">https://github.com/mingrammer/go-web-framework-stars</a></li>
</ul>
</div>
<div class="section" id="gin-example">
<h6>Gin example<a class="headerlink" href="#gin-example" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/EDDYCJY/go-gin-example">https://github.com/EDDYCJY/go-gin-example</a></li>
<li><a class="reference external" href="https://github.com/vsouza/go-gin-boilerplate">https://github.com/vsouza/go-gin-boilerplate</a></li>
<li><a class="reference external" href="https://github.com/gothinkster/golang-gin-realworld-example-app">https://github.com/gothinkster/golang-gin-realworld-example-app</a></li>
<li><a class="reference external" href="https://github.com/go-programming-tour-book/blog-service">https://github.com/go-programming-tour-book/blog-service</a> 《go 编程之旅》博客代码示例</li>
</ul>
<p>gin 实战博客:</p>
<ul class="simple">
<li><a class="reference external" href="https://segmentfault.com/a/1190000013808421">https://segmentfault.com/a/1190000013808421</a>  gin 连载博客</li>
<li><a class="reference external" href="https://www.cnblogs.com/xinliangcoder/p/11212573.html">https://www.cnblogs.com/xinliangcoder/p/11212573.html</a> logrus日志</li>
<li><a class="reference external" href="https://marcoma.xyz/2019/03/17/gin-tutorial-7/">https://marcoma.xyz/2019/03/17/gin-tutorial-7/</a></li>
</ul>
</div>
<div class="section" id="id9">
<h6>微服务<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<p>微服务框架：</p>
<ul class="simple">
<li>go kit: <a class="reference external" href="https://github.com/go-kit/kit">https://github.com/go-kit/kit</a></li>
<li>go-micro: <a class="reference external" href="https://github.com/micro/go-micro">https://github.com/micro/go-micro</a></li>
<li>kratos: <a class="reference external" href="https://github.com/bilibili/kratos">https://github.com/bilibili/kratos</a> B站go微服务框架</li>
<li>go-zero: <a class="reference external" href="https://github.com/tal-tech/go-zero">https://github.com/tal-tech/go-zero</a> 好未来 go 微服务框架</li>
<li>jupiter: <a class="reference external" href="https://github.com/douyu/jupiter">https://github.com/douyu/jupiter</a> 斗鱼 go 微服务框架</li>
</ul>
<p>微服务代码示例：</p>
<ul class="simple">
<li><a class="reference external" href="https://dzone.com/users/3214037/eriklupander.html">https://dzone.com/users/3214037/eriklupander.html</a> 介绍 go 微服务实践的一系列博客</li>
<li><a class="reference external" href="https://github.com/callistaenterprise/goblog">https://github.com/callistaenterprise/goblog</a> go 微服务代码示例和博客，介绍了微服务各种基础组件</li>
<li><a class="reference external" href="https://github.com/yun-mu/MicroServicePractice">https://github.com/yun-mu/MicroServicePractice</a> 微服务实践</li>
</ul>
</div>
<div class="section" id="go-package-go">
<h6>Go package (搜索常用的 go 第三方库)<a class="headerlink" href="#go-package-go" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://awesome-go.com/">https://awesome-go.com/</a></li>
<li><a class="reference external" href="https://go-search.org/search?q=redis">https://go-search.org/search?q=redis</a></li>
<li><a class="reference external" href="https://golangrepo.com/">https://golangrepo.com/</a></li>
</ul>
</div>
<div class="section" id="golayout">
<h6>Go项目Layout<a class="headerlink" href="#golayout" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/golang-standards/project-layout">https://github.com/golang-standards/project-layout</a> 标准 go 项目目录组织</li>
<li><a class="reference external" href="https://zhengyinyong.com/go-project-layout-design.html">https://zhengyinyong.com/go-project-layout-design.html</a></li>
</ul>
</div>
<div class="section" id="unittest">
<h6>单元测试(unittest)<a class="headerlink" href="#unittest" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="https://www.jianshu.com/p/f4e773a1b11f">GoMock框架使用指南</a>
<a class="reference external" href="https://draveness.me/golang-101">如何写出优雅的 golang 代码</a></p>
<p>静态语言编写单测相比动态语言要难一些，动态语言中比如 python 可以很容易用 mock.patch 来做属性/方法替换。
但是静态语言不行，一般难点在于如何去模拟外部依赖(比如数据库/rpc请求，redis 请求等)：</p>
<ul class="simple">
<li>接口(go 推荐面向接口编程，否则你很难使用 gomock 来编写单测)</li>
<li>mysql: 如何 mock 数据库请求。使用 sqlmock，或者编写 dao 层 interface，然后 mock 这个dao层接口</li>
<li>http: 使用 httpmock 来模拟请求返回值</li>
<li>redis: 这里我试了下 miniredis 比较好用，基于 go 实现，无需真实的 redis server</li>
</ul>
<p>也有一种方式在单测环境加入真实的db 和redis（比如 docker），然后单测读取测试环境的数据库来操作。
这样的好处是可以不使用各种 mock 库，直接操作真实的 mysql，测试代码写起来也更方便。</p>
<p>以下是一些单测相关的库：</p>
<ul class="simple">
<li>testing: 内置库</li>
<li>github.com/stretchr/testify/assert: 用来做断言 assert 方便</li>
<li>gomock(mockgen): 静态语言难以像动态语言直接属性替换，所以一般我们基于接口编写代码，然后可以生成接口 mock</li>
<li>sqlmock: 如果依赖了数据库 mysql 等，可以使用 sqlmock 模拟数据库返回内容。（或者就在测试环境用真实的 mysql，测试完清理插入的测试数据)</li>
<li>httpmock: 用来 mock 调 http 请求</li>
<li>github.com/alicebob/miniredis 可以用来 mock redis，无需启动真实的 resdis server。试了下非常好用，也不用使用 mock 和真实的 redis 了。个人强烈推荐</li>
<li>bouk/monkey: 通过替换函数指针的方式修改任意函数的实现，如果以上都无法满足需求，可以用这种比较 hack 的方式。可能需要禁止编译器内联优化 <code class="xref py py-obj docutils literal"><span class="pre">go</span> <span class="pre">test</span> <span class="pre">-gcflask=-l</span> <span class="pre">./...</span></code></li>
</ul>
<p>目前比较推荐使用 assert 做断言，使用 monkey 用来 mock 函数/方法等。</p>
<p>参考：</p>
<ul class="simple">
<li><a class="reference external" href="https://medium.com/&#64;rosaniline/unit-testing-gorm-with-go-sqlmock-in-go-93cbce1f6b5b">https://medium.com/&#64;rosaniline/unit-testing-gorm-with-go-sqlmock-in-go-93cbce1f6b5b</a></li>
</ul>
</div>
<div class="section" id="go-dlv">
<h6>Go 断点调试器dlv<a class="headerlink" href="#go-dlv" title="永久链接至标题">¶</a></h6>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># 搜索函数，打断点，如果有同名函数的时候比较有用</span>
funcs FuncName

<span class="c1"># 打断点断点</span>
b main.main

<span class="c1"># 打印变量</span>
print val

<span class="c1"># go get -u github.com/derekparker/delve/cmd/dlv</span>
dlv debug main.go

<span class="c1"># 加上命令行参数</span>
<span class="c1"># https://github.com/go-delve/delve/issues/562</span>
dlv debug ./cmd/unit-assignment-cli/main.go -- server

<span class="c1"># 如何调试 go 的 coredump 文件。对于一些很偶发的进程退出会比较难排查，可以利用 coredump 文件辅助排查问题：</span>
<span class="m">1</span>. 调整ulimit关于core file size的设置，执行 <span class="nb">ulimit</span> -c unlimited 将core file size设成无限大小。
<span class="m">2</span>. 输出环境变量 <span class="nb">export</span> <span class="nv">GOTRACEBACK</span><span class="o">=</span>crash 使得golang进程知道需要产生cash时候的coredump文件。
<span class="m">3</span>. 分析 /usr/local/bin/dlv core ./app ./core_app
<span class="m">4</span>. 使用命令 goroutine goroutineid 和 bt 打印栈信息
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://yq.aliyun.com/articles/57578">https://yq.aliyun.com/articles/57578</a></li>
</ul>
</div>
<div class="section" id="go-debug">
<h6>Go Debug 调试工具<a class="headerlink" href="#go-debug" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>go-spew: 用来打印一些复杂结构方便调试 <a class="reference external" href="https://github.com/davecgh/go-spew">https://github.com/davecgh/go-spew</a></li>
<li>dlv: 断点调试器</li>
</ul>
</div>
<div class="section" id="go-vs-python">
<h6>Go vs. Python<a class="headerlink" href="#go-vs-python" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="http://govspy.peterbe.com/">http://govspy.peterbe.com/</a></li>
</ul>
</div>
<div class="section" id="go-best-practice">
<h6>Go Best practice(工程实践)<a class="headerlink" href="#go-best-practice" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://draveness.me/golang-101">https://draveness.me/golang-101</a> 如何写出优雅的 golang 代码(好文推荐)</li>
<li><a class="reference external" href="https://github.com/golang/go/wiki/CodeReviewComments">https://github.com/golang/go/wiki/CodeReviewComments</a> 作为 effective go 补充</li>
<li><a class="reference external" href="https://peter.bourgon.org/go-best-practices-2016/">https://peter.bourgon.org/go-best-practices-2016/</a></li>
<li><a class="reference external" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a></li>
<li><a class="reference external" href="https://golang.org/doc/effective_go.html">https://golang.org/doc/effective_go.html</a></li>
<li><a class="reference external" href="https://talks.golang.org/2013/bestpractices.slide">https://talks.golang.org/2013/bestpractices.slide</a></li>
<li><a class="reference external" href="https://dave.cheney.net/practical-go">https://dave.cheney.net/practical-go</a></li>
<li><a class="reference external" href="https://github.com/codeship/go-best-practices">https://github.com/codeship/go-best-practices</a></li>
<li><a class="reference external" href="https://github.com/uber-go/guide/blob/master/style.md">https://github.com/uber-go/guide/blob/master/style.md</a>   uber 的 go 规范</li>
<li><a class="reference external" href="https://12factor.net/zh_cn/">https://12factor.net/zh_cn/</a></li>
<li><a class="reference external" href="https://go-proverbs.github.io">https://go-proverbs.github.io</a> go谚语，类似 python 之禅</li>
<li><a class="reference external" href="https://the-zen-of-go.netlify.com/">https://the-zen-of-go.netlify.com/</a> zen of go</li>
<li><a class="reference external" href="https://bluxte.net/musings/2018/04/10/go-good-bad-ugly/">https://bluxte.net/musings/2018/04/10/go-good-bad-ugly/</a></li>
</ul>
</div>
<div class="section" id="id10">
<h6>Go 开发关键技术指南<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://developer.aliyun.com/article/739836">https://developer.aliyun.com/article/739836</a> Go 开发关键技术指南</li>
<li><a class="reference external" href="https://developer.aliyun.com/article/740696">https://developer.aliyun.com/article/740696</a> Go 面向失败编程</li>
<li><a class="reference external" href="https://yq.aliyun.com/articles/741747">https://yq.aliyun.com/articles/741747</a> 带着服务器编程金刚经走进 2020 年</li>
<li><a class="reference external" href="https://developer.aliyun.com/article/742169">https://developer.aliyun.com/article/742169</a>  Go 开发关键技术指南 | 敢问路在何方？</li>
</ul>
</div>
<div class="section" id="go-list-import">
<h6>Go List import<a class="headerlink" href="#go-list-import" title="永久链接至标题">¶</a></h6>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># https://pmcgrath.net/how-to-get-golang-package-import-list</span>
go list -f <span class="s1">&#39;{{range $imp := .Imports}}{{printf &quot;%s\n&quot; $imp}}{{end}}&#39;</span> <span class="p">|</span> sort
go list -f <span class="s1">&#39;{{range $dep := .Deps}}{{printf &quot;%s\n&quot; $dep}}{{end}}&#39;</span> <span class="p">|</span> xargs go list -f <span class="s1">&#39;{{if not .Standard}}{{.ImportPath}}{{end}}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h6>Go 常用框架(工具)<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
<p>技术选型一般选择接口稳定，更新快，生态相对成熟，star 数量较高，用户广泛的库，坑少一点。
前后分离时代用 gin 之类的框架写app后台还是挺快的，但是感觉做并发不高的内部后台业务还是用脚本python/php之类的更快。
以下第三方库均可以通过 google + 关键词搜索到，同一行尽量按照流行程度从前往后列举，默认都是 github 上的包(只写了仓库后缀)。
也可以去 awesome-go 之类的去查找，然后根据 star 数目等作为参考选用。</p>
<ul>
<li><p class="first">web/rpc框架: gin, grpc, beego, labstack/echo</p>
</li>
<li><p class="first">参数验证：go-playground/validator, bytedance/go-tagexpr</p>
</li>
<li><p class="first">单元测试断言：matryer/is, testify/assert, smartystreets/goconvey(bdd 驱动测试)</p>
</li>
<li><p class="first">json处理转换：go-simplejson/mapstructure，json-iterator/go (比内置的 json 解析快很多), tidwall/gjson(获取 json 值)</p>
</li>
<li><p class="first">字典/结构体合并：imdario/mergo</p>
</li>
<li><p class="first">配置解析: viper(兼容很多格式)</p>
</li>
<li><p class="first">mysql orm: gorm, xorm, sqlx, ent/ent(实体框架)</p>
</li>
<li><p class="first">redis: go-redis, redigo</p>
</li>
<li><p class="first">Kafka: Shopify/sarama, confluent-kafka-go</p>
</li>
<li><p class="first">Elasticsearch: olivere/elastic, elastic/elasticsearch</p>
</li>
<li><p class="first">mongodb: mongodb/mongo-go-driver</p>
</li>
<li><p class="first">id生成器: rx/xid, satori/go.uuid, beinan/fastid, bwmarrin/snowflake, sony/sonyflake</p>
</li>
<li><p class="first">hash: cespare/xxhash(快速 hash)</p>
</li>
<li><p class="first">cache(in memory): patrickmn/go-cache, allegro/bigcache, golang/groupcache(分布式), singleflight(防止缓存击穿)</p>
</li>
<li><p class="first">并发/协程池(star 数从低到高排序)：</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/panjf2000/ants">https://github.com/panjf2000/ants</a></li>
<li><a class="reference external" href="https://github.com/rafaeldias/async">https://github.com/rafaeldias/async</a></li>
<li><a class="reference external" href="https://github.com/Jeffail/tunny">https://github.com/Jeffail/tunny</a></li>
<li><a class="reference external" href="https://github.com/benmanns/goworker">https://github.com/benmanns/goworker</a></li>
<li><a class="reference external" href="https://github.com/buptmiao/parallel">https://github.com/buptmiao/parallel</a></li>
</ul>
</li>
<li><p class="first">异步任务框架: machinery, gocelery</p>
</li>
<li><p class="first">定时任务：robfig/cron, ouiqiang/gocron</p>
</li>
<li><p class="first">熔断：hystrix-go, eapache/go-resiliency, cep21/circuit, alibaba/sentinel-golang</p>
</li>
<li><p class="first">限流库:</p>
<blockquote>
<div><ul class="simple">
<li>web框架限流：ulule/limiter, didip/tollbooth</li>
<li>令牌桶(token bucket)限流：juju/ratelimit, golang.org/x/time/rate</li>
<li>漏桶(leaky bucket)限流: uber-go/ratelimit</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">日志: logrus, zap, lumberjack(滚动日志)</p>
</li>
<li><p class="first">链路追踪：opentracing/opentracing-go, uber/jaeger-client-go</p>
</li>
<li><p class="first">调试：go-spew/dlv</p>
</li>
<li><p class="first">图片处理：h2non/imaginary</p>
</li>
<li><p class="first">网络库/连接池：fatih/pool; panjf2000/gnet, valyala/fasthttp，kavu/go_reuseport</p>
</li>
<li><p class="first">websocket: nhooyr.io/websocket, gorilla/websocket</p>
</li>
<li><p class="first">http client: levigross/grequests</p>
</li>
<li><p class="first">表格：go-echarts</p>
</li>
<li><p class="first">excel(XLSX): 360EntSecGroup-Skylar/excelize, tealeg/xlsx</p>
</li>
<li><p class="first">转换工具：</p>
<ul class="simple">
<li>sql2go(sql -&gt; go struct): <a class="reference external" href="http://stming.cn/tool/sql2go.html">http://stming.cn/tool/sql2go.html</a></li>
<li>curl2go(curl -&gt; go http code): <a class="reference external" href="https://mholt.github.io/curl-to-go/">https://mholt.github.io/curl-to-go/</a></li>
<li>Json2go(json -&gt; go struct): <a class="reference external" href="https://mholt.github.io/json-to-go/">https://mholt.github.io/json-to-go/</a></li>
</ul>
</li>
<li><p class="first">热编译工具：gowatch</p>
</li>
<li><p class="first">静态检查：golangci-lint</p>
</li>
<li><p class="first">网络代理：goproxy</p>
</li>
<li><p class="first">命令行: spf13/cobra</p>
</li>
<li><p class="first">字符串处理工具：huandu/xstrings</p>
</li>
<li><p class="first">类型转换：spf13/cast</p>
</li>
<li><p class="first">HTML 处理/过滤: PuerkitoBio/goquery, microcosm-cc/bluemonday</p>
</li>
<li><p class="first">系统信息收集：shirou/gopsutil</p>
</li>
<li><p class="first">go runtime: bmhatfield/go-runtime-metrics(runtime 指标收集)</p>
</li>
<li><p class="first">邮件：gopkg.in/gomail</p>
</li>
<li><p class="first">接口文档生成：swaggo/swag</p>
</li>
<li><p class="first">消息队列：nsqio/nsq</p>
</li>
<li><p class="first">分布式kv存储：etcd</p>
</li>
<li><p class="first">用户认证：dgrijalva/jwt-go</p>
</li>
<li><p class="first">地理位置：ip2location/ip2location-go</p>
</li>
</ul>
<p>工具:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/smallnest/gen">https://github.com/smallnest/gen</a> gorm struct 生成工具，根据 sql 生成 struct，甚至还可以直接生成增删改查的代码</li>
<li><a class="reference external" href="https://mholt.github.io/json-to-go/">https://mholt.github.io/json-to-go/</a> json 转 go struct</li>
<li><a class="reference external" href="https://protogen.marcgravell.com/decode">https://protogen.marcgravell.com/decode</a> proto decode 工具</li>
<li><a class="reference external" href="https://gopherize.me/">https://gopherize.me/</a>  一个好玩的小工具，设计你喜欢的 gopher 形象</li>
<li><a class="reference external" href="https://github.com/jfeliu007/goplantuml">https://github.com/jfeliu007/goplantuml</a> 一个自动根据 go 项目生成 uml 图的工具 <a class="reference external" href="https://www.dumels.com/">https://www.dumels.com/</a></li>
<li><a class="reference external" href="https://github.com/TrueFurby/go-callvis">https://github.com/TrueFurby/go-callvis</a> 查看 go 的调用关系</li>
</ul>
<p>博客：</p>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/22803609">https://zhuanlan.zhihu.com/p/22803609</a> redigo demo</li>
<li><a class="reference external" href="https://blog.biezhi.me/2018/10/load-config-with-viper.html">https://blog.biezhi.me/2018/10/load-config-with-viper.html</a> viper 解析配置</li>
</ul>
</div>
<div class="section" id="id12">
<h6>Go 底层实现(源码)<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://draveness.me/golang/concurrency/golang-context.html">https://draveness.me/golang/concurrency/golang-context.html</a></li>
<li><a class="reference external" href="https://github.com/tiancaiamao/go-internals/tree/master/zh">https://github.com/tiancaiamao/go-internals/tree/master/zh</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/80853548">https://zhuanlan.zhihu.com/p/80853548</a> 深度解密Go语言之 scheduler</li>
<li><a class="reference external" href="https://github.com/cch123/golang-notes">https://github.com/cch123/golang-notes</a></li>
<li><a class="reference external" href="https://draveness.me/golang/">https://draveness.me/golang/</a>  Go 语言设计与实现</li>
</ul>
</div>
<div class="section" id="go-profiler">
<h6>Go Profiler<a class="headerlink" href="#go-profiler" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>pprof</li>
<li>github.com/uber/go-troch: Flame graph profiler for Go programs，火焰图工具，配合压测看性能瓶颈</li>
<li><a class="reference external" href="https://cizixs.com/2017/09/11/profiling-golang-program/">https://cizixs.com/2017/09/11/profiling-golang-program/</a></li>
<li><a class="reference external" href="https://software.intel.com/en-us/blogs/2014/05/10/debugging-performance-issues-in-go-programs">https://software.intel.com/en-us/blogs/2014/05/10/debugging-performance-issues-in-go-programs</a></li>
</ul>
</div>
<div class="section" id="id13">
<h6>Go 性能优化<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/dgryski/go-perfbook">https://github.com/dgryski/go-perfbook</a></li>
<li><a class="reference external" href="https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html">https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html</a></li>
<li><a class="reference external" href="https://stephen.sh/posts/quick-go-performance-improvements">https://stephen.sh/posts/quick-go-performance-improvements</a></li>
<li><a class="reference external" href="https://mp.weixin.qq.com/s/ogtRE_LbllN2Tla97LnFrQ">https://mp.weixin.qq.com/s/ogtRE_LbllN2Tla97LnFrQ</a></li>
</ul>
</div>
<div class="section" id="goroutines">
<h6>Goroutines<a class="headerlink" href="#goroutines" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://medium.com/&#64;vigneshsk/how-to-write-high-performance-code-in-golang-using-go-routines-227edf979c3c">https://medium.com/&#64;vigneshsk/how-to-write-high-performance-code-in-golang-using-go-routines-227edf979c3c</a></li>
<li><a class="reference external" href="https://udhos.github.io/golang-concurrency-tricks/">https://udhos.github.io/golang-concurrency-tricks/</a></li>
</ul>
</div>
<div class="section" id="id14">
<h6>Go 内存泄露<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://go101.org/article/memory-leaking.html">https://go101.org/article/memory-leaking.html</a></li>
<li><a class="reference external" href="https://colobu.com/2019/08/28/go-memory-leak-i-dont-think-so/">https://colobu.com/2019/08/28/go-memory-leak-i-dont-think-so/</a></li>
</ul>
</div>
<div class="section" id="id15">
<h6>Go 反射<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://segmentfault.com/a/1190000016230264">https://segmentfault.com/a/1190000016230264</a> Go Reflect 高级实践</li>
</ul>
</div>
<div class="section" id="id16">
<h6>Go 网络编程<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://tumregels.github.io/Network-Programming-with-Go/">https://tumregels.github.io/Network-Programming-with-Go/</a>  一本 go 网络编程入门在线电子书</li>
</ul>
</div>
<div class="section" id="id17">
<h6>Go 并发模式<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://blog.golang.org/pipelines">https://blog.golang.org/pipelines</a></li>
</ul>
</div>
<div class="section" id="id18">
<h6>Go 位操作<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://learnku.com/go/t/23460/bit-operation-of-go">https://learnku.com/go/t/23460/bit-operation-of-go</a></li>
</ul>
</div>
<div class="section" id="id19">
<h6>Go 缺陷<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ksimka/go-is-not-good">https://github.com/ksimka/go-is-not-good</a></li>
<li><a class="reference external" href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/">50 Shades of Go: Traps, Gotchas, and Common Mistakes for New Golang Devs</a></li>
<li><a class="reference external" href="https://bluxte.net/musings/2018/04/10/go-good-bad-ugly/">https://bluxte.net/musings/2018/04/10/go-good-bad-ugly/</a></li>
</ul>
</div>
<div class="section" id="go-leetcode">
<h6>Go Leetcode<a class="headerlink" href="#go-leetcode" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/austingebauer/go-leetcode">https://github.com/austingebauer/go-leetcode</a></li>
<li><a class="reference external" href="https://books.halfrost.com/leetcode/">https://books.halfrost.com/leetcode/</a> 一本 go leetcode 题解电子书</li>
</ul>
</div>
<div class="section" id="id20">
<h6>Go 面试<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://goquiz.github.io/">Awesome Go Interview Questions and Answers</a></li>
</ul>
</div>
<div class="section" id="id21">
<h6>Go源码阅读<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h6>
<img alt="_images/gocode阅读.png" src="_images/gocode阅读.png" />
</div>
</div>
<span id="document-go-note/tricks"></span><div class="section" id="go">
<span id="gotricks"></span><h5>Go踩坑<a class="headerlink" href="#go" title="永久链接至标题">¶</a></h5>
<div class="section" id="id1">
<h6>go初学者常见错误<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h6>
<p>强烈建议 go 新手先过一遍下边这篇文章，go 写多了你一定会遇到很多里边总结的坑。</p>
<ul class="simple">
<li><a class="reference external" href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/">50 Shades of Go: Traps, Gotchas, and Common Mistakes for New Golang Devs</a></li>
</ul>
</div>
<div class="section" id="go-tricks">
<h6>Go tricks<a class="headerlink" href="#go-tricks" title="永久链接至标题">¶</a></h6>
<div class="section" id="shadowed-variables">
<h7>影子变量(Shadowed variables)<a class="headerlink" href="#shadowed-variables" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://yourbasic.org/golang/gotcha-shadowing-variables/</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="kc">true</span> <span class="p">{</span>
        <span class="nx">n</span> <span class="o">:=</span> <span class="mi">1</span>
        <span class="nx">n</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="c1">// 0，注意 if 作用与里边使用 := 赋值隐藏了外部的 n，所以原来的 n 打印还是 0</span>
    <span class="c1">// 如果想要修改 n，直接用 n = 1</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="golang-cannot-refer-to-unexported-field-or-method">
<h7>golang cannot refer to unexported field or method<a class="headerlink" href="#golang-cannot-refer-to-unexported-field-or-method" title="永久链接至标题">¶</a></h7>
<p>小写开头只能被本 package 访问</p>
<ul class="simple">
<li><a class="reference external" href="https://stackoverflow.com/questions/24487943/invoke-golang-struct-function-gives-cannot-refer-to-unexported-field-or-method">https://stackoverflow.com/questions/24487943/invoke-golang-struct-function-gives-cannot-refer-to-unexported-field-or-method</a></li>
</ul>
</div>
<div class="section" id="go-package">
<h7>访问其它Go package中的私有函数(不推荐)<a class="headerlink" href="#go-package" title="永久链接至标题">¶</a></h7>
<p>可以写一个公有函数暴露私有方法，不过一般私有方法都是希望隐藏的，就像 python 的下划线虽然不强制，但是不推荐使用。</p>
<ul class="simple">
<li><a class="reference external" href="https://colobu.com/2017/05/12/call-private-functions-in-other-packages/">https://colobu.com/2017/05/12/call-private-functions-in-other-packages/</a></li>
</ul>
</div>
<div class="section" id="can-t-load-package">
<h7>Can&#8217;t load package<a class="headerlink" href="#can-t-load-package" title="永久链接至标题">¶</a></h7>
<p>同一个 folder 不要存在不同 package，否则 can&#8217;t load package</p>
<p>package is folder.  package name is folder name.  package path is folder path.</p>
<ul class="simple">
<li><a class="reference external" href="https://studygolang.com/articles/8312">https://studygolang.com/articles/8312</a></li>
</ul>
</div>
<div class="section" id="id2">
<h7>如何编译期间检查是否实现接口？<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// for pointers to struct</span>
<span class="kd">type</span> <span class="nx">MyType</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="nx">MyInterface</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">MyType</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>  <span class="c1">// 很多源码中可以看到这种写法，但是一开始感觉有点奇怪</span>
<span class="c1">// for struct literals</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="nx">MyInterface</span> <span class="p">=</span> <span class="nx">MyType</span><span class="p">{}</span>
<span class="c1">// for other types - just create some instance</span>
<span class="kd">type</span> <span class="nx">MyType</span> <span class="kt">string</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="nx">MyInterface</span> <span class="p">=</span> <span class="nx">MyType</span><span class="p">(</span><span class="s">&quot;doesn&#39;t matter&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://splice.com/blog/golang-verify-type-implements-interface-compile-time/">https://splice.com/blog/golang-verify-type-implements-interface-compile-time/</a></li>
<li><a class="reference external" href="https://medium.com/&#64;matryer/golang-tip-compile-time-checks-to-ensure-your-type-satisfies-an-interface-c167afed3aae">https://medium.com/&#64;matryer/golang-tip-compile-time-checks-to-ensure-your-type-satisfies-an-interface-c167afed3aae</a></li>
</ul>
</div>
<div class="section" id="id3">
<h7>如何通过反射判断是否实现接口?<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">CustomError</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">CustomError</span><span class="p">)</span> <span class="nx">Error</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testImplements</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 判断某个类型是否实现了接口。</span>
    <span class="c1">// 获取接口类型 reflect.TypeOf((*&lt;interface&gt;)(nil)).Elem()</span>
    <span class="nx">typeOfError</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">((</span><span class="o">*</span><span class="kt">error</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)).</span><span class="nx">Elem</span><span class="p">()</span>
    <span class="nx">customErrorPtr</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">CustomError</span><span class="p">{})</span>
    <span class="nx">customError</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="nx">CustomError</span><span class="p">{})</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">customErrorPtr</span><span class="p">.</span><span class="nx">Implements</span><span class="p">(</span><span class="nx">typeOfError</span><span class="p">))</span> <span class="c1">// true</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">customError</span><span class="p">.</span><span class="nx">Implements</span><span class="p">(</span><span class="nx">typeOfError</span><span class="p">))</span>    <span class="c1">// false</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-undefined">
<h7>Go 运行单个测试文件报错 undefined？<a class="headerlink" href="#go-undefined" title="永久链接至标题">¶</a></h7>
<p>执行命令时加入这个测试文件需要引用的源码文件，在命令行后方的文件都会被加载到command-line-arguments中进行编译</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">go</span> <span class="pre">test</span> <span class="pre">-v</span> <span class="pre">getinfo_test.go</span>&nbsp; <span class="pre">lib.go</span></code></p>
<ul class="simple">
<li><a class="reference external" href="https://www.cnblogs.com/Detector/p/10010292.html">https://www.cnblogs.com/Detector/p/10010292.html</a></li>
<li><a class="reference external" href="https://stackoverflow.com/questions/14723229/go-test-cant-find-function-in-a-same-package">https://stackoverflow.com/questions/14723229/go-test-cant-find-function-in-a-same-package</a></li>
</ul>
</div>
<div class="section" id="go-struct">
<h7>Go 循环遍历 []struct 是值传递<a class="headerlink" href="#go-struct" title="永久链接至标题">¶</a></h7>
<p>注意循环遍历一个结构体切片是值传递，如果想要修改 struct 的值，请使用 slice 下标赋值或者用结构体指针。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Cat</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testSliceAssign</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cats</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Cat</span><span class="p">{</span>
    <span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&quot;cat1&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&quot;cat2&quot;</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cat</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cats</span> <span class="p">{</span> <span class="c1">// cat 这里是拷贝的值</span>
    <span class="nx">cat</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;new cat&quot;</span>  <span class="c1">// NOTE: 注意这里 cat 是拷贝的值，所以你无法修改 cat。使用下标或者指针</span>
  <span class="p">}</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cats</span><span class="p">)</span> <span class="c1">// 无法修改 [{cat1} {cat2}]</span>

  <span class="c1">// 方式1：使用下标</span>
  <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cats</span> <span class="p">{</span>
    <span class="nx">cats</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;new cat&quot;</span>
  <span class="p">}</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cats</span><span class="p">)</span>

  <span class="c1">// 方式2：使用struct 指针</span>
  <span class="nx">pcats</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Cat</span><span class="p">{</span>
    <span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&quot;cat1&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&quot;cat2&quot;</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cat</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pcats</span> <span class="p">{</span>
    <span class="nx">cat</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&quot;new cat&quot;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cat</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pcats</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cat</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-map">
<h7>Go 无法修改值为结构体的map<a class="headerlink" href="#go-map" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">testChangeMapStruct</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span><span class="p">{</span> <span class="nx">Cnt</span> <span class="kt">int</span> <span class="p">}</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">T</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s">&quot;b&quot;</span><span class="p">:</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span> <span class="p">{</span>
        <span class="nx">v</span><span class="p">.</span><span class="nx">Cnt</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>

    <span class="c1">// 修改值为结构体的 map，可以使用指针</span>
    <span class="nx">m2</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">T</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s">&quot;b&quot;</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m2</span> <span class="p">{</span>
        <span class="nx">v</span><span class="p">.</span><span class="nx">Cnt</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">],</span> <span class="nx">m2</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">])</span>

    <span class="c1">// 或者使用 map[k].v 修改</span>
    <span class="nx">m3</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">T</span><span class="p">{</span><span class="s">&quot;a&quot;</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s">&quot;b&quot;</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">T</span><span class="p">{</span><span class="nx">Cnt</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}</span>
    <span class="k">for</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m3</span> <span class="p">{</span>
        <span class="nx">m3</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">Cnt</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m3</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">],</span> <span class="nx">m3</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">])</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">testChangeMapStruct</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="map">
<h7>不要并发读写map，可能导致程序崩溃<a class="headerlink" href="#map" title="永久链接至标题">¶</a></h7>
<p>使用内置 map 注意几点:</p>
<ul class="simple">
<li>使用 make 初始化。直接声明然后赋值会 panic</li>
<li>赋值是浅拷贝。深拷贝需要自己复制</li>
<li>内置 map 不要并发写入或者删除，必须加锁。或者使用 sync.Map</li>
</ul>
<p>如果多个 goroutine 并发对 map 进行读写，必须要同步，否则可能导致进程退出</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://blog.golang.org/go-maps-in-action</span>
<span class="kd">var</span> <span class="nx">counter</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
    <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<span class="p">}{</span><span class="nx">m</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)}</span>

<span class="nx">counter</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span> <span class="c1">// locks for reading</span>
<span class="nx">n</span> <span class="o">:=</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;some_key&quot;</span><span class="p">]</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;some_key:&quot;</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>

<span class="nx">counter</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span> <span class="c1">// locks for writing</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;some_key&quot;</span><span class="p">]</span><span class="o">++</span>
<span class="nx">counter</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="empty-struct">
<h7>如何判断一个空结构体(empty struct)<a class="headerlink" href="#empty-struct" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// 注意需要加上括号，否则 syntax error</span>
<span class="c1">// https://stackoverflow.com/questions/28447297/how-to-check-for-an-empty-struct</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Session</span><span class="p">{})</span> <span class="o">==</span> <span class="nx">session</span>  <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;is zero value&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-go">
<h7>go 如何实现函数默认值(go本身没提供)<a class="headerlink" href="#go-go" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://stackoverflow.com/questions/19612449/default-value-in-gos-method</span>
<span class="c1">// 可以通过传递零值或者 nil 的方式来判断。</span>
<span class="c1">// Both parameters are optional, use empty string for default value</span>
<span class="kd">func</span> <span class="nx">Concat1</span><span class="p">(</span><span class="nx">a</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
    <span class="nx">a</span> <span class="p">=</span> <span class="s">&quot;default-a&quot;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="mi">5</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-slice-map">
<h7>go 初始化 slice/map 的区别<a class="headerlink" href="#go-slice-map" title="永久链接至标题">¶</a></h7>
<p>直接看代码，注意 map 赋值之前需要先 make 创建，直接给一个 nil map 赋值会 panic，但是 slice 却可以直接声明然后 append。
如果是一个 struct 包含了 map，你应该在构造函数里进行 make 初始化，否则直接赋值也会 panic。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// 初始化一个全局 map 可以用 make，防止第一次赋值 nil map 会 panic</span>
<span class="kd">var</span> <span class="nx">globalMap</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="c1">// 之后可以在 init() 函数初始化</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">intSlice</span> <span class="p">[]</span><span class="kt">int</span> <span class="c1">// 注意可以直接声明一个 slice 然后 append</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">intSlice</span><span class="p">)</span>
        <span class="nx">intSlice</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">intSlice</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">intSlice</span><span class="p">)</span>

        <span class="c1">// 已知最大容量的情况下，建议 make 初始化，可以避免重新分配内存提升效率</span>
        <span class="nx">maxCap</span> <span class="o">:=</span> <span class="mi">3</span>
        <span class="nx">intSlice2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">maxCap</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">intSlice2</span><span class="p">)</span>

        <span class="nx">m2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span> <span class="c1">// 如果是 map 要先 make 才可以，否则 panic</span>
        <span class="nx">m2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// ok</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span>

        <span class="c1">// 直接声明然后赋值就会 panic。有一些 struct 包含了 map 结构体成员，构造函数里需要注意初始化 map，否则直接赋值panic</span>
        <span class="c1">// https://stackoverflow.com/questions/27553399/golang-how-to-initialize-a-map-field-within-a-struct</span>
        <span class="kd">var</span> <span class="nx">m1</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span>
        <span class="nx">m1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>          <span class="c1">// NOTE: panic ! 注意这样会panic 啊！！!</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">m1</span><span class="p">)</span>

        <span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span> <span class="p">{</span>
            <span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][</span><span class="kt">int</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="kd">func</span> <span class="nx">NewT</span><span class="p">()</span> <span class="nx">T</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">T</span><span class="p">{</span><span class="nx">m</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)}</span>
            <span class="c1">// return T{m: map[int]int{}}</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-set">
<h7>go 没有内置的 set 结构<a class="headerlink" href="#go-set" title="永久链接至标题">¶</a></h7>
<p>go 目前没有提供泛型，也没提供一个统一的 set 数据结构。可以使用 map[string]bool 来模拟 set(注意并发安全)。
或者使用第三方提供的 set 类型。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/deckarep/golang-set">https://github.com/deckarep/golang-set</a></li>
<li><a class="reference external" href="https://stackoverflow.com/questions/34018908/golang-why-dont-we-have-a-set-datastructure">https://stackoverflow.com/questions/34018908/golang-why-dont-we-have-a-set-datastructure</a></li>
</ul>
</div>
<div class="section" id="tag">
<h7>编译 tag 的作用<a class="headerlink" href="#tag" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// +build linux,386 darwin,!cgo</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://golang.org/pkg/go/build/">https://golang.org/pkg/go/build/</a></li>
</ul>
</div>
<div class="section" id="application-auto-build-versioning">
<h7>Application auto build versioning<a class="headerlink" href="#application-auto-build-versioning" title="永久链接至标题">¶</a></h7>
<p>给 build 的二进制文件加上版本号，注意如果命令中输出有空格，需要加上单引号。
这样我们可以每次运行二进制文件的时候打印构建时间，当前的版本等信息。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// +build linux,386 darwin,!cgo</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kd">var</span> <span class="nx">xyz</span> <span class="kt">string</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">xyz</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// $ go run -ldflags &quot;-X main.xyz=abc&quot; main.go</span>
<span class="c1">// go build -ldflags &quot;-X main.minversion=`date -u +.%Y%m%d.%H%M%S`&quot; service.go</span>
<span class="c1">// go build  -ldflags &quot;-X &#39;main.time=$(date -u --rfc-3339=seconds)&#39; -X &#39;main.git=$(git log --pretty=format:&quot;%h&quot; -1)&#39;&quot;  main.go</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://stackoverflow.com/questions/11354518/application-auto-build-versioning">https://stackoverflow.com/questions/11354518/application-auto-build-versioning</a></li>
</ul>
</div>
<div class="section" id="go-json">
<h7>Go JSON 空值处理的一些坑，看示例<a class="headerlink" href="#go-json" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;encoding/json&quot;</span>
        <span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="c1">// https://www.sohamkamani.com/blog/golang/2018-07-19-golang-omitempty/</span>
<span class="c1">// omitempty 对于0值和，nil，pointer 的处理需要注意下坑。</span>

<span class="kd">func</span> <span class="nx">testNormal</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Breed</span>    <span class="kt">string</span>
                <span class="nx">WeightKg</span> <span class="kt">int</span>
        <span class="p">}</span>
        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
                <span class="nx">Breed</span><span class="p">:</span>    <span class="s">&quot;dalmation&quot;</span><span class="p">,</span>
                <span class="nx">WeightKg</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">// {&quot;Breed&quot;:&quot;dalmation&quot;,&quot;WeightKg&quot;:45}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testOmit</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Breed</span>    <span class="kt">string</span>
                <span class="nx">WeightKg</span> <span class="kt">int</span>
        <span class="p">}</span>
        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
                <span class="nx">Breed</span><span class="p">:</span> <span class="s">&quot;pug&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">//{&quot;Breed&quot;:&quot;pug&quot;,&quot;WeightKg&quot;:0}</span>
        <span class="c1">// 注意没填的字段输出0，如果不想输出0呢？比如想输出 null 或者压根不输出这个字段</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testOmitEmpty</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Breed</span> <span class="kt">string</span>
                <span class="c1">// The first comma below is to separate the name tag from the omitempty tag</span>
                <span class="nx">WeightKg</span> <span class="kt">int</span> <span class="s">`json:&quot;,omitempty&quot;`</span>
        <span class="p">}</span>
        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
                <span class="nx">Breed</span><span class="p">:</span> <span class="s">&quot;pug&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">// {&quot;Breed&quot;:&quot;pug&quot;}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testValuesCannotBeOmitted</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">dimension</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Height</span> <span class="kt">int</span>
                <span class="nx">Width</span>  <span class="kt">int</span>
        <span class="p">}</span>

        <span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Breed</span>    <span class="kt">string</span>
                <span class="nx">WeightKg</span> <span class="kt">int</span>
                <span class="nx">Size</span>     <span class="nx">dimension</span> <span class="s">`json:&quot;,omitempty&quot;`</span>
        <span class="p">}</span>

        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
                <span class="nx">Breed</span><span class="p">:</span> <span class="s">&quot;pug&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">//{&quot;Breed&quot;:&quot;pug&quot;,&quot;WeightKg&quot;:0,&quot;Size&quot;:{&quot;Height&quot;:0,&quot;Width&quot;:0}}</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testValuesCannotBeOmittedButUsePointer</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">dimension</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Height</span> <span class="kt">int</span>
                <span class="nx">Width</span>  <span class="kt">int</span>
        <span class="p">}</span>

        <span class="kd">type</span> <span class="nx">Dog</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">Breed</span>    <span class="kt">string</span>
                <span class="nx">WeightKg</span> <span class="kt">int</span>
                <span class="nx">Size</span>     <span class="o">*</span><span class="nx">dimension</span> <span class="s">`json:&quot;,omitempty&quot;`</span> <span class="c1">//和上一个不同在于这里使用指针</span>
        <span class="p">}</span>

        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Dog</span><span class="p">{</span>
                <span class="nx">Breed</span><span class="p">:</span> <span class="s">&quot;pug&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">// {&quot;Breed&quot;:&quot;pug&quot;,&quot;WeightKg&quot;:0}</span>

<span class="p">}</span>

<span class="c1">// The difference between 0, &quot;&quot; and nil</span>
<span class="c1">// One issue which particularly caused me a lot a trouble is the case where you want to differentiate between a default value, and a zero value.</span>
<span class="c1">//</span>
<span class="c1">// For example, if we have a struct describing a resteraunt, with the number of seated customers as an attribute:</span>
<span class="kd">func</span> <span class="nx">testZeroWillOmit</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">Restaurant</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">NumberOfCustomers</span> <span class="kt">int</span> <span class="s">`json:&quot;,omitempty&quot;`</span>
        <span class="p">}</span>

        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">Restaurant</span><span class="p">{</span>
                <span class="nx">NumberOfCustomers</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">// {}</span>
        <span class="c1">// 输出 {}， 0被省略了</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testZeroPointer</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">type</span> <span class="nx">Restaurant</span> <span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">NumberOfCustomers</span> <span class="o">*</span><span class="kt">int</span> <span class="s">`json:&quot;,omitempty&quot;`</span>
        <span class="p">}</span>
        <span class="nx">d1</span> <span class="o">:=</span> <span class="nx">Restaurant</span><span class="p">{}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d1</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">//Prints: {}</span>

        <span class="nx">n</span> <span class="o">:=</span> <span class="mi">0</span>
        <span class="nx">d2</span> <span class="o">:=</span> <span class="nx">Restaurant</span><span class="p">{</span>
                <span class="nx">NumberOfCustomers</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">n</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">d2</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">//Prints: {&quot;NumberOfCustomers&quot;:0} ，总结一下就是值为 0 的 pointer 也不会省略字段</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// testOmit()</span>
        <span class="c1">// testOmitEmpty()</span>
        <span class="c1">// testValuesCannotBeOmitted()</span>
        <span class="c1">// testValuesCannotBeOmittedButUsePointer()</span>
        <span class="nx">testZeroWillOmit</span><span class="p">()</span>

<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://www.sohamkamani.com/blog/golang/2018-07-19-golang-omitempty/">https://www.sohamkamani.com/blog/golang/2018-07-19-golang-omitempty/</a></li>
<li><a class="reference external" href="https://ethancai.github.io/2016/06/23/bad-parts-about-json-serialization-in-Golang/">https://ethancai.github.io/2016/06/23/bad-parts-about-json-serialization-in-Golang/</a></li>
</ul>
</div>
<div class="section" id="go-int-int64-float-string">
<h7>Go int/int64/float 和 string 转换示例<a class="headerlink" href="#go-int-int64-float-string" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// 推荐一个更加强大的转换库：https://github.com/spf13/cast</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;fmt&quot;</span>
        <span class="s">&quot;strconv&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// 测试 int 和 string(decimal) 互相转换的函数</span>
        <span class="c1">// https://yourbasic.org/golang/convert-int-to-string/</span>
        <span class="c1">// int -&gt; string</span>
        <span class="nx">sint</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="mi">97</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">sint</span><span class="p">,</span> <span class="nx">sint</span> <span class="o">==</span> <span class="s">&quot;97&quot;</span><span class="p">)</span>

        <span class="c1">// byte -&gt; string</span>
        <span class="nx">bytea</span> <span class="o">:=</span> <span class="nb">byte</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nx">bint</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">bytea</span><span class="p">))</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">bint</span><span class="p">)</span>

        <span class="c1">// int64 -&gt; string</span>
        <span class="nx">sint64</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">FormatInt</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="mi">97</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">sint64</span><span class="p">,</span> <span class="nx">sint64</span> <span class="o">==</span> <span class="s">&quot;97&quot;</span><span class="p">)</span>

        <span class="c1">// int64 -&gt; string (hex) ，十六进制</span>
        <span class="nx">sint64hex</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">FormatInt</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="mi">97</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">sint64hex</span><span class="p">,</span> <span class="nx">sint64hex</span> <span class="o">==</span> <span class="s">&quot;61&quot;</span><span class="p">)</span>

        <span class="c1">// string -&gt; int</span>
        <span class="nx">_int</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="s">&quot;97&quot;</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">_int</span><span class="p">,</span> <span class="nx">_int</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="mi">97</span><span class="p">))</span>

        <span class="c1">// string -&gt; int64</span>
        <span class="nx">_int64</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseInt</span><span class="p">(</span><span class="s">&quot;97&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">_int64</span><span class="p">,</span> <span class="nx">_int64</span> <span class="o">==</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">97</span><span class="p">))</span>

        <span class="c1">// https://stackoverflow.com/questions/30299649/parse-string-to-specific-type-of-int-int8-int16-int32-int64</span>
        <span class="c1">// string -&gt; int32，注意 parseInt 始终返回的是 int64，所以还是需要 int32(n) 强转一下</span>
        <span class="nx">_int32</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseInt</span><span class="p">(</span><span class="s">&quot;97&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">_int32</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">_int32</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">97</span><span class="p">))</span>

        <span class="c1">// int32 -&gt; string, https://stackoverflow.com/questions/39442167/convert-int32-to-string-in-golang</span>
        <span class="nx">strconv</span><span class="p">.</span><span class="nx">FormatInt</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// fast</span>
        <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="c1">// fast</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="c1">// slow</span>

        <span class="c1">// int -&gt; int64 ，不会丢失精度</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">97</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">97</span><span class="p">))</span>

        <span class="c1">// string -&gt; float32/float64  https://yourbasic.org/golang/convert-string-to-float/</span>
        <span class="nx">f</span> <span class="o">:=</span> <span class="s">&quot;3.14159265&quot;</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseFloat</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="c1">// 3.1415927410125732</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseFloat</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="c1">// 3.14159265</span>
        <span class="p">}</span>

        <span class="c1">// float -&gt; string https://yourbasic.org/golang/convert-string-to-float/</span>
        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%f&quot;</span><span class="p">,</span> <span class="mf">123.456</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h7>Go struct 如何设置默认值<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h7>
<p>Go 的结构体成员没法直接设置默认值，使用的是每个类型的默认值，可以 New 构造函数里设置。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://stackoverflow.com/questions/37135193/how-to-set-default-values-in-go-structs</span>
<span class="c1">//Something is the structure we work with</span>
<span class="kd">type</span> <span class="nx">Something</span> <span class="kd">struct</span> <span class="p">{</span>
     <span class="nx">Text</span> <span class="kt">string</span>
     <span class="nx">DefaultText</span> <span class="kt">string</span>
<span class="p">}</span>
<span class="c1">// NewSomething create new instance of Something</span>
<span class="kd">func</span> <span class="nx">NewSomething</span><span class="p">(</span><span class="nx">text</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Something</span> <span class="p">{</span>
   <span class="nx">something</span> <span class="o">:=</span> <span class="nx">Something</span><span class="p">{}</span>
   <span class="nx">something</span><span class="p">.</span><span class="nx">Text</span> <span class="p">=</span> <span class="nx">text</span>
   <span class="nx">something</span><span class="p">.</span><span class="nx">DefaultText</span> <span class="p">=</span> <span class="s">&quot;default text&quot;</span>
   <span class="k">return</span> <span class="nx">something</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-enum">
<h7>Go 如何使用枚举值 Enum<a class="headerlink" href="#go-enum" title="永久链接至标题">¶</a></h7>
<p>Go没有提供内置的枚举类型，不过可以使用自定义类型和常量值来实现枚举类型。
并且还可以给自定义的类型定义方法。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Base</span> <span class="kt">int</span>

<span class="kd">const</span> <span class="p">(</span>
        <span class="nx">A</span> <span class="nx">Base</span> <span class="p">=</span> <span class="kc">iota</span>
        <span class="nx">C</span>
        <span class="nx">T</span>
        <span class="nx">G</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://stackoverflow.com/questions/14426366/what-is-an-idiomatic-way-of-representing-enums-in-go">https://stackoverflow.com/questions/14426366/what-is-an-idiomatic-way-of-representing-enums-in-go</a></li>
<li><a class="reference external" href="https://blog.learngoprogramming.com/golang-const-type-enums-iota-bc4befd096d3">https://blog.learngoprogramming.com/golang-const-type-enums-iota-bc4befd096d3</a></li>
</ul>
</div>
<div class="section" id="go-slice">
<h7>Go 如何断判非空字符串/slice<a class="headerlink" href="#go-slice" title="永久链接至标题">¶</a></h7>
<p>标准库实际上 <code class="xref py py-obj docutils literal"><span class="pre">len(s)</span> <span class="pre">!=</span> <span class="pre">0</span></code> 和 <code class="xref py py-obj docutils literal"><span class="pre">s</span> <span class="pre">!=</span> <span class="pre">&quot;&quot;</span></code> 都有使用，我个人倾向于 <code class="xref py py-obj docutils literal"><span class="pre">s</span> <span class="pre">!=</span> <span class="pre">&quot;&quot;</span></code> 看起来更清楚，区分其他容器类型判断的方式。
比如如果使用 slice 可以使用 len(slice) == 0 判断是否为空。</p>
</div>
<div class="section" id="id5">
<h7>Go 清空 slice 两种方式区别<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://yourbasic.org/golang/clear-slice/</span>
<span class="kd">func</span> <span class="nx">testClearSlice</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 1. 赋值 nil 清空</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">}</span>
    <span class="nx">a</span> <span class="p">=</span> <span class="kc">nil</span>                        <span class="c1">// 这种方式会导致 gc 释放底层数组（假设没有其他引用)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span> <span class="c1">// [] 0 0</span>

    <span class="c1">// 2. 使用 s = s[:0] , 注意底层 cap 还是 5</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">}</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>                      <span class="c1">// 不会清空底层数组</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="c1">// [] 0 5</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h7>Go 如何格式化参数<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h7>
<ul class="simple">
<li><a class="reference external" href="https://yourbasic.org/golang/fmt-printf-reference-cheat-sheet/">https://yourbasic.org/golang/fmt-printf-reference-cheat-sheet/</a></li>
</ul>
</div>
<div class="section" id="id7">
<h7>命名返回值<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h7>
<p>go 的返回值可以命名，使用命名返回值有几个用处：</p>
<ul class="simple">
<li>可以当成文档，直观的展示返回值的含义</li>
<li>自动初始化为类型的零值</li>
<li>返回的时候不用写很多参数名，直接用 return 就行</li>
<li>如果想要在 defer 中修改返回值，只能使用命名参数。例子如下</li>
<li>缺点：函数里很容易误用声明一个同名的参数就会被被覆盖了(shadow)</li>
<li>函数返回相同类型的两个或三个参数，或者如果从上下文中不清楚结果的含义，使用命名返回，其它情况不建议使用命名返回。</li>
</ul>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">namedReturn</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">ret</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span> <span class="p">=</span> <span class="nx">i</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">ret</span><span class="o">++</span> <span class="p">}()</span>

    <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">anonReturn</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">ret</span> <span class="o">:=</span> <span class="nx">i</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">ret</span><span class="o">++</span> <span class="p">}()</span> <span class="c1">// 修改 ret 无效</span>
    <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">namedReturn</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="c1">// 1</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">anonReturn</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1">// 0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h7>Go 如何复制map<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h7>
<p>注意 go 和其他很多编程语言一样，对于复合结构是浅拷贝，共享底层数据结构。几个变量指向同一个复合结构的时候注意修改一个对其他变量也是可见的。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// https://stackoverflow.com/questions/23057785/how-to-copy-a-map</span>
<span class="kd">func</span> <span class="nx">copyMap</span><span class="p">(</span><span class="nx">src</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span>
  <span class="nx">res</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">src</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testShareMap</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">am</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
    <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a1&quot;</span><span class="p">:</span> <span class="s">&quot;a1&quot;</span><span class="p">,</span> <span class="s">&quot;b1&quot;</span><span class="p">:</span> <span class="s">&quot;b1&quot;</span><span class="p">},</span>
    <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;a2&quot;</span><span class="p">:</span> <span class="s">&quot;a2&quot;</span><span class="p">,</span> <span class="s">&quot;b2&quot;</span><span class="p">:</span> <span class="s">&quot;b2&quot;</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="nx">bm</span> <span class="o">:=</span> <span class="nx">am</span>
  <span class="nx">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;a1&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;testbm&quot;</span> <span class="c1">// NOTE 这里修改了b，a 里边的也会变。共享 map</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">am</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">cm</span> <span class="p">[]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">am</span> <span class="p">{</span>
    <span class="nx">cm</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cm</span><span class="p">,</span> <span class="nx">copyMap</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="nx">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;a1&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;testcm&quot;</span> <span class="c1">// will not modify am</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">am</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">testShareMap</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h7>闭包问题<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;fmt&quot;</span>
        <span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="c1">// 闭包问题</span>

<span class="kd">func</span> <span class="nx">testClosure</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
                <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
                <span class="p">}()</span>
        <span class="p">}</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// not good, just for demo</span>
        <span class="c1">// three three three</span>
<span class="p">}</span>

<span class="c1">// 两种方式解决：1.使用一个for 循环临时变量</span>
<span class="kd">func</span> <span class="nx">testClosure1</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
                <span class="nx">vcopy</span> <span class="o">:=</span> <span class="nx">v</span>
                <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">vcopy</span><span class="p">)</span>
                <span class="p">}()</span>
        <span class="p">}</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// not good, just for demo</span>
        <span class="c1">// one two three (may wrong order)</span>
<span class="p">}</span>

<span class="c1">// 方法2：使用传给匿名goroutine参数，推荐使用这种方式</span>
<span class="kd">func</span> <span class="nx">testClosure2</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
                <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">in</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span>
                <span class="p">}(</span><span class="nx">v</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// not good, just for demo</span>
        <span class="c1">// one two three (may wrong order)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">field</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">field</span><span class="p">)</span> <span class="nb">print</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">testField</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">field</span><span class="p">{{</span><span class="s">&quot;one&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;two&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;three&quot;</span><span class="p">}}</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
                <span class="c1">// v := v    // NOTE：直接这样就可以解决，</span>
                <span class="c1">// 或者使用 struct 指针。 []*field 初始化</span>
                <span class="k">go</span> <span class="nx">v</span><span class="p">.</span><span class="nb">print</span><span class="p">()</span> <span class="c1">// print three three three</span>
        <span class="p">}</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// testClosure()</span>
        <span class="c1">// testClosure1()</span>
        <span class="c1">// testClosure2()</span>
        <span class="nx">testField</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="failed-type-assertions">
<h7>Failed Type Assertions<a class="headerlink" href="#failed-type-assertions" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">=</span> <span class="s">&quot;hehe&quot;</span>
        <span class="c1">// NOTE: 这里不要用 同名的 data 变量，比如换成 dataInt</span>
        <span class="k">if</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">.(</span><span class="kt">int</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[is an int] value =&gt;&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;[not an int] value =&gt;&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
                <span class="c1">// NOTE ：注意 data 已经被失败的 type assert 赋值成了0</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="an-interface-holding-a-nil-value-is-not-nil">
<h7>An interface holding a nil value is not nil<a class="headerlink" href="#an-interface-holding-a-nil-value-is-not-nil" title="永久链接至标题">¶</a></h7>
<p>An interface holding nil value is not nil. An interface equals nil only if both type and value are nil.</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;a == nil is %t\n&quot;</span><span class="p">,</span> <span class="nx">a</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// a == nil is true</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">*</span><span class="kt">int</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="nx">p</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;b == nil is %t\n&quot;</span><span class="p">,</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// b == nil is false</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h7>逃逸分析<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h7>
<p>想要知道变量在 stask 还是 heap 分配使用 <code class="xref py py-obj docutils literal"><span class="pre">go</span> <span class="pre">run</span> <span class="pre">-gcflags</span> <span class="pre">-m</span> <span class="pre">app.go</span></code></p>
</div>
<div class="section" id="go-test-flag-flag-provided-but-not-defined">
<h7>报错：go test flag: flag provided but not defined<a class="headerlink" href="#go-test-flag-flag-provided-but-not-defined" title="永久链接至标题">¶</a></h7>
<ul class="simple">
<li><a class="reference external" href="https://stackoverflow.com/questions/29699982/go-test-flag-flag-provided-but-not-defined">https://stackoverflow.com/questions/29699982/go-test-flag-flag-provided-but-not-defined</a></li>
</ul>
</div>
<div class="section" id="go-context">
<h7>Go Context 的坑<a class="headerlink" href="#go-context" title="永久链接至标题">¶</a></h7>
<p>调用接收context的函数时要小心，要清楚context在什么时候cancel，什么行为会触发cancel。
笔者最近遇到一个问题是，在框架的 handler 函数返回之前，单独开一个 goroutine 创建一条 mysql 流水，但是handler 函数调用完
成之后框架会cancel，导致这个 mysql 传进去了框架函数带过来的 ctx cancel 之后执行失败</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">handleFunc</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// ... 其他业务逻辑</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// 异步记录流水</span>
        <span class="c1">// 注意，这里不能直接用框架的 ctx，而是需要一个不被 cancel 的 context，否则执行会失败</span>
        <span class="c1">// 改成 context.Background()</span>
        <span class="c1">// if err := postDao.CreatePostCreateRecord(context.Background(), row); err != nil {</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">postDao</span><span class="p">.</span><span class="nx">CreatePostCreateRecord</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">row</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;CreatePost postDao.CreatePostCreateRecord err:%+v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/34417106">https://zhuanlan.zhihu.com/p/34417106</a> 《Go Context的踩坑经历》</li>
</ul>
</div>
</div>
<div class="section" id="redio-tricks">
<h6>redio tricks<a class="headerlink" href="#redio-tricks" title="永久链接至标题">¶</a></h6>
<div class="section" id="redis">
<h7>redis 连接超时<a class="headerlink" href="#redis" title="永久链接至标题">¶</a></h7>
<p>默认是没有超时时间的，注意设置超时时间（connect/read/write)。</p>
<ul class="simple">
<li><a class="reference external" href="https://ms2008.github.io/2019/07/04/golang-redis-deadlock/">https://ms2008.github.io/2019/07/04/golang-redis-deadlock/</a></li>
</ul>
</div>
<div class="section" id="redis-mock">
<h7>redis 单测如何 mock<a class="headerlink" href="#redis-mock" title="永久链接至标题">¶</a></h7>
<p>reids mock 可以用 miniredis，以下是一个示例代码</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&quot;fmt&quot;</span>
  <span class="s">&quot;os&quot;</span>
  <span class="s">&quot;testing&quot;</span>

  <span class="s">&quot;github.com/alicebob/miniredis&quot;</span>
  <span class="s">&quot;github.com/go-redis/redis&quot;</span>
  <span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">followImpl</span> <span class="o">*</span><span class="nx">Follow</span>

<span class="kd">func</span> <span class="nx">setupFollow</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;setup&quot;</span><span class="p">)</span>
  <span class="nx">mr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">miniredis</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;init miniredis failed&quot;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">client</span> <span class="o">:=</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
    <span class="nx">Addr</span><span class="p">:</span> <span class="nx">mr</span><span class="p">.</span><span class="nx">Addr</span><span class="p">(),</span>
  <span class="p">})</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span> <span class="s">&quot;wang&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">Err</span><span class="p">()</span>
  <span class="nx">followImpl</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Follow</span><span class="p">{</span><span class="nx">client</span><span class="p">:</span> <span class="nx">client</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestGet</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">val</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">followImpl</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">)</span>
  <span class="nx">followImpl</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="s">&quot;wang&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestPING</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">PING</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">setupFollow</span><span class="p">()</span>
  <span class="nx">code</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
  <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h6>网络相关<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
<div class="section" id="ip">
<h7>获取本机 ip<a class="headerlink" href="#ip" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;log&quot;</span>
    <span class="s">&quot;net&quot;</span>
    <span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">localIp</span> <span class="kt">string</span> <span class="c1">// 用一个全局变量或者缓存，防止高并发的时候重复频繁系统调用</span>

<span class="c1">// GetIPAddr 获取 server IP</span>
<span class="kd">func</span> <span class="nx">GetIPAddr</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">localIp</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
        <span class="c1">// fmt.Printf(&quot;use local ip %s\n&quot;, localIp)</span>
        <span class="k">return</span> <span class="nx">localIp</span>
    <span class="p">}</span>
    <span class="nx">addrs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">InterfaceAddrs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">addrs</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">ipnet</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">IPNet</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">ipnet</span><span class="p">.</span><span class="nx">IP</span><span class="p">.</span><span class="nx">IsLoopback</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">ipnet</span><span class="p">.</span><span class="nx">IP</span><span class="p">.</span><span class="nx">To4</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">localIp</span> <span class="p">=</span> <span class="nx">ipnet</span><span class="p">.</span><span class="nx">IP</span><span class="p">.</span><span class="nx">String</span><span class="p">()</span>
                <span class="k">return</span> <span class="nx">localIp</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">GetIPAddr</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="go-host">
<h7>Go 网络请求设置 Host 不起作用<a class="headerlink" href="#go-host" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;http://bbb.com/&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="s">&quot;aaa.com&quot;</span>
<span class="c1">// 注意以下不起作用，用 python 习惯使用 header 设置头了，但是 go 里边只能通过 req.Host 设置 host</span>
<span class="c1">// req.Header.Set(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;) // 不起作用！！！</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="go-panic">
<h6>Go panic 场景<a class="headerlink" href="#go-panic" title="永久链接至标题">¶</a></h6>
<p>在《Go 编程之旅》中总结了一些 panic 场景，写 go 的时候注意下，防止进程退出：</p>
<ul class="simple">
<li>数组/切片越界</li>
<li>空指针调用</li>
<li>过早关闭 HTTP 响应体</li>
<li>除以 0</li>
<li>向已经关闭的 channel 发送消息</li>
<li>重复关闭 channel</li>
<li>关闭未初始化的 channel</li>
<li>未初始化 map。注意访问 map 不存在的 key 不会 panic，而是返回 map 类型对应的零值</li>
<li>跨协程的 panic 处理</li>
<li>sync 计数为负数。</li>
<li>类型断言不匹配。<code class="xref py py-obj docutils literal"><span class="pre">var</span> <span class="pre">a</span> <span class="pre">interface{}</span> <span class="pre">=</span> <span class="pre">1;</span> <span class="pre">fmt.Println(a.(string))</span></code> 会 panic，建议用 <code class="xref py py-obj docutils literal"><span class="pre">s,ok</span> <span class="pre">:=</span> <span class="pre">a.(string)</span></code></li>
</ul>
</div>
<div class="section" id="go-web">
<h6>Go Web<a class="headerlink" href="#go-web" title="永久链接至标题">¶</a></h6>
<div class="section" id="id12">
<h7>滚动日志<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h7>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;strings&quot;</span>

    <span class="s">&quot;go.uber.org/zap&quot;</span>
    <span class="s">&quot;go.uber.org/zap/zapcore&quot;</span>
    <span class="nx">lumberjack</span> <span class="s">&quot;gopkg.in/natefinch/lumberjack.v2&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">NewLogger</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">level</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span><span class="p">,</span> <span class="nx">maxSize</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxBackups</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxAge</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">compress</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">serviceName</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span> <span class="p">{</span>
    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">newCore</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">maxSize</span><span class="p">,</span> <span class="nx">maxBackups</span><span class="p">,</span> <span class="nx">maxAge</span><span class="p">,</span> <span class="nx">compress</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">core</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">AddCaller</span><span class="p">(),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Development</span><span class="p">(),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Fields</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;serviceName&quot;</span><span class="p">,</span> <span class="nx">serviceName</span><span class="p">)))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">newCore</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">level</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span><span class="p">,</span> <span class="nx">maxSize</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxBackups</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxAge</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">compress</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Core</span> <span class="p">{</span>
    <span class="c1">//日志文件路径配置</span>
    <span class="nx">hook</span> <span class="o">:=</span> <span class="nx">lumberjack</span><span class="p">.</span><span class="nx">Logger</span><span class="p">{</span>
        <span class="nx">Filename</span><span class="p">:</span>   <span class="nx">filePath</span><span class="p">,</span>   <span class="c1">// 日志文件路径</span>
        <span class="nx">MaxSize</span><span class="p">:</span>    <span class="nx">maxSize</span><span class="p">,</span>    <span class="c1">// 每个日志文件保存的最大尺寸 单位：M</span>
        <span class="nx">MaxBackups</span><span class="p">:</span> <span class="nx">maxBackups</span><span class="p">,</span> <span class="c1">// 日志文件最多保存多少个备份</span>
        <span class="nx">MaxAge</span><span class="p">:</span>     <span class="nx">maxAge</span><span class="p">,</span>     <span class="c1">// 文件最多保存多少天</span>
        <span class="nx">Compress</span><span class="p">:</span>   <span class="nx">compress</span><span class="p">,</span>   <span class="c1">// 是否压缩</span>
    <span class="p">}</span>
    <span class="c1">// 设置日志级别</span>
    <span class="nx">atomicLevel</span> <span class="o">:=</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">NewAtomicLevel</span><span class="p">()</span>
    <span class="nx">atomicLevel</span><span class="p">.</span><span class="nx">SetLevel</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span>
    <span class="c1">//公用编码器</span>
    <span class="nx">encoderConfig</span> <span class="o">:=</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">EncoderConfig</span><span class="p">{</span>
        <span class="nx">TimeKey</span><span class="p">:</span>        <span class="s">&quot;time&quot;</span><span class="p">,</span>
        <span class="nx">LevelKey</span><span class="p">:</span>       <span class="s">&quot;level&quot;</span><span class="p">,</span>
        <span class="nx">NameKey</span><span class="p">:</span>        <span class="s">&quot;logger&quot;</span><span class="p">,</span>
        <span class="nx">CallerKey</span><span class="p">:</span>      <span class="s">&quot;linenum&quot;</span><span class="p">,</span>
        <span class="nx">MessageKey</span><span class="p">:</span>     <span class="s">&quot;msg&quot;</span><span class="p">,</span>
        <span class="nx">StacktraceKey</span><span class="p">:</span>  <span class="s">&quot;stacktrace&quot;</span><span class="p">,</span>
        <span class="nx">LineEnding</span><span class="p">:</span>     <span class="nx">zapcore</span><span class="p">.</span><span class="nx">DefaultLineEnding</span><span class="p">,</span>
        <span class="nx">EncodeLevel</span><span class="p">:</span>    <span class="nx">zapcore</span><span class="p">.</span><span class="nx">LowercaseLevelEncoder</span><span class="p">,</span>  <span class="c1">// 小写编码器</span>
        <span class="nx">EncodeTime</span><span class="p">:</span>     <span class="nx">zapcore</span><span class="p">.</span><span class="nx">ISO8601TimeEncoder</span><span class="p">,</span>     <span class="c1">// ISO8601 UTC 时间格式</span>
        <span class="nx">EncodeDuration</span><span class="p">:</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">SecondsDurationEncoder</span><span class="p">,</span> <span class="c1">//</span>
        <span class="nx">EncodeCaller</span><span class="p">:</span>   <span class="nx">zapcore</span><span class="p">.</span><span class="nx">FullCallerEncoder</span><span class="p">,</span>      <span class="c1">// 全路径编码器</span>
        <span class="nx">EncodeName</span><span class="p">:</span>     <span class="nx">zapcore</span><span class="p">.</span><span class="nx">FullNameEncoder</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">NewCore</span><span class="p">(</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nx">NewJSONEncoder</span><span class="p">(</span><span class="nx">encoderConfig</span><span class="p">),</span>                                           <span class="c1">// json 格式编码器配置</span>
        <span class="nx">zapcore</span><span class="p">.</span><span class="nx">NewMultiWriteSyncer</span><span class="p">(</span><span class="nx">zapcore</span><span class="p">.</span><span class="nx">AddSync</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">),</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">AddSync</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hook</span><span class="p">)),</span> <span class="c1">// 打印到控制台和文件</span>
        <span class="nx">atomicLevel</span><span class="p">,</span> <span class="c1">// 日志级别</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 全局 logger 定义</span>
<span class="kd">var</span> <span class="nx">Logger</span> <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>

<span class="kd">func</span> <span class="nx">getZapLevel</span><span class="p">(</span><span class="nx">level</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">Level</span> <span class="p">{</span>
    <span class="nx">level</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span>
    <span class="k">switch</span> <span class="nx">level</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&quot;debug&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">DebugLevel</span>
    <span class="k">case</span> <span class="s">&quot;info&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">InfoLevel</span>
    <span class="k">case</span> <span class="s">&quot;warn&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">WarnLevel</span>
    <span class="k">case</span> <span class="s">&quot;error&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">ErrorLevel</span>
    <span class="k">case</span> <span class="s">&quot;dpanic&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">DPanicLevel</span>
    <span class="k">case</span> <span class="s">&quot;fatal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">zapcore</span><span class="p">.</span><span class="nx">FatalLevel</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;invalid log level&quot;</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">loglevel</span> <span class="o">:=</span> <span class="s">&quot;debug&quot;</span>
    <span class="nx">Logger</span> <span class="p">=</span> <span class="nx">NewLogger</span><span class="p">(</span><span class="s">&quot;./logs/service.log&quot;</span><span class="p">,</span> <span class="nx">getZapLevel</span><span class="p">(</span><span class="nx">loglevel</span><span class="p">),</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s">&quot;UploadServer&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;hello go!&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-go-note/optimize"></span><div class="section" id="go">
<span id="optimize"></span><h5>Go 性能优化<a class="headerlink" href="#go" title="永久链接至标题">¶</a></h5>
<div class="section" id="string-byte">
<h6>string 与 []byte 互转<a class="headerlink" href="#string-byte" title="永久链接至标题">¶</a></h6>
<p>利用了底层 string 和 byte slice 实现的技巧，如果需要大量互转可以使用这种方式。</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">type StringHeader struct { // reflect.StringHeader</span>
<span class="cm">    Data uintptr</span>
<span class="cm">    Len  int</span>
<span class="cm">}</span>
<span class="cm">type SliceHeader struct { // reflect.SliceHeader</span>
<span class="cm">    Data uintptr</span>
<span class="cm">    Len  int</span>
<span class="cm">    Cap  int</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kd">func</span> <span class="nx">str2bytes</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
   <span class="nx">x</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">))</span>
   <span class="nx">b</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="kt">uintptr</span><span class="p">{</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
   <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">bytes2str</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
   <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">string</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://segmentfault.com/a/1190000005006351">Go性能优化技巧</a></li>
<li><a class="reference external" href="https://medium.com/&#64;kevinbai/golang-%E4%B8%AD-string-%E4%B8%8E-byte-%E4%BA%92%E8%BD%AC%E4%BC%98%E5%8C%96-6651feb4e1f2">Golang 中 string 与 []byte 互转优化</a></li>
</ul>
</div>
<div class="section" id="id2">
<h6>大量字符串拼接<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>大量字符串拼接不要用 + ，使用 bytes.Buffer 或者 strings.Builder</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// bytes.Buffer</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;bytes&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">b</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>

    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;def&quot;</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span> <span class="c1">// abcdef</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// strings.Builder</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;strings&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sb</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Builder</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;First&quot;</span><span class="p">)</span>
    <span class="nx">sb</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;Second&quot;</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">sb</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>    <span class="c1">// FirstSecond</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://golangdocs.com/concatenate-strings-in-golang">concatenate strings in golang</a></li>
<li><a class="reference external" href="https://stackoverflow.com/questions/1760757/how-to-efficiently-concatenate-strings-in-go">How to efficiently concatenate strings in go</a></li>
</ul>
</div>
</div>
<span id="document-go-note/algorithms"></span><div class="section" id="go">
<span id="go-algorithms"></span><h5>Go 算法和数据结构<a class="headerlink" href="#go" title="永久链接至标题">¶</a></h5>
<p>刷题过程中会遇到一些通用数据结构的封装，在这里记录一下。注意因为是刷算法题用的，没有考虑 goroutine 安全，
不要直接用在并发环境，如果是在生产环境中使用请加锁改造。(没有泛型写起来挺繁琐的)</p>
<div class="section" id="stack">
<h6>Stack<a class="headerlink" href="#stack" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Stack</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">st</span> <span class="p">[]</span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">NewStack</span><span class="p">()</span> <span class="o">*</span><span class="nx">Stack</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Stack</span><span class="p">{</span><span class="nx">st</span><span class="p">:</span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Stack</span><span class="p">)</span> <span class="nx">Push</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">st</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Stack</span><span class="p">)</span> <span class="nx">Peek</span><span class="p">()</span> <span class="kt">int</span><span class="p">{</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Stack</span><span class="p">)</span> <span class="nx">Pop</span><span class="p">()</span> <span class="kt">int</span><span class="p">{</span>
    <span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">)</span>
    <span class="nx">top</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">st</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">[:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">top</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Stack</span><span class="p">)</span> <span class="nx">Empty</span><span class="p">()</span> <span class="kt">bool</span><span class="p">{</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">st</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="queue">
<h6>Queue<a class="headerlink" href="#queue" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">Item</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Num</span>   <span class="kt">int</span>
    <span class="nx">Order</span> <span class="kt">int</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Queue</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">items</span> <span class="p">[]</span><span class="nx">Item</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">NewQueue</span><span class="p">()</span> <span class="o">*</span><span class="nx">Queue</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Queue</span><span class="p">{</span>
        <span class="nx">items</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Item</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nx">Push</span><span class="p">(</span><span class="nx">x</span> <span class="nx">Item</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">items</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nx">Pop</span><span class="p">()</span> <span class="nx">Item</span> <span class="p">{</span>
    <span class="nx">x</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">items</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="nx">x</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nx">Front</span><span class="p">()</span> <span class="nx">Item</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nx">End</span><span class="p">()</span> <span class="nx">Item</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">Queue</span><span class="p">)</span> <span class="nx">Empty</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="deque">
<h6>Deque<a class="headerlink" href="#deque" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;container/list&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="c1">// 滑动窗口最大值</span>

<span class="kd">type</span> <span class="nx">Deque</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ll</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">NewDeque</span><span class="p">()</span> <span class="o">*</span><span class="nx">Deque</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Deque</span><span class="p">{</span><span class="nx">ll</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">New</span><span class="p">()}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">PushFront</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">PushFront</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">PushBack</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">Pop</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// remove back</span>
    <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Back</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">PopFront</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// remove first</span>
    <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Front</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">Front</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Front</span><span class="p">().</span><span class="nx">Value</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">Back</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Back</span><span class="p">().</span><span class="nx">Value</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">dq</span> <span class="o">*</span><span class="nx">Deque</span><span class="p">)</span> <span class="nx">Len</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dq</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Len</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="linked-list">
<h6>Linked List<a class="headerlink" href="#linked-list" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="c1">// 测试链表。在 redigo 里边使用到了链表作为 pool 的实现</span>
<span class="kd">type</span> <span class="nx">IntList</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">count</span> <span class="kt">int</span>
    <span class="c1">// front,back 分别指向第一个和最后一个 node，或者是 nil。front.prev back.next 都是空</span>
    <span class="nx">front</span><span class="p">,</span> <span class="nx">back</span> <span class="o">*</span><span class="nx">Node</span>
<span class="p">}</span>

<span class="c1">// 链表节点</span>
<span class="kd">type</span> <span class="nx">Node</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">next</span><span class="p">,</span> <span class="nx">prev</span> <span class="o">*</span><span class="nx">Node</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">IntList</span><span class="p">)</span> <span class="nx">Count</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">count</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">IntList</span><span class="p">)</span> <span class="nx">pushFront</span><span class="p">(</span><span class="nx">node</span> <span class="o">*</span><span class="nx">Node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">front</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// note when list is empty</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="p">=</span> <span class="nx">node</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">front</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="nx">node</span>
    <span class="p">}</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">front</span> <span class="p">=</span> <span class="nx">node</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">IntList</span><span class="p">)</span> <span class="nx">popFront</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">first</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">front</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>
    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">front</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">first</span><span class="p">.</span><span class="nx">next</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">front</span> <span class="p">=</span> <span class="nx">first</span><span class="p">.</span><span class="nx">next</span>
    <span class="p">}</span>
    <span class="nx">first</span><span class="p">.</span><span class="nx">next</span><span class="p">,</span> <span class="nx">first</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span> <span class="c1">// clear first</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">IntList</span><span class="p">)</span> <span class="nx">popBack</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">last</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">back</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>
    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">front</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">last</span><span class="p">.</span><span class="nx">prev</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="p">=</span> <span class="nx">last</span><span class="p">.</span><span class="nx">prev</span>
    <span class="p">}</span>
    <span class="nx">last</span><span class="p">.</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">last</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">IntList</span><span class="p">)</span> <span class="nx">Print</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">cur</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">front</span>
    <span class="k">for</span> <span class="nx">cur</span> <span class="o">!=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">cur</span><span class="p">)</span>
        <span class="nx">cur</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">next</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">back</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">back</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="trie">
<h6>Trie<a class="headerlink" href="#trie" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">// Package main provides ...</span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="c1">// https://golangbyexample.com/trie-implementation-in-go/</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">ALBHABET_SIZE</span> <span class="p">=</span> <span class="mi">26</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">node</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">childrens</span> <span class="p">[</span><span class="nx">ALBHABET_SIZE</span><span class="p">]</span><span class="o">*</span><span class="nx">node</span>
    <span class="nx">isWordEnd</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">trie</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">root</span> <span class="o">*</span><span class="nx">node</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">newTrie</span><span class="p">()</span> <span class="o">*</span><span class="nx">trie</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">trie</span><span class="p">{</span>
        <span class="nx">root</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">node</span><span class="p">{},</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">trie</span><span class="p">)</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">word</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wordLength</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">word</span><span class="p">)</span>
    <span class="nx">current</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">root</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">wordLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">idx</span> <span class="o">:=</span> <span class="nx">word</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span>
        <span class="k">if</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childrens</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">current</span><span class="p">.</span><span class="nx">childrens</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">node</span><span class="p">{}</span>
        <span class="p">}</span>
        <span class="nx">current</span> <span class="p">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childrens</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">current</span><span class="p">.</span><span class="nx">isWordEnd</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">trie</span><span class="p">)</span> <span class="nx">find</span><span class="p">(</span><span class="nx">word</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">wordLength</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">word</span><span class="p">)</span>
    <span class="nx">current</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">root</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">wordLength</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">idx</span> <span class="o">:=</span> <span class="nx">word</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span>
        <span class="k">if</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childrens</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        <span class="nx">current</span> <span class="p">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">childrens</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">current</span><span class="p">.</span><span class="nx">isWordEnd</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">trie</span> <span class="o">:=</span> <span class="nx">newTrie</span><span class="p">()</span>
    <span class="nx">words</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;zhang&quot;</span><span class="p">,</span> <span class="s">&quot;wang&quot;</span><span class="p">,</span> <span class="s">&quot;li&quot;</span><span class="p">,</span> <span class="s">&quot;zhao&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">words</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">trie</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">words</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="nx">toFind</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;zhang&quot;</span><span class="p">,</span> <span class="s">&quot;wang&quot;</span><span class="p">,</span> <span class="s">&quot;li&quot;</span><span class="p">,</span> <span class="s">&quot;zhao&quot;</span><span class="p">,</span> <span class="s">&quot;gong&quot;</span><span class="p">}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">toFind</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">toFind</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">trie</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;word[%s] found in trie.\n&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;word[%s] not found in trie\n&quot;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="orderedmap-python-collections-ordereddict">
<h6>OrderedMap (类似 python collections.OrderedDict)<a class="headerlink" href="#orderedmap-python-collections-ordereddict" title="永久链接至标题">¶</a></h6>
<p>模拟 python collections.OrderedDict 写的，可以方便的实现 lru 等</p>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;container/list&quot;</span>
    <span class="s">&quot;fmt&quot;</span>
<span class="p">)</span>

<span class="c1">// 按照 key 插入顺序遍历 map，类似 python collections.OrderedDict。注意不是 key 的字典序，而是插入顺序</span>
<span class="kd">type</span> <span class="nx">OrderedMap</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">m</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
    <span class="nx">me</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">Element</span>
    <span class="nx">ll</span> <span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">List</span> <span class="c1">// 记录 key order</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">NewOrderedMap</span><span class="p">()</span> <span class="o">*</span><span class="nx">OrderedMap</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">OrderedMap</span><span class="p">{</span>
        <span class="nx">m</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">),</span>
        <span class="nx">me</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">list</span><span class="p">.</span><span class="nx">Element</span><span class="p">),</span>
        <span class="nx">ll</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">New</span><span class="p">(),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Set</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">PushBack</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">me</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">e</span>
    <span class="p">}</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Exist</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">found</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Delete</span><span class="p">(</span><span class="nx">k</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>

    <span class="nx">node</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">me</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Len</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 按照 key 进入顺序返回</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">OrderedMap</span><span class="p">)</span> <span class="nx">Keys</span><span class="p">()</span> <span class="p">[]</span><span class="kt">string</span> <span class="p">{</span>
    <span class="nx">keys</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Len</span><span class="p">())</span>
    <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">ll</span><span class="p">.</span><span class="nx">Front</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Value</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
        <span class="nx">i</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">keys</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-go-note/design_patterns"></span><div class="section" id="go">
<span id="go-design-patterns"></span><h5>Go 设计模式<a class="headerlink" href="#go" title="永久链接至标题">¶</a></h5>
<div class="section" id="singleton">
<h6>单例模式(Singleton)<a class="headerlink" href="#singleton" title="永久链接至标题">¶</a></h6>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;sync&quot;</span>
<span class="p">)</span>

<span class="cm">/*</span>
<span class="cm">go 单例模式：</span>

<span class="cm">1. 使用 lock，为了并发安全，使用 lock + double check</span>
<span class="cm">2. 使用 sync.Once</span>
<span class="cm">3. 使用 init() The init function is only called once per file in a package,  so we can be sure that only a single instance will be created</span>

<span class="cm">参考：</span>

<span class="cm">- https://blog.cyeam.com/designpattern/2015/08/12/singleton</span>
<span class="cm">- https://golangbyexample.com/all-design-patterns-golang/</span>
<span class="cm">- https://medium.com/golang-issue/how-singleton-pattern-works-with-golang-2fdd61cd5a7f</span>
<span class="cm">*/</span>

<span class="kd">var</span> <span class="nx">lock</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">{}</span>

<span class="kd">type</span> <span class="nx">single</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">singleInstance</span> <span class="o">*</span><span class="nx">single</span>

<span class="kd">func</span> <span class="nx">getInstance</span><span class="p">()</span> <span class="o">*</span><span class="nx">single</span> <span class="p">{</span>
     <span class="k">if</span> <span class="nx">singleInstance</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// 防止每次调用 getInstance 都频繁加锁</span>
         <span class="nx">lock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
         <span class="k">defer</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
         <span class="c1">// double check. 如果超过一个goroutine进入这里，保证只有一个 goroutine 创建</span>
         <span class="k">if</span> <span class="nx">singleInstance</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
             <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Creting Single Instance Now&quot;</span><span class="p">)</span>
             <span class="nx">singleInstance</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">single</span><span class="p">{}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
             <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Single Instance already created-1&quot;</span><span class="p">)</span>
         <span class="p">}</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Single Instance already created-2&quot;</span><span class="p">)</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nx">singleInstance</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
         <span class="k">go</span> <span class="nx">getInstance</span><span class="p">()</span>
     <span class="p">}</span>
     <span class="c1">// Scanln is similar to Scan, but stops scanning at a newline and</span>
     <span class="c1">// after the final item there must be a newline or EOF.</span>
     <span class="nx">fmt</span><span class="p">.</span><span class="nx">Scanln</span><span class="p">()</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">// 使用 once</span>
<span class="cm">var once sync.Once</span>

<span class="cm">type single struct {</span>
<span class="cm">}</span>

<span class="cm">var singleInstance *single</span>

<span class="cm">func getInstance() *single {</span>
<span class="cm">     if singleInstance == nil {</span>
<span class="cm">         once.Do(</span>
<span class="cm">             func() {</span>
<span class="cm">                 fmt.Println(&quot;Creting Single Instance Now&quot;)</span>
<span class="cm">                 singleInstance = &amp;single{}</span>
<span class="cm">             })</span>
<span class="cm">     } else {</span>
<span class="cm">         fmt.Println(&quot;Single Instance already created-2&quot;)</span>
<span class="cm">     }</span>
<span class="cm">     return singleInstance</span>
<span class="cm">}</span>
<span class="cm">*/</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-microservice_distribute/index"></span><div class="section" id="web">
<h4>微服务/分布式 web 组件<a class="headerlink" href="#web" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-microservice_distribute/library"></span><div class="section" id="library">
<span id="id1"></span><h5>微服务/分布式系统组件<a class="headerlink" href="#library" title="永久链接至标题">¶</a></h5>
<p>介绍一些微服务中的常见问题，包括常见概念，中间件，开源系统等，佛系更新中。</p>
<div class="section" id="id2">
<h6>限流器<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>某些业务需要针对 IP 或者用户来进行一个限流操作，减少恶意请求，减轻服务器压力或者根据业务需求来进行频率控制。
限流可以在很多层面去做，比如 nginx+lua, API Gateway，或者在接口层直接来做，一般可以结合 redis 来做为计数器。
解决高并发问题有一下一些实现方式，可以根据业务场景选择：</p>
<ul class="simple">
<li>扩容</li>
<li>静态化(cdn)</li>
<li>限流</li>
<li>缓存</li>
<li>队列(削峰，解耦)</li>
</ul>
<p>常见的几种限流算法有计数器算法、漏桶算法、令牌桶算法。</p>
<ul class="simple">
<li>token bucket。令牌桶算法。允许突发流量。<a class="reference external" href="https://github.com/juju/ratelimit">https://github.com/juju/ratelimit</a> 或者 go 自带的 <a class="reference external" href="https://github.com/golang/time">https://github.com/golang/time</a></li>
<li>leaky bucket。漏桶算法。以恒定速率处理(恒定速率漏水) <a class="reference external" href="https://github.com/uber-go/ratelimit">https://github.com/uber-go/ratelimit</a></li>
<li>redis incr/expire。最简单的一种方式，通过 redis 针对用户或者 ip key 来计数，可以加上用户信息作为 key</li>
<li>redis zset。可以实现基于时间窗口来限流。不过不适合短期内大量 qps 限流，适合用户行为限流</li>
</ul>
<p>你可以在网上很方便的搜索 『rate limiter』 来找到对应的实现。</p>
<ul class="simple">
<li><a class="reference external" href="https://juejin.im/post/5eb2cfcce51d4528dd23bd7e">分布式系统高可用实战之限流器（Go 版本实现）</a></li>
<li><a class="reference external" href="https://juejin.cn/post/6915591543797596174#heading-6">5种常见限流算法</a></li>
</ul>
</div>
<div class="section" id="circuit-breaker">
<h6>断路器/熔断器(Circuit Breaker)<a class="headerlink" href="#circuit-breaker" title="永久链接至标题">¶</a></h6>
<p>在分布式系统中，为了防止级联错误，导致服务雪崩，经常需要使用断路器来保护系统。断路器原理如下：</p>
<img alt="_images/熔断器原理.png" src="_images/熔断器原理.png" />
<p>Netflix 开源的 Hystrix 是比较流行的开源实现，对应的有各种其他语言的实现，比如 Hystrix-go</p>
<p>参考:</p>
<ul class="simple">
<li><a class="reference external" href="https://medium.com/&#64;trongdan_tran/circuit-breaker-and-retry-64830e71d0f6">Circuit Breaker and Retry</a></li>
</ul>
</div>
<div class="section" id="id">
<h6>分布式 id 生成器(发号器)<a class="headerlink" href="#id" title="永久链接至标题">¶</a></h6>
<p>单机 mysql 一般我们直接使用 mysql 提供的自增 id 作为主键，但是分布式系统下需要别的算法来保证多机 mysql 全局自增唯一 id。
一般有如下一些实现方式，各有优劣，可以根据自己的业务灵活选取：</p>
<ul class="simple">
<li>发号器(snowflake 算法)</li>
<li>uuid</li>
</ul>
<p>一般来说单调递增整形 id 对于索引更加友好，所以一般我们可以使用 snowflake 之类的算法来分配 id，其大致原理如下：</p>
<img alt="_images/slowflake.png" src="_images/slowflake.png" />
<p>网上依旧很多开源实现，你可以搜索到一些 snowflake 的 golang 实现，注意依赖时间戳有些可能有时钟回拨问题。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/bwmarrin/snowflake">bwmarrin/snowflake</a></li>
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/107939861">9种分布式ID生成方式</a></li>
</ul>
</div>
<div class="section" id="rpc">
<h6>RPC<a class="headerlink" href="#rpc" title="永久链接至标题">¶</a></h6>
<p>在分布式系统中，不同业务模块之间可以通过消息队列或者 rpc 来进行通信。</p>
</div>
<div class="section" id="id5">
<h6>服务发现<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id6">
<h6>配置中心<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id7">
<h6>健康检查<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="elk">
<h6>日志聚合(ELK)<a class="headerlink" href="#elk" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="tracing">
<h6>分布式跟踪(tracing)<a class="headerlink" href="#tracing" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id8">
<h6>异常跟踪<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<p>分布式系统中，和追踪日志一样也会遇到集中收集程序异常的问题。这里推荐笔者公司常用的一个系统叫做 sentry。它可以收集
和展示比如 Python 的异常或者 golang 的 error并收集上下文，方便我们快速排查程序中的严重问题。</p>
</div>
<div class="section" id="id9">
<h6>应用程序指标<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id10">
<h6>分布式锁<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<p>单机上可以使用 go 提供的 sync 包加锁，分布式情况下一般有几种方式：</p>
<ul class="simple">
<li>redis: 借助 setnx。性能较高</li>
<li>zookpeer: 适合分布式调度，不适合高频率持有时间短的抢锁场景</li>
<li>etcd</li>
</ul>
</div>
<div class="section" id="id11">
<h6>消息队列<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id12">
<h6>延时队列<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<p>在分布式系统中经常需要触发一些延后执行的任务，比如启动取消未支付订单、定时给预定会的人员发送消息、外卖下单后提醒小哥即将超时，
这个使用一般会使用到延时队列。常见的实现方式是使用 redis zset/死信队列/时间轮/多层时间轮等。
有一些语言框架直接帮我们实现好了， 比如 python celery, golang 的 machinery 等，也可以直接拿来用，一般需要一个消息队列作为broker.</p>
<ul class="simple">
<li><a class="reference external" href="https://zhuanlan.zhihu.com/p/266156267">你真的知道怎么实现一个延迟队列吗</a></li>
</ul>
</div>
<div class="section" id="id14">
<h6>分布式缓存<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id15">
<h6>常见缓存使用模式<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>Cache Aside: 如果数据在缓存中直接读取缓存；如果没有缓存 <strong>应用从数据库读取</strong> ；更新数据到缓存(下次直接可以从缓存读取了)</li>
<li>Read Through: 如果数据在缓存中直接读取缓存；如果不存在 <strong>缓存负责从数据库读取</strong> ；缓存返回给应用。应用只和缓存交互</li>
<li>Write Through: 应用写到缓存；缓存直接写到数据库</li>
<li>Write Back (Write Behind): 应用直接写到缓存；缓存定期把更新刷新到数据库</li>
</ul>
<p>参考：</p>
<ul class="simple">
<li><a class="reference external" href="https://bluzelle.com/blog/things-you-should-know-about-database-caching">https://bluzelle.com/blog/things-you-should-know-about-database-caching</a></li>
</ul>
</div>
<div class="section" id="id16">
<h6>缓存问题（雪崩，击穿，穿透，回源）<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li>缓存和数据库双写一致性问题</li>
<li>缓存雪崩: 缓存同一时间全部失效导致数据库瞬间压力陡增引起雪崩。缓存宕机，设置相同过期时间可能导致。(热数据集中淘汰)<ul>
<li>缓存时间加上超时随机，防止同时大量缓存失效</li>
<li>加锁或者队列的方式保证不会同时对数据库进行读写</li>
</ul>
</li>
<li>缓存击穿: 某个key缓存过期的那一刻，同时大量请求击穿打到数据库，瞬时数据库压力陡增。可以使用 singleflight 模式避免，原
理就是当缓存失效的时候，相同 key 的请求只放行一个到后台数据库，减少请求压力。多线程获取应该用锁限制只有一个线程回源。</li>
<li>缓存穿透: 大量查询 key 不存在导致请求回源到数据库，导致数据库压力增大甚至宕机。(比如爬虫遍历抓取碰到大量不存在内容)<ul>
<li>可以把所有可能存在的数据放到足够到的bitmap 或者布隆过滤器中，查询之前如果不在其中则过滤掉</li>
<li>查询不到的值也放到缓存中加上较短的失效时间</li>
</ul>
</li>
<li>缓存污染：爬虫批量抓取导致缓存了很多冷数据</li>
<li>缓存并发竞争</li>
<li>缓存预热。上线之前可以通过脚本来进行预热，定期刷新</li>
<li>热点key。热点 key 导致单机 redis 压力陡增，通过 key hash分散热点或者使用本地缓存的方式(多级缓存)，减小 redis 压力</li>
<li>回源。过期 key 会回源一般有两种方式，一种是被动更新，一种是主动更新。
- 被动更新：缓存过期的时候回源到 db，注意防止击穿，使用 singleflight 模式或者分布式锁保证只有一个线程回源。
- 主动更新：db 数据更新之后可以写入消息队列，消费者拉取信息更新本地缓存。</li>
</ul>
</div>
<div class="section" id="id17">
<h6>双写不一致性问题<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id18">
<h6>分布式事务<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id19">
<h6>超卖问题<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h6>
<p>在关系数据库之外进行热卖商品的库存扣减操作。使用分布式锁会比较重。有以下两种方式：</p>
<ul class="simple">
<li>基于乐观锁实现库存扣减。redis WATCH/MULTI/EXEC 命令结合即可实现乐观锁效果。</li>
<li>结合 lua 脚本实现库存扣减。 redis执行 EVAL/EVALSHA 把它当做单条命令在执行，操作原子。扣减成功后，可以写入到消息队列实现削峰，保证写入到数据库的流量可控。</li>
</ul>
</div>
<div class="section" id="elasticsearch">
<h6>搜索引擎(Elasticsearch)<a class="headerlink" href="#elasticsearch" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id20">
<h6>业务边界划分(领域驱动设计)<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h6>
<p>笔者感觉微服务的业务划分不光是一个技术问题，还是一个业务问题。笔者经历过的一些项目有时候感觉拆分太细，不像是微服务，反而
是微函数或者微接口了，维护和部署成本急剧升高。粒度太粗了可能又成了一个大的单体项目。
微服务有自己的优势，但也有缺点，比如需要较高的 devops 水平，良好的基础设施，合理的业务代码划分等，如果做不好可能微
服务带来的问题会比收益要多。所以微服务可能也不是银弹，需要根据当前的业务合理选择。</p>
</div>
<div class="section" id="id21">
<h6>参考:<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h6>
<ul class="simple">
<li><a class="reference external" href="https://github.com/doocs/advanced-java">https://github.com/doocs/advanced-java</a></li>
<li>《微服架构设计模式》 一本比较好的讲微服务架构实现的书籍</li>
<li><a class="reference external" href="https://github.com/theanalyst/awesome-distributed-systems">https://github.com/theanalyst/awesome-distributed-systems</a></li>
<li><a class="reference external" href="https://github.com/ty4z2008/Qix/blob/master/ds">https://github.com/ty4z2008/Qix/blob/master/ds</a>.md#</li>
</ul>
</div>
</div>
<span id="document-microservice_distribute/theory"></span><div class="section" id="theory">
<span id="id1"></span><h5>分布式理论知识<a class="headerlink" href="#theory" title="永久链接至标题">¶</a></h5>
<p>本章介绍后端常用到的分布式理论知识，包括 cap，base理论，一致性协议算法等。</p>
<div class="section" id="id2">
<h6>一致性模型<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>弱一致性(最终一致性):</p>
<ul class="simple">
<li>DNS(Domain Name System)</li>
<li>Gossip</li>
</ul>
<p>强一致性:</p>
<ul class="simple">
<li>主从同步(一致性高，可用性低)<ul>
<li>master 接受写清球</li>
<li>master 复制日志到 slave</li>
<li>master 等待直到所有从库返回。</li>
</ul>
</li>
<li>Paxos</li>
<li>Raft (multi-paxos)</li>
<li>ZAB (multi-paxos)</li>
</ul>
</div>
<div class="section" id="paxos">
<h6>Paxos<a class="headerlink" href="#paxos" title="永久链接至标题">¶</a></h6>
<div class="section" id="bacic-paxos">
<h7>Bacic Paxos<a class="headerlink" href="#bacic-paxos" title="永久链接至标题">¶</a></h7>
<p>角色：</p>
<ul class="simple">
<li>Client: 系统外部角色，请求发起者。(民众)</li>
<li>Proposer: 接收 client 请求，向集群踢出提议(propose)。(议员)</li>
<li>Accpetor(Voter): 提议投票和接收者，只有在形成法定人数(Quorum，一般为majority多数派)时，提议才会被接受。(过会)</li>
<li>Learner: 提议接受者, backup，备份。对一群一致性无影响。(记录员)</li>
</ul>
<p>阶段：</p>
<ul class="simple">
<li>1a: Prepare: Proposer提出一个提案编号N，此 N 大于这个 proposer 之前踢出的编号。请求 Accpetor的quorum接</li>
<li>1b: Promise: 请求 N 大于此 Acceptor 之前接受的任何提案编号则接受，否则拒绝</li>
<li>2a: Accept: 如果达到了多数派,Proposer 会发出 accept 请求(包含N)和提案内容</li>
<li>2b: Accepted: 如果Acceptor在此期间没有接收到任何编号大于N的提案，则接受此提案内容，否则忽略</li>
</ul>
<p>潜在问题：活锁(liveness)或dueling。解决方案，随机超时</p>
<p>难实现，效率低（2轮RPC)，活锁</p>
</div>
<div class="section" id="multi-paxos">
<h7>Multi Paxos<a class="headerlink" href="#multi-paxos" title="永久链接至标题">¶</a></h7>
<p>新概念，Leader： 唯一的Proposer，所有请求都需要经过此 Leader</p>
</div>
<div class="section" id="fast-paxos">
<h7>Fast Paxos<a class="headerlink" href="#fast-paxos" title="永久链接至标题">¶</a></h7>
</div>
</div>
<div class="section" id="raft">
<h6>Raft<a class="headerlink" href="#raft" title="永久链接至标题">¶</a></h6>
</div>
</div>
</div>
</div>
<span id="document-tracing/index"></span><div class="section" id="id1">
<h4>后台服务搭建<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-tracing/sentry"></span><div class="section" id="sentry">
<span id="id1"></span><h5>Sentry 搭建<a class="headerlink" href="#sentry" title="永久链接至标题">¶</a></h5>
<div class="section" id="id2">
<h6>Sentry 简介<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h6>
<p>Sentry 是一个 Python 社区中使用广泛的错误收集系统，可以用来收集并归类 Python 异常/Go error 等信息，在知乎/腾讯内部等都有使用。
你可以把它类比成错误收集的 ELK，虽然它也可以展示收集的日志，不过出于性能等因素考虑，一般只用来收集错误和异常，通过官方提供的开源版本，
可以很容易使用 docker 运行它。</p>
<ul class="simple">
<li>官网：<a class="reference external" href="https://sentry.io/welcome/">https://sentry.io/welcome/</a></li>
<li>优势：相比在浩如烟海的日志中搜索异常信息，使用 Sentry 你可以更加容易发现程序中的严重错误并及时修复，同时附带上有用的上下文信息帮助你排查异常。</li>
</ul>
</div>
<div class="section" id="docker-docker-compose">
<h6>安装 Docker 和 Docker Compose<a class="headerlink" href="#docker-docker-compose" title="永久链接至标题">¶</a></h6>
<div class="code sh highlight-none"><div class="highlight"><pre><span></span>curl -sSL https://get.daocloud.io/docker | sh

sudo easy_install pip
sudo pip3 install docker-compose==1.24.1 -i https://pypi.doubanio.com/simple
sudo pip3 install docker-compose -i https://pypi.doubanio.com/simple
</pre></div>
</div>
<p>pip 如果安装某个包有问题：</p>
<p><code class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">requests</span> <span class="pre">--ignore-installed</span> <span class="pre">requests</span></code></p>
</div>
<div class="section" id="dockerhub">
<h6>DockerHub 加速器<a class="headerlink" href="#dockerhub" title="永久链接至标题">¶</a></h6>
<p>参考：<a class="reference external" href="https://cloud.tencent.com/document/product/457/9113">https://cloud.tencent.com/document/product/457/9113</a></p>
<p><code class="docutils literal"><span class="pre">sudo</span> <span class="pre">vi</span> <span class="pre">/etc/docker/daemon.json</span></code></p>
<div class="code json highlight-none"><div class="highlight"><pre><span></span>{
   &quot;registry-mirrors&quot;: [
       &quot;https://mirror.ccs.tencentyun.com&quot;
  ]
}
</pre></div>
</div>
<p>重启docker</p>
<div class="code sh highlight-none"><div class="highlight"><pre><span></span>sudo systemctl daemon-reload
sudo systemctl restart docker
</pre></div>
</div>
<p>使用 <code class="docutils literal"><span class="pre">docker</span> <span class="pre">info</span></code> 检查 Registry Mirrors 是否正确。</p>
</div>
<div class="section" id="id3">
<h6>使用官方安装脚本<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="https://develop.sentry.dev/self-hosted/">https://develop.sentry.dev/self-hosted/</a></p>
<div class="code sh highlight-none"><div class="highlight"><pre><span></span>wget https://github.com/getsentry/onpremise/archive/20.11.0.zip
unzip 20.11.0.zip
cd onpremise-20.11.0/
sudo ./install.sh
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h6>启动服务<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span># https://develop.sentry.dev/self-hosted/#productionalizing
# 启动服务
docker-compose up -d

# 重启
docker-compose restart web worker cron sentry-cleanup

# 或者直接重启所有服务
docker-compose restart
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h6>创建管理员<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
<p>执行 <code class="docutils literal"><span class="pre">./install.sh</span></code>
安装脚本的时候会提示是否创建用户，如果跳过了还可以单独创建：</p>
<div class="code sh highlight-none"><div class="highlight"><pre><span></span>sudo docker-compose run --rm web createuser
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-memo/memo"></span><div class="section" id="memo">
<span id="id1"></span><h4>个人备忘录<a class="headerlink" href="#memo" title="永久链接至标题">¶</a></h4>
<blockquote>
<div>好记性不如烂笔头. - 中国谚语</div></blockquote>
<div class="section" id="python">
<h5>Python<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># python起文件服务器</span>
<span class="n">python3</span><span class="o">.</span><span class="mi">4</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHTTPServer</span>    <span class="c1"># python2</span>

<span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="n">script</span><span class="o">.</span><span class="n">py</span>   <span class="c1"># 刷新缓冲，执行脚本重定向结果到文件时候比较有用</span>

<span class="c1"># logging</span>
<span class="n">FATAL</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ERROR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">WARNING</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">INFO</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DEBUG</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 使用virtualenv制定python版本</span>
<span class="n">virtualenv</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span> <span class="n">ENV2</span><span class="o">.</span><span class="mi">7</span>

<span class="c1"># pyenv 安装多个版本的 python : https://github.com/pyenv/pyenv</span>
<span class="c1"># pyenv-virtualenv https://github.com/pyenv/pyenv-virtualenv</span>
<span class="c1"># mac install multiple version of python</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">pyenv</span> <span class="n">pyenv</span><span class="o">-</span><span class="n">virtualenv</span>
<span class="n">pyenv</span> <span class="n">install</span> <span class="mf">3.6</span><span class="o">.</span><span class="mi">4</span>  <span class="c1"># install python3.6.4</span>
<span class="n">pyenv</span> <span class="n">virtualenv</span> <span class="mf">3.6</span><span class="o">.</span><span class="mi">4</span> <span class="n">v3</span><span class="o">.</span><span class="mf">6.4</span>
<span class="n">pyenv</span> <span class="n">activate</span> <span class="n">v3</span><span class="o">.</span><span class="mf">6.4</span>
<span class="n">pyenv</span> <span class="n">deactivate</span>

<span class="c1"># 格式化 json，这个可以配置在 vim 里用来格式化当前 json 文本</span>
<span class="n">cat</span> <span class="n">some</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">json</span><span class="o">.</span><span class="n">tool</span>
</pre></div>
</div>
</div>
<div class="section" id="pip-easy-install">
<h5>pip/easy_install<a class="headerlink" href="#pip-easy-install" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 服务器上有时候没有 root 权限可以试试</span>
<span class="c1"># https://stackoverflow.com/questions/7465445/how-to-install-python-modules-without-root-access</span>

<span class="c1"># https://stackoverflow.com/questions/12332975/installing-python-module-within-code</span>
<span class="c1"># pip install</span>
<span class="kn">import</span> <span class="nn">pip</span>

<span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
    <span class="n">pip</span><span class="o">.</span><span class="n">main</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="n">package</span><span class="p">])</span>

<span class="c1"># Example</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">install</span><span class="p">(</span><span class="s1">&#39;argh&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>更换源, vi ~/.pip/pip.conf</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="o">[</span>global<span class="o">]</span>
<span class="nv">timeout</span> <span class="o">=</span> <span class="m">60</span>
index-url <span class="o">=</span> http://pypi.douban.com/simple
trusted-host <span class="o">=</span> pypi.douban.com
</pre></div>
</div>
</div>
<div class="section" id="ipython">
<h5>IPython<a class="headerlink" href="#ipython" title="永久链接至标题">¶</a></h5>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># ipython 如何使用 autoreload，每次重新修改了文件都得重新重启 ipython 很麻烦，解决方式</span>
<span class="c1"># https://support.enthought.com/hc/en-us/articles/204469240-Jupyter-IPython-After-editing-a-module-changes-are-not-effective-without-kernel-restart</span>
<span class="c1"># https://stackoverflow.com/questions/1254370/reimport-a-module-in-python-while-interactive</span>
<span class="c1"># http://ipython.readthedocs.io/en/stable/config/extensions/autoreload.html</span>
In <span class="o">[</span><span class="m">1</span><span class="o">]</span>: %load_ext autoreload
In <span class="o">[</span><span class="m">2</span><span class="o">]</span>: %autoreload <span class="m">2</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span># -*- coding: utf-8 -*-

# ~/.ipython/profile_default/startup/startup.py
# Ned&#39;s .startup.py file    ipython 启动加载文件，用来导入一些自定义函数或者模块，方便调试
# http://stackoverflow.com/questions/11124578/automatically-import-modules-when-entering-the-python-or-ipython-interpreter

print(&quot;(.startup.py)&quot;)

import datetime as dt
import os
import pprint
import re
import sys
import time
import json
import requests as req

try:
    import matplotlib.pyplot as plt
    import pandas as pd
    from pandas import Series, DataFrame
    import numpy as np
except ImportError:
    pass

print(&quot;(imported datetime, os, pprint, re, sys, time, json)&quot;)

def _json_dumps(dict_data, indent=4):
    &quot;&quot;&quot;用来处理一些包含中文的 json 输出&quot;&quot;&quot;
    print(json.dumps(dict_data, indent=indent, ensure_ascii=False))

def _repr_dict(d):
    &quot;&quot;&quot;https://stackoverflow.com/questions/25118698/print-python-dictionary-with-utf8-values&quot;&quot;&quot;
    print(&#39;{%s}&#39; % &#39;,\n&#39;.join(&quot;&#39;%s&#39;: &#39;%s&#39;&quot; % pair for pair in d.iteritems()))

def _json_dumps(dict_data, indent=4):
    &quot;&quot;&quot;用来处理一些包含中文的 json 输出&quot;&quot;&quot;
    print(json.dumps(dict_data, indent=indent, ensure_ascii=False))


repr_dict = _repr_dict
pp = pprint.pprint
json_dumps = _json_dumps

# http://shawnleezx.github.io/blog/2015/08/03/some-notes-on-ipython-startup-script/
&quot;&quot;&quot;
!!! 注意，如果遇到了 TypeError: super(type, obj): obj must be an instance or subtype of type
请禁用 autoreload, http://thomas-cokelaer.info/blog/2011/09/382/
&quot;&quot;&quot;
from IPython import get_ipython
ipython = get_ipython()

# ipython.magic(&quot;pylab&quot;)
ipython.magic(&quot;load_ext autoreload&quot;)
ipython.magic(&quot;autoreload 2&quot;)

# Ipython 技巧，如何查询文档，比如 time.time 方法的文档
# https://jakevdp.github.io/PythonDataScienceHandbook/01.01-help-and-documentation.html
&gt;&gt;&gt; import time
&gt;&gt;&gt; time.time?  # 回车之后可以输出该函数的 docstring 文档
&gt;&gt;&gt; time.time??  # 回车之后可以输出该函数的定义
</pre></div>
</div>
</div>
<div class="section" id="ipdb">
<h5>Ipdb<a class="headerlink" href="#ipdb" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span># ~/.pdbrc
# https://github.com/gotcha/ipdb/issues/111

import os
alias kk os._exit(0)    # 如果不幸在循环里打了断点，可以用 os._exit(0) 跳出

alias pd for k in sorted(%1.keys()): print &quot;%s: %s&quot; % (k, (%1[k]))

# https://stackoverflow.com/questions/21123473/how-do-i-manipulate-a-variable-whose-name-conflicts-with-pdb-commands
# 如果 pdb 里的内置命令和内置函数冲突了，可以加上 ! 使用内置函数
!next(iter)
</pre></div>
</div>
</div>
<div class="section" id="chrome-mac">
<h5>Chrome(Mac)<a class="headerlink" href="#chrome-mac" title="永久链接至标题">¶</a></h5>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># 使用 comamnd + l 可以立即定位到 url 输入框</span>
<span class="c1"># 使用 vimium 或者 surfingkeys 插件可以用 vim 的模式操作 chrome</span>
<span class="c1"># 用 vimium 如何不用鼠标从 url 输入框回到网页:</span>
https://superuser.com/questions/324266/google-chrome-mac-set-keyboard-focus-from-address-bar-back-to-page/324267#324267
https://xavierchow.github.io/2016/03/07/vimium-leave-address-bar/
<span class="c1"># 清理 dns cache, https://superuser.com/questions/203674/how-to-clear-flush-the-dns-cache-in-google-chrome</span>
Navigate to chrome://net-internals/#dns <span class="c1"># and press the &quot;Clear host cache&quot; button.</span>

<span class="c1"># 收藏夹。注意分类收藏，否则后来会收藏多了比较乱。使用 surfingkeys ab (add bookmark) 和 gb(收藏夹管理) 可以快速操作</span>

<span class="c1"># 黑科技：如何chrome 证书认证（不推荐）</span>
在网页中输入 thisisunsafe 或者 badidea 就可以了
</pre></div>
</div>
</div>
<div class="section" id="macos">
<h5>MacOS<a class="headerlink" href="#macos" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span># NOTE: 使用『时间机器』定期备份你的mac 是一个好习惯，笔者买了一个移动硬盘用来定期备份
# 文件字符串批量替换，git项目里替换的时候注意指定文件类型，防止破坏git信息
find . -name \*.py -exec sed -i &#39;&#39; &#39;s/old/new/g&#39; {} \;
# copy that data into the system’s paste buffer
cat file.txt | pbcopy
# The pbpaste command lets you take data from the system’s paste buffer and write it to standard out.
pbcopy &lt; birthday.txt
pbpaste | ag name
pbpaste &gt; filename

# updatedb https://superuser.com/questions/109590/whats-the-equivalent-of-linuxs-updatedb-command-for-the-mac
sudo /usr/libexec/locate.updatedb

# homebrew 更换源, https://maomihz.com/2016/06/tutorial-6/
cd /usr/local
git remote set-url origin git://mirrors.ustc.edu.cn/brew.git

cd /usr/local/Library/Taps/homebrew/homebrew-core
git remote set-url origin git://mirrors.ustc.edu.cn/homebrew-core.git

# 从终端查 wifi 密码, https://apple.stackexchange.com/questions/176119/how-to-access-the-wi-fi-password-through-terminal
security find-generic-password -ga &quot;ROUTERNAME&quot; | grep &quot;password:&quot;

# XXX.APP已损坏,打不开.你应该将它移到废纸篓 MACOS 10.12 SIERRA，允许“任何来源” https://zhuanlan.zhihu.com/p/135948430
sudo spctl --master-disable

# 使用 mounty 挂载 ntfs 盘，Item &quot;file.mov&quot; is used by Mac OS X and cannot be opened.
# https://apple.stackexchange.com/questions/136157/mov-file-in-external-hd-greyed-out-and-wont-open-this-item-is-used-by-mac-o?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa
cd /Volumes/[drive name]
xattr -d com.apple.FinderInfo *
# or
SetFile -c &quot;&quot; -t &quot;&quot; path/to/file.mov

# mac 使用命令挂载
diskutil mount /dev/disk1s2
diskutil unmount /dev/disk1s2

# 使用 rmtrash 删除到 trash，防止危险的 rm 删除命令找不回来。在 bashrc or zshrc alias rm=&#39;rmtrash &#39;
# 如果是 linux 用户，可以使用 safe-rm https://github.com/kaelzhang/shell-safe-rm
# 删除的文件会放到 $HOME/.Trash 方便恢复
brew install rmtrash  # npm install -g safe-rm; alias rm=&#39;safe-rm&#39;

# 增加 terminal 光标移动速度, https://stackoverflow.com/questions/4489885/how-can-i-increase-the-cursor-speed-in-terminal
# defaults write NSGlobalDomain KeyRepeat -int 1
mac: 系统设置-&gt; 键盘 -&gt; 修改按键重复到最快，重复前延迟最短。可以让光标在终端里移动更快

# 如何在文件更新之后自动刷新浏览器，需要首先 pip 安装 when-changed
alias flush_watch_refresh_chrome=&quot; when-changed -v -r -1 -s ./ osascript -e &#39;tell application \&quot;Google Chrome\&quot; to tell the active tab of its first window to reload&#39; &quot;

# 如何启用三指拖移(新版本把改设置移动到了辅助功能，使用三指移动可以方便地移动窗口，一般我会启用提高效率)
辅助功能 -&gt; 鼠标与触控板 -&gt; 触控板选项 -&gt; 启用拖移 (之后就能直接三指翻译单词了)

# 如何解决 mac 突然没有声音的问题(系统 bug，音频守护进程 coreaudiod出了问题)
sudo killall coreaudiod

# mac 如何使用 realpath, https://stackoverflow.com/questions/3572030/bash-script-absolute-path-with-os-x
# brew install coreutils
grealpath file

# mac trackpad 蓝牙频繁掉线问题。尝试使用 5G wifi 而不是 2.4G
# https://apple.stackexchange.com/questions/321948/why-does-my-magic-trackpad-2-randomly-disconnect-and-stop-clicking

# 软件：pathfinder 如何增加 隔空投送 airdrop 分享文件
https://support.cocoatech.com/discussions/problems/126873-full-airdrop-sharing-is-here-for-pf8-and-pf7
</pre></div>
</div>
<p>如何发送 mac 通知，可以用来做提示</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># https://stackoverflow.com/questions/17651017/python-post-osx-notification</span>
<span class="c1"># 配合 crontab 可以用来做一个简单的定时任务提醒功能 57-59 17 * * * python ~/.tmp/noti.py</span>


<span class="c1"># ~/.tmp/noti.py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              osascript -e &#39;display notification &quot;</span><span class="si">{}</span><span class="s2">&quot; with title &quot;</span><span class="si">{}</span><span class="s2">&quot;&#39;</span>
<span class="s2">              &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">title</span><span class="p">))</span>

<span class="n">notify</span><span class="p">(</span><span class="s2">&quot;开会啦&quot;</span><span class="p">,</span> <span class="s2">&quot;Go Go Go !!!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ssh">
<h5>SSH<a class="headerlink" href="#ssh" title="永久链接至标题">¶</a></h5>
<p>二次验证自动登录跳板机脚本，根据你的密码和服务器配置修改即可。</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># 有二次验证登录跳板机的时候比较麻烦，可以用这个脚本自动登录跳板机 参考：https://juejin.im/post/5ce760cef265da1b6e657d6f</span>
<span class="c1"># brew install expect</span>
<span class="c1"># brew install oath-toolkit</span>
<span class="c1"># {user} {ip} {yourpassword} {server_qr_token} 替换成对应的 用户名、ip、密码、服务器秘钥</span>
<span class="n">export</span> <span class="n">LC_CTYPE</span><span class="o">=</span><span class="s2">&quot;en_US.UTF-8&quot;</span>
<span class="n">expect</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;</span>
<span class="n">spawn</span> <span class="n">ssh</span> <span class="n">user</span><span class="nd">@ip</span> <span class="o">-</span><span class="n">p22</span>
<span class="nb">set</span> <span class="n">timeout</span> <span class="mi">3</span>
<span class="n">expect</span>  \<span class="s2">&quot;user@ip&#39;s password:</span><span class="se">\&quot;</span>
<span class="nb">set</span> <span class="n">password</span> <span class="n">yourpassword</span>
<span class="nb">set</span> <span class="n">token</span> \<span class="s2">&quot;`oathtool --totp -b -d 6 server_qr_token`</span><span class="se">\&quot;</span>
<span class="n">send</span> \<span class="s2">&quot;\$password\$token</span><span class="se">\r\&quot;</span>
<span class="n">interact</span>
<span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="mac-wi1000x">
<h5>Mac 蓝牙耳机(自用索尼 wi1000x)<a class="headerlink" href="#mac-wi1000x" title="永久链接至标题">¶</a></h5>
<p>如何给Macbook Pro 开启 Apt-X 蓝牙音质 <a class="reference external" href="https://www.jianshu.com/p/a1efa561ed9e">https://www.jianshu.com/p/a1efa561ed9e</a>
使用播放器 Audirvana Plus</p>
</div>
<div class="section" id="proxy">
<h5>Proxy<a class="headerlink" href="#proxy" title="永久链接至标题">¶</a></h5>
<p>mac电脑下设置socks5代理 <a class="reference external" href="https://blog.csdn.net/fafa211/article/details/78387899">https://blog.csdn.net/fafa211/article/details/78387899</a></p>
</div>
<div class="section" id="oh-my-zsh">
<h5>Oh My Zsh<a class="headerlink" href="#oh-my-zsh" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># Powerlevel9k 是一个强大的 zsh 主题</span>
<span class="c1"># iTerm2 + Oh My Zsh + Solarized color scheme + Meslo powerline font + [Powerlevel9k] - (macOS)</span>
<span class="c1"># https://gist.github.com/kevin-smets/8568070</span>

<span class="c1"># https://gist.github.com/dogrocker/1efb8fd9427779c827058f873b94df95</span>
<span class="c1"># 安装自动补全插件</span>
git clone https://github.com/zsh-users/zsh-autosuggestions.git <span class="nv">$ZSH_CUSTOM</span>/plugins/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="nv">$ZSH_CUSTOM</span>/plugins/zsh-syntax-highlighting
<span class="c1"># nvi ~/.zshrc</span>
<span class="nv">plugins</span><span class="o">=(</span>git zsh-autosuggestions zsh-syntax-highlighting<span class="o">)</span>

<span class="c1"># 如何复制上一条命令, https://apple.stackexchange.com/questions/110343/copy-last-command-in-terminal</span>
<span class="nb">alias</span> <span class="nv">lcc</span><span class="o">=</span><span class="s1">&#39;fc -ln -1 | awk &quot;{\$1=\$1}1&quot; ORS=&quot;&quot; | pbcopy &#39;</span>

<span class="c1"># 报错：_git:58: _git_commands: function definition file not found</span>
<span class="c1"># 解决方式：rm ~/.zcompdump*; rm ~/.zplug/zcompdump  # https://github.com/robbyrussell/oh-my-zsh/issues/3996</span>
<span class="c1"># rm ~/.zcompdump; exec zsh -l  # https://github.com/ohmyzsh/ohmyzsh/issues/3996</span>
</pre></div>
</div>
</div>
<div class="section" id="linux-centos-ubuntu">
<h5>Linux(centos/ubuntu)<a class="headerlink" href="#linux-centos-ubuntu" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 查看版本</span>
<span class="n">lsb_release</span> <span class="o">-</span><span class="n">a</span>

<span class="c1"># virtual box虚拟机和windows主机共享目录方法：安装增强工具；win主机设置共享目录例如ubuntu_share；在ubuntu里建立/mnt/share后使用命令：</span>

<span class="n">sudo</span> <span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">vboxsf</span> <span class="n">ubuntu_share</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">share</span><span class="o">/</span>

<span class="c1"># 映射capslock 为　ctrl</span>
<span class="n">setxkbmap</span> <span class="o">-</span><span class="n">layout</span> <span class="n">us</span> <span class="o">-</span><span class="n">option</span> <span class="n">ctrl</span><span class="p">:</span><span class="n">nocaps</span>

<span class="c1"># 文件字符串批量替换</span>
<span class="n">grep</span> <span class="n">oldString</span> <span class="o">-</span><span class="n">rl</span> <span class="o">/</span><span class="n">path</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;s/oldString/newString/g&quot;</span>

<span class="c1"># 递归删除某一类型文件</span>
<span class="n">find</span> <span class="o">.</span> <span class="o">-</span><span class="n">name</span> <span class="s2">&quot;*.bak&quot;</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">delete</span>

<span class="c1"># 监控某一日志文件变化</span>
<span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="n">t</span><span class="o">.</span><span class="n">log</span>

<span class="c1"># 类似mac pbcopy, apt-get install xsel</span>
<span class="n">cat</span> <span class="n">README</span><span class="o">.</span><span class="n">TXT</span> <span class="o">|</span> <span class="n">xsel</span>
<span class="n">cat</span> <span class="n">README</span><span class="o">.</span><span class="n">TXT</span> <span class="o">|</span> <span class="n">xsel</span> <span class="o">-</span><span class="n">b</span> <span class="c1"># 如有问题可以试试-b选项</span>
<span class="n">xsel</span> <span class="o">&lt;</span> <span class="n">README</span><span class="o">.</span><span class="n">TXT</span>
<span class="c1"># 将readme.txt的文本放入剪贴板</span>

<span class="n">xsel</span> <span class="o">-</span><span class="n">c</span>
<span class="c1"># 清空剪贴板</span>

<span class="c1"># 可以把代码文件贴到paste.ubuntu.com共享，此命令返回一个网址</span>
<span class="c1"># sudo apt-get install pastebinit; sudo pip install configobj</span>
<span class="n">pastebinit</span> <span class="o">-</span><span class="n">i</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>


<span class="c1"># json格式化输出</span>
<span class="n">echo</span> <span class="s1">&#39;{&quot;foo&quot;: &quot;lorem&quot;, &quot;bar&quot;: &quot;ipsum&quot;}&#39;</span> <span class="o">|</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">json</span><span class="o">.</span><span class="n">tool</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">json</span><span class="o">.</span><span class="n">tool</span> <span class="n">my_json</span><span class="o">.</span><span class="n">json</span>
<span class="c1"># 或者apt-get intsall jq</span>
<span class="n">jq</span> <span class="o">.</span> <span class="o">&lt;&lt;&lt;</span> <span class="s1">&#39;{ &quot;foo&quot;: &quot;lorem&quot;, &quot;bar&quot;: &quot;ipsum&quot;  }&#39;</span>


<span class="c1"># 进程相关</span>
<span class="n">dmesg</span> <span class="o">|</span> <span class="n">egrep</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">B100</span> <span class="s1">&#39;killed process&#39;</span>   <span class="c1"># 查看被杀死进程信息</span>
<span class="c1"># linux 批量杀掉筛选进程(比如定时脚本多个同时执行，最好限制) https://blog.csdn.net/weiyichenlun/article/details/59108463</span>
<span class="n">ps</span> <span class="o">-</span><span class="n">ef</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">grep</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="o">|</span> <span class="n">xargs</span> <span class="n">kill</span> <span class="o">-</span><span class="mi">9</span>

<span class="c1"># scp</span>
<span class="n">scp</span> <span class="n">someuser</span><span class="o">@</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">199.1</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">someuser</span><span class="o">/</span><span class="n">file</span> <span class="o">./</span>    <span class="c1"># 远程机器拷贝到本机</span>
<span class="n">scp</span> <span class="o">./</span><span class="n">file</span> <span class="n">someuser</span><span class="o">@</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">199.1</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">someuser</span><span class="o">/</span>    <span class="c1"># 拷贝到远程机器</span>

<span class="c1"># tar</span>
<span class="n">tar</span> <span class="n">zxvf</span> <span class="n">FileName</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>    <span class="c1"># 解压</span>
<span class="n">tar</span> <span class="n">zcvf</span> <span class="n">FileName</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="n">DirName</span>    <span class="c1"># 压缩</span>
</pre></div>
</div>
<p>代码搜索用ag/rg, 比ack快</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>sudo apt-get install silversearcher-ag    # ubuntu
brew install ag
ag string dir/    # search dir
ag readme$    # regular expression
ag -Q .rb    # Literal Expression Searches, search for the exact pattern
ag string -l    # Listing Files (-l)
ag string -i    # Case Insensitive Searches (-i)
ag string -G py$    # 搜索应py结尾的文件
ag readme -l --ignore-dir=railties/lib    # 忽略文件夹
ag readme -l --ignore-dir=&quot;*.rb&quot;    # 忽略特性类型文件
.agignore    # 用来忽略一些vcs，git等文件。
</pre></div>
</div>
</div>
<div class="section" id="centos">
<h5>Centos<a class="headerlink" href="#centos" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># 如何搜索和安装指定版本</span>
<span class="c1"># https://unix.stackexchange.com/questions/151689/how-can-i-instruct-yum-to-install-a-specific-version-of-package-x</span>
yum --showduplicates list golang
yum install package-version
</pre></div>
</div>
</div>
<div class="section" id="crontab">
<h5>crontab<a class="headerlink" href="#crontab" title="永久链接至标题">¶</a></h5>
<p>分、时、日、月、周</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 记得bashrc里边</span>
<span class="n">EXPORT</span> <span class="n">EDITOR</span><span class="o">=</span><span class="n">vim</span>
<span class="n">export</span> <span class="n">PYTHONIOENCODING</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>

<span class="c1"># crontab注意：绝对路径；环境变量；</span>
<span class="mi">0</span> <span class="o">*/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">python</span> <span class="o">-</span><span class="n">u</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">wechannel</span><span class="o">/</span><span class="n">crawler</span><span class="o">/</span><span class="n">sougou_wechat</span><span class="o">/</span><span class="n">sougou</span><span class="o">.</span><span class="n">py</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">wechannel</span><span class="o">/</span><span class="n">crawler</span><span class="o">/</span><span class="n">sougou_wechat</span><span class="o">/</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="o">*/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span>  <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">pyhome</span><span class="o">/</span><span class="n">crawler</span><span class="o">/</span><span class="n">lagou</span><span class="o">/</span><span class="n">changeip</span><span class="o">.</span><span class="n">sh</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">pyhome</span><span class="o">/</span><span class="n">crawler</span><span class="o">/</span><span class="n">lagou</span><span class="o">/</span><span class="n">ip</span><span class="o">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>
</div>
<p>可以用如下方式执行依赖其他模块的python脚本，用run.sh执行run.py，记得chmod +x可执行权限，运行前执行下sh脚本测试能否成功</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>#!/usr/bin/env bash
PREFIX=$(cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd)
cd $PREFIX
source ~/.bashrc

python -u run.py    # -u 参数强制刷新输出
date
</pre></div>
</div>
<p>对于python脚本，可以用如下方式保证同一时间只有一个脚本在运行（一些定时任务同一台机器上多个同时跑可能有问题），可以用
如下方式限制。（多个机器上应该用分布式锁）</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

import <span class="nb">time</span>
<span class="c1"># https://stackoverflow.com/questions/380870/make-sure-only-a-single-instance-of-a-program-is-running</span>
<span class="c1"># 更好的方式使用 tendo</span>
<span class="c1"># pip install tendo</span>
from tendo import singleton
<span class="nv">me</span> <span class="o">=</span> singleton.SingleInstance<span class="o">()</span> <span class="c1"># will sys.exit(-1) if other instance is running</span>

def main<span class="o">()</span>:
    time.sleep<span class="o">(</span><span class="m">10</span><span class="o">)</span>
    print<span class="o">(</span>time.time<span class="o">())</span>

<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span>:
    main<span class="o">()</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/crontab.html">《crontab快速参考》</a></li>
</ul>
</div>
<div class="section" id="iterm2-terminal">
<h5>Iterm2/Terminal<a class="headerlink" href="#iterm2-terminal" title="永久链接至标题">¶</a></h5>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># https://stackoverflow.com/questions/11913990/iterm2-keyboard-shortcut-for-moving-tabs-around</span>
<span class="c1"># Preferences/Keys 自定义配置使用 Cmd +jk 来在 Iterm2 tab 前后移动，模仿 vim 键位</span>

<span class="c1"># 如何防止 command+w 意外关闭导致工作丢失，这里可以如下设置，每次关闭提醒</span>
<span class="c1"># Settings -&gt; Profiles -&gt; Session -&gt; Prompt before closing 勾选 Always</span>

<span class="c1"># 如何使用 rz/sz 传文件</span>
https://segmentfault.com/a/1190000012166969

<span class="c1"># 如何使用 iterm2 it2copy 从 服务器上用 vim 拷贝文件</span>
<span class="c1"># https://stackoverflow.com/questions/10694516/vim-copy-mac-over-ssh/10703012</span>
<span class="m">1</span>. 安装 iTerm2 Utilities 到服务器。iTerm2 -&gt; Install shell Integratio。后边是 bash or zsh，根据你用的 shell 选择
 curl -L https://iterm2.com/shell_integration/install_shell_integration_and_utilities.sh <span class="p">|</span> zsh
<span class="m">2</span>. 重新登录之后 it2copy 生效
<span class="m">3</span>. 在 vim visual 模式选择之后 执行 <span class="sb">`</span>:w !it2copy<span class="sb">`</span> 即可。或这直接 cat file.txt <span class="p">|</span> it2copy

<span class="c1"># 终端输出乱序。有时候有一些脚本或者软件可能会修改终端配置但是失败后又没有恢复，导致输出乱序，解决如下</span>
<span class="sb">`</span>stty sane<span class="sb">`</span> 或者 <span class="sb">`</span>reset<span class="sb">`</span>
</pre></div>
</div>
</div>
<div class="section" id="tmux">
<h5>Tmux<a class="headerlink" href="#tmux" title="永久链接至标题">¶</a></h5>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># https://wiki.archlinux.org/index.php/tmux</span>
tmux rename -t oriname newname
tmux att -t name -d               <span class="c1"># -d 不同窗口全屏</span>

<span class="c1"># 如果手贱在本机tmux里又ssh到服务器又进入服务器的tmux怎么办(退出 tmux 套娃)</span>
c-b c-b d

<span class="c1"># 如果升级了 tmux 之后，使用 tmux 出现 tmux server exited unexpectedly 尝试删除 /tmp 里的 tmux 临时文件</span>
<span class="c1"># https://github.com/tmux/tmux/issues/2376</span>

<span class="c1"># Vim style pane selection</span>
<span class="nb">bind</span> -n C-h <span class="k">select</span>-pane -L
<span class="nb">bind</span> -n C-j <span class="k">select</span>-pane -D
<span class="nb">bind</span> -n C-k <span class="k">select</span>-pane -U
<span class="nb">bind</span> -n C-l <span class="k">select</span>-pane -R

<span class="c1"># https://stackoverflow.com/questions/22138211/how-do-i-disconnect-all-other-users-in-tmux</span>
tmux a -dt &lt;session-name&gt;

<span class="c1"># 如何 ssh 后自动 attach 到某个 session</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$TMUX</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$SSH_CONNECTION</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Attempt to discover a detached session and attach it, else create a new session</span>
    <span class="nv">WHOAMI</span><span class="o">=</span><span class="s2">&quot;lens&quot;</span>   <span class="c1"># attach 的 session 名称</span>
    <span class="k">if</span> tmux has-session -t <span class="nv">$WHOAMI</span> <span class="m">2</span>&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
        tmux -2 attach-session -t <span class="nv">$WHOAMI</span>
    <span class="k">else</span>
        tmux -2 new-session -s <span class="nv">$WHOAMI</span>
    <span class="k">fi</span>
<span class="k">fi</span>
<span class="c1"># 或者</span>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="nv">$TMUX</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$SSH_CONNECTION</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">SESSION_NAME</span><span class="o">=</span><span class="s2">&quot;sessionname&quot;</span>
    tmux attach-session -t <span class="nv">$SESSION_NAME</span> <span class="o">||</span> tmux new-session -s <span class="nv">$SESSION_NAME</span>
<span class="k">fi</span>

<span class="c1"># 问题：Tmux resurrect file not found!</span>
<span class="k">function</span> tmux-resurrect-reset-last<span class="o">()</span> <span class="o">{</span>
    <span class="nb">cd</span> ~/.tmux/resurrect <span class="o">&amp;&amp;</span> <span class="se">\</span>
        ln -f -s <span class="k">$(</span>/bin/ls -t tmux_resurrect_*.txt <span class="p">|</span> head -n <span class="m">1</span><span class="k">)</span> last <span class="o">&amp;&amp;</span> <span class="se">\</span>
        /bin/ls -l last
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5>SSH<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># https://superuser.com/questions/98562/way-to-avoid-ssh-connection-timeout-freezing-of-gnome-terminal/98565#98565</span>
<span class="n">Press</span> <span class="n">Enter</span><span class="p">,</span> <span class="o">~</span><span class="p">,</span> <span class="o">.</span> <span class="n">one</span> <span class="n">after</span> <span class="n">the</span> <span class="n">other</span> <span class="n">to</span> <span class="n">disconnect</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">frozen</span> <span class="n">session</span><span class="o">.</span>
<span class="c1"># https://unix.stackexchange.com/questions/176547/copy-only-file-details-file-name-size-time-from-remote-machine-in-unix</span>
<span class="n">ssh</span> <span class="n">remotemachine</span>  <span class="s2">&quot;ls -l /opt/apache../webapps/Context&quot;</span>
<span class="c1"># 使用 paramiko  库可以实现 ssh client 功能</span>
<span class="c1"># https://www.digitalocean.com/community/tutorials/how-to-use-fabric-to-automate-administration-tasks-and-deployments</span>
</pre></div>
</div>
</div>
<div class="section" id="fabric">
<h5>Fabric<a class="headerlink" href="#fabric" title="永久链接至标题">¶</a></h5>
<p>可以用 Fabric 实现一些自动化控制服务器功能。示例 fabfile.py</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">local</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">需求：经常忘记开发机 build 完go 二进制文件以后 scp 到本地，导致有时候部署还是老的二进制文件。</span>

<span class="sd">功能：</span>
<span class="sd">实现监听开发机的二进制文件变动，每一次和本地文件对比，如果有开发机二进制文件大小变了，就拷贝到本地来。</span>

<span class="sd"># pip install fabric==1.14.0</span>
<span class="sd"># brew install watch</span>
<span class="sd">mac 下用 watch 用来定期执行命令 watch -n 60 ls</span>

<span class="sd">比如每分钟检查一下开发机上的 FaceFusionServer 是否重新 build 了，然后拉取到本地，可以执行</span>
<span class="sd">watch -n 30 fab monitor_facefusion_server monitor_uploadserver</span>

<span class="sd">1. http://www.bjhee.com/fabric.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Bcolors</span><span class="p">:</span>
    <span class="n">HEADER</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[95m&#39;</span>
    <span class="n">OKBLUE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span>
    <span class="n">OKGREEN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[92m&#39;</span>
    <span class="n">WARNING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[93m&#39;</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[91m&#39;</span>
    <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1m&#39;</span>
    <span class="n">UNDERLINE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[4m&#39;</span>


<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">]</span>
<span class="n">env</span><span class="o">.</span><span class="n">use_ssh_config</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">env</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">who</span><span class="p">():</span>
     <span class="n">run</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_change</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot; 根据 md5 判断是否变化，注意 centos 和 mac 命令和结果格式不同</span>
<span class="sd">     centos:</span>
<span class="sd">     md5sum UploadServer</span>
<span class="sd">     e4fccc07eafc7ef97d436c50546e352b  UploadServer</span>

<span class="sd">     mac:</span>
<span class="sd">     md5 UploadServer</span>
<span class="sd">     MD5 (UploadServer) = e4fccc07eafc7ef97d436c50546e352b</span>

<span class="sd">     :param remote_path: absolute remote server path</span>
<span class="sd">     :param local_path: local path</span>
<span class="sd">     &quot;&quot;&quot;</span>
     <span class="n">output</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s2">&quot;md5sum </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remote_path</span><span class="p">))</span>  <span class="c1"># 请保证路径存在，不会判断</span>
     <span class="n">remote_md5</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local_path</span><span class="p">):</span>  <span class="c1"># 第一次本地没有文件直接拉取</span>
         <span class="k">return</span> <span class="kc">True</span>
     <span class="n">local_output</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s2">&quot;md5 </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
     <span class="n">local_md5</span> <span class="o">=</span> <span class="n">local_output</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
     <span class="k">return</span> <span class="n">remote_md5</span> <span class="o">!=</span> <span class="n">local_md5</span>


<span class="k">def</span> <span class="nf">monitor_uploadserver</span><span class="p">():</span>
     <span class="n">remote_path</span> <span class="o">=</span> <span class="s2">&quot;/user/work/UploadServer&quot;</span>
     <span class="n">local_path</span> <span class="o">=</span> <span class="s2">&quot;./UploadServer&quot;</span>
     <span class="k">if</span> <span class="n">is_change</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">):</span>  <span class="c1"># 变化了就复制到本地 get(remote, local)，存在会覆盖</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">Bcolors</span><span class="o">.</span><span class="n">WARNING</span> <span class="o">+</span> <span class="s2">&quot;===========</span><span class="si">%s</span><span class="s2"> file changed=========&quot;</span> <span class="o">+</span> <span class="n">Bcolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
         <span class="n">get</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">local_path</span><span class="p">)</span>
         <span class="n">local</span><span class="p">(</span><span class="s2">&quot;chmod +x </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">Bcolors</span><span class="o">.</span><span class="n">HEADER</span> <span class="o">+</span> <span class="n">local_path</span> <span class="o">+</span> <span class="s2">&quot; not change&quot;</span> <span class="o">+</span> <span class="n">Bcolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="makefile">
<h5>Makefile<a class="headerlink" href="#makefile" title="永久链接至标题">¶</a></h5>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="c1"># 如何设置子进程环境变量 https://stackoverflow.com/questions/23843106/how-to-set-child-process-environment-variable-in-makefile</span>
test: <span class="nb">export</span> <span class="nv">NODE_ENV</span> <span class="o">=</span> <span class="nb">test</span>
</pre></div>
</div>
</div>
<div class="section" id="git">
<h5>Git<a class="headerlink" href="#git" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># .gitconfig配置用如下配置可以使用pycharm的diff和merge工具（已经安装pycharm）</span>
<span class="p">[</span><span class="n">diff</span><span class="p">]</span>
    <span class="n">tool</span> <span class="o">=</span> <span class="n">pycharm</span>
<span class="p">[</span><span class="n">difftool</span> <span class="s2">&quot;pycharm&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">charm</span> <span class="n">diff</span> <span class="s2">&quot;$LOCAL&quot;</span> <span class="s2">&quot;$REMOTE&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s2">&quot;Press enter to continue...&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">read</span>
<span class="p">[</span><span class="n">merge</span><span class="p">]</span>
    <span class="n">tool</span> <span class="o">=</span> <span class="n">pycharm</span>
    <span class="n">keepBackup</span> <span class="o">=</span> <span class="n">false</span>
<span class="p">[</span><span class="n">mergetool</span> <span class="s2">&quot;pycharm&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">charm</span> <span class="n">merge</span> <span class="s2">&quot;$LOCAL&quot;</span> <span class="s2">&quot;$REMOTE&quot;</span> <span class="s2">&quot;$BASE&quot;</span> <span class="s2">&quot;$MERGED&quot;</span>

<span class="c1"># https://stackoverflow.com/questions/34549040/git-not-displaying-unicode-file-names</span>
<span class="c1"># git 显示中文文件名，如果你的文件名有中文会好看很多</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">core</span><span class="o">.</span><span class="n">quotePath</span> <span class="n">false</span>

<span class="c1"># 用来review：</span>
<span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">since</span><span class="o">=</span><span class="mf">1.</span><span class="n">days</span> <span class="o">--</span><span class="n">committer</span><span class="o">=</span><span class="n">PegasusWang</span> <span class="o">--</span><span class="n">author</span><span class="o">=</span><span class="n">PegasusWang</span>
<span class="n">git</span> <span class="n">diff</span> <span class="n">commit1</span> <span class="n">commit2</span>

<span class="c1"># 冲突以后使用远端的版本： NOTE：注意在 git merge 和 git rebase 中 ours/theirs 含义相反</span>
<span class="c1"># rebase 场景下，theirs 实际表示的是当前分之</span>
<span class="c1"># merge 场景下相反，theirs 表示的确是远端分之</span>
<span class="c1"># https://stackoverflow.com/questions/16825849/choose-git-merge-strategy-for-specific-files-ours-mine-theirs</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">--</span><span class="n">theirs</span> <span class="n">templates</span><span class="o">/</span><span class="n">efmp</span><span class="o">/</span><span class="n">campaign</span><span class="o">.</span><span class="n">mako</span>

<span class="c1"># 防止http协议每次都要输入密码：</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">credential</span><span class="o">.</span><span class="n">helper</span> <span class="s1">&#39;cache --timeout=36000000&#39;</span>      <span class="c1">#秒数</span>

<span class="c1"># 暂存和恢复，当我们需要切分支又暂时不想 git add，可以先把目前的修改咱存起来</span>
<span class="n">git</span> <span class="n">stash</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">apply</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">apply</span> <span class="n">stash</span><span class="o">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">pop</span> <span class="c1"># 重新应用储藏并且从堆栈中移走</span>
<span class="c1"># 显示 git stash 内容 https://stackoverflow.com/questions/7677736/git-diff-against-a-stash</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">show</span> <span class="o">-</span><span class="n">p</span>  <span class="c1"># see the most recent stash</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">show</span> <span class="o">-</span><span class="n">p</span> <span class="n">stash</span><span class="o">@</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>

<span class="c1"># 删除远程分之</span>
<span class="n">git</span> <span class="n">push</span> <span class="n">origin</span> <span class="o">--</span><span class="n">delete</span> <span class="p">{</span><span class="n">the_remote_branch</span><span class="p">}</span>

<span class="c1"># 手残 add 完以后输入错了 commit 信息</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">--</span><span class="n">amend</span>
<span class="c1"># 类似的还可以修改上一个提交者的名字 https://stackoverflow.com/questions/750172/how-to-change-the-author-and-committer-name-and-e-mail-of-multiple-commits-in-gi</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="s2">&quot;you name&quot;</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="n">you</span><span class="nd">@domain</span><span class="o">.</span><span class="n">com</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">--</span><span class="n">amend</span> <span class="o">--</span><span class="n">reset</span><span class="o">-</span><span class="n">author</span>
<span class="c1"># 如果想要修改多个历史提交的 commit 信息，可以使用 git rebase -i 交互式修改。对应的提交行使用 reword 就可以</span>

<span class="c1"># 撤销 add （暂存），此时还没有 commit。比如 add 了不该 add 的文件</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span> <span class="n">file</span>
<span class="n">git</span> <span class="n">reset</span> <span class="c1"># 撤销所有的 add</span>

<span class="c1"># 撤销修改</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">--</span> <span class="n">file</span>

<span class="c1"># 手残pull错了分支就(pull是先fetch然后merge)。或者 revert 一个失误的 merge</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="n">HEAD</span><span class="o">~</span>
<span class="c1"># 如果 pull 产生了 冲突，可以撤销。</span>
<span class="n">git</span> <span class="n">merge</span> <span class="o">--</span><span class="n">abort</span>
<span class="c1"># git rebase 同样可以</span>
<span class="n">git</span> <span class="n">rebase</span> <span class="o">--</span><span class="n">abort</span>

<span class="c1"># How to revert Git repository to a previous commit?, https://stackoverflow.com/questions/4114095/how-to-revert-git-repository-to-a-previous-commit</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">hard</span> <span class="mi">0</span><span class="n">d1d7fc32</span>

<span class="c1"># 手残直接在master分之改了并且add了</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">soft</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="n">git</span> <span class="n">branch</span> <span class="n">new_branch</span> <span class="c1"># 切到一个新分支去 commit</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">new_branch</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;...&quot;</span>
<span class="c1"># 或者</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span><span class="n">soft</span> <span class="n">HEAD</span><span class="o">^</span>
<span class="n">git</span> <span class="n">stash</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="n">new_branch</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">pop</span>

<span class="c1"># 如果改了master但是没有add比较简单，三步走</span>
<span class="n">git</span> <span class="n">stash</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">new_branch</span>
<span class="n">git</span> <span class="n">stash</span> <span class="n">pop</span>

<span class="c1"># rename branch</span>
<span class="n">git</span> <span class="n">branch</span> <span class="o">-</span><span class="n">m</span> <span class="o">&lt;</span><span class="n">oldname</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">newname</span><span class="o">&gt;</span>
<span class="n">git</span> <span class="n">branch</span> <span class="o">-</span><span class="n">m</span> <span class="o">&lt;</span><span class="n">newname</span><span class="o">&gt;</span> <span class="c1"># rename the current branch</span>

<span class="c1"># 指定文件类型diff</span>
<span class="n">git</span> <span class="n">diff</span> <span class="n">master</span> <span class="o">--</span> <span class="s1">&#39;*.c&#39;</span> <span class="s1">&#39;*.h&#39;</span>
<span class="c1"># 带有上下文的diff</span>
<span class="n">git</span> <span class="n">diff</span> <span class="n">master</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">prefix</span> <span class="o">-</span><span class="n">U999</span>

<span class="c1"># undo add</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>
<span class="n">git</span> <span class="n">reset</span>    <span class="c1"># undo all</span>

<span class="c1"># 查看add后的diff</span>
<span class="n">git</span> <span class="n">diff</span> <span class="o">--</span><span class="n">staged</span>

<span class="c1"># http://weizhifeng.net/git-rebase.html</span>
<span class="c1"># rebase改变历史, 永远不要用在master分之，别人有可能使用你的分之时也不要用</span>
<span class="c1"># only change history for commits that have not yet been pushed</span>
<span class="c1"># master has changed since I stared my feature branch, and I want bo bring my branch up to date with master. - Dont&#39;t merge. rebase</span>
<span class="c1"># rebase: finds the merge base; cherry-picks all commits; reassigns the branch pointer.</span>
<span class="c1"># then git push -f</span>
<span class="c1"># git rebase --abort</span>

<span class="c1"># 全局 ignore, 对于不同编辑器协作的人比较有用，或者用来单独忽略一些自己建立的测试文件等。</span>
<span class="c1"># NOTE: git 支持每个子文件夹下有一个自己的 .gitignore，文件路径也是相对当前文件夹</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">core</span><span class="o">.</span><span class="n">excludesfile</span> <span class="o">~/.</span><span class="n">gitignore_global</span>  <span class="c1"># 全局忽略一些文件</span>

<span class="c1"># 拉取别人远程分支，在 .git/config 里配置好</span>
<span class="n">git</span> <span class="n">fetch</span> <span class="n">somebody</span> <span class="n">somebranch</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">somebranch</span> <span class="n">origin</span><span class="o">/</span><span class="n">somebranch</span>

<span class="c1"># prune all the dead branches from all the remotes</span>
<span class="c1"># https://stackoverflow.com/questions/17933401/how-do-i-remove-deleted-branch-names-from-autocomplete?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa</span>
<span class="n">git</span> <span class="n">fetch</span> <span class="o">--</span><span class="n">prune</span> <span class="o">--</span><span class="nb">all</span> <span class="c1"># 清理本地本删除的远程分之，补全的时候很干净，没有已经删除的分之</span>

<span class="c1"># https://stackoverflow.com/questions/1274057/how-to-make-git-forget-about-a-file-that-was-tracked-but-is-now-in-gitignore</span>
<span class="c1"># https://wildlyinaccurate.com/git-ignore-changes-in-already-tracked-files/</span>
<span class="c1"># 如果一个文件已经被 git 跟踪但是你之后又不想提交针对它的修改了，可以这么做（比如我想修改一些配置，本地 debug 等）</span>
<span class="n">git</span> <span class="n">update</span><span class="o">-</span><span class="n">index</span> <span class="o">--</span><span class="n">assume</span><span class="o">-</span><span class="n">unchanged</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>    <span class="c1"># 忽略一个已经 tracked 的文件，修改后不会被 commit</span>
<span class="n">git</span> <span class="n">update</span><span class="o">-</span><span class="n">index</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">assume</span><span class="o">-</span><span class="n">unchanged</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>   <span class="c1"># undo 上一步</span>
<span class="c1"># 那如何列出这些文件呢？ https://stackoverflow.com/questions/2363197/can-i-get-a-list-of-files-marked-assume-unchanged</span>
<span class="n">git</span> <span class="n">ls</span><span class="o">-</span><span class="n">files</span> <span class="o">-</span><span class="n">v</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;^[[:lower:]]&#39;</span>

<span class="c1"># https://stackoverflow.com/questions/48341920/git-branch-command-behaves-like-less</span>
<span class="c1"># 禁止 git brach 的时候使用交互式</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">pager</span><span class="o">.</span><span class="n">branch</span> <span class="n">false</span>

<span class="c1"># git rm file and add, https://stackoverflow.com/questions/9591407/unstage-a-deleted-file-in-git/9591612</span>
<span class="c1"># this restores the file status in the index</span>
<span class="n">git</span> <span class="n">reset</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>
<span class="c1"># then check out a copy from the index</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">--</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>

<span class="c1"># git 注意不要把二进制大文件，视频文件等放入到版本库，可能会导致 .git 非常大，删了也无济于事</span>
<span class="n">find</span> <span class="o">.</span> <span class="o">-</span><span class="n">executable</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">&gt;&gt;.</span><span class="n">gitignore</span> <span class="c1"># https://stackoverflow.com/questions/5711120/gitignore-without-binary-files</span>

<span class="c1"># git 历史删除大文件。如果你提交了大文件，即使你git rm删除了也会留在 git 的历史记录中，导致.git 文件夹很大</span>
<span class="c1"># https://stackoverflow.com/questions/8083282/how-do-i-remove-a-big-file-wrongly-committed-in-git</span>
<span class="n">git</span> <span class="nb">filter</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">index</span><span class="o">-</span><span class="nb">filter</span> <span class="s2">&quot;git rm -rf --cached --ignore-unmatch path_to_file&quot;</span> <span class="n">HEAD</span>

<span class="c1"># 如何恢复一个已经删除的分之, https://stackoverflow.com/questions/3640764/can-i-recover-a-branch-after-its-deletion-in-git</span>
<span class="n">git</span> <span class="n">reflog</span>  <span class="c1"># 查找对应 commit hash</span>
<span class="n">git</span> <span class="n">checkout</span> <span class="o">-</span><span class="n">b</span> <span class="n">branch</span><span class="o">-</span><span class="n">name</span> <span class="nb">hash</span>

<span class="c1"># git diff 代码显示 tab 为 4 个空格，比如看 go 代码的时候，git diff 显示 8 个</span>
<span class="c1"># https://stackoverflow.com/questions/10581093/setting-tabwidth-to-4-in-git-show-git-diff</span>
<span class="n">git</span> <span class="n">config</span> <span class="o">--</span><span class="k">global</span> <span class="n">core</span><span class="o">.</span><span class="n">pager</span> <span class="s1">&#39;less -x1,5&#39;</span>

<span class="c1"># git 如何使用不同的 committer，除了每个项目和全局可以设置 gitconfig 里的 user 外，可以使用如下方式</span>
<span class="c1"># https://stackoverflow.com/questions/4220416/can-i-specify-multiple-users-for-myself-in-gitconfig</span>
<span class="c1"># global config ~/.gitconfig</span>
<span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">John</span> <span class="n">Doe</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">john</span><span class="nd">@doe</span><span class="o">.</span><span class="n">tld</span>

<span class="p">[</span><span class="n">includeIf</span> <span class="s2">&quot;gitdir:~/work/&quot;</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="o">~/</span><span class="n">work</span><span class="o">/.</span><span class="n">gitconfig</span>

<span class="c1"># ~/work/.gitconfig</span>
<span class="p">[</span><span class="n">user</span><span class="p">]</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">john</span><span class="o">.</span><span class="n">doe</span><span class="nd">@company</span><span class="o">.</span><span class="n">tld</span>

<span class="c1"># 从提交历史搜索字符串，比如提交历史中引入了一个新的函数，可以通过这个方式搜索</span>
<span class="c1"># https://stackoverflow.com/questions/5816134/how-to-find-the-git-commit-that-introduced-a-string-in-any-branch</span>
<span class="n">git</span> <span class="n">log</span> <span class="o">-</span><span class="n">S</span> <span class="s1">&#39;hello world&#39;</span> <span class="o">--</span><span class="n">source</span> <span class="o">--</span><span class="nb">all</span>

<span class="c1"># 统计xx某某提交了多少代码</span>
<span class="n">git</span> <span class="n">log</span> <span class="o">--</span><span class="n">author</span><span class="o">=</span><span class="s2">&quot;xxx&quot;</span> <span class="o">--</span><span class="n">pretty</span><span class="o">=</span><span class="n">tformat</span><span class="p">:</span> <span class="o">--</span><span class="n">numstat</span> <span class="o">|</span> <span class="n">awk</span> <span class="s1">&#39;{ add += $1; subs += $2; loc += $1 - $2 } END { printf &quot;added lines: </span><span class="si">%s</span><span class="s1">, removed lines: </span><span class="si">%s</span><span class="s1">, total lines: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&quot;, add, subs, loc }&#39;</span>

<span class="c1"># 修改上一次提交人。比如一开始 git commiter 配置错了。https://stackoverflow.com/questions/3042437/how-to-change-the-commit-author-for-one-specific-commit</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">--</span><span class="n">amend</span> <span class="o">--</span><span class="n">author</span><span class="o">=</span><span class="s2">&quot;Author Name &lt;email@address.com&gt;&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">edit</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h5>Git工作流<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span>git checkout master    <span class="c1"># 切到master</span>
git pull origin master     <span class="c1"># 拉取更新</span>
git checkout -b newbranch    <span class="c1"># 新建分之，名称最好起个有意义的，比如jira号等</span>

<span class="c1"># 开发中。。。</span>
git fetch origin master    <span class="c1"># fetch master</span>
git rebase origin/master    <span class="c1">#</span>

<span class="c1"># 开发完成等待合并到master，推荐使用 rebase 保持线性的提交历史，但是记住不要在公众分之搞，如果有无意义的提交也可以用 rebase -i 压缩提交</span>
git rebase -i origin/master
git checkout master
git merge newbranch
git push origin master

<span class="c1"># 压缩提交</span>
git rebase -i HEAD~~    <span class="c1"># 最近两次提交</span>
</pre></div>
</div>
</div>
<div class="section" id="git-hook">
<h5>Git hook<a class="headerlink" href="#git-hook" title="永久链接至标题">¶</a></h5>
<p>比如我们要在每次 commit 之前运行下单测，进入项目的 .git/hooks 目录， &#8220;cp pre-commit.sample pre-commit&#8221; 修改内容如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> git rev-parse --verify HEAD &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="k">then</span>
    <span class="nv">against</span><span class="o">=</span>HEAD
<span class="k">else</span>
    <span class="c1"># Initial commit: diff against an empty tree object</span>
    <span class="nv">against</span><span class="o">=</span>4b825dc642cb6eb9a060e54bf8d69288fbee4904
<span class="k">fi</span>

<span class="c1"># Redirect output to stderr.</span>
<span class="nb">exec</span> <span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span>

<span class="k">if</span> /your/path/bin/test:    <span class="c1"># 这里添加需要运行的测试脚本</span>
<span class="k">then</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">else</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># If there are whitespace errors, print the offending file names and fail.</span>
<span class="nb">exec</span> git diff-index --check --cached <span class="nv">$against</span> --
</pre></div>
</div>
</div>
<div class="section" id="vim">
<h5>vim<a class="headerlink" href="#vim" title="永久链接至标题">¶</a></h5>
<div class="highlight-vim"><div class="highlight"><pre><span></span><span class="c"> &quot; http://stackoverflow.com/questions/9104706/how-can-i-convert-spaces-to-tabs-in-vim-or-linux</span>
<span class="p">:</span><span class="k">set</span> <span class="nb">tabstop</span><span class="p">=</span><span class="m">2</span>      <span class="c">&quot; To match the sample file</span>
<span class="p">:</span><span class="k">set</span> <span class="nb">noexpandtab</span>    <span class="c">&quot; Use tabs, not spaces</span>
<span class="p">:</span>%<span class="k">retab</span><span class="p">!</span>            <span class="c">&quot; Retabulate the whole file，替换tab为空格</span>
map <span class="p">&lt;</span>F4<span class="p">&gt;</span> :%<span class="k">retab</span><span class="p">!</span> <span class="p">&lt;</span>CR<span class="p">&gt;</span> :<span class="k">w</span> <span class="p">&lt;</span>CR<span class="p">&gt;</span> <span class="c">&quot; 映射一个命令</span>

<span class="c">&quot;https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwjF6JzH8aTRAhXiqVQKHUQBDcIQFggcMAA&amp;url=http%3A%2F%2Fstackoverflow.com%2Fquestions%2F71323%2Fhow-to-replace-a-character-by-a-newline-in-vim&amp;usg=AFQjCNGer9onNl_RExCUdE75ctTvVx8WGA&amp;sig2=WrcRh9RFNvN6bUZoHpJvDg</span>
<span class="c">&quot;vim替换成换行符使用\r不是\n</span>
<span class="c">&quot; 多行加上引号 http://stackoverflow.com/questions/9055998/vim-add-tag-to-multiple-lines-with-surround-vim&quot;</span>
<span class="p">:</span><span class="m">1</span><span class="p">,</span><span class="m">3</span>norm yss&quot;

# Git 插件
Plugin <span class="s1">&#39;tpope/vim-fugitive&#39;</span> # 在 <span class="k">vim</span> 里执行 :Gblame 可以看到当前文件每行代码的提交人和日期，找人背锅或者咨询的神器

# 直接在 <span class="k">vim</span> 里 <span class="nb">diff</span> 文件，比如打开了两个文件
<span class="p">:</span><span class="k">windo</span> <span class="k">diffthis</span>
<span class="p">:</span><span class="k">diffoff</span><span class="p">!</span>

# 解决中文输入法的问题
# https:<span class="sr">//</span>www.jianshu.<span class="k">com</span><span class="sr">/p/</span><span class="m">4</span>d<span class="m">81</span>b<span class="m">7</span>e<span class="m">32</span>bff
# https:<span class="sr">//</span>zhuanlan.zhihu.<span class="k">com</span><span class="sr">/p/</span><span class="m">23939198</span>

# 如果跳转到跳转之前的位置<span class="p">,</span> https:<span class="sr">//</span><span class="k">vi</span>.stackexchange.<span class="k">com</span><span class="sr">/questions/</span><span class="m">2001</span>/how<span class="p">-</span><span class="k">do</span><span class="p">-</span><span class="k">i</span><span class="p">-</span><span class="k">jump</span><span class="p">-</span><span class="k">to</span><span class="p">-</span>the<span class="p">-</span>location<span class="p">-</span>of<span class="p">-</span>my<span class="p">-</span>last<span class="p">-</span>edit
# 使用场景：比如在当前函数里使用了logging，发现logging import，我会跳转到文件头去 import logging，编辑完后进入normal模式使用  `` 就可以跳转到之前编辑位置
`` which will bring you back <span class="k">to</span> where the cursor was before you made your last <span class="k">jump</span>. See :help `` <span class="k">for</span> <span class="nb">more</span> information.

# 如何编辑远程服务器文件<span class="p">,</span> https:<span class="sr">//</span>superuser.<span class="k">com</span><span class="sr">/questions/</span><span class="m">403664</span>/how<span class="p">-</span>can<span class="p">-</span><span class="k">i</span><span class="p">-</span>copy<span class="p">-</span>and<span class="p">-</span><span class="nb">paste</span><span class="p">-</span>text<span class="p">-</span>out<span class="p">-</span>of<span class="p">-</span><span class="k">a</span><span class="p">-</span>remote<span class="p">-</span><span class="k">vim</span><span class="p">-</span><span class="k">to</span><span class="p">-</span><span class="k">a</span><span class="p">-</span>local<span class="p">-</span><span class="k">vim</span>
<span class="p">:</span><span class="k">e</span> scp:<span class="sr">//</span>user@host<span class="sr">/relative/</span><span class="nb">path</span><span class="sr">/from/</span>home.txt

# 跳转
<span class="k">g</span><span class="p">&lt;</span><span class="k">c</span><span class="p">-</span>]<span class="p">&gt;</span> # <span class="nb">list</span> <span class="k">all</span> <span class="k">match</span> <span class="nb">tag</span>

# 跳转到上一个 insert 的位置，经常用在修改之后跳转到之前的编辑位置 https:<span class="sr">//</span><span class="k">vi</span>.stackexchange.<span class="k">com</span><span class="sr">/questions/</span><span class="m">2001</span>/how<span class="p">-</span><span class="k">do</span><span class="p">-</span><span class="k">i</span><span class="p">-</span><span class="k">jump</span><span class="p">-</span><span class="k">to</span><span class="p">-</span>the<span class="p">-</span>location<span class="p">-</span>of<span class="p">-</span>my<span class="p">-</span>last<span class="p">-</span>edit
`^ 或者 &#39;^

# <span class="k">vim</span> 替换不间断空格，illegal character U<span class="p">+</span><span class="m">00</span>A<span class="m">0</span>异常解决。https:<span class="sr">//</span>www.jianshu.<span class="k">com</span><span class="sr">/p/</span><span class="m">5</span>f<span class="m">9992</span>e<span class="m">5</span>cd<span class="m">47</span>
<span class="p">:</span>%s<span class="sr">/\%u00a0/</span> /<span class="k">g</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://vim.rtorr.com/lang/zh_cn/">《vim cheet sheet》</a></li>
</ul>
</div>
<div class="section" id="vim-go-plugin-tips">
<h5>vim-go plugin Tips<a class="headerlink" href="#vim-go-plugin-tips" title="永久链接至标题">¶</a></h5>
<div class="highlight-vim"><div class="highlight"><pre><span></span># 最近一直在开发机服务器上直接用 neovim<span class="p">+</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span> 写 golang，具有完备开发功能<span class="p">(</span><span class="k">vim</span><span class="p">-</span>go借助各种go工具实现<span class="p">)</span>
# https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/fatih/</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span>
# https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/fatih/</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span><span class="p">-</span>tutorial  # <span class="k">vim</span><span class="p">-</span><span class="k">go</span> 官方教程，最好过一遍
<span class="k">let</span> <span class="k">g</span>:go_def_mode<span class="p">=</span><span class="s1">&#39;godef&#39;</span>  # 有时候 gopls 有问题可以用 godef 跳转，默认用 gopls

# 如何生成 interface 接口定义
type S struct{}   # cursor 放在 S 上执行 :GoImpl io.Reader

# 跳转到接口的实现 https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/fatih/</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span><span class="sr">/issues/</span><span class="m">820</span>
<span class="p">:</span>GoDef <span class="p">(</span>或ctrl<span class="p">+</span>]<span class="p">)</span> 跳转到定义，但是如果是接口实现只能跳转到 interface 定义而非 struct 实现。
<span class="p">:</span>GoCallees 从函数调用处跳转到接口的真正实现，而不是接口定义 <span class="p">(</span>在方法调用点使用 <span class="p">-&gt;</span> struct 方法实现列表<span class="p">)</span>
<span class="p">:</span>GoCallers 找到当前函数被调用的地点 <span class="p">(</span>caller 主调， callee 被调<span class="p">)</span>
<span class="p">:</span>GoImplements 获取一个接口方法的所有实现列表。<span class="p">(</span>interface method <span class="p">-&gt;</span> implement method <span class="nb">list</span><span class="p">)</span>

# 常用的方便命令<span class="p">(</span>命令模式Tab补全<span class="p">),</span> 参考 https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/fatih/</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span><span class="sr">/blob/</span>master<span class="sr">/doc/</span><span class="k">vim</span><span class="p">-</span><span class="k">go</span>.txt
<span class="p">:</span>GoFmt 格式化，你可以配置 <span class="k">vim</span><span class="p">-</span><span class="k">go</span> 直接保存自动执行格式化或者直接执行 GoImports
<span class="p">:</span>GoRun<span class="p">,</span> GoTest<span class="p">,</span> GoTestFunc 运行代码和单测
<span class="p">:</span>GoMetaLinter 执行 lint，可以配置 .gometalinter.json 忽略一些 lint 错误。https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/PegasusWang/</span>linux_config<span class="sr">/blob/</span>master<span class="sr">/golang/</span>gometalinter.json
<span class="p">:</span>GoRename 快速重构
<span class="p">:</span>GoImpl 为 struct 生成接口函数定义<span class="p">(</span>光标放到struct定义上使用<span class="p">)</span>。如果一个 interface 有很多需要实现的函数，比较方便
<span class="p">:</span>GoAddTags GoRemoveTags json 快速给 struct field 增加 json <span class="nb">tag</span>，支持 visual 模式多选。默认 <span class="nb">tag</span> 名是下划线命名
<span class="p">:</span>GoKeyify 把无名称初始化的 struct literals 转成包含字段名的初始化方式
<span class="p">:</span>GoIfErr 生成 <span class="k">if</span> err 返回值<span class="p">(</span>或者用 snippets<span class="p">)</span>
<span class="p">:</span>GoChannelPeers 寻找可能的 channel 发送和接收点
<span class="p">:</span>GoFillStruct 给一个 struct 填充默认值

# 甚至还可以让超过 <span class="m">120</span> 行的代码自动折行，需要安装 https:<span class="sr">//</span>github.<span class="k">com</span><span class="sr">/segmentio/</span>golines
# golines <span class="p">-</span><span class="k">w</span> <span class="p">-</span><span class="k">m</span> <span class="m">120</span> red_dot.<span class="k">go</span>  # 直接命令行格式化
<span class="k">let</span> <span class="k">g</span>:go_fmt_command <span class="p">=</span> <span class="s2">&quot;golines&quot;</span>
<span class="k">let</span> <span class="k">g</span>:go_fmt_options <span class="p">=</span> {
  \ <span class="s1">&#39;golines&#39;</span>: <span class="s1">&#39;-m 128&#39;</span><span class="p">,</span>
  \ }
</pre></div>
</div>
</div>
<div class="section" id="markdownhtml-ppt">
<h5>用markdown文件制作html ppt<a class="headerlink" href="#markdownhtml-ppt" title="永久链接至标题">¶</a></h5>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">brightbox</span><span class="o">/</span><span class="n">ruby</span><span class="o">-</span><span class="n">ng</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">ruby2</span><span class="o">.</span><span class="mi">2</span>
<span class="n">gem</span> <span class="n">install</span> <span class="n">slideshow</span>
<span class="n">slideshow</span> <span class="n">install</span> <span class="n">deck</span><span class="o">.</span><span class="n">js</span>
<span class="n">sudo</span>  <span class="n">pip</span> <span class="n">install</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">joh</span><span class="o">/</span><span class="n">when</span><span class="o">-</span><span class="n">changed</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
<span class="n">when</span><span class="o">-</span><span class="n">changed</span> <span class="n">rest</span><span class="o">.</span><span class="n">md</span> <span class="n">slideshow</span>  <span class="n">build</span> <span class="n">rest</span><span class="o">.</span><span class="n">md</span> <span class="o">-</span><span class="n">t</span> <span class="n">deck</span><span class="o">.</span><span class="n">js</span>

<span class="c1"># mac: brew install fswatch, http://stackoverflow.com/questions/1515730/is-there-a-command-like-watch-or-inotifywait-on-the-mac</span>
<span class="n">jfswatch</span> <span class="o">-</span><span class="n">o</span> <span class="o">~/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">watch</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">n1</span> <span class="o">~/</span><span class="n">script</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">when</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">change</span><span class="o">.</span><span class="n">sh</span>
<span class="n">fswatch</span> <span class="o">-</span><span class="n">o</span> <span class="o">./*.</span><span class="n">py</span>  <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">n1</span>  <span class="o">./</span><span class="n">runtest</span><span class="o">.</span><span class="n">sh</span>    <span class="c1"># 比如写单元测试的时候修改后就让测试执行</span>

<span class="c1"># 也可以使用下边的工具用 Jupyter 做 slideshow，最大的特点是直接在浏览器里敲代码交互演示</span>
<span class="c1"># Reveal.js - Jupyter/IPython Slideshow Extension, also known as live_reveal</span>
<span class="c1"># https://github.com/damianavila/RISE</span>

<span class="c1"># 更推荐使用 reveal-md</span>
<span class="n">reveal</span><span class="o">-</span><span class="n">md</span> <span class="n">slides</span><span class="o">.</span><span class="n">md</span> <span class="o">-</span><span class="n">w</span>
</pre></div>
</div>
</div>
<div class="section" id="ppt">
<h5>PPT 技巧<a class="headerlink" href="#ppt" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># 如何粘贴代码到 PPT 里边: 转成 rtf。直接粘贴没有代码高亮，转成 rtf 格式就可以了</span>
<span class="c1"># https://superuser.com/questions/85948/how-can-i-embed-programming-source-code-in-powerpoint-slide-and-keep-code-highli</span>
<span class="c1"># pip install Pygments</span>
pygmentize -f rtf code.py <span class="p">|</span> pbcopy
<span class="c1"># 粘贴到 ppt 之后需要选择 “保留源格式”，这样代码才有高亮</span>
</pre></div>
</div>
</div>
<div class="section" id="benchmark">
<h5>Benchmark<a class="headerlink" href="#benchmark" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span>sudo apt-get install apache2-utils
ab -c 并发数量 -n 总数量 url
</pre></div>
</div>
</div>
<div class="section" id="ffmpeg-youbute-dl">
<h5>Ffmpeg &amp;&amp; youbute-dl<a class="headerlink" href="#ffmpeg-youbute-dl" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># brew install youtube-dl</span>
<span class="c1"># https://askubuntu.com/questions/486297/how-to-select-video-quality-from-youtube-dl</span>
<span class="c1"># http://www.cnblogs.com/faunjoe88/p/7810427.html</span>
youtube-dl -F <span class="s2">&quot;http://www.youtube.com/watch?v=P9pzm5b6FFY&quot;</span>
youtube-dl -f <span class="m">22</span> <span class="s2">&quot;http://www.youtube.com/watch?v=P9pzm5b6FFY&quot;</span>
youtube-dl -f bestvideo+bestaudio <span class="s2">&quot;http://www.youtube.com/watch?v=P9pzm5b6FFY&quot;</span>

<span class="c1"># 截取视频</span>
ffmpeg -i input.mp4 -ss <span class="m">00</span>:01:00 -to <span class="m">00</span>:02:00 -c copy output.mp4
<span class="c1"># https://gist.github.com/PegasusWang/11b9203ffa699cd8f07e29559cc4d055</span>
<span class="c1"># 截图</span>
ffmpeg -ss <span class="m">00</span>:10:00 -i <span class="s2">&quot;Apache Sqoop Tutorial.mp4&quot;</span> -y -f image2 -vframes <span class="m">1</span> test.png

<span class="c1"># 提取音频mp3, https://stackoverflow.com/questions/9913032/ffmpeg-to-extract-audio-from-video</span>
ffmpeg -i sample.avi -q:a <span class="m">0</span> -map a sample.mp3

<span class="c1"># 连接视频</span>
$ cat input.txt
file <span class="s1">&#39;/path/to/file1&#39;</span>
file <span class="s1">&#39;/path/to/file2&#39;</span>
file <span class="s1">&#39;/path/to/file3&#39;</span>
<span class="c1"># 注意用 -safe 0</span>
ffmpeg -f concat -safe <span class="m">0</span> -i input.txt -c copy output.mp4

<span class="c1"># youtube-dl 下载音频: https://askubuntu.com/questions/178481/how-to-download-an-mp3-track-from-a-youtube-video</span>
youtube-dl --extract-audio --audio-format mp3 &lt;video URL&gt;
<span class="c1"># use socks5 proxy</span>
youtube-dl --proxy <span class="s1">&#39;socks5://127.0.0.1:1080&#39;</span> <span class="o">[</span>URL<span class="o">]</span>

<span class="c1"># use aria2 # https://blog.51cto.com/14046599/2348642</span>
<span class="c1"># brew install aria2</span>
youtube-dl https://www.youtube.com/watch?v<span class="o">=</span>zAJUeZ0SNp8 --external-downloader aria2c --external-downloader-args <span class="s2">&quot;-x 16 -k 1M&quot;</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># 脚本下载 youtube 视频</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="c1"># pip install youtube_dl，如果报错尝试升级</span>
<span class="c1"># pip install --upgrade youtube_dl</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">youtube_dl</span>


<span class="k">class</span> <span class="nc">MyLogger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">my_hook</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;finished&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done downloading, now converting ...&#39;</span><span class="p">)</span>


<span class="n">ydl_opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;bestaudio/best&#39;</span><span class="p">,</span>
    <span class="s1">&#39;postprocessors&#39;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;FFmpegExtractAudio&#39;</span><span class="p">,</span>
        <span class="s1">&#39;preferredcodec&#39;</span><span class="p">:</span> <span class="s1">&#39;mp3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;preferredquality&#39;</span><span class="p">:</span> <span class="s1">&#39;192&#39;</span><span class="p">,</span>
    <span class="p">}],</span>
    <span class="s1">&#39;logger&#39;</span><span class="p">:</span> <span class="n">MyLogger</span><span class="p">(),</span>
    <span class="s1">&#39;progress_hooks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">my_hook</span><span class="p">],</span>
<span class="p">}</span>
<span class="k">with</span> <span class="n">youtube_dl</span><span class="o">.</span><span class="n">YoutubeDL</span><span class="p">(</span><span class="n">ydl_opts</span><span class="p">)</span> <span class="k">as</span> <span class="n">ydl</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.youtube.com/watch?v=48VSP-atSeI&#39;</span>
    <span class="n">ydl</span><span class="o">.</span><span class="n">download</span><span class="p">([</span><span class="n">url</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="vlog">
<h5>Vlog 如何增加字幕<a class="headerlink" href="#vlog" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://github.com/BingLingGroup/autosub/blob/dev/docs/README.zh-Hans.md#%E8%AF%AD%E9%9F%B3%E8%BD%AC%E6%96%87%E5%AD%97%E7%BF%BB%E8%AF%91api%E8%AF%B7%E6%B1%82">https://github.com/BingLingGroup/autosub/blob/dev/docs/README.zh-Hans.md#%E8%AF%AD%E9%9F%B3%E8%BD%AC%E6%96%87%E5%AD%97%E7%BF%BB%E8%AF%91api%E8%AF%B7%E6%B1%82</a></li>
<li><a class="reference external" href="https://www.zhihu.com/question/24717723/answer/290003526">https://www.zhihu.com/question/24717723/answer/290003526</a></li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># 首先安装 autosub。先安装 brew install ffmpeg</span>
pip3 install git+https://github.com/BingLingGroup/autosub.git@alpha ffmpeg-normalize
<span class="c1"># 使用方式。最后生成 srt 文件，名字为 视频.zh-cn.rst</span>
autosub -S zh-cn -D zh-cn -i 视频.mp4
<span class="c1"># 之后可以使用软件比如 ArcTime 或者之类的软件可以导入并生成新的视频。</span>
<span class="c1"># 使用 ffmpeg 也可以增加字幕并输出到新的 mp4</span>
ffmpeg -i 视频.mp4 -vf <span class="nv">subtitles</span><span class="o">=</span>视频.zh-cn.srt output.mp4
</pre></div>
</div>
</div>
<div class="section" id="curl">
<h5>Curl<a class="headerlink" href="#curl" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># 记录 curl 过程, https://askubuntu.com/questions/944788/how-does-curl-print-to-terminal-while-piping</span>
curl -v http://httpbin.org/headers &gt; t.txt <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/">《Linux工具快速教程》</a></li>
<li><a class="reference external" href="http://slideshow-s9.github.io/">《slide show》</a></li>
<li><a class="reference external" href="http://commonmark.org/help/">《markdown sheet》</a></li>
<li><a class="reference external" href="http://conqueringthecommandline.com/book/">《CONQUERING THE COMMAND LINE》</a></li>
</ul>
</div>
<div class="section" id="pandoc">
<h5>Pandoc 转换文档格式<a class="headerlink" href="#pandoc" title="永久链接至标题">¶</a></h5>
<div class="highlight-shell"><div class="highlight"><pre><span></span>pandoc -s -o about.md about.rst
</pre></div>
</div>
</div>
<div class="section" id="wireshark-mac-tcp">
<h5>Wireshark(mac tcp 抓包)<a class="headerlink" href="#wireshark-mac-tcp" title="永久链接至标题">¶</a></h5>
<p>Capture -&gt; Options -&gt; lo0 抓本地 127.0.0.1 包。筛选 tcp.port == 6379 抓 redis tcp 包
抓包后点击一条选择右键 Follow -&gt; TCP Stream 就可以查看 tcp 包发送的文本内容。</p>
<p>抓包iOS: 输入 rvictl -s 设备[udid]。格式是rvictl -s [设备udid]，设备的udid可以通过itunes或者itools获取
<code class="xref py py-obj docutils literal"><span class="pre">system_profiler</span> <span class="pre">SPUSBDataType</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&quot;Serial</span> <span class="pre">Number:.*&quot;</span> <span class="pre">|</span> <span class="pre">sed</span> <span class="pre">s#&quot;.*Serial</span> <span class="pre">Number:</span> <span class="pre">&quot;##</span></code></p>
<ul class="simple">
<li><a class="reference external" href="https://serverfault.com/questions/22990/is-there-a-way-to-get-wireshark-to-capture-packets-sent-from-to-localhost-on-win">https://serverfault.com/questions/22990/is-there-a-way-to-get-wireshark-to-capture-packets-sent-from-to-localhost-on-win</a></li>
<li><a class="reference external" href="https://www.jianshu.com/p/62f00db7be68">https://www.jianshu.com/p/62f00db7be68</a></li>
<li><a class="reference external" href="http://mrpeak.cn/blog/wireshark/">http://mrpeak.cn/blog/wireshark/</a>  Wireshark抓包iOS入门教程</li>
</ul>
</div>
<div class="section" id="hhkb-karabiner-mac">
<h5>HHKB 静电容键盘。Karabiner 修改 mac 键位配置<a class="headerlink" href="#hhkb-karabiner-mac" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li>HHKB 开关我只打开了 2 （mac 模式），貌似网上有说打开开关 6 会出现无法唤醒的问题。</li>
<li>Mac 模式 HHKB 可以用使用 Fn+Esc 休眠。</li>
<li>如何禁用内置键盘： Karabiner-Elements 同时可以禁用内置键盘，配置在 Devices -&gt; Advanced， 勾选 Disable the built-in keyboard.</li>
<li>网易云音乐切歌：使用 Fn + 7/8/9 分别是上一首，暂停和下一首</li>
</ul>
<p>如何使用 mac 使用 Karabiner-Elements  改键配置</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/tekezo/Karabiner-Elements">https://github.com/tekezo/Karabiner-Elements</a></li>
<li><a class="reference external" href="https://www.jianshu.com/p/47d5de7f12bc">https://www.jianshu.com/p/47d5de7f12bc</a></li>
<li><a class="reference external" href="https://madogiwa.github.io/KE-complex_modifications/">https://madogiwa.github.io/KE-complex_modifications/</a></li>
</ul>
<p>配置文件放置位置在 <a class="reference external" href="https://github.com/PegasusWang/linux_config/blob/master/mac_karabiner/wasd.json">https://github.com/PegasusWang/linux_config/blob/master/mac_karabiner/wasd.json</a></p>
<p>~/.config/karabiner/assets/complex_modifications/wasd.json</p>
<p>这里我把 right_command + WASD 修改成上下左右，方便 HHKB 方向键移动，默认的 HHKB 方向键不方便。</p>
</div>
</div>
<span id="document-docker"></span><div class="section" id="docker">
<h4>Docker 快速入门<a class="headerlink" href="#docker" title="永久链接至标题">¶</a></h4>
<div class="section" id="id1">
<h5>基本概念<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h5>
<p>Docker 是基于 Linux kernel 的虚拟化工具，仅需要极低的系统资源使用就提供了
强大的虚拟化、资源隔离能力。使用 Docker，用户只需要几分钟即可以将应用程序
“Docker 化”，并且由于其易于复制分享的优点，能够保证开发与部署环境的一致性。</p>
<p>Docker 的基本结构包括：</p>
<ol class="arabic simple">
<li>Docker 客户端和服务器（C/S）</li>
<li>Image</li>
<li>Registry</li>
<li>Container</li>
</ol>
<p>在本地安装 Docker 之后，即完成了 Docker C/S 的安装。用户使用 Docker 客户端向
Docker 的守护进程发送命令操作 Container。</p>
<p>Image（镜像）类似于应用的源代码，你可以通过修改源代码（Image）来构建出不同的 Container。
Registry（）类似于源码的托管服务器，默认的 Registry 是 Docker 公司提供的 Docker Hub，
你可以将 Docker Hub 类比于 GitHub。</p>
<p>Container 是 Docker 最重要的概念，它通过操作相应的镜像提供一个执行环境。</p>
<p>使用 Docker，可以快速构建很分享应用程序部署服务器、开发环境、CI 环境或者一个应用服务。</p>
<p>首先声明，这里的系统环境设置为 Ubuntu 14.04，Mac OS 和 Windows
系统请在虚拟机里安装 Ubuntu， 其它 Linux 发行版 和 Ubuntu
不会有太大区别，请自行修改命令。</p>
<p>使用 Ubuntu（我自己安装的是 Xubuntu） 的好处：</p>
<ul class="simple">
<li>相比 Boot2docker 来说更加强大，比如我可以通过安装 zsh +
zsh-docker-completetion 提供 docker 自动补全功能。</li>
<li>获得最新最强大的官方支持，Docker 官方推荐使用 Ubuntu，对 Ubuntu
下的问题也能够最及时解决， 甚至某些工具不提供 Mac OS 或者 Windows
兼容方案。</li>
<li>相对于其它 Linux 发行版用户更多，使用更简单。</li>
<li>推荐在虚拟机中安装 Xubuntu，和 Ubuntu 相比，Xubuntu
更轻量，在虚拟机中性能更好； 在虚拟机中安装 Xubuntu
便于对开发环境的迁移以及内部共享。</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Docker 命令<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<p>Docker 可以通过命令来构建镜像，也可以根据 Dockerfile 配置来构建。 docker
命令与 Dockerfile 的对应关系如下：</p>
</div>
<div class="section" id="dockerfile">
<h5>Dockerfile<a class="headerlink" href="#dockerfile" title="永久链接至标题">¶</a></h5>
<div class="section" id="id3">
<h6>命令<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h6>
<div class="section" id="workdir">
<h7>WORKDIR<a class="headerlink" href="#workdir" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="env">
<h7>ENV<a class="headerlink" href="#env" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="user">
<h7>USER<a class="headerlink" href="#user" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="volume">
<h7>VOLUME<a class="headerlink" href="#volume" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="add">
<h7>ADD<a class="headerlink" href="#add" title="永久链接至标题">¶</a></h7>
<p>向镜像中添加特定文件，可以是主机中或者 web 文件。以 WordPress 的
Dockerfile 为例：</p>
<div class="code dockerfile highlight-none"><div class="highlight"><pre><span></span>ADD http://wordpress.org/latest.zip /var/www/wordpress.zip
</pre></div>
</div>
</div>
<div class="section" id="onbuild">
<h7>ONBUILD<a class="headerlink" href="#onbuild" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="run">
<h7>RUN<a class="headerlink" href="#run" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="cmd">
<h7>CMD<a class="headerlink" href="#cmd" title="永久链接至标题">¶</a></h7>
</div>
<div class="section" id="entrypoint">
<h7>ENTRYPOINT<a class="headerlink" href="#entrypoint" title="永久链接至标题">¶</a></h7>
</div>
</div>
<div class="section" id="centos">
<h6>CentOS<a class="headerlink" href="#centos" title="永久链接至标题">¶</a></h6>
<div class="section" id="mongodb">
<h7>MongoDB<a class="headerlink" href="#mongodb" title="永久链接至标题">¶</a></h7>
<p>参考：<a class="reference external" href="https://github.com/CentOS/CentOS-Dockerfiles/blob/master/mongodb/centos7/Dockerfile">CentOS/CentOS-Dockerfiles</a></p>
<div class="code dockerfile highlight-none"><div class="highlight"><pre><span></span>FROM centos:latest
MAINTAINER Kane Blueriver &lt;kxxoling@gmail.com&gt;

RUN yum -y update; yum clean all
RUN yum -y install epel-release; yum clean all
RUN yum -y install mongodb-server; yum clean all

RUN mkdir -p /data/

# 设置挂载点
VOLUME [&quot;/data/mongo&quot;]

# Define working directory.
WORKDIR /data

CMD [&quot;mongod&quot;]

EXPOSE 27017
ENTRYPOINT [&quot;/usr/bin/mongod&quot;]
</pre></div>
</div>
</div>
<div class="section" id="redis">
<h7>Redis<a class="headerlink" href="#redis" title="永久链接至标题">¶</a></h7>
<p>参考：<a class="reference external" href="https://github.com/CentOS/CentOS-Dockerfiles/blob/master/redis/centos7/Dockerfile">CentOS/CentOS-Dockerfiles</a></p>
<div class="code dockerfile highlight-none"><div class="highlight"><pre><span></span>FROM centos:latest
MAINTAINER Kane Blueriver &lt;kxxoling@gmail.com&gt;

RUN yum -y update; yum clean all
RUN yum -y install epel-release; yum clean all
RUN yum -y install redis; yum clean all

# 设置挂载点
VOLUME [&quot;/data/redis&quot;]

# Define working directory.
WORKDIR /data

EXPOSE 6379

CMD [&quot;redis-server&quot;]
</pre></div>
</div>
</div>
<div class="section" id="memcached">
<h7>Memcached<a class="headerlink" href="#memcached" title="永久链接至标题">¶</a></h7>
<p>参考：<a class="reference external" href="https://github.com/CentOS/CentOS-Dockerfiles/blob/master/memcached/centos7/Dockerfile">CentOS/CentOS-Dockerfiles</a></p>
<div class="code dockerfile highlight-none"><div class="highlight"><pre><span></span>FROM centos:latest
MAINTAINER Kane Blueriver &lt;kxxoling@gmail.com&gt;
RUN  yum -y update; yum clean all
RUN yum -y install epel-release; yum clean all
RUN yum -y install memcached; yum clean all

VOLUME [&quot;/data/mc&quot;]

WORKDIR /data

CMD [&quot;memcached&quot;]

EXPOSE  11211

CMD  [&quot;memcached&quot;, &quot;-u&quot;, &quot;daemon&quot;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="ubuntu">
<h6>Ubuntu<a class="headerlink" href="#ubuntu" title="永久链接至标题">¶</a></h6>
<p>参考<a class="reference external" href="https://registry.hub.docker.com/u/dockerfile/mongodb/dockerfile/">dockerfile/mongodb</a></p>
<div class="code dockerfile highlight-none"><div class="highlight"><pre><span></span>FROM dockerfile/ubuntu

# 从官网安装 MongoDB
RUN \
  apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10 &amp;&amp; \
  echo &#39;deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen&#39; &gt; /etc/apt/sources.list.d/mongodb.list &amp;&amp; \
  apt-get update &amp;&amp; \
  apt-get install -y mongodb-org &amp;&amp; \
  rm -rf /var/lib/apt/lists/*

# 设置挂载点
VOLUME [&quot;/data/db&quot;]

# Define working directory.
WORKDIR /data

CMD [&quot;mongod&quot;]

# 27017: process
# 28017: http
EXPOSE 27017
EXPOSE 28017
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h5>分享<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<p>构建好自己的镜像后可以将其 push 到 Registry 上进行分享，默认的 Registry
由 Docker Hub 提供， 如果镜像中存在隐私内容也可以使用 Docker
公司的源代码搭建内部的共享服务器。</p>
<div class="section" id="id5">
<h6>登录<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="push">
<h6>Push<a class="headerlink" href="#push" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id6">
<h6>自动构建<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="docker-registry">
<h6>搭建自己的 Docker Registry<a class="headerlink" href="#docker-registry" title="永久链接至标题">¶</a></h6>
</div>
</div>
<div class="section" id="docker-web">
<h5>使用 Docker 进行 web 开发<a class="headerlink" href="#docker-web" title="永久链接至标题">¶</a></h5>
<div class="section" id="id7">
<h6>多个容器互联<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h6>
</div>
<div class="section" id="id8">
<h6>持续集成<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h6>
<p>Drone Shippable</p>
</div>
</div>
<div class="section" id="id9">
<h5>快速编配<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h5>
<p>Docker 公司还提供了快速编配工具 compose（原 Fig）用于加速 Docker
环境的构建。</p>
<p>安装：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>pip install docker-compose
</pre></div>
</div>
<p>下面以一个标准的 Python WSGI 应用为例，介绍 compose 的使用方法。</p>
<div class="section" id="wsgi">
<h6>WSGI 应用<a class="headerlink" href="#wsgi" title="永久链接至标题">¶</a></h6>
<p>首先你需要一个 WSGI 应用，这里以一个简单的 Flask 应用为例：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;hits&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;Hello World! I have been seen </span><span class="si">%s</span><span class="s1"> times.&#39;</span> <span class="o">%</span> <span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hits&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>标准的 Python 应用还需要提供一个 requirements.txt 记录其依赖——flask 和 redis：</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>flask
redis
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h6>Dockerfile<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h6>
<p>定制一个 Flask 应用的运行环境：</p>
<div class="highlight-dockerfile"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">python:2.7</span>
<span class="k">ADD</span> . /code
<span class="k">WORKDIR</span><span class="s"> /code</span>
<span class="k">RUN</span> pip install -r requirements.txt
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h6>定义服务<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h6>
<p>定义 <code class="docutils literal"><span class="pre">docker-compose.yml</span></code> 配置文件，装配应用运行环境所需组件（Container、Volume 等）：</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nt">web</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python app.py</span>
  <span class="nt">ports</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="s">&quot;5000:5000&quot;</span>
  <span class="nt">volumes</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">.:/code</span>
  <span class="nt">links</span><span class="p">:</span>
   <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="nt">redis</span><span class="p">:</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">redis</span>
</pre></div>
</div>
<p>上面的配置文件定义了 2 个服务：</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>web：根据本地 Dockerfile 构建出的 Image，提供一个 WSGI 应用的运行环境，将 Docker 中的 5000 端口</dt>
<dd>映射到主机的 5000 端口，并将本目录挂载到 Container 的 /code 目录。并且链接到 redis 服务。</dd>
</dl>
</li>
<li>redis：基于 Docker Hub 的 redis 公开镜像构建的 Container。</li>
</ul>
</div>
<div class="section" id="id12">
<h6>构建以及运行<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h6>
<p>构建：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>docker-compose up
</pre></div>
</div>
<p>运行：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>docker-compose run web env
</pre></div>
</div>
<p>停止：</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>docker-compose stop
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-meta"></span><div class="section" id="rest">
<h4>如何编译 reST 文档<a class="headerlink" href="#rest" title="永久链接至标题">¶</a></h4>
<p>reST 文档的编译依赖 make 和 sphinx，安装完依赖后在文档的根目录执行
<code class="xref py py-obj docutils literal"><span class="pre">make</span> <span class="pre">html</span></code> 构建 HTML 文档，如无错误即可在 <code class="xref py py-obj docutils literal"><span class="pre">_build/html</span></code> 目录中生成对应的 HTML 文件，
可以在浏览器中直接打开 <code class="xref py py-obj docutils literal"><span class="pre">_build/html/index.html</span></code> 预览生成的
HTML。或者用python起一个本地的server查看。</p>
<p>本文档托管在 ReadTheDocs，文档合并之主分支后将会自动构建，预览请访问 <a class="reference external" href="http://python-web-guide.readthedocs.io/zh/latest/">RTFD</a> 。</p>
</div>
<span id="document-mush"></span><div class="section" id="id1">
<h4>蘑菇碎碎念<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<div class="section" id="hg">
<h5>HG<a class="headerlink" href="#hg" title="永久链接至标题">¶</a></h5>
<ol class="arabic">
<li><p class="first">fetch 某个分支</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">hg</span> <span class="pre">fetch</span> <span class="pre">http://xxx.xxx.xxx.xxx:8000</span> <span class="pre">-r</span></code></p>
</li>
<li><p class="first">在docker中互相fetch</p>
<p>docker额外映射了一个端口到8000,可以通过这个端口</p>
</li>
<li><p class="first">关闭无名分支</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>hg update -r &lt;版本号&gt;
hg commit --close-branch -m &#39;Closing old branch&#39;
hg update -C default
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="id2">
<h5>翻墙有道<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<div class="section" id="gentooemerge">
<h6>gentoo下emerge访问墙外资源<a class="headerlink" href="#gentooemerge" title="永久链接至标题">¶</a></h6>
<ol class="arabic">
<li><p class="first">emerge设置HTTP代理</p>
<p>在 <code class="xref py py-obj docutils literal"><span class="pre">/etc/make.conf</span></code> 写入代理配置</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>http_proxy=&quot;http://127.0.0.1:8080&quot;
https_proxy=&quot;http://127.0.0.1:8080&quot;
</pre></div>
</div>
</li>
<li><p class="first">安装配置HTTP代理工具polipo</p>
<blockquote>
<div><p><code class="xref py py-obj docutils literal"><span class="pre">sudo</span> <span class="pre">emerge</span> <span class="pre">polipo</span></code> 即可完成安装,安装后在 <code class="xref py py-obj docutils literal"><span class="pre">/etc/polipo/conf</span></code> 中写入</p>
</div></blockquote>
<div class="highlight-none"><div class="highlight"><pre><span></span>daemonise=false
diskCacheRoot=/var/cache/polipo/
proxyAddress=127.0.0.1
proxyName=localhost
cacheIsShared=true
allowedClients=127.0.0.1
proxyPort=8080
socksParentProxy = 127.0.0.1:1080
socksProxyType = socks5
</pre></div>
</div>
</li>
<li><p class="first">配置shadowsocks</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>{
    &quot;server&quot;:&quot;vpn.mushapi.com&quot;,
    &quot;server_port&quot;:1081,
    &quot;local_address&quot;: &quot;127.0.0.1&quot;,
    &quot;local_port&quot;:1080,
    &quot;password&quot;:&quot;btyh17mxy&quot;,
    &quot;timeout&quot;:300,
    &quot;method&quot;:&quot;aes-256-cfb&quot;,
    &quot;fast_open&quot;: false,
    &quot;workers&quot;: 1
}
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="vim">
<h5>vim黑科技<a class="headerlink" href="#vim" title="永久链接至标题">¶</a></h5>
<ol class="arabic">
<li><p class="first">遇到gbk乱码囧木办</p>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre><span></span>set encoding=utf-8
set fenc=cp936
set fileencodings=cp936,ucs-bom,utf-8
if v:lang =~? &#39;^\(zh\)\|\(ja\)\|\(ko\)&#39;
    set ambiwidth=double
endif
set nobomb
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">粘贴后格式错乱怎么办</p>
<p>有的时候，在插入模式下从系统粘贴板粘贴文本到vim中会出现缩进异常的情况，为了解决这种问题，在粘贴前应该设置vim为粘贴模式并在粘贴完成后取消粘贴模式</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:set</span> <span class="pre">paste</span></code></p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:set</span> <span class="pre">nopaste</span></code></p>
</li>
<li><p class="first">你滚开</p>
<p>如果你在一个文件中滚动屏幕，那么另一个文件也会自动滚动以显示相同的位置。你可以使用以下命令，取消联动：</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:set</span> <span class="pre">noscrollbind</span></code></p>
<p>使用以下命令，将重新绑定联动：</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:set</span> <span class="pre">scrollbind</span></code></p>
<p>利用以下命令，可以定义滚动方式：</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:set</span> <span class="pre">scrollopt</span> <span class="pre">ver,hor,jump</span></code></p>
<p>其中：选项ver ，启用垂直同步滚动；选项hor ，启用水平同步滚动；而jump 选项，则在切换窗口时，使垂直滚动始终同步。</p>
<p>如果光标停留在两个文件的不同位置，那么可以使用下面的命令同步滚动：</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">:syncbind</span></code></p>
</li>
</ol>
</div>
<div class="section" id="id3">
<h5>vim插件及使用<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<ol class="arabic">
<li><p class="first">syntastic 在错误之间跳转</p>
<blockquote>
<div><p>:lnext 跳到下一个</p>
<p>:lprev 跳到上一个</p>
</div></blockquote>
</li>
<li><p class="first">使用pyflakes进行语法检查</p>
<blockquote>
<div><p>:SyntasticCheck pyflakes</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="iptables">
<h5>iptables<a class="headerlink" href="#iptables" title="永久链接至标题">¶</a></h5>
<ol class="arabic">
<li><p class="first">列出所有规则</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">iptables</span> <span class="pre">-nvL</span>&nbsp; <span class="pre">-t</span> <span class="pre">nat</span> <span class="pre">--line-number</span></code></p>
<p>列出nat表的所有规则并显示行号</p>
</li>
<li><p class="first">清零流量统计</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">iptables</span> <span class="pre">-Z</span></code></p>
</li>
<li><p class="first">删除</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">iptables</span> <span class="pre">-t</span> <span class="pre">nat</span> <span class="pre">-D</span> <span class="pre">DOCKER</span> <span class="pre">13</span></code></p>
<p>删除nat表DOCKER链的第13行的规则</p>
</li>
<li><p class="first">用iptables给Docker添加端口映射</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">iptables</span> <span class="pre">-t</span> <span class="pre">nat</span> <span class="pre">-A</span> <span class="pre">DOCKER</span> <span class="pre">--in-interface</span> <span class="pre">!docker0</span> <span class="pre">-p</span> <span class="pre">tcp</span> <span class="pre">--dport</span> <span class="pre">6666</span> <span class="pre">-j</span> <span class="pre">DNAT</span> <span class="pre">--to</span> <span class="pre">172.17.0.5:6666</span></code></p>
<p>docker会在系统中创建一个叫docker0的网卡，本例中172.17.0.5就是docker0的IP地址</p>
</li>
</ol>
</div>
<div class="section" id="linux">
<h5>linux命令<a class="headerlink" href="#linux" title="永久链接至标题">¶</a></h5>
<div class="section" id="ssh">
<h6>ssh客户端配置文件<a class="headerlink" href="#ssh" title="永久链接至标题">¶</a></h6>
<p>当主机较多的时候，不方便记住所有的IP、用户、端口以及密码，为了解决这个问题我们可以使用一个ssh的配置文件来记录这些服务器。</p>
<p>常用的配置有</p>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre><span></span>Host 主机别名
HostName 主机地址
User 登陆用户名
Port 端口号
IdentityFile 公钥
</pre></div>
</div>
</div></blockquote>
<p>在~/.ssh/目录下创建一个config文件，在config中写入相应的配置后就可以使用 <code class="xref py py-obj docutils literal"><span class="pre">ssh</span> <span class="pre">&lt;主机别名&gt;</span></code> 直接连接服务器了</p>
</div>
<div class="section" id="id4">
<h6>保障服务器安全<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h6>
<ol class="arabic">
<li><p class="first">禁用密码登陆, 使用密钥登陆</p>
<blockquote>
<div><p>编辑/etc/ssh/sshd_config</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>PasswordAuthentication no
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">禁用root登陆</p>
<blockquote>
<div><p>编辑/etc/ssh/sshd_config</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>PermitRootLogin no
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="axel">
<h6>多线程下载工具axel<a class="headerlink" href="#axel" title="永久链接至标题">¶</a></h6>
<p>curl和wget是单线程的，使用这货的多线程方式下载文件会显著提高下载速度</p>
<ol class="arabic">
<li><p class="first">安装</p>
<p>gentoo下 <code class="xref py py-obj docutils literal"><span class="pre">sudo</span> <span class="pre">emerge</span> <span class="pre">axel</span></code></p>
<p>centos下 <code class="xref py py-obj docutils literal"><span class="pre">sudo</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">axel</span></code></p>
</li>
<li><p class="first">使用</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>axel -n &lt;线程数&gt; -o &lt;保存文件的目录&gt; &lt;下载地址&gt;
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="docker">
<h6>docker 的一个奇怪命令<a class="headerlink" href="#docker" title="永久链接至标题">¶</a></h6>
<p>docker run -e MYSQL_ROOT_PASSWORD=rstfsgbcedh &#8211;expose 3306  &#8211;entrypoint=&#8221;/entrypoint.sh&#8221; &#8211;name mysql-hg -d mush/mysql-hg mysqld</p>
<p>如果遇到 TERM environment variable not set. 就执行 <code class="xref py py-obj docutils literal"><span class="pre">export</span> <span class="pre">TERM=dumb</span></code></p>
</div>
<div class="section" id="redis-in-docker">
<h6>redis in docker<a class="headerlink" href="#redis-in-docker" title="永久链接至标题">¶</a></h6>
<p>当我们在使用docker提供redis服务时, 如果我们需要执行一个redis命令就需要使用 <code class="xref py py-obj docutils literal"><span class="pre">docker</span> <span class="pre">exec</span> <span class="pre">&lt;option&gt;</span> <span class="pre">redis</span> <span class="pre">&lt;command&gt;</span> <span class="pre">redis-cli</span></code> 的形式.</p>
<p>但是这一个问题, 如果使用-d的option, 它就会后台执行, 我们不知道其何时执行玩, 使用-i又会导致挂起, 下面是一个执行并退出的方法.</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nb">echo</span> -e <span class="s1">&#39;bgsave&#39;</span> <span class="p">|</span> docker <span class="nb">exec</span> -i redis redis-cli
</pre></div>
</div>
</div>
<div class="section" id="rediskey">
<h6>redis批量删除key<a class="headerlink" href="#rediskey" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>EVAL &quot;local keys = redis.call(&#39;keys&#39;, ARGV[1]) \n for i=1,#keys,5000 do \n redis.call(&#39;del&#39;, unpack(keys, i, math.min(i+4999, #keys))) \n end \n return keys&quot; 0 investment_0*

EVAL &quot;local keys = redis.call(&#39;keys&#39;, ARGV[1]) \n for i=1,#keys,5000 do \n redis.call(&#39;del&#39;, unpack(keys, i, math.min(i+4999, #keys))) \n end \n return keys&quot; 0 s_idx_cache_*

EVAL &quot;local keys = redis.call(&#39;keys&#39;, ARGV[1]) \n for i=1,#keys,5000 do \n redis.call(&#39;del&#39;, unpack(keys, i, math.min(i+4999, #keys))) \n end \n return keys&quot; 0 autocom*
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h5>开发服务器环境介绍<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h5>
<p>开发服务器上通过使用docker来为每人提供一个独立的开发环境，通过主机上的nginx来将每人的域名分别通过反代指向他的docker。
我们使用了一个数据卷容器充当数据库文件目录，启动ssh供登陆开发.</p>
<div class="section" id="id6">
<h6>添加一个新的开发docker<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h6>
<ol class="arabic">
<li><p class="first">启动一个数据卷容器</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">-v</span> <span class="pre">/data</span> <span class="pre">--name</span> <span class="pre">&lt;your</span> <span class="pre">name&gt;_data</span> <span class="pre">pevc/data</span> <span class="pre">echo</span> <span class="pre">data_only</span> <span class="pre">for</span> <span class="pre">database</span></code></p>
</li>
<li><p class="first">启动一个开发容器</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-d</span> <span class="pre">-i</span> <span class="pre">-p</span> <span class="pre">9005:80</span> <span class="pre">-p</span> <span class="pre">10005:22</span> <span class="pre">-p</span> <span class="pre">8005:8000</span>&nbsp; <span class="pre">--volumes-from</span> <span class="pre">&lt;your</span> <span class="pre">name&gt;_data</span> <span class="pre">--name</span> <span class="pre">&lt;your</span> <span class="pre">name&gt;_42web</span> <span class="pre">mush/ac</span> <span class="pre">/usr/sbin/sshd</span> <span class="pre">-D</span> <span class="pre">-f</span> <span class="pre">/etc/ssh/sshd_config</span></code></p>
<p>需要注意端口号，run之前先看下别人用了哪些端口了，一般就将端口号加一就行了。</p>
</li>
<li><p class="first">配置dns和主机的nginx反向代理</p>
<p>在/etc/dnsmasq.conf解析你要使用的域名。</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>address=/mushapi.info/192.168.10.169
address=/*.mushapi.info/192.168.10.169
</pre></div>
</div>
<p>在/etc/nginx/conf.d中加入你的反向代理配置。</p>
</li>
</ol>
<div class="highlight-nginx"><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">mushapi.info</span> <span class="s">*.mushapi.info</span><span class="p">;</span>
    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
            <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:9000</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dnsmasq">
<h6>dnsmasq配置<a class="headerlink" href="#dnsmasq" title="永久链接至标题">¶</a></h6>
<ol class="arabic">
<li><p class="first">解析和泛解析</p>
<blockquote>
<div><p>在`/etc/dnsmasq.conf`中添加下面的代码</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>address=/mushapi.info/192.168.10.169
address=/*.mushapi.info/192.168.10.169
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">cname解析</p>
<p>假设我们要将a.com用cname指向b.com，则需要首先在本地hosts中增加b.com的解析，再向/etc/dnsmasq.conf中添加cname解析。</p>
<p>修改/etc/hosts,增加一行</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">&lt;some</span> <span class="pre">ip&gt;</span> <span class="pre">b.com</span></code></p>
<p>在dnsmasq.conf中增加</p>
<p><code class="xref py py-obj docutils literal"><span class="pre">cname=a.com,b.com</span></code></p>
</li>
</ol>
</div>
</div>
<div class="section" id="id7">
<h5>不要依赖工具<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h5>
<div class="section" id="redis">
<h6>redis分析工具<a class="headerlink" href="#redis" title="永久链接至标题">¶</a></h6>
<p><a class="reference external" href="https://github.com/sripathikrishnan/redis-rdb-tools">https://github.com/sripathikrishnan/redis-rdb-tools</a></p>
</div>
</div>
<div class="section" id="python">
<h5>Python抽象方法<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h5>
<p>Python中抽象方法有两种实现,一是通过抛出 <code class="xref py py-obj docutils literal"><span class="pre">NotImplementedError</span></code> 异常, 而是通过abc模块.</p>
<p>例如</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>和</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h5>使用Docker的正确姿势<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h5>
<div class="section" id="id9">
<h6>压缩Docker镜像的体积<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h6>
<div class="highlight-none"><div class="highlight"><pre><span></span>docker export &lt;要压缩的容器&gt; | docker import - &lt;新镜像名字&gt;
</pre></div>
</div>
</div>
<div class="section" id="godockerdocker">
<h6>使用go语言编写一个可以放到Docker中的静态可执行文件并生成为一个Docker容器<a class="headerlink" href="#godockerdocker" title="永久链接至标题">¶</a></h6>
<p>go语言是个好东西,吉祥物都那么萌.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>go build  -a -ldflags &#39;-s&#39; &lt;要编译的Go文件&gt;
</pre></div>
</div>
<p>然后再DockerFile里这么写</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>FROM scratch
ADD &lt;编译粗来的可执行文件&gt; /
ENTRYPOINT [&quot;&lt;编译粗来的可执行文件&gt;&quot;]
</pre></div>
</div>
<p>我研究这个问题的起因是我只想弄个echo到Docker里面,因为你run一个Docker的时候必须指定一个运行的命令.但我把echo这个可执行文件搞进去发现不能用.具体的可以参看这里,http://blog.xebia.com/2014/07/04/create-the-smallest-possible-docker-container/</p>
<p>监控Docker容器内存使用情况</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>cat /sys/fs/cgroup/memory/system.slice/docker-88018f8043d00669bbf865855ebc8a6ccc93a04ce588111e01d4e63739250340.scope/memory.stat
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h5>应对怪需求的好方法<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h5>
<div class="section" id="dict">
<h6>关于dict顺序的问题<a class="headerlink" href="#dict" title="永久链接至标题">¶</a></h6>
<p>经常的我们有一些字段为枚举,然后在页面上要用select的形式展现,往往善变的产品会要求改变下拉菜单条目出现的顺序,我们可以这样应对.</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;stage&quot;</span>  <span class="na">ms_duplex</span><span class="o">=</span><span class="s">&quot;o.com_base_info.stage&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;spinput&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;0&quot;</span><span class="p">&gt;</span>请选择阶段<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
    % for k, v in COM_STAGE_DICT.iteritems():
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;${k.value}&quot;</span><span class="p">&gt;</span>${v}：${COM_STAGE_COMMENT_DICT[k.value]}<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
    % endfor
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">COM_STAGE_DICT</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
<span class="n">COM_STAGE_DICT</span><span class="p">[</span><span class="n">COM_INFO_STAGE</span><span class="o">.</span><span class="n">CONCEPT</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;概念阶段&#39;</span>
<span class="n">COM_STAGE_DICT</span><span class="p">[</span><span class="n">COM_INFO_STAGE</span><span class="o">.</span><span class="n">DEVELOPING</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;研发阶段&#39;</span>
<span class="n">COM_STAGE_DICT</span><span class="p">[</span><span class="n">COM_INFO_STAGE</span><span class="o">.</span><span class="n">RELEASED</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;正式发布&#39;</span>
<span class="n">COM_STAGE_DICT</span><span class="p">[</span><span class="n">COM_INFO_STAGE</span><span class="o">.</span><span class="n">GETUSERS</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;已有用户&#39;</span>
<span class="n">COM_STAGE_DICT</span><span class="p">[</span><span class="n">COM_INFO_STAGE</span><span class="o">.</span><span class="n">PROFIT</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;已有收入&#39;</span>
<span class="c1"># COM_STAGE_DICT = {</span>
<span class="c1">#     COM_INFO_STAGE.CONCEPT : &#39;概念阶段&#39;,</span>
<span class="c1">#     COM_INFO_STAGE.DEVELOPING : &#39;研发阶段&#39;,</span>
<span class="c1">#     COM_INFO_STAGE.RELEASED : &#39;正式发布&#39;,</span>
<span class="c1">#     COM_INFO_STAGE.GETUSERS : &#39;已有用户&#39;,</span>
<span class="c1">#     COM_INFO_STAGE.PROFIT : &#39;已有收入&#39;,</span>
<span class="c1"># }</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 版权所有 2021, PegasusWang
      <span class="commit">
        
        Revision <code>f3c9eb03</code>.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/zh/latest/">latest</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//python-web-guide.readthedocs.io/_/downloads/zh/latest/htmlzip/">html</a></dd>
        
          <dd><a href="//python-web-guide.readthedocs.io/_/downloads/zh/latest/epub/">epub</a></dd>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/python-web-guide/?fromdocs=python-web-guide">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/python-web-guide/?fromdocs=python-web-guide">Builds</a>
          </dd>
      </dl>
    </div>
  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>