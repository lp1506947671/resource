

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Python黑魔法手册 2.0 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/js/readmore.js"></script>
        <script type="text/javascript" src="_static/js/baidutongji.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/_static/css/theme.css" type="text/css" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html#document-index" class="icon icon-home"> Python黑魔法手册
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-preface">前言</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">关于博客</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">作者的话</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p01">第一章：魔法冷知识</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_01">1.1 默默无闻的省略号很好用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_02">1.2 使用 end 来结束代码块</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_03">1.3 可直接运行的 zip 包</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_04">1.4 反斜杠的倔强: 不写最后</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_05">1.5 如何修改解释器提示符</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_06">1.6 简洁而优雅的链式比较</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_07">1.7 and 和 or 的短路效应</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_08">1.8 连接多个列表最极客的方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_09">1.9 字典居然是可以排序的？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_10">1.10 哪些情况下不需要续行符？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_11">1.11 用户无感知的小整数池</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_12">1.12 神奇的 intern 机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_13">1.13 site-packages和 dist-packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_14">1.14 argument 和 parameter 的区别?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_15">1.15 /usr/bin/env python 有什么用？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_16">1.16 dict() 与 {} 生成空字典有什么区别？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_17">1.17 有趣但没啥用的 import 用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_18">1.18 正负得负，负负得正</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_19">1.19 return不一定都是函数的终点</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_20">1.20 字符串里的缝隙是什么？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_21">1.21 Python2下 也能使用 print(“”)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_22">1.22 字母也玩起了障眼法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_23">1.23 数值与字符串的比较</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_24">1.24 时有时无的切片异常</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_25">1.25 迷一样的字符串</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_26">1.26 x 与 +x 等价吗？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_27">1.27 += 不等同于=+</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_28">1.28 循环中的局部变量泄露</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_29">1.29 局部/全局变量傻傻分不清</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_30">1.30 break /continue 和 上下文管理器哪个优先级高？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c01/c01_31">1.31 如何像 awk一样分割字符串？</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p02">第二章：魔法命令行</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_01">2.1 懒人必备技能：使用 “_” </a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_02">2.2 最快查看包搜索路径的方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_03">2.3 使用 json.tool 来格式化 JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_04">2.4 命令行式执行 Python 代码</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_05">2.5 用调试模式执行脚本</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_06">2.6 如何快速搭建 HTTP 服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_07">2.7 快速构建 HTML 帮助文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_08">2.8 最正确且优雅的装包方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_09">2.9 往 Python Shell 中传入参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_10">2.10 让脚本报错后立即进入调试模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_11">2.11 极简模式执行 Python Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_12">2.12 在执行任意代码前自动念一段平安经</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_13">2.13 启动 Python Shell 前自动执行某脚本</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c02/c02_14">2.14 把模块当做脚本来执行 7 种方法及原理</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p03">第三章：炫技魔法操作</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_01">3.1 八种连接列表的方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_02">3.2 合并字典的 8 种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_03">3.3 花式导包的八种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_04">3.4 条件语句的七种写法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_05">3.5 判断是否包含子串的七种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_06">3.6 海象运算符的三种用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_07">3.7 模块重载的五种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_08">3.8 Python 转义的五种表示法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_09">3.9 Python 装包的八种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_10">3.10 Python装饰器的六种写法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_11">3.11 Python 读取文件的三种方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c03/c03_12">3.12 调用函数的九种方法</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p04">第四章：魔法进阶扫盲</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c04/c04_01">4.1 精通上下文管理器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c04/c04_02">4.2 深入理解描述符</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c04/c04_03">4.3 神奇的元类编程</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p05">第五章：魔法开发技巧</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_01">5.1 嵌套上下文管理的另类写法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_02">5.2 将嵌套 for 循环写成单行</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_03">5.3 单行实现 for 死循环如何写？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_04">5.4 如何关闭异常自动关联上下文？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_05">5.5 自带的缓存机制不用白不用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_06">5.6 如何流式读取数G超大文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_07">5.7 实现类似 defer 的延迟调用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_08">5.8 如何快速计算函数运行时间</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_09">5.9 重定向标准输出到日志</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_10">5.10 快速定位错误进入调试模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_11">5.11 在程序退出前执行代码的技巧</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_12">5.12 逗号也有它的独特用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_13">5.13 如何在运行状态查看源代码？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_14">5.14 单分派泛函数如何写？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_15">5.15 让我爱不释手的用户环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_16">5.16 字符串的分割技巧</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_17">5.17 反转字符串/列表最优雅的方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_18">5.18 如何将 print 内容输出到文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_19">5.19 改变默认递归次数限制</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_20">5.20 让你晕头转向的 else 用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_21">5.21 字典访问不存在的key时不再报错</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_22">5.22 如何实现函数的连续调用？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_23">5.23 如何实现字典的多级排序</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_24">5.24 对齐字符串的两种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_25">5.25 将位置参数变成关键字参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_26">5.26 如何获取一个函数设定的参数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_27">5.27 如何进行版本的比较</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_28">5.28 如何捕获警告?(注意不是捕获异常)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_29">5.29 如何禁止对象深拷贝?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_30">5.30 如何将变量名和变量值转为字典？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c05/c05_31">5.31 替换实例方法的最佳实践</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p06">第六章：良好编码习惯</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_01">6.1 不要直接调用类的私有方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_02">6.2 默认参数最好不为可变对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_03">6.3 增量赋值的性能更好</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_04">6.4 别再使用 pprint 打印了</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_05">6.5 变量名与保留关键冲突怎么办？</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c06/c06_06">6.6 不想让子类继承的变量名该怎么写？</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-chapters/p07">第七章：神奇魔法模块</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_01">7.1 远程登陆服务器的最佳利器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_02">7.2 代码 BUG 变得酷炫的利器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_03">7.3 少有人知的 Python “重试机制”</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_04">7.4 规整字符串提取数据的神器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_05">7.5 一行代码让代码运行速度提高100倍</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_06">7.6 新一代的调试神器：PySnooper</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_07">7.7 比open更好用、更优雅的读取文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_08">7.8 像操作路径一样，操作嵌套字典</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-c07/c07_09">7.9 读取文件中任意行的数据</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-aboutme">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-roadmap">Roadmap</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">Python黑魔法手册</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index">Docs</a> &raquo;</li>
        
      <li>Python黑魔法手册 2.0 文档</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/iswbm/magic-python/blob/master/source/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python">
<h1>Python黑魔法手册<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<span id="document-preface"></span><div class="section" id="id1">
<h2>前言<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="section" id="id2">
<h3>关于博客<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>这个博客于2020年8月3日发布完成，使用的是 Sphinx 来生成文档，使用 Github 托管文档，并使用 Read the Doc 发布文档。</p>
</div>
<div class="section" id="id3">
<h3>作者的话<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>Python 是一门对编程新手非常友好的语言，通常花个两个月的时间，就能开始自己写代码，做项目。</p>
<p>但也因为过于高级，给予了开发者很高的自由度。这本身没有问题，但是想要写出优雅的 Python 代码，需要 Coder 有一定的代码审美能力，才能很好的驾驭。</p>
<p>这本电子教程，是我个人花了很多的时间，将自己这些年来写 Python 的一些心得整理所成。</p>
<p>内容包含各种你在教材上、培训视频中无法习得的冷门知识，魔法知识，以及开发技巧，不管对于新手还是老手，我想都会有一定的帮助。</p>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
</div>
<span id="document-chapters/p01"></span><div class="section" id="id1">
<h2>第一章：魔法冷知识<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节记录了一些大多数开发者并不知晓的冷知识，内容基本延续 v1.0 。</p>
<p>本章节，会持续更新，敬请关注...</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c01/c01_01"></span><div class="section" id="id1">
<h3>1.1 默默无闻的省略号很好用<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在Python中，一切皆对象，省略号也不例外。</p>
<p>在 Python 3 中你可以直接写 <code class="docutils literal notranslate"><span class="pre">...</span></code> 来得到它</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">...</span>
<span class="go">Ellipsis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="go">&lt;class &#39;ellipsis&#39;&gt;</span>
</pre></div>
</div>
<p>而在 Python 2 中没有<code class="docutils literal notranslate"><span class="pre">...</span></code> 这个语法，只能直接写Ellipsis来获取。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="bp">Ellipsis</span>
<span class="go">Ellipsis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)</span>
<span class="go">&lt;type &#39;ellipsis&#39;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>它转为布尔值时为真</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">bool</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>最后，这东西是一个单例。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="go">4362672336</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="go">4362672336</span>
</pre></div>
</div>
<p>那这东西有啥用呢？</p>
<ol class="arabic simple">
<li><p>它是 Numpy 的一个语法糖</p></li>
<li><p>在 Python 3 中可以使用 … 代替 pass</p></li>
</ol>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat demo.py
def func01<span class="o">()</span>:
    ...

def func02<span class="o">()</span>:
    pass

func01<span class="o">()</span>
func02<span class="o">()</span>

print<span class="o">(</span><span class="s2">&quot;ok&quot;</span><span class="o">)</span>

$ python3 demo.py
ok
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_02"></span><div class="section" id="end">
<h3>1.2 使用 end 来结束代码块<a class="headerlink" href="#end" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>有不少编程语言，循环、判断代码块需要用 end
标明结束，这样一定程度上会使代码逻辑更加清晰一点。</p>
<p>但是其实在 Python 这种严格缩进的语言里并没有必要这样做。</p>
<p>如果你真的想用，也不是没有办法，具体你看下面这个例子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">__builtins__</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">my_abs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="k">print</span><span class="p">(</span><span class="n">my_abs</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">my_abs</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>执行后，输出如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span>$ python demo.py
<span class="m">10</span>
<span class="m">10</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_03"></span><div class="section" id="zip">
<h3>1.3 可直接运行的 zip 包<a class="headerlink" href="#zip" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>我们可以经常看到有 Python 包，居然可以以 zip
包进行发布，并且可以不用解压直接使用。</p>
<p>这与大多数人的认识的 Python 包格式不一样，正常人认为 Python 包的格式要嘛
是 egg，要嘛是whl 格式。</p>
<p>那么这个zip 是如何制作的呢，请看下面的示例。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ls -l demo</span>
total <span class="m">8</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">30</span> May  <span class="m">8</span> <span class="m">19</span>:27 calc.py
-rw-r--r-- <span class="m">1</span> root root <span class="m">35</span> May  <span class="m">8</span> <span class="m">19</span>:33 __main__.py
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo/__main__.py</span>
import calc

print<span class="o">(</span>calc.add<span class="o">(</span><span class="m">2</span>, <span class="m">3</span><span class="o">))</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo/calc.py</span>
def add<span class="o">(</span>x, y<span class="o">)</span>:
    <span class="k">return</span> x+y
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># python -m zipfile -c demo.zip demo/*</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p>制作完成后，我们可以执行用 python 去执行它</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># python demo.zip</span>
<span class="m">5</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_04"></span><div class="section" id="id1">
<h3>1.4 反斜杠的倔强: 不写最后<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">\</span></code> 在 Python 中的用法主要有两种</p>
<p><strong>1、在行尾时，用做续行符</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>[root@localhost ~]$ cat demo.py
print(&quot;hello &quot;\
   &quot;world&quot;)
[root@localhost ~]$
[root@localhost ~]$ python demo.py
hello world
</pre></div>
</div>
<p><strong>2、在字符串中，用做转义字符，可以将普通字符转化为有特殊含义的字符。</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; str1=&#39;\nhello&#39;　　＃换行
&gt;&gt;&gt; print(str1)

hello
&gt;&gt;&gt; str2=&#39;\thello&#39;　　＃tab
&gt;&gt;&gt; print(str2)
    hello
</pre></div>
</div>
<p>但是如果你用单<code class="docutils literal notranslate"><span class="pre">\</span></code>结尾是会报语法错误的</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">str3</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\&quot;</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>
    <span class="n">str3</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\&quot;</span>
           <span class="o">^</span>
<span class="gr">SyntaxError</span>: <span class="n">EOL while scanning string literal</span>
</pre></div>
</div>
<p>就算你指定它是个 raw 字符串，也不行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">str3</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\&quot;</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>
    <span class="n">str3</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\&quot;</span>
            <span class="o">^</span>
<span class="gr">SyntaxError</span>: <span class="n">EOL while scanning string literal</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_05"></span><div class="section" id="id1">
<h3>1.5 如何修改解释器提示符<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>这个当做今天的一个小彩蛋吧。应该算是比较冷门的，估计知道的人很少了吧。</p>
<p>正常情况下，我们在 终端下 执行Python 命令是这样的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">0</span>
<span class="go">1</span>
</pre></div>
</div>
<p>你是否想过 <code class="docutils literal notranslate"><span class="pre">&gt;&gt;&gt;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">...</span></code> 这两个提示符也是可以修改的呢？</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">ps1</span>
<span class="go">&#39;&gt;&gt;&gt; &#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">ps2</span>
<span class="go">&#39;... &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">ps2</span> <span class="o">=</span> <span class="s1">&#39;---------------- &#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">ps1</span> <span class="o">=</span> <span class="s1">&#39;Python编程时光&gt;&gt;&gt;&#39;</span>
<span class="go">Python编程时光&gt;&gt;&gt;for i in range(2):</span>
<span class="go">----------------    print (i)</span>
<span class="go">----------------</span>
<span class="go">0</span>
<span class="go">1</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_06"></span><div class="section" id="id1">
<h3>1.6 简洁而优雅的链式比较<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>先给你看一个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="bp">False</span> <span class="o">==</span> <span class="bp">False</span> <span class="o">==</span> <span class="bp">True</span>
<span class="go">False</span>
</pre></div>
</div>
<p>你知道这个表达式为什么会会返回 False 吗？</p>
<p>它的运行原理与下面这个类似，是不是有点头绪了：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="mi">80</span> <span class="o">&lt;</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;成绩良好&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你还是不明白，那我再给你整个第一个例子的等价写法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="bp">False</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">False</span> <span class="o">==</span> <span class="bp">True</span>
<span class="go">False</span>
</pre></div>
</div>
<p>这个用法叫做链式比较。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_07"></span><div class="section" id="and-or">
<h3>1.7 and 和 or 的短路效应<a class="headerlink" href="#and-or" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>and 和 or 是我们再熟悉不过的两个逻辑运算符，在 Python 也有它有妙用。</p>
<ul class="simple">
<li><p>当一个 <strong>or 表达式</strong>中所有值都为真，Python会选择第一个值</p></li>
<li><p>当一个 <strong>and 表达式</strong> 所有值都为真，Python 会选择最后一个值。</p></li>
</ul>
<p>示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;(2 or 3) * (5 and 6 and 7)</span>
<span class="go">14  # 2*7</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_08"></span><div class="section" id="id1">
<h3>1.8 连接多个列表最极客的方式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),</span> <span class="p">[])</span>
<span class="go">[1, 2, 3, 4, 5, 6]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_09"></span><div class="section" id="id1">
<h3>1.9 字典居然是可以排序的？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在 Python 3.6 之前字典不可排序的思想，似乎已经根深蒂固。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python2.7.10</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mydict</span>
<span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
</pre></div>
</div>
<p>假如哪一天，有人跟你说字典也可以是有序的，不要惊讶，那确实是真的</p>
<p>在 Python3.6 +
中字典已经是有序的，并且效率相较之前的还有所提升，具体信息你可以去查询相关资料。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python3.6.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mydict</span>
<span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_10"></span><div class="section" id="id1">
<h3>1.10 哪些情况下不需要续行符？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在写代码时，为了代码的可读性，代码的排版是尤为重要的。</p>
<p>为了实现高可读性的代码，我们常常使用到的就是续行符 <code class="docutils literal notranslate"><span class="pre">\</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;talk is cheap,&#39;</span>\
<span class="gp">... </span>    <span class="s1">&#39;show me the code.&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">talk is cheap,show me the code.</span>
</pre></div>
</div>
<p>那有哪些情况下，是不需要写续行符的呢？</p>
<p>经过总结，在这些符号中间的代码换行可以省略掉续行符：<code class="docutils literal notranslate"><span class="pre">[]</span></code>,<code class="docutils literal notranslate"><span class="pre">()</span></code>,<code class="docutils literal notranslate"><span class="pre">{}</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>         <span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">my_tuple</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
<span class="gp">... </span>          <span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">my_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MING&quot;</span><span class="p">,</span>
<span class="gp">... </span>         <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>另外还有，在多行文本注释中 <code class="docutils literal notranslate"><span class="pre">'''</span></code> ，续行符也是可以不写的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;talk is cheap,</span>
<span class="gp">... </span><span class="s1">show me code.&#39;&#39;&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>但是这种写法回车会自动转化为 <code class="docutils literal notranslate"><span class="pre">\n</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;talk is cheap,</span>
<span class="gp">... </span><span class="s1">show me code.&#39;&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">text</span>
<span class="go">&#39;talk is cheap,\nshow me code.&#39;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_11"></span><div class="section" id="id1">
<h3>1.11 用户无感知的小整数池<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>为避免整数频繁申请和销毁内存空间，Python 定义了一个小整数池 [-5, 256]
这些整数对象是提前建立好的，不会被垃圾回收。</p>
<p>以上代码请在 终端Python环境下测试，如果你是在IDE中测试，由于 IDE
的影响，效果会有所不同。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="mi">256</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="mi">257</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="mi">257</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="mi">257</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">257</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">True</span>
</pre></div>
</div>
<p><strong>问题又来了：最后一个示例，为啥是True？</strong></p>
<p>因为当你在同一行里，同时给两个变量赋同一值时，解释器知道这个对象已经生成，那么它就会引用到同一个对象。如果分成两行的话，解释器并不知道这个对象已经存在了，就会重新申请内存存放这个对象。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_12"></span><div class="section" id="intern">
<h3>1.12 神奇的 intern 机制<a class="headerlink" href="#intern" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>字符串类型作为Python中最常用的数据类型之一，Python解释器为了提高字符串使用的效率和使用性能，做了很多优化.</p>
<p>例如：Python解释器中使用了
intern（字符串驻留）的技术来提高字符串效率，什么是intern机制？就是同样的字符串对象仅仅会保存一份，放在一个字符串储蓄池中，是共用的，当然，肯定不能改变，这也决定了字符串必须是不可变对象。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">True</span>

<span class="go"># 如果有空格，默认不启用intern机制</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">=</span><span class="s2">&quot;hell o&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">=</span><span class="s2">&quot;hell o&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">False</span>

<span class="go"># 如果一个字符串长度超过20个字符，不启动intern机制</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">21</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">21</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">False</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span> <span class="o">*</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span> <span class="o">*</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span> <span class="o">*</span> <span class="mi">11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span> <span class="o">*</span> <span class="mi">11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="ow">is</span> <span class="n">s2</span>
<span class="go">False</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_13"></span><div class="section" id="site-packages-dist-packages">
<h3>1.13 site-packages和 dist-packages<a class="headerlink" href="#site-packages-dist-packages" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>如果你足够细心，你会在你的机器上，有些包是安装在 <strong>site-packages</strong>
下，而有些包安装在 <strong>dist-packages</strong> 下。</p>
<p><strong>它们有什么区别呢？</strong></p>
<p>一般情况下，你只见过 site-packages 这个目录，而你所安装的包也将安装在
这个目录下。</p>
<p>而 dist-packages 其实是 debian 系的 Linux 系统（如
Ubuntu）才特有的目录，当你使用 apt 去安装的 Python 包会使用
dist-packages，而你使用 pip 或者 easy_install 安装的包还是照常安装在
site-packages 下。</p>
<p>Debian 这么设计的原因，是为了减少不同来源的 Python 之间产生的冲突。</p>
<p>如何查找 Python 安装目录</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">distutils.sysconfig</span> <span class="kn">import</span> <span class="n">get_python_lib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">get_python_lib</span><span class="p">())</span>
<span class="go">/usr/lib/python2.7/site-packages</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_14"></span><div class="section" id="argument-parameter">
<h3>1.14 argument 和 parameter 的区别?<a class="headerlink" href="#argument-parameter" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>arguments 和 parameter
的翻译都是参数，在中文场景下，二者混用基本没有问题，毕竟都叫参数嘛。</p>
<p>但若要严格再进行区分，它们实际上还有各自的叫法</p>
<ul class="simple">
<li><p>parameter：形参（<strong>formal
parameter</strong>），体现在函数内部，作用域是这个函数体。</p></li>
<li><p>argument ：实参（<strong>actual parameter</strong>），调用函数实际传递的参数。</p></li>
</ul>
<p>举个例子，如下这段代码，<code class="docutils literal notranslate"><span class="pre">&quot;error&quot;</span></code> 为 argument，而 msg 为
<code class="docutils literal notranslate"><span class="pre">parameter</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">output_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="n">output_msg</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_15"></span><div class="section" id="usr-bin-env-python">
<h3>1.15 /usr/bin/env python 有什么用？<a class="headerlink" href="#usr-bin-env-python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>我们经常会在别人的脚本或者项目的入口文件里看到第一行是下面这样</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
</pre></div>
</div>
<p>或者这样</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
</pre></div>
</div>
<p>这两者有什么区别呢？</p>
<p>稍微接触过 linux 的人都知道 <code class="docutils literal notranslate"><span class="pre">/usr/bin/python</span></code> 就是我们执行 <code class="docutils literal notranslate"><span class="pre">python</span></code>
进入console 模式里的 <code class="docutils literal notranslate"><span class="pre">python</span></code></p>
<p><img alt="image1" src="http://image.iswbm.com/20200331184021.png" /></p>
<p>而当你在可执行文件头里使用 <code class="docutils literal notranslate"><span class="pre">#!</span></code> + <code class="docutils literal notranslate"><span class="pre">/usr/bin/python</span></code>
，意思就是说你得用哪个软件 （python）来执行这个文件。</p>
<p>那么加和不加有什么区别呢？</p>
<p>不加的话，你每次执行这个脚本时，都得这样： <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">xx.py</span></code> ，</p>
<p><img alt="image2" src="http://image.iswbm.com/20200331185034.png" /></p>
<p>有没有一种方式？可以省去每次都加 <code class="docutils literal notranslate"><span class="pre">python</span></code> 呢？</p>
<p>当然有，你可以文件头里加上<code class="docutils literal notranslate"><span class="pre">#!/usr/bin/python</span></code>
，那么当这个文件有可执行权限 时，只直接写这个脚本文件，就像下面这样。</p>
<p><img alt="image3" src="http://image.iswbm.com/20200331184755.png" /></p>
<p>明白了这个后，再来看看 <code class="docutils literal notranslate"><span class="pre">!/usr/bin/env</span> <span class="pre">python</span></code> 这个 又是什么意思 ？</p>
<p>当我执行 <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">python</span></code> 时，自动进入了 python console 的模式。</p>
<p><img alt="image4" src="http://image.iswbm.com/20200331185741.png" /></p>
<p>这是为什么？和 直接执行 python 好像没什么区别呀</p>
<p>当你执行 <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">python</span></code> 时，它其实会去 <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">PATH</span></code> 里（也就是
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin
）这几个路径里去依次查找名为python的可执行文件。</p>
<p>找到一个就直接执行，上面我们的 python 路径是在 <code class="docutils literal notranslate"><span class="pre">/usr/bin/python</span></code>
里，在 <code class="docutils literal notranslate"><span class="pre">PATH</span></code> 列表里倒数第二个目录下，所以当我在 <code class="docutils literal notranslate"><span class="pre">/usr/local/sbin</span></code>
下创建一个名字也为 python 的可执行文件时，就会执行
<code class="docutils literal notranslate"><span class="pre">/usr/local/sbin/python</span></code> 了。</p>
<p>具体演示过程，你可以看下面。</p>
<p><img alt="image5" src="http://image.iswbm.com/20200331190224.png" /></p>
<p>那么对于这两者，我们应该使用哪个呢？</p>
<p>个人感觉应该优先使用 <code class="docutils literal notranslate"><span class="pre">#!/usr/bin/env</span> <span class="pre">python</span></code>，因为不是所有的机器的
python 解释器都是 <code class="docutils literal notranslate"><span class="pre">/usr/bin/python</span></code> 。</p>
<p><img alt="image6" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_16"></span><div class="section" id="dict">
<h3>1.16 dict() 与 {} 生成空字典有什么区别？<a class="headerlink" href="#dict" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在初始化一个空字典时，有的人会写 dict()，而有的人会写成 {}</p>
<p>很多人会想当然的认为二者是等同的，但实际情况却不是这样的。</p>
<p>在运行效率上，{} 会比 dict() 快三倍左右。</p>
<p>使用 timeit 模块，可以轻松测出这个结果</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m timeit -n <span class="m">1000000</span> -r <span class="m">5</span> -v <span class="s2">&quot;dict()&quot;</span>
raw times: <span class="m">0</span>.0996 <span class="m">0</span>.0975 <span class="m">0</span>.0969 <span class="m">0</span>.0969 <span class="m">0</span>.0994
<span class="m">1000000</span> loops, best of <span class="m">5</span>: <span class="m">0</span>.0969 usec per loop
$
$ python -m timeit -n <span class="m">1000000</span> -r <span class="m">5</span> -v <span class="s2">&quot;{}&quot;</span>
raw times: <span class="m">0</span>.0305 <span class="m">0</span>.0283 <span class="m">0</span>.0272 <span class="m">0</span>.03 <span class="m">0</span>.0317
<span class="m">1000000</span> loops, best of <span class="m">5</span>: <span class="m">0</span>.0272 usec per loop
</pre></div>
</div>
<p>那为什么会这样呢？</p>
<p>探究这个过程，可以使用 dis 模块</p>
<p>当使用 {} 时</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat demo.py
<span class="o">{}</span>
$
$ python -m dis demo.py
  <span class="m">1</span>           <span class="m">0</span> BUILD_MAP                <span class="m">0</span>
              <span class="m">2</span> POP_TOP
              <span class="m">4</span> LOAD_CONST               <span class="m">0</span> <span class="o">(</span>None<span class="o">)</span>
              <span class="m">6</span> RETURN_VALUE
</pre></div>
</div>
<p>当使用 dict() 时：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat demo.py
dict<span class="o">()</span>
$
$ python -m dis demo.py
  <span class="m">1</span>           <span class="m">0</span> LOAD_NAME                <span class="m">0</span> <span class="o">(</span>dict<span class="o">)</span>
              <span class="m">2</span> CALL_FUNCTION            <span class="m">0</span>
              <span class="m">4</span> POP_TOP
              <span class="m">6</span> LOAD_CONST               <span class="m">0</span> <span class="o">(</span>None<span class="o">)</span>
              <span class="m">8</span> RETURN_VALUE
</pre></div>
</div>
<p>可以发现使用
dict()，会多了个调用函数的过程，而这个过程会有进出栈的操作，相对更加耗时。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_17"></span><div class="section" id="import">
<h3>1.17 有趣但没啥用的 import 用法<a class="headerlink" href="#import" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>import 是 Python 导包的方式。</p>
<p>你知道 Python 中内置了一些很有（wu）趣（liao）的包吗？</p>
<p><strong>Hello World</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">__hello__</span>
<span class="go">Hello World!</span>
</pre></div>
</div>
<p><strong>Python之禅</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">this</span>

<span class="go">The Zen of Python, by Tim Peters</span>

<span class="go">Beautiful is better than ugly.</span>
<span class="go">Explicit is better than implicit.</span>
<span class="go">Simple is better than complex.</span>
<span class="go">Complex is better than complicated.</span>
<span class="go">Flat is better than nested.</span>
<span class="go">Sparse is better than dense.</span>
<span class="go">Readability counts.</span>
<span class="go">Special cases aren&#39;t special enough to break the rules.</span>
<span class="go">Although practicality beats purity.</span>
<span class="go">Errors should never pass silently.</span>
<span class="go">Unless explicitly silenced.</span>
<span class="go">In the face of ambiguity, refuse the temptation to guess.</span>
<span class="go">There should be one-- and preferably only one --obvious way to do it.</span>
<span class="go">Although that way may not be obvious at first unless you&#39;re Dutch.</span>
<span class="go">Now is better than never.</span>
<span class="go">Although never is often better than *right* now.</span>
<span class="go">If the implementation is hard to explain, it&#39;s a bad idea.</span>
<span class="go">If the implementation is easy to explain, it may be a good idea.</span>
<span class="go">Namespaces are one honking great idea -- let&#39;s do more of those!</span>
</pre></div>
</div>
<p><strong>反地心引力漫画</strong></p>
<p>在 cmd 窗口中导入<code class="docutils literal notranslate"><span class="pre">antigravity</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">antigravity</span>
</pre></div>
</div>
<p>就会自动打开一个网页。 <img alt="image1" src="http://image.iswbm.com/20190511165735.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_18"></span><div class="section" id="id1">
<h3>1.18 正负得负，负负得正<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>从初中开始，我们就开始接触了<code class="docutils literal notranslate"><span class="pre">负数</span></code> ，并且都知道了<code class="docutils literal notranslate"><span class="pre">负负得正</span></code>
的思想。</p>
<p>Python 作为一门高级语言，它的编写符合人类的思维逻辑，包括 <code class="docutils literal notranslate"><span class="pre">负负得正</span></code>
。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">5</span><span class="o">-</span><span class="mi">3</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">5</span><span class="o">--</span><span class="mi">3</span>
<span class="go">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">5</span><span class="o">+-</span><span class="mi">3</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">5</span><span class="o">++</span><span class="mi">3</span>
<span class="go">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">5</span><span class="o">---</span><span class="mi">3</span>
<span class="go">2</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_19"></span><div class="section" id="return">
<h3>1.19 return不一定都是函数的终点<a class="headerlink" href="#return" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>众所周知，try…finally…
的用法是：不管try里面是正常执行还是有报异常，最终都能保证finally能够执行。</p>
<p>同时我们又知道，一个函数里只要遇到 return 函数就会立马结束。</p>
<p>那问题就来了，以上这两种规则，如果同时存在，Python
解释器会如何选择？哪个优先级更高？</p>
<p>写个示例验证一下，就明白啦</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s1">&#39;try&#39;</span>
<span class="gp">... </span>    <span class="k">finally</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s1">&#39;finally&#39;</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="p">()</span>
<span class="go">&#39;finally&#39;</span>
</pre></div>
</div>
<p>从输出中，我们可以发现：在try…finally…语句中，try中的 return
会被直接忽视（这里的 return 不是函数的终点），因为要保证 finally
能够执行。</p>
<p><strong>如果 try 里的 return 真的是直接被忽视吗？</strong></p>
<p>我们都知道如果一个函数没有 return，会隐式的返回 None，假设 try 里的
return 真的是直接被忽视，那当finally 下没有显式的 return
的时候，是不是会返回None呢？</p>
<p>还是写个 示例来验证一下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">try</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s1">&#39;try&#39;</span>
<span class="gp">... </span>    <span class="k">finally</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;finally&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="p">()</span>
<span class="go">finally</span>
<span class="go">&#39;try&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>从结果来看，当 finally 下没有 reutrn ，其实 try 里的 return
仍然还是有效的。</p>
<p>那结论就出来了，如果 finally 里有显式的 return，那么这个 return
会直接覆盖 try 里的 return，而如果 finally 里没有 显式的 return，那么
try 里的 return 仍然有效。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_20"></span><div class="section" id="id1">
<h3>1.20 字符串里的缝隙是什么？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在Python中求一个字符串里，某子字符（串）出现的次数。</p>
<p>大家都懂得使用 count() 函数，比如下面几个常规例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;aabb&quot;</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;aabb&quot;</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;aabb&quot;</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;ab&quot;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<p>但是如果我想计算空字符串的个数呢？</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;aabb&quot;</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">5</span>
</pre></div>
</div>
<p><strong>奇怪了吧？</strong></p>
<p>不是应该返回 0 吗？怎么会返回 5？</p>
<p>实际上，在 Python 看来，两个字符之间都是一个空字符，通俗的说就是缝隙。</p>
<p>因此 对于 <code class="docutils literal notranslate"><span class="pre">aabb</span></code> 这个字符串在 Python 来看应该是这样的</p>
<p><img alt="image1" src="http://image.iswbm.com/20200509172331.png" /></p>
<p>理解了这个“<strong>缝隙</strong>” 的概念后，以下这些就好理解了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">11</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="s2">&quot;&quot;</span>
<span class="go">True</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;&quot;</span> <span class="ow">in</span> <span class="s2">&quot;M&quot;</span>
<span class="go">True</span>
</pre></div>
</div>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_21"></span><div class="section" id="python2-print">
<h3>1.21 Python2下 也能使用 print(“”)<a class="headerlink" href="#python2-print" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>可能会有不少人，觉得只有 Python 3 才可以使用 print()，而 Python 2
只能使用<code class="docutils literal notranslate"><span class="pre">print</span> <span class="pre">&quot;&quot;</span></code>。</p>
<p>但是其实并不是这样的。</p>
<p>在Python 2.6之前，只支持</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="s2">&quot;hello&quot;</span>
</pre></div>
</div>
<p>在Python 2.6和2.7中，可以支持如下三种</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="s2">&quot;hello&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>在Python3.x中，可以支持如下两种</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>虽然 在 Python 2.6+ 可以和 Python3.x+ 一样，像函数一样去调用 print
，但是这仅用于两个 python 版本之间的代码兼容，并不是说在
python2.6+下使用 print() 后，就成了函数。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_22"></span><div class="section" id="id1">
<h3>1.22 字母也玩起了障眼法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>以下我分别在 Python2.7 和 Python 3.7 的 console 模式下，运行了如下代码。</p>
<p><strong>在Python 2.x 中</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">valuе</span> <span class="o">=</span> <span class="mi">32</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>
    <span class="n">valuе</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="o">^</span>
<span class="gr">SyntaxError</span>: <span class="n">invalid syntax</span>
</pre></div>
</div>
<p><strong>在Python 3.x 中</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">valuе</span> <span class="o">=</span> <span class="mi">32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">value</span>
<span class="go">11</span>
</pre></div>
</div>
<p>什么？没有截图你不信？</p>
<p><img alt="image1" src="http://image.iswbm.com/20200509122954.png" /></p>
<p>如果你在自己的电脑上尝试一下，结果可能是这样的</p>
<p><img alt="image2" src="http://image.iswbm.com/20200509123107.png" /></p>
<p><strong>怎么又好了呢？</strong></p>
<p>如果你想复现的话，请复制我这边给出的代码：<code class="docutils literal notranslate"><span class="pre">valuе</span> <span class="pre">=</span> <span class="pre">32</span></code></p>
<p><strong>这是为什么呢？</strong></p>
<p>原因在于，我上面使用的 value 变量名里的 <code class="docutils literal notranslate"><span class="pre">е</span></code> 又不是我们熟悉的
<code class="docutils literal notranslate"><span class="pre">e</span></code>，它是 Cyrillic（西里尔）字母。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;е&#39;</span><span class="p">)</span> <span class="c1"># cyrillic &#39;e&#39; (Ye)</span>
<span class="go">1077</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span> <span class="c1"># latin &#39;e&#39;, as used in English and typed using standard keyboard</span>
<span class="go">101</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;е&#39;</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span>
<span class="go">False</span>
</pre></div>
</div>
<p>细思恐极，在这里可千万不要得罪同事们，万一离职的时候，对方把你项目里的
<code class="docutils literal notranslate"><span class="pre">e</span></code> 全局替换成 <code class="docutils literal notranslate"><span class="pre">e</span></code>，到时候你就哭去吧，肉眼根本看不出来嘛。</p>
<p><img alt="image3" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_23"></span><div class="section" id="id1">
<h3>1.23 数值与字符串的比较<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在 Python2 中，数字可以与字符串直接比较。结果是数值永远比字符串小。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">100000000</span> <span class="o">&lt;</span> <span class="s2">&quot;&quot;</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">100000000</span> <span class="o">&lt;</span> <span class="s2">&quot;hello&quot;</span>
<span class="go">True</span>
</pre></div>
</div>
<p>但在 Python3 中，却不行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">100000000</span> <span class="o">&lt;</span> <span class="s2">&quot;&quot;</span>
<span class="go">TypeError: &#39;&lt;&#39; not supported between instances of &#39;int&#39; and &#39;str&#39;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_24"></span><div class="section" id="id1">
<h3>1.24 时有时无的切片异常<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>这是个简单例子，alist 只有5 个元素，当你取第 6
个元素时，会抛出索引异常。这与我们的认知一致。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">alist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alist</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">IndexError</span>: <span class="n">list index out of range</span>
</pre></div>
</div>
<p>但是当你使用 alist[5:] 取一个区间时，即使 alist 并没有 第
6个元素，也不抛出异常，而是会返回一个新的列表。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">alist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alist</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">alist</span><span class="p">[</span><span class="mi">100</span><span class="p">:]</span>
<span class="go">[]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_25"></span><div class="section" id="id1">
<h3>1.25 迷一样的字符串<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>示例一</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python2.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;Hello_Python&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">32045616</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;Python&quot;</span><span class="p">)</span>
<span class="mi">32045616</span>

<span class="c1"># Python3.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;Hello_Python&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">38764272</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">id</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;Python&quot;</span><span class="p">)</span>
<span class="mi">32045616</span>
</pre></div>
</div>
<p>示例二</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;MING&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;MING&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">True</span>

<span class="go"># Python2.7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;MING!&quot;</span><span class="p">,</span> <span class="s2">&quot;MING!&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">True</span>

<span class="go"># Python3.7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;MING!&quot;</span><span class="p">,</span> <span class="s2">&quot;MING!&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span>
<span class="go">False</span>
</pre></div>
</div>
<p>示例三</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python2.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">20</span> <span class="ow">is</span> <span class="s1">&#39;aaaaaaaaaaaaaaaaaaaa&#39;</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">21</span> <span class="ow">is</span> <span class="s1">&#39;aaaaaaaaaaaaaaaaaaaaa&#39;</span>
<span class="bp">False</span>

<span class="c1"># Python3.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">20</span> <span class="ow">is</span> <span class="s1">&#39;aaaaaaaaaaaaaaaaaaaa&#39;</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">21</span> <span class="ow">is</span> <span class="s1">&#39;aaaaaaaaaaaaaaaaaaaaa&#39;</span>
<span class="bp">True</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_26"></span><div class="section" id="x-x">
<h3>1.26 x 与 +x 等价吗？<a class="headerlink" href="#x-x" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在大多数情况下，这个等式是成立的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span> <span class="o">=</span> <span class="mi">10086</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n2</span> <span class="o">=</span> <span class="o">+</span><span class="n">n1</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span>
<span class="go">True</span>
</pre></div>
</div>
<p>什么情况下，这个等式会不成立呢？</p>
<p>由于Counter的机制，<code class="docutils literal notranslate"><span class="pre">+</span></code> 用于两个 Counter
实例相加，而相加的结果如果元素的个数 <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code> 0，就会被丢弃。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ct</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="s1">&#39;abcdbcaa&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ct</span>
<span class="go">Counter({&#39;a&#39;: 3, &#39;b&#39;: 2, &#39;c&#39;: 2, &#39;d&#39;: 1})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ct</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ct</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ct</span>
<span class="go">Counter({&#39;a&#39;: 3, &#39;b&#39;: 2, &#39;c&#39;: 0, &#39;d&#39;: -2})</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="o">+</span><span class="n">ct</span>
<span class="go">Counter({&#39;a&#39;: 3, &#39;b&#39;: 2})</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_27"></span><div class="section" id="id1">
<h3>1.27 += 不等同于=+<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>对列表 进行<code class="docutils literal notranslate"><span class="pre">+=</span></code> 操作相当于 extend，而使用 <code class="docutils literal notranslate"><span class="pre">=+</span></code>
操作是新增了一个列表。</p>
<p>因此会有如下两者的差异。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># =+</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>


<span class="c1"># +=</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_28"></span><div class="section" id="id1">
<h3>1.28 循环中的局部变量泄露<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在Python 2中 x 的值在一个循环执行之后被改变了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span>
<span class="mi">4</span>
</pre></div>
</div>
<p>不过在Python3 中这个问题已经得到解决了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span>
<span class="mi">1</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_29"></span><div class="section" id="id1">
<h3>1.29 局部/全局变量傻傻分不清<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在开始讲之前，你可以试着运行一下下面这小段代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># demo.py</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">add</span><span class="p">()</span>
</pre></div>
</div>
<p>看似没有毛病，但实则已经犯了一个很基础的问题，运行结果如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>$ python demo.py
Traceback (most recent call last):
  File &quot;demo.py&quot;, line 6, in &lt;module&gt;
    add()
  File &quot;demo.py&quot;, line 4, in add
    a += 1
UnboundLocalError: local variable &#39;a&#39; referenced before assignment
</pre></div>
</div>
<p>回顾一下，什么是局部变量？在非全局下定义声明的变量都是局部变量。</p>
<p>当程序运行到 <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+=</span> <span class="pre">1</span></code> 时，Python 解释器就认为在函数内部要给 <code class="docutils literal notranslate"><span class="pre">a</span></code>
这个变量赋值，当然就把 <code class="docutils literal notranslate"><span class="pre">a</span></code> 当做局部变量了，但是做为局部变量的 a
还没有被还没被定义。</p>
<p>因此报错是正常的。</p>
<p>理解了上面的例子，给你留个思考题。为什么下面的代码不会报错呢？</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>$ cat demo.py
a = 1

def output():
    print(a)

output()

$ python demo.py
1
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_30"></span><div class="section" id="break-continue">
<h3>1.30 break /continue 和 上下文管理器哪个优先级高？<a class="headerlink" href="#break-continue" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>众所周知，在循环体中（无论是 for 还是 while），continue
会用来跳入下一个循环，而 break 则用来跳出某个循环体。</p>
<p>同时我们又知道：在上下文管理器中，被包裹的程序主体代码结束会运行上下文管理器中的一段代码（通常是资源的释放）。</p>
<p>但如果把上下文管理器放在一个循环体中，而在这个上下文管理器中执行了 break
，是否会直接跳出循环呢？</p>
<p>换句话说，上下文管理器与 break/continue
这两个规则哪一个优先级会更高一些？</p>
<p>这个问题其实不难，只要做一下试验都能轻易地得出答案，难就难在很多对这个答案都是半猜半疑，无法肯定的回答。</p>
<p>试验代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;start: a = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">yield</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;end: a = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


<span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">a</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">with</span> <span class="n">runtime</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
<p>从输出的结果来看，当 a = 2 时执行了 break
，此时的并不会直接跳出循环，依然要运行上下文管理器里清理释放资源的代码（示例中，我使用
print 来替代）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">end</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">start</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">end</span><span class="p">:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>另外还有几个与此类似的问题，我这里也直接给出答案，不再细说了</p>
<ol class="arabic simple">
<li><p>continue 与 break 一样，如果先遇到上下文管理器会先进行资源的释放</p></li>
<li><p>上面只举例了 while 循环体，而 for 循环也是同样的。</p></li>
</ol>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c01/c01_31"></span><div class="section" id="awk">
<h3>1.31 如何像 awk一样分割字符串？<a class="headerlink" href="#awk" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>若你使用过 Shell 中的 awk
工具，会发现用它来分割字符串是非常方便的。特别是多个连续空格会被当做一个处理。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo.txt</span>
hello      world
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># awk &#39;{print$1,$2}&#39; demo.txt</span>
hello world
</pre></div>
</div>
<p>可是转换到 Python 上面来呢？结果可能是这样的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;hello    world&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="go">[&#39;hello&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;world&#39;]</span>
</pre></div>
</div>
<p>与我预想的结果不符，多个空格会被分割多次。</p>
<p>那有什么办法可以达到 awk 一样的效果呢？</p>
<p>有两种方法。</p>
<div class="section" id="id1">
<h4>第一种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>不加参数，这种只适用于将多个空格当成一个空格处理，如果不是以空格为分隔符的场景，这种就不适用了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;hello    world&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;]</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>第二种方法<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>使用 filter 来辅助，这种适用于所有的分隔符，下面以 <code class="docutils literal notranslate"><span class="pre">-</span></code>
为分隔符来举例。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;hello----world&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="go">[&#39;hello&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;world&#39;]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;]</span>
</pre></div>
</div>
<p>是不是很神奇，filter 印象中第一个参数接收的是 函数，这里直接传 None
居然有奇效。</p>
<p>查看了注释，原来是这个函数会适配 None
的情况，当第一个参数是None的时候，返回第二个参数（可迭代对象）中非空的值，非常方便。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200821173708.png" /></p>
<p>换用函数的写法，可以这样</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;hello----world&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="go">[&#39;hello&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;world&#39;]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">item</span> <span class="k">else</span> <span class="bp">False</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
<span class="go">[&#39;hello&#39;, &#39;world&#39;]</span>
</pre></div>
</div>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p02"></span><div class="section" id="id1">
<h2>第二章：魔法命令行<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节是全新的内容，主要介绍的是 Python Shell 的一些冷门玩法，这里面的内容，应该足够让你惊叹。</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c02/c02_01"></span><div class="section" id="image0">
<h3>2.1 懒人必备技能：使用 “_” <img alt="image0" src="http://image.iswbm.com/20200804124133.png" /><a class="headerlink" href="#image0" title="永久链接至标题">¶</a></h3>
<p>对于 <code class="docutils literal notranslate"><span class="pre">_</span></code> ，大家对于他的印象都是用于
<strong>占位符</strong>，省得为一个不需要用到的变量，绞尽脑汁的想变量名。</p>
<p>今天要介绍的是他的第二种用法，就是在交互式模式下的应用。</p>
<p>示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span>
<span class="go">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>
<span class="go">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;公众号: Python编程时光&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">name</span>
<span class="go">&#39;公众号: Python编程时光&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>
<span class="go">&#39;公众号: Python编程时光&#39;</span>
</pre></div>
</div>
<p>它可以返回上一次的运行结果。</p>
<p>但是，如果是print函数打印出来的就不行了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span>
<span class="go">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>
<span class="go">7</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;公众号: Python编程时光&quot;</span><span class="p">)</span>
<span class="go">ming</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>
<span class="go">7</span>
</pre></div>
</div>
<p>我自己写了个例子，验证了下，用<code class="docutils literal notranslate"><span class="pre">__repr__</span></code>输出的内容可以被获取到的。
首先，在我们的目录下，写一个文件 demo.py。内容如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># demo.py</span>
<span class="k">class</span> <span class="nc">mytest</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;hello&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;world&quot;</span>
</pre></div>
</div>
<p>然后在这个目录下进入交互式环境。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">demo</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mt</span><span class="o">=</span><span class="n">demo</span><span class="o">.</span><span class="n">mytest</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mt</span>
<span class="go">world</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
<span class="go">hello</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>
<span class="go">world</span>
</pre></div>
</div>
<p>知道这两个魔法方法的人，一看就明白了，这里不再解释啦。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_02"></span><div class="section" id="id1">
<h3>2.2 最快查看包搜索路径的方式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你使用 import 导入一个包或模块时，Python
会去一些目录下查找，而这些目录是有优先级顺序的，正常人会使用 sys.path
查看。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="go">[&#39;&#39;,</span>
<span class="go"> &#39;/usr/local/Python3.7/lib/python37.zip&#39;,</span>
<span class="go"> &#39;/usr/local/Python3.7/lib/python3.7&#39;,</span>
<span class="go"> &#39;/usr/local/Python3.7/lib/python3.7/lib-dynload&#39;,</span>
<span class="go"> &#39;/home/wangbm/.local/lib/python3.7/site-packages&#39;,</span>
<span class="go"> &#39;/usr/local/Python3.7/lib/python3.7/site-packages&#39;]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>那有没有更快的方式呢？</p>
<p>我这有一种连 console 模式都不用进入的方法呢？</p>
<p>你可能会想到这种，但这本质上与上面并无区别</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>[wangbm@localhost ~]$ python -c &quot;print(&#39;\n&#39;.join(__import__(&#39;sys&#39;).path))&quot;

/usr/lib/python2.7/site-packages/pip-18.1-py2.7.egg
/usr/lib/python2.7/site-packages/redis-3.0.1-py2.7.egg
/usr/lib64/python27.zip
/usr/lib64/python2.7
/usr/lib64/python2.7/plat-linux2
/usr/lib64/python2.7/lib-tk
/usr/lib64/python2.7/lib-old
/usr/lib64/python2.7/lib-dynload
/home/wangbm/.local/lib/python2.7/site-packages
/usr/lib64/python2.7/site-packages
/usr/lib64/python2.7/site-packages/gtk-2.0
/usr/lib/python2.7/site-packages
</pre></div>
</div>
<p>这里我要介绍的是比上面两种都方便的多的方法，一行命令即可解决</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ python3 -m site
sys.path <span class="o">=</span> <span class="o">[</span>
    <span class="s1">&#39;/home/wangbm&#39;</span>,
    <span class="s1">&#39;/usr/local/Python3.7/lib/python37.zip&#39;</span>,
    <span class="s1">&#39;/usr/local/Python3.7/lib/python3.7&#39;</span>,
    <span class="s1">&#39;/usr/local/Python3.7/lib/python3.7/lib-dynload&#39;</span>,
    <span class="s1">&#39;/home/wangbm/.local/lib/python3.7/site-packages&#39;</span>,
    <span class="s1">&#39;/usr/local/Python3.7/lib/python3.7/site-packages&#39;</span>,
<span class="o">]</span>
USER_BASE: <span class="s1">&#39;/home/wangbm/.local&#39;</span> <span class="o">(</span>exists<span class="o">)</span>
USER_SITE: <span class="s1">&#39;/home/wangbm/.local/lib/python3.7/site-packages&#39;</span> <span class="o">(</span>exists<span class="o">)</span>
ENABLE_USER_SITE: True
</pre></div>
</div>
<p>从输出你可以发现，这个列的路径会比 sys.path
更全，它包含了用户环境的目录。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_03"></span><div class="section" id="json-tool-json">
<h3>2.3 使用 json.tool 来格式化 JSON<a class="headerlink" href="#json-tool-json" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>假设现在你需要查看你机器上的json文件，而这个文件没有经过任何的美化，阅读起来是非常困难的。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat demo.json
<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;5f12d319624e57e27d1291fe&quot;</span>,<span class="s2">&quot;index&quot;</span>:0,<span class="s2">&quot;guid&quot;</span>:<span class="s2">&quot;4e482708-c6aa-4ef9-a45e-d5ce2c72c68d&quot;</span>,<span class="s2">&quot;isActive&quot;</span>:false,<span class="s2">&quot;balance&quot;</span>:<span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">,954.93&quot;</span>,<span class="s2">&quot;picture&quot;</span>:<span class="s2">&quot;http://placehold.it/32x32&quot;</span>,<span class="s2">&quot;age&quot;</span>:36,<span class="s2">&quot;eyeColor&quot;</span>:<span class="s2">&quot;green&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MasseySaunders&quot;</span>,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;male&quot;</span>,<span class="s2">&quot;company&quot;</span>:<span class="s2">&quot;TALAE&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;masseysaunders@talae.com&quot;</span>,<span class="s2">&quot;phone&quot;</span>:<span class="s2">&quot;+1(853)508-3237&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;246IndianaPlace,Glenbrook,Iowa,3896&quot;</span>,<span class="s2">&quot;about&quot;</span>:<span class="s2">&quot;Velitmagnanostrudexcepteurduisextemporirurefugiataliquasunt.Excepteurvelitquiseuinexinoccaecatoccaecatveliteuet.Commodonisialiquipirureminimconsequatminimconsecteturipsumsitex.\r\n&quot;</span>,<span class="s2">&quot;registered&quot;</span>:<span class="s2">&quot;2017-02-06T06:42:20-08:00&quot;</span>,<span class="s2">&quot;latitude&quot;</span>:-10.269827,<span class="s2">&quot;longitude&quot;</span>:-103.12419,<span class="s2">&quot;tags&quot;</span>:<span class="o">[</span><span class="s2">&quot;laborum&quot;</span>,<span class="s2">&quot;excepteur&quot;</span>,<span class="s2">&quot;veniam&quot;</span>,<span class="s2">&quot;reprehenderit&quot;</span>,<span class="s2">&quot;voluptate&quot;</span>,<span class="s2">&quot;laborum&quot;</span>,<span class="s2">&quot;in&quot;</span><span class="o">]</span>,<span class="s2">&quot;friends&quot;</span>:<span class="o">[{</span><span class="s2">&quot;id&quot;</span>:0,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;DorotheaShields&quot;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;id&quot;</span>:1,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;AnnaRosales&quot;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&quot;id&quot;</span>:2,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;GravesBryant&quot;</span><span class="o">}]</span>,<span class="s2">&quot;greeting&quot;</span>:<span class="s2">&quot;Hello,MasseySaunders!Youhave8unreadmessages.&quot;</span>,<span class="s2">&quot;favoriteFruit&quot;</span>:<span class="s2">&quot;apple&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>这时候你就可以使用 python 的命令行来直接美化。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m json.tool demo.json
<span class="o">{</span>
    <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;5f12d319624e57e27d1291fe&quot;</span>,
    <span class="s2">&quot;about&quot;</span>: <span class="s2">&quot;Velitmagnanostrudexcepteurduisextemporirurefugiataliquasunt.Excepteurvelitquiseuinexinoccaecatoccaecatveliteuet.Commodonisialiquipirureminimconsequatminimconsecteturipsumsitex.\r\n&quot;</span>,
    <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;246IndianaPlace,Glenbrook,Iowa,3896&quot;</span>,
    <span class="s2">&quot;age&quot;</span>: <span class="m">36</span>,
    <span class="s2">&quot;balance&quot;</span>: <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">,954.93&quot;</span>,
    <span class="s2">&quot;company&quot;</span>: <span class="s2">&quot;TALAE&quot;</span>,
    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;masseysaunders@talae.com&quot;</span>,
    <span class="s2">&quot;eyeColor&quot;</span>: <span class="s2">&quot;green&quot;</span>,
    <span class="s2">&quot;favoriteFruit&quot;</span>: <span class="s2">&quot;apple&quot;</span>,
    <span class="s2">&quot;friends&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;id&quot;</span>: <span class="m">0</span>,
            <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;DorotheaShields&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;id&quot;</span>: <span class="m">1</span>,
            <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;AnnaRosales&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;id&quot;</span>: <span class="m">2</span>,
            <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;GravesBryant&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">&quot;gender&quot;</span>: <span class="s2">&quot;male&quot;</span>,
    <span class="s2">&quot;greeting&quot;</span>: <span class="s2">&quot;Hello,MasseySaunders!Youhave8unreadmessages.&quot;</span>,
    <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;4e482708-c6aa-4ef9-a45e-d5ce2c72c68d&quot;</span>,
    <span class="s2">&quot;index&quot;</span>: <span class="m">0</span>,
    <span class="s2">&quot;isActive&quot;</span>: false,
    <span class="s2">&quot;latitude&quot;</span>: -10.269827,
    <span class="s2">&quot;longitude&quot;</span>: -103.12419,
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;MasseySaunders&quot;</span>,
    <span class="s2">&quot;phone&quot;</span>: <span class="s2">&quot;+1(853)508-3237&quot;</span>,
    <span class="s2">&quot;picture&quot;</span>: <span class="s2">&quot;http://placehold.it/32x32&quot;</span>,
    <span class="s2">&quot;registered&quot;</span>: <span class="s2">&quot;2017-02-06T06:42:20-08:00&quot;</span>,
    <span class="s2">&quot;tags&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;laborum&quot;</span>,
        <span class="s2">&quot;excepteur&quot;</span>,
        <span class="s2">&quot;veniam&quot;</span>,
        <span class="s2">&quot;reprehenderit&quot;</span>,
        <span class="s2">&quot;voluptate&quot;</span>,
        <span class="s2">&quot;laborum&quot;</span>,
        <span class="s2">&quot;in&quot;</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_04"></span><div class="section" id="python">
<h3>2.4 命令行式执行 Python 代码<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>有时候你只是想验证一小段 Python 代码是否可用时，通常有两种方法</p>
<ol class="arabic simple">
<li><p>输入 python 回车，进入 console 模式，然后敲入代码进行验证</p></li>
<li><p>将你的代码写入 demo.py 脚本中，然后使用 python demo.py 验证</p></li>
</ol>
<p>其实还有一种更简单的方法，比如我要计算一个字符串的md5</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;import hashlib;print(hashlib.md5(&#39;hello&#39;).hexdigest())&quot;</span>
5d41402abc4b2a76b9719d911017c592
</pre></div>
</div>
<p>只要加 -c 参数，就可以输入你的 Python 代码了。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_05"></span><div class="section" id="id1">
<h3>2.5 用调试模式执行脚本<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你使用 pdb 进行脚本的调试时，你可能会先在目标代码处输入
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">pdb;pdb.set_trace()</span></code> 来设置断点。</p>
<p>除此之外，还有一种方法，就是使用 <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">pdb</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m pdb demo.py
&gt; /Users/MING/demo.py<span class="o">(</span><span class="m">1</span><span class="o">)</span>&lt;module&gt;<span class="o">()</span>
-&gt; import sys
<span class="o">(</span>Pdb<span class="o">)</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_06"></span><div class="section" id="http">
<h3>2.6 如何快速搭建 HTTP 服务器<a class="headerlink" href="#http" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>搭建FTP，或者是搭建网络文件系统，这些方法都能够实现Linux的目录共享。但是FTP和网络文件系统的功能都过于强大，因此它们都有一些不够方便的地方。比如你想快速共享Linux系统的某个目录给整个项目团队，还想在一分钟内做到，怎么办？很简单，使用Python中的SimpleHTTPServer。</p>
<p>SimpleHTTPServer是Python
2自带的一个模块，是Python的Web服务器。它在Python
3已经合并到http.server模块中。具体例子如下，如不指定端口，则默认是8000端口。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># python2</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHTTPServer</span> <span class="mi">8888</span>

<span class="c1"># python3</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span> <span class="mi">8888</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20190511165716.png" /></p>
<p>SimpleHTTPServer有一个特性，如果待共享的目录下有index.html，那么index.html文件会被视为默认主页；如果不存在index.html文件，那么就会显示整个目录列表。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_07"></span><div class="section" id="html">
<h3>2.7 快速构建 HTML 帮助文档<a class="headerlink" href="#html" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你不知道一个内置模块如何使用时，会怎么做呢？</p>
<p>百度？Google？</p>
<p>其实完全没必要，这里教你一个离线学习 Python 模块的方法。</p>
<p>是的，你没有听错。</p>
<p>就算没有外网网络也能学习 Python 模块.</p>
<p>你只要在命令行下输入 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">pydoc</span> <span class="pre">-p</span> <span class="pre">xxx</span></code> 命令即可开启一个 HTTP
服务，xxx 为端口，你可以自己指定。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m pydoc -p <span class="m">5200</span>
pydoc server ready at http://localhost:5200/
</pre></div>
</div>
<p>帮助文档的效果如下</p>
<p><img alt="image1" src="http://image.iswbm.com/20200718191249.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_08"></span><div class="section" id="id1">
<h3>2.8 最正确且优雅的装包方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你使用 pip 来安装第三方的模块时，通常会使用这样的命令</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install requests
</pre></div>
</div>
<p>此时如果你的环境中有 Python2 也有 Python
3，那你使用这条命令安装的包是安装 Python2 呢？还是安装到 Python 3 呢？</p>
<p>就算你的环境上没有安装 Python2，那也有可能存在着多个版本的 Python
吧？比如安装了 Python3.8，也安装了
Python3.9，那你安装包时就会很困惑，我到底把包安装在了哪里？</p>
<p>但若你使用这样的命令去安装，就没有了这样的烦恼了</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在 python2 中安装</span>
$ python -m pip install requests

<span class="c1"># 在 python3 中安装</span>
$ python3 -m pip install requests

<span class="c1"># 在 python3.8 中安装</span>
$ python3.8 -m pip install requests

<span class="c1"># 在 python3.9 中安装</span>
$ python3.9 -m pip install requests
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_09"></span><div class="section" id="python-shell">
<h3>2.9 往 Python Shell 中传入参数<a class="headerlink" href="#python-shell" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>往一个 Python 脚本传入参数，是一件非常简单的事情。</p>
<p>比如这样：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py arg1 arg2
</pre></div>
</div>
<p>我在验证一些简单的 Python 代码时，喜欢使用 Python Shell 。</p>
<p>那有没有办法在使用 Python Shell 时，向上面传递参数一样，传入参数呢？</p>
<p>经过我的摸索，终于找到了方法，具体方法如下：</p>
<p><img alt="image1" src="http://image.iswbm.com/20200801195158.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_10"></span><div class="section" id="id1">
<h3>2.10 让脚本报错后立即进入调试模式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你在使用 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">xxx.py</span></code> 这样的方法，执行 Python 脚本时，若因为代码
bug 导致异常未捕获，那整个程序便会终止退出。</p>
<p>这个时候，我们通常会去排查是什么原因导致的程序崩溃。</p>
<p>大家都知道，排查问题的思路，第一步肯定是去查看日志，若这个 bug
隐藏的比较深，只有在特定场景下才会现身，那么还需要开发者，复现这个
bug，方能优化代码。</p>
<p>复现有时候很难，有时候虽然简单，但是要伪造各种数据，相当麻烦。</p>
<p><strong>如果有一种方法能在程序崩溃后，立马进入调试模式该有多好啊？</strong></p>
<p>明哥都这么问了，那肯定是带着解决方案来的。</p>
<p>只要你在执行脚本行，加上 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 参数，即可在脚本执行完毕后进入 Python
Shell 模式，方便你进行调试。</p>
<p>具体演示如下：</p>
<p><img alt="image1" src="http://image.iswbm.com/20200801195950.png" /></p>
<p>需要注意的是：脚本执行完毕，有两种情况：</p>
<ol class="arabic simple">
<li><p>正常退出</p></li>
<li><p>异常退出</p></li>
</ol>
<p>这两种都会进入 Python Shell，如果脚本并无异常，最终也会进入 Python Shell
模式，需要你手动退出</p>
<p><img alt="image2" src="http://image.iswbm.com/20200801201110.png" /></p>
<p>如果希望脚本正确完成时自动推出，可以在脚本最后加上一行<code class="docutils literal notranslate"><span class="pre">__import__(&quot;os&quot;)._exit(0)</span></code></p>
<p><img alt="image3" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_11"></span><div class="section" id="python-shell">
<h3>2.11 极简模式执行 Python Shell<a class="headerlink" href="#python-shell" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在终端输入 Python 就会进入 Python Shell 。</p>
<p>方便是挺方便，就是有点说不出的难受，谁能告诉我，为什么要多出这么大一段无关的内容。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200801202733.png" /></p>
<p>这有点像，你上爱某艺看视频吧，都要先看个 90 秒的广告。</p>
<p>如果你和我一样不喜欢这种 『牛皮癣』，那么可以加个 <code class="docutils literal notranslate"><span class="pre">-q</span></code> 参数，静默进入
Python Shell，就像下面这样子，开启了极简模式，舒服多了。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200801203047.png" /></p>
<p><img alt="image3" src="http://image.iswbm.com/20200512125643.png" /></p>
<p><img alt="image4" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_12"></span><div class="section" id="id1">
<h3>2.12 在执行任意代码前自动念一段平安经<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>最近的“平安经”可谓是引起了不小的风波啊。</p>
<p>作为一个正儿八经的程序员，最害怕的就是自己的代码上线出现各种各样的 BUG。</p>
<p>为此明哥就研究了一下，如何在你执行任意 Python 代码前，让 Python
解释器自动念上一段平安经，保佑代码不出 BUG 。</p>
<p>没想到还真被我研究出来了</p>
<p>做好心理准备了嘛？</p>
<p>我要开始作妖了，噢不，是开始念经了。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200801221705.png" /></p>
<p>感谢佛祖保佑，Everything is ok，No bugs in the code.</p>
<p>你一定很想知道这是如何的吧？</p>
<p>如果你对 Linux 比较熟悉，就会知道，当你在使用 SSH 远程登陆 Linux
服务器的时候？会读取 <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> 文件加载一些环境变量。</p>
<p><code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> 你可以视其为一个 shell 脚本，可以在这里写一些 shell
代码达到你的定制化需求。</p>
<p>而在 Python 中，也有类似 <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code>
的文件，这个文件一般情况下是不存在的。</p>
<p>我们需要新建一个用户环境目录，这个目录比较长，不需要你死记硬背，使用
site 模块的方法就可以获取，然后使用 <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">-p</span></code> 命令创建它。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200801220819.png" /></p>
<p>在这个目录下，新建一个 <code class="docutils literal notranslate"><span class="pre">usercustomize.py</span></code>
文件，注意名字必须是这个，换成其他的可就识别不到啦。</p>
<p>这个 <code class="docutils literal notranslate"><span class="pre">usercustomize.py</span></code> 的内容如下（明哥注：佛祖只保佑几个 Python
的主要应用方向，毕竟咱是 Python 攻城狮嘛…）</p>
<p><img alt="image3" src="http://image.iswbm.com/20200801221413.png" /></p>
<p>这个文件我放在了我的 github 上，你可以点此前往获取。</p>
<p>一切都完成后，无论你是使用 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">xxx.py</span></code> 执行脚本</p>
<p><img alt="image4" src="http://image.iswbm.com/20200801221705.png" /></p>
<p>还是使用 <code class="docutils literal notranslate"><span class="pre">python</span></code> 进入 Python Shell ，都会先念一下平安经保平安。</p>
<p><img alt="image5" src="http://image.iswbm.com/20200801221457.png" /></p>
<p><img alt="image6" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_13"></span><div class="section" id="python-shell">
<h3>2.13 启动 Python Shell 前自动执行某脚本<a class="headerlink" href="#python-shell" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>前一节我们介绍了一种，只要运行解释器就会自动触发执行 Python 脚本的方法。</p>
<p>除此之外，可还有其他方法呢？</p>
<p>当然是有，只不过相对来说，会麻烦一点了。</p>
<p>先来看一下效果，在 <code class="docutils literal notranslate"><span class="pre">~/Library/Python/3.9/lib/python/site-packages</span></code>
目录下并没有 <code class="docutils literal notranslate"><span class="pre">usercustomize.py</span></code> 文件，但是在执行 python 进入 Python
Shell 模式后，还是会打印平安经。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200801225652.png" /></p>
<p>这是如何做到的呢？</p>
<p>很简单，只要做两件事</p>
<p>第一件事，在任意你喜欢的目录下，新建 一个Python
脚本，名字也随意，比如我叫 <code class="docutils literal notranslate"><span class="pre">startup.py</span></code>，内容还是和上面一样</p>
<p><img alt="image2" src="http://image.iswbm.com/20200801221413.png" /></p>
<p>第二件事，设置一个环境变量 PYTHONSTARTUP，指向你的脚本路径</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">PYTHONSTARTUP</span><span class="o">=</span>/Users/MING/startup.py
</pre></div>
</div>
<p>这样就可以了。</p>
<p>但是这种方法只适用于 Python Shell ，只不适合 Python 执行脚本的方法。</p>
<p><img alt="image3" src="http://image.iswbm.com/20200801230230.png" /></p>
<p>如果要在脚本中实现这种效果，我目前想到最粗糙我笨拙的方法了 –
<code class="docutils literal notranslate"><span class="pre">手动加载执行</span></code></p>
<p><img alt="image4" src="http://image.iswbm.com/20200801230503.png" /></p>
<p><img alt="image5" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c02/c02_14"></span><div class="section" id="id1">
<h3>2.14 把模块当做脚本来执行 7 种方法及原理<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>1. 用法举例<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>前面的文章里其实分享过不少类似的用法。比如：</p>
<p>1、 快速搭建一个 HTTP 服务</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># python2</span>
$ python -m SimpleHTTPServer <span class="m">8888</span>

<span class="c1"># python3</span>
$ python3 -m http.server <span class="m">8888</span>
</pre></div>
</div>
<p>2、快速构建 HTML 帮助文档</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m pydoc -p <span class="m">5200</span>
</pre></div>
</div>
<p>3、快速进入 pdb 调试模式</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m pdb demo.py
</pre></div>
</div>
<p>4、最优雅且正确的包安装方法</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install requests
</pre></div>
</div>
<p>5、快速美化 JSON 字符串</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;{&quot;name&quot;: &quot;MING&quot;}&#39;</span> <span class="p">|</span> python -m json.tool
</pre></div>
</div>
<p>6、快速打印包的搜索路径</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m site
</pre></div>
</div>
<p>7、用于快速计算程序执行时长</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m timeit <span class="s1">&#39;&quot;-&quot;.join(map(str, range(100)))&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>2. 原理剖析<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>上面的诸多命令，都有一个特点，在命令中都含有 <code class="docutils literal notranslate"><span class="pre">-m</span></code>
参数选项，而参数的值，SimpleHTTPServer， http.server， pydoc，pdb，pip，
json.tool，site ，timeit这些都是模块或者包。</p>
<p>通常来说模块或者包，都是用做工具包由其他模块导入使用，而很少直接使用命令来执行（脚本除外）。</p>
<p>Python
给我们提供了一种方法，可以让我们将模块里的部分功能抽取出来，直接用于命令行式的调用。效果就是前面你所看到的。</p>
<p>那这是如何实现的呢？</p>
<p>最好的学习方式，莫过于模仿，直接以 pip 和 json
模块为学习对象，看看目录结构和代码都有什么特点。</p>
<p>先看一下 <code class="docutils literal notranslate"><span class="pre">pip</span></code> 的源码目录，发现在其下有一个 <code class="docutils literal notranslate"><span class="pre">__main__.py</span></code>
的文件，难道这是 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 的入口？</p>
<p><img alt="image1" src="http://image.iswbm.com/20200811155234.png" /></p>
<p>再看一下 <code class="docutils literal notranslate"><span class="pre">json.tool</span></code> 的源码文件，json 库下面却没有 <code class="docutils literal notranslate"><span class="pre">__main__.py</span></code>
的文件。</p>
<p>这就很奇怪了。</p>
<p>不对，再回过头看，我们调用的不是 json 库，而是 json 库下的 tool 模块。</p>
<p>查看 tool 模块的源代码，有一个名为 main 的函数</p>
<p><img alt="image2" src="http://image.iswbm.com/20200811154945.png" /></p>
<p>但它这不是关键，main 函数是在模块中直接被调用的。</p>
<p>只有当 <code class="docutils literal notranslate"><span class="pre">__name__</span></code> 为 <code class="docutils literal notranslate"><span class="pre">__main___</span></code> 时，main 函数才会被调用</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>当模块被导入时，<code class="docutils literal notranslate"><span class="pre">__name__</span></code> 的值为模块名，</p>
<p>而当模块被直接执行，<code class="docutils literal notranslate"><span class="pre">__name__</span></code> 的值就变成了 <code class="docutils literal notranslate"><span class="pre">__main__</span></code>。</p>
<p>这下思路清晰了。</p>
<p>想要使用 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 的方式执行模块，有两种方式：</p>
<ul class="simple">
<li><p>第一种：以 <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;package&gt;</span></code> 的方式执行，只要在 package 下写一个
<code class="docutils literal notranslate"><span class="pre">__main__.py</span></code> 的文件即可。</p></li>
<li><p>第二种：以 <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;package.module&gt;</span></code> 的方式执行，只要在 module
的代码中，定义一个 main 函数，然后在最外层写入下面这段固定的代码</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>上面我将 <code class="docutils literal notranslate"><span class="pre">-m</span></code>
的使用情况分为两种，但是实际上，只有一种，对于第一种，你完全可以将
<code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;package&gt;</span></code> 理解为 <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;package.__main__&gt;</span></code> 的简写形式。</p>
</div>
<div class="section" id="id4">
<h4>3. 实践一下<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>先把当前路径设置追加到 PATH 的环境变量中</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>:<span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
</pre></div>
</div>
<p>先来验证一下第一种方法。</p>
<p>然后在当前目录下新建一个<code class="docutils literal notranslate"><span class="pre">demo</span></code> 文件夹，并且在 demo 目录下新建一个
<code class="docutils literal notranslate"><span class="pre">__main__.py</span></code> 的文件，随便打印点东西</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># __main__.py</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>然后直接执行如下命令，立马就能看到效果。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m demo
hello,world
</pre></div>
</div>
<p>执行过程如下：</p>
<p><img alt="image3" src="http://image.iswbm.com/20200811184733.png" /></p>
<p>再来验证一下使用第二种方法。</p>
<p>在 demo 目录下再新建一个 foobar.py 文件</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foobar.py</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, world&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>最后执行一下如下命令，输出与预期相符</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m demo.foobar
hello, foobar
</pre></div>
</div>
</div>
<div class="section" id="m">
<h4>4. -m 存在的意义<a class="headerlink" href="#m" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">-m</span></code> 实现的效果，无异于直接执行一个 Python 模块/脚本。</p>
<p>那么问题就来了，那我直接执行不就行啦，何必多此一举再加个 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 呢？</p>
<p>这个问题很有意思，值得一提。</p>
<p>当我们使用一个模块的时候，往往只需要记住模块名，然后使用 import
去导入它就行了。</p>
<p>之所以能这么便利，这得益于 Python
完善的导入机制，你完全不需要知道这个模块文件存在哪个目录下，它的绝对路径是什么？因为
Python 的包导入机制会帮你做这些事情。</p>
<p>换句话说，如果你不使用 <code class="docutils literal notranslate"><span class="pre">-m</span></code> 的方式，当你要使用
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">json.tool</span></code>，你就得这样子写</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;{&quot;name&quot;: &quot;MING&quot;}&#39;</span> <span class="p">|</span> python /usr/lib64/python2.7/json/tool.py
<span class="o">{</span>
    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;MING&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>如此一对比，哪个更方便？你心里应该有数了。</p>
<p><img alt="image4" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p03"></span><div class="section" id="id1">
<h2>第三章：炫技魔法操作<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节是取自我个人公众号原创专辑《Python炫技操作》里的文章，其中的多篇文章成为了爆款文章，不少大号均有转载。很多网友看完后直呼 &quot;卧槽，居然还能这样？！&quot;，如果你之前没有看过这几篇文章，那么你读这一章一定会大有收获。</p>
<p>本章节，会持续更新，敬请关注…</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c03/c03_01"></span><div class="section" id="id1">
<h3>3.1 八种连接列表的方式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>1、最直观的相加<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">+</span></code> 对多个列表进行相加，你应该懂，不多说了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">+</span> <span class="n">list02</span> <span class="o">+</span> <span class="n">list03</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="itertools">
<h4>2、借助 itertools<a class="headerlink" href="#itertools" title="永久链接至标题">¶</a></h4>
<p>itertools 在 Python
里有一个非常强大的内置模块，它专门用于操作可迭代对象。</p>
<p>在前面的文章中也介绍过，使用 <code class="docutils literal notranslate"><span class="pre">itertools.chain()</span></code>
函数先可迭代对象（在这里指的是列表）串联起来，组成一个更大的可迭代对象。</p>
<p>最后你再利用 list 将其转化为 列表。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">))</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>3、使用 * 解包<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">*</span></code> 可以解包列表，解包后再合并。</p>
<p>示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="o">*</span><span class="n">list01</span><span class="p">,</span> <span class="o">*</span><span class="n">list02</span><span class="p">]</span>
<span class="go">[1, 2, 3, 4, 5, 6]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="extend">
<h4>4、使用 extend<a class="headerlink" href="#extend" title="永久链接至标题">¶</a></h4>
<p>在字典中，使用 update 可实现原地更新，而在列表中，使用 extend
可实现列表的自我扩展。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list02</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span>
<span class="go">[1, 2, 3, 4, 5, 6]</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>5、使用列表推导式<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>Python 里对于生成列表、集合、字典，有一套非常 Pythonnic 的写法。</p>
<p>那就是列表解析式，集合解析式和字典解析式，通常是 Python
发烧友的最爱，那么今天的主题：列表合并，列表推导式还能否胜任呢？</p>
<p>当然可以，具体示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="heapq">
<h4>6、使用 heapq<a class="headerlink" href="#heapq" title="永久链接至标题">¶</a></h4>
<p>heapq 是 Python 的一个标准模块，它提供了堆排序算法的实现。</p>
<p>该模块里有一个 merge 方法，可以用于合并多个列表，如下所示</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">heapq</span> <span class="kn">import</span> <span class="n">merge</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">))</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>要注意的是，heapq.merge
除了合并多个列表外，它还会将合并后的最终的列表进行排序。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">heapq</span> <span class="kn">import</span> <span class="n">merge</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">))</span>
<span class="go">[1, 2, 4, 5, 3, 6, 7, 9, 8]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>它的效果等价于下面这行代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">sorted</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">))</span>
</pre></div>
</div>
<p>如果你希望得到一个始终有序的列表，那请第一时间想到
heapq.merge，因为它采用堆排序，效率非常高。但若你不希望得到一个排过序的列表，就不要使用它了。</p>
</div>
<div class="section" id="id5">
<h4>7、借助魔法方法<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>有一个魔法方法叫 <code class="docutils literal notranslate"><span class="pre">__add__</span></code>，当我们使用第一种方法 list01 + list02
的时候，内部实际上是作用在 <code class="docutils literal notranslate"><span class="pre">__add__</span></code> 这个魔法方法上的。</p>
<p>所以以下两种方法其实是等价的</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">+</span> <span class="n">list02</span>
<span class="go">[1, 2, 3, 4, 5, 6]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">list02</span><span class="p">)</span>
<span class="go">[1, 2, 3, 4, 5, 6]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>借用这个魔法特性，我们可以 reduce
这个方法来对多个列表进行合并，示例代码如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">reduce</span><span class="p">(</span><span class="nb">list</span><span class="o">.</span><span class="fm">__add__</span><span class="p">,</span> <span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">))</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="yield-from">
<h4>8. 使用 yield from<a class="headerlink" href="#yield-from" title="永久链接至标题">¶</a></h4>
<p>在 yield from 后可接一个可迭代对象，用于迭代并返回其中的每一个元素。</p>
<p>因此，我们可以像下面这样自定义一个合并列表的工具函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">list01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list02</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">list03</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="o">*</span><span class="n">lists</span><span class="p">):</span>
<span class="gp">... </span>  <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">yield from</span> <span class="n">l</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">list01</span><span class="p">,</span> <span class="n">list02</span><span class="p">,</span> <span class="n">list03</span><span class="p">))</span>
<span class="go">[1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
<span class="go">&gt;&gt;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_02"></span><div class="section" id="id1">
<h3>3.2 合并字典的 8 种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>1、最简单的原地更新<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>字典对象内置了一个 update 方法，用于把另一个字典更新到自己身上。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ext_info</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p>如果想使用 update
这种最简单、最地道原生的方法，但又不想更新到自己身上，而是生成一个新的对象，那请使用深拷贝。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ext_info</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">full_profile</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="go">{&quot;name&quot;: &quot;xiaoming&quot;, &quot;age&quot;: 27}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>2、先解包再合并字典<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">**</span></code> 可以解包字典，解包完后再使用 dict 或者 <code class="docutils literal notranslate"><span class="pre">{}</span></code> 就可以合并。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile01</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">profile</span><span class="p">,</span> <span class="o">**</span><span class="n">ext_info</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">full_profile01</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile02</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">profile</span><span class="p">,</span> <span class="o">**</span><span class="n">ext_info</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">full_profile02</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p>若你不知道 <code class="docutils literal notranslate"><span class="pre">dict(**profile,</span> <span class="pre">**ext_info)</span></code> 做了啥，你可以将它等价于</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(((</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;gender&quot;</span><span class="p">,</span> <span class="s2">&quot;male&quot;</span><span class="p">)))</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="itertools">
<h4>3、借助 itertools<a class="headerlink" href="#itertools" title="永久链接至标题">¶</a></h4>
<p>在 Python 里有一个非常强大的内置模块，它专门用于操作可迭代对象。</p>
<p>正好我们字典也是可迭代对象，自然就可以想到，可以使用
<code class="docutils literal notranslate"><span class="pre">itertools.chain()</span></code>
函数先将多个字典（可迭代对象）串联起来，组成一个更大的可迭代对象，然后再使用
dict 转成字典。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">ext_info</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="chainmap">
<h4>4、借助 ChainMap<a class="headerlink" href="#chainmap" title="永久链接至标题">¶</a></h4>
<p>如果可以引入一个辅助包，那我就再提一个， <code class="docutils literal notranslate"><span class="pre">ChainMap</span></code> 也可以达到和
<code class="docutils literal notranslate"><span class="pre">itertools</span></code> 同样的效果。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">ext_info</span><span class="p">))</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p>使用 ChainMap
有一点需要注意，当字典间有重复的键时，只会取第一个值，排在后面的键值并不会更新掉前面的（使用
itertools 就不会有这个问题）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">ext_info</span><span class="p">))</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27}</span>
</pre></div>
</div>
</div>
<div class="section" id="dict-items">
<h4>5、使用dict.items() 合并<a class="headerlink" href="#dict-items" title="永久链接至标题">¶</a></h4>
<p>在 Python 3.9 之前，其实就已经有 <code class="docutils literal notranslate"><span class="pre">|</span></code>
操作符了，只不过它通常用于对集合（set）取并集。</p>
<p>利用这一点，也可以将它用于字典的合并，只不过得绕个弯子，有点不好理解。</p>
<p>你得先利用 <code class="docutils literal notranslate"><span class="pre">items</span></code> 方法将 dict 转成 dict_items，再对这两个 dict_items
取并集，最后利用 dict 函数，转成字典。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">|</span> <span class="n">ext_info</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_profile</span>
<span class="go">{&#39;gender&#39;: &#39;male&#39;, &#39;age&#39;: 27, &#39;name&#39;: &#39;xiaoming&#39;}</span>
</pre></div>
</div>
<p>当然了，你如果嫌这样太麻烦，也可以简单点，直接使用 list
函数再合并（示例为 Python 3.x ）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ext_info</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p>若你在 Python 2.x 下，可以直接省去 list 函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">ext_info</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>6、最酷炫的字典解析式<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>Python 里对于生成列表、集合、字典，有一套非常 Pythonnic 的写法。</p>
<p>那就是列表解析式，集合解析式和字典解析式，通常是 Python
发烧友的最爱，那么今天的主题：字典合并，字典解析式还能否胜任呢？</p>
<p>当然可以，具体示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">profile</span><span class="p">,</span> <span class="n">ext_info</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="python-3-9">
<h4>7、Python 3.9 新特性<a class="headerlink" href="#python-3-9" title="永久链接至标题">¶</a></h4>
<p>在 2 月份发布的 Python 3.9.04a
版本中，新增了一个抓眼球的新操作符操作符： <code class="docutils literal notranslate"><span class="pre">|</span></code>， PEP584
将它称之为合并操作符（Union Operator），用它可以很直观地合并多个字典。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">27</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;male&quot;</span><span class="p">}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">|</span> <span class="n">ext_info</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">|</span> <span class="n">profile</span>
<span class="go">{&#39;gender&#39;: &#39;male&#39;, &#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>除了 <code class="docutils literal notranslate"><span class="pre">|</span></code> 操作符之外，还有另外一个操作符 <code class="docutils literal notranslate"><span class="pre">|=</span></code>，类似于原地更新。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span> <span class="o">|=</span> <span class="n">profile</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ext_info</span>
<span class="go">{&#39;gender&#39;: &#39;male&#39;, &#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27}</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">|=</span> <span class="n">ext_info</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">{&#39;name&#39;: &#39;xiaoming&#39;, &#39;age&#39;: 27, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p>看到这里，有没有涨姿势了，学了这么久的 Python
，没想到合并字典还有这么多的方法。本篇文章的主旨，并不在于让你全部掌握这
7
种合并字典的方法，实际在工作中，你只要选用一种最顺手的方式即可，但是在协同工作中，或者在阅读他人代码时，你不可避免地会碰到各式各样的写法，这时候你能下意识的知道这是在做合并字典的操作，那这篇文章就是有意义的。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_03"></span><div class="section" id="id1">
<h3>3.3 花式导包的八种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="import">
<h4>1. 直接 import<a class="headerlink" href="#import" title="永久链接至标题">¶</a></h4>
<p>人尽皆知的方法，直接导入即可</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
<p>与此类似的还有，不再细讲</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="o">...</span>
<span class="kn">import</span> <span class="o">...</span> <span class="k">as</span> <span class="o">...</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="o">...</span>
<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="o">...</span> <span class="k">as</span> <span class="o">...</span>
</pre></div>
</div>
<p>一般情况下，使用 <code class="docutils literal notranslate"><span class="pre">import</span></code> 语句导入模块已经够用的。</p>
<p>但是在一些特殊场景中，可能还需要其他的导入方式。</p>
<p>下面我会一一地给你介绍。</p>
</div>
<div class="section" id="id2">
<h4>2. 使用 __import__<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">__import__</span></code> 函数可用于导入模块，import 语句也会调用函数。其定义为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">[,</span> <span class="nb">globals</span><span class="p">[,</span> <span class="nb">locals</span><span class="p">[,</span> <span class="n">fromlist</span><span class="p">[,</span> <span class="n">level</span><span class="p">]]]])</span>
</pre></div>
</div>
<p>参数介绍：</p>
<ul class="simple">
<li><p>name (required): 被加载 module 的名称</p></li>
<li><p>globals (optional): 包含全局变量的字典，该选项很少使用，采用默认值
global()</p></li>
<li><p>locals (optional):
包含局部变量的字典，内部标准实现未用到该变量，采用默认值 - local()</p></li>
<li><p>fromlist (Optional): 被导入的 submodule 名称</p></li>
<li><p>level (Optional): 导入路径选项，Python 2 中默认为 -1，表示同时支持
absolute import 和 relative import。Python 3 中默认为 0，表示仅支持
absolute import。如果大于 0，则表示相对导入的父目录的级数，即 1
类似于 ‘.’，2 类似于 ‘..’。</p></li>
</ul>
<p>使用示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">os</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
<p>如果要实现 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">xx</span> <span class="pre">as</span> <span class="pre">yy</span></code> 的效果，只要修改左值即可</p>
<p>如下示例，等价于 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">os</span> <span class="pre">as</span> <span class="pre">myos</span></code>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
<p>上面说过的 <code class="docutils literal notranslate"><span class="pre">__import__</span></code>
是一个内建函数，既然是内建函数的话，那么这个内建函数必将存在于
<code class="docutils literal notranslate"><span class="pre">__buildins__</span></code> 中，因此我们还可以这样导入 os 的模块：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">__builtins__</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="importlib">
<h4>3. 使用 importlib 模块<a class="headerlink" href="#importlib" title="永久链接至标题">¶</a></h4>
<p>importlib 是 Python 中的一个标准库，importlib 能提供的功能非常全面。</p>
<p>它的简单示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">=</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;os&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
<p>如果要实现 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">xx</span> <span class="pre">as</span> <span class="pre">yy</span></code>效果，可以这样</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;os&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="imp">
<h4>4. 使用 imp 模块<a class="headerlink" href="#imp" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">imp</span></code> 模块提供了一些 import
语句内部实现的接口。例如模块查找（find_module）、模块加载（load_module）等等（模块的导入过程会包含模块查找、加载、缓存等步骤）。可以用该模块来简单实现内建的
<code class="docutils literal notranslate"><span class="pre">__import__</span></code> 函数功能：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">imp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">file</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="s1">&#39;sep&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span>
<span class="go">&lt;module &#39;sep&#39; from &#39;/usr/lib64/python2.7/os.pyc&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">myos</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
<p>从 python 3 开始，内建的 reload 函数被移到了 imp 模块中。而从 Python 3.4
开始，imp 模块被否决，不再建议使用，其包含的功能被移到了 importlib
模块下。即从 Python 3.4 开始，importlib 模块是之前 imp 模块和 importlib
模块的合集。</p>
</div>
<div class="section" id="execfile">
<h4>5. 使用 execfile<a class="headerlink" href="#execfile" title="永久链接至标题">¶</a></h4>
<p>在 Python 2 中有一个 execfile 函数，利用它可以用来执行一个文件。</p>
<p>语法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">execfile</span><span class="p">(</span><span class="n">filename</span><span class="p">[,</span> <span class="nb">globals</span><span class="p">[,</span> <span class="nb">locals</span><span class="p">]])</span>
</pre></div>
</div>
<p>参数有这么几个：</p>
<ul class="simple">
<li><p>filename：文件名。</p></li>
<li><p>globals：变量作用域，全局命名空间，如果被提供，则必须是一个字典对象。</p></li>
<li><p>locals：变量作用域，局部命名空间，如果被提供，可以是任何映射对象。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">execfile</span><span class="p">(</span><span class="s2">&quot;/usr/lib64/python2.7/os.py&quot;</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="exec">
<h4>6. 使用 exec 执行<a class="headerlink" href="#exec" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">execfile</span></code> 只能在 Python2 中使用，Python 3.x 里已经删除了这个函数。</p>
<p>但是原理值得借鉴，你可以使用 open … read 读取文件内容，然后再用 exec
去执行模块。</p>
<p>示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/usr/lib64/python2.7/os.py&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">exec</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">getcwd</span><span class="p">()</span>
<span class="go">&#39;/home/wangbm&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="import-from-github-com">
<h4>7. import_from_github_com<a class="headerlink" href="#import-from-github-com" title="永久链接至标题">¶</a></h4>
<p>有一个包叫做
<strong>import_from_github_com</strong>，从名字上很容易得知，它是一个可以从 github
下载安装并导入的包。为了使用它，你需要做的就是按照如下命令使用pip
先安装它。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install import_from_github_com
</pre></div>
</div>
<p>这个包使用了PEP
302中新的引入钩子，允许你可以从github上引入包。这个包实际做的就是安装这个包并将它添加到本地。你需要
Python 3.2 或者更高的版本，并且 git 和 pip 都已经安装才能使用这个包。</p>
<p>pip 要保证是较新版本，如果不是请执行如下命令进行升级。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install --upgrade pip
</pre></div>
</div>
<p>确保环境 ok 后，你就可以在 Python shell 中使用 import_from_github_com</p>
<p>示例如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">github_com.zzzeek</span> <span class="kn">import</span> <span class="n">sqlalchemy</span>
<span class="go">Collecting git+https://github.com/zzzeek/sqlalchemy</span>
<span class="go">Cloning https://github.com/zzzeek/sqlalchemy to /tmp/pip-acfv7t06-build</span>
<span class="go">Installing collected packages: SQLAlchemy</span>
<span class="go">Running setup.py install for SQLAlchemy ... done</span>
<span class="go">Successfully installed SQLAlchemy-1.1.0b1.dev0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">locals</span><span class="p">()</span>
<span class="go">{&#39;__builtins__&#39;: &lt;module &#39;builtins&#39; (built-in)&gt;, &#39;__spec__&#39;: None,</span>
<span class="go">&#39;__package__&#39;: None, &#39;__doc__&#39;: None, &#39;__name__&#39;: &#39;__main__&#39;,</span>
<span class="go">&#39;sqlalchemy&#39;: &lt;module &#39;sqlalchemy&#39; from &#39;/usr/local/lib/python3.5/site-packages/\</span>
<span class="go">sqlalchemy/__init__.py&#39;&gt;,</span>
<span class="go">&#39;__loader__&#39;: &lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;}</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>看了
import_from_github_com的源码后，你会注意到它并没有使用importlib。实际上，它的原理就是使用
pip
来安装那些没有安装的包，然后使用Python的<code class="docutils literal notranslate"><span class="pre">__import__()</span></code>函数来引入新安装的模块。</p>
</div>
<div class="section" id="id3">
<h4>8、远程导入模块<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>我在这篇文章里（<a class="reference external" href="http://mp.weixin.qq.com/s?__biz=MzIzMzMzOTI3Nw==&amp;mid=2247484838&amp;idx=1&amp;sn=1e6fbf5d7546902c6965c60383f7b639&amp;chksm=e8866544dff1ec52e01b6c9a982dfa150b8e34ad472acca35201373dc51dadb5a8630870982a&amp;scene=21#wechat_redirect">深入探讨 Python 的 import
机制：实现远程导入模块</a>），深入剖析了导入模块的内部原理，并在最后手动实现了从远程服务器上读取模块内容，并在本地成功将模块导入的导入器。</p>
<p>具体内容非常的多，你可以点击这个<a class="reference external" href="http://mp.weixin.qq.com/s?__biz=MzIzMzMzOTI3Nw==&amp;mid=2247484838&amp;idx=1&amp;sn=1e6fbf5d7546902c6965c60383f7b639&amp;chksm=e8866544dff1ec52e01b6c9a982dfa150b8e34ad472acca35201373dc51dadb5a8630870982a&amp;scene=21#wechat_redirect">链接</a>进行深入学习。</p>
<p>示例代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 新建一个 py 文件（my_importer.py），内容如下</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">urllib.request</span> <span class="kn">as</span> <span class="nn">urllib2</span>

<span class="k">class</span> <span class="nc">UrlMetaFinder</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MetaPathFinder</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_baseurl</span> <span class="o">=</span> <span class="n">baseurl</span>


    <span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">baseurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseurl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 不是原定义的url就直接返回不存在</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseurl</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">baseurl</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="n">UrlMetaLoader</span><span class="p">(</span><span class="n">baseurl</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">loader</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">UrlMetaLoader</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">SourceLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseurl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="o">=</span> <span class="n">baseurl</span>

    <span class="k">def</span> <span class="nf">get_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">fullname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullname</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseurl</span> <span class="o">+</span> <span class="n">fullname</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>

<span class="k">def</span> <span class="nf">install_meta</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="n">finder</span> <span class="o">=</span> <span class="n">UrlMetaFinder</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">meta_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">finder</span><span class="p">)</span>
</pre></div>
</div>
<p>并且在远程服务器上开启 http
服务（为了方便，我仅在本地进行演示），并且手动编辑一个名为 my_info 的
python 文件，如果后面导入成功会打印 <code class="docutils literal notranslate"><span class="pre">ok</span></code>。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ mkdir httpserver <span class="o">&amp;&amp;</span> <span class="nb">cd</span> httpserver
$ cat&gt;my_info.py&lt;EOF
<span class="nv">name</span><span class="o">=</span><span class="s1">&#39;wangbm&#39;</span>
print<span class="o">(</span><span class="s1">&#39;ok&#39;</span><span class="o">)</span>
EOF
$ cat my_info.py
<span class="nv">name</span><span class="o">=</span><span class="s1">&#39;wangbm&#39;</span>
print<span class="o">(</span><span class="s1">&#39;ok&#39;</span><span class="o">)</span>
$
$ python3 -m http.server <span class="m">12800</span>
Serving HTTP on <span class="m">0</span>.0.0.0 port <span class="m">12800</span> <span class="o">(</span>http://0.0.0.0:12800/<span class="o">)</span> ...
...
</pre></div>
</div>
<p>一切准备好，验证开始。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">my_importer</span> <span class="kn">import</span> <span class="n">install_meta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">install_meta</span><span class="p">(</span><span class="s1">&#39;http://localhost:12800/&#39;</span><span class="p">)</span> <span class="c1"># 往 sys.meta_path 注册 finder</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">my_info</span>  <span class="c1"># 打印ok，说明导入成功</span>
<span class="go">ok</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_info</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># 验证可以取得到变量</span>
<span class="go">&#39;wangbm&#39;</span>
</pre></div>
</div>
<p>好了，8 种方法都给大家介绍完毕，对于普通开发者来说，其实只要掌握 import
这种方法足够了，而对于那些想要自己开发框架的人来说，深入学习<code class="docutils literal notranslate"><span class="pre">__import__</span></code>以及
importlib 是非常有必要的。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_04"></span><div class="section" id="id1">
<h3>3.4 条件语句的七种写法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>第一种：原代码<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>这是一段非常简单的通过年龄判断一个人是否成年的代码，由于代码行数过多，有些人就不太愿意这样写，因为这体现不出自己多年的
Python 功力。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;已成年&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;未成年&quot;</span>
</pre></div>
</div>
<p>下面我列举了六种这段代码的变异写法，一个比一个还 6
，单独拿出来比较好理解，放在工程代码里，没用过这些学法的人，一定会看得一脸懵逼，理解了之后，又不经意大呼：<strong>卧槽，还可以这样写？</strong>，而后就要开始骂街了：<strong>这是给人看的代码？</strong>
（除了第一种之外）</p>
</div>
<div class="section" id="id3">
<h4>第二种<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>语法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span> <span class="k">if</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="k">else</span> <span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">age1</span> <span class="o">=</span> <span class="mi">20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age2</span> <span class="o">=</span> <span class="mi">17</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="s2">&quot;已成年&quot;</span> <span class="k">if</span> <span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="k">else</span> <span class="s2">&quot;未成年&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">msg1</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="s2">&quot;已成年&quot;</span> <span class="k">if</span> <span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="k">else</span> <span class="s2">&quot;未成年&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">msg2</span>
<span class="go">未成年</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>第三种<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>语法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="ow">and</span> <span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span> <span class="ow">or</span> <span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="ow">and</span> <span class="s2">&quot;已成年&quot;</span> <span class="ow">or</span> <span class="s2">&quot;未成年&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="s2">&quot;已成年&quot;</span> <span class="k">if</span> <span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span> <span class="k">else</span> <span class="s2">&quot;未成年&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="go">未成年</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>第四种<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>语法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span><span class="p">)[</span><span class="n">condition</span><span class="p">]</span>
</pre></div>
</div>
<p>例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;未成年&quot;</span><span class="p">,</span> <span class="s2">&quot;已成年&quot;</span><span class="p">)[</span><span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;未成年&quot;</span><span class="p">,</span> <span class="s2">&quot;已成年&quot;</span><span class="p">)[</span><span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="go">未成年</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>第五种<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>语法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span><span class="p">)[</span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">]()</span>
</pre></div>
</div>
<p>例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="s2">&quot;未成年&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="s2">&quot;已成年&quot;</span><span class="p">)[</span><span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="s2">&quot;未成年&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span><span class="s2">&quot;已成年&quot;</span><span class="p">)[</span><span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="go">未成年</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4>第六种<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>语法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="bp">True</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span><span class="p">}[</span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="p">{</span><span class="bp">True</span><span class="p">:</span> <span class="s2">&quot;已成年&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="s2">&quot;未成年&quot;</span><span class="p">}[</span><span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="p">{</span><span class="bp">True</span><span class="p">:</span> <span class="s2">&quot;已成年&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="s2">&quot;未成年&quot;</span><span class="p">}[</span><span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="go">未成年</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>第七种<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p>语法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">on_true</span><span class="o">&gt;</span><span class="p">,)</span> <span class="ow">or</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">on_false</span><span class="o">&gt;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg1</span> <span class="o">=</span> <span class="p">((</span><span class="n">age1</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;已成年&quot;</span><span class="p">,)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;未成年&quot;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg1</span><span class="p">)</span>
<span class="go">已成年</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg2</span> <span class="o">=</span> <span class="p">((</span><span class="n">age2</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;已成年&quot;</span><span class="p">,)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;未成年&quot;</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
<span class="go">未成年</span>
</pre></div>
</div>
<p>以上代码，都比较简单，仔细看都能看懂，我就不做解释了。</p>
<p>看到这里，有没有涨姿势了，学了这么久的 Python
，这么多骚操作，还真是活久见。。这六种写法里，我最推荐使用的是第一种，自己也经常在用，简洁直白，代码行还少。而其他的写法虽然能写，但是不会用，也不希望在我余生里碰到会在公共代码里用这些写法的同事。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_05"></span><div class="section" id="id1">
<h3>3.5 判断是否包含子串的七种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="in-not-in">
<h4>1、使用 in 和 not in<a class="headerlink" href="#in-not-in" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">in</span></code> 和 <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">in</span></code> 在 Python 中是很常用的关键字，我们将它们归类为
<code class="docutils literal notranslate"><span class="pre">成员运算符</span></code>。</p>
<p>使用这两个成员运算符，可以很让我们很直观清晰的判断一个对象是否在另一个对象中，示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;llo&quot;</span> <span class="ow">in</span> <span class="s2">&quot;hello, python&quot;</span>
<span class="go">True</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;lol&quot;</span> <span class="ow">in</span> <span class="s2">&quot;hello, python&quot;</span>
<span class="go">False</span>
</pre></div>
</div>
</div>
<div class="section" id="find">
<h4>2、使用 find 方法<a class="headerlink" href="#find" title="永久链接至标题">¶</a></h4>
<p>使用 字符串 对象的 find
方法，如果有找到子串，就可以返回指定子串在字符串中的出现位置，如果没有找到，就返回
<code class="docutils literal notranslate"><span class="pre">-1</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;hello, python&quot;</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;llo&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;hello, python&quot;</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;lol&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
<span class="go">False</span>
<span class="go">&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="index">
<h4>3、使用 index 方法<a class="headerlink" href="#index" title="永久链接至标题">¶</a></h4>
<p>字符串对象有一个 index
方法，可以返回指定子串在该字符串中第一次出现的索引，如果没有找到会抛出异常，因此使用时需要注意捕获。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_in</span><span class="p">(</span><span class="n">full_str</span><span class="p">,</span> <span class="n">sub_str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">full_str</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sub_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;llo&quot;</span><span class="p">))</span>  <span class="c1"># True</span>
<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;lol&quot;</span><span class="p">))</span>  <span class="c1"># False</span>
</pre></div>
</div>
</div>
<div class="section" id="count">
<h4>4、使用 count 方法<a class="headerlink" href="#count" title="永久链接至标题">¶</a></h4>
<p>利用和 index 这种曲线救国的思路，同样我们可以使用 count 的方法来判断。</p>
<p>只要判断结果大于 0 就说明子串存在于字符串中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_in</span><span class="p">(</span><span class="n">full_str</span><span class="p">,</span> <span class="n">sub_str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">full_str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">sub_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;llo&quot;</span><span class="p">))</span>  <span class="c1"># True</span>
<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;lol&quot;</span><span class="p">))</span>  <span class="c1"># False</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>5、通过魔法方法<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>在第一种方法中，我们使用 in 和 not in
判断一个子串是否存在于另一个字符中，实际上当你使用 in 和 not in
时，Python 解释器会先去检查该对象是否有 <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> 魔法方法。</p>
<p>若有就执行它，若没有，Python
就自动会迭代整个序列，只要找到了需要的一项就返回 True 。</p>
<p>示例如下；</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;hello, python&quot;</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;llo&quot;</span><span class="p">)</span>
<span class="go">True</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;hello, python&quot;</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;lol&quot;</span><span class="p">)</span>
<span class="go">False</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>这个用法与使用 in 和 not in
没有区别，但不排除有人会特意写成这样来增加代码的理解难度。</p>
</div>
<div class="section" id="operator">
<h4>6、借助 operator<a class="headerlink" href="#operator" title="永久链接至标题">¶</a></h4>
<p>operator模块是python中内置的操作符函数接口，它定义了一些算术和比较内置操作的函数。operator模块是用c实现的，所以执行速度比
python 代码快。</p>
<p>在 operator 中有一个方法 <code class="docutils literal notranslate"><span class="pre">contains</span></code>
可以很方便地判断子串是否在字符串中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">operator</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">operator</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;llo&quot;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">operator</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;lol&quot;</span><span class="p">)</span>
<span class="go">False</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>7、使用正则匹配<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>说到查找功能，那正则绝对可以说是专业的工具，多复杂的查找规则，都能满足你。</p>
<p>对于判断字符串是否存在于另一个字符串中的这个需求，使用正则简直就是大材小用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">is_in</span><span class="p">(</span><span class="n">full_str</span><span class="p">,</span> <span class="n">sub_str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">sub_str</span><span class="p">,</span> <span class="n">full_str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;llo&quot;</span><span class="p">))</span>  <span class="c1"># True</span>
<span class="k">print</span><span class="p">(</span><span class="n">is_in</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">,</span> <span class="s2">&quot;lol&quot;</span><span class="p">))</span>  <span class="c1"># False</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_06"></span><div class="section" id="id1">
<h3>3.6 海象运算符的三种用法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>Python 版本发展非常快，如今最新的版本已经是 Pyhton
3.9，即便如此，有很多人甚至还停留在 3.6 或者 3.7，连 3.8 还没用上。</p>
<p>很多 Python 3.8
的特性还没来得及了解，就已经成为旧知识了，比如今天要说的海象运算符。</p>
<p>海象运算符是在 PEP 572 被提出的，直到 3.8 版本合入发布。</p>
<p>它的英文原名叫 <code class="docutils literal notranslate"><span class="pre">Assignment</span> <span class="pre">Expressions</span></code>，翻译过来也就是
<code class="docutils literal notranslate"><span class="pre">赋值表达式</span></code>，不过现在大家更普遍地称之为海象运算符，就是因为它长得真的太像海象了。</p>
<p><img alt="image1" src="http://image.iswbm.com/image-20200418122739417.png" /></p>
<div class="section" id="if-else">
<h4>第一个用法：if/else<a class="headerlink" href="#if-else" title="永久链接至标题">¶</a></h4>
<p>可能有朋友是第一次接触这个新特性，所以还是简单的介绍一下这个海象运算符有什么用？</p>
<p>在 Golang 中的条件语句可以直接在 if
中运算变量的获取后直接对这个变量进行判断，可以让你少写一行代码</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">age</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span><span class="nx">age</span> <span class="p">&gt;</span> <span class="mi">18</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;已经成年了&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>若在 Python 3.8 之前，Python 必须得这样子写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">age</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;已经成年了&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>但有了海象运算符之后，你可以和 Golang 一样（如果你没学过
Golang，那这里要注意，Golang 中的 <code class="docutils literal notranslate"><span class="pre">:=</span></code>
叫短变量声明，意思是声明并初始化，它和 Python 中的 <code class="docutils literal notranslate"><span class="pre">:=</span></code> 不是一个概念）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">age</span><span class="p">:</span><span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;已经成年了&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="while">
<h4>第二个用法：while<a class="headerlink" href="#while" title="永久链接至标题">¶</a></h4>
<p>在不使用 海象运算符之前，使用 while 循环来读取文件的时候，你也许会这么写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;demo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
<p>但有了海象运算符之后，你可以这样</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;demo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="p">:</span><span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
<p>使用它替换以往的无限 while 循环写法更为惊艳</p>
<p>比如，实现一个需要命令行交互输入密码并检验的代码，你也许会这样子写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
   <span class="n">p</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the password: &quot;</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;youpassword&quot;</span><span class="p">:</span>
      <span class="k">break</span>
</pre></div>
</div>
<p>有了海象运算符之后，这样子写更为舒服</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="p">:</span><span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the password: &quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">&quot;youpassword&quot;</span><span class="p">:</span>
   <span class="k">continue</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>第三个用法：推导式<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>这个系列的文章，几乎每篇都能看到推导式的身影，这一篇依旧如此。</p>
<p>在编码过程中，我很喜欢使用推导式，在简单的应用场景下，它简洁且不失高效。</p>
<p>如下这段代码中，我会使用列表推导式得出所有会员中过于肥胖的人的 bmi 指数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小五&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">72</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小李&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mf">1.72</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">63</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;小陈&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mf">1.78</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">82</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">get_bmi</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;执行了 {count} 次&quot;</span><span class="p">)</span>

    <span class="n">height</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">weight</span> <span class="o">/</span> <span class="p">(</span><span class="n">height</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># 查出所有会员中过于肥胖的人的 bmi 指数</span>
<span class="n">fat_bmis</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_bmi</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span> <span class="k">if</span> <span class="n">get_bmi</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="n">fat_bmis</span><span class="p">)</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">执行了</span> <span class="mi">1</span> <span class="n">次</span>
<span class="n">执行了</span> <span class="mi">2</span> <span class="n">次</span>
<span class="n">执行了</span> <span class="mi">3</span> <span class="n">次</span>
<span class="n">执行了</span> <span class="mi">4</span> <span class="n">次</span>
<span class="p">[</span><span class="mf">25.88057063502083</span><span class="p">]</span>
</pre></div>
</div>
<p>可以看到，会员数只有 3 个，但是 get_bmi 函数却执行了 4
次，原因是在判断时执行了 3 次，而在构造新的列表时又重复执行了一遍。</p>
<p>如果所有会员都是过于肥胖的，那最终将执行 6
次，这种在大量的数据下是比较浪费性能的，因此对于这种结构，我通常会使用传统的for
循环 + if 判断。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fat_bmis</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 查出所有会员中过于肥胖的人的 bmi 指数</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
    <span class="n">bmi</span> <span class="o">=</span> <span class="n">get_bmi</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bmi</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">fat_bmis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bmi</span><span class="p">)</span>
</pre></div>
</div>
<p>在有了海象运算符之后，你就可以不用在这种场景下做出妥协。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 查出所有会员中过于肥胖的人的 bmi 指数</span>
<span class="n">fat_bmis</span> <span class="o">=</span> <span class="p">[</span><span class="n">bmi</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span> <span class="k">if</span> <span class="p">(</span><span class="n">bmi</span> <span class="p">:</span><span class="o">=</span> <span class="n">get_bmi</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">]</span>
</pre></div>
</div>
<p>最终从输出结果可以看出，只执行了 3 次</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">执行了</span> <span class="mi">1</span> <span class="n">次</span>
<span class="n">执行了</span> <span class="mi">2</span> <span class="n">次</span>
<span class="n">执行了</span> <span class="mi">3</span> <span class="n">次</span>
<span class="p">[</span><span class="mf">25.88057063502083</span><span class="p">]</span>
</pre></div>
</div>
<p>这里仅介绍了列表推导式，但在字典推导式和集合推导式中同样适用。不再演示。</p>
<p>海象运算符，是一个新奇的特性，有不少人觉得这样这种特性会破坏代码的可读性。确实在一个新鲜事物刚出来时是会这样，但我相信经过时间的沉淀后，越来越多的人使用它并享受它带来的便利时，这种争议也会慢慢消失在历史的长河中。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_07"></span><div class="section" id="id1">
<h3>3.7 模块重载的五种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>环境准备<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>新建一个 foo 文件夹，其下包含一个 bar.py 文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree foo
foo
└── bar.py

0 directories, 1 file
</pre></div>
</div>
<p>bar.py 的内容非常简单，只写了个 print 语句</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;successful to be imported&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>只要 bar.py 被导入一次，就被执行一次 print</p>
</div>
<div class="section" id="id3">
<h4>禁止重复导入<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>由于有 sys.modules
的存在，当你导入一个已导入的模块时，实际上是没有效果的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">successful to be imported</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>重复导入方法一<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>如果你使用的 python2（记得前面在 foo 文件夹下加一个
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>），有一个 reload 的方法可以直接使用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">successful to be imported</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reload</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
<span class="go">successful to be imported</span>
<span class="go">&lt;module &#39;foo.bar&#39; from &#39;foo/bar.pyc&#39;&gt;</span>
</pre></div>
</div>
<p>如果你使用的 python3 那方法就多了，详细请看下面</p>
</div>
<div class="section" id="id5">
<h4>重复导入方法二<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>如果你使用 Python3.0 -&gt; 3.3，那么可以使用 imp.reload 方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">successful to be imported</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">imp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
<span class="go">successful to be imported</span>
<span class="go">&lt;module &#39;foo.bar&#39; from &#39;/Users/MING/Code/Python/foo/bar.py&#39;&gt;</span>
</pre></div>
</div>
<p>但是这个方法在 Python 3.4+，就不推荐使用了</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">stdin</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="ne">DeprecationWarning</span><span class="p">:</span> <span class="n">the</span> <span class="n">imp</span> <span class="n">module</span> <span class="ow">is</span> <span class="n">deprecated</span> <span class="ow">in</span> <span class="n">favour</span> <span class="n">of</span> <span class="n">importlib</span><span class="p">;</span> <span class="n">see</span> <span class="n">the</span> <span class="n">module</span><span class="s1">&#39;s documentation for alternative uses</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>重复导入方法三<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>如果你使用的 Python 3.4+，请使用 importlib.reload 方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">successful to be imported</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
<span class="go">successful to be imported</span>
<span class="go">&lt;module &#39;foo.bar&#39; from &#39;/Users/MING/Code/Python/foo/bar.py&#39;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4>重复导入方法四<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>如果你对包的加载器有所了解（详细可以翻阅我以前写的文章：<a class="reference external" href="https://iswbm.com/84.html">https://iswbm.com/84.html</a>）</p>
<p>还可以使用下面的方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">successful to be imported</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bar</span><span class="o">.</span><span class="n">__spec__</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">load_module</span><span class="p">()</span>
<span class="go">successful to be imported</span>
<span class="go">&lt;module &#39;foo.bar&#39; from &#39;/Users/MING/Code/Python/foo/bar.py&#39;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>重复导入方法五<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p>既然影响我们重复导入的是
sys.modules，那我们只要将已导入的包从其中移除是不是就好了呢？</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="go">successful to be imported</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;foo.bar&#39;</span><span class="p">]</span>
<span class="go">&lt;module &#39;foo.bar&#39; from &#39;/Users/MING/Code/Python/foo/bar.py&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;foo.bar&#39;</span><span class="p">]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="go">successful to be imported</span>
</pre></div>
</div>
<p>有没有发现在前面的例子里我使用的都是
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">foo</span> <span class="pre">import</span> <span class="pre">bar</span></code>，在这个例子里，却使用
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">foo.bar</span></code>，这是为什么呢？</p>
<p>这是因为如果你使用 <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">foo</span> <span class="pre">import</span> <span class="pre">bar</span></code> 这种方式，想使用移除
sys.modules 来重载模块这种方法是失效的。</p>
<p>这应该算是一个小坑，不知道的人，会掉入坑中爬不出来。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="go">successful to be imported</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;foo.bar&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">foo</span> <span class="k">import</span> <span class="n">bar</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_08"></span><div class="section" id="python">
<h3>3.8 Python 转义的五种表示法<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id1">
<h4>1. 为什么要有转义？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>ASCII 表中一共有 128
个字符。这里面有我们非常熟悉的字母、数字、标点符号，这些都可以从我们的键盘中输出。除此之外，还有一些非常特殊的字符，这些字符，我通常很难用键盘上的找到，比如制表符、响铃这种。</p>
<p>为了能将那些特殊字符都能写入到字符串变量中，就规定了一个用于转义的字符
<code class="docutils literal notranslate"><span class="pre">\</span></code> ，有了这个字符，你在字符串中看的字符，print
出来后就不一定你原来看到的了。</p>
<p>举个例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello</span><span class="se">\013</span><span class="s2">world</span><span class="se">\013</span><span class="s2">hello</span><span class="se">\013</span><span class="s2">python&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="go">hello</span>
<span class="go">     world</span>
<span class="go">          hello</span>
<span class="go">               python</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>是不是有点神奇？变成阶梯状的输出了。</p>
<p>那个 <code class="docutils literal notranslate"><span class="pre">\013</span></code> 又是什么意思呢？</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\</span></code> 是转义符号，上面已经说过</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">013</span></code> 是 ASCII 编码的八进制表示，注意前面是 <code class="docutils literal notranslate"><span class="pre">0</span></code>
且不可省略，而不是字母 <code class="docutils literal notranslate"><span class="pre">o</span></code></p></li>
</ul>
<p>把八进制的 13 转成 10 进制后是 11</p>
<p><img alt="image1" src="http://image.iswbm.com/image-20201125122441089.png" /></p>
<p>对照查看 ASCII 码表，11
对应的是一个垂直定位符号，这就能解释，为什么是阶梯状的输出字符串。</p>
<p><img alt="image2" src="http://image.iswbm.com/image-20201125122651086.png" /></p>
</div>
<div class="section" id="id2">
<h4>2. 转义的 5 种表示法<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>ASCII 有 128 个字符，如果用
八进制表示，至少得有三位数，才能将其全部表示。这就是为什么说上面的首位
<code class="docutils literal notranslate"><span class="pre">0</span></code> 不能省略的原因，即使现在用不上，我也得把它空出来。</p>
<p>而如果使用十六进制，只要两位数就其 ASCII
的字符全部表示出来。同时为了避免和八进制的混淆起来，所以在 <code class="docutils literal notranslate"><span class="pre">\</span></code>
后面要加上英文字母 <code class="docutils literal notranslate"><span class="pre">x</span></code> 表示十六进制，后面再接两位十六进制的数值。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\</span></code> 开头并接三位 0-7 的数值，表示 8 进制</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\x</span></code> 开头并接两位 0-f 的数值，表示 16进制</p></li>
</ul>
<p>因此，当我定义一个字符串的值为 <code class="docutils literal notranslate"><span class="pre">hello</span></code> + 回车 + <code class="docutils literal notranslate"><span class="pre">world</span></code>
时，就有了多种方法：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 第一种方法：8进制</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello</span><span class="se">\012</span><span class="s2">world&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
<span class="o">&gt;&gt;&gt;</span>

<span class="c1"># 第二种方法：16 进制</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello</span><span class="se">\x0a</span><span class="s2">world&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>通常我们很难记得住一个字符的 ASCII
编号，即使真记住了，也要去转换成八进制或者16进制，实在是太难了。</p>
<p>因此对于一些常用并且比较特殊字符，我们习惯用另一种类似别名的方式，比如使用
<code class="docutils literal notranslate"><span class="pre">\n</span></code> 表示换行，它与 <code class="docutils literal notranslate"><span class="pre">\012</span></code> 、<code class="docutils literal notranslate"><span class="pre">\x0a</span></code> 是等价的。</p>
<p>与此类似的表示法，还有如下这些</p>
<p><img alt="image3" src="http://image.iswbm.com/image-20201125213925997.png" /></p>
<p>于是，要实现 <code class="docutils literal notranslate"><span class="pre">hello</span></code> + 回车 + <code class="docutils literal notranslate"><span class="pre">world</span></code> ，就有了第三种方法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 第三种方法：使用类似别名的方法</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello</span><span class="se">\n</span><span class="s2">world&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>到目前为止，我们掌握了 三种转义的表示法。</p>
<p>已经非常难得了，让我们的脑洞再大一点吧，接下来再介绍两种。</p>
<p>ASCII 码表所能表示字符实在太有限了，想打印一个中文汉字，抱歉，你得借助
Unicode 码。</p>
<p>Unicode 编码由 4 个16进制数值组合而成</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\u4E2D</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">中</span>
</pre></div>
</div>
<p>什么？我为什么知道 <code class="docutils literal notranslate"><span class="pre">中</span></code> 的 unicode 是
<code class="docutils literal notranslate"><span class="pre">\u4E2D</span></code>？像下面这样打印就知道啦</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python 2.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;中&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span>
<span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u4e2d</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>由此，要实现 <code class="docutils literal notranslate"><span class="pre">hello</span></code> + 回车 + <code class="docutils literal notranslate"><span class="pre">world</span></code> ，就有了第四种方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 第四种方法：使用 unicode ，\u000a 表示换行</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello</span><span class="se">\u000a</span><span class="s1">world&#39;</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
</pre></div>
</div>
<p>看到这里，你是不是以为要结束啦？</p>
<p>不，还没有。下面还有一种。</p>
<p>Unicode 编码其实还可以由 8
个32进制数值组合而成，为了以前面的区分开来，这里用 <code class="docutils literal notranslate"><span class="pre">\U</span></code> 开头。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 第五种方法：使用 unicode ，\U0000000A 表示换行</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello</span><span class="se">\U0000000A</span><span class="s1">world&#39;</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
</pre></div>
</div>
<p>好啦，目前我们掌握了五种转义的表示法。</p>
<p>总结一下：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">\</span></code> 开头并接三位 0-7 的数值（八进制） — 可以表示所有ASCII 字符</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\x</span></code> 开头并接两位 0-f 的数值（十六进制） — 可以表示所有ASCII 字符</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\u</span></code> 开头并接四位 0-f 的数值（十六进制） — 可以表示所有 Unicode
字符</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\U</span></code> 开头并接八位 0-f 的数值（三十二进制）） — 可以表示所有 Unicode
字符</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\</span></code> 开头后接除 x、u、U 之外的特定字符 — 仅可表示部分字符</p></li>
</ol>
<p>为什么标题说，转义也可以炫技呢？</p>
<p>试想一下，假如你的同事，在打印日志时，使用这种 unicode
编码，然后你在定位问题的时候使用这个关键词去搜，却发现什么都搜不到？这就扑街了。</p>
<p><img alt="image4" src="http://image.iswbm.com/image-20201126090917123.png" /></p>
<p>虽然这种行为真的很 sb，但在某些人看来也许是非常牛逼的操作呢？</p>
<p>五种转义的表示法到这里就介绍完成，接下来是更多转义相关的内容，也是非常有意思的内容，有兴趣的可以继续往下看。</p>
</div>
<div class="section" id="raw">
<h4>3. raw 字符串<a class="headerlink" href="#raw" title="永久链接至标题">¶</a></h4>
<p>当一个字符串中具有转义的字符时，我们使用 print
打印后，正常情况下，输出的不是我们原来在字符串中看到的那样子。</p>
<p>那如果我们需要输出 <code class="docutils literal notranslate"><span class="pre">hello\nworld</span></code> ，不希望 Python 将 <code class="docutils literal notranslate"><span class="pre">\n</span></code> 转义成
换行符呢？</p>
<p>这种情况下，你可以在定义时将字符串定义成 raw
字符串，只要在字符串前面加个 <code class="docutils literal notranslate"><span class="pre">r</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">R</span></code> 即可。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;hello\nworld&quot;</span><span class="p">)</span>
<span class="go">hello\nworld</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="sa">R</span><span class="s2">&quot;hello\nworld&quot;</span><span class="p">)</span>
<span class="go">hello\nworld</span>
</pre></div>
</div>
<p>然而，不是所有时候都可以加 <code class="docutils literal notranslate"><span class="pre">r</span></code>
的，比如当你的字符串是由某个程序/函数返回给你的，而不是你自己生成的</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 假设这个是外来数据，返回 &quot;hello\nworld&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">spider</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="n">hello</span>
<span class="n">world</span>
</pre></div>
</div>
<p>这个时候打印它，<code class="docutils literal notranslate"><span class="pre">\n</span></code> 就是换行打印。</p>
</div>
<div class="section" id="repr">
<h4>4. 使用 repr<a class="headerlink" href="#repr" title="永久链接至标题">¶</a></h4>
<p>对于上面那种无法使用 <code class="docutils literal notranslate"><span class="pre">r</span></code> 的情况，可以试一下 <code class="docutils literal notranslate"><span class="pre">repr</span></code> 来解决这个需求：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">body</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">spider</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="go">&#39;hello\nworld&#39;</span>
</pre></div>
</div>
<p>经过 <code class="docutils literal notranslate"><span class="pre">repr</span></code> 函数的处理后，为让 print
后的结果，接近字符串本身的样子，它实际上做了两件事</p>
<ol class="arabic simple">
<li><p>将 <code class="docutils literal notranslate"><span class="pre">\</span></code> 变为了 <code class="docutils literal notranslate"><span class="pre">\\</span></code></p></li>
<li><p>在字符串的首尾添加 <code class="docutils literal notranslate"><span class="pre">'</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">&quot;</span></code></p></li>
</ol>
<p>你可以在 Python Shell 下敲入 变量 回车，就可以能看出端倪。</p>
<p>首尾是添加 <code class="docutils literal notranslate"><span class="pre">'</span></code> 还是 <code class="docutils literal notranslate"><span class="pre">&quot;</span></code> ，取决于你原字符串。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\n</span><span class="s2">world&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">repr</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="go">&quot;&#39;hello\\nworld&#39;&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s1">&#39;hello</span><span class="se">\n</span><span class="s1">world&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">repr</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="go">&quot;&#39;hello\\nworld&#39;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="string-escape">
<h4>5. 使用 string_escape<a class="headerlink" href="#string-escape" title="永久链接至标题">¶</a></h4>
<p>如果你还在使用 Python 2 ，其实还可以使用另一种方法。</p>
<p>那就是使用 <code class="docutils literal notranslate"><span class="pre">string.encode('string_escape')</span></code> 的方法，它同样可以达到
<code class="docutils literal notranslate"><span class="pre">repr</span></code> 的效果</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;hello</span><span class="se">\n</span><span class="s2">world&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;string_escape&#39;</span><span class="p">)</span>
<span class="go">&#39;hello\\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>6. 查看原生字符串<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>综上，想查看原生字符串有两种方法：</p>
<ol class="arabic simple">
<li><p>如果你在 Python Shell 交互模式下，那么敲击变量回车</p></li>
<li><p>如果不在 Python Shell 交互模式下，可先使用 <code class="docutils literal notranslate"><span class="pre">repr</span></code> 处理一下，再使用
print 打印</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\n</span><span class="s2">world&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span>
<span class="go">&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
<span class="go">&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>7. 恢复转义：转成原字符串<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>经过 <code class="docutils literal notranslate"><span class="pre">repr</span></code> 处理过或者 <code class="docutils literal notranslate"><span class="pre">\\</span></code>
取消转义过的字符串，有没有办法再回退出去，变成原先的有转义的字符串呢？</p>
<p>答案是：有。</p>
<p>如果你使用 Python 2，可以这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\\</span><span class="s2">nworld&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span>
<span class="go">&#39;hello\\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;string_escape&#39;</span><span class="p">)</span>
<span class="go">&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>如果你使用 Python 3 ，可以这样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\\</span><span class="s2">nworld&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span>
<span class="go">&#39;hello\\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">bytes</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;unicode_escape&quot;</span><span class="p">)</span>
<span class="go">&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>什么？还要区分 Python 2 和 Python 3？太麻烦了吧。</p>
<p>明哥教你用一种可以兼容 Python 2 和 Python 3 的写法。</p>
<p>首先是在 Python 2 中的输出</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">codecs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\\</span><span class="s2">nworld&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;unicode_escape&#39;</span><span class="p">)</span>
<span class="go">u&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>然后再看看 Python 3 中的输出</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">codecs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;hello</span><span class="se">\\</span><span class="s2">nworld&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;unicode_escape&#39;</span><span class="p">)</span>
<span class="go">&#39;hello\nworld&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>可以看到 Pyhton 2 中的输出 有一个 <code class="docutils literal notranslate"><span class="pre">u</span></code> ，而 Python 3 的输出没有了
<code class="docutils literal notranslate"><span class="pre">u</span></code>，但无论如何 ，他们都取消了转义。</p>
<p>以上，就是我为大家整理的关于 Python
中转义的全部内容了，整理的过程，不断的发现新知识，帮助到大家的同时，自己也对转义的一些内容有了更深的理解。</p>
<p>如果本文对你有些许帮助，不如给明哥 <strong>来个四连</strong> ~ 比心</p>
<p><img alt="image5" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_09"></span><div class="section" id="python">
<h3>3.9 Python 装包的八种方法<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="easy-install">
<h4>1. 使用 easy_install<a class="headerlink" href="#easy-install" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">easy_install</span></code>
这应该是最古老的包安装方式了，目前基本没有人使用了。下面是
<code class="docutils literal notranslate"><span class="pre">easy_install</span></code> 的一些安装示例</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 通过包名，从PyPI寻找最新版本，自动下载、编译、安装</span>
$ easy_install pkg_name

<span class="c1"># 通过包名从指定下载页寻找链接来安装或升级包</span>
$ easy_install -f http://pythonpaste.org/package_index.html

<span class="c1"># 指定线上的包地址安装</span>
$ easy_install http://example.com/path/to/MyPackage-1.2.3.tgz

<span class="c1"># 从本地的 .egg 文件安装</span>
$ easy_install xxx.egg
</pre></div>
</div>
</div>
<div class="section" id="pip-install">
<h4>2. 使用 pip install<a class="headerlink" href="#pip-install" title="永久链接至标题">¶</a></h4>
<p>pip 是最主流的包管理方案，使用 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">xxx</span></code> 就可以从 PYPI
上搜索并安装 <code class="docutils literal notranslate"><span class="pre">xxx</span></code> （如果该包存在的话）。</p>
<p>下面仅列出一些常用的 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code>的安装示例</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install requests

<span class="c1"># 前提你得保证你已经下载 pkg 包到 /local/wheels 目录下</span>
$ pip install --no-index --find-links<span class="o">=</span>/local/wheels pkg

<span class="c1"># 所安装的包的版本为 2.1.2</span>
$ pip install <span class="nv">pkg</span><span class="o">==</span><span class="m">2</span>.1.2

<span class="c1"># 所安装的包必须大于等于 2.1.2</span>
$ pip install pkg&gt;<span class="o">=</span><span class="m">2</span>.1.2

<span class="c1"># 所安装的包必须小于等于 2.1.2</span>
$ pip install pkg&lt;<span class="o">=</span><span class="m">2</span>.1.2
</pre></div>
</div>
<p>更多 pip 的使用方法，可参考我之前写过的文章，介绍得非常清楚：<a class="reference external" href="https://demo.iswbm.com/en/latest/c08/c08_08.html">8.8 pip
的详细使用指南</a></p>
</div>
<div class="section" id="pipx">
<h4>3. 使用 pipx<a class="headerlink" href="#pipx" title="永久链接至标题">¶</a></h4>
<p>pipx 是一个专门用于安装和管理 cli 应用程序的工具，使用它安装的 Python
包会单独安装到一个全新的独有虚拟环境。</p>
<p>由于它是一个第三方工具，因此在使用它之前，需要先安装</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install --user pipx
$ python3 -m userpath append ~/.local/bin
Success!
</pre></div>
</div>
<p>安装就可以使用 pipx 安装cli 工具了。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建虚拟环境并安装包</span>
$ pipx install pkg
</pre></div>
</div>
<p>更多 pipx 的使用方法，可参考我之前写过的文章，介绍得非常清楚：<a class="reference external" href="https://demo.iswbm.com/en/latest/c12/c12_04.html">12.4
pipx
安装程序的使用指南</a></p>
</div>
<div class="section" id="setup-py">
<h4>4. 使用 setup.py<a class="headerlink" href="#setup-py" title="永久链接至标题">¶</a></h4>
<p>如果你有编写 setup.py 文件，可以使用如下命令直接安装</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># 使用源码直接安装
$ python setup.py install
</pre></div>
</div>
</div>
<div class="section" id="yum">
<h4>5. 使用 yum<a class="headerlink" href="#yum" title="永久链接至标题">¶</a></h4>
<p>Python 包在使用 <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>
构建的时候，对于包的发布格式有多种选项，其中有一个选项是
<code class="docutils literal notranslate"><span class="pre">bdist_rpm</span></code>，以这个选项发布出来的包是 <code class="docutils literal notranslate"><span class="pre">rpm</span></code> 的包格式。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 发布 rpm 包</span>
$ python setup.py bdist_rpm
</pre></div>
</div>
<p>对于<code class="docutils literal notranslate"><span class="pre">rpm</span></code> 这种格式，你需要使用 <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">install</span> <span class="pre">xxx</span></code> 或者
<code class="docutils literal notranslate"><span class="pre">rpm</span> <span class="pre">install</span> <span class="pre">xxx</span></code> 来安装。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用 yum 安装</span>
$ yum install pkg

<span class="c1"># 使用 rpm 安装</span>
$ rpm -ivh pkg
</pre></div>
</div>
</div>
<div class="section" id="pipenv">
<h4>6. 使用 pipenv<a class="headerlink" href="#pipenv" title="永久链接至标题">¶</a></h4>
<p>如果你在使用 pipenv
创建的虚拟环境中，可以使用下面这条命令把包安装到虚拟环境中</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pipenv install pkg
</pre></div>
</div>
</div>
<div class="section" id="poetry">
<h4>7. 使用 poetry<a class="headerlink" href="#poetry" title="永久链接至标题">¶</a></h4>
<p>如果你有使用 poetry 管理项目依赖，那么可以使用下面这条命令安装包</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 直接安装包</span>
$ poetry add pkg

<span class="c1"># 指定为开发依赖</span>
$ poetry add pytest --dev
</pre></div>
</div>
</div>
<div class="section" id="curl">
<h4>8. 使用 curl + 管道<a class="headerlink" href="#curl" title="永久链接至标题">¶</a></h4>
<p>有一些第三方工具包提供的安装方法，是直接使用 curl
配置管道来安装，比如上面提到的 poetry 就可以用这种方法安装。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py <span class="p">|</span> python
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_10"></span><div class="section" id="python">
<h3>3.10 Python装饰器的六种写法<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>装饰器本质上是一个Python函数，它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象。</p>
<p>它经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等场景。</p>
<p>装饰器是解决这类问题的绝佳设计，有了装饰器，我们就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。</p>
<p>装饰器的使用方法很固定</p>
<ul class="simple">
<li><p>先定义一个装饰器（帽子）</p></li>
<li><p>再定义你的业务函数或者类（人）</p></li>
<li><p>最后把这装饰器（帽子）扣在这个函数（人）头上</p></li>
</ul>
<p>就像下面这样子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义装饰器</span>
<span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="c1"># 定义业务函数并进行装饰</span>
<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, decorator&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>实际上，装饰器并不是编码必须性，意思就是说，你不使用装饰器完全可以，它的出现，应该是使我们的代码</p>
<ul class="simple">
<li><p>更加优雅，代码结构更加清晰</p></li>
<li><p>将实现特定的功能代码封装成装饰器，提高代码复用率，增强代码可读性</p></li>
</ul>
<p>接下来，我将以实例讲解，如何编写出各种简单及复杂的装饰器。</p>
<div class="section" id="id1">
<h4>1. 第一种：普通装饰器<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>首先咱来写一个最普通的装饰器，它实现的功能是：</p>
<ul class="simple">
<li><p>在函数执行前，先记录一行日志</p></li>
<li><p>在函数执行完，再记录一行日志</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 这是装饰器函数，参数 func 是被装饰的函数</span>
<span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;我准备开始执行：{} 函数了:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

        <span class="c1"># 真正执行的是这行。</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;主人，我执行完啦。&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
<p>假如，我的业务函数是，计算两个数之和。写好后，直接给它带上帽子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@logger</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} + {} = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>然后执行一下 add 函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<p>来看看输出了什么？</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>我准备开始执行：add 函数了:
200 + 50 = 250
我执行完啦。
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>2. 第二种：带参数的函数装饰器<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>通过上面两个简单的入门示例，你应该能体会到装饰器的工作原理了。</p>
<p>不过，装饰器的用法还远不止如此，深究下去，还大有文章。今天就一起来把这个知识点学透。</p>
<p>回过头去看看上面的例子，装饰器是不能接收参数的。其用法，只能适用于一些简单的场景。不传参的装饰器，只能对被装饰函数，执行固定逻辑。</p>
<p>装饰器本身是一个函数，做为一个函数，如果不能传参，那这个函数的功能就会很受限，只能执行固定的逻辑。这意味着，如果装饰器的逻辑代码的执行需要根据不同场景进行调整，若不能传参的话，我们就要写两个装饰器，这显然是不合理的。</p>
<p>比如我们要实现一个可以定时发送邮件的任务（一分钟发送一封），定时进行时间同步的任务（一天同步一次），就可以自己实现一个
periodic_task
（定时任务）的装饰器，这个装饰器可以接收一个时间间隔的参数，间隔多长时间执行一次任务。</p>
<p>可以这样像下面这样写，由于这个功能代码比较复杂，不利于学习，这里就不贴了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@periodic_task</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">():</span>
     <span class="k">pass</span>

<span class="nd">@periodic_task</span><span class="p">(</span><span class="n">spacing</span><span class="o">=</span><span class="mi">86400</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ntp</span><span class="p">()</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>那我们来自己创造一个伪场景，可以在装饰器里传入一个参数，指明国籍，并在函数执行前，用自己国家的母语打一个招呼。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 小明，中国人</span>
<span class="nd">@say_hello</span><span class="p">(</span><span class="s2">&quot;china&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xiaoming</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="c1"># jack，美国人</span>
<span class="nd">@say_hello</span><span class="p">(</span><span class="s2">&quot;america&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">jack</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>那我们如果实现这个装饰器，让其可以实现 <code class="docutils literal notranslate"><span class="pre">传参</span></code> 呢？</p>
<p>会比较复杂，需要两层嵌套。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">contry</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">deco</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">contry</span> <span class="o">==</span> <span class="s2">&quot;china&quot;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;你好!&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">contry</span> <span class="o">==</span> <span class="s2">&quot;america&quot;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># 真正执行函数的地方</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deco</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
<p>来执行一下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xiaoming</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
<span class="n">jack</span><span class="p">()</span>
</pre></div>
</div>
<p>看看输出结果。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>你好!
------------
hello.
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>3. 第三种：不带参数的类装饰器<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>以上都是基于函数实现的装饰器，在阅读别人代码时，还可以时常发现还有基于类实现的装饰器。</p>
<p>基于类装饰器的实现，必须实现 <code class="docutils literal notranslate"><span class="pre">__call__</span></code> 和
<code class="docutils literal notranslate"><span class="pre">__init__</span></code>两个内置函数。 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> ：接收被装饰函数 <code class="docutils literal notranslate"><span class="pre">__call__</span></code>
：实现装饰逻辑。</p>
<p>还是以日志打印这个简单的例子为例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[INFO]: the function {func}() is running...&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nd">@logger</span>
<span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="n">something</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;say {}!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">something</span><span class="p">))</span>

<span class="n">say</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>执行一下，看看输出</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[INFO]: the function say() is running...
say hello!
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>4. 第四种：带参数的类装饰器<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>上面不带参数的例子，你发现没有，只能打印<code class="docutils literal notranslate"><span class="pre">INFO</span></code>级别的日志，正常情况下，我们还需要打印<code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>
<code class="docutils literal notranslate"><span class="pre">WARNING</span></code>等级别的日志。这就需要给类装饰器传入参数，给这个函数指定级别了。</p>
<p>带参数和不带参数的类装饰器有很大的不同。</p>
<p><code class="docutils literal notranslate"><span class="pre">__init__</span></code> ：不再接收被装饰函数，而是接收传入参数。 <code class="docutils literal notranslate"><span class="pre">__call__</span></code>
：接收被装饰函数，实现装饰逻辑。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">logger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span> <span class="c1"># 接受函数</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[{level}]: the function {func}() is running...&quot;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>  <span class="c1">#返回函数</span>

<span class="nd">@logger</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="n">something</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;say {}!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">something</span><span class="p">))</span>

<span class="n">say</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>我们指定<code class="docutils literal notranslate"><span class="pre">WARNING</span></code>级别，运行一下，来看看输出。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[WARNING]: the function say() is running...
say hello!
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>5. 第五种：使用偏函数与类实现装饰器<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>绝大多数装饰器都是基于函数和闭包实现的，但这并非制造装饰器的唯一方式。</p>
<p>事实上，Python 对某个对象是否能通过装饰器（
<code class="docutils literal notranslate"><span class="pre">&#64;decorator</span></code>）形式使用只有一个要求：<strong>decorator
必须是一个“可被调用（callable）的对象</strong>。</p>
<p>对于这个 callable 对象，我们最熟悉的就是函数了。</p>
<p>除函数之外，类也可以是 callable 对象，只要实现了<code class="docutils literal notranslate"><span class="pre">__call__</span></code>
函数（上面几个例子已经接触过了）。</p>
<p>还有容易被人忽略的偏函数其实也是 callable 对象。</p>
<p>接下来就来说说，如何使用 类和偏函数结合实现一个与众不同的装饰器。</p>
<p>如下所示，DelayFunc 是一个实现了 <code class="docutils literal notranslate"><span class="pre">__call__</span></code> 的类，delay
返回一个偏函数，在这里 delay 就可以做为一个装饰器。（以下代码摘自
Python工匠：使用装饰器的小技巧）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="k">class</span> <span class="nc">DelayFunc</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">duration</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Wait for {self.duration} seconds...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eager_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Call without delay&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delay</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    装饰器：推迟某个函数的执行。</span>
<span class="sd">    同时提供 .eager_call 方法立即执行</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 此处为了避免定义额外函数，</span>
    <span class="c1"># 直接使用 functools.partial 帮助构造 DelayFunc 实例</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">DelayFunc</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
</pre></div>
</div>
<p>我们的业务函数很简单，就是相加</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@delay</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
</pre></div>
</div>
<p>来看一下执行过程</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span>    <span class="c1"># 可见 add 变成了 Delay 的实例</span>
<span class="go">&lt;__main__.DelayFunc object at 0x107bd0be0&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 直接调用实例，进入 __call__</span>
<span class="go">Wait for 2 seconds...</span>
<span class="go">8</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">func</span> <span class="c1"># 实现实例方法</span>
<span class="go">&lt;function add at 0x107bef1e0&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>6. 第六种：能装饰类的装饰器<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>用 Python
写单例模式的时候，常用的有三种写法。其中一种，是用装饰器来实现的。</p>
<p>以下便是我自己写的装饰器版的单例写法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">singleton</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">cls_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===== 1 ====&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cls_name</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===== 2 ====&#39;</span><span class="p">)</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">instances</span><span class="p">[</span><span class="n">cls_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="k">return</span> <span class="n">instances</span><span class="p">[</span><span class="n">cls_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">get_instance</span>

<span class="nd">@singleton</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">_instance</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===== 3 ====&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</pre></div>
</div>
<p>可以看到我们用singleton 这个装饰函数来装饰 User
这个类。装饰器用在类上，并不是很常见，但只要熟悉装饰器的实现过程，就不难以实现对类的装饰。在上面这个例子中，装饰器就只是实现对类实例的生成的控制而已。</p>
<p>其实例化的过程，你可以参考我这里的调试过程，加以理解。</p>
<p><img alt="image1" src="http://image.iswbm.com/20190512113917.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_11"></span><div class="section" id="python">
<h3>3.11 Python 读取文件的三种方式<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="open">
<h4>第一种：使用 open<a class="headerlink" href="#open" title="永久链接至标题">¶</a></h4>
<p>常规操作</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
  <span class="n">content</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="fileinput">
<h4>第二种：使用 fileinput<a class="headerlink" href="#fileinput" title="永久链接至标题">¶</a></h4>
<p>使用内置库 fileinput</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;data.txt&#39;</span><span class="p">,))</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="filecache">
<h4>第三种：使用 filecache<a class="headerlink" href="#filecache" title="永久链接至标题">¶</a></h4>
<p>使用内置库
filecache，你可以用它来指定读取具体某一行，或者某几行，不指定就读取全部行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">linecache</span>

<span class="n">content</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span><span class="p">(</span><span class="s1">&#39;werobot.toml&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="codecs">
<h4>第四种：使用 codecs<a class="headerlink" href="#codecs" title="永久链接至标题">¶</a></h4>
<p>使用 <code class="docutils literal notranslate"><span class="pre">codecs.open</span></code> 来读取</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">codecs</span>
<span class="nb">file</span><span class="o">=</span><span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;README.md&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>如果你还在使用 Python2，那么它可以帮你处理掉 Python 2
下写文件时一些编码错误，一般的建议是：</p>
<ul class="simple">
<li><p>在 Python 3 下写文件，直接使用 open</p></li>
<li><p>在 Python 2 下写文件，推荐使用 codecs.open，特别是有中文的情况下</p></li>
<li><p>如果希望代码同时兼容Python2和Python3，那么也推荐用codecs.open</p></li>
</ul>
</div>
<div class="section" id="io">
<h4>第五种：使用 io<a class="headerlink" href="#io" title="永久链接至标题">¶</a></h4>
<p>使用最底层的 io 模块</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="nb">file</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;README.md&quot;</span><span class="p">)</span>
<span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c03/c03_12"></span><div class="section" id="id1">
<h3>3.12 调用函数的九种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>方法一：直接调用函数运行<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>这种是最简单且直观的方法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running task&quot;</span><span class="p">)</span>

<span class="n">task</span><span class="p">()</span>
</pre></div>
</div>
<p>如果是在类中，也是如此</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running task&quot;</span><span class="p">)</span>

<span class="n">Task</span><span class="p">()</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>方法二：使用偏函数来执行<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>在 functools 这个内置库中，有一个 partial 方法专门用来生成偏函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">power_2</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">power_2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># output: 4</span>
<span class="n">power_2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># output: 9</span>
</pre></div>
</div>
</div>
<div class="section" id="eval">
<h4>方法三：使用 eval 动态执行<a class="headerlink" href="#eval" title="永久链接至标题">¶</a></h4>
<p>如果你有需要动态执行函数的需要，可以使用 eval + 字符串 来执行函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">pre_task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running pre_task&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running task&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">post_task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running post_task&quot;</span><span class="p">)</span>

<span class="n">argvs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">argvs</span><span class="p">:</span>
    <span class="nb">eval</span><span class="p">(</span><span class="n">action</span><span class="p">)()</span>
</pre></div>
</div>
<p>运行效果如下</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ python demo.py pre_task task post_task
running pre_task
running task
running post_task
</pre></div>
</div>
</div>
<div class="section" id="getattr">
<h4>方法四：使用 getattr 动态获取执行<a class="headerlink" href="#getattr" title="永久链接至标题">¶</a></h4>
<p>若把所有的函数是放在类中，并定义成静态方法，那就不需要用 eval
了，接着使用 getattr 去获取并调用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pre_task</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running pre_task&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">task</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running task&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">post_task</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running post_task&quot;</span><span class="p">)</span>

<span class="n">argvs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">()</span>

<span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">argvs</span><span class="p">:</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
    <span class="n">func</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>方法五：使用类本身的字典<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>我们都知道对象都有一个 <code class="docutils literal notranslate"><span class="pre">__dict__()</span></code>
的魔法方法，存放所有对象的属性及方法。</p>
<p>到这里，大家可以思考一下， 如果还是上面的代码，我直接取实例的
<code class="docutils literal notranslate"><span class="pre">__dict__()</span></code> 能不能取到函数呢？</p>
<p><strong>我相信很多人都会答错。</strong></p>
<p>上面我们定义的是静态方法，静态方法并没有与实例进行绑定，因此静态方法是属于类的，但是不是属于实例的，实例虽然有使用权（可以调用），但是并没有拥有权。</p>
<p>因此要想通过 <code class="docutils literal notranslate"><span class="pre">__dict__</span></code> 获取函数，得通过类本身
<code class="docutils literal notranslate"><span class="pre">Task</span></code>，取出来的函数，调用方法和平时的也不一样，必须先用
<code class="docutils literal notranslate"><span class="pre">__func__</span></code> 获取才能调用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pre_task</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running pre_task&quot;</span><span class="p">)</span>

<span class="n">func</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pre_task&quot;</span><span class="p">)</span>
<span class="n">func</span><span class="o">.</span><span class="vm">__func__</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="global">
<h4>方法六：使用 global() 获取执行<a class="headerlink" href="#global" title="永久链接至标题">¶</a></h4>
<p>上面放入类中，只是为了方便使用 <code class="docutils literal notranslate"><span class="pre">getattr</span></code>
的方法，其实不放入类中，也是可以的。此时你需要借助 globals() 或者
locals() ，它们本质上就是一个字典，你可以直接 get 来获得函数。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">pre_task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running pre_task&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running task&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">post_task</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running post_task&quot;</span><span class="p">)</span>

<span class="n">argvs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">argvs</span><span class="p">:</span>
    <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">)()</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>方法七：从文本中编译运行<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>先定义一个字符串，内容是你函数的内容，比如上面的 pre_task ，再通过
<code class="docutils literal notranslate"><span class="pre">compile</span></code> 函数编进 编译，转化为字节代码，最后再使用 <code class="docutils literal notranslate"><span class="pre">exec</span></code>
去执行它。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pre_task</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">print(&quot;running pre_task&quot;)</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="k">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">pre_task</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>若你的代码是放在一个 txt 文本中，虽然无法直接导入运行，但仍然可以通过
open 来读取，最后使用 compile 函数编译运行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;source.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;source.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="attrgetter">
<h4>方法八：使用 attrgetter 获取执行<a class="headerlink" href="#attrgetter" title="永久链接至标题">¶</a></h4>
<p>在 operator 这个内置库中，有一个获取属性的方法，叫 <code class="docutils literal notranslate"><span class="pre">attrgetter</span></code>
，获取到函数后再执行。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>

<span class="k">class</span> <span class="nc">People</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">dest</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">()</span>
<span class="n">caller</span> <span class="o">=</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;speak&quot;</span><span class="p">)</span>
<span class="n">caller</span><span class="p">(</span><span class="n">p</span><span class="p">)(</span><span class="s2">&quot;明哥&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="methodcaller">
<h4>方法九：使用 methodcaller 执行<a class="headerlink" href="#methodcaller" title="永久链接至标题">¶</a></h4>
<p>同样还是 operator 这个内置库，有一个 methodcaller
方法，使用它，也可以做到动态调用实例方法的效果。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">methodcaller</span>

<span class="k">class</span> <span class="nc">People</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">dest</span><span class="p">)</span>

<span class="n">caller</span> <span class="o">=</span> <span class="n">methodcaller</span><span class="p">(</span><span class="s2">&quot;speak&quot;</span><span class="p">,</span> <span class="s2">&quot;明哥&quot;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">()</span>
<span class="n">caller</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p04"></span><div class="section" id="id1">
<h2>第四章：魔法进阶扫盲<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这一章节主要深入理解 Python 中那些难点，将这些难点逐个击破？</p>
<p>比如：</p>
<p>如何写出一个可以带参数的装饰器呢？</p>
<p>装饰器可以装饰函数，那么你知道如何装饰类吗？</p>
<p>描述符的访问规则是什么？</p>
<p>描述符在实际开发中有哪些使用场景？</p>
<p>这些恐怕有不少人都还没有深入学习过，这一章节可扩展的内容有很多，比如元类等，日后会慢慢完善。</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c04/c04_01"></span><div class="section" id="id1">
<h3>4.1 精通上下文管理器<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">with</span></code> 这个关键字，对于每一学习Python的人，都不会陌生。</p>
<p>操作文本对象的时候，几乎所有的人都会让我们要用 <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">open</span></code>
，这就是一个上下文管理的例子。你一定已经相当熟悉了，我就不再废话了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
</pre></div>
</div>
<div class="section" id="what-context-manager">
<h4>what context manager？<a class="headerlink" href="#what-context-manager" title="永久链接至标题">¶</a></h4>
<p><strong>基本语法</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EXPR</span> <span class="k">as</span> <span class="n">VAR</span><span class="p">:</span>
    <span class="n">BLOCK</span>
</pre></div>
</div>
<p>先理清几个概念</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. 上下文表达式：with open(&#39;test.txt&#39;) as f:
2. 上下文管理器：open(&#39;test.txt&#39;)
3. f 不是上下文管理器，应该是资源对象。
</pre></div>
</div>
</div>
<div class="section" id="how-context-manager">
<h4>how context manager？<a class="headerlink" href="#how-context-manager" title="永久链接至标题">¶</a></h4>
<p>要自己实现这样一个上下文管理，要先知道上下文管理协议。</p>
<p>简单点说，就是在一个类里，实现了<code class="docutils literal notranslate"><span class="pre">__enter__</span></code>和<code class="docutils literal notranslate"><span class="pre">__exit__</span></code>的方法，这个类的实例就是一个上下文管理器。</p>
<p>例如这个示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Resource</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===connect to resource===&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===close resource connection===&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===in operation===&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Resource</span><span class="p">()</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
    <span class="n">res</span><span class="o">.</span><span class="n">operate</span><span class="p">()</span>
</pre></div>
</div>
<p>我们执行一下，通过日志的打印顺序。可以知道其执行过程。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">===</span><span class="n">connect</span> <span class="n">to</span> <span class="n">resource</span><span class="o">===</span>
<span class="o">===</span><span class="ow">in</span> <span class="n">operation</span><span class="o">===</span>
<span class="o">===</span><span class="n">close</span> <span class="n">resource</span> <span class="n">connection</span><span class="o">===</span>
</pre></div>
</div>
<p>从这个示例可以很明显的看出，在编写代码时，可以将资源的连接或者获取放在<code class="docutils literal notranslate"><span class="pre">__enter__</span></code>中，而将资源的关闭写在<code class="docutils literal notranslate"><span class="pre">__exit__</span></code>
中。</p>
</div>
<div class="section" id="why-context-manager">
<h4>why context manager？<a class="headerlink" href="#why-context-manager" title="永久链接至标题">¶</a></h4>
<p>学习时多问自己几个为什么，养成对一些细节的思考，有助于加深对知识点的理解。</p>
<p>为什么要使用上下文管理器？</p>
<p>在我看来，这和 Python 崇尚的优雅风格有关。</p>
<ol class="arabic simple">
<li><p>可以以一种更加优雅的方式，操作（创建/获取/释放）资源，如文件操作、数据库连接；</p></li>
<li><p>可以以一种更加优雅的方式，处理异常；</p></li>
</ol>
<p>第一种，我们上面已经以资源的连接为例讲过了。</p>
<p>而第二种，会被大多数人所忽略。这里会重点讲一下。</p>
<p>大家都知道，处理异常，通常都是使用 <code class="docutils literal notranslate"><span class="pre">try...execept..</span></code>
来捕获处理的。这样做一个不好的地方是，在代码的主逻辑里，会有大量的异常处理代理，这会很大的影响我们的可读性。</p>
<p>好一点的做法呢，可以使用 <code class="docutils literal notranslate"><span class="pre">with</span></code> 将异常的处理隐藏起来。</p>
<p>仍然是以上面的代码为例，我们将<code class="docutils literal notranslate"><span class="pre">1/0</span></code>
这个<code class="docutils literal notranslate"><span class="pre">一定会抛出异常的代码</span></code>写在 <code class="docutils literal notranslate"><span class="pre">operate</span></code> 里</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Resource</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===connect to resource===&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;===close resource connection===&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">operate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

<span class="k">with</span> <span class="n">Resource</span><span class="p">()</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
    <span class="n">res</span><span class="o">.</span><span class="n">operate</span><span class="p">()</span>
</pre></div>
</div>
<p>运行一下，惊奇地发现，居然不会报错。</p>
<p>这就是上下文管理协议的一个强大之处，异常可以在<code class="docutils literal notranslate"><span class="pre">__exit__</span></code>
进行捕获并由你自己决定如何处理，是抛出呢还是在这里就解决了。在<code class="docutils literal notranslate"><span class="pre">__exit__</span></code>
里返回 <code class="docutils literal notranslate"><span class="pre">True</span></code>（没有return 就默认为 return False），就相当于告诉
Python解释器，这个异常我们已经捕获了，不需要再往外抛了。</p>
<p>在 写<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> 函数时，需要注意的事，它必须要有这三个参数：</p>
<ul class="simple">
<li><p>exc_type：异常类型</p></li>
<li><p>exc_val：异常值</p></li>
<li><p>exc_tb：异常的错误栈信息</p></li>
</ul>
<p>当主逻辑代码没有报异常时，这三个参数将都为None。</p>
</div>
<div class="section" id="how-contextlib">
<h4>how contextlib?<a class="headerlink" href="#how-contextlib" title="永久链接至标题">¶</a></h4>
<p>在上面的例子中，我们只是为了构建一个上下文管理器，却写了一个类。如果只是要实现一个简单的功能，写一个类未免有点过于繁杂。这时候，我们就想，如果只写一个函数就可以实现上下文管理器就好了。</p>
<p>这个点Python早就想到了。它给我们提供了一个装饰器，你只要按照它的代码协议来实现函数内容，就可以将这个函数对象变成一个上下文管理器。</p>
<p>我们按照 contextlib 的协议来自己实现一个打开文件（with
open）的上下文管理器。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">open_func</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="c1"># __enter__方法</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;open file:&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;in __enter__&#39;</span><span class="p">)</span>
    <span class="n">file_handler</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># 【重点】：yield</span>
    <span class="k">yield</span> <span class="n">file_handler</span>

    <span class="c1"># __exit__方法</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;close file:&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;in __exit__&#39;</span><span class="p">)</span>
    <span class="n">file_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>

<span class="k">with</span> <span class="n">open_func</span><span class="p">(</span><span class="s1">&#39;/Users/MING/mytest.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_in</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_in</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>在被装饰函数里，必须是一个生成器（带有yield），而yield之前的代码，就相当于<code class="docutils literal notranslate"><span class="pre">__enter__</span></code>里的内容。yield
之后的代码，就相当于<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> 里的内容。</p>
<p>上面这段代码只能实现上下文管理器的第一个目的（管理资源），并不能实现第二个目的（处理异常）。</p>
<p>如果要处理异常，可以改成下面这个样子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">open_func</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="c1"># __enter__方法</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;open file:&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;in __enter__&#39;</span><span class="p">)</span>
    <span class="n">file_handler</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">file_handler</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># deal with exception</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;the exception was thrown&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;close file:&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;in __exit__&#39;</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span>

<span class="k">with</span> <span class="n">open_func</span><span class="p">(</span><span class="s1">&#39;/Users/MING/mytest.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_in</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_in</span><span class="p">:</span>
        <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>好像只要讲到上下文管理器，大多数人都会谈到打开文件这个经典的例子。</p>
<p>但是在实际开发中，可以使用到上下文管理器的例子也不少。我这边举个我自己的例子。</p>
<p>在OpenStack中，给一个虚拟机创建快照时，需要先创建一个临时文件夹，来存放这个本地快照镜像，等到本地快照镜像创建完成后，再将这个镜像上传到Glance。然后删除这个临时目录。</p>
<p>这段代码的主逻辑是<code class="docutils literal notranslate"><span class="pre">创建快照</span></code>，而<code class="docutils literal notranslate"><span class="pre">创建临时目录</span></code>，属于前置条件，<code class="docutils literal notranslate"><span class="pre">删除临时目录</span></code>，是收尾工作。</p>
<p>虽然代码量很少，逻辑也不复杂，但是“<code class="docutils literal notranslate"><span class="pre">创建临时目录，使用完后再删除临时目录</span></code>”这个功能，在一个项目中很多地方都需要用到，如果可以将这段逻辑处理写成一个工具函数作为一个上下文管理器，那代码的复用率也大大提高。</p>
<p>代码是这样的</p>
<p><img alt="image1" src="http://image.iswbm.com/20190310172800.png" /></p>
<p>总结起来，使用上下文管理器有三个好处：</p>
<ol class="arabic simple">
<li><p>提高代码的复用率；</p></li>
<li><p>提高代码的优雅度；</p></li>
<li><p>提高代码的可读性；</p></li>
</ol>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c04/c04_02"></span><div class="section" id="id1">
<h3>4.2 深入理解描述符<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>学习 Python 这么久了，说起 Python 的优雅之处，能让我脱口而出的，
Descriptor（描述符）特性可以排得上号。</p>
<p>描述符 是Python
语言独有的特性，它不仅在应用层使用，在语言语法糖的实现上也有使用到（在下面的文章会一一介绍）。</p>
<p>当你点进这篇文章时</p>
<ul class="simple">
<li><p>你也许没学过描述符，甚至没听过描述符。</p></li>
<li><p>或者你对描述符只是一知半解</p></li>
</ul>
<p>无论你是哪种，本篇都将带你全面的学习描述符，一起来感受 Python
语言的优雅。</p>
<div class="section" id="id2">
<h4>1. 为什么要使用描述符？<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>假想你正在给学校写一个成绩管理系统，并没有太多编码经验的你，可能会这样子写。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">,</span> <span class="n">english</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">english</span> <span class="o">=</span> <span class="n">english</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student: {}, math:{}, chinese: {}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>看起来一切都很合理</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="s1">&#39;小明&#39;</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">68</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span>
<span class="go">&lt;Student: 小明, math:76, chinese: 87, english:68&gt;</span>
</pre></div>
</div>
<p>但是程序并不像人那么智能，不会自动根据使用场景判断数据的合法性，如果老师在录入成绩的时候，不小心录入了将成绩录成了负数，或者超过100，程序是无法感知的。</p>
<p>聪明的你，马上在代码中加入了判断逻辑。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">,</span> <span class="n">english</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">math</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">chinese</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">chinese</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">english</span> <span class="o">=</span> <span class="n">english</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student: {}, math:{}, chinese: {}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>这下程序稍微有点人工智能了，能够自己明辨是非了。</p>
<p><img alt="image1" src="http://image.iswbm.com/20190425221322.png" /></p>
<p>程序是智能了，但在<code class="docutils literal notranslate"><span class="pre">__init__</span></code>里有太多的判断逻辑，很影响代码的可读性。巧的是，你刚好学过
Property
特性，可以很好的应用在这里。于是你将代码修改成如下，代码的可读性瞬间提升了不少</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">,</span> <span class="n">english</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">english</span> <span class="o">=</span> <span class="n">english</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_math</span>

    <span class="nd">@math.setter</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_math</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chinese</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chinese</span>

    <span class="nd">@chinese.setter</span>
    <span class="k">def</span> <span class="nf">chinese</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chinese</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">english</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_english</span>

    <span class="nd">@english.setter</span>
    <span class="k">def</span> <span class="nf">english</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_english</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student: {}, math:{}, chinese: {}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>程序还是一样的人工智能，非常好。</p>
<p><img alt="image2" src="http://image.iswbm.com/20190425221322.png" /></p>
<p>你以为你写的代码，已经非常优秀，无懈可击了。</p>
<p>没想到，人外有天，你的主管看了你的代码后，深深地叹了口气：类里的三个属性，math、chinese、english，都使用了
Property
对属性的合法性进行了有效控制。功能上，没有问题，但就是太啰嗦了，三个变量的合法性逻辑都是一样的，只要大于0，小于100
就可以，代码重复率太高了，这里三个成绩还好，但假设还有地理、生物、历史、化学等十几门的成绩呢，这代码简直没法忍。去了解一下
Python 的描述符吧。</p>
<p>经过主管的指点，你知道了「描述符」这个东西。怀着一颗敬畏之心，你去搜索了下关于
描述符的用法。</p>
<p>其实也很简单，一个实现了 <code class="docutils literal notranslate"><span class="pre">描述符协议</span></code> 的类就是一个描述符。</p>
<p>什么描述符协议：在类里实现了
<code class="docutils literal notranslate"><span class="pre">__get__()</span></code>、<code class="docutils literal notranslate"><span class="pre">__set__()</span></code>、<code class="docutils literal notranslate"><span class="pre">__delete__()</span></code>
其中至少一个方法。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__get__</span></code>：
用于访问属性。它返回属性的值，若属性不存在、不合法等都可以抛出对应的异常。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__set__</span></code>：将在属性分配操作中调用。不会返回任何内容。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__delete__</span></code>：控制删除操作。不会返回内容。</p></li>
</ul>
<p>对描述符有了大概的了解后，你开始重写上面的方法。</p>
<p>如前所述，Score 类是一个描述符，当从 Student 的实例访问
math、chinese、english这三个属性的时候，都会经过 Score
类里的三个特殊的方法。这里的 Score 避免了 使用Property
出现大量的代码无法复用的尴尬。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Score</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Score must be integer&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Valid value must be in [0, 100]&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span>

    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="n">math</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chinese</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">english</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">,</span> <span class="n">english</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">english</span> <span class="o">=</span> <span class="n">english</span>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student: {}, math:{}, chinese: {}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>实现的效果和前面的一样，可以对数据的合法性进行有效控制（字段类型、数值区间等）</p>
<p><img alt="image3" src="http://image.iswbm.com/20190425221233.png" /></p>
<p>以上，我举了下具体的实例，从最原始的编码风格到 Property
，最后引出描述符。由浅入深，一步一步带你感受到描述符的优雅之处。</p>
<p>到这里，你需要记住的只有一点，就是描述符给我们带来的编码上的便利，它在实现
<code class="docutils literal notranslate"><span class="pre">保护属性不受修改</span></code>、<code class="docutils literal notranslate"><span class="pre">属性类型检查</span></code>
的基本功能，同时有大大提高代码的复用率。</p>
</div>
<div class="section" id="id3">
<h4>2. 描述符的访问规则<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>描述符分两种：</p>
<ul class="simple">
<li><p>数据描述符：实现了<code class="docutils literal notranslate"><span class="pre">__get__</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__set__</span></code> 两种方法的描述符</p></li>
<li><p>非数据描述符：只实现了<code class="docutils literal notranslate"><span class="pre">__get__</span></code> 一种方法的描述符</p></li>
</ul>
<p>你一定会问，他们有什么区别呢？网上的讲解，我看过几个，很多都把一个简单的东西讲得复杂了。</p>
<p>其实就一句话，<strong>数据描述器和非数据描述器的区别在于：它们相对于实例的字典的优先级不同</strong>。</p>
<p>如果实例字典中有与描述符同名的属性，那么：</p>
<ul class="simple">
<li><p>描述符是数据描述符的话，优先使用数据描述符</p></li>
<li><p>描述符是非数据描述符的话，优先使用字典中的属性。</p></li>
</ul>
<p>这边还是以上节的成绩管理的例子来说明，方便你理解。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 数据描述符</span>
<span class="k">class</span> <span class="nc">DataDes</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;访问数据描述符里的 __get__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span>

<span class="c1"># 非数据描述符</span>
<span class="k">class</span> <span class="nc">NoDataDes</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;访问非数据描述符里的 __get__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span>


<span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="n">math</span> <span class="o">=</span> <span class="n">DataDes</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chinese</span> <span class="o">=</span> <span class="n">NoDataDes</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>

    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;调用 __getattribute__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student: {}, math:{}, chinese: {},&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">)</span>
</pre></div>
</div>
<p>需要注意的是，math 是数据描述符，而 chinese
是非数据描述符。从下面的验证中，可以看出，当实例属性和数据描述符同名时，会优先访问数据描述符（如下面的math），而当实例属性和非数据描述符同名时，会优先访问实例属性（<code class="docutils literal notranslate"><span class="pre">__getattribute__</span></code>）</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">std</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="s1">&#39;xm&#39;</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std</span><span class="o">.</span><span class="n">math</span>
<span class="go">调用 __getattribute__</span>
<span class="go">访问数据描述符里的 __get__</span>
<span class="go">88</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std</span><span class="o">.</span><span class="n">chinese</span>
<span class="go">调用 __getattribute__</span>
<span class="go">99</span>
</pre></div>
</div>
<p>讲完了数据描述符和非数据描述符，我们还需要了解的对象属性的查找规律。</p>
<p>当我们对一个实例属性进行访问时，Python 会按 <code class="docutils literal notranslate"><span class="pre">obj.__dict__</span></code> →
<code class="docutils literal notranslate"><span class="pre">type(obj).__dict__</span></code> → <code class="docutils literal notranslate"><span class="pre">type(obj)的父类.__dict__</span></code>
顺序进行查找，如果查找到目标属性并发现是一个描述符，Python
会调用描述符协议来改变默认的控制行为。</p>
</div>
<div class="section" id="property">
<h4>3. 基于描述符如何实现property<a class="headerlink" href="#property" title="永久链接至标题">¶</a></h4>
<p>经过上面的讲解，我们已经知道如何定义描述符，且明白了描述符是如何工作的。</p>
<p>正常人所见过的描述符的用法就是上面提到的那些，我想说的是那只是描述符协议最常见的应用之一，或许你还不知道，其实有很多
Python 的特性的底层实现机制都是基于 <code class="docutils literal notranslate"><span class="pre">描述符协议</span></code>
的，比如我们熟悉的<code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> 、<code class="docutils literal notranslate"><span class="pre">&#64;classmethod</span></code>
、<code class="docutils literal notranslate"><span class="pre">&#64;staticmethod</span></code> 和 <code class="docutils literal notranslate"><span class="pre">super</span></code> 等。</p>
<p>先来说说 <code class="docutils literal notranslate"><span class="pre">property</span></code> 吧。</p>
<p>有了前面的基础，我们知道了 property
的基本用法。这里我直接切入主题，从第一篇的例子里精简了一下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_math</span>

    <span class="nd">@math.setter</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_math</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>不防再简单回顾一下它的用法，通过property装饰的函数，如例子中的 math
会变成 Student 实例的属性。而对 math 属性赋值会进入 使用 <code class="docutils literal notranslate"><span class="pre">math.setter</span></code>
装饰函数的逻辑代码块。</p>
<p>为什么说 property 底层是基于描述符协议的呢？通过 PyCharm 点击进入
property
的源码，很可惜，只是一份类似文档一样的伪源码，并没有其具体的实现逻辑。</p>
<p>不过，从这份伪源码的魔法函数结构组成，可以大体知道其实现逻辑。</p>
<p>这里我自己通过模仿其函数结构，结合「描述符协议」来自己实现类
<code class="docutils literal notranslate"><span class="pre">property</span></code> 特性。</p>
<p>代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fget</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fdel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="o">=</span> <span class="n">fget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fset</span> <span class="o">=</span> <span class="n">fset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdel</span> <span class="o">=</span> <span class="n">fdel</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in __get__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in __set__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fset</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in __delete__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdel</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fget</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in getter&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">fget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fset</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in setter&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">fset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deleter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fdel</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in deleter&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">fdel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<p>然后 Student 类，我们也相应改成如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="c1"># 其实只有这里改变</span>
    <span class="nd">@TestProperty</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_math</span>

    <span class="nd">@math.setter</span>
    <span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_math</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid value must be in [0, 100]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>为了尽量让你少产生一点疑惑，我这里做两点说明：</p>
<ol class="arabic simple">
<li><p>使用<code class="docutils literal notranslate"><span class="pre">TestProperty</span></code>装饰后，<code class="docutils literal notranslate"><span class="pre">math</span></code>
不再是一个函数，而是<code class="docutils literal notranslate"><span class="pre">TestProperty</span></code>
类的一个实例。所以第二个math函数可以使用 <code class="docutils literal notranslate"><span class="pre">math.setter</span></code>
来装饰，本质是调用<code class="docutils literal notranslate"><span class="pre">TestProperty.setter</span></code> 来产生一个新的
<code class="docutils literal notranslate"><span class="pre">TestProperty</span></code> 实例赋值给第二个<code class="docutils literal notranslate"><span class="pre">math</span></code>。</p></li>
<li><p>第一个 <code class="docutils literal notranslate"><span class="pre">math</span></code> 和第二个 <code class="docutils literal notranslate"><span class="pre">math</span></code> 是两个不同 <code class="docutils literal notranslate"><span class="pre">TestProperty</span></code>
实例。但他们都属于同一个描述符类（TestProperty），当对 math
对于赋值时，就会进入 <code class="docutils literal notranslate"><span class="pre">TestProperty.__set__</span></code>，当对math
进行取值里，就会进入
<code class="docutils literal notranslate"><span class="pre">TestProperty.__get__</span></code>。仔细一看，其实最终访问的还是Student实例的
<code class="docutils literal notranslate"><span class="pre">_math</span></code> 属性。</p></li>
</ol>
<p>说了这么多，还是运行一下，更加直观一点。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 运行后，会直接打印这一行，这是在实例化 TestProperty 并赋值给第二个math</span>
<span class="ow">in</span> <span class="n">setter</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s1</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="mi">90</span>
<span class="ow">in</span> <span class="fm">__set__</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">s1</span><span class="o">.</span><span class="n">math</span>
<span class="ow">in</span> <span class="fm">__get__</span>
<span class="mi">90</span>
</pre></div>
</div>
<p>对于以上理解 <code class="docutils literal notranslate"><span class="pre">property</span></code>
的运行原理有困难的同学，请务必参照我上面写的两点说明。如有其他疑问，可以加微信与我进行探讨。</p>
</div>
<div class="section" id="staticmethod">
<h4>4. 基于描述符如何实现staticmethod<a class="headerlink" href="#staticmethod" title="永久链接至标题">¶</a></h4>
<p>说完了 <code class="docutils literal notranslate"><span class="pre">property</span></code> ，这里再来讲讲 <code class="docutils literal notranslate"><span class="pre">&#64;classmethod</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&#64;staticmethod</span></code>
的实现原理。</p>
<p>我这里定义了一个类，用了两种方式来实现静态方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Test</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">myfunc</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

<span class="c1"># 上下两种写法等价</span>

<span class="k">class</span> <span class="nc">Test</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">myfunc</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
    <span class="c1"># 重点：这就是描述符的体现</span>
    <span class="n">myfunc</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">myfunc</span><span class="p">)</span>
</pre></div>
</div>
<p>这两种写法是等价的，就好像在 <code class="docutils literal notranslate"><span class="pre">property</span></code>
一样，其实以下两种写法也是等价的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@TestProperty</span>
<span class="k">def</span> <span class="nf">math</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_math</span>

<span class="n">math</span> <span class="o">=</span> <span class="n">TestProperty</span><span class="p">(</span><span class="n">fget</span><span class="o">=</span><span class="n">math</span><span class="p">)</span>
</pre></div>
</div>
<p>话题还是转回到 <code class="docutils literal notranslate"><span class="pre">staticmethod</span></code> 这边来吧。</p>
<p>由上面的注释，可以看出 <code class="docutils literal notranslate"><span class="pre">staticmethod</span></code>
其实就相当于一个描述符类，而<code class="docutils literal notranslate"><span class="pre">myfunc</span></code> 在此刻变成了一个描述符。关于
<code class="docutils literal notranslate"><span class="pre">staticmethod</span></code> 的实现，你可以参照下面这段我自己写的代码，加以理解。</p>
<p><img alt="image4" src="http://image.iswbm.com/20190519001930.png" /></p>
<p>调用这个方法可以知道，每调用一次，它都会经过描述符类的 <code class="docutils literal notranslate"><span class="pre">__get__</span></code> 。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Test</span><span class="o">.</span><span class="n">myfunc</span><span class="p">()</span>
<span class="go">in staticmethod __get__</span>
<span class="go">hello</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Test</span><span class="p">()</span><span class="o">.</span><span class="n">myfunc</span><span class="p">()</span>
<span class="go">in staticmethod __get__</span>
<span class="go">hello</span>
</pre></div>
</div>
</div>
<div class="section" id="classmethod">
<h4>5. 基于描述符如何实现classmethod<a class="headerlink" href="#classmethod" title="永久链接至标题">¶</a></h4>
<p>同样的 <code class="docutils literal notranslate"><span class="pre">classmethod</span></code> 也是一样。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">classmethod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in classmethod __get__&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newfunc</span>

<span class="k">class</span> <span class="nc">Test</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">myfunc</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

    <span class="c1"># 重点：这就是描述符的体现</span>
    <span class="n">myfunc</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="n">myfunc</span><span class="p">)</span>
</pre></div>
</div>
<p>验证结果如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Test</span><span class="o">.</span><span class="n">myfunc</span><span class="p">()</span>
<span class="go">in classmethod __get__</span>
<span class="go">hello</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Test</span><span class="p">()</span><span class="o">.</span><span class="n">myfunc</span><span class="p">()</span>
<span class="go">in classmethod __get__</span>
<span class="go">hello</span>
</pre></div>
</div>
<p>讲完了 <code class="docutils literal notranslate"><span class="pre">property</span></code>、<code class="docutils literal notranslate"><span class="pre">staticmethod</span></code>和<code class="docutils literal notranslate"><span class="pre">classmethod</span></code> 与
描述符的关系。我想你应该对描述符在 Python 中的应用有了更深的理解。对于
super 的实现原理，就交由你来自己完成。</p>
</div>
<div class="section" id="id4">
<h4>6. 所有实例共享描述符<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>通过以上内容的学习，你是不是觉得自己已经对描述符足够了解了呢？</p>
<p>可在这里，我想说以上的描述符代码都有问题。</p>
<p>问题在哪里呢？请看下面这个例子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Score</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>


<span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="n">math</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chinese</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">english</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student math:{}, chinese:{}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span><span class="p">)</span>
</pre></div>
</div>
<p>Student
里没有像前面那样写了构造函数，但是关键不在这儿，没写只是因为没必要写。</p>
<p>然后来看一下会出现什么样的问题呢</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span> <span class="o">=</span> <span class="n">Student</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span>
<span class="go">&lt;Student math:0, chinese:0, english:0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="mi">85</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span>
<span class="go">&lt;Student math:85, chinese:0, english:0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std2</span> <span class="o">=</span> <span class="n">Student</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std2</span> <span class="c1"># std2 居然共享了std1 的属性值</span>
<span class="go">&lt;Student math:85, chinese:0, english:0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std2</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="mi">100</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">std1</span> <span class="c1"># std2 也会改变std1 的属性值</span>
<span class="go">&lt;Student math:100, chinese:0, english:0&gt;</span>
</pre></div>
</div>
<p>从结果上来看，std2 居然共享了 std1
的属性值，只要其中一个实例的变量发生改变，另一个实例的变量也会跟着改变。</p>
<p>探其根因，是由于此时 math，chinese，english 三个全部是类变量，导致 std2
和 std1 在访问 math，chinese，english 这三个变量时，其实都是访问类变量。</p>
<p>问题是不是来了？小明和小强的分数怎么可能是绑定的呢？这很明显与实际业务不符。</p>
<p>使用描述符给我们制造了便利，却无形中给我们带来了麻烦，难道这也是描述符的特性吗？</p>
<p>描述符是个很好用的特性，会出现这个问题，是由于我们之前写的描述符代码都是错误的。</p>
<p>描述符的机制，在我看来，只是抢占了访问顺序，而具体的逻辑却要因地制宜，视情况而定。</p>
<p>如果要把 math，chinese，english
这三个变量变成实例之间相互隔离的属性，应该这么写。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Score</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">subject</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>


<span class="k">class</span> <span class="nc">Student</span><span class="p">:</span>
    <span class="n">math</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="s2">&quot;math&quot;</span><span class="p">)</span>
    <span class="n">chinese</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="s2">&quot;chinese&quot;</span><span class="p">)</span>
    <span class="n">english</span> <span class="o">=</span> <span class="n">Score</span><span class="p">(</span><span class="s2">&quot;english&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">chinese</span><span class="p">,</span> <span class="n">english</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">math</span> <span class="o">=</span> <span class="n">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span> <span class="o">=</span> <span class="n">chinese</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">english</span> <span class="o">=</span> <span class="n">english</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;Student math:{}, chinese:{}, english:{}&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">math</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chinese</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">english</span><span class="p">)</span>
</pre></div>
</div>
<p>引导程序逻辑进入描述符之后，不管你是获取属性，还是设置属性，都是直接作用于
instance 的。</p>
<p><img alt="image5" src="http://image.iswbm.com/20200812085823.png" /></p>
<p>这段代码，你可以仔细和前面的对比一下。</p>
<p>不难看出：</p>
<ul class="simple">
<li><p>之前的错误代码，更像是把描述符当做了存储节点。</p></li>
<li><p>之后的正确代码，则是把描述符直接当做代理，本身不存储值。</p></li>
</ul>
<p>以上便是我对描述符的全部分享，希望能对你有所帮助。</p>
<p><img alt="image6" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c04/c04_03"></span><div class="section" id="id1">
<h3>4.3 神奇的元类编程<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>1. 类是如何产生的<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>类是如何产生？这个问题也许你会觉得很傻。</p>
<p>实则不然，很多初学者只知道使用继承的表面形式来创建一个类，却不知道其内部真正的创建是由
<code class="docutils literal notranslate"><span class="pre">type</span></code> 来创建的。</p>
<p>type？这不是判断对象类型的函数吗？</p>
<p>是的，type通常用法就是用来判断对象的类型。但除此之外，他最大的用途是用来动态创建类。当Python扫描到class的语法的时候，就会调用type函数进行类的创建。</p>
</div>
<div class="section" id="type">
<h4>2. 如何使用type创建类<a class="headerlink" href="#type" title="永久链接至标题">¶</a></h4>
<p>首先，<code class="docutils literal notranslate"><span class="pre">type()</span></code> 需要接收三个参数</p>
<ol class="arabic simple">
<li><p>类的名称，若不指定，也要传入空字符串：<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></p></li>
<li><p>父类，注意以tuple的形式传入，若没有父类也要传入空tuple：<code class="docutils literal notranslate"><span class="pre">()</span></code>，默认继承object</p></li>
<li><p>绑定的方法或属性，注意以dict的形式传入</p></li>
</ol>
<p>来看个例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 准备一个基类（父类）</span>
<span class="k">class</span> <span class="nc">BaseClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">talk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;i am people&quot;</span><span class="p">)</span>

<span class="c1"># 准备一个方法</span>
<span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>

<span class="c1"># 使用type来创建User类</span>
<span class="n">User</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseClass</span><span class="p">,</span> <span class="p">),</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;say&quot;</span><span class="p">:</span><span class="n">say</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>3. 理解什么是元类<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>什么是类？可能谁都知道，类就是用来创建对象的「模板」。</p>
<p>那什么是元类呢？一句话通俗来说，元类就是创建类的「模板」。</p>
<p>为什么type能用来创建类？因为它本身是一个元类。使用元类创建类，那就合理了。</p>
<p>type是Python在背后用来创建所有类的元类，我们熟知的类的始祖 <code class="docutils literal notranslate"><span class="pre">object</span></code>
也是由type创建的。更有甚者，连type自己也是由type自己创建的，这就过份了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
<span class="go">&lt;class &#39;type&#39;&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
<span class="go">&lt;class &#39;type&#39;&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="go">&lt;class &#39;type&#39;&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="go">&lt;class &#39;type&#39;&gt;</span>
</pre></div>
</div>
<p>如果要形象的来理解的话，就看下面这三行话。</p>
<ul class="simple">
<li><p>str：用来创建字符串对象的类。</p></li>
<li><p>int：是用来创建整数对象的类。</p></li>
<li><p>type：是用来创建类对象的类。</p></li>
</ul>
<p>反过来看</p>
<ul class="simple">
<li><p>一个实例的类型，是类</p></li>
<li><p>一个类的类型，是元类</p></li>
<li><p>一个元类的类型，是type</p></li>
</ul>
<p>写个简单的小示例来验证下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MetaPerson</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaPerson</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Tom</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Tom</span><span class="p">))</span>
<span class="go">&lt;class &#39;__main__.Person&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Tom</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>
<span class="go">&lt;class &#39;__main__.MetaPerson&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Tom</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>
<span class="go">&lt;class &#39;type&#39;&gt;</span>
</pre></div>
</div>
<p>下面再来看一个稍微完整的</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 注意要从type继承</span>
<span class="k">class</span> <span class="nc">BaseClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in BaseClass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">BaseClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in User&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

<span class="c1"># in BaseClass</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;wangbm&quot;</span><span class="p">)</span>
<span class="c1"># in User</span>
</pre></div>
</div>
<p>综上，我们知道了类是元类的实例，所以在创建一个普通类时，其实会走元类的
<code class="docutils literal notranslate"><span class="pre">__new__</span></code>。</p>
<p>同时，我们又知道在类里实现了 <code class="docutils literal notranslate"><span class="pre">__call__</span></code>
就可以让这个类的实例变成可调用。</p>
<p>所以在我们对普通类进行实例化时，实际是对一个元类的实例（也就是普通类）进行直接调用，所以会走进元类的
<code class="docutils literal notranslate"><span class="pre">__call__</span></code></p>
<p>在这里可以借助 「单例的实现」举一个例子，你就清楚了</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MetaSingleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;cls:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;====1====&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_instance&quot;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;====2====&quot;</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaSingleton</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;====3====&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
<p>验证结果</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s1">&#39;wangbm1&#39;</span><span class="p">)</span>
<span class="go">cls:User</span>
<span class="go">====1====</span>
<span class="go">====2====</span>
<span class="go">====3====</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s1">&#39;wangbm2&#39;</span><span class="p">)</span>
<span class="go">cls:User</span>
<span class="go">====1====</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u2</span><span class="o">.</span><span class="n">age</span>
<span class="go">20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="ow">is</span> <span class="n">u2</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>4. 使用元类的意义<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>正常情况下，我们都不会使用到元类。但是这并不意味着，它不重要。假如某一天，我们需要写一个框架，很有可能就需要你对元类要有进一步的研究。</p>
<p>元类有啥用，用我通俗的理解，元类的作用过程：</p>
<ol class="arabic simple">
<li><p>拦截类的创建</p></li>
<li><p>拦截下后，进行修改</p></li>
<li><p>修改完后，返回修改后的类</p></li>
</ol>
<p>所以，很明显，为什么要用它呢？不要它会怎样？</p>
<p>使用元类，是要对类进行定制修改。使用元类来动态生成元类的实例，而99%的开发人员是不需要动态修改类的，因为这应该是框架才需要考虑的事。</p>
<p>但是，这样说，你一定不会服气，到底元类用来干什么？其实元类的作用就是<code class="docutils literal notranslate"><span class="pre">创建API</span></code>，一个最典型的应用是
<code class="docutils literal notranslate"><span class="pre">Django</span> <span class="pre">ORM</span></code>。</p>
</div>
<div class="section" id="orm">
<h4>5. 元类实战：ORM<a class="headerlink" href="#orm" title="永久链接至标题">¶</a></h4>
<p>使用过Django ORM的人都知道，有了ORM，使得我们操作数据库，变得异常简单。</p>
<p>ORM的一个类(User)，就对应数据库中的一张表。id,name,email,password
就是字段。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StrField</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StrField</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">StrField</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
</pre></div>
</div>
<p>如果我们要插入一条数据，我们只需这样做</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 实例化成一条记录</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">20180424</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xiaoming&quot;</span><span class="p">,</span>
         <span class="n">email</span><span class="o">=</span><span class="s2">&quot;xiaoming@163.com&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;abc123&quot;</span><span class="p">)</span>

<span class="c1"># 保存这条记录</span>
<span class="n">u</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>通常用户层面，只需要懂应用，就像上面这样操作就可以了。</p>
<p>但是今天我并不是来教大家如何使用ORM，我们是用来探究ORM内部究竟是如何实现的。我们也可以自己写一个简易的ORM。</p>
<p>从上面的<code class="docutils literal notranslate"><span class="pre">User</span></code>类中，我们看到<code class="docutils literal notranslate"><span class="pre">StrField</span></code>和<code class="docutils literal notranslate"><span class="pre">IntField</span></code>，从字段意思上看，我们很容易看出这代表两个字段类型。字段名分别是<code class="docutils literal notranslate"><span class="pre">id</span></code>,<code class="docutils literal notranslate"><span class="pre">username</span></code>,<code class="docutils literal notranslate"><span class="pre">email</span></code>,<code class="docutils literal notranslate"><span class="pre">password</span></code>。</p>
<p><code class="docutils literal notranslate"><span class="pre">StrField</span></code>和<code class="docutils literal notranslate"><span class="pre">IntField</span></code>在这里的用法，叫做<code class="docutils literal notranslate"><span class="pre">属性描述符</span></code>。
简单来说呢，<code class="docutils literal notranslate"><span class="pre">属性描述符</span></code>可以实现对属性值的类型，范围等一切做约束，意思就是说变量id只能是int类型，变量name只能是str类型，否则将会抛出异常。</p>
<p>那如何实现这两个<code class="docutils literal notranslate"><span class="pre">属性描述符</span></code>呢？请看代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numbers</span>

<span class="k">class</span> <span class="nc">Field</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">IntField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;int value need&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">class</span> <span class="nc">StrField</span><span class="p">(</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;string value need&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
<p>我们看到<code class="docutils literal notranslate"><span class="pre">User</span></code>类继承自<code class="docutils literal notranslate"><span class="pre">BaseModel</span></code>，这个<code class="docutils literal notranslate"><span class="pre">BaseModel</span></code>里，定义了数据库操作的各种方法，譬如我们使用的<code class="docutils literal notranslate"><span class="pre">save</span></code>函数，也可以放在这里面的。所以我们就可以来写一下这个<code class="docutils literal notranslate"><span class="pre">BaseModel</span></code>类</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ModelMetaClass</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># 这里执行赋值操作，会进行数据描述符的__set__逻辑</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_columns</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">db_values</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">db_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
            <span class="n">db_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">)))</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;insert into {table} ({columns}) values({values})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db_columns</span><span class="p">),</span>
                <span class="n">values</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">db_values</span><span class="p">))</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>从<code class="docutils literal notranslate"><span class="pre">BaseModel</span></code>类中，save函数里面有几个新变量。</p>
<ol class="arabic simple">
<li><p>fields: 存放所有的字段属性</p></li>
<li><p>db_table：表名</p></li>
</ol>
<p>我们思考一下这个<code class="docutils literal notranslate"><span class="pre">u</span></code>实例的创建过程：</p>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">ModelMetaClass</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">BaseModel</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">User</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">u</span></code></p>
<p>这里会有几个问题。</p>
<ul class="simple">
<li><p>init的参数是User实例时传入的，所以传入的id是int类型，name是str类型。看起来没啥问题，若是这样，我上面的数据描述符就失效了，不能起约束作用。所以我们希望init接收到的id是IntField类型，name是StrField类型。</p></li>
<li><p>同时，我们希望这些字段属性，能够自动归类到fields变量中。因为，做为BaseModel，它可不是专门为User类服务的，它还要兼容各种各样的表。不同的表，表里有不同数量，不同属性的字段，这些都要能自动类别并归类整理到一起。这是一个ORM框架最基本的。</p></li>
<li><p>我们希望对表名有两种选择，一个是User中若指定Meta信息，比如表名，就以此为表名，若未指定就以类名的小写
做为表名。虽然BaseModel可以直接取到User的db_table属性，但是如果在数据库业务逻辑中，加入这段复杂的逻辑，显然是很不优雅的。</p></li>
</ul>
<p>上面这几个问题，其实都可以通过元类的<code class="docutils literal notranslate"><span class="pre">__new__</span></code>函数来完成。</p>
<p>下面就来看看，如何用元类来解决这些问题呢？请看代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ModelMetaClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span>
            <span class="c1"># 第一次进入__new__是创建BaseModel类，name=&quot;BaseModel&quot;</span>
            <span class="c1"># 第二次进入__new__是创建User类及其实例，name=&quot;User&quot;</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># 根据属性类型，取出字段</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Field</span><span class="p">)}</span>

        <span class="c1"># 如果User中有指定Meta信息，比如表名，就以此为准</span>
        <span class="c1"># 如果没有指定，就默认以 类名的小写 做为表名，比如User类，表名就是user</span>
        <span class="n">_meta</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Meta&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;db_table&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">db_table</span> <span class="o">=</span> <span class="n">table</span>

        <span class="c1"># 注意原来由User传递过来的各项参数attrs，最好原模原样的返回，</span>
        <span class="c1"># 如果不返回，有可能下面的数据描述符不起作用</span>
        <span class="c1"># 除此之外，我们可以往里面添加我们自定义的参数</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;db_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_table</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="new">
<h4>6. __new__ 有什么用？<a class="headerlink" href="#new" title="永久链接至标题">¶</a></h4>
<p>在没有元类的情况下，每次创建实例，在先进入 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 之前都会先进入
<code class="docutils literal notranslate"><span class="pre">__new__</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in BaseClass&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;in User&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</pre></div>
</div>
<p>使用如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s1">&#39;wangbm&#39;</span><span class="p">)</span>
<span class="go">in BaseClass</span>
<span class="go">in User</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;wangbm&#39;</span>
</pre></div>
</div>
<p>在有元类的情况下，每次创建类时，会都先进入 元类的 <code class="docutils literal notranslate"><span class="pre">__new__</span></code>
方法，如果你要对类进行定制，可以在这时做一些手脚。</p>
<p>综上，元类的<code class="docutils literal notranslate"><span class="pre">__new__</span></code>和普通类的不一样：</p>
<ul class="simple">
<li><p>元类的<code class="docutils literal notranslate"><span class="pre">__new__</span></code>
在创建类时就会进入，它可以获取到上层类的一切属性和方法，包括类名，魔法方法。</p></li>
<li><p>而普通类的<code class="docutils literal notranslate"><span class="pre">__new__</span></code>
在实例化时就会进入，它仅能获取到实例化时外界传入的属性。</p></li>
</ul>
</div>
<div class="section" id="id5">
<h4>附录：参考文章<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="http://python3-cookbook.readthedocs.io/zh_CN/latest/chapters/p09_meta_programming.html">Python Cookbook -
元编程</a></p></li>
<li><p><a class="reference external" href="http://blog.jobbole.com/21351/">深刻理解Python中的元类</a></p></li>
</ul>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p05"></span><div class="section" id="id1">
<h2>第五章：魔法开发技巧<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节可能会是很多人感兴趣的，因为里面介绍的是所有开发者都有可能用到的开发技巧，掌握这些代码编写技巧，对提高你代码的可读性、优雅性会很有帮助。</p>
<p>本章节，会持续更新，敬请关注…</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c05/c05_01"></span><div class="section" id="id1">
<h3>5.1 嵌套上下文管理的另类写法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当我们要写一个嵌套的上下文管理器时，可能会这样写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">test_context</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;enter, my name is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">yield</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;exit, my name is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

<span class="k">with</span> <span class="n">test_context</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">test_context</span><span class="p">(</span><span class="s1">&#39;bbb&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;========== in main ============&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>输出结果如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">enter</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">aaa</span>
<span class="n">enter</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">bbb</span>
<span class="o">==========</span> <span class="ow">in</span> <span class="n">main</span> <span class="o">============</span>
<span class="nb">exit</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">bbb</span>
<span class="nb">exit</span><span class="p">,</span> <span class="n">my</span> <span class="n">name</span> <span class="ow">is</span> <span class="n">aaa</span>
</pre></div>
</div>
<p>除此之外，你可知道，还有另一种嵌套写法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">test_context</span><span class="p">(</span><span class="s1">&#39;aaa&#39;</span><span class="p">),</span> <span class="n">test_context</span><span class="p">(</span><span class="s1">&#39;bbb&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;========== in main ============&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_02"></span><div class="section" id="for">
<h3>5.2 将嵌套 for 循环写成单行<a class="headerlink" href="#for" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>我们经常会如下这种嵌套的 for 循环代码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list1</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">list2</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">list3</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item1</span> <span class="ow">in</span> <span class="n">list1</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item2</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item3</span> <span class="ow">in</span> <span class="n">list3</span><span class="p">:</span>
              <span class="k">print</span><span class="p">(</span><span class="n">item1</span><span class="o">+</span><span class="n">item2</span><span class="o">+</span><span class="n">item3</span><span class="p">)</span>
</pre></div>
</div>
<p>这里仅仅是三个 for 循环，在实际编码中，有可能会有更层。</p>
<p>这样的代码，可读性非常的差，很多人不想这么写，可又没有更好的写法。</p>
<p>这里介绍一种我常用的写法，使用 itertools 这个库来实现更优雅易读的代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="n">list1</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">list2</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">list3</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
<span class="k">for</span> <span class="n">item1</span><span class="p">,</span><span class="n">item2</span><span class="p">,</span><span class="n">item3</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">,</span> <span class="n">list3</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item1</span><span class="o">+</span><span class="n">item2</span><span class="o">+</span><span class="n">item3</span><span class="p">)</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
<span class="m">12</span>
<span class="m">13</span>
<span class="m">13</span>
<span class="m">14</span>
<span class="m">13</span>
<span class="m">14</span>
<span class="m">14</span>
<span class="m">15</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_03"></span><div class="section" id="for">
<h3>5.3 单行实现 for 死循环如何写？<a class="headerlink" href="#for" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>如果让你在不借助 while ，只使用 for 来写一个死循环？</p>
<p><strong>你会写吗？</strong></p>
<p><strong>如果你还说简单，你可以自己试一下。</strong></p>
<p>…</p>
<p>如果你尝试后，仍然写不出来，那我给出自己的做法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span><span class="k">pass</span>
</pre></div>
</div>
<p><strong>是不是傻了？iter 还有这种用法？这为啥是个死循环？</strong></p>
<p>关于这个问题，你如果看中文网站，可能找不到相关资料。</p>
<p>还好你可以通过 IDE 看py源码里的注释内容，介绍了很详细的使用方法。</p>
<p>原来iter有两种使用方法。</p>
<ul class="simple">
<li><p>通常我们的认知是第一种，将一个列表转化为一个迭代器。</p></li>
<li><p>而第二种方法，他接收一个 callable对象，和一个sentinel
参数。第一个对象会一直运行，直到它返回 sentinel 值才结束。</p></li>
</ul>
<p>那<code class="docutils literal notranslate"><span class="pre">int</span></code> 呢？</p>
<p>这又是一个知识点，int
是一个内建方法。通过看注释，可以看出它是有默认值0的。你可以在console
模式下输入 <code class="docutils literal notranslate"><span class="pre">int()</span></code> 看看是不是返回0。</p>
<p>由于int() 永远返回0，永远返回不了1，所以这个 for
循环会没有终点。一直运行下去。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_04"></span><div class="section" id="id1">
<h3>5.4 如何关闭异常自动关联上下文？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你在处理异常时，由于处理不当或者其他问题，再次抛出另一个异常时，往外抛出的异常也会携带原始的异常信息。</p>
<p>就像这样子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something bad happened&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>从输出可以看到两个异常信息</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;demo.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
<span class="ne">ZeroDivisionError</span><span class="p">:</span> <span class="n">division</span> <span class="n">by</span> <span class="n">zero</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;demo.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">4</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something bad happened&quot;</span><span class="p">)</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">Something</span> <span class="n">bad</span> <span class="n">happened</span>
</pre></div>
</div>
<p>如果在异常处理程序或 finally
块中引发异常，默认情况下，异常机制会隐式工作会将先前的异常附加为新异常的
<code class="docutils literal notranslate"><span class="pre">__context__</span></code>属性。这就是 Python 默认开启的自动关联异常上下文。</p>
<p>如果你想自己控制这个上下文，可以加个 from 关键字（<code class="docutils literal notranslate"><span class="pre">from</span></code>
语法会有个限制，就是第二个表达式必须是另一个异常类或实例。），来表明你的新异常是直接由哪个异常引起的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something bad happened&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;demo.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
<span class="ne">ZeroDivisionError</span><span class="p">:</span> <span class="n">division</span> <span class="n">by</span> <span class="n">zero</span>

<span class="n">The</span> <span class="n">above</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">the</span> <span class="n">direct</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">exception</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;demo.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">4</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something bad happened&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">Something</span> <span class="n">bad</span> <span class="n">happened</span>
</pre></div>
</div>
<p>当然，你也可以通过<code class="docutils literal notranslate"><span class="pre">with_traceback()</span></code>方法为异常设置上下文<code class="docutils literal notranslate"><span class="pre">__context__</span></code>属性，这也能在<code class="docutils literal notranslate"><span class="pre">traceback</span></code>更好的显示异常信息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bad thing&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<p>最后，如果我想彻底关闭这个自动关联异常上下文的机制？有什么办法呢？</p>
<p>可以使用 <code class="docutils literal notranslate"><span class="pre">raise...from</span> <span class="pre">None</span></code>，从下面的例子上看，已经没有了原始异常</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>$ cat demo.py
try:
    print(1 / 0)
except Exception as exc:
    raise RuntimeError(&quot;Something bad happened&quot;) from None
$
$ python demo.py
Traceback (most recent call last):
  File &quot;demo.py&quot;, line 4, in &lt;module&gt;
    raise RuntimeError(&quot;Something bad happened&quot;) from None
RuntimeError: Something bad happened
(PythonCodingTime)
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_05"></span><div class="section" id="id1">
<h3>5.5 自带的缓存机制不用白不用<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>缓存是一种将定量数据加以保存，以备迎合后续获取需求的处理方式，旨在加快数据获取的速度。</p>
<p>数据的生成过程可能需要经过计算，规整，远程获取等操作，如果是同一份数据需要多次使用，每次都重新生成会大大浪费时间。所以，如果将计算或者远程请求等操作获得的数据缓存下来，会加快后续的数据获取需求。</p>
<p>为了实现这个需求，Python 3.2 +
中给我们提供了一个机制，可以很方便的实现，而不需要你去写这样的逻辑代码。</p>
<p>这个机制实现于 functool 模块中的 lru_cache 装饰器。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@functools.lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">typed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>参数解读：</p>
<ul class="simple">
<li><p>maxsize：最多可以缓存多少个此函数的调用结果，如果为None，则无限制，设置为
2 的幂时，性能最佳</p></li>
<li><p>typed：若为 True，则不同参数类型的调用将分别缓存。</p></li>
</ul>
<p>举个例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;calculating: </span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>输出如下，可以看到第二次调用并没有真正的执行函数体，而是直接返回缓存里的结果</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>calculating: <span class="m">1</span> + <span class="m">2</span>
<span class="m">3</span>
<span class="m">3</span>
calculating: <span class="m">2</span> + <span class="m">3</span>
<span class="m">5</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_06"></span><div class="section" id="g">
<h3>5.6 如何流式读取数G超大文件<a class="headerlink" href="#g" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>使用 with…open… 可以从一个文件中读取数据，这是所有 Python
开发者都非常熟悉的操作。</p>
<p>但是如果你使用不当，也会带来很大的麻烦。</p>
<p>比如当你使用了 read 函数，其实 Python
会将文件的内容一次性的全部载入内存中，如果文件有 10
个G甚至更多，那么你的电脑就要消耗的内存非常巨大。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 一次性读取</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;big_file.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>对于这个问题，你也许会想到使用 readline 去做一个生成器来逐行返回。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</pre></div>
</div>
<p>可如果这个文件内容就一行呢，一行就
10个G，其实你还是会一次性读取全部内容。</p>
<p>最优雅的解决方法是，在使用 read
方法时，指定每次只读取固定大小的内容，比如下面的代码中，每次只读取 8kb
返回。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">yield</span> <span class="n">chunk</span>
</pre></div>
</div>
<p>上面的代码，功能上已经没有问题了，但是代码看起来代码还是有些臃肿。</p>
<p>借助偏函数 和 iter 函数可以优化一下代码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="k">def</span> <span class="nf">read_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">block_size</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>
</pre></div>
</div>
<p>如果你使用的是 Python 3.8
+，还有一种更直观、易于理解的写法，既不用使用偏函数，也不用掌握 iter
这种另类的用法。而只要用利用 海象运算符就可以，具体代码如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">chunk</span> <span class="p">:</span><span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_07"></span><div class="section" id="defer">
<h3>5.7 实现类似 defer 的延迟调用<a class="headerlink" href="#defer" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在 Golang 中有一种延迟调用的机制，关键字是 defer，例如下面的示例</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">func</span> <span class="nx">myfunc</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">myfunc</span><span class="p">()</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>输出如下，myfunc 的调用会在函数返回前一步完成，即使你将 myfunc
的调用写在函数的第一行，这就是延迟调用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span>
<span class="n">B</span>
</pre></div>
</div>
<p>那么在 Python 中否有这种机制呢？</p>
<p>当然也有，只不过并没有 Golang 这种简便。</p>
<p>在 Python 可以使用 <strong>上下文管理器</strong> 达到这种效果</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span>
<span class="n">B</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_08"></span><div class="section" id="id1">
<h3>5.8 如何快速计算函数运行时间<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>计算一个函数的运行时间，你可能会这样子做</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># run the function</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>你看看你为了计算函数运行时间，写了几行代码了。 ​
有没有一种方法可以更方便的计算这个运行时间呢？ ​ 有。 ​ 有一个内置模块叫
timeit ​ 使用它，只用一行代码即可</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">timeit</span>

<span class="k">def</span> <span class="nf">run_sleep</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

<span class="c1"># 只用这一行</span>
<span class="k">print</span><span class="p">(</span><span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span><span class="n">run_sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">number</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>运行结果如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>
<span class="mi">2</span>
<span class="mi">2</span>
<span class="mi">2</span>
<span class="mi">2</span>
<span class="mf">10.020059824</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_09"></span><div class="section" id="id1">
<h3>5.9 重定向标准输出到日志<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>假设你有一个脚本，会执行一些任务，比如说集群健康情况的检查。</p>
<p>检查完成后，会把各服务的的健康状况以 JSON 字符串的形式打印到标准输出。</p>
<p>如果代码有问题，导致异常处理不足，最终检查失败，是很有可能将一些错误异常栈输出到标准错误或标准输出上。</p>
<p>由于最初约定的脚本返回方式是以 JSON
的格式输出，此时你的脚本却输出各种错误异常，异常调用方也无法解析。</p>
<p>如何避免这种情况的发生呢？</p>
<p>我们可以这样做，把你的标准错误输出到日志文件中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;/var/log/you.log&quot;</span>

<span class="k">def</span> <span class="nf">you_task</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">close_stdout</span><span class="p">():</span>
    <span class="n">raw_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">file</span>

    <span class="k">yield</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">raw_stdout</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">with</span> <span class="n">close_stdout</span><span class="p">():</span>
    <span class="n">you_task</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_10"></span><div class="section" id="id1">
<h3>5.10 快速定位错误进入调试模式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你在写一个程序时，最初的程序一定遇到不少零零散散的错误，这时候就免不了调试一波。</p>
<p>如果你和我一样，习惯使用 pdb
进行调试的话，一定有所体会，通常我们都要先把 <code class="docutils literal notranslate"><span class="pre">pdb.set_trace()</span></code>
去掉，让程序畅通无阻，直到它把异常抛出来。</p>
<p>出现异常后，再使用 vim 跳转到抛出异常的位置，敲入
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">pdb;pdb.set_trace()</span></code>
，然后再到运行，进入调试模式，找到问题并修改代码后再去掉我们加上的那行
pdb 的代码。</p>
<p>如此反复这样一个过程，直到最后程序没有异常。</p>
<p>你应该能够感受到这个过程有多繁锁，令人崩溃。</p>
<p>接下来介绍一种，可以让你不需要修改源代码，就可以在异常抛出时，快速切换到调试模式，进入
『案发现场』排查问题。</p>
<p>方法很简单，只需要你在执行脚本时，加入 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 参考</p>
<p><img alt="image1" src="http://image.iswbm.com/20200615235900.png" /></p>
<p>如果你的程序没有任何问题，加上 <code class="docutils literal notranslate"><span class="pre">-i</span></code> 后又会有什么不一样呢？</p>
<p>从下图可以看出，程序执行完成后会自动进入 console 交互模式。</p>
<p><img alt="image2" src="http://image.iswbm.com/image-20200616000039009.png" /></p>
<p><img alt="image3" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_11"></span><div class="section" id="id1">
<h3>5.11 在程序退出前执行代码的技巧<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>使用 atexit 这个内置模块，可以很方便的注册退出函数。</p>
<p>不管你在哪个地方导致程序崩溃，都会执行那些你注册过的函数。</p>
<p>示例如下</p>
<p><img alt="image1" src="http://image.iswbm.com/20200510112133.png" /></p>
<p>如果<code class="docutils literal notranslate"><span class="pre">clean()</span></code>函数有参数，那么你可以不用装饰器，而是直接调用<code class="docutils literal notranslate"><span class="pre">atexit.register(clean_1,</span> <span class="pre">参数1,</span> <span class="pre">参数2,</span> <span class="pre">参数3='xxx')</span></code>。</p>
<p>可能你有其他方法可以处理这种需求，但肯定比上不使用 atexit
来得优雅，来得方便，并且它很容易扩展。</p>
<p>但是使用 atexit 仍然有一些局限性，比如：</p>
<ul class="simple">
<li><p>如果程序是被你没有处理过的系统信号杀死的，那么注册的函数无法正常执行。</p></li>
<li><p>如果发生了严重的 Python 内部错误，你注册的函数无法正常执行。</p></li>
<li><p>如果你手动调用了<code class="docutils literal notranslate"><span class="pre">os._exit()</span></code>，你注册的函数无法正常执行。</p></li>
</ul>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_12"></span><div class="section" id="id1">
<h3>5.12 逗号也有它的独特用法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>逗号，虽然是个很不起眼的符号，但在 Python 中也有他的用武之地。</p>
<p><strong>第一个用法</strong></p>
<p>元组的转化</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo.py</span>
def func<span class="o">()</span>:
    <span class="k">return</span> <span class="s2">&quot;ok&quot;</span>,

print<span class="o">(</span>func<span class="o">())</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># python3 demo.py</span>
<span class="o">(</span><span class="s1">&#39;ok&#39;</span>,<span class="o">)</span>
</pre></div>
</div>
<p><strong>第二个用法</strong>r</p>
<p>print 的取消换行</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo.py</span>
<span class="k">for</span> i in range<span class="o">(</span><span class="m">3</span><span class="o">)</span>:
    print i
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># python demo.py</span>
<span class="m">0</span>
<span class="m">1</span>
<span class="m">2</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># vim demo.py</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat demo.py</span>
<span class="k">for</span> i in range<span class="o">(</span><span class="m">3</span><span class="o">)</span>:
    print i,
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># python demo.py</span>
<span class="m">0</span> <span class="m">1</span> <span class="m">2</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_13"></span><div class="section" id="id1">
<h3>5.13 如何在运行状态查看源代码？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>查看函数的源代码，我们通常会使用 IDE 来完成。</p>
<p>比如在 PyCharm 中，你可以 Ctrl + 鼠标点击 进入函数的源代码。</p>
<p>那如果没有 IDE 呢？</p>
<p>当我们想使用一个函数时，如何知道这个函数需要接收哪些参数呢？</p>
<p>当我们在使用函数时出现问题的时候，如何通过阅读源代码来排查问题所在呢？</p>
<p>这时候，我们可以使用 inspect 来代替 IDE 帮助你完成这些事</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># demo.py</span>
<span class="kn">import</span> <span class="nn">inspect</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;===================&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">add</span><span class="p">))</span>
</pre></div>
</div>
<p>运行结果如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
<span class="o">===================</span>
def add<span class="o">(</span>x, y<span class="o">)</span>:
    <span class="k">return</span> x + y
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_14"></span><div class="section" id="id1">
<h3>5.14 单分派泛函数如何写？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>泛型，如果你尝过java，应该对他不陌生吧。但你可能不知道在 Python 中（3.4+
），也可以实现 简单的泛型函数。</p>
<p>在Python中只能实现基于单个（第一个）参数的数据类型来选择具体的实现方式，官方名称
是
<code class="docutils literal notranslate"><span class="pre">single-dispatch</span></code>。你或许听不懂，说人话，就是可以实现第一个参数的数据类型不同，其调用的函数也就不同。</p>
<p><code class="docutils literal notranslate"><span class="pre">singledispatch</span></code> 是 PEP443 中引入的，如果你对此有兴趣，PEP443
应该是最好的学习文档：<a class="reference external" href="https://www.python.org/dev/peps/pep-0443/">https://www.python.org/dev/peps/pep-0443/</a></p>
<p>它使用方法极其简单，只要被<code class="docutils literal notranslate"><span class="pre">singledispatch</span></code>
装饰的函数，就是一个<code class="docutils literal notranslate"><span class="pre">single-dispatch</span></code>
的泛函数（<code class="docutils literal notranslate"><span class="pre">generic</span> <span class="pre">functions</span></code>）。</p>
<ul class="simple">
<li><p><strong>单分派</strong>：根据一个参数的类型，以不同方式执行相同的操作的行为。</p></li>
<li><p><strong>多分派</strong>：可根据多个参数的类型选择专门的函数的行为。</p></li>
<li><p><strong>泛函数</strong>：多个函数绑在一起组合成一个泛函数。</p></li>
</ul>
<p>这边举个简单的例子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">singledispatch</span>

<span class="nd">@singledispatch</span>
<span class="k">def</span> <span class="nf">age</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;请传入合法类型的参数！&#39;</span><span class="p">)</span>

<span class="nd">@age.register</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;我已经{}岁了。&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">))</span>

<span class="nd">@age.register</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;I am {} years old.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">))</span>


<span class="n">age</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>  <span class="c1"># int</span>
<span class="n">age</span><span class="p">(</span><span class="s1">&#39;twenty three&#39;</span><span class="p">)</span>  <span class="c1"># str</span>
<span class="n">age</span><span class="p">([</span><span class="s1">&#39;23&#39;</span><span class="p">])</span>  <span class="c1"># list</span>
</pre></div>
</div>
<p>执行结果</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>我已经23岁了。
I am twenty three years old.
请传入合法类型的参数！
</pre></div>
</div>
<p>说起泛型，其实在 Python 本身的一些内建函数中并不少见，比如 <code class="docutils literal notranslate"><span class="pre">len()</span></code> ，
<code class="docutils literal notranslate"><span class="pre">iter()</span></code>，<code class="docutils literal notranslate"><span class="pre">copy.copy()</span></code> ，<code class="docutils literal notranslate"><span class="pre">pprint()</span></code> 等</p>
<p>你可能会问，它有什么用呢？实际上真没什么用，你不用它或者不认识它也完全不影响你编码。</p>
<p>我这里举个例子，你可以感受一下。</p>
<p>大家都知道，Python 中有许许多的数据类型，比如 str，list， dict， tuple
等，不同数据类型的拼接方式各不相同，所以我这里我写了一个通用的函数，可以根据对应的数据类型对选择对应的拼接方式拼接，而且不同数据类型我还应该提示无法拼接。以下是简单的实现。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg2</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;【错误】：参数类型不同，无法拼接!!&#39;</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="nd">@singledispatch</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span>

<span class="nd">@add.register</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="nd">@check_type</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">+=</span> <span class="n">new_obj</span>
    <span class="k">return</span> <span class="n">obj</span>


<span class="nd">@add.register</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="nd">@check_type</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="nd">@add.register</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="nd">@check_type</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="nd">@add.register</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
<span class="nd">@check_type</span>
<span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">new_obj</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span><span class="s1">&#39;, world&#39;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;wangbm&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">}))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">((</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;huawei&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vivo&#39;</span><span class="p">,</span> <span class="s1">&#39;oppo&#39;</span><span class="p">)))</span>

<span class="c1"># list 和 字符串 无法拼接</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;4,5,6&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>输出结果如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hello, world
[1, 2, 3, 4, 5, 6]
{&#39;name&#39;: &#39;wangbm&#39;, &#39;age&#39;: 25}
(&#39;apple&#39;, &#39;huawei&#39;, &#39;vivo&#39;, &#39;oppo&#39;)
【错误】：参数类型不同，无法拼接!!
</pre></div>
</div>
<p>如果不使用singledispatch 的话，你可能会写出这样的代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg2</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;【错误】：参数类型不同，无法拼接!!&#39;</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="nd">@check_type</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">obj</span> <span class="o">+=</span> <span class="n">new_obj</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">new_obj</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span><span class="s1">&#39;, world&#39;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;wangbm&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">25</span><span class="p">}))</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">((</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;huawei&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vivo&#39;</span><span class="p">,</span> <span class="s1">&#39;oppo&#39;</span><span class="p">)))</span>

<span class="c1"># list 和 字符串 无法拼接</span>
<span class="k">print</span><span class="p">(</span><span class="n">add</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;4,5,6&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hello, world
[1, 2, 3, 4, 5, 6]
{&#39;name&#39;: &#39;wangbm&#39;, &#39;age&#39;: 25}
(&#39;apple&#39;, &#39;huawei&#39;, &#39;vivo&#39;, &#39;oppo&#39;)
【错误】：参数类型不同，无法拼接!!
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_15"></span><div class="section" id="id1">
<h3>5.15 让我爱不释手的用户环境<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你在机器上并没有 root 权限时，如何安装 Python 的第三方包呢？</p>
<p>可以使用 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">--user</span> <span class="pre">pkg</span></code>
将你的包安装在你的用户环境中，该用户环境与全局环境并不冲突，并且多用户之间相互隔离，互不影响。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在全局环境中未安装 requests</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span>$ pip list <span class="p">|</span> grep requests
<span class="o">[</span>root@localhost ~<span class="o">]</span>$ su - wangbm

<span class="c1"># 由于用户环境继承自全局环境，这里也未安装</span>
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ pip list <span class="p">|</span> grep requests
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ pip install --user requests
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ pip list <span class="p">|</span> grep requests
requests <span class="o">(</span><span class="m">2</span>.22.0<span class="o">)</span>
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$

<span class="c1"># 从 Location 属性可发现 requests 只安装在当前用户环境中</span>
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ pip show requests
---
Metadata-Version: <span class="m">2</span>.1
Name: requests
Version: <span class="m">2</span>.22.0
Summary: Python HTTP <span class="k">for</span> Humans.
Home-page: http://python-requests.org
Author: Kenneth Reitz
Author-email: me@kennethreitz.org
Installer: pip
License: Apache <span class="m">2</span>.0
Location: /home/wangbm/.local/lib/python2.7/site-packages
<span class="o">[</span>wangbm@localhost ~<span class="o">]</span>$ <span class="nb">exit</span>
<span class="nb">logout</span>

<span class="c1"># 退出 wangbm 用户，在 root 用户环境中发现 requests 未安装</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span>$ pip list <span class="p">|</span> grep requests
<span class="o">[</span>root@localhost ~<span class="o">]</span>$
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_16"></span><div class="section" id="id1">
<h3>5.16 字符串的分割技巧<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当我们对字符串进行分割时，且分割符是
<code class="docutils literal notranslate"><span class="pre">\n</span></code>，有可能会出现这样一个窘境：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;a</span><span class="se">\n</span><span class="s2">b</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="go">a</span>
<span class="go">b</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="go">[&#39;a&#39;, &#39;b&#39;, &#39;&#39;]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>会在最后一行多出一个元素，为了应对这种情况，你可以会多加一步处理。</p>
<p>但我想说的是，完成没有必要，对于这个场景，你可以使用 <code class="docutils literal notranslate"><span class="pre">splitlines</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="go">[&#39;a&#39;, &#39;b&#39;]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_17"></span><div class="section" id="id1">
<h3>5.17 反转字符串/列表最优雅的方式<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>反转序列并不难，但是如何做到最优雅呢？</p>
<p>先来看看，正常是如何反转的。</p>
<p>最简单的方法是使用列表自带的reverse()方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ml</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ml</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ml</span>
<span class="go">[5, 4, 3, 2, 1]</span>
</pre></div>
</div>
<p>但如果你要处理的是字符串，reverse就无能为力了。你可以尝试将其转化成list，再reverse，然后再转化成str。转来转去，也太麻烦了吧？需要这么多行代码（后面三行是不能合并成一行的），一点都不Pythonic。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mstr1</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span>
<span class="n">ml1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mstr1</span><span class="p">)</span>
<span class="n">ml1</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
<span class="n">mstr2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ml1</span><span class="p">)</span>
</pre></div>
</div>
<p>对于字符串还有一种稍微复杂一点的，是自定义递归函数来实现。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_reverse</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">my_reverse</span><span class="p">(</span><span class="nb">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="nb">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>在这里，介绍一种最优雅的反转方式，使用切片，不管你是字符串，还是列表，简直通杀。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mstr</span> <span class="o">=</span> <span class="s1">&#39;abc&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ml</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mstr</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&#39;cba&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ml</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">[3, 2, 1]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_18"></span><div class="section" id="print">
<h3>5.18 如何将 print 内容输出到文件<a class="headerlink" href="#print" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>Python 3 中的 print
作为一个函数，由于可以接收更多的参数，所以功能变为更加强大。</p>
<p>比如今天要说的使用 print
将你要打印的内容，输出到日志文件中（但是我并不推荐使用它）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test.log&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hello, python&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">exit</span><span class="p">()</span>

<span class="go">$ cat test.log</span>
<span class="go">hello, python</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_19"></span><div class="section" id="id1">
<h3>5.19 改变默认递归次数限制<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>上面才提到递归，大家都知道使用递归是有风险的，递归深度过深容易导致堆栈的溢出。如果你这字符串太长啦，使用递归方式反转，就会出现问题。</p>
<p>那到底，默认递归次数限制是多少呢？</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">getrecursionlimit</span><span class="p">()</span>
<span class="go">1000</span>
</pre></div>
</div>
<p>可以查，当然也可以自定义修改次数，退出即失效。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">getrecursionlimit</span><span class="p">()</span>
<span class="go">2000</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_20"></span><div class="section" id="else">
<h3>5.20 让你晕头转向的 else 用法<a class="headerlink" href="#else" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>if else 用法可以说最基础的语法表达式之一，但是今天不是讲这个的。</p>
<p>if else 早已烂大街，但我相信仍然有很多人都不曾见过 for else 和 try else
的用法。为什么说它曾让我晕头转向，因为它不像 if else
那么直白，非黑即白，脑子经常要想一下才能才反应过来代码怎么走。</p>
<p>先来说说，for … else …</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_item</span><span class="p">(</span><span class="n">source_list</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">source_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Exists!&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Does not exist&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>在往下看之前，你可以思考一下，什么情况下才会走 else。是循环被
break，还是没有break？</p>
<p>给几个例子，你体会一下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">check_item</span><span class="p">([</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;huawei&quot;</span><span class="p">,</span> <span class="s2">&quot;oppo&quot;</span><span class="p">],</span> <span class="s2">&quot;oppo&quot;</span><span class="p">)</span>
<span class="c1"># Exists!</span>

<span class="n">check_item</span><span class="p">([</span><span class="s2">&quot;apple&quot;</span><span class="p">,</span> <span class="s2">&quot;huawei&quot;</span><span class="p">,</span> <span class="s2">&quot;oppo&quot;</span><span class="p">],</span> <span class="s2">&quot;vivo&quot;</span><span class="p">)</span>
<span class="c1"># Does not exist</span>
</pre></div>
</div>
<p>可以看出，没有被 break 的程序才会正常走else流程。</p>
<p>再来看看，try else 用法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_try_else</span><span class="p">(</span><span class="n">attr1</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attr1</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Exception occurred...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No Exception occurred...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>同样来几个例子。当不传参数时，就抛出异常。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_try_else</span><span class="p">()</span>
<span class="c1"># Exception occurred...</span>

<span class="n">test_try_else</span><span class="p">(</span><span class="s2">&quot;ming&quot;</span><span class="p">)</span>
<span class="c1"># No Exception occurred...</span>
</pre></div>
</div>
<p>可以看出，没有 try 里面的代码块没有抛出异常的，会正常走else。</p>
<p>总结一下，for else 和 try else 相同，只要代码正常走下去不被
break，不抛出异常，就可以走else。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_21"></span><div class="section" id="key">
<h3>5.21 字典访问不存在的key时不再报错<a class="headerlink" href="#key" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当一个字典里没有某个 key 时，此时你访问他是会报 KeyError 的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">=</span><span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">KeyError</span>: <span class="n">&#39;age&#39;</span>
</pre></div>
</div>
<p>这里有一个小技巧，使用 collections 的 defaultdict
方法，可以帮你处理这个小问题，当你访问一个不存在的 key
时，会返回默认值。</p>
<p>defaultdict 接收一个工厂方法，工厂方法返回的对象就是字典的默认值。</p>
<p>常用的工厂方法有，我们常见的 int，str，bool 等</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="nb">int</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">0</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">=</span><span class="nb">str</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span>
<span class="go">&#39;&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">=</span><span class="nb">bool</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span>
<span class="go">False</span>
</pre></div>
</div>
<p>因为 defaultdict 可以这样子用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">collections</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">defaultdict(&lt;class &#39;int&#39;&gt;, {})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">defaultdict(&lt;class &#39;str&#39;&gt;, {})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<span class="go">&#39;&#39;</span>
</pre></div>
</div>
<p>当然既然是工厂方法，你也可以使用 lambda
匿名函数来实现自定义的效果，比如我们使用 str
就会设置一个空字符串，但这并不是我想要的，我想要的是设置一个其他字符串，你就可以像下面这样子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">info</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;default value&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">info</span>
<span class="go">defaultdict(&lt;function &lt;lambda&gt; at 0x10ff10488&gt;, {})</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span>
<span class="go">&#39;default value&#39;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_22"></span><div class="section" id="id1">
<h3>5.22 如何实现函数的连续调用？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>现在我想写一个函数可以实现把所有的数进行求和，并且可以达到反复调用的目的。</p>
<p>比如这样子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="mi">3</span><span class="p">)(</span><span class="mi">4</span><span class="p">)(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">6</span><span class="p">)(</span><span class="mi">7</span><span class="p">)</span>
<span class="go">27</span>
</pre></div>
</div>
<p>当只调用一次时，也必须适用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">2</span>
</pre></div>
</div>
<p>每次调用的返回结果都是一个 int
类型的实例，要实现将一个实例看做一个函数一样调用，那就不得不使用到
<code class="docutils literal notranslate"><span class="pre">__call__</span></code> 这个魔法方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">AddInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;calling __call__ function&quot;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">AddInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numerator</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age</span> <span class="o">=</span> <span class="n">AddInt</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age</span>
<span class="go">18</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">calling __call__ function</span>
<span class="go">19</span>
</pre></div>
</div>
<p>有了上面的铺垫，可以再 AddInt 外层再加一层封装即可。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">class</span> <span class="nc">AddInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">return</span> <span class="n">AddInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numerator</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">AddInt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)(</span><span class="mi">3</span><span class="p">)(</span><span class="mi">4</span><span class="p">)(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">6</span><span class="p">)(</span><span class="mi">7</span><span class="p">)</span>
<span class="go">27</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_23"></span><div class="section" id="id1">
<h3>5.23 如何实现字典的多级排序<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在一个列表中，每个元素都是一个字典，里面的每个字典结构都是一样的。</p>
<p>里面的每个字典会有多个键值对，根据某个 key 或 value
的值大小，对该列表进行排序，使用 sort 函数就可以轻松实现。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">students</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jack&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">89</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Julia&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">student</span><span class="p">:</span> <span class="n">student</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span>
<span class="go">[{&#39;age&#39;: 17, &#39;score&#39;: 80, &#39;name&#39;: &#39;Julia&#39;}, {&#39;age&#39;: 16, &#39;score&#39;: 80, &#39;name&#39;: &#39;Tom&#39;}, {&#39;age&#39;: 17, &#39;score&#39;: 89, &#39;name&#39;: &#39;Jack&#39;}]</span>
</pre></div>
</div>
<p>如果两名同学的成绩一样，那谁排在前面呢？</p>
<p>那就再额外再定个第二指标呗，成绩一样，就再看年龄，年龄小的，成绩还能一样，那不是更历害嘛
。</p>
<p>规则定下了：先按成绩降序，如果成绩一致，再按年龄降序。</p>
<p>问题来了，这样的规则，代码该如何实现呢？</p>
<p>用字典本身的 sort 函数也能实现，方法如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">students</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jack&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">89</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Julia&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">student</span><span class="p">:</span> <span class="p">(</span><span class="n">student</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">student</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span>
<span class="go">[{&#39;age&#39;: 16, &#39;score&#39;: 80, &#39;name&#39;: &#39;Tom&#39;}, {&#39;age&#39;: 17, &#39;score&#39;: 80, &#39;name&#39;: &#39;Julia&#39;}, {&#39;age&#39;: 17, &#39;score&#39;: 89, &#39;name&#39;: &#39;Jack&#39;}]</span>
</pre></div>
</div>
<p>那如果一个降序，而另一个是升序，那又该怎么写呢？</p>
<p>很简单，只要在对应的 key 上，前面加一个负号，就会把顺序给颠倒过来。</p>
<p>还是以上面为例，我现在要实现先按成绩降序，如果成绩一致，再按年龄升序。可以这样写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">students</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Jack&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">89</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Julia&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">student</span><span class="p">:</span> <span class="p">(</span><span class="n">student</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">student</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">students</span>
<span class="go">[{&#39;age&#39;: 17, &#39;score&#39;: 80, &#39;name&#39;: &#39;Julia&#39;}, {&#39;age&#39;: 16, &#39;score&#39;: 80, &#39;name&#39;: &#39;Tom&#39;}, {&#39;age&#39;: 17, &#39;score&#39;: 89, &#39;name&#39;: &#39;Jack&#39;}]</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_24"></span><div class="section" id="id1">
<h3>5.24 对齐字符串的两种方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="format">
<h4>第一种：使用 format<a class="headerlink" href="#format" title="永久链接至标题">¶</a></h4>
<p>左对齐</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;{:&lt;10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">&#39;a         &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>右对齐</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;{:&gt;10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">&#39;         a&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>居中</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;{:^10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">&#39;    a     &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>当你不指定 <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> 、<code class="docutils literal notranslate"><span class="pre">&gt;</span></code>、<code class="docutils literal notranslate"><span class="pre">^</span></code> 时，默认就是左对齐</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;{:10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">&#39;a         &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>有了上面的铺垫，写一个整齐的 1-10 的平方、立方表就很容易了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
<span class="gp">... </span>       <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{:2d} {:3d} {:4d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go"> 1   1    1</span>
<span class="go"> 2   4    8</span>
<span class="go"> 3   9   27</span>
<span class="go"> 4  16   64</span>
<span class="go"> 5  25  125</span>
<span class="go"> 6  36  216</span>
<span class="go"> 7  49  343</span>
<span class="go"> 8  64  512</span>
<span class="go"> 9  81  729</span>
<span class="go">10 100 1000</span>
</pre></div>
</div>
<p>对齐的思想其实就是在不足的位自动给你补上空格。</p>
<p>如果不想使用空格，可以指定你想要的字符进行填充，比如下面我用 <code class="docutils literal notranslate"><span class="pre">0</span></code>
来补全。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{:02d} {:03d} {:04d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">01 001 0001</span>
<span class="go">02 004 0008</span>
<span class="go">03 009 0027</span>
<span class="go">04 016 0064</span>
<span class="go">05 025 0125</span>
<span class="go">06 036 0216</span>
<span class="go">07 049 0343</span>
<span class="go">08 064 0512</span>
<span class="go">09 081 0729</span>
<span class="go">10 100 1000</span>
</pre></div>
</div>
</div>
<div class="section" id="ljust-rjust">
<h4>第二种：使用 ljust, rjust<a class="headerlink" href="#ljust-rjust" title="永久链接至标题">¶</a></h4>
<p>左对齐</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;a&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="go">&#39;a         &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>右对齐</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;a&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="go">&#39;         a&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>居中</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;a&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="go">&#39;    a     &#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>同样写一个整齐的 1-10 的平方、立方表</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">)]))</span>
<span class="gp">...</span>
<span class="go">1  1   1</span>
<span class="go">2  4   8</span>
<span class="go">3  9   27</span>
<span class="go">4  16  64</span>
<span class="go">5  25  125</span>
<span class="go">6  36  216</span>
<span class="go">7  49  343</span>
<span class="go">8  64  512</span>
<span class="go">9  81  729</span>
<span class="go">10 100 1000</span>
</pre></div>
</div>
<p>如果不想使用空格，而改用 0 来补齐呢？可以这样</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)]))</span>
<span class="gp">...</span>
<span class="go">01 001 0001</span>
<span class="go">02 004 0008</span>
<span class="go">03 009 0027</span>
<span class="go">04 016 0064</span>
<span class="go">05 025 0125</span>
<span class="go">06 036 0216</span>
<span class="go">07 049 0343</span>
<span class="go">08 064 0512</span>
<span class="go">09 081 0729</span>
<span class="go">10 100 1000</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c05/c05_25"></span><div class="section" id="id1">
<h3>5.25 将位置参数变成关键字参数<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在 Python 中，参数的种类，大概可以分为四种：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">必选参数</span></code>，也叫<code class="docutils literal notranslate"><span class="pre">位置参数</span></code>，调用函数时一定指定的参数，并且在传参的时候必须按函数定义时的顺序来</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">可选参数</span></code>，也叫<code class="docutils literal notranslate"><span class="pre">默认参数</span></code>，调用函数时，可以指定也可以不指定，不指定就默认的参数值来。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">可变参数</span></code>，就是参数个数可变，可以是 0
个或者任意个，但是传参时不能指定参数名，通常使用 <code class="docutils literal notranslate"><span class="pre">*args</span></code> 来表示。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">关键字参数</span></code>，就是参数个数可变，可以是 0
个或者任意个，但是传参时必须指定参数名，通常使用 <code class="docutils literal notranslate"><span class="pre">**kw</span></code> 来表示</p></li>
</ol>
<p>使用单独的
<code class="docutils literal notranslate"><span class="pre">*</span></code>，可以后面的位置参数变成关键字参数，关键字参数在你传参时，必须要写参数名，不然会报错。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">demo_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">demo_func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">TypeError</span>: <span class="n">demo_func() takes 2 positional arguments but 3 were given</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">demo_func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_26"></span><div class="section" id="id1">
<h3>5.26 如何获取一个函数设定的参数<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在 Python 中有一个叫 inspect
的库，非常的好用，利用它可以获取一些数据，这在写一些框架时非常有用。</p>
<p>比如有下面这样一个函数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>使用 inspect 可以直接获取</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">demo</span><span class="p">)</span> <span class="c1"># # 获取函数签名</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span>
<span class="go">&lt;Signature (name, age, gender=&#39;male&#39;, *args, **kw)&gt;</span>
</pre></div>
</div>
<p>利用 inspect 还可以检查传参是否匹配签名</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;王炳明&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
<span class="go">&lt;BoundArguments (name=&#39;王炳明&#39;, age=27)&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;王炳明&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;/usr/lib64/python3.6/inspect.py&quot;</span>, line <span class="m">2997</span>, in <span class="n">bind</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_bind</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">kwargs</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/lib64/python3.6/inspect.py&quot;</span>, line <span class="m">2912</span>, in <span class="n">_bind</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
<span class="gr">TypeError</span>: <span class="n">missing a required argument: &#39;age&#39;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_27"></span><div class="section" id="id1">
<h3>5.27 如何进行版本的比较<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="distutils">
<h4>使用 distutils<a class="headerlink" href="#distutils" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">distutils</span></code> 是 Python 的内置模块，它做为最古老的 python
分发工具，本身也实现了版本的比较与检查的功能。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">distutils.version</span> <span class="kn">import</span> <span class="n">LooseVersion</span><span class="p">,</span> <span class="n">StrictVersion</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">LooseVersion</span><span class="p">(</span><span class="s2">&quot;2.3.1&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">LooseVersion</span><span class="p">(</span><span class="s2">&quot;10.1.2&quot;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">StrictVersion</span><span class="p">(</span><span class="s2">&quot;2.3.1&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">StrictVersion</span><span class="p">(</span><span class="s2">&quot;10.1.2&quot;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="packaging">
<h4>使用 packaging<a class="headerlink" href="#packaging" title="永久链接至标题">¶</a></h4>
<p>如果你的环境中安装过 <code class="docutils literal notranslate"><span class="pre">setuptools</span></code>，那么一定会附带安装了 packaging
这个包，而如果你的环境中并没有 setuptools ，也可以通过 pip 来快速安装</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install packaging
</pre></div>
</div>
<p>在 packaging 中有一个 version 模块，专门用来为 setuptools
提供包版本的版本解析。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2.3.1&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;10.1.2&quot;</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.3.a4&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;10.1.2&quot;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c05/c05_28"></span><div class="section" id="id1">
<h3>5.28 如何捕获警告?(注意不是捕获异常)<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<div class="section" id="id2">
<h4>1. 警告不是异常<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>你是不是经常在使用一些系统库或者第三方模块的时候，会出现一些既不是异常也不是错误的警告信息？</p>
<p>这些警告信息，有时候非常多，对于新手容易造成一些误判，以为是程序出错了。</p>
<p>实则不然，异常和错误，都是程序出现了一些问题，但是警告不同，他的紧急程度非常之低，以致于大多数的警告都是可以直接忽略的。</p>
<p>如果不想显示这些告警信息，可以直接加上参数 <code class="docutils literal notranslate"><span class="pre">-W</span> <span class="pre">ignore</span></code>
参数，就不会再显示了。</p>
</div>
<div class="section" id="id3">
<h4>2. 警告能捕获吗<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>能捕获的只有错误异常，但是通过一系列的操作后，你可以将这些警告转化为异常。</p>
<p>这样一来，你就可以像异常一样去捕获他们了。</p>
<p>在不进行任何设置的情况下，警告会直接打印在终端上。</p>
<p><img alt="image0" src="http://image.iswbm.com/20210313143425.png" /></p>
</div>
<div class="section" id="id4">
<h4>3. 捕获警告方法一<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>在 warnings 中有一系列的过滤器。</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>值</p></th>
<th class="head"><p>处置</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;default&quot;</span></code></p></td>
<td><p>为发出警告的每个位置（模块+行号）打印第一个匹配警告</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;error&quot;</span></code></p></td>
<td><p>将匹配警告转换为异常</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;ignore&quot;</span></code></p></td>
<td><p>从不打印匹配的警告</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;always&quot;</span></code></p></td>
<td><p>总是打印匹配的警告</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;module&quot;</span></code></p></td>
<td><p>为发出警告的每个模块打印第一次匹配警告（无论行号如何）</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;once&quot;</span></code></p></td>
<td><p>无论位置如何，仅打印第一次出现的匹配警告</p></td>
</tr>
</tbody>
</table>
<p>当你指定为 error 的时候，就会将匹配警告转换为异常。</p>
<p>之后你就可以通过异常的方式去捕获警告了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Warning</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>运行后，效果如下</p>
<p><img alt="image1" src="http://image.iswbm.com/20210313144501.png" /></p>
</div>
<div class="section" id="id5">
<h4>4. 捕获警告方法二<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>如果你不想对在代码中去配置将警告转成异常。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Warning</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>可以在执行的时候，只要加上一个参数 <code class="docutils literal notranslate"><span class="pre">-W</span> <span class="pre">error</span></code> ，就可以实现一样的效果</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -W error demo.py
deprecated
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>5. 捕获警告方法三<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>除了上面的方法之外 ，warnings 还自带了个捕获警告的上下文管理器。</p>
<p>当你加上 <code class="docutils literal notranslate"><span class="pre">record=True</span></code>
它会返回一个列表，列表里存放的是所有捕获到的警告，我将它赋值为
<code class="docutils literal notranslate"><span class="pre">w</span></code>，然后就可以将它打印出来了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">def</span> <span class="nf">do_warning</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
    <span class="n">do_warning</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>运行后，效果如下</p>
<p><img alt="image2" src="http://image.iswbm.com/20210313144751.png" /></p>
</div>
</div>
<span id="document-c05/c05_29"></span><div class="section" id="id1">
<h3>5.29 如何禁止对象深拷贝?<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当你使用 copy 模块的 deepcopy
拷贝一个对象后，会创建出来一个全新的的对象。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;wangbm&quot;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="go">21203408</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_profile</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">new_profile</span><span class="p">)</span>
<span class="go">21236144</span>
</pre></div>
</div>
<p>但是有的时候，我们希望基于我们的类实例化后对象，禁止被深拷贝，这时候就要用到
Python 的魔法方法了。</p>
<p>在如下代码中，我们重写了 Sentinel 类的 <code class="docutils literal notranslate"><span class="pre">__deepcopy__</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__copy__</span></code>
方法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sentinel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># Always return the same object because this is essentially a constant.</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># called via copy.copy(x)</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>此时你如果对它进行深度拷贝的话，会发现返回的永远都是原来的对象</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Sentinel</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="go">140151569169808</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_obj</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">id</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
<span class="go">140151569169808</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_30"></span><div class="section" id="id1">
<h3>5.30 如何将变量名和变量值转为字典？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>千言万语，不如上示例演示下效果</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;wangbm&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">age</span><span class="o">=</span><span class="mi">28</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gender</span><span class="o">=</span><span class="s2">&quot;male&quot;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">convert_vars_to_dict</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: &#39;wangbm&#39;, &#39;age&#39;: 28, &#39;gender&#39;: &#39;male&#39;}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">convert_vars_to_dict</span></code>
是我要自己定义的这么一个函数，功能如上，代码如下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">def</span> <span class="nf">varname</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">current_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
    <span class="n">back_frame</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_back</span>
    <span class="n">back_frame_info</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">back_frame</span><span class="p">)</span>

    <span class="n">current_func_name</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

    <span class="n">caller_file_path</span> <span class="o">=</span> <span class="n">back_frame_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">caller_line_no</span> <span class="o">=</span> <span class="n">back_frame_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">caller_type</span> <span class="o">=</span> <span class="n">back_frame_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">caller_expression</span> <span class="o">=</span> <span class="n">back_frame_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">caller_expression</span><span class="p">:</span>
        <span class="n">re_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b{}\((.*?)\)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_func_name</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">match_string</span> <span class="o">=</span> <span class="n">re_match</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">match_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</pre></div>
</div>
<p>附上 ：<a class="reference external" href="https://docs.python.org/zh-cn/3.7/library/inspect.html">inspect
学习文档</a></p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c05/c05_31"></span><div class="section" id="id1">
<h3>5.31 替换实例方法的最佳实践<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id2">
<h4>思路一：简单替换<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>当你想对类实例的方法进行替换时，你可能想到的是直接对他进行粗暴地替换</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">People</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, world&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">speak</span> <span class="o">=</span> <span class="n">speak</span>
<span class="n">p</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
</pre></div>
</div>
<p>但当你试着执行这段代码的时候，就会发现行不通，它提示我们要传入 self 参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/Users/MING/Code/Python/demo.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">12</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">p</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">speak</span><span class="p">()</span> <span class="n">missing</span> <span class="mi">1</span> <span class="n">required</span> <span class="n">positional</span> <span class="n">argument</span><span class="p">:</span> <span class="s1">&#39;self&#39;</span>
</pre></div>
</div>
<p>不对啊~ self 不是实例本身吗？函数不是一直就这么写的？</p>
<p>实际上你这么替换，speak 就变成了一个 function，而不是一个和实例绑定的
method ，你可以把替换前后的 speak 打印出来</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">speak</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">speak</span> <span class="o">=</span> <span class="n">speak</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">speak</span><span class="p">)</span>
</pre></div>
</div>
<p>输出结果如下，区别非常明显</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">People</span><span class="o">.</span><span class="n">speak</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">People</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10cfa7fd0</span><span class="o">&gt;&gt;</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">speak</span> <span class="n">at</span> <span class="mh">0x10ca10040</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>这种方法，只能用在替换不与实例绑定的静态方法上，不然你每次调用的时候，就得手动传入实例本身，但这样调用就会变得非常怪异。</p>
</div>
<div class="section" id="im-func">
<h4>思路二：利用 im_func<a class="headerlink" href="#im-func" title="永久链接至标题">¶</a></h4>
<p>有 Python 2 使用经验的朋友，可以会知道类实例的方法，都有 <code class="docutils literal notranslate"><span class="pre">im_func</span></code> 和
<code class="docutils literal notranslate"><span class="pre">im_class</span></code> 属性，分别指向了该方法的函数和类。</p>
<p><img alt="image1" src="http://image.iswbm.com/20210328111610.png" /></p>
<p>很抱歉的是，这些在 Python3 中全都取消了，意味你无法再使用 <code class="docutils literal notranslate"><span class="pre">im_func</span></code> 和
<code class="docutils literal notranslate"><span class="pre">im_class</span></code> 。</p>
<p>但即使你身处 Python 2 的环境下，你想通过 <code class="docutils literal notranslate"><span class="pre">im_func</span></code>
去直接替换函数，也仍然是有问题的。</p>
<p>因为在 Python2 中不推荐普通用户对类实例的方法进行替换，所以 Python
给类实例的方法赋予了只读属性</p>
<p><img alt="image2" src="http://image.iswbm.com/20210328111904.png" /></p>
</div>
<div class="section" id="id3">
<h4>思路三：非常危险的字节码替换<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>表层不行，但这个方法在字节码层面却是可行的</p>
<p><img alt="image3" src="http://image.iswbm.com/20210328112231.png" /></p>
<p>这种方法，非常的粗暴且危险，他会直接影响到使用 People 的所有实例的 speak
方法，因此这种方法千万不要使用。</p>
<p><img alt="image4" src="http://image.iswbm.com/20210328112501.png" /></p>
</div>
<div class="section" id="types">
<h4>思路四：利用 types 绑定方法<a class="headerlink" href="#types" title="永久链接至标题">¶</a></h4>
<p>在 types 中有一个 MethodType，可以将普通方法与实例进行绑定。</p>
<p>绑定后，就可以直接替换掉原实例的 speak 方法了，完整代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">types</span>

<span class="k">class</span> <span class="nc">People</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, world&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, python&quot;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">People</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">speak</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">speak</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
</pre></div>
</div>
<p>这种方法，最为安全，不会影响其他实例。并且 Python 2 和 Python 3
都适用，是官方推荐的一种做法。</p>
<p><img alt="image5" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p06"></span><div class="section" id="id1">
<h2>第六章：良好编码习惯<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节会写一些我自己日常开发总结的一些开发习惯，虽然内容还不是很多，但是我已经有了很多的思路，大家再给我点时间。</p>
<p>本章节，会持续更新，敬请关注…</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c06/c06_01"></span><div class="section" id="id1">
<h3>6.1 不要直接调用类的私有方法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>大家都知道，类中可供直接调用的方法，只有公有方法（protected类型的方法也可以，但是不建议）。也就是说，类的私有方法是无法直接调用的。</p>
<p>这里先看一下例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Kls</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Hello public world!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__private</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Hello private world!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call_private</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__private</span><span class="p">()</span>

<span class="n">ins</span> <span class="o">=</span> <span class="n">Kls</span><span class="p">()</span>

<span class="c1"># 调用公有方法，没问题</span>
<span class="n">ins</span><span class="o">.</span><span class="n">public</span><span class="p">()</span>

<span class="c1"># 直接调用私有方法，不行</span>
<span class="n">ins</span><span class="o">.</span><span class="n">__private</span><span class="p">()</span>

<span class="c1"># 但你可以通过内部公有方法，进行代理</span>
<span class="n">ins</span><span class="o">.</span><span class="n">call_private</span><span class="p">()</span>
</pre></div>
</div>
<p>既然都是方法，那我们真的没有方法可以直接调用吗？</p>
<p>当然有啦，只是建议你千万不要这样弄，这里只是普及，让你了解一下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 调用私有方法，以下两种等价</span>
<span class="n">ins</span><span class="o">.</span><span class="n">_Kls__private</span><span class="p">()</span>
<span class="n">ins</span><span class="o">.</span><span class="n">call_private</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c06/c06_02"></span><div class="section" id="id1">
<h3>6.2 默认参数最好不为可变对象<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>函数的参数分三种</p>
<ul class="simple">
<li><p>可变参数</p></li>
<li><p>默认参数</p></li>
<li><p>关键字参数</p></li>
</ul>
<p>当你在传递默认参数时，有新手很容易踩雷的一个坑。</p>
<p>先来看一个示例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item_list</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">item_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">item_list</span><span class="p">)</span>

<span class="n">func</span><span class="p">(</span><span class="s1">&#39;iphone&#39;</span><span class="p">)</span>
<span class="n">func</span><span class="p">(</span><span class="s1">&#39;xiaomi&#39;</span><span class="p">,</span> <span class="n">item_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;oppo&#39;</span><span class="p">,</span><span class="s1">&#39;vivo&#39;</span><span class="p">])</span>
<span class="n">func</span><span class="p">(</span><span class="s1">&#39;huawei&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在这里，你可以暂停一下，思考一下会输出什么？</p>
<p>思考过后，你的答案是否和下面的一致呢</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;iphone&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;oppo&#39;</span><span class="p">,</span> <span class="s1">&#39;vivo&#39;</span><span class="p">,</span> <span class="s1">&#39;xiaomi&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;iphone&#39;</span><span class="p">,</span> <span class="s1">&#39;huawei&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>如果是，那你可以跳过这部分内容，如果不是，请接着往下看，这里来分析一下。</p>
<p>Python 中的 def
语句在每次执行的时候都初始化一个函数对象，这个函数对象就是我们要调用的函数，可以把它当成一个一般的对象，只不过这个对象拥有一个可执行的方法和部分属性。</p>
<p>对于参数中提供了初始值的参数，由于 Python
中的函数参数传递的是对象，也可以认为是传地址，在第一次初始化 def
的时候，会先生成这个可变对象的内存地址，然后将这个默认参数 item_list
会与这个内存地址绑定。在后面的函数调用中，如果调用方指定了新的默认值，就会将原来的默认值覆盖。如果调用方没有指定新的默认值，那就会使用原来的默认值。</p>
<p><img alt="image1" src="http://image.iswbm.com/20190511165650.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c06/c06_03"></span><div class="section" id="id1">
<h3>6.3 增量赋值的性能更好<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>诸如 <code class="docutils literal notranslate"><span class="pre">+=</span></code> 和 <code class="docutils literal notranslate"><span class="pre">*=</span></code> 这些运算符，叫做 增量赋值运算符。</p>
<p>这里使用用 += 举例，以下两种写法，在效果上是等价的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 第一种</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># 第二种</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">+=</span></code> 其背后使用的魔法方法是
<code class="docutils literal notranslate"><span class="pre">__iadd__</span></code>，如果没有实现这个方法则会退而求其次，使用 <code class="docutils literal notranslate"><span class="pre">__add__</span></code> 。</p>
<p>这两种写法有什么区别呢？</p>
<p>用列表举例 a += b，使用 <code class="docutils literal notranslate"><span class="pre">__add__</span></code> 的话就像是使用了a.extend(b),如果使用
<code class="docutils literal notranslate"><span class="pre">__add__</span></code> 的话，则是 a =
a+b,前者是直接在原列表上进行扩展，而后者是先从原列表中取出值，在一个新的列表中进行扩展，然后再将新的列表对象返回给变量，显然后者的消耗要大些。</p>
<p>所以在能使用增量赋值的时候尽量使用它。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c06/c06_04"></span><div class="section" id="pprint">
<h3>6.4 别再使用 pprint 打印了<a class="headerlink" href="#pprint" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<div class="section" id="id1">
<h4>1. 吐槽问题<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>pprint 你应该很熟悉了吧？</p>
<p>随便在搜索引擎上搜索如何打印漂亮的字典或者格式化字符串时，大部分人都会推荐你使用这货
。</p>
<p>比如这下面这个 json
字符串或者说字典（我随便在网上找的），如果不格式化美化一下，根本无法阅读。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="nt">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="nt">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="nt">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="nt">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;2011-2017 你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="nt">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="nt">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="nt">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="nt">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="nt">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;斗鱼271934 走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
</pre></div>
</div>
<p>如果你不想看到一堆密密麻麻的字，那就使用大伙都极力推荐的 pprint
看下什么效果（以下在 Python 2 中演示，Python 3 中是不一样的效果）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">info</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;2011-2017 你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;斗鱼271934 走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
<span class="go">[{&#39;des&#39;: &#39;2011-2017 \xe4\xbd\xa0\xe7\x9a\x84\xe9\x93\x81\xe5\xa4\xb4\xe5\xa8\x83\xe4\xb8\x80\xe7\x9b\xb4\xe5\x9c\xa8\xe8\xbf\x99\xe5\x84\xbf\xe3\x80\x82\xe4\xb8\xad\xe5\x9b\xbd\xe6\x9c\x80\xe5\xa4\xa7\xe7\x9a\x84\xe5\xae\x9e\xe5\x90\x8d\xe5\x88\xb6SNS\xe7\xbd\x91\xe7\xbb\x9c\xe5\xb9\xb3\xe5\x8f\xb0\xef\xbc\x8c\xe5\xab\xa9\xe5\xa4\xb4\xe9\x9d\x92&#39;,</span>
<span class="go">  &#39;downloadUrl&#39;: &#39;app/com.renren.mobile.android/com.renren.mobile.android.apk&#39;,</span>
<span class="go">  &#39;iconUrl&#39;: &#39;app/com.renren.mobile.android/icon.jpg&#39;,</span>
<span class="go">  &#39;id&#39;: 1580615,</span>
<span class="go">  &#39;name&#39;: &#39;\xe7\x9a\xae\xe7\x9a\x84\xe5\x98\x9b&#39;,</span>
<span class="go">  &#39;packageName&#39;: &#39;com.renren.mobile.android&#39;,</span>
<span class="go">  &#39;size&#39;: 21803987,</span>
<span class="go">  &#39;stars&#39;: 2},</span>
<span class="go"> {&#39;des&#39;: &#39;\xe6\x96\x97\xe9\xb1\xbc271934 \xe8\xb5\xb0\xe8\xbf\x87\xe8\xb7\xaf\xe8\xbf\x87\xe4\xb8\x8d\xe8\xa6\x81\xe9\x94\x99\xe8\xbf\x87\xef\xbc\x8c\xe8\xbf\x99\xe9\x87\x8c\xe6\x9c\x89\xe6\x9c\x80\xe5\xa5\xbd\xe7\x9a\x84\xe9\xb8\xa1\xe5\x84\xbf&#39;,</span>
<span class="go">  &#39;downloadUrl&#39;: &#39;app/com.ct.client/com.ct.client.apk&#39;,</span>
<span class="go">  &#39;iconUrl&#39;: &#39;app/com.ct.client/icon.jpg&#39;,</span>
<span class="go">  &#39;id&#39;: 1540629,</span>
<span class="go">  &#39;name&#39;: &#39;\xe4\xb8\x8d\xe5\xad\x98\xe5\x9c\xa8\xe7\x9a\x84&#39;,</span>
<span class="go">  &#39;packageName&#39;: &#39;com.ct.client&#39;,</span>
<span class="go">  &#39;size&#39;: 4794202,</span>
<span class="go">  &#39;stars&#39;: 2}]</span>
</pre></div>
</div>
<p>好像有点效果，真的是 “神器”呀。</p>
<p>但是你告诉我，
<strong>:raw-latex:`xe`4:raw-latex:`xbd`:raw-latex:`xa`0:raw-latex:`xe`7:raw-latex:`x`9a</strong>
这些是什么玩意？本来想提高可读性的，现在变成完全不可读了。</p>
<p>好在我懂点 Python 2 的编码，知道 Python 2
中默认（不带u）的字符串格式都是 str 类型，也是 bytes 类型，它是以 byte
存储的。</p>
<p>行吧，好像是我错了，我改了下，使用 unicode 类型来定义中文字符串吧。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
<span class="go">[{&#39;des&#39;: u&#39;2011-2017\u4f60\u7684\u94c1\u5934\u5a03\u4e00\u76f4\u5728\u8fd9\u513f\u3002\u4e2d\u56fd\u6700\u5927\u7684\u5b9e\u540d\u5236SNS\u7f51\u7edc\u5e73\u53f0\uff0c\u5ae9\u5934\u9752&#39;,</span>
<span class="go">  &#39;downloadUrl&#39;: &#39;app/com.renren.mobile.android/com.renren.mobile.android.apk&#39;,</span>
<span class="go">  &#39;iconUrl&#39;: &#39;app/com.renren.mobile.android/icon.jpg&#39;,</span>
<span class="go">  &#39;id&#39;: 1580615,</span>
<span class="go">  &#39;name&#39;: u&#39;\u76ae\u7684\u561b&#39;,</span>
<span class="go">  &#39;packageName&#39;: &#39;com.renren.mobile.android&#39;,</span>
<span class="go">  &#39;size&#39;: 21803987,</span>
<span class="go">  &#39;stars&#39;: 2},</span>
<span class="go"> {&#39;des&#39;: u&#39;\u6597\u9c7c271934\u8d70\u8fc7\u8def\u8fc7\u4e0d\u8981\u9519\u8fc7\uff0c\u8fd9\u91cc\u6709\u6700\u597d\u7684\u9e21\u513f&#39;,</span>
<span class="go">  &#39;downloadUrl&#39;: &#39;app/com.ct.client/com.ct.client.apk&#39;,</span>
<span class="go">  &#39;iconUrl&#39;: &#39;app/com.ct.client/icon.jpg&#39;,</span>
<span class="go">  &#39;id&#39;: 1540629,</span>
<span class="go">  &#39;name&#39;: u&#39;\u4e0d\u5b58\u5728\u7684&#39;,</span>
<span class="go">  &#39;packageName&#39;: &#39;com.ct.client&#39;,</span>
<span class="go">  &#39;size&#39;: 4794202,</span>
<span class="go">  &#39;stars&#39;: 2}]</span>
</pre></div>
</div>
<p>确实是有好点了，但是看到下面这些，我崩溃了，我哪里知道这是什么鬼，难道是我太菜了吗？当我是计算机呀？</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u6597\u9c7c</span><span class="s1">271934</span><span class="se">\u8d70\u8fc7\u8def\u8fc7\u4e0d\u8981\u9519\u8fc7\uff0c\u8fd9\u91cc\u6709\u6700\u597d\u7684\u9e21\u513f</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>除此之外，我们知道 json 的严格要求必须使用
<strong>双引号</strong>，而我定义字典时，也使用了双引号了，为什么打印出来的为什么是
<strong>单引号</strong>？我也太难了吧，我连自己的代码都无法控制了吗？</p>
<p>到这里，我们知道了 pprint 带来的两个问题：</p>
<ol class="arabic simple">
<li><p>没法在 Python 2 下正常打印中文</p></li>
<li><p>没法输出 JSON 标准格式的格式化内容（双引号）</p></li>
</ol>
</div>
<div class="section" id="id2">
<h4>2. 解决问题<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<div class="section" id="id3">
<h5>打印中文<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<p>如果你是在 Python 3 下使用，你会发现中文是可以正常显示的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python3.7</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
<span class="p">[{</span><span class="s1">&#39;des&#39;</span><span class="p">:</span> <span class="s1">&#39;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&#39;</span><span class="p">,</span>
  <span class="s1">&#39;downloadUrl&#39;</span><span class="p">:</span> <span class="s1">&#39;app/com.renren.mobile.android/com.renren.mobile.android.apk&#39;</span><span class="p">,</span>
  <span class="s1">&#39;iconUrl&#39;</span><span class="p">:</span> <span class="s1">&#39;app/com.renren.mobile.android/icon.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1580615</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;皮的嘛&#39;</span><span class="p">,</span>
  <span class="s1">&#39;packageName&#39;</span><span class="p">:</span> <span class="s1">&#39;com.renren.mobile.android&#39;</span><span class="p">,</span>
  <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">21803987</span><span class="p">,</span>
  <span class="s1">&#39;stars&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;des&#39;</span><span class="p">:</span> <span class="s1">&#39;斗鱼271934走过路过不要错过，这里有最好的鸡儿&#39;</span><span class="p">,</span>
  <span class="s1">&#39;downloadUrl&#39;</span><span class="p">:</span> <span class="s1">&#39;app/com.ct.client/com.ct.client.apk&#39;</span><span class="p">,</span>
  <span class="s1">&#39;iconUrl&#39;</span><span class="p">:</span> <span class="s1">&#39;app/com.ct.client/icon.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1540629</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;不存在的&#39;</span><span class="p">,</span>
  <span class="s1">&#39;packageName&#39;</span><span class="p">:</span> <span class="s1">&#39;com.ct.client&#39;</span><span class="p">,</span>
  <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">4794202</span><span class="p">,</span>
  <span class="s1">&#39;stars&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>但是很多时候（在公司的一些服务器）你无法选择自己使用哪个版本的
Python，本来我可以选择不用的，因为有更好的替代方案（<strong>这个后面会讲</strong>）。</p>
<p>但是我出于猎奇，正好前两天不是写过一篇关于 编码
的文章吗，我自认为自己对于
编码还是掌握比较熟练的，就想着来解决一下这个问题。</p>
<p>索性就来看下 pprint
的源代码，还真被我找到了解决方法，如果你也想挑战一下，不防在这里停住，自己研究一下如何实现，我相信对你阅读源码会有帮助。</p>
<p><strong>以下是我的解决方案，供你参考</strong>：</p>
<p>写一个自己的 printer 对象，继承自 PrettyPrinter （pprint 使用的printer）</p>
<p>并且复写 format 方法，判断传进来的字符串对象是否 str 类型，如果不是 str
类型，而是 unicode 类型，就用 uft8 编码成 str 类型。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">PrettyPrinter</span>

<span class="c1"># 继承 PrettyPrinter，复写 format 方法</span>
<span class="k">class</span> <span class="nc">MyPrettyPrinter</span><span class="p">(</span><span class="n">PrettyPrinter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PrettyPrinter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

<span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>

<span class="n">MyPrettyPrinter</span><span class="p">()</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>输出如下，已经解决了中文的显示问题：</p>
<p><img alt="image1" src="http://image.iswbm.com/20200507171451.png" /></p>
</div>
<div class="section" id="id4">
<h5>打印双引号<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<p>解决了中文问题后，再来看看如何让 pprint 打印双引号。</p>
<p>在实例化 PrettyPrinter 对象的时候，可以接收一个 stream
对象，它表示你要将内容输出到哪里，默认是使用 sys.stdout 这个
stream，也就是标准输出。</p>
<p>现在我们要修改输出的内容，也就是将输出的单引号替换成双引号。</p>
<p>那我们完全可以自己定义一个 stream
类型的对象，该对象不需要继承任何父类，只要你实现 write 方法就可以。</p>
<p>有了思路，就可以开始写代码了，如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">PrettyPrinter</span>

<span class="k">class</span> <span class="nc">MyPrettyPrinter</span><span class="p">(</span><span class="n">PrettyPrinter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PrettyPrinter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyStream</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

<span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
<span class="n">MyPrettyPrinter</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">MyStream</span><span class="p">())</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>尝试执行了下，我的天，怎么是这样子的。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span>[
{
&quot;des&quot;
:
2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青
,
  &quot;downloadUrl&quot;:
&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;
,
  &quot;iconUrl&quot;:
&quot;app/com.renren.mobile.android/icon.jpg&quot;
,
  &quot;id&quot;:
1580615
,
  &quot;name&quot;:
皮的嘛
,
  &quot;packageName&quot;:
&quot;com.renren.mobile.android&quot;
,
  &quot;size&quot;:
21803987
,
  &quot;stars&quot;:
2
}
,

{
&quot;des&quot;
:
斗鱼271934走过路过不要错过，这里有最好的鸡儿
,
  &quot;downloadUrl&quot;:
&quot;app/com.ct.client/com.ct.client.apk&quot;
,
  &quot;iconUrl&quot;:
&quot;app/com.ct.client/icon.jpg&quot;
,
  &quot;id&quot;:
1540629
,
  &quot;name&quot;:
不存在的
,
  &quot;packageName&quot;:
&quot;com.ct.client&quot;
,
  &quot;size&quot;:
4794202
,
  &quot;stars&quot;:
2
}
]
</pre></div>
</div>
<p>经过一番研究，才知道是因为 print 函数默认会将打印的内容后面加个
<strong>换行符</strong>。</p>
<p>那如何将使 print 函数打印的内容，不进行换行呢？</p>
<p>方法很简单，但是我相信很多人都不知道，只要在 print 的内容后加一个
<strong>逗号</strong> 就行。</p>
<p>就像下面这样。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200507174459.png" /></p>
<p>知道了问题所在，再修改下代码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">PrettyPrinter</span>

<span class="k">class</span> <span class="nc">MyPrettyPrinter</span><span class="p">(</span><span class="n">PrettyPrinter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PrettyPrinter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">maxlevels</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyStream</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">),</span>

<span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="sa">u</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>

<span class="n">MyPrettyPrinter</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">MyStream</span><span class="p">())</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>终于成功了，太不容易了吧。</p>
<p><img alt="image3" src="http://image.iswbm.com/20200507174802.png" /></p>
</div>
</div>
<div class="section" id="id5">
<h4>3. 何必折腾<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>通过上面的一番折腾，我终于实现了我 <strong>梦寐以求</strong> 的需求。</p>
<p>代价就是我整整花费了两个小时，才得以实现，而对于小白来说，可能没有信心，也没有耐心去做这样的事情。</p>
<p><strong>所以我想说的是，Python 2 下的 pprint ，真的不要再用了</strong>。</p>
<p>为什么我要用这么 说，因为明明有更好的替代品，人生苦短，既然用了 Python
，当然是怎么简单怎么来咯，何必为难自己呢，一行代码可以解决的事情，偏偏要去写两个类，那不是自讨苦吃吗？（我这是在骂自己吗？</p>
<p>如果你愿意抛弃 pprint ，那我推荐你用 json.dumps ，我保证你再也不想用
pprint 了。</p>
<div class="section" id="id6">
<span id="id7"></span><h5>打印中文<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h5>
<p>其实无法打印中文，是 Python 2 引来的大坑，并不能全怪 pprint 。</p>
<p>但是同样的问题，在 json.dumps 这里，却只要加个参数就好了，可比 pprint
简单得不要太多。</p>
<p>具体的代码示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">info</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1580615</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;皮的嘛&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.renren.mobile.android&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">21803987</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;</span><span class="p">},{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">1540629</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;不存在的&quot;</span><span class="p">,</span><span class="s2">&quot;packageName&quot;</span><span class="p">:</span><span class="s2">&quot;com.ct.client&quot;</span><span class="p">,</span><span class="s2">&quot;iconUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/icon.jpg&quot;</span><span class="p">,</span><span class="s2">&quot;stars&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">4794202</span><span class="p">,</span><span class="s2">&quot;downloadUrl&quot;</span><span class="p">:</span><span class="s2">&quot;app/com.ct.client/com.ct.client.apk&quot;</span><span class="p">,</span><span class="s2">&quot;des&quot;</span><span class="p">:</span><span class="s2">&quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;</span><span class="p">}]</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">json</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="go">[</span>
<span class="go">    {</span>
<span class="go">        &quot;downloadUrl&quot;: &quot;app/com.renren.mobile.android/com.renren.mobile.android.apk&quot;,</span>
<span class="go">        &quot;iconUrl&quot;: &quot;app/com.renren.mobile.android/icon.jpg&quot;,</span>
<span class="go">        &quot;name&quot;: &quot;皮的嘛&quot;,</span>
<span class="go">        &quot;stars&quot;: 2,</span>
<span class="go">        &quot;packageName&quot;: &quot;com.renren.mobile.android&quot;,</span>
<span class="go">        &quot;des&quot;: &quot;2011-2017你的铁头娃一直在这儿。中国最大的实名制SNS网络平台，嫩头青&quot;,</span>
<span class="go">        &quot;id&quot;: 1580615,</span>
<span class="go">        &quot;size&quot;: 21803987</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">        &quot;downloadUrl&quot;: &quot;app/com.ct.client/com.ct.client.apk&quot;,</span>
<span class="go">        &quot;iconUrl&quot;: &quot;app/com.ct.client/icon.jpg&quot;,</span>
<span class="go">        &quot;name&quot;: &quot;不存在的&quot;,</span>
<span class="go">        &quot;stars&quot;: 2,</span>
<span class="go">        &quot;packageName&quot;: &quot;com.ct.client&quot;,</span>
<span class="go">        &quot;des&quot;: &quot;斗鱼271934走过路过不要错过，这里有最好的鸡儿&quot;,</span>
<span class="go">        &quot;id&quot;: 1540629,</span>
<span class="go">        &quot;size&quot;: 4794202</span>
<span class="go">    }</span>
<span class="go">]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>json.dumps 的关键参数有两个：</p>
<ul class="simple">
<li><p><strong>indent=4</strong>：以 4 个空格缩进单位</p></li>
<li><p><strong>ensure_ascii=False</strong>：接收非 ASCII 编码的字符，这样才能使用中文</p></li>
</ul>
<p>与 pprint 相比 json.dumps 可以说完胜：</p>
<ol class="arabic simple">
<li><p>两个参数就能实现所有我的需求（打印中文与双引号）</p></li>
<li><p>就算在 Python 2 下，使用中文也不需要用 <code class="docutils literal notranslate"><span class="pre">u'中文'</span></code> 这种写法</p></li>
<li><p>Python2 和 Python3 的写法完全一致，对于这一点不需要考虑兼容问题</p></li>
</ol>
</div>
</div>
<div class="section" id="id8">
<h4>4. 总结一下<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p>本来很简单的一个观点，我为了证明 pprint
实现那两个需求有多么困难，花了很多的时间去研究了 pprint
的源码（各种处理其实还是挺复杂的），不过好在最后也能有所收获。</p>
<p>本文的分享就到这里，阅读本文，我认为你可以获取到三个知识点</p>
<ol class="arabic simple">
<li><p>核心观点：Python2 下不要再使用 pprint</p></li>
<li><p>若真要使用，且有和一样的改造需求，可以参考我的实现</p></li>
<li><p>Python 2 中的 print 语句后居然可以加 逗号</p></li>
</ol>
<p><img alt="image4" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c06/c06_05"></span><div class="section" id="id1">
<h3>6.5 变量名与保留关键冲突怎么办？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>所有的编程语言都有一些保留关键字，这是代码得以编译/解释的基础。</p>
<p>有了这些关键字就组成了语法，当你的变量名和这些保留关键字冲突时，该怎么办呢？</p>
<p>在回答这个问题前，先要看看 Python 中的保留关键字有哪些？</p>
<p>Python 的关键字，可以通过 keyword 这个模块列出来，一共有 33 个。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">keyword</span><span class="p">;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">kwlist</span><span class="p">))</span>
<span class="go">False</span>
<span class="go">None</span>
<span class="go">True</span>
<span class="go">and</span>
<span class="go">as</span>
<span class="go">assert</span>
<span class="go">break</span>
<span class="go">class</span>
<span class="go">continue</span>
<span class="go">def</span>
<span class="go">del</span>
<span class="go">elif</span>
<span class="go">else</span>
<span class="go">except</span>
<span class="go">finally</span>
<span class="go">for</span>
<span class="go">from</span>
<span class="go">global</span>
<span class="go">if</span>
<span class="go">import</span>
<span class="go">in</span>
<span class="go">is</span>
<span class="go">lambda</span>
<span class="go">nonlocal</span>
<span class="go">not</span>
<span class="go">or</span>
<span class="go">pass</span>
<span class="go">raise</span>
<span class="go">return</span>
<span class="go">try</span>
<span class="go">while</span>
<span class="go">with</span>
<span class="go">yield</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">kwlist</span><span class="p">)</span>
<span class="go">33</span>
</pre></div>
</div>
<p>使用这些关键字来做为变量名，是会报语法错误的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">try</span> <span class="o">=</span> <span class="bp">True</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>
    <span class="k">try</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="o">^</span>
<span class="gr">SyntaxError</span>: <span class="n">invalid syntax</span>
</pre></div>
</div>
<p>关于这个问题，<a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP8</a>
建议当你想使用的变量名被关键字所占用时，可以使用 <code class="docutils literal notranslate"><span class="pre">变量_</span></code>
这样在变量后面加一个单下划线的形式来命名，这种后缀一下划线的方式优先于缩写或拼写错误。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200823203106.png" /></p>
<p>有了 PEP8 做为指导，我们可以这样子写了</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">try_</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c06/c06_06"></span><div class="section" id="id1">
<h3>6.6 不想让子类继承的变量名该怎么写？<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>先来看下面这段代码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;MING&quot;</span>

<span class="k">class</span> <span class="nc">Son</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Xiao MING&quot;</span>

<span class="n">bar</span> <span class="o">=</span> <span class="n">Son</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="c1"># 输出： Xiao MING</span>
</pre></div>
</div>
<p>Bar 作为 Foo 的子类，会继承父类的 name 属性。</p>
<p>如果有一些属性，是父类自己独有的，不想被子类继承，该怎么写呢？</p>
<p>可以在属性前面加两个下划线，两个类的定义如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;MING&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wife</span> <span class="o">=</span> <span class="s2">&quot;Julia&quot;</span>

<span class="k">class</span> <span class="nc">Son</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Xiao MING&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
<p>从本章节的第一篇文章（<a href="#id2"><span class="problematic" id="id3">`6.1
不要直接调用类的私有方法 &lt;&gt;`__</span></a>）我们知道了私有的变量或函数，是不能直接调用的，需要用这样的形式才能访问
<code class="docutils literal notranslate"><span class="pre">_类名__变量名</span></code>。</p>
<p>Son 类的实例的并没有初始化 <code class="docutils literal notranslate"><span class="pre">__wife</span></code> 属性，但是 Parent
类的实例有，但是由于这个属性是父类私有的，当子类想要访问时，是会提示该变量不存在。</p>
<p>验证过程如下：</p>
<p><img alt="image1" src="http://image.iswbm.com/20200823205210.png" /></p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-chapters/p07"></span><div class="section" id="id1">
<h2>第七章：神奇魔法模块<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>这个章节会收集一些被市场公认好用的模块，对于编码代码很有帮助，同样还是需要时间慢慢沉淀。</p>
<p>本章节，会持续更新，敬请关注…</p>
<hr class="docutils" />
<div class="toctree-wrapper compound">
<span id="document-c07/c07_01"></span><div class="section" id="id1">
<h3>7.1 远程登陆服务器的最佳利器<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在使用 Python
写一些脚本的时候，在某些情况下，我们需要频繁登陆远程服务去执行一次命令，并返回一些结果。</p>
<p>在 shell 环境中，我们是这样子做的。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sshpass -p <span class="si">${</span><span class="nv">passwd</span><span class="si">}</span> ssh -p <span class="si">${</span><span class="nv">port</span><span class="si">}</span> -l <span class="si">${</span><span class="nv">user</span><span class="si">}</span> -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no xx.xx.xx.xx <span class="s2">&quot;ls -l&quot;</span>
</pre></div>
</div>
<p>然后你会发现，你的输出有很多你并不需要，但是又不去不掉的一些信息（也许有方法，请留言交流），类似这样</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>host: xx.xx.xx.xx, port: xx
Warning: Permanently added <span class="s1">&#39;[xx.xx.xx.xx]:xx&#39;</span> <span class="o">(</span>RSA<span class="o">)</span> to the list of known hosts.
Login failure: <span class="o">[</span>Errno <span class="m">1</span><span class="o">]</span> This server is not registered to rmp platform, please confirm whether cdn server.
total <span class="m">4</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">239</span> Mar <span class="m">30</span>  <span class="m">2018</span> admin-openrc
</pre></div>
</div>
<p>对于直接使用 shell
命令，来执行命令的，可以直接使用管道，或者将标准输出重定向到文件的方法取得执行命令返回的结果</p>
<div class="section" id="subprocess">
<h4>1. 使用 subprocess<a class="headerlink" href="#subprocess" title="永久链接至标题">¶</a></h4>
<p>若是使用 Python 来做这件事，通常我们会第一时间，想到使用
os.popen，os.system，commands，subprocess 等一些命令执行库来间接获取 。</p>
<p>但是据我所知，这些库获取的 output
不仅只有标准输出，还包含标准错误（也就是上面那些多余的信息）</p>
<p>所以每次都要对 output
进行的数据清洗，然后整理格式化，才能得到我们想要的数据。</p>
<p>用 subprocess 举个例子，就像这样子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">ssh_cmd</span> <span class="o">=</span> <span class="s2">&quot;sshpass -p ${passwd} ssh -p 22 -l root -o StrictHostKeyChecking=no xx.xx.xx.xx  &#39;ls -l&#39;&quot;</span>
<span class="n">status</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="n">ssh_cmd</span><span class="p">)</span>

<span class="c1"># 数据清理，格式化的就不展示了</span>
<span class="o">&lt;</span><span class="n">code</span><span class="o">...&gt;</span>
</pre></div>
</div>
<p>通过以上的文字 + 代码的展示 ，可以感觉到 ssh 登陆的几大痛点</p>
<ul class="simple">
<li><p><strong>痛点一</strong>：需要额外安装 sshpass（如果不免密的话）</p></li>
<li><p><strong>痛点二</strong>：干扰信息太多，数据清理、格式化相当麻烦</p></li>
<li><p><strong>痛点三</strong>：代码实现不够优雅（有点土），可读性太差</p></li>
<li><p><strong>痛点四</strong>：ssh 连接不能复用，一次连接仅能执行一次</p></li>
<li><p><strong>痛点五</strong>：代码无法全平台，仅能在 Linux 和 OSX 上使用</p></li>
</ul>
<p>为了解决这几个问题，我搜索了全网关于 Python ssh
的文章，没有看到有完整介绍这方面的技巧的。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200512125643.png" /></p>
<p>为此，我就翻阅了一个很火的 Github 项目： awesome-python-cn
（<a class="reference external" href="https://github.com/BingmingWong/awesome-python-cn">https://github.com/BingmingWong/awesome-python-cn</a>）。</p>
<p>期望在这里，找到有一些关于 远程连接 的一些好用的库。</p>
<p>还真的被我找到了两个</p>
<ul class="simple">
<li><p>sh.ssh</p></li>
<li><p>Paramiko</p></li>
</ul>
</div>
<div class="section" id="sh-ssh">
<h4>2. 使用 sh.ssh<a class="headerlink" href="#sh-ssh" title="永久链接至标题">¶</a></h4>
<p>首先来介绍第一个，<code class="docutils literal notranslate"><span class="pre">sh.ssh</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">sh</span></code> 是一个可以让你通过函数的调用来完成 Linxu/OSX
系统命令的一个库，非常好用，关于它有机会也写篇介绍。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install sh
</pre></div>
</div>
<p>今天只介绍它其中的一个函数：<code class="docutils literal notranslate"><span class="pre">ssh</span></code></p>
<p>通常两台机器互访，为了方便，可设置免密登陆，这样就不需要输入密码。</p>
<p>这段代码可以实现免密登陆，并执行我们的命令 <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ssh</span>
<span class="n">output</span><span class="o">=</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;root@xx.xx.xx.xx&quot;</span><span class="p">,</span> <span class="s2">&quot;-p 22&quot;</span><span class="p">,</span> <span class="s2">&quot;ls -l&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>但有可能
，我们并不想设置互信免密，为了使这段代码更通用，我假定我们没有设置免密，只能使用密码进行登陆。</p>
<p>问题就来了，要输入密码，必须得使用交互式的方法来输入呀，在 Python
中要如何实现呢？</p>
<p>原来 ssh 方法接收一个 <code class="docutils literal notranslate"><span class="pre">_out</span></code>
参数，这个参数可以为一个字符串，表示文件路径，也可以是一个文件对象（或者类文件对象），还可以是一个回调函数，意思是当有标准输出时，就会调用将输出内容传给这个函数。</p>
<p>这就好办了呀。</p>
<p>我只要识别到有 <code class="docutils literal notranslate"><span class="pre">password:</span></code> 字样，就往标准输入写入我的密码就好了呀。</p>
<p>完整代码如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ssh</span>

<span class="n">aggregated</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">def</span> <span class="nf">ssh_interact</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">stdin</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">aggregated</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">aggregated</span> <span class="o">+=</span> <span class="n">char</span>
    <span class="k">if</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;password: &quot;</span><span class="p">):</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;you_password</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">output</span><span class="o">=</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;root@xx.xx.xx.xx&quot;</span><span class="p">,</span> <span class="s2">&quot;-p 22&quot;</span><span class="p">,</span> <span class="s2">&quot;ls -l&quot;</span><span class="p">,</span><span class="n">_tty_in</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_out_bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">_out</span><span class="o">=</span><span class="n">ssh_interact</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>这是官方文档（<a class="reference external" href="http://amoffat.github.io/sh/tutorials/interacting_with_processes.html?highlight=ssh">http://amoffat.github.io/sh/tutorials/interacting_with_processes.html?highlight=ssh</a>）给的一些信息，写的一个demo。</p>
<p>尝试运行后，发现程序会一直在运行中，永远不会返回，不会退出，回调函数也永远不会进入。</p>
<p>通过调试查看源代码，仍然查不到问题所在，于是去
<a class="reference external" href="https://github.com/amoffat/sh/issues/393">Github</a> 上搜了下，原来在
2017 年就已经存在这个问题了，到现在 2020 年了还没有修复，看来使用
<code class="docutils literal notranslate"><span class="pre">sh.ssh</span></code> 的人并不多，于是我又“追问”了下，期望能得到回复。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200228085749.png" /></p>
<p>以上这个问题，只有在需要输入密码才会出现，如果设置了机器互信是没有问题的。</p>
<p>为了感受 <code class="docutils literal notranslate"><span class="pre">sh.ssh</span></code>
的使用效果，我设置了机器互信免密，然后使用如下这段代码。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sh</span> <span class="kn">import</span> <span class="n">ssh</span>

<span class="n">my_server</span><span class="o">=</span><span class="n">ssh</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;root@xx.xx.xx.xx&quot;</span><span class="p">,</span> <span class="s2">&quot;-p 22&quot;</span><span class="p">)</span>

<span class="c1"># 相当于执行登陆一次执行一次命令，执行完就退出登陆</span>
<span class="k">print</span><span class="p">(</span><span class="n">my_server</span><span class="o">.</span><span class="n">ls</span><span class="p">())</span>

<span class="c1"># 可在 sleep 期间，手动登陆服务器，使用 top ，查看当前有多少终端在连接</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># 再次执行这条命令时，登陆终端数将 +1，执行完后，又将 -1</span>
<span class="k">print</span><span class="p">(</span><span class="n">my_server</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">())</span>
</pre></div>
</div>
<p>惊奇地发现使用 <code class="docutils literal notranslate"><span class="pre">bake</span></code> 这种方式，<code class="docutils literal notranslate"><span class="pre">my_server.ls()</span></code> 和
<code class="docutils literal notranslate"><span class="pre">my_server.ifconfig()</span></code>
这种看似是通过同一个ssh连接，执行两次命令，可实际上，你可以在远程机器上，执行
top 命令看到已连接的终端的变化，会先 <code class="docutils literal notranslate"><span class="pre">+1</span></code> 再
<code class="docutils literal notranslate"><span class="pre">-1</span></code>，说明两次命令的执行是通过两次连接实现的。</p>
<p>如此看来，使用 <code class="docutils literal notranslate"><span class="pre">sh.ssh</span></code>
可以解决痛点一（如果上述问题能得到解决）、痛点二、痛点三。</p>
<p>但是它仍然无法复用 ssh 连接，还是不太方便，不是我理想中的最佳方案。</p>
<p>最重要的一点是， <code class="docutils literal notranslate"><span class="pre">sh</span></code> 这个模块，仅支持 Linxu/OSX ，在 Windows
你得使用它的兄弟库 - <code class="docutils literal notranslate"><span class="pre">pbs</span></code> ，然后我又去 pypi 看了一眼
<a class="reference external" href="https://pypi.org/project/pbs/">pbs</a>，已经 “年久失修”，没人维护了。</p>
<p><img alt="image3" src="http://image.iswbm.com/20200228093627.png" /></p>
<p>至此，我离 “卒”，就差最后一根稻草了。</p>
<p><img alt="image4" src="http://image.iswbm.com/20200512125643.png" /></p>
</div>
<div class="section" id="paramiko">
<h4>3. 使用 paramiko<a class="headerlink" href="#paramiko" title="永久链接至标题">¶</a></h4>
<p>带着最后一丝希望，我尝试使用了 <code class="docutils literal notranslate"><span class="pre">paramiko</span></code> 这个库，终于在 <code class="docutils literal notranslate"><span class="pre">paramiko</span></code>
这里，找回了本应属于 Python 的那种优雅。</p>
<p>你可以通过如下命令去安装它</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install paramiko
</pre></div>
</div>
<p>然后接下来，就介绍几种常用的 ssh 登陆的方法</p>
<div class="section" id="sshclient">
<h5>方法1：基于用户名和密码的 sshclient 方式登录<a class="headerlink" href="#sshclient" title="永久链接至标题">¶</a></h5>
<p>然后你可以参考如下这段代码，在 Linux/OSX 系统下进行远程连接</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="c1"># 允许连接不在know_hosts文件中的主机</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>

<span class="c1"># 建立连接</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;xx.xx.xx.xx&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;you_password&quot;</span><span class="p">)</span>

<span class="c1"># 使用这个连接执行命令</span>
<span class="n">ssh_stdin</span><span class="p">,</span> <span class="n">ssh_stdout</span><span class="p">,</span> <span class="n">ssh_stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;ls -l&quot;</span><span class="p">)</span>

<span class="c1"># 获取输出</span>
<span class="k">print</span><span class="p">(</span><span class="n">ssh_stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># 关闭连接</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="transport">
<h5>方法2：基于用户名和密码的 transport 方式登录<a class="headerlink" href="#transport" title="永久链接至标题">¶</a></h5>
<p>方法1
是传统的连接服务器、执行命令、关闭的一个操作，多个操作需要连接多次，无法复用连接[<strong>痛点四</strong>]。</p>
<p>有时候需要登录上服务器执行多个操作，比如执行命令、上传/下载文件，方法1
则无法实现，那就可以使用 transport 的方法。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="c1"># 建立连接</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">Transport</span><span class="p">((</span><span class="s2">&quot;xx.xx.xx.xx&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
<span class="n">trans</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;you_passwd&quot;</span><span class="p">)</span>

<span class="c1"># 将sshclient的对象的transport指定为以上的trans</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">trans</span>

<span class="c1"># 剩下的就和上面一样了</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
<span class="n">ssh_stdin</span><span class="p">,</span> <span class="n">ssh_stdout</span><span class="p">,</span> <span class="n">ssh_stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;ls -l&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ssh_stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># 关闭连接</span>
<span class="n">trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h5>方法3：基于公钥密钥的 SSHClient 方式登录<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="c1"># 指定本地的RSA私钥文件</span>
<span class="c1"># 如果建立密钥对时设置的有密码，password为设定的密码，如无不用指定password参数</span>
<span class="n">pkey</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">RSAKey</span><span class="o">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="s1">&#39;/home/you_username/.ssh/id_rsa&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>

<span class="c1"># 建立连接</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;xx.xx.xx.xx&#39;</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;you_username&#39;</span><span class="p">,</span>
            <span class="n">pkey</span><span class="o">=</span><span class="n">pkey</span><span class="p">)</span>

<span class="c1"># 执行命令</span>
<span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s1">&#39;ls -l&#39;</span><span class="p">)</span>

<span class="c1"># 结果放到stdout中，如果有错误将放到stderr中</span>
<span class="k">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># 关闭连接</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5>方法4：基于密钥的 Transport 方式登录<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="c1"># 指定本地的RSA私钥文件</span>
<span class="c1"># 如果建立密钥对时设置的有密码，password为设定的密码，如无不用指定password参数</span>
<span class="n">pkey</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">RSAKey</span><span class="o">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="s1">&#39;/home/you_username/.ssh/id_rsa&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>

<span class="c1"># 建立连接</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">Transport</span><span class="p">((</span><span class="s1">&#39;xx.xx.xx.xx&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
<span class="n">trans</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;you_username&#39;</span><span class="p">,</span> <span class="n">pkey</span><span class="o">=</span><span class="n">pkey</span><span class="p">)</span>

<span class="c1"># 将sshclient的对象的transport指定为以上的trans</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">trans</span>

<span class="c1"># 执行命令，和传统方法一样</span>
<span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s1">&#39;df -hl&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

<span class="c1"># 关闭连接</span>
<span class="n">trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>以上四种方法，可以帮助你实现远程登陆服务器执行命令，如果需要复用连接：一次连接执行多次命令，可以使用
<strong>方法二</strong> 和 <strong>方法四</strong></p>
<p>用完后，记得关闭连接。</p>
</div>
<div class="section" id="sftp">
<h5>实现 sftp 文件传输<a class="headerlink" href="#sftp" title="永久链接至标题">¶</a></h5>
<p>同时，paramiko 做为 ssh 的完美解决方案，它非常专业，利用它还可以实现
sftp 文件传输。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="c1"># 实例化一个trans对象# 实例化一个transport对象</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">Transport</span><span class="p">((</span><span class="s1">&#39;xx.xx.xx.xx&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>

<span class="c1"># 建立连接</span>
<span class="n">trans</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;you_username&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;you_passwd&#39;</span><span class="p">)</span>

<span class="c1"># 实例化一个 sftp对象,指定连接的通道</span>
<span class="n">sftp</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SFTPClient</span><span class="o">.</span><span class="n">from_transport</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

<span class="c1"># 发送文件</span>
<span class="n">sftp</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">localpath</span><span class="o">=</span><span class="s1">&#39;/tmp/11.txt&#39;</span><span class="p">,</span> <span class="n">remotepath</span><span class="o">=</span><span class="s1">&#39;/tmp/22.txt&#39;</span><span class="p">)</span>

<span class="c1"># 下载文件</span>
<span class="n">sftp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remotepath</span><span class="o">=</span><span class="s1">&#39;/tmp/22.txt&#39;</span><span class="p">,</span> <span class="n">localpath</span><span class="o">=</span><span class="s1">&#39;/tmp/33.txt&#39;</span><span class="p">)</span>
<span class="n">trans</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>到这里，Paramiko
已经完胜了，但是仍然有一个痛点我们没有提及，就是多平台，说的就是
Windows，这里就有一件好事，一件坏事了，。</p>
<p>好事就是：paramiko 支持 windows</p>
<p>坏事就是：你需要做很多复杂的准备，你可 google
解决，但是我建议你直接放弃，坑太深了。</p>
<p><img alt="image5" src="http://image.iswbm.com/20200228111654.png" /></p>
</div>
<div class="section" id="id4">
<h5>注意事项<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<p>使用 paramiko 的时候，有一点需要注意一下，这个也是我自己 “踩坑”
后才发现的，其实我觉得这个设计挺好的，如果你不需要等待它返回数据，可以直接实现异步效果，只不过对于不知道这个设计的人，确实是个容易掉坑的点</p>
<p>就是在执行 <code class="docutils literal notranslate"><span class="pre">ssh.exec_command(cmd)</span></code> 时，这个命令并不是同步阻塞的。</p>
<p>比如下面这段代码，执行时，你会发现 脚本立马就结束退出了，并不会等待 5 s
后，再 执行 ssh.close()</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">Transport</span><span class="p">((</span><span class="s2">&quot;172.20.42.1&quot;</span><span class="p">,</span> <span class="mi">57891</span><span class="p">))</span>
<span class="n">trans</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;youpassword&quot;</span><span class="p">)</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">trans</span>
<span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;sleep 5;echo ok&quot;</span><span class="p">)</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>但是如果改成这样，加上一行 stdout.read()， paramiko
就知道，你需要这个执行的结果，就会在 read() 进行阻塞。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">paramiko</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">Transport</span><span class="p">((</span><span class="s2">&quot;172.20.42.1&quot;</span><span class="p">,</span> <span class="mi">57891</span><span class="p">))</span>
<span class="n">trans</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;youpassword&quot;</span><span class="p">)</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">trans</span>
<span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;sleep 5;echo ok&quot;</span><span class="p">)</span>

<span class="c1"># 加上一行 read()</span>
<span class="k">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h4>4. 写在最后<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>经过了一番对比，和一些实例的展示，可以看出 Paramiko
是一个专业、让人省心的 ssh 利器，个人认为 Paramiko
模块是运维人员必学模块之一，如果你恰好需要在 Python 代码中实现 ssh
到远程服务器去获取一些信息，那么我把 Paramiko 推荐给你。</p>
<p><img alt="image6" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c07/c07_02"></span><div class="section" id="bug">
<h3>7.2 代码 BUG 变得酷炫的利器<a class="headerlink" href="#bug" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>当我们写的一个脚本或程序发生各种不可预知的异常时，如果我们没有进行捕获处理的时候，通常都会致使程序崩溃退出，并且会在终端打印出一堆
<strong>密密麻麻</strong> 的 traceback 堆栈信息来告诉我们，是哪个地方出了问题。</p>
<p>就像这样子，天呐，密集恐惧症要犯了都</p>
<p><img alt="image1" src="http://image.iswbm.com/image-20200307210853246.png" /></p>
<p>上面这段 traceback</p>
<ul class="simple">
<li><p>只有黑白两个颜色，无法像代码高亮那样，对肉眼实现太不友好了</p></li>
<li><p>无法直接显示报错的代码，排查问题慢人一步，效率太低</p></li>
</ul>
<p>那有没有一种办法，可以解决这些问题呢？</p>
<p>当然有了，在 Python
中，没有什么问题是一个库解决不了的，如果有，那就等你去开发这个库。</p>
<p>今天要介绍的这个库呢，叫做 <code class="docutils literal notranslate"><span class="pre">pretty-errors</span></code>
，从名字上就可以知道它的用途，是用来美化错误信息的。</p>
<p>通过这条命令你可以安装它</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install pretty-errors
</pre></div>
</div>
<div class="section" id="id1">
<h4>1. 环境要求<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>由于使用了 <code class="docutils literal notranslate"><span class="pre">pretty-errors</span></code> 后，你的 traceback
信息输出，会有代码高亮那样的效果，因此当你在使用测试使用
<code class="docutils literal notranslate"><span class="pre">pretty-error</span></code> 时，请确保你使用的终端可以输出带有颜色的字体。</p>
<p>在 windows 上你可以使用 Powershell，cmder 等</p>
<p>在 Mac 上你可以使用自带的终端，或者安装一个更好用的 iTerm2</p>
</div>
<div class="section" id="id2">
<h4>2. 效果对比<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<hr class="docutils" />
<p>随便写一个没有使用 pretty-errors ，并且报错了的程序，是这样子的。</p>
<p><img alt="image2" src="http://image.iswbm.com/image-20200307212823345.png" /></p>
<p>而使用了 pretty_errors 后，报错信息被美化成这样了。</p>
<p><img alt="image3" src="http://image.iswbm.com/image-20200307213534278.png" /></p>
<p>是不是感觉清楚了不少，那种密密麻麻带来的焦虑感是不是都消失了呢？</p>
<p>当然这段代码少，你可能还没感受到，那就来看下 该项目在
Github上的一张效果对比图吧</p>
<p><img alt="image4" src="https://warehouse-camo.cmh1.psfhosted.org/31399c5a034c3989b9e99b35249e8f2f0d40e102/68747470733a2f2f692e696d6775722e636f6d2f306a7045716f622e706e67" /></p>
</div>
<div class="section" id="id3">
<h4>3. 配置全局可用<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>可以看到使用了 pretty_errors
后，无非就是把过滤掉了一些干扰我们视线的无用信息，然后把有用的关键信息给我们高亮显示。</p>
<p>既然既然这样，那 pretty_errors
应该也能支持我们如何自定义我们选用什么样的颜色，怎么排版吧？</p>
<p>答案是显而易见的。</p>
<p>pretty_errors
和其他库不太一样，在一定程度上（如果你使用全局配置的话），它并不是开箱即用的，你在使用它之前可能需要做一下配置。</p>
<p>使用这一条命令，会让你进行配置，可以让你在该环境中运行其他脚本时的
traceback 输出都自动美化。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pretty_errors
</pre></div>
</div>
<p><img alt="image5" src="http://image.iswbm.com/image-20200307214742135.png" /></p>
<p>配置完成后，你再运行任何脚本，traceback 都会自动美化了。</p>
<p>不仅是在我的 iTerm 终端下</p>
<p><img alt="image6" src="http://image.iswbm.com/image-20200307213534278.png" /></p>
<p>在 PyCharm 中也会</p>
<p><img alt="image7" src="http://image.iswbm.com/image-20200307215530270.png" /></p>
<p>唯一的缺点就是，原先在 PyCharm 中的 traceback 可以直接点击 <code class="docutils literal notranslate"><span class="pre">文件路径</span></code>
直接跳转到对应错误文件代码行，而你如果是在 VSCode 可以使用
下面自定义配置的方案解决这个问题（下面会讲到，参数是：<code class="docutils literal notranslate"><span class="pre">display_link</span></code>）。</p>
<p><img alt="image8" src="http://image.iswbm.com/image-20200307215834623.png" /></p>
<p>因此，有些情况下，你并不想设置 <code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code> 全局可用。</p>
<p>那怎么取消之前的配置呢？</p>
<p>只需要再次输出 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">pretty_errors</span></code>，输出入 <code class="docutils literal notranslate"><span class="pre">C</span></code> 即可清除。</p>
<p><img alt="image9" src="http://image.iswbm.com/image-20200307214600749.png" /></p>
</div>
<div class="section" id="id4">
<h4>4. 单文件中使用<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>取消全局可用后，你可以根据自己需要，在你需要使用 <code class="docutils literal notranslate"><span class="pre">pretty-errors</span></code>
的脚本文件中导入<code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code>，即可使用</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pretty_errors</span>
</pre></div>
</div>
<p>就像这样</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pretty_errors</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">foo</span><span class="p">()</span>
</pre></div>
</div>
<p>值得一提的是，使用这种方式，若是你的脚本中，出现语法错误，则输出的异常信息还是按照之前的方式展示，并不会被美化。</p>
<p>因此，为了让美化更彻底，官方推荐你使用 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">pretty_errors</span></code></p>
</div>
<div class="section" id="id5">
<h4>5. 自定义设置<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>上面的例子里，我们使用的都是 <code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code>
的默认美化格式，展示的信息并没有那么全。</p>
<p>比如</p>
<ul class="simple">
<li><p>它并没有展示报错文件的绝对路径，这将使我们很难定位到是哪个文件里的代码出现错误。</p></li>
<li><p>如果能把具体报错的代码，给我们展示在终端屏幕上，就不需要我们再到源码文件中排查原因了。</p></li>
</ul>
<p>如果使用了 <code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code> 导致异常信息有丢失，那还不如不使用
<code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code> 呢。</p>
<p>不过，可以告诉你的是，<code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code> 并没有你想象的那么简单。</p>
<p>它足够开放，支持自定义配置，可以由你选择你需要展示哪些信息，怎么展示？</p>
<p>这里举一个例子</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pretty_errors</span>

<span class="c1"># 【重点】进行配置</span>
<span class="n">pretty_errors</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
    <span class="n">separator_character</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
    <span class="n">filename_display</span>    <span class="o">=</span> <span class="n">pretty_errors</span><span class="o">.</span><span class="n">FILENAME_EXTENDED</span><span class="p">,</span>
    <span class="n">line_number_first</span>   <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">display_link</span>        <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">lines_before</span>        <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">lines_after</span>         <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">line_color</span>          <span class="o">=</span> <span class="n">pretty_errors</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s1">&#39;&gt; &#39;</span> <span class="o">+</span> <span class="n">pretty_errors</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">line_color</span><span class="p">,</span>
    <span class="n">code_color</span>          <span class="o">=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">pretty_errors</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">line_color</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 原来的代码</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">foo</span><span class="p">()</span>
</pre></div>
</div>
<p>在你像上面这样使用 <code class="docutils literal notranslate"><span class="pre">pretty_errrs.configure</span></code>
进行配置时，抛出的的异常信息就变成这样了。</p>
<p><img alt="image10" src="http://image.iswbm.com/image-20200308121949011.png" /></p>
<p>当然了，<code class="docutils literal notranslate"><span class="pre">pretty_errors.configure()</span></code>
还可以接收很多的参数，你可以根据你自己的需要进行配置。</p>
<div class="section" id="id6">
<h5>5.1 设置颜色<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">header_color</span></code>：设置标题行的颜色。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp_color</span></code>：设置时间戳颜色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_color</span></code>：设置默认的颜色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filename_color</span></code>：设置文件名颜色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">line_number_color</span></code>：设置行号颜色。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">function_color</span></code>：设置函数颜色。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">link_color</span></code>：设置链接的颜色。</p></li>
</ul>
<p>在设置颜色的时候，<code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code> 提供了一些常用的
颜色常量供你直接调取。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BLACK</span></code>：黑色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GREY</span></code>：灰色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RED</span></code>：红色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GREEN</span></code>：绿色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">YELLOW</span></code>：黄色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BLUE</span></code>：蓝色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAGENTA</span></code>：品红色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CYAN</span></code>：蓝绿色</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WHITE</span></code>：白色</p></li>
</ul>
<p>而每一种颜色，都相应的匹配的 <code class="docutils literal notranslate"><span class="pre">BRIGHT_</span></code> 变体 和 <code class="docutils literal notranslate"><span class="pre">_BACKGROUND</span></code> 变体，</p>
<p>其中，<code class="docutils literal notranslate"><span class="pre">_BACKGROUND</span></code> 用于设置背景色，举个例子如下。</p>
<p><img alt="image11" src="http://image.iswbm.com/image-20200308125431779.png" /></p>
</div>
<div class="section" id="id7">
<h5>5.2 设置显示内容<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">line_number_first</span></code> 启用后，将首先显示行号，而不是文件名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lines_before</span></code> ： 显示发生异常处的前几行代码</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lines_after</span></code>： 显示发生异常处的后几行代码</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">display_link</span></code>：启用后，将在错误位置下方写入链接，VScode将允许您单击该链接。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">separator_character</span></code>：用于创建标题行的字符。默认情况下使用连字符。如果设置为
<code class="docutils literal notranslate"><span class="pre">''</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，标题将被禁用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">display_timestamp</span></code>：启用时，时间戳将写入回溯头中。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">display_locals</span></code>
启用后，将显示在顶部堆栈框架代码中的局部变量及其值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">display_trace_locals</span></code>
启用后，其他堆栈框架代码中出现的局部变量将与它们的值一起显示。</p></li>
</ul>
</div>
<div class="section" id="id8">
<h5>5.3 设置怎么显示<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h5>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">line_length</span></code>：设置每行的长度，默认为0，表示每行的输出将与控制台尺寸相匹配，如果你设置的长度将好与控制台宽度匹配，则可能需要禁用<code class="docutils literal notranslate"><span class="pre">full_line_newline</span></code>，以防止出现明显的双换行符。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">full_line_newline</span></code>：当输出的字符满行时，是否要插入换行符。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp_function</span></code>
调用该函数以生成时间戳。默认值为<code class="docutils literal notranslate"><span class="pre">time.perf_counter</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_first</span></code> 启用后，堆栈跟踪将反转，首先显示堆栈顶部。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">display_arrow</span></code>
启用后，将针对语法错误显示一个箭头，指向有问题的令牌。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">truncate_code</span></code> 启用后，每行代码将被截断以适合行长。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stack_depth</span></code>
要显示的堆栈跟踪的最大条目数。什么时候<code class="docutils literal notranslate"><span class="pre">0</span></code>将显示整个堆栈，这是默认值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exception_above</span></code> 启用后，异常将显示在堆栈跟踪上方。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exception_below</span></code>： 启用后，异常显示在堆栈跟踪下方。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reset_stdout</span></code>
启用后，重置转义序列将写入stdout和stderr；如果您的控制台留下错误的颜色，请启用此选项。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filename_display</span></code></p>
<p>设置文件名的展示方式，有三个选项： <code class="docutils literal notranslate"><span class="pre">pretty_errors.FILENAME_COMPACT</span></code>
、<code class="docutils literal notranslate"><span class="pre">pretty_errors.FILENAME_EXTENDED</span></code>，或者<code class="docutils literal notranslate"><span class="pre">pretty_errors.FILENAME_FULL</span></code></p>
</li>
</ul>
<p>以上，就是我对 <code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code>
的使用体验，总的来说，这个库功能非常强大，使用效果也特别酷炫，它就跟
PEP8
规范一样，没有它是可以，但是有了它会更好一样。对于某些想自定义错误输出场景的人，<code class="docutils literal notranslate"><span class="pre">pretty_errors</span></code>
会是一个不错的解决方案，明哥把它推荐给你。</p>
<p><img alt="image12" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<span id="document-c07/c07_03"></span><div class="section" id="python">
<h3>7.3 少有人知的 Python “重试机制”<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>为了避免由于一些网络或等其他不可控因素，而引起的功能性问题。比如在发送请求时，会因为网络不稳定，往往会有请求超时的问题。</p>
<p>这种情况下，我们通常会在代码中加入重试的代码。重试的代码本身不难实现，但如何写得优雅、易用，是我们要考虑的问题。</p>
<p>这里要给大家介绍的是一个第三方库 - <code class="docutils literal notranslate"><span class="pre">Tenacity</span></code>
，它实现了几乎我们可以使用到的所有重试场景，比如：</p>
<ol class="arabic simple">
<li><p>在什么情况下才进行重试？</p></li>
<li><p>重试几次呢?</p></li>
<li><p>重试多久后结束？</p></li>
<li><p>每次重试的间隔多长呢？</p></li>
<li><p>重试失败后的回调？</p></li>
</ol>
<p>在使用它之前 ，先要安装它</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install tenacity
</pre></div>
</div>
<div class="section" id="id1">
<h4>最基本的重试<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>无条件重试，重试之间无间隔</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span>

<span class="nd">@retry</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试，重试无间隔执行...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
<p>无条件重试，但是在重试之前要等待 2 秒</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">wait_fixed</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_fixed</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>设置停止基本条件<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>只重试7 次</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
<p>重试 10 秒后不再重试</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_delay</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
<p>或者上面两个条件满足一个就结束重试</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_delay</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="p">(</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>设置何时进行重试<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>在出现特定错误/异常（比如请求超时）的情况下，再进行重试</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">retry_if_exception_type</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
<p>在满足自定义条件时，再进行重试。</p>
<p>如下示例，当 <code class="docutils literal notranslate"><span class="pre">test_retry</span></code> 函数返回值为 False 时，再进行重试</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">retry_if_result</span>

<span class="k">def</span> <span class="nf">is_false</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
       <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_result</span><span class="p">(</span><span class="n">is_false</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>多个条件注意顺序<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>如果想对一个异常进行重试，但是最多重试3次。</p>
<p>下面这个代码是无效的，因为它会一直重试，重试三次的限制不会生效，因为它的条件是有顺序的，在前面的条件会先被走到，就永远走不到后面的条件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">retry_if_exception_type</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;retry&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
<p>如果你把 stop_after_attempt 写到前边，就没有问题了。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">retry_if_exception_type</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;retry&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>重试后错误重新抛出<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>当出现异常后，tenacity
会进行重试，若重试后还是失败，默认情况下，往上抛出的异常会变成
RetryError，而不是最根本的原因。</p>
<p>因此可以加一个参数（<code class="docutils literal notranslate"><span class="pre">reraise=True</span></code>），使得当重试失败后，往外抛出的异常还是原来的那个。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">reraise</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试...&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span>

<span class="n">test_retry</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>设置回调函数<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>当最后一次重试失败后，可以执行一个回调函数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">return_last_value</span><span class="p">(</span><span class="n">retry_state</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;执行回调函数&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retry_state</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># 表示返回原函数的返回值</span>

<span class="k">def</span> <span class="nf">is_false</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">False</span>

<span class="nd">@retry</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
       <span class="n">retry_error_callback</span><span class="o">=</span><span class="n">return_last_value</span><span class="p">,</span>
       <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_result</span><span class="p">(</span><span class="n">is_false</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_retry</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;等待重试中...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">print</span><span class="p">(</span><span class="n">test_retry</span><span class="p">())</span>
</pre></div>
</div>
<p>输出如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>等待重试中...
等待重试中...
等待重试中...
执行回调函数
False
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c07/c07_04"></span><div class="section" id="id1">
<h3>7.4 规整字符串提取数据的神器<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>从一段指定的字符串中，取得期望的数据，正常人都会想到正则表达式吧？</p>
<p>写过正则表达式的人都知道，正则表达式入门不难，写起来也容易。</p>
<p>但是正则表达式几乎没有可读性可言，维护起来，真的会让人抓狂，别以为这段正则是你写的就可以驾驭它，过个一个月你可能就不认识它了。</p>
<p>今天给你介绍一个好东西，可以让你在某些场景下摆脱正则的噩梦，那就是
Python 中一个非常冷门的库 – parse 。</p>
<div class="section" id="id2">
<h4>1. 真实案例<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>拿一个最近使用 parse 的真实案例来举例说明。</p>
<p>下面是 ovs
一个条流表，现在我需要收集提取一个虚拟机（网口）里有多少流量、多少包流经了这条流表。也就是每个
in_port 对应的 n_bytes、n_packets 的值 。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cookie</span><span class="o">=</span><span class="mh">0x9816da8e872d717d</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">298506.364</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_packets</span><span class="o">=</span><span class="mi">480</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="mi">20160</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="s2">&quot;tapbbdf080b-c2&quot;</span> <span class="n">actions</span><span class="o">=</span><span class="n">NORMAL</span>
</pre></div>
</div>
<p>如果是你，你会怎么做呢？</p>
<p>先以逗号分隔开来，再以等号分隔取出值来？</p>
<p>你不防可以尝试一下，写出来的代码应该和我想象的一样，没有一丝美感而言。</p>
<p>我来给你展示一下，我是怎么做的？</p>
<p><img alt="image1" src="http://image.iswbm.com/image-20200903214325849.png" /></p>
<p>可以看到，我使用了一个叫做 parse 的第三方包，是需要自行安装的</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python -m pip install parse
</pre></div>
</div>
<p>从上面这个案例中，你应该能感受到 parse
对于解析规范的字符串，是非常强大的。</p>
</div>
<div class="section" id="parse">
<h4>2. parse 的结果<a class="headerlink" href="#parse" title="永久链接至标题">¶</a></h4>
<p>parse 的结果只有两种结果：</p>
<ol class="arabic simple">
<li><p>没有匹配上，parse 的值为None</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;halo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">True</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>如果匹配上，parse 的值则 为 Result 实例</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="go">&lt;Result () {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>如果你编写的解析规则，没有为字段定义字段名，也就是匿名字段， Result
将是一个 类似 list 的实例，演示如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {}, {} years old, {}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am Jack, 27 years old, male&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">&lt;Result (&#39;Jack&#39;, &#39;27&#39;, &#39;male&#39;) {}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&#39;Jack&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&#39;27&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="go">&#39;male&#39;</span>
</pre></div>
</div>
<p>而如果你编写的解析规则，为字段定义了字段名， Result 将是一个 类似 字典
的实例，演示如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {name}, {age} years old, {gender}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am Jack, 27 years old, male&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">&lt;Result () {&#39;gender&#39;: &#39;male&#39;, &#39;age&#39;: &#39;27&#39;, &#39;name&#39;: &#39;Jack&#39;}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">&#39;Jack&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span>
<span class="go">&#39;27&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span>
<span class="go">&#39;male&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="pattern">
<h4>3. 重复利用 pattern<a class="headerlink" href="#pattern" title="永久链接至标题">¶</a></h4>
<p>和使用 re 一样，parse 同样支持 pattern 复用。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="nb">compile</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pattern</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s2">&quot;I am {}, {} years old, {}&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pattern</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am Jack, 27 years old, male&quot;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;Jack&#39;, &#39;27&#39;, &#39;male&#39;) {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pattern</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am Tom, 26 years old, male&quot;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;Tom&#39;, &#39;26&#39;, &#39;male&#39;) {}&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>4. 类型转化<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>从上面的例子中，你应该能注意到，parse
在获取年龄的时候，变成了一个<code class="docutils literal notranslate"><span class="pre">&quot;27&quot;</span></code>
，这是一个字符串，有没有一种办法，可以在提取的时候就按照我们的类型进行转换呢？</p>
<p>你可以这样写。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">parse</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {name}, {age:d} years old, {gender}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am Jack, 27 years old, male&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span>
<span class="go">&lt;Result () {&#39;gender&#39;: &#39;male&#39;, &#39;age&#39;: 27, &#39;name&#39;: &#39;Jack&#39;}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">])</span>
<span class="go">&lt;type &#39;int&#39;&gt;</span>
</pre></div>
</div>
<p>除了将其转为 整型，还有其他格式吗？</p>
<p>内置的格式还有很多，比如</p>
<p>匹配时间</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;Meet at {:tg}&#39;</span><span class="p">,</span> <span class="s1">&#39;Meet at 1/2/2011 11:00 PM&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (datetime.datetime(2011, 2, 1, 23, 0),) {}&gt;</span>
</pre></div>
</div>
<p>更多类型请参考官方文档：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 4%" />
<col style="width: 86%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>T
y
p
e</p></th>
<th class="head"><p>Characters Matched</p></th>
<th class="head"><p>Outpu
t</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>l</p></td>
<td><p>Letters (ASCII)</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-odd"><td><p>w</p></td>
<td><p>Letters, numbers and underscore</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-even"><td><p>W</p></td>
<td><p>Not letters, numbers and underscore</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-odd"><td><p>s</p></td>
<td><p>Whitespace</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-even"><td><p>S</p></td>
<td><p>Non-whitespace</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-odd"><td><p>d</p></td>
<td><p>Digits (effectively integer numbers)</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>D</p></td>
<td><p>Non-digit</p></td>
<td><p>str</p></td>
</tr>
<tr class="row-odd"><td><p>n</p></td>
<td><p>Numbers with thousands separators (, or .)</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>%</p></td>
<td><p>Percentage (converted to value/100.0)</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-odd"><td><p>f</p></td>
<td><p>Fixed-point numbers</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>F</p></td>
<td><p>Decimal numbers</p></td>
<td><p>Decim
al</p></td>
</tr>
<tr class="row-odd"><td><p>e</p></td>
<td><p>Floating-point numbers with exponent e.g. 1.1e-10, NAN
(all case insensitive)</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>g</p></td>
<td><p>General number format (either d, f or e)</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-odd"><td><p>b</p></td>
<td><p>Binary numbers</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>o</p></td>
<td><p>Octal numbers</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-odd"><td><p>x</p></td>
<td><p>Hexadecimal numbers (lower and upper case)</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>t
i</p></td>
<td><p>ISO 8601 format date/time e.g. 1972-01-20T10:21:36Z (“T”
and “Z” optional)</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-odd"><td><p>t
e</p></td>
<td><p>RFC2822 e-mail format date/time e.g. Mon, 20 Jan 1972
10:21:36 +1000</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-even"><td><p>t
g</p></td>
<td><p>Global (day/month) format date/time e.g. 20/1/1972
10:21:36 AM +1:00</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-odd"><td><p>t
a</p></td>
<td><p>US (month/day) format date/time e.g. 1/20/1972 10:21:36
PM +10:30</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-even"><td><p>t
c</p></td>
<td><p>ctime() format date/time e.g. Sun Sep 16 01:03:52 1973</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-odd"><td><p>t
h</p></td>
<td><p>HTTP log format date/time e.g. 21/Nov/2011:00:07:11 +0000</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-even"><td><p>t
s</p></td>
<td><p>Linux system log format date/time e.g. Nov 9 03:37:44</p></td>
<td><p>datet
ime</p></td>
</tr>
<tr class="row-odd"><td><p>t
t</p></td>
<td><p>Time e.g. 10:21:36 PM -5:30</p></td>
<td><p>time</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h4>5. 提取时去除空格<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>去除两边空格</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;hello {} , hello python&#39;</span><span class="p">,</span> <span class="s1">&#39;hello     world    , hello python&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;    world   &#39;,) {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;hello {:^} , hello python&#39;</span><span class="p">,</span> <span class="s1">&#39;hello     world    , hello python&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;world&#39;,) {}&gt;</span>
</pre></div>
</div>
<p>去除左边空格</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;hello {:&gt;} , hello python&#39;</span><span class="p">,</span> <span class="s1">&#39;hello     world    , hello python&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;world   &#39;,) {}&gt;</span>
</pre></div>
</div>
<p>去除右边空格</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;hello {:&lt;} , hello python&#39;</span><span class="p">,</span> <span class="s1">&#39;hello     world    , hello python&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;    world&#39;,) {}&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>6. 大小写敏感开关<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>Parse 默认是大小写不敏感的，你写 hello 和 HELLO 是一样的。</p>
<p>如果你需要区分大小写，那可以加个参数，演示如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;SPAM&#39;</span><span class="p">,</span> <span class="s1">&#39;spam&#39;</span><span class="p">)</span>
<span class="go">&lt;Result () {}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;SPAM&#39;</span><span class="p">,</span> <span class="s1">&#39;spam&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;SPAM&#39;</span><span class="p">,</span> <span class="s1">&#39;spam&#39;</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>7. 匹配字符数<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>精确匹配：指定最大字符数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:.2}{:.2}&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>  <span class="c1"># 字符数不符</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:.2}{:.2}&#39;</span><span class="p">,</span> <span class="s1">&#39;hell&#39;</span><span class="p">)</span>   <span class="c1"># 字符数相符</span>
<span class="go">&lt;Result (&#39;he&#39;, &#39;ll&#39;) {}&gt;</span>
</pre></div>
</div>
<p>模糊匹配：指定最小字符数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:.2}{:2}&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;h&#39;, &#39;ello&#39;) {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:2}{:2}&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;he&#39;, &#39;llo&#39;) {}&gt;</span>
</pre></div>
</div>
<p>若要在精准/模糊匹配的模式下，再进行格式转换，可以这样写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:2}{:2}&#39;</span><span class="p">,</span> <span class="s1">&#39;1024&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (&#39;10&#39;, &#39;24&#39;) {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:2d}{:2d}&#39;</span><span class="p">,</span> <span class="s1">&#39;1024&#39;</span><span class="p">)</span>
<span class="go">&lt;Result (10, 24) {}&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4>8. 三个重要属性<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>Parse 里有三个非常重要的属性</p>
<ul class="simple">
<li><p>fixed：利用位置提取的匿名字段的元组</p></li>
<li><p>named：存放有命名的字段的字典</p></li>
<li><p>spans：存放匹配到字段的位置</p></li>
</ul>
<p>下面这段代码，带你了解他们之间有什么不同</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {name}, {age:d} years old, {}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am Jack, 27 years old, male&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">.</span><span class="n">fixed</span>
<span class="go">(&#39;male&#39;,)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">.</span><span class="n">named</span>
<span class="go">{&#39;age&#39;: 27, &#39;name&#39;: &#39;Jack&#39;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">profile</span><span class="o">.</span><span class="n">spans</span>
<span class="go">{0: (25, 29), &#39;age&#39;: (11, 13), &#39;name&#39;: (5, 9)}</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>9. 自定义类型的转换<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p>匹配到的字符串，会做为参数传入对应的函数</p>
<p>比如我们之前讲过的，将字符串转整型</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {:d}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am 27&quot;</span><span class="p">)</span>
<span class="go">&lt;Result (27,) {}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">&lt;type &#39;int&#39;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>其等价于</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">myint</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;I am {:myint}&quot;</span><span class="p">,</span> <span class="s2">&quot;I am 27&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">myint</span><span class="o">=</span><span class="n">myint</span><span class="p">))</span>
<span class="go">&lt;Result (27,) {}&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">&lt;type &#39;int&#39;&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>利用它，我们可以定制很多的功能，比如我想把匹配的字符串弄成全大写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">shouty</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;{:shouty} world&#39;</span><span class="p">,</span> <span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shouty</span><span class="o">=</span><span class="n">shouty</span><span class="p">))</span>
<span class="go">&lt;Result (&#39;HELLO&#39;,) {}&gt;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>10 总结一下<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
<p>parse 库在字符串解析处理场景中提供的便利，肉眼可见，上手简单。</p>
<p>在一些简单的场景中，使用 parse 可比使用 re 去写正则开发效率不知道高几个
level，用它写出来的代码富有美感，可读性高，后期维护起代码来一点压力也没有，推荐你使用。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c07/c07_05"></span><div class="section" id="id1">
<h3>7.5 一行代码让代码运行速度提高100倍<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>python一直被病垢运行速度太慢，但是实际上python的执行效率并不慢，慢的是python用的解释器Cpython运行效率太差。</p>
<p>“一行代码让python的运行速度提高100倍”这绝不是哗众取宠的论调。</p>
<p>我们来看一下这个最简单的例子，从1一直累加到1亿。</p>
<p>最原始的代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">i</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Time used: {} sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">print</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100000000</span><span class="p">))</span>
</pre></div>
</div>
<p>结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Time</span> <span class="n">used</span><span class="p">:</span> <span class="mf">6.779874801635742</span> <span class="n">sec</span>
<span class="mi">4999999950000000</span>
</pre></div>
</div>
<p>我们来加一行代码，再看看结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">i</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Time used: {} sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">tt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span>
<span class="k">print</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100000000</span><span class="p">))</span>
</pre></div>
</div>
<p>结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Time</span> <span class="n">used</span><span class="p">:</span> <span class="mf">0.04680037498474121</span> <span class="n">sec</span>
<span class="mi">4999999950000000</span>
</pre></div>
</div>
<p>是不是快了100多倍呢？</p>
<p>那么下面就分享一下“为啥<strong>numba</strong>库的<strong>jit</strong>模块那么牛掰？”</p>
<p><strong>NumPy</strong>的创始人Travis
Oliphant在离开Enthought之后，创建了CONTINUUM，致力于将Python大数据处理方面的应用。最近推出的Numba项目能够将处理NumPy数组的Python函数JIT编译为机器码执行，从而上百倍的提高程序的运算速度。</p>
<p>Numba项目的主页上有Linux下的详细安装步骤。编译LLVM需要花一些时间。Windows用户可以从Unofficial
Windows Binaries for Python Extension
Packages下载安装LLVMPy、meta和numba等几个扩展库。</p>
<p>下面我们看一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numba</span> <span class="kn">as</span> <span class="nn">nb</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="nd">@jit</span><span class="p">(</span><span class="s1">&#39;f8(f8[:])&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sum1d</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">sum1d</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="o">%</span><span class="n">timeit</span> <span class="nb">sum</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="mi">10000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">38.9</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>
<span class="mi">10000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">32.3</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>
<span class="mi">100</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">12.4</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>
</div>
<p>numba中提供了一些修饰器，它们可以将其修饰的函数<strong>JIT</strong>编译成机器码函数，并返回一个可在Python中调用机器码的包装对象。为了能将Python函数编译成能高速执行的机器码，我们需要告诉JIT编译器函数的各个参数和返回值的类型。我们可以通过多种方式指定类型信息，在上面的例子中，类型信息由一个字符串’f8(f8[:])’指定。其中’f8’表示8个字节双精度浮点数，括号前面的’f8’表示返回值类型，括号里的表示参数类型，’[:]’表示一维数组。因此整个类型字符串表示sum1d()是一个参数为双精度浮点数的一维数组，返回值是一个双精度浮点数。需要注意的是，JIT所产生的函数只能对指定的类型的参数进行运算：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="n">sum1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="k">print</span> <span class="n">sum1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="k">print</span> <span class="n">sum1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="mf">1.2095376009e-312</span>
<span class="mf">1.46201599944e+185</span>
<span class="mf">10.0</span>
</pre></div>
</div>
<p>如果希望JIT能针对所有类型的参数进行运算，可以使用<strong>autojit</strong>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">autojit</span>
<span class="nd">@autojit</span>
<span class="k">def</span> <span class="nf">sum1d2</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="o">%</span><span class="n">timeit</span> <span class="n">sum1d2</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="k">print</span> <span class="n">sum1d2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="k">print</span> <span class="n">sum1d2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="k">print</span> <span class="n">sum1d2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="mi">10000</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">143</span> <span class="n">us</span> <span class="n">per</span> <span class="n">loop</span>
<span class="mf">10.0</span>
<span class="mf">10.0</span>
<span class="mf">10.0</span>
</pre></div>
</div>
<p><strong>autoit</strong>虽然可以根据参数类型动态地产生机器码函数，但是由于它需要每次检查参数类型，因此计算速度也有所降低。numba的用法很简单，基本上就是用jit和autojit这两个修饰器，和一些类型对象。下面的程序列出numba所支持的所有类型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">minivect</span><span class="o">.</span><span class="n">minitypes</span><span class="o">.</span><span class="n">Type</span><span class="p">)]</span>
<span class="p">[</span><span class="n">size_t</span><span class="p">,</span> <span class="n">Py_uintptr_t</span><span class="p">,</span> <span class="n">uint16</span><span class="p">,</span> <span class="n">complex128</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">complex256</span><span class="p">,</span> <span class="n">void</span><span class="p">,</span> <span class="nb">int</span> <span class="p">,</span> <span class="nb">long</span> <span class="n">double</span><span class="p">,</span>
<span class="n">unsigned</span> <span class="n">PY_LONG_LONG</span><span class="p">,</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">complex256</span><span class="p">,</span> <span class="n">complex64</span><span class="p">,</span> <span class="n">object_</span><span class="p">,</span> <span class="n">npy_intp</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="p">,</span>
<span class="n">double</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">short</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">object_</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">uint32</span><span class="p">,</span> <span class="n">uint8</span><span class="p">,</span> <span class="n">complex128</span><span class="p">,</span> <span class="n">uint16</span><span class="p">,</span>
<span class="nb">int</span><span class="p">,</span> <span class="nb">int</span> <span class="p">,</span> <span class="n">uint8</span><span class="p">,</span> <span class="n">complex64</span><span class="p">,</span> <span class="n">int8</span><span class="p">,</span> <span class="n">uint64</span><span class="p">,</span> <span class="n">double</span><span class="p">,</span> <span class="nb">long</span> <span class="n">double</span><span class="p">,</span> <span class="n">int32</span><span class="p">,</span> <span class="n">double</span><span class="p">,</span> <span class="nb">long</span> <span class="n">double</span><span class="p">,</span>
<span class="n">char</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">char</span><span class="p">,</span> <span class="n">PY_LONG_LONG</span><span class="p">,</span> <span class="n">int64</span><span class="p">,</span> <span class="n">int16</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">long</span><span class="p">,</span> <span class="n">int8</span><span class="p">,</span> <span class="n">int16</span><span class="p">,</span> <span class="n">int32</span><span class="p">,</span>
<span class="n">unsigned</span> <span class="nb">int</span><span class="p">,</span> <span class="n">short</span><span class="p">,</span> <span class="n">int64</span><span class="p">,</span> <span class="n">Py_ssize_t</span><span class="p">]</span>
</pre></div>
</div>
<p>工作原理
<strong>numba</strong>的通过<strong>meta</strong>模块解析Python函数的ast语法树，对各个变量添加相应的类型信息。然后调用llvmpy生成机器码，最后再生成机器码的Python调用接口。</p>
<div class="section" id="meta">
<h4>meta模块<a class="headerlink" href="#meta" title="永久链接至标题">¶</a></h4>
<p>通过研究numba的工作原理，我们可以找到许多有用的工具。例如meta模块可在程序源码、ast语法树以及Python二进制码之间进行相互转换。下面看一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>decompile_func能将函数的代码对象反编译成ast语法树，而str_ast能直观地显示ast语法树，使用这两个工具学习Python的ast语法树是很有帮助的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">meta.decompiler</span> <span class="kn">import</span> <span class="n">decompile_func</span>
<span class="kn">from</span> <span class="nn">meta.asttools</span> <span class="kn">import</span> <span class="n">str_ast</span>
<span class="k">print</span> <span class="n">str_ast</span><span class="p">(</span><span class="n">decompile_func</span><span class="p">(</span><span class="n">add2</span><span class="p">))</span>
<span class="n">FunctionDef</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">arguments</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">Name</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">Param</span><span class="p">(),</span>
                                      <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">),</span>
                                 <span class="n">Name</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">Param</span><span class="p">(),</span>
                                      <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)],</span>
                           <span class="n">defaults</span><span class="o">=</span><span class="p">[],</span>
                           <span class="n">kwarg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">vararg</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">Return</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">BinOp</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">(),</span>
                                               <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">),</span>
                                     <span class="n">op</span><span class="o">=</span><span class="n">Add</span><span class="p">(),</span>
                                     <span class="n">right</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">(),</span>
                                                <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)))],</span>
            <span class="n">decorator_list</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>而python_source可以将ast语法树转换为Python源代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">meta.asttools</span> <span class="kn">import</span> <span class="n">python_source</span>
<span class="n">python_source</span><span class="p">(</span><span class="n">decompile_func</span><span class="p">(</span><span class="n">add2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">add2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>decompile_pyc将上述二者结合起来，它能将Python编译之后的pyc或者pyo文件反编译成源代码。下面我们先写一个tmp.py文件，然后通过py_compile将其编译成tmp.pyc。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">def square_sum(n):</span>
<span class="s2">    s = 0</span>
<span class="s2">    for i in range(n):</span>
<span class="s2">        s += i**2</span>
<span class="s2">    return s</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">py_compile</span>
<span class="n">py_compile</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;tmp.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>下面调用decompile_pyc将tmp.pyc显示为源代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;tmp.pyc&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">decompile_pyc</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">square_sum</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
</div>
<div class="section" id="llvmpy">
<h4>llvmpy模块<a class="headerlink" href="#llvmpy" title="永久链接至标题">¶</a></h4>
<p>LLVM是一个动态编译器，llvmpy则可以通过Python调用LLVM动态地创建机器码。直接通过llvmpy创建机器码是比较繁琐的，例如下面的程序创建一个计算两个整数之和的函数，并调用它计算结果。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">llvm.core</span> <span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Builder</span>
<span class="kn">from</span> <span class="nn">llvm.ee</span> <span class="kn">import</span> <span class="n">ExecutionEngine</span><span class="p">,</span> <span class="n">GenericValue</span>

<span class="c1"># Create a new module with a function implementing this:</span>
<span class="c1">#</span>
<span class="c1"># int add(int a, int b) {</span>
<span class="c1">#   return a + b;</span>
<span class="c1"># }</span>
<span class="c1">#</span>
<span class="n">my_module</span> <span class="o">=</span> <span class="n">Module</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;my_module&#39;</span><span class="p">)</span>
<span class="n">ty_int</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
<span class="n">ty_func</span> <span class="o">=</span> <span class="n">Type</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">ty_int</span><span class="p">,</span> <span class="p">[</span><span class="n">ty_int</span><span class="p">,</span> <span class="n">ty_int</span><span class="p">])</span>
<span class="n">f_add</span> <span class="o">=</span> <span class="n">my_module</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">ty_func</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span>
<span class="n">f_add</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
<span class="n">f_add</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
<span class="n">bb</span> <span class="o">=</span> <span class="n">f_add</span><span class="o">.</span><span class="n">append_basic_block</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span>

<span class="c1"># IRBuilder for our basic block</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">Builder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f_add</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f_add</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;tmp&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

<span class="c1"># Create an execution engine object. This will create a JIT compiler</span>
<span class="c1"># on platforms that support it, or an interpreter otherwise</span>
<span class="n">ee</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">my_module</span><span class="p">)</span>

<span class="c1"># Each argument needs to be passed as a GenericValue object, which is a kind</span>
<span class="c1"># of variant</span>
<span class="n">arg1</span> <span class="o">=</span> <span class="n">GenericValue</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">ty_int</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">arg2</span> <span class="o">=</span> <span class="n">GenericValue</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">ty_int</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>

<span class="c1"># Now let&#39;s compile and run!</span>
<span class="n">retval</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">run_function</span><span class="p">(</span><span class="n">f_add</span><span class="p">,</span> <span class="p">[</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">])</span>

<span class="c1"># The return value is also GenericValue. Let&#39;s print it.</span>
<span class="k">print</span> <span class="s2">&quot;returned&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="o">.</span><span class="n">as_int</span><span class="p">()</span>
<span class="n">returned</span> <span class="mi">142</span>
</pre></div>
</div>
<p>f_add就是一个动态生成的机器码函数，我们可以把它想象成C语言编译之后的函数。在上面的程序中，我们通过ee.run_function调用此函数，而实际上我们还可以获得它的地址，然后通过Python的ctypes模块调用它。</p>
<p>首先通过ee.get_pointer_to_function获得f_add函数的地址：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">addr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">get_pointer_to_function</span><span class="p">(</span><span class="n">f_add</span><span class="p">)</span>
<span class="n">addr</span>
<span class="il">2975997968L</span>
</pre></div>
</div>
<p>然后通过ctypes.PYFUNCTYPE创建一个函数类型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="n">f_type</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">PYFUNCTYPE</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)</span>
</pre></div>
</div>
<p>最后通过f_type将函数的地址转换为可调用的Python函数，并调用它：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">f_type</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">f</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
<span class="mi">142</span>
</pre></div>
</div>
<p>numba所完成的工作就是：解析Python函数的ast语法树并加以改造，添加类型信息；将带类型信息的ast语法树通过llvmpy动态地转换为机器码函数，然后再通过和ctypes类似的技术为机器码函数创建包装函数供Python调用。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c07/c07_06"></span><div class="section" id="pysnooper">
<h3>7.6 新一代的调试神器：PySnooper<a class="headerlink" href="#pysnooper" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>对于每个程序开发者来说，调试几乎是必备技能。</p>
<p>代码写到一半卡住了，不知道这个函数执行完的返回结果是怎样的？调试一下看看</p>
<p>代码运行到一半报错了，什么情况？怎么跟预期的不一样？调试一下看看</p>
<p>调试的方法多种多样，不同的调试方法适合不同的场景和人群。</p>
<ul class="simple">
<li><p>如果你是刚接触编程的小萌新，对很多工具的使用还不是很熟练，那么 print
和 log 大法好</p></li>
<li><p>如果你在本地（Win或者Mac）电脑上开发，那么 IDE
的图形化界面调试无疑是最适合的；</p></li>
<li><p>如果你在服务器上排查BUG，那么使用 PDB
进行无图形界面的调试应该是首选；</p></li>
<li><p>如果你要在本地进行开发，但是项目的进行需要依赖复杂的服务器环境，那么可以了解下
PyCharm 的远程调试</p></li>
</ul>
<p>除了以上，今天明哥再给你介绍一款非常好用的调试工具，它能在一些场景下，大幅度提高调试的效率，
那就是 <code class="docutils literal notranslate"><span class="pre">PySnooper</span></code>，它在 Github 上已经收到了 13k 的
star，获得大家的一致好评。</p>
<p><strong>有了这个工具后，就算是小萌新也可以直接无门槛上手，从此与 print
说再见~</strong></p>
<div class="section" id="id1">
<h4>1. 快速安装<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>执行下面这些命令进行安装 PySnooper</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install pysnooper

<span class="c1"># 或者</span>
$ conda install -c conda-forge pysnooper

<span class="c1"># 或者</span>
$ yay -S python-pysnooper
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>2. 简单案例<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>下面这段代码，定义了一个 demo_func 的函数，在里面生成一个 profile
的字典变量，然后去更新它，最后返回。</p>
<p>代码本身没有什么实际意义，但是用来演示 PySnooper 已经足够。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pysnooper</span>

<span class="nd">@pysnooper.snoop</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;写代码的明哥&quot;</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">27</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;male&quot;</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">demo_func</span><span class="p">()</span>

<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>现在我使用终端命令行的方式来运行它</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@iswbm ~<span class="o">]</span><span class="c1"># python3 demo.py</span>
Source path:... demo.py
<span class="m">17</span>:52:49.624943 call         <span class="m">4</span> def demo_func<span class="o">()</span>:
<span class="m">17</span>:52:49.625124 line         <span class="m">5</span>     <span class="nv">profile</span> <span class="o">=</span> <span class="o">{}</span>
New var:....... <span class="nv">profile</span> <span class="o">=</span> <span class="o">{}</span>
<span class="m">17</span>:52:49.625156 line         <span class="m">6</span>     profile<span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;写代码的明哥&quot;</span>
Modified var:.. <span class="nv">profile</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;写代码的明哥&#39;</span><span class="o">}</span>
<span class="m">17</span>:52:49.625207 line         <span class="m">7</span>     profile<span class="o">[</span><span class="s2">&quot;age&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="m">27</span>
Modified var:.. <span class="nv">profile</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;写代码的明哥&#39;</span>, <span class="s1">&#39;age&#39;</span>: <span class="m">27</span><span class="o">}</span>
<span class="m">17</span>:52:49.625254 line         <span class="m">8</span>     profile<span class="o">[</span><span class="s2">&quot;gender&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;male&quot;</span>
Modified var:.. <span class="nv">profile</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;写代码的明哥&#39;</span>, <span class="s1">&#39;age&#39;</span>: <span class="m">27</span>, <span class="s1">&#39;gender&#39;</span>: <span class="s1">&#39;male&#39;</span><span class="o">}</span>
<span class="m">17</span>:52:49.625306 line        <span class="m">10</span>     <span class="k">return</span> profile
<span class="m">17</span>:52:49.625344 <span class="k">return</span>      <span class="m">10</span>     <span class="k">return</span> profile
Return value:.. <span class="o">{</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;写代码的明哥&#39;</span>, <span class="s1">&#39;age&#39;</span>: <span class="m">27</span>, <span class="s1">&#39;gender&#39;</span>: <span class="s1">&#39;male&#39;</span><span class="o">}</span>
Elapsed time: <span class="m">00</span>:00:00.000486
</pre></div>
</div>
<p>可以看到 PySnooper 把函数运行的过程全部记录了下来，包括：</p>
<ul class="simple">
<li><p>代码的片段、行号等信息，以及每一行代码是何时调用的？</p></li>
<li><p>函数内局部变量的值如何变化的？何时新增了变量，何时修改了变量。</p></li>
<li><p>函数的返回值是什么？</p></li>
<li><p>运行函数消耗了多少时间？</p></li>
</ul>
<p>而作为开发者，要得到这些如此详细的调试信息，你需要做的非常简单，只要给你想要调试的函数上带上一顶帽子（装饰器）
– <code class="docutils literal notranslate"><span class="pre">&#64;pysnooper.snoop()</span></code> 即可。</p>
</div>
<div class="section" id="id3">
<h4>3. 详细使用<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<div class="section" id="id4">
<h5>2.1 重定向到日志文件<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">&#64;pysnooper.snoop()</span></code>
不加任何参数时，会默认将调试的信息输出到标准输出。</p>
<p>对于单次调试就能解决的 BUG ，这样没有什么问题，但是有一些 BUG
只有在特定的场景下才会出现，需要你把程序放在后面跑个一段时间才能复现。</p>
<p>这种情况下，你可以将调试信息重定向输出到某一日志文件中，方便追溯排查。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;/var/log/debug.log&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h5>2.2 跟踪非局部变量值<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h5>
<p>PySnooper
是以函数为单位进行调试的，它默认只会跟踪函数体内的局部变量，若想跟踪全局变量，可以给
<code class="docutils literal notranslate"><span class="pre">&#64;pysnooper.snoop()</span></code> 加上 <code class="docutils literal notranslate"><span class="pre">watch</span></code> 参数</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}</span>

<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">watch</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;out[&quot;foo&quot;]&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>如此一来，PySnooper 会在 <code class="docutils literal notranslate"><span class="pre">out[&quot;foo&quot;]</span></code> 值有变化时，也将其打印出来</p>
<p><img alt="image1" src="http://image.iswbm.com/20201114183018.png" /></p>
<p>watch 参数，接收一个可迭代对象（可以是list 或者
tuple），里面的元素为字符串表达式，什么意思呢？看下面例子就知道了</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">watch</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;out[&quot;foo&quot;]&#39;</span><span class="p">,</span> <span class="s1">&#39;foo.bar&#39;</span><span class="p">,</span> <span class="s1">&#39;self.foo[&quot;bar&quot;]&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>和 <code class="docutils literal notranslate"><span class="pre">watch</span></code> 相对的，<code class="docutils literal notranslate"><span class="pre">pysnooper.snoop()</span></code> 还可以接收一个函数
<code class="docutils literal notranslate"><span class="pre">watch_explode</span></code>，表示除了这几个参数外的其他所有全局变量都监控。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">watch_explode</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h5>2.3 设置跟踪函数的深度<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h5>
<p>当你使用 PySnooper 调试某个函数时，若该函数中还调用了其他函数，PySnooper
是不会傻傻的跟踪进去的。</p>
<p>如果你想继续跟踪该函数中调用的其他函数，可以通过指定 <code class="docutils literal notranslate"><span class="pre">depth</span></code>
参数来设置跟踪深度（不指定的话默认为 1）。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h5>2.4 设置调试日志的前缀<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h5>
<p>当你在使用 PySnooper
跟踪多个函数时，调试的日志会显得杂乱无章，不方便查看。</p>
<p>在这种情况下，PySnooper
提供了一个参数，方便你为不同的函数设置不同的标志，方便你在查看日志时进行区分。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="s2">&quot;/var/log/debug.log&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;demo_func: &quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>效果如下</p>
<p><img alt="image2" src="http://image.iswbm.com/20201114193131.png" /></p>
</div>
<div class="section" id="id8">
<h5>2.5 设置最大的输出长度<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h5>
<p>默认情况下，PySnooper 输出的变量和异常信息，如果超过 100
个字符，被会截断为 100 个字符。</p>
<p>当然你也可以通过指定参数 进行修改</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>@pysnooper.snoop(max_variable_length=200）
def demo_func():
    ...
</pre></div>
</div>
<p>您也可以使用max_variable_length=None它从不截断它们。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>@pysnooper.snoop(max_variable_length=None）
def demo_func():
    ...
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h5>2.6 支持多线程调试模式<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h5>
<p>PySnooper 同样支持多线程的调试，通过设置参数
<code class="docutils literal notranslate"><span class="pre">thread_info=True</span></code>，它就会在日志中打印出是在哪个线程对变量进行的修改。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">thread_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>效果如下</p>
<p><img alt="image3" src="http://image.iswbm.com/20201114194449.png" /></p>
</div>
<div class="section" id="id10">
<h5>2.7 自定义对象的格式输出<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">pysnooper.snoop()</span></code> 函数有一个参数是
<code class="docutils literal notranslate"><span class="pre">custom_repr</span></code>，它接收一个元组对象。</p>
<p>在这个元组里，你可以指定特定类型的对象以特定格式进行输出。</p>
<p>这边我举个例子。</p>
<p>假如我要跟踪 person 这个 Person 类型的对象，由于它不是常规的 Python
基础类型，PySnooper 是无法正常输出它的信息的。</p>
<p>因此我在 <code class="docutils literal notranslate"><span class="pre">pysnooper.snoop()</span></code> 函数中设置了 <code class="docutils literal notranslate"><span class="pre">custom_repr</span></code>
参数，该参数的第一个元素为 Person，第二个元素为 <code class="docutils literal notranslate"><span class="pre">print_persion_obj</span></code>
函数。</p>
<p>PySnooper 在打印对象的调试信息时，会逐个判断它是否是 Person
类型的对象，若是，就将该对象传入 <code class="docutils literal notranslate"><span class="pre">print_persion_obj</span></code>
函数中，由该函数来决定如何显示这个对象的信息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span><span class="k">pass</span>

<span class="k">def</span> <span class="nf">print_person_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;Person {obj.name} {obj.age} {obj.gender}&gt;&quot;</span>

<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">print_person_obj</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>完整的代码如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pysnooper</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span><span class="k">pass</span>


<span class="k">def</span> <span class="nf">print_person_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;&lt;Person {obj.name} {obj.age} {obj.gender}&gt;&quot;</span>

<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">print_person_obj</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">()</span>
    <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;写代码的明哥&quot;</span>
    <span class="n">person</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">27</span>
    <span class="n">person</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="s2">&quot;male&quot;</span>

    <span class="k">return</span> <span class="n">person</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">demo_func</span><span class="p">()</span>

<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>运行一下，观察一下效果。</p>
<p><img alt="image4" src="http://image.iswbm.com/20201114201042.png" /></p>
<p>如果你要自定义格式输出的有很多个类型，那么 <code class="docutils literal notranslate"><span class="pre">custom_repr</span></code>
参数的值可以这么写</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">((</span><span class="n">Person</span><span class="p">,</span> <span class="n">print_person_obj</span><span class="p">),</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">print_ndarray</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>还有一点我提醒一下，元组的第一个元素可以是类型（如类名Person
或者其他基础类型 list等），也可以是一个判断对象类型的函数。</p>
<p>也就是说，下面三种写法是等价的。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 【第一种写法】</span>
<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">print_persion_obj</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>


<span class="c1"># 【第二种写法】</span>
<span class="k">def</span> <span class="nf">is_persion_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Person</span><span class="p">)</span>

<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">(</span><span class="n">is_persion_obj</span><span class="p">,</span> <span class="n">print_persion_obj</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>


<span class="c1"># 【第三种写法】</span>
<span class="nd">@pysnooper.snoop</span><span class="p">(</span><span class="n">custom_repr</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Person</span><span class="p">),</span> <span class="n">print_persion_obj</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">demo_func</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>以上就是明哥今天给大家介绍的一款调试神器（<code class="docutils literal notranslate"><span class="pre">PySnooper</span></code>）
的详细使用手册，是不是觉得还不错？</p>
<p><img alt="image5" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
</div>
<span id="document-c07/c07_07"></span><div class="section" id="open">
<h3>7.7 比open更好用、更优雅的读取文件<a class="headerlink" href="#open" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>使用 open 函数去读取文件，似乎是所有 Python 工程师的共识。</p>
<p>今天明哥要给大家推荐一个比 open 更好用、更优雅的读取文件方法 – 使用
<code class="docutils literal notranslate"><span class="pre">fileinput</span></code></p>
<p>fileinput 是 Python 的内置模块，但我相信，不少人对它都是陌生的。今天我把
fileinput
的所有的用法、功能进行详细的讲解，并列举了一些非常实用的案例，对于理解和使用它可以说完全没有问题。</p>
<div class="section" id="id1">
<h4>1. 从标准输入中读取<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h4>
<p>当你的 Python 脚本没有传入任何参数时，fileinput 默认会以 stdin
作为输入源</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># demo.py</span>
<span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>效果如下，不管你输入什么，程序会自动读取并再打印一次，像个复读机似的。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
hello
hello

python
python
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>2. 单独打开一个文件<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h4>
<p>单独打开一个文件，只需要在 files 中输入一个文件名即可</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,))</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{fileinput.filename()} 第{fileinput.lineno()}行: {line}&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">a.txt</span></code> 的内容如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hello</span>
<span class="n">world</span>
</pre></div>
</div>
<p>执行后就会输出如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
a.txt 第1行: hello
a.txt 第2行: world
</pre></div>
</div>
<p>需要说明的一点是，<code class="docutils literal notranslate"><span class="pre">fileinput.input()</span></code> 默认使用 <code class="docutils literal notranslate"><span class="pre">mode='r'</span></code>
的模式读取文件，如果你的文件是二进制的，可以使用<code class="docutils literal notranslate"><span class="pre">mode='rb'</span></code>
模式。fileinput 有且仅有这两种读取模式。</p>
</div>
<div class="section" id="id3">
<h4>3. 批量打开多个文件<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<p>从上面的例子也可以看到，我在 <code class="docutils literal notranslate"><span class="pre">fileinput.input</span></code> 函数中传入了 <code class="docutils literal notranslate"><span class="pre">files</span></code>
参数，它接收一个包含多个文件名的列表或元组，传入一个就是读取一个文件，传入多件就是读取多个文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{fileinput.filename()} 第{fileinput.lineno()}行: {line}&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">a.txt</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b.txt</span></code> 的内容分别是</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat a.txt
hello
world
$ cat b.txt
hello
python
</pre></div>
</div>
<p>运行后输出结果如下，由于 <code class="docutils literal notranslate"><span class="pre">a.txt</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b.txt</span></code>
的内容被整合成一个文件对象 <code class="docutils literal notranslate"><span class="pre">file</span></code> ，因此 <code class="docutils literal notranslate"><span class="pre">fileinput.lineno()</span></code>
只有在读取一个文件时，才是原文件中真实的行号。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
a.txt 第1行: hello
a.txt 第2行: world
b.txt 第3行: hello
b.txt 第4行: python
</pre></div>
</div>
<p>如果想要在读取多个文件的时候，也能读取原文件的真实行号，可以使用
<code class="docutils literal notranslate"><span class="pre">fileinput.filelineno()</span></code> 方法</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{fileinput.filename()} 第{fileinput.filelineno()}行: {line}&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行后，输出如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python demo.py
a.txt 第1行: hello
a.txt 第2行: world
b.txt 第1行: hello
b.txt 第2行: python
</pre></div>
</div>
<p>这个用法和 glob 模块简直是绝配</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.txt&quot;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">isfirstline</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Reading {fileinput.filename()}...&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="n">lineno</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行效果如下</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>$ python demo.py
-------------------- Reading b.txt... --------------------
1: HELLO
2: PYTHON
-------------------- Reading a.txt... --------------------
3: HELLO
4: WORLD
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>4. 读取的同时备份文件<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">fileinput.input</span></code> 有一个 backup 参数，你可以指定备份的后缀名，比如
<code class="docutils literal notranslate"><span class="pre">.bak</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>


<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,),</span> <span class="n">backup</span><span class="o">=</span><span class="s2">&quot;.bak&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{fileinput.filename()} 第{fileinput.lineno()}行: {line}&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行的结果如下，会多出一个 <code class="docutils literal notranslate"><span class="pre">a.txt.bak</span></code> 文件</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ls -l a.txt*
-rw-r--r--  <span class="m">1</span> MING  staff  <span class="m">12</span>  <span class="m">2</span> <span class="m">27</span> <span class="m">10</span>:43 a.txt

$ python demo.py
a.txt 第1行: hello
a.txt 第2行: world

$ ls -l a.txt*
-rw-r--r--  <span class="m">1</span> MING  staff  <span class="m">12</span>  <span class="m">2</span> <span class="m">27</span> <span class="m">10</span>:43 a.txt
-rw-r--r--  <span class="m">1</span> MING  staff  <span class="m">42</span>  <span class="m">2</span> <span class="m">27</span> <span class="m">10</span>:39 a.txt.bak
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>5. 标准输出重定向替换<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">fileinput.input</span></code> 有一个 inplace
参数，表示是否将标准输出的结果写回文件，默认不取代</p>
<p>请看如下一段测试代码</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;a.txt&quot;</span><span class="p">,),</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[INFO] task is started...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{fileinput.filename()} 第{fileinput.lineno()}行: {line}&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[INFO] task is closed...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行后，会发现在 for 循环体内的 print 内容会写回到原文件中了。而在 for
循环体外的 print 则没有变化。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat a.txt
hello
world

$ python demo.py
<span class="o">[</span>INFO<span class="o">]</span> task is started...
<span class="o">[</span>INFO<span class="o">]</span> task is closed...

$ cat a.txt
a.txt 第1行: hello
a.txt 第2行: world
</pre></div>
</div>
<p>利用这个机制，可以很容易的实现文本替换。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c1">#将Windows/DOS格式下的文本文件转为Linux的文件</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>附：如何实现 DOS 和 UNIX 格式互换以供程序测试，使用 vim 输入如下指令即可</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>DOS转UNIX：:setfileformat=unix
UNIX转DOS：:setfileformat=dos
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h4>6. 不得不介绍的方法<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>如果只是想要 <code class="docutils literal notranslate"><span class="pre">fileinput</span></code> 当做是替代 open
读取文件的工具，那么以上的内容足以满足你的要求。 -
<code class="docutils literal notranslate"><span class="pre">fileinput.filenam()</span></code> 返回当前被读取的文件名。
在第一行被读取之前，返回 <code class="docutils literal notranslate"><span class="pre">None</span></code>。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.fileno()</span></code> 返回以整数表示的当前文件“文件描述符”。
当未打开文件时（处在第一行和文件之间），返回 <code class="docutils literal notranslate"><span class="pre">-1</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.lineno()</span></code> 返回已被读取的累计行号。
在第一行被读取之前，返回 <code class="docutils literal notranslate"><span class="pre">0</span></code>。
在最后一个文件的最后一行被读取之后，返回该行的行号。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.filelineno()</span></code> 返回当前文件中的行号。
在第一行被读取之前，返回 <code class="docutils literal notranslate"><span class="pre">0</span></code>。
在最后一个文件的最后一行被读取之后，返回此文件中该行的行号。</p></li>
</ul>
<p>但若要想基于 fileinput
来做一些更加复杂的逻辑，也许你会需要用到如下这几个方法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.isfirstline()</span></code> 如果刚读取的行是其所在文件的第一行则返回
<code class="docutils literal notranslate"><span class="pre">True</span></code>，否则返回 <code class="docutils literal notranslate"><span class="pre">False</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.isstdin()</span></code> 如果最后读取的行来自 <code class="docutils literal notranslate"><span class="pre">sys.stdin</span></code> 则返回
<code class="docutils literal notranslate"><span class="pre">True</span></code>，否则返回 <code class="docutils literal notranslate"><span class="pre">False</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.nextfile()</span></code>
关闭当前文件以使下次迭代将从下一个文件（如果存在）读取第一行；不是从该文件读取的行将不会被计入累计行数。
直到下一个文件的第一行被读取之后文件名才会改变。
在第一行被读取之前，此函数将不会生效；它不能被用来跳过第一个文件。
在最后一个文件的最后一行被读取之后，此函数将不再生效。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.close()</span></code> 关闭序列。</p></li>
</ul>
</div>
<div class="section" id="id7">
<h4>7. 进阶一点的玩法<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>在 <code class="docutils literal notranslate"><span class="pre">fileinput.input()</span></code> 中有一个 <code class="docutils literal notranslate"><span class="pre">openhook</span></code>
的参数，它支持用户传入自定义的对象读取方法。</p>
<p>若你没有传入任何的勾子，fileinput 默认使用的是 open 函数。</p>
<p><img alt="image1" src="http://image.iswbm.com/image-20210227095708676.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">fileinput</span></code> 为我们内置了两种勾子供你使用</p>
<ol class="arabic">
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.hook_compressed(*filename*,</span> <span class="pre">*mode*)</span></code></p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">gzip</span></code> 和 <code class="docutils literal notranslate"><span class="pre">bz2</span></code> 模块透明地打开 gzip 和 bzip2
压缩的文件（通过扩展名 <code class="docutils literal notranslate"><span class="pre">'.gz'</span></code> 和 <code class="docutils literal notranslate"><span class="pre">'.bz2'</span></code> 来识别）。
如果文件扩展名不是 <code class="docutils literal notranslate"><span class="pre">'.gz'</span></code> 或
<code class="docutils literal notranslate"><span class="pre">'.bz2'</span></code>，文件会以正常方式打开（即使用
<code class="docutils literal notranslate"><span class="pre">`open()</span></code> &lt;<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#open">https://docs.python.org/zh-cn/3/library/functions.html#open</a>&gt;`__
并且不带任何解压操作）。使用示例:
<code class="docutils literal notranslate"><span class="pre">fi</span> <span class="pre">=</span> <span class="pre">fileinput.FileInput(openhook=fileinput.hook_compressed)</span></code></p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput.hook_encoded(*encoding*,</span> <span class="pre">*errors=None*)</span></code></p></li>
</ol>
<p>返回一个通过 <code class="docutils literal notranslate"><span class="pre">open()</span></code> 打开每个文件的钩子，使用给定的 <em>encoding</em> 和
<em>errors</em> 来读取文件。使用示例:
<code class="docutils literal notranslate"><span class="pre">fi</span> <span class="pre">=</span> <span class="pre">fileinput.FileInput(openhook=fileinput.hook_encoded(&quot;utf-8&quot;,</span> <span class="pre">&quot;surrogateescape&quot;))</span></code></p>
<p>如果你自己的场景比较特殊，以上的三种勾子都不能满足你的要求，你也可以自定义。</p>
<p>这边我举个例子来抛砖引玉下</p>
<p>假如我想要使用 fileinput 来读取网络上的文件，可以这样定义勾子。</p>
<ol class="arabic simple">
<li><p>先使用 requests 下载文件到本地</p></li>
<li><p>再使用 open 去读取它</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">online_open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">requests</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
        <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f2</span>
</pre></div>
</div>
<p>直接将这个函数传给 openhook 即可</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>

<span class="n">file_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.csdn.net/robots.txt&#39;</span>
<span class="k">with</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="n">file_url</span><span class="p">,),</span> <span class="n">openhook</span><span class="o">=</span><span class="n">online_open</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>运行后按预期一样将 CSDN 的 robots 的文件打印了出来</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>User-agent: *
Disallow: /scripts
Disallow: /public
Disallow: /css/
Disallow: /images/
Disallow: /content/
Disallow: /ui/
Disallow: /js/
Disallow: /scripts/
Disallow: /article_preview.html*
Disallow: /tag/
Disallow: /*?*
Disallow: /link/

Sitemap: https://www.csdn.net/sitemap-aggpage-index.xml
Sitemap: https://www.csdn.net/article/sitemap.txt
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>8. 列举一些实用案例<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p><strong>案例一</strong>：读取一个文件所有行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;data.txt&#39;</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>案例二</strong>：读取多个文件所有行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.txt&quot;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">isfirstline</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;Reading {fileinput.filename()}...&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="n">lineno</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>案例三</strong>：利用fileinput将CRLF文件转为LF</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">fileinput</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c1">#将Windows/DOS格式下的文本文件转为Linux的文件</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>案例四</strong>：配合 re 做日志分析：取所有含日期的行</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#--样本文件--：error.log</span>
<span class="n">aaa</span>
<span class="mi">1970</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mi">13</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">30</span>  <span class="n">Error</span><span class="p">:</span> <span class="o">****</span> <span class="n">Due</span> <span class="n">to</span> <span class="n">System</span> <span class="n">Disk</span> <span class="n">spacke</span> <span class="ow">not</span> <span class="n">enough</span><span class="o">...</span>
<span class="n">bbb</span>
<span class="mi">1970</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">02</span> <span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span>  <span class="n">Error</span><span class="p">:</span> <span class="o">****</span> <span class="n">Due</span> <span class="n">to</span> <span class="n">System</span> <span class="n">Out</span> <span class="n">of</span> <span class="n">Memory</span><span class="o">...</span>
<span class="n">ccc</span>

<span class="c1">#---测试脚本---</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}&#39;</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;error.log&#39;</span><span class="p">,</span><span class="n">backup</span><span class="o">=</span><span class="s1">&#39;.bak&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;=&gt; &quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1">#---测试结果---</span>
<span class="o">=&gt;</span> <span class="mi">1970</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mi">13</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">30</span>  <span class="n">Error</span><span class="p">:</span> <span class="o">****</span> <span class="n">Due</span> <span class="n">to</span> <span class="n">System</span> <span class="n">Disk</span> <span class="n">spacke</span> <span class="ow">not</span> <span class="n">enough</span><span class="o">...</span>
<span class="o">=&gt;</span> <span class="mi">1970</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">02</span> <span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span>  <span class="n">Error</span><span class="p">:</span> <span class="o">****</span> <span class="n">Due</span> <span class="n">to</span> <span class="n">System</span> <span class="n">Out</span> <span class="n">of</span> <span class="n">Memory</span><span class="o">...</span>
</pre></div>
</div>
<p><strong>案例五</strong>：利用fileinput实现类似于grep的功能</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>import sys
import re
import fileinput

pattern= re.compile(sys.argv[1])
for line in fileinput.input(sys.argv[2]):
    if pattern.match(line):
        print(fileinput.filename(), fileinput.filelineno(), line)

$ ./demo.py import.*re *.py
#查找所有py文件中，含import re字样的
addressBook.py  2   import re
addressBook1.py 10  import re
addressBook2.py 18  import re
test.py         238 import re
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>9. 写在最后<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
<p>fileinput 是 Python 的内置模块，但我相信，不少人对它都是陌生的。今天我把
fileinput
的所有的用法、功能进行详细的讲解，并列举了一些非常实用的案例，对于理解和使用它可以说完全没有问题。</p>
<p>fileinput 是对 open 函数的再次封装，在仅需读取数据的场景中， fileinput
显然比 open
做得更专业、更人性，当然在其他有写操作的复杂场景中，fileinput
就无能为力啦，本身从 fileinput
的命名上就知道这个模块只专注于输入（读）而不是输出（写）。</p>
<p><img alt="image2" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<span id="document-c07/c07_08"></span><div class="section" id="id1">
<h3>7.8 像操作路径一样，操作嵌套字典<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p>在使用前先安装它，要注意的是该模块只能在 Python 3.8+ 中使用</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install dpath
</pre></div>
</div>
<p>下边是一个简单的使用案例</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dpath.util</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;buggy&#39;</span><span class="p">,</span> <span class="s1">&#39;bumpers&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">print</span><span class="p">(</span><span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;/foo/bar/d&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">[ab]</span></code> 会把 键为 <code class="docutils literal notranslate"><span class="pre">a</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b</span></code> 的都筛选出来</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;/foo/bar/[ab]&quot;</span><span class="p">))</span>
<span class="c1"># output: {&#39;foo&#39;: {&#39;bar&#39;: {&#39;a&#39;: 10, &#39;b&#39;: 20}}}</span>
</pre></div>
</div>
<p>获取所有匹配的键值对的 value 值列表</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">dpath</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;/foo/bar/*&quot;</span><span class="p">))</span>
<span class="c1"># output: [10, 20, [], [&#39;red&#39;, &#39;buggy&#39;, &#39;bumpers&#39;]]</span>
</pre></div>
</div>
<p>更多案例，请前往 <a class="reference external" href="https://pypi.org/project/dpath/">官方文档</a> 查阅。</p>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
<span id="document-c07/c07_09"></span><div class="section" id="id1">
<h3>7.9 读取文件中任意行的数据<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p><img alt="image0" src="http://image.iswbm.com/20200804124133.png" /></p>
<p><code class="docutils literal notranslate"><span class="pre">linecache</span></code> 是 Python 中的一个内置模块。</p>
<p>它允许从任何文件中获取任意行，同时尝试使用缓存进行内部优化，这是一种常见的情况，即从单个文件读取多行。它被<code class="docutils literal notranslate"><span class="pre">traceback</span></code>模块用来检索包含在格式化回溯中的源代码行。</p>
<p>这是一个简单的例子。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">linecache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="go">&#39;sys:x:3:3:sys:/dev:/bin/sh\n&#39;</span>
</pre></div>
</div>
<p>如果你指定的行数超过了文件原有的行数，该函数也不会抛出错误，而是返回空字符串。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">linecache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p><img alt="image1" src="http://image.iswbm.com/20200607174235.png" /></p>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
<span id="document-aboutme"></span><div class="section" id="id1">
<h2>关于作者<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>姓名：     王炳明</p></li>
<li><p>微信：     stromwbm</p></li>
<li><p>公众号：   《Python编程时光》&amp;《Go编程时光》</p></li>
<li><p>Email：    <a class="reference external" href="mailto:wongbingming&#37;&#52;&#48;163&#46;com">wongbingming<span>&#64;</span>163<span>&#46;</span>com</a></p></li>
<li><p>GitHub：   <a class="reference external" href="https://github.com/iswbm">https://github.com/iswbm</a></p></li>
</ul>
<hr class="docutils" />
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
<span id="document-roadmap"></span><div class="section" id="roadmap">
<h2>Roadmap<a class="headerlink" href="#roadmap" title="永久链接至标题">¶</a></h2>
<p>2020/08/03:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>|    github项目搭建，readthedocs文档生成。
|    整个项目的框架完成
</pre></div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>
</div>
<hr class="docutils" />
<div class="figure align-default">
<img alt="http://image.iswbm.com/20200607174235.png" src="http://image.iswbm.com/20200607174235.png" />
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Python编程时光
      
        <span class="commit">
          Revision <code>d8b2265f</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/zh/latest/">latest</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//magic.iswbm.com/_/downloads/zh/latest/htmlzip/">html</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/magic-python-guide/?fromdocs=magic-python-guide">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/magic-python-guide/?fromdocs=magic-python-guide">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>